<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N√°klady projekt≈Ø | Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <style>
        :root {
            --bg-primary: #0a0e11;
            --bg-card: #151a1e;
            --bg-elevated: #1a2027;
            --border-primary: #2d3439;
            --text-primary: #e8eef2;
            --text-secondary: #9ca8b3;
            --text-tertiary: #6b7580;
            --mint: #9FD4A1;
            --mint-dim: rgba(159, 212, 161, 0.16);
            --warning: #fbbf24;
            --danger: #ff6b6b;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .costs-container {
            padding: 20px;
            padding-bottom: 100px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .costs-header {
            margin-bottom: 24px;
        }
        
        .costs-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .costs-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Project cards */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }
        
        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border-color: var(--mint);
        }
        
        .project-card.on-track {
            border-left: 4px solid var(--mint);
        }
        
        .project-card.warning {
            border-left: 4px solid var(--warning);
        }
        
        .project-card.over-budget {
            border-left: 4px solid var(--danger);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .project-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .project-code {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .status-badge.ok {
            background: var(--mint-dim);
            color: var(--mint);
        }
        
        .status-badge.warning {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
        }
        
        .status-badge.danger {
            background: rgba(255, 107, 107, 0.15);
            color: var(--danger);
        }
        
        .budget-section {
            margin-bottom: 16px;
        }
        
        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .budget-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .budget-value.spent {
            color: var(--text-primary);
        }
        
        .budget-value.budget {
            color: var(--text-tertiary);
        }
        
        .budget-value.remaining {
            color: var(--mint);
        }
        
        .budget-value.over {
            color: var(--danger);
        }
        
        /* Progress bar */
        .progress-container {
            margin-top: 16px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .progress-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .progress-percent {
            font-size: 14px;
            font-weight: 700;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--border-primary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        
        .progress-fill.ok {
            background: linear-gradient(90deg, var(--mint), #7bc67e);
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #f59e0b);
        }
        
        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #ef4444);
        }
        
        /* Hours summary */
        .hours-summary {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-primary);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }
    </style>
</head>
<body>
    <header style="background: var(--bg-card); border-bottom: 1px solid var(--border-primary); padding: 16px 20px; position: sticky; top: 0; z-index: 100;">
        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <a href="javascript:history.back()" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; text-decoration: none; color: var(--text-primary);">
                <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                <span style="font-weight: 600; font-size: 14px;">Zpƒõt</span>
            </a>
            <h1 style="margin: 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <svg style="width: 24px; height: 24px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="1" x2="12" y2="5"/><line x1="12" y1="9" x2="12" y2="15"/></svg>
                N√°klady projekt≈Ø
            </h1>
            <div style="display: flex; gap: 8px; margin-left: auto;">
                <a href="/planning/daily" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">Dnes</a>
                <a href="/planning/timeline" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">Timeline</a>
                <a href="/planning/week" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">T√Ωden</a>
                <a href="/planning/costs" style="padding: 8px 16px; background: var(--mint); color: #0a0e11; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">N√°klady</a>
            </div>
        </div>
    </header>

    <div class="costs-container">
        <div class="costs-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div class="costs-title">Real-time n√°klady projekt≈Ø</div>
                    <div class="costs-subtitle">N√°klady pr√°ce poƒç√≠tan√© z v√Ωkaz≈Ø √ó rozpoƒçet projektu</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="window.print()" style="padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        Print
                    </button>
                    <button onclick="exportCosts()" style="padding: 10px 16px; background: var(--mint); color: #0a0e11; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export CSV
                    </button>
                </div>
            </div>
        </div>

        <div class="projects-grid" id="projectsGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-tertiary);">
                <div style="width: 40px; height: 40px; border: 3px solid var(--border-primary); border-top-color: var(--mint); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                Naƒç√≠t√°m n√°klady projekt≈Ø...
            </div>
        </div>
    </div>

    <script>
        async function loadCosts() {
            try {
                const response = await fetch('/api/planning/costs');
                const data = await response.json();

                if (data.success && data.projects) {
                    renderProjects(data.projects);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderProjects(projects) {
            allProjects = projects; // Save for export
            
            if (projects.length === 0) {
                document.getElementById('projectsGrid').innerHTML = 
                    '<div class="empty-state">≈Ω√°dn√© aktivn√≠ projekty s rozpoƒçtem</div>';
                return;
            }

            let html = '';
            projects.forEach(p => {
                const percent = p.percent_used || 0;
                const isWarning = percent > 80 && percent <= 100;
                const isDanger = percent > 100;
                const statusClass = isDanger ? 'over-budget' : (isWarning ? 'warning' : 'on-track');
                const badgeClass = isDanger ? 'danger' : (isWarning ? 'warning' : 'ok');
                const progressClass = isDanger ? 'danger' : (isWarning ? 'warning' : 'ok');
                
                const statusText = isDanger ? '‚ö†Ô∏è P≈ôeƒçerp√°no' : (isWarning ? '‚ö° Bl√≠zko limitu' : '‚úì V po≈ô√°dku');

                html += `<div class="project-card ${statusClass}" onclick="openProject(${p.id})">`;
                html += `<div class="project-header">`;
                html += `<div>`;
                html += `<div class="project-name">${p.name}</div>`;
                if (p.code) html += `<div class="project-code">${p.code}</div>`;
                html += `</div>`;
                html += `<div class="status-badge ${badgeClass}">${statusText}</div>`;
                html += `</div>`;

                html += `<div class="budget-section">`;
                html += `<div class="budget-row">`;
                html += `<div class="budget-label">Utraceno</div>`;
                html += `<div class="budget-value spent">${formatCurrency(p.spent)}</div>`;
                html += `</div>`;
                html += `<div class="budget-row">`;
                html += `<div class="budget-label">Rozpoƒçet</div>`;
                html += `<div class="budget-value budget">${formatCurrency(p.budget)}</div>`;
                html += `</div>`;
                html += `<div class="budget-row">`;
                html += `<div class="budget-label">${isDanger ? 'P≈ôekroƒçeno' : 'Zb√Ωv√°'}</div>`;
                html += `<div class="budget-value ${isDanger ? 'over' : 'remaining'}">${formatCurrency(Math.abs(p.remaining))}</div>`;
                html += `</div>`;
                html += `</div>`;

                html += `<div class="progress-container">`;
                html += `<div class="progress-header">`;
                html += `<div class="progress-label">Vyu≈æit√≠ rozpoƒçtu</div>`;
                html += `<div class="progress-percent">${percent.toFixed(0)}%</div>`;
                html += `</div>`;
                html += `<div class="progress-bar">`;
                html += `<div class="progress-fill ${progressClass}" style="width: ${Math.min(100, percent)}%"></div>`;
                html += `</div>`;
                html += `</div>`;

                if (p.hours_spent) {
                    html += `<div class="hours-summary">`;
                    html += `üíº ${p.hours_spent.toFixed(1)} hodin pr√°ce zalogov√°no`;
                    html += `</div>`;
                }

                html += `</div>`;
            });

            document.getElementById('projectsGrid').innerHTML = html;
        }

        function formatCurrency(amount) {
            if (!amount) return '0 Kƒç';
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                maximumFractionDigits: 0
            }).format(amount);
        }

        function openProject(id) {
            window.location.href = `/job-detail.html?id=${id}`;
        }
        
        let allProjects = [];
        
        function exportCosts() {
            let csv = 'Projekt,K√≥d,Status,Rozpoƒçet,Utraceno,Zb√Ωv√°,Vyu≈æit√≠ %,Hodiny\n';
            allProjects.forEach(p => {
                const status = p.percent_used > 100 ? 'P≈ôeƒçerp√°no' : (p.percent_used > 80 ? 'Bl√≠zko limitu' : 'V po≈ô√°dku');
                csv += `"${p.name}","${p.code || ''}","${status}","${p.budget || 0}","${p.spent || 0}","${p.remaining || 0}","${(p.percent_used || 0).toFixed(1)}","${(p.hours_spent || 0).toFixed(1)}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `naklady_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Init
        loadCosts();
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
