<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Náklady projektů | Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <link rel="stylesheet" href="/static/css/glass-design.css"/>
    <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #1a1d1f;
            --bg-card: rgba(255,255,255,0.06);
            --bg-elevated: rgba(255,255,255,0.05);
            --border-primary: rgba(255,255,255,0.08);
            --text-primary: #e8eef2;
            --text-secondary: #9ca8b3;
            --text-tertiary: #6b7580;
            --mint: #4ade80;
            --mint-dim: rgba(74, 222, 128, 0.16);
            --warning: #fbbf24;
            --danger: #ff6b6b;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        /* Kompenzace pro sidebar */
        body.has-sidebar > header {
            margin-left: var(--sidebar-w, 200px) !important;
            width: calc(100% - var(--sidebar-w, 200px)) !important;
            max-width: calc(100% - var(--sidebar-w, 200px)) !important;
            box-sizing: border-box;
        }
        body.has-sidebar > .costs-container {
            margin-left: var(--sidebar-w, 200px) !important;
            width: calc(100% - var(--sidebar-w, 200px)) !important;
            max-width: calc(100% - var(--sidebar-w, 200px)) !important;
            box-sizing: border-box;
        }
        body.has-sidebar.sidebar-collapsed > header {
            margin-left: var(--sidebar-width-collapsed, 60px) !important;
            width: calc(100% - var(--sidebar-width-collapsed, 60px)) !important;
            max-width: calc(100% - var(--sidebar-width-collapsed, 60px)) !important;
        }
        body.has-sidebar.sidebar-collapsed > .costs-container {
            margin-left: var(--sidebar-width-collapsed, 60px) !important;
            width: calc(100% - var(--sidebar-width-collapsed, 60px)) !important;
            max-width: calc(100% - var(--sidebar-width-collapsed, 60px)) !important;
        }
        
        /* Override sidebar-content-wrapper z sidebar.css — jen pro tuto stránku */
        .sidebar-content-wrapper {
            max-width: none !important;
            width: 100% !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            box-sizing: border-box !important;
        }
        
        .costs-container {
            padding: 20px;
            padding-bottom: 100px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Summary karty */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }
        
        @media (max-width: 1200px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .summary-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .summary-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
        }
        
        .summary-card-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-card-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .summary-card-value.warning {
            color: var(--warning);
        }
        
        .summary-card-value.danger {
            color: var(--danger);
        }
        
        .summary-card-value.success {
            color: var(--mint);
        }
        
        /* Grafy */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 20px;
        }
        
        .chart-card h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin: 0 0 16px 0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-container.line {
            height: 250px;
        }
        
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .donut-center-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .donut-center-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Sekce detailu */
        .detail-section {
            margin-top: 40px;
        }
        
        .detail-section h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }
        
        .costs-header {
            margin-bottom: 24px;
        }
        
        .costs-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .costs-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Project cards */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }
        
        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border-color: var(--mint);
        }
        
        .project-card.on-track {
            border-left: 4px solid var(--mint);
        }
        
        .project-card.warning {
            border-left: 4px solid var(--warning);
        }
        
        .project-card.over-budget {
            border-left: 4px solid var(--danger);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .project-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .project-code {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .status-badge.ok {
            background: var(--mint-dim);
            color: var(--mint);
        }
        
        .status-badge.warning {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
        }
        
        .status-badge.danger {
            background: rgba(255, 107, 107, 0.15);
            color: var(--danger);
        }
        
        .budget-section {
            margin-bottom: 16px;
        }
        
        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .budget-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .budget-value.spent {
            color: var(--text-primary);
        }
        
        .budget-value.budget {
            color: var(--text-tertiary);
        }
        
        .budget-value.remaining {
            color: var(--mint);
        }
        
        .budget-value.over {
            color: var(--danger);
        }
        
        /* Progress bar */
        .progress-container {
            margin-top: 16px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .progress-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .progress-percent {
            font-size: 14px;
            font-weight: 700;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--border-primary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        
        .progress-fill.ok {
            background: linear-gradient(90deg, var(--mint), #7bc67e);
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #f59e0b);
        }
        
        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #ef4444);
        }
        
        /* Hours summary */
        .hours-summary {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-primary);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }
    </style>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
</head>
<body class="has-sidebar">
  <div id="app-header"></div>
        <div id="app-sidebar"></div>
<header style="background: var(--bg-card); border-bottom: 1px solid var(--border-primary); padding: 16px 20px; position: sticky; top: 0; z-index: 100;">
        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <a href="javascript:history.back()" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; text-decoration: none; color: var(--text-primary);">
                <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                <span style="font-weight: 600; font-size: 14px;">Zpět</span>
            </a>
            <h1 style="margin: 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <svg style="width: 24px; height: 24px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="1" x2="12" y2="5"/><line x1="12" y1="9" x2="12" y2="15"/></svg>
                Náklady projektů
            </h1>
            <div style="display: flex; gap: 8px; margin-left: auto;">
                <a href="/planning/daily" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">Dnes</a>
                <a href="/planning/timeline" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">Timeline</a>
                <a href="/planning/week" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">Týden</a>
                <a href="/planning/costs" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(74,222,128,0.08)); color: #4ade80; border: 1px solid rgba(74,222,128,0.35); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; box-shadow: 0 0 12px rgba(74,222,128,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">Náklady</a>
                <a href="/planning/scenarios" style="padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                        <path d="M15 18l6-6-6-6" opacity="0.5"/>
                    </svg>
                    Scénáře
                </a>
            </div>
        </div>
    </header>

    <div class="costs-container">
        <div class="costs-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div class="costs-title">Real-time náklady projektů</div>
                    <div class="costs-subtitle">Náklady práce počítané z výkazů × rozpočet projektu</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="window.print()" style="padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        Print
                    </button>
                    <button onclick="exportCosts()" style="padding: 10px 16px; background: linear-gradient(135deg, rgba(74,222,128,0.85), rgba(34,197,94,0.85)); color: #0a0e11; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(74,222,128,0.2);">
                        <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary karty -->
        <div class="summary-grid" id="summaryGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-tertiary);">
                <div style="width: 40px; height: 40px; border: 3px solid var(--border-primary); border-top-color: var(--mint); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                Načítám náklady projektů...
            </div>
        </div>
        
        <!-- Grafy -->
        <div class="charts-grid" id="chartsGrid" style="display: none;">
            <div class="chart-card">
                <h3>Rozpočet vs. Utraceno</h3>
                <div class="chart-container">
                    <canvas id="donutChart"></canvas>
                    <div class="donut-center" id="donutCenter"></div>
                </div>
            </div>
            <div class="chart-card">
                <h3>Náklady po zakázkách</h3>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="chart-card" id="lineChartCard" style="display: none; margin-bottom: 20px;">
            <h3>Měsíční trend nákladů</h3>
            <div class="chart-container line">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
        
        <!-- Detail po zakázkách -->
        <div class="detail-section">
            <h2>Detail po zakázkách</h2>
            <div class="projects-grid" id="projectsGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-tertiary);">
                    <div style="width: 40px; height: 40px; border: 3px solid var(--border-primary); border-top-color: var(--mint); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                    Načítám náklady projektů...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart.js dark theme
        Chart.defaults.color = '#9ca8b3';
        Chart.defaults.borderColor = '#2d3439';
        
        let donutChartInstance = null;
        let barChartInstance = null;
        let lineChartInstance = null;
        
        async function loadCosts() {
            try {
                const response = await fetch('/api/planning/costs');
                const data = await response.json();

                if (data.success && data.projects) {
                    renderSummary(data.projects);
                    renderCharts(data.projects, data.monthly_trend || []);
                    renderProjects(data.projects);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderSummary(projects) {
            const totalBudget = projects.reduce((sum, p) => sum + (p.budget || 0), 0);
            const totalSpent = projects.reduce((sum, p) => sum + (p.spent || 0), 0);
            const totalRemaining = totalBudget - totalSpent;
            const avgMargin = totalBudget > 0 ? ((totalRemaining / totalBudget) * 100) : 0;
            const spentPercent = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            
            const html = `
                <div class="summary-card">
                    <div class="summary-card-header">
                        <div class="summary-card-icon">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div class="summary-card-label">Celkový rozpočet</div>
                            <div class="summary-card-value">${formatCurrency(totalBudget)}</div>
                        </div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-header">
                        <div class="summary-card-icon">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div class="summary-card-label">Celkem utraceno</div>
                            <div class="summary-card-value ${spentPercent > 80 ? 'danger' : ''}">${formatCurrency(totalSpent)}</div>
                        </div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-header">
                        <div class="summary-card-icon">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div class="summary-card-label">Zbývá</div>
                            <div class="summary-card-value ${totalRemaining > totalBudget * 0.2 ? 'success' : 'warning'}">${formatCurrency(totalRemaining)}</div>
                        </div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-header">
                        <div class="summary-card-icon">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div class="summary-card-label">Průměrná marže</div>
                            <div class="summary-card-value">${avgMargin.toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('summaryGrid').innerHTML = html;
        }
        
        function renderCharts(projects, monthlyTrend) {
            const totalBudget = projects.reduce((sum, p) => sum + (p.budget || 0), 0);
            const totalSpent = projects.reduce((sum, p) => sum + (p.spent || 0), 0);
            const totalRemaining = totalBudget - totalSpent;
            const spentPercent = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            
            // Donut chart
            const donutCtx = document.getElementById('donutChart');
            if (donutChartInstance) donutChartInstance.destroy();
            donutChartInstance = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Utraceno', 'Zbývá'],
                    datasets: [{
                        data: [totalSpent, totalRemaining],
                        backgroundColor: ['#f87171', '#4ade80'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#9ca8b3', padding: 15 }
                        }
                    }
                }
            });
            
            // Center text
            document.getElementById('donutCenter').innerHTML = `
                <div class="donut-center-value">${spentPercent.toFixed(1)}%</div>
                <div class="donut-center-label">čerpáno</div>
            `;
            
            // Bar chart
            const barCtx = document.getElementById('barChart');
            if (barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: projects.map(p => p.name || p.code || `#${p.id}`),
                    datasets: [
                        { 
                            label: 'Rozpočet', 
                            data: projects.map(p => p.budget || 0), 
                            backgroundColor: '#4ade80' 
                        },
                        { 
                            label: 'Utraceno', 
                            data: projects.map(p => p.spent || 0), 
                            backgroundColor: '#f87171' 
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            ticks: { color: '#9ca8b3' }, 
                            grid: { color: '#2d3439' } 
                        },
                        y: { 
                            ticks: { color: '#e8eef2' }, 
                            grid: { display: false } 
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#9ca8b3', padding: 15 }
                        }
                    }
                }
            });
            
            // Line chart (měsíční trend)
            if (monthlyTrend && monthlyTrend.length > 0) {
                const lineCtx = document.getElementById('lineChart');
                if (lineChartInstance) lineChartInstance.destroy();
                lineChartInstance = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyTrend.map(m => m.label),
                        datasets: [{
                            label: 'Měsíční náklady (Kč)',
                            data: monthlyTrend.map(m => m.cost),
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96,165,250,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#60a5fa'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                ticks: { color: '#9ca8b3' }, 
                                grid: { color: '#2d3439' } 
                            },
                            y: { 
                                ticks: { 
                                    color: '#9ca8b3', 
                                    callback: function(value) {
                                        return value.toLocaleString('cs-CZ') + ' Kč';
                                    }
                                }, 
                                grid: { color: '#2d3439' } 
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { color: '#9ca8b3', padding: 15 }
                            }
                        }
                    }
                });
                document.getElementById('lineChartCard').style.display = 'block';
            }
            
            document.getElementById('chartsGrid').style.display = 'grid';
        }

        function renderProjects(projects) {
            allProjects = projects; // Save for export
            
            if (projects.length === 0) {
                document.getElementById('projectsGrid').innerHTML = 
                    '<div class="empty-state">Žádné aktivní projekty s rozpočtem</div>';
                return;
            }

            let html = '';
            projects.forEach(p => {
                const percent = p.percent_used || 0;
                const isWarning = percent > 80 && percent <= 100;
                const isDanger = percent > 100;
                const statusClass = isDanger ? 'over-budget' : (isWarning ? 'warning' : 'on-track');
                const badgeClass = isDanger ? 'danger' : (isWarning ? 'warning' : 'ok');
                const progressClass = isDanger ? 'danger' : (isWarning ? 'warning' : 'ok');
                
                const statusText = isDanger ? 'Přečerpáno' : (isWarning ? 'Blízko limitu' : '✓ V pořádku');

                html += `<div class="project-card ${statusClass}" onclick="openProject(${p.id})">`;
                html += `<div class="project-header">`;
                html += `<div>`;
                html += `<div class="project-name">${p.name}</div>`;
                if (p.code) html += `<div class="project-code">${p.code}</div>`;
                html += `</div>`;
                html += `<div class="status-badge ${badgeClass}">${statusText}</div>`;
                html += `</div>`;

                html += `<div class="budget-section">`;
                html += `<div class="budget-row">`;
                html += `<div class="budget-label">Utraceno</div>`;
                html += `<div class="budget-value spent">${formatCurrency(p.spent)}</div>`;
                html += `</div>`;
                html += `<div class="budget-row">`;
                html += `<div class="budget-label">Rozpočet</div>`;
                html += `<div class="budget-value budget">${formatCurrency(p.budget)}</div>`;
                html += `</div>`;
                html += `<div class="budget-row">`;
                html += `<div class="budget-label">${isDanger ? 'Překročeno' : 'Zbývá'}</div>`;
                html += `<div class="budget-value ${isDanger ? 'over' : 'remaining'}">${formatCurrency(Math.abs(p.remaining))}</div>`;
                html += `</div>`;
                html += `</div>`;

                html += `<div class="progress-container">`;
                html += `<div class="progress-header">`;
                html += `<div class="progress-label">Využití rozpočtu</div>`;
                html += `<div class="progress-percent">${percent.toFixed(0)}%</div>`;
                html += `</div>`;
                html += `<div class="progress-bar">`;
                html += `<div class="progress-fill ${progressClass}" style="width: ${Math.min(100, percent)}%"></div>`;
                html += `</div>`;
                html += `</div>`;

                if (p.hours_spent) {
                    html += `<div class="hours-summary">`;
                    html += `<svg style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> ${p.hours_spent.toFixed(1)} hodin práce zalogováno`;
                    html += `</div>`;
                }

                html += `</div>`;
            });

            document.getElementById('projectsGrid').innerHTML = html;
        }

        function formatCurrency(amount) {
            if (!amount) return '0 Kč';
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                maximumFractionDigits: 0
            }).format(amount);
        }

        function openProject(id) {
            window.location.href = `/job-detail.html?id=${id}`;
        }
        
        let allProjects = [];
        
        function exportCosts() {
            let csv = 'Projekt,Kód,Status,Rozpočet,Utraceno,Zbývá,Využití %,Hodiny\n';
            allProjects.forEach(p => {
                const status = p.percent_used > 100 ? 'Přečerpáno' : (p.percent_used > 80 ? 'Blízko limitu' : 'V pořádku');
                csv += `"${p.name}","${p.code || ''}","${status}","${p.budget || 0}","${p.spent || 0}","${p.remaining || 0}","${(p.percent_used || 0).toFixed(1)}","${(p.hours_spent || 0).toFixed(1)}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `naklady_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Init
        loadCosts();
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="/static/app-sidebar.js"></script>
  <script src="/static/app-header.js"></script>
</body>
</html>
