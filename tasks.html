<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ãškoly - Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <script src="/app-settings.js"></script>
</head>
<body>
        <div class="page">
            <h1>âœ… Ãškoly</h1>
            <button class="btn-primary" id="btn-new-task">+ NovÃ½ Ãºkol</button>
        </header>

        <!-- Filtry -->
        <div class="filters-bar">
            <button class="filter-btn active" data-filter="all">VÅ¡echny</button>
            <button class="filter-btn" data-filter="my">Moje Ãºkoly</button>
            <button class="filter-btn" data-filter="high">ğŸ”´ VysokÃ¡ priorita</button>
            <button class="filter-btn" data-filter="today">Dnes</button>
        </div>

        <!-- Kanban -->
        <div class="tasks-kanban">
            <div class="task-column">
                <h3>ğŸ“ K dokonÄenÃ­ <span class="count">0</span></h3>
                <div class="task-list" id="tasks-todo"></div>
            </div>

            <div class="task-column">
                <h3>ğŸ”„ ProbÃ­hÃ¡ <span class="count">0</span></h3>
                <div class="task-list" id="tasks-progress"></div>
            </div>

            <div class="task-column">
                <h3>âœ… Hotovo <span class="count">0</span></h3>
                <div class="task-list" id="tasks-done"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>NovÃ½ Ãºkol</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <input type="text" id="task-title" placeholder="NÃ¡zev Ãºkolu" required>
                    <textarea id="task-desc" placeholder="Popis" rows="3"></textarea>
                    <input type="date" id="task-deadline" placeholder="Deadline">
                    <select id="task-priority">
                        <option value="low">ğŸŸ¢ NÃ­zkÃ¡</option>
                        <option value="medium" selected>ğŸŸ¡ StÅ™ednÃ­</option>
                        <option value="high">ğŸ”´ VysokÃ¡</option>
                    </select>
                    <select id="task-assignee">
                        <option value="">Vyberte zamÄ›stnance</option>
                        <option>Petr NovÃ¡k</option>
                        <option>Jana SvobodovÃ¡</option>
                        <option>Martin DvoÅ™Ã¡k</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary close-modal">ZruÅ¡it</button>
                <button class="btn-primary" id="btn-save-task">VytvoÅ™it</button>
            </div>
        </div>
    </div>


    <script src="/static/toast.js"></script>
    <script src="/static/loading.js"></script>
    <script src="/static/global-search.js"></script>
    <script src="/static/keyboard-shortcuts.js"></script>
    <script>
        const mockTasks = [
            {
                id: 1,
                title: "Objednat materiÃ¡l na TÅ™ebonice",
                description: "Obklady, lepidlo, spÃ¡rovacÃ­ hmota",
                status: "todo",
                priority: "high",
                deadline: "2026-01-15",
                assignee: "Petr NovÃ¡k"
            },
            {
                id: 2,
                title: "Kontrola elektroinstalace",
                status: "progress",
                priority: "medium",
                deadline: "2026-01-20",
                assignee: "Jana SvobodovÃ¡"
            },
            {
                id: 3,
                title: "Zavolat klientovi",
                status: "done",
                priority: "low",
                deadline: "2026-01-10",
                assignee: "Martin DvoÅ™Ã¡k"
            },
            {
                id: 4,
                title: "PÅ™ipravit fakturu",
                description: "Faktura za dokonÄenou zakÃ¡zku",
                status: "todo",
                priority: "high",
                deadline: "2026-01-18",
                assignee: "Eva NovÃ¡kovÃ¡"
            },
            {
                id: 5,
                title: "Aktualizovat web",
                status: "progress",
                priority: "low",
                deadline: null,
                assignee: null
            }
        ];

        let tasks = [];
        let currentFilter = 'all';

        // Load tasks
        async function loadTasks() {
            try {
                const res = await fetch('/api/tasks');
                if (res.ok) {
                    const data = await res.json();
                    tasks = (data.tasks || []).map(t => {
                        // Normalize API payload to UI expectations
                        const nt = { ...t };
                        if (!nt.assignee) nt.assignee = nt.employee_name || null;
                        if (!nt.priority) nt.priority = 'medium';
                        // Backend historically used arbitrary statuses; map common ones.
                        if (nt.status === 'open' || nt.status === 'new' || nt.status === null || nt.status === undefined) nt.status = 'todo';
                        if (nt.status === 'in_progress') nt.status = 'progress';
                        if (nt.status === 'resolved' || nt.status === 'closed') nt.status = 'done';
                        return nt;
                    });
                } else {
                    throw new Error('API not available');
                }
            } catch (e) {
                console.warn('API not available, using mock data:', e);
                tasks = [...mockTasks];
            }
            renderTasks();
        }

        function renderTasks() {
            const statusMap = {
                todo: 'tasks-todo',
                progress: 'tasks-progress',
                done: 'tasks-done'
            };

            Object.keys(statusMap).forEach(status => {
                const container = document.getElementById(statusMap[status]);
                if (!container) return;
                
                container.innerHTML = '';
                let filteredTasks = tasks.filter(t => {
                    if (t.status !== status) return false;
                    
                    // Apply filters
                    if (currentFilter === 'my') {
                        // Mock - would check current user
                        return t.assignee !== null;
                    }
                    if (currentFilter === 'high') {
                        return t.priority === 'high';
                    }
                    if (currentFilter === 'today') {
                        if (!t.deadline) return false;
                        const today = new Date().toISOString().slice(0, 10);
                        return t.deadline === today;
                    }
                    return true;
                });
                
                filteredTasks.forEach(task => {
                    const item = createTaskItem(task);
                    container.appendChild(item);
                });
                
                // Update count
                const column = container.closest('.task-column');
                if (column) {
                    column.querySelector('.count').textContent = filteredTasks.length;
                }
            });
        }

        function createTaskItem(task) {
            const item = document.createElement('div');
            item.className = `task-item ${task.status === 'done' ? 'completed' : ''}`;
            item.dataset.taskId = task.id;
            
            const priorityIcon = {
                high: 'ğŸ”´',
                medium: 'ğŸŸ¡',
                low: 'ğŸŸ¢'
            }[task.priority] || 'ğŸŸ¡';
            
            item.innerHTML = `
                <h4>${escapeHtml(task.title)}</h4>
                ${task.description ? `<p style="color: rgba(255,255,255,0.6); font-size: 12px; margin: 4px 0;">${escapeHtml(task.description)}</p>` : ''}
                <div class="task-meta">
                    <span>${priorityIcon}</span>
                    ${task.deadline ? `<span>ğŸ“… ${task.deadline}</span>` : ''}
                    ${task.assignee ? `<span>ğŸ‘¤ ${escapeHtml(task.assignee)}</span>` : ''}
                </div>
            `;
            
            // Click to change status
            item.addEventListener('click', () => {
                if (task.status === 'todo') task.status = 'progress';
                else if (task.status === 'progress') task.status = 'done';
                else task.status = 'todo';
                renderTasks();
                showToast('Status Ãºkolu zmÄ›nÄ›n', 'success');
            });
            
            return item;
        }

        // Modal
        document.getElementById('btn-new-task')?.addEventListener('click', () => {
            document.getElementById('task-modal').classList.add('active');
        });

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('task-modal').classList.remove('active');
            });
        });

        document.getElementById('btn-save-task')?.addEventListener('click', () => {
            const title = document.getElementById('task-title').value.trim();
            if (!title) {
                showToast('VyplÅˆte nÃ¡zev Ãºkolu', 'warning');
                return;
            }
            
            const newTask = {
                id: Math.max(...tasks.map(t => t.id), 0) + 1,
                title: title,
                description: document.getElementById('task-desc').value.trim(),
                status: 'todo',
                priority: document.getElementById('task-priority').value,
                deadline: document.getElementById('task-deadline').value || null,
                assignee: document.getElementById('task-assignee').value || null
            };
            
            tasks.push(newTask);
            renderTasks();
            document.getElementById('task-modal').classList.remove('active');
            document.getElementById('task-form').reset();
            showToast('Ãškol vytvoÅ™en', 'success');
        });

        // Filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderTasks();
            });
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadTasks();
            });
        } else {
            loadTasks();
        }
    </script>
    <div id="bottom-nav-container"></div>
    <script src="/static/bottom-nav.js"></script>
    <link rel="stylesheet" href="/static/icons.css">
    <script src="/static/js/components/header.js"></script>
</body>
</html>
