# ZMÄšNY - 2026-01-05

## ğŸ¯ PROBLÃ‰M
- Tasks a Issues se **nenaÄÃ­taly z databÃ¡ze** po reloadu
- Data byla jen v **localStorage** (ztracenÃ¡ pÅ™i zmÄ›nÄ› prohlÃ­Å¾eÄe)
- Render persistent disk na `/var/data` se **nepouÅ¾Ã­val**
- Issues se **neuklÃ¡daly do databÃ¡ze** pÅ™es API

## âœ… Å˜EÅ ENÃ

### 1ï¸âƒ£ main.py - Oprava databÃ¡zovÃ© cesty

**Å˜Ã¡dky 11-27**: PÅ™idÃ¡na priorita pro `/var/data`

```python
# PÅ˜ED:
if os.path.exists("/persistent"):
    DB_PATH = "/persistent/app.db"
elif os.path.exists("/data"):
    DB_PATH = "/data/app.db"

# PO:
if os.path.exists("/var/data"):
    DB_PATH = "/var/data/app.db"
elif os.path.exists("/persistent"):
    DB_PATH = "/persistent/app.db"
elif os.path.exists("/data"):
    DB_PATH = "/data/app.db"
```

**VÃ½sledek**: Aplikace nynÃ­ pouÅ¾Ã­vÃ¡ tvÅ¯j Render persistent disk na `/var/data/app.db`

---

### 2ï¸âƒ£ jobs.html - KompletnÃ­ pÅ™epis na API

#### A) loadOps() - NynÃ­ naÄÃ­tÃ¡ z API

**PÅ˜ED** (Å™Ã¡dek ~1548):
```javascript
function loadOps(jobId) {
    const raw = localStorage.getItem(opsStorageKey(jobId));
    return { 
        problems: parsed.problems || [],
        todos: []  // âŒ PrÃ¡zdnÃ©!
    };
}
```

**PO**:
```javascript
async function loadOps(jobId) {
    // NaÄte z /api/issues a /api/tasks
    const [issuesRes, tasksRes] = await Promise.all([
        fetch(`/api/issues?job_id=${jobId}`),
        fetch(`/api/tasks?job_id=${jobId}`)
    ]);
    // VracÃ­ reÃ¡lnÃ¡ data z databÃ¡ze
}
```

---

#### B) renderOperativa() - ÄŒekÃ¡ na loadOps

**PÅ˜ED**:
```javascript
function renderOperativa(jobId) {
    const ops = loadOps(jobId);  // âŒ SynchronnÃ­
}
```

**PO**:
```javascript
async function renderOperativa(jobId) {
    const ops = await loadOps(jobId);  // âœ… ÄŒekÃ¡ na API
}
```

---

#### C) addProblem() - UklÃ¡dÃ¡ pÅ™es API

**PÅ˜ED**:
```javascript
function addProblem(jobId) {
    ops.problems.push({...});
    localStorage.setItem(...);  // âŒ Jen localStorage
}
```

**PO**:
```javascript
async function addProblem(jobId) {
    await fetch('/api/issues', {
        method: 'POST',
        body: JSON.stringify({
            job_id: jobId,
            title: title,
            description: note,
            severity: severity,
            assigned_employees: assignedEmployees
        })
    });
    await renderOperativa(jobId);  // Znovu naÄte z API
}
```

---

#### D) addTodo() - UklÃ¡dÃ¡ pÅ™es API

**PÅ˜ED**:
```javascript
function addTodo(jobId) {
    ops.todos.push(newTodo);
    localStorage.setItem(...);
    // "Best-effort" API v pozadÃ­
}
```

**PO**:
```javascript
async function addTodo(jobId) {
    await fetch('/api/tasks', {
        method: 'POST',
        body: JSON.stringify({
            job_id: jobId,
            title: title,
            assigned_employees: assignedEmployees
        })
    });
    await renderOperativa(jobId);  // Znovu naÄte z API
}
```

---

#### E) VÅ¡echny CRUD operace pÅ™es API

| Funkce | Operace | API Endpoint |
|--------|---------|--------------|
| `addProblem()` | VytvoÅ™ issue | `POST /api/issues` |
| `resolveProblem()` | VyÅ™eÅ¡ issue | `PATCH /api/issues` |
| `deleteProblem()` | SmaÅ¾ issue | `DELETE /api/issues?id=X` |
| `addTodo()` | VytvoÅ™ task | `POST /api/tasks` |
| `completeTodo()` | DokonÄi task | `PATCH /api/tasks` |
| `toggleTodo()` | PÅ™epni task | `PATCH /api/tasks` |
| `deleteTodo()` | SmaÅ¾ task | `DELETE /api/tasks?id=X` |

**VÅ¡echny funkce jsou nynÃ­ `async` a ÄekajÃ­ na API odpovÄ›Ä!**

---

## ğŸ“¦ SOUBORY KE COMMITU

```bash
git add main.py jobs.html DEPLOY_NOTES.md ZMENY_2026-01-05.md
git commit -m "Fix: Persistent disk /var/data + API sync for tasks/issues"
git push origin main
```

---

## ğŸ§ª JAK TESTOVAT

### 1. Zkontroluj logs na Renderu:
```
[DB] Using database: /var/data/app.db
```

### 2. OtevÅ™i zakÃ¡zku â†’ Operativa

### 3. PÅ™idej Issue:
- Zadej nÃ¡zev: "Test problÃ©m"
- Vyber zÃ¡vaÅ¾nost
- PÅ™iÅ™aÄ zamÄ›stnance
- Klikni "PÅ™idat"
- **Zkontroluj**: Issue se zobrazÃ­ v seznamu

### 4. Reload strÃ¡nku (F5)
- **Zkontroluj**: Issue je stÃ¡le tam (naÄteno z API)

### 5. PÅ™idej Ãškol:
- Zadej nÃ¡zev: "Test Ãºkol"
- PÅ™iÅ™aÄ zamÄ›stnance
- Klikni "PÅ™idat"
- **Zkontroluj**: Ãškol se zobrazÃ­ v seznamu

### 6. Reload strÃ¡nku (F5)
- **Zkontroluj**: Ãškol je stÃ¡le tam (naÄteno z API)

---

## ğŸ‰ VÃSLEDEK

âœ… **Data se uklÃ¡dajÃ­ do databÃ¡ze** na `/var/data/app.db`  
âœ… **Data pÅ™eÅ¾ijÃ­ reload** prohlÃ­Å¾eÄe  
âœ… **Data pÅ™eÅ¾ijÃ­ redeploy** aplikace  
âœ… **Å½Ã¡dnÃ¡ zÃ¡vislost na localStorage**  
âœ… **VÅ¡echny operace pÅ™es API** s error handlingem

---

## ğŸ”„ CO DÄšLAT PÅ˜Ã CHYBÄš

Pokud nÄ›co nefunguje:

1. **Zkontroluj Render Logs**: MÄ›l by bÃ½t `/var/data/app.db`
2. **Hard refresh**: Cmd+Shift+R (vymaÅ¾e cache)
3. **Zkontroluj Network tab**: MÄ›ly by bÃ½t volÃ¡nÃ­ na `/api/tasks` a `/api/issues`
4. **Zkontroluj Console**: ChybovÃ© hlÃ¡Å¡ky od API

