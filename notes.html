<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Poznámky - green david app</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <link rel="stylesheet" href="/static/css/app.css"/>
  <link rel="stylesheet" href="/static/css/glass-design.css"/>
  <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
  <script src="/app-settings.js"></script>
  <link rel="stylesheet" href="/static/css/sidebar.css"/>
  <link rel="stylesheet" href="/static/css/responsive.css"/>
  <style>
    .notes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    @media (max-width: 1024px) { .notes-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .notes-grid { grid-template-columns: 1fr; } }
    .note-card { background: var(--bg-card, #1a2332); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .note-card:hover { border-color: rgba(45, 212, 191, 0.3); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .note-card-stripe { position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .note-card[data-color="default"] .note-card-stripe { background: #64748b; }
    .note-card[data-color="green"] .note-card-stripe { background: #4ade80; }
    .note-card[data-color="blue"] .note-card-stripe { background: #60a5fa; }
    .note-card[data-color="yellow"] .note-card-stripe { background: #fbbf24; }
    .note-card[data-color="red"] .note-card-stripe { background: #f87171; }
    .note-card[data-color="purple"] .note-card-stripe { background: #a78bfa; }
    .note-category-badge { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); margin-bottom: 8px; }
    .note-pin { position: absolute; top: 10px; right: 10px; }
    .note-pin svg { width: 16px; height: 16px; stroke: #fbbf24; }
    .note-title { font-size: 15px; font-weight: 600; color: #e2e8f0; margin: 0 0 6px 0; }
    .note-content-preview { font-size: 13px; color: rgba(255,255,255,0.5); line-height: 1.5; margin: 0 0 12px 0; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
    .note-links { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
    .note-link { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 2px 8px; border-radius: 6px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); }
    .note-link svg { width: 12px; height: 12px; }
    .note-link.job svg { stroke: #60a5fa; }
    .note-link.employee svg { stroke: #4ade80; }
    .note-link.party svg { stroke: #a78bfa; }
    .note-card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.06); padding-top: 10px; margin-top: 4px; }
    .note-date { font-size: 11px; color: rgba(255,255,255,0.3); }
    .note-actions { display: flex; gap: 4px; }
    .note-actions button { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 6px; opacity: 0; transition: opacity 0.2s; }
    .note-card:hover .note-actions button { opacity: 0.6; }
    .note-actions button:hover { opacity: 1 !important; background: rgba(255,255,255,0.08); }
    .note-actions button svg { width: 16px; height: 16px; stroke: rgba(255,255,255,0.5); }
    .note-color-picker { display: flex; gap: 8px; }
    .color-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
    .color-dot.active, .color-dot:hover { border-color: white; transform: scale(1.15); }
    .note-link-selectors { display: flex; flex-direction: column; gap: 10px; }
    .link-row { display: flex; align-items: center; gap: 10px; }
    .link-row svg { width: 18px; height: 18px; stroke: rgba(255,255,255,0.4); flex-shrink: 0; }
    .link-row select { flex: 1; }
    .notes-filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .notes-filters input, .notes-filters select { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 14px; color: #e2e8f0; font-size: 13px; }
    .notes-filters input { flex: 1; min-width: 200px; }
    .notes-empty { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4); }
    .notes-empty svg { width: 64px; height: 64px; stroke: rgba(255,255,255,0.15); margin-bottom: 16px; }
    .page-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .page-icon svg { width: 24px; height: 24px; }
  </style>
</head>
<body class="has-sidebar">
  <div id="app-header"></div>

  <div class="notes-content" style="padding: 16px 28px 20px;">
  <div style="display:flex; justify-content:flex-end; gap:12px; flex-wrap:wrap; margin-bottom:20px;">
    <button class="btn-secondary" onclick="exportNotes()">
      <svg style="width:18px;height:18px;display:inline-block;vertical-align:middle;margin-right:6px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export
    </button>
    <button class="btn-primary" onclick="openNewNoteModal()">+ Nová poznámka</button>
  </div>

  <!-- KPI Karty -->
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-icon time">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
      </div>
      <div>
        <div class="kpi-label">Celkem poznámek</div>
        <div class="kpi-value" id="statTotal">0</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon average">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div>
        <div class="kpi-label">Tento týden</div>
        <div class="kpi-value" id="statWeek">0</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon projects">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </div>
      <div>
        <div class="kpi-label">Připnuté</div>
        <div class="kpi-value" id="statPinned">0</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon team">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/></svg>
      </div>
      <div>
        <div class="kpi-label">Nejčastější kategorie</div>
        <div class="kpi-value" id="statCategory">-</div>
      </div>
    </div>
  </div>

  <!-- Filtry -->
  <div class="notes-filters">
    <input type="text" id="filterSearch" placeholder="Hledat v poznámkách..." oninput="debouncedLoadNotes()">
    <select id="filterCategory" onchange="loadNotes()">
      <option value="">Všechny kategorie</option>
      <option value="general">Obecné</option>
      <option value="measurement">Výměry / Měření</option>
      <option value="observation">Postřehy</option>
      <option value="idea">Nápady</option>
      <option value="reminder">Připomínky</option>
      <option value="issue">Problémy</option>
    </select>
    <select id="filterLink" onchange="loadNotes()">
      <option value="">Všechny vazby</option>
      <option value="free">Volné poznámky</option>
      <option value="job">K zakázkám</option>
      <option value="employee">K pracovníkům</option>
      <option value="party">K firmám</option>
    </select>
  </div>

  <!-- Seznam poznámek -->
  <div id="notesContainer">
    <div class="notes-grid" id="notesGrid"></div>
    <div class="notes-empty" id="notesEmpty" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
      <p>Žádné poznámky. Klikněte na „Nová poznámka“ a začněte psát.</p>
    </div>
  </div>

  </div><!-- .notes-content -->

  <!-- Modal nová/editace poznámky -->
  <div class="modal-overlay" id="noteModal" style="display:none" onclick="if(event.target===this)closeNoteModal()">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h2 id="noteModalTitle">Nová poznámka</h2>
        <button class="modal-close" onclick="closeNoteModal()" style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;padding:4px;">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-size:13px;">Nadpis <small style="color:rgba(255,255,255,0.5);">(volitelné)</small></label>
          <input type="text" id="noteTitle" placeholder="Krátký nadpis..." class="form-input" style="width:100%;"/>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-size:13px;">Poznámka *</label>
          <textarea id="noteContent" rows="6" placeholder="Zapište poznámku, výměry, postřehy..." class="form-input" style="resize:vertical;width:100%;"></textarea>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-size:13px;">Kategorie</label>
          <select id="noteCategory" class="form-input" style="width:100%;">
            <option value="general">Obecné</option>
            <option value="measurement">Výměry / Měření</option>
            <option value="observation">Postřehy</option>
            <option value="idea">Nápady</option>
            <option value="reminder">Připomínky</option>
            <option value="issue">Problémy</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-size:13px;">Barva</label>
          <div class="note-color-picker">
            <button type="button" class="color-dot active" data-color="default" style="background:#64748b"></button>
            <button type="button" class="color-dot" data-color="green" style="background:#4ade80"></button>
            <button type="button" class="color-dot" data-color="blue" style="background:#60a5fa"></button>
            <button type="button" class="color-dot" data-color="yellow" style="background:#fbbf24"></button>
            <button type="button" class="color-dot" data-color="red" style="background:#f87171"></button>
            <button type="button" class="color-dot" data-color="purple" style="background:#a78bfa"></button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-size:13px;">Navázat na</label>
          <div class="note-link-selectors">
            <div class="link-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
              <select id="noteJobId" class="form-input">
                <option value="">— žádná zakázka —</option>
              </select>
            </div>
            <div class="link-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              <select id="noteEmployeeId" class="form-input">
                <option value="">— žádný pracovník —</option>
              </select>
            </div>
            <div class="link-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
              <select id="notePartyId" class="form-input">
                <option value="">— žádná firma —</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex;gap:12px;justify-content:flex-end;padding:16px 24px;border-top:1px solid rgba(255,255,255,0.1);">
        <button class="btn-secondary" onclick="closeNoteModal()">Zrušit</button>
        <button class="btn-primary" onclick="saveNote()">Uložit poznámku</button>
      </div>
    </div>
  </div>

  <!-- Modal detail poznámky -->
  <div class="modal-overlay" id="noteDetailModal" style="display:none" onclick="if(event.target===this)closeNoteDetailModal()">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h2 id="noteDetailTitle">Detail poznámky</h2>
        <button class="modal-close" onclick="closeNoteDetailModal()" style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;padding:4px;">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="noteDetailBody"></div>
      <div class="modal-footer" style="display:flex;gap:12px;justify-content:flex-end;padding:16px 24px;border-top:1px solid rgba(255,255,255,0.1);">
        <button class="btn-secondary" onclick="closeNoteDetailModal()">Zavřít</button>
        <button class="btn-primary" id="btnEditFromDetail" onclick="editNoteFromDetail()">Upravit</button>
      </div>
    </div>
  </div>

  <div id="bottom-nav-container"></div>
  <script src="/static/bottom-nav.js"></script>
  <link rel="stylesheet" href="/static/icons.css">
  <script src="/static/app-header.js"></script>
  <script src="/static/navigation.js"></script>
  <script src="/static/toast.js"></script>
  <script src="/static/loading.js"></script>
  <script src="/static/app-sidebar.js"></script>

  <script>
    const CATEGORY_LABELS = {
      general: 'Obecné',
      measurement: 'Výměry',
      observation: 'Postřehy',
      idea: 'Nápady',
      reminder: 'Připomínky',
      issue: 'Problémy'
    };

    let editingNoteId = null;
    let currentDetailNote = null;

    function formatDate(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      const day = String(d.getDate()).padStart(2,'0');
      const month = String(d.getMonth()+1).padStart(2,'0');
      const year = d.getFullYear();
      const h = String(d.getHours()).padStart(2,'0');
      const m = String(d.getMinutes()).padStart(2,'0');
      return `${day}.${month}.${year} ${h}:${m}`;
    }

    function truncate(txt, len) {
      if (!txt) return '';
      return txt.length > len ? txt.substring(0, len) + '…' : txt;
    }

    async function loadNotes() {
      const params = new URLSearchParams();
      const cat = document.getElementById('filterCategory').value;
      const link = document.getElementById('filterLink').value;
      const search = document.getElementById('filterSearch').value.trim();
      if (cat) params.set('category', cat);
      if (link === 'free' || link === 'job' || link === 'employee' || link === 'party') params.set('link_type', link);
      if (search) params.set('search', search);

      try {
        const res = await fetch('/api/notes?' + params.toString());
        const data = await res.json();
        const notes = data.notes || [];
        renderNotes(notes);
      } catch (e) {
        if (window.showToast) window.showToast('Chyba při načítání poznámek', 'error');
      }
    }

    function renderNotes(notes) {
      const grid = document.getElementById('notesGrid');
      const empty = document.getElementById('notesEmpty');
      grid.innerHTML = '';
      if (notes.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      for (const n of notes) {
        const card = document.createElement('div');
        card.className = 'note-card';
        card.dataset.id = n.id;
        card.dataset.color = n.color || 'default';
        card.onclick = (e) => { if (!e.target.closest('.note-actions')) openNoteDetail(n.id); };

        const stripe = document.createElement('div');
        stripe.className = 'note-card-stripe';
        card.appendChild(stripe);

        if (n.is_pinned) {
          const pin = document.createElement('div');
          pin.className = 'note-pin';
          pin.title = 'Připnuto';
          pin.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>';
          card.appendChild(pin);
        }

        const badge = document.createElement('span');
        badge.className = 'note-category-badge';
        badge.textContent = CATEGORY_LABELS[n.category] || n.category;
        card.appendChild(badge);

        if (n.title) {
          const h3 = document.createElement('h3');
          h3.className = 'note-title';
          h3.textContent = n.title;
          card.appendChild(h3);
        }

        const preview = document.createElement('p');
        preview.className = 'note-content-preview';
        preview.textContent = truncate(n.content || '', 150);
        card.appendChild(preview);

        const links = document.createElement('div');
        links.className = 'note-links';
        if (n.job_title || n.job_code) {
          const j = document.createElement('span');
          j.className = 'note-link job';
          j.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="14" rx="2"/></svg> Zakázka: ' + (n.job_title || n.job_code || '');
          links.appendChild(j);
        }
        if (n.employee_name) {
          const e = document.createElement('span');
          e.className = 'note-link employee';
          e.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> ' + n.employee_name;
          links.appendChild(e);
        }
        if (n.party_name) {
          const p = document.createElement('span');
          p.className = 'note-link party';
          p.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg> ' + n.party_name;
          links.appendChild(p);
        }
        if (links.children.length) card.appendChild(links);

        const footer = document.createElement('div');
        footer.className = 'note-card-footer';
        footer.innerHTML = '<span class="note-date">' + formatDate(n.updated_at || n.created_at) + '</span>';
        const actions = document.createElement('div');
        actions.className = 'note-actions';
        actions.innerHTML = '<button type="button" onclick="pinNote(' + n.id + ', event)" title="Připnout"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>' +
          '<button type="button" onclick="editNote(' + n.id + ', event)" title="Upravit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>' +
          '<button type="button" onclick="deleteNote(' + n.id + ', event)" title="Smazat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>';
        footer.appendChild(actions);
        card.appendChild(footer);
        grid.appendChild(card);
      }
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/notes/stats');
        const data = await res.json();
        document.getElementById('statTotal').textContent = data.total || 0;
        document.getElementById('statWeek').textContent = data.this_week || 0;
        document.getElementById('statPinned').textContent = data.pinned || 0;
        document.getElementById('statCategory').textContent = data.top_category || '-';
      } catch (e) {}
    }

    async function loadLinkOptions() {
      try {
        const [jRes, eRes, pRes] = await Promise.all([
          fetch('/api/jobs').then(r => r.json()).catch(() => ({ jobs: [] })),
          fetch('/api/employees').then(r => r.json()).catch(() => ({ employees: [] })),
          fetch('/api/parties?limit=200').then(r => r.json()).catch(() => ({ parties: [] }))
        ]);
        const jobs = (jRes.jobs || jRes) || [];
        const employees = (eRes.employees || eRes) || [];
        const parties = (pRes.parties || pRes) || [];

        const jobSel = document.getElementById('noteJobId');
        const empSel = document.getElementById('noteEmployeeId');
        const partySel = document.getElementById('notePartyId');
        const curJob = jobSel.value;
        const curEmp = empSel.value;
        const curParty = partySel.value;

        jobSel.innerHTML = '<option value="">— žádná zakázka —</option>';
        jobs.forEach(j => { const o = document.createElement('option'); o.value = j.id; o.textContent = (j.title || j.name || j.code || '') + (j.code ? ' (' + j.code + ')' : ''); jobSel.appendChild(o); });
        empSel.innerHTML = '<option value="">— žádný pracovník —</option>';
        employees.forEach(e => { const o = document.createElement('option'); o.value = e.id; o.textContent = e.name || ''; empSel.appendChild(o); });
        partySel.innerHTML = '<option value="">— žádná firma —</option>';
        parties.forEach(p => { const o = document.createElement('option'); o.value = p.id; o.textContent = p.display_name || p.legal_name || ''; partySel.appendChild(o); });

        if (curJob) jobSel.value = curJob;
        if (curEmp) empSel.value = curEmp;
        if (curParty) partySel.value = curParty;
      } catch (e) {}
    }

    let debounceTimer;
    function debouncedLoadNotes() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(loadNotes, 300);
    }

    function openNewNoteModal() {
      editingNoteId = null;
      document.getElementById('noteModalTitle').textContent = 'Nová poznámka';
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteContent').value = '';
      document.getElementById('noteCategory').value = 'general';
      document.getElementById('noteJobId').value = '';
      document.getElementById('noteEmployeeId').value = '';
      document.getElementById('notePartyId').value = '';
      document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
      document.querySelector('.color-dot[data-color="default"]').classList.add('active');
      loadLinkOptions();
      document.getElementById('noteModal').style.display = 'flex';
    }

    function closeNoteModal() {
      document.getElementById('noteModal').style.display = 'none';
    }

    async function editNote(id, ev) {
      if (ev) ev.stopPropagation();
      try {
        const res = await fetch('/api/notes/' + id);
        const note = await res.json();
        if (!note.id) { if (window.showToast) window.showToast('Poznámka nenalezena', 'error'); return; }
        editingNoteId = id;
        document.getElementById('noteModalTitle').textContent = 'Upravit poznámku';
        document.getElementById('noteTitle').value = note.title || '';
        document.getElementById('noteContent').value = note.content || '';
        document.getElementById('noteCategory').value = note.category || 'general';
        document.getElementById('noteJobId').value = note.job_id || '';
        document.getElementById('noteEmployeeId').value = note.employee_id || '';
        document.getElementById('notePartyId').value = note.party_id || '';
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
        const cd = document.querySelector('.color-dot[data-color="' + (note.color || 'default') + '"]');
        if (cd) cd.classList.add('active'); else document.querySelector('.color-dot[data-color="default"]').classList.add('active');
        loadLinkOptions();
        document.getElementById('noteModal').style.display = 'flex';
      } catch (e) {
        if (window.showToast) window.showToast('Chyba při načítání poznámky', 'error');
      }
    }

    async function saveNote() {
      const content = document.getElementById('noteContent').value.trim();
      if (!content) {
        if (window.showToast) window.showToast('Obsah poznámky je povinný', 'error');
        return;
      }
      const payload = {
        title: document.getElementById('noteTitle').value.trim() || undefined,
        content,
        category: document.getElementById('noteCategory').value,
        color: document.querySelector('.color-dot.active')?.dataset.color || 'default',
        job_id: document.getElementById('noteJobId').value || null,
        employee_id: document.getElementById('noteEmployeeId').value || null,
        party_id: document.getElementById('notePartyId').value || null
      };
      if (payload.job_id === '') payload.job_id = null;
      if (payload.employee_id === '') payload.employee_id = null;
      if (payload.party_id === '') payload.party_id = null;

      try {
        if (editingNoteId) {
          const res = await fetch('/api/notes/' + editingNoteId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Chyba');
          if (window.showToast) window.showToast('Poznámka uložena', 'success');
        } else {
          const res = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Chyba');
          if (window.showToast) window.showToast('Poznámka vytvořena', 'success');
        }
        closeNoteModal();
        loadNotes();
        loadStats();
      } catch (e) {
        if (window.showToast) window.showToast(e.message || 'Chyba při ukládání', 'error');
      }
    }

    async function deleteNote(id, ev) {
      if (ev) ev.stopPropagation();
      if (!confirm('Smazat tuto poznámku?')) return;
      try {
        const res = await fetch('/api/notes/' + id, { method: 'DELETE' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        if (window.showToast) window.showToast('Poznámka smazána', 'success');
        closeNoteDetailModal();
        loadNotes();
        loadStats();
      } catch (e) {
        if (window.showToast) window.showToast('Chyba při mazání', 'error');
      }
    }

    async function pinNote(id, ev) {
      if (ev) ev.stopPropagation();
      try {
        const res = await fetch('/api/notes/' + id + '/pin', { method: 'PUT' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        if (window.showToast) window.showToast(data.is_pinned ? 'Poznámka připnuta' : 'Poznámka odepnuta', 'success');
        loadNotes();
        loadStats();
      } catch (e) {
        if (window.showToast) window.showToast('Chyba', 'error');
      }
    }

    async function openNoteDetail(id) {
      try {
        const res = await fetch('/api/notes/' + id);
        const note = await res.json();
        if (!note.id) return;
        currentDetailNote = note;
        document.getElementById('noteDetailTitle').textContent = note.title || 'Bez nadpisu';
        const body = document.getElementById('noteDetailBody');
        body.innerHTML = '<p style="white-space:pre-wrap;margin:0 0 12px 0;">' + (note.content || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>' +
          '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">' +
          (note.job_title || note.job_code ? '<span class="note-link job">Zakázka: ' + (note.job_title || note.job_code) + '</span>' : '') +
          (note.employee_name ? '<span class="note-link employee">' + note.employee_name + '</span>' : '') +
          (note.party_name ? '<span class="note-link party">' + note.party_name + '</span>' : '') +
          '</div>' +
          '<div style="font-size:12px;color:rgba(255,255,255,0.4);">' + formatDate(note.updated_at || note.created_at) + '</div>';
        document.getElementById('btnEditFromDetail').onclick = () => { closeNoteDetailModal(); editNote(id); };
        document.getElementById('noteDetailModal').style.display = 'flex';
      } catch (e) {}
    }

    function closeNoteDetailModal() {
      document.getElementById('noteDetailModal').style.display = 'none';
      currentDetailNote = null;
    }

    function editNoteFromDetail() {
      if (currentDetailNote) editNote(currentDetailNote.id);
    }

    async function exportNotes() {
      try {
        const res = await fetch('/api/notes?limit=9999');
        const data = await res.json();
        const notes = data.notes || [];
        const rows = [['ID','Nadpis','Obsah','Kategorie','Barva','Připnuto','Zakázka','Pracovník','Firma','Vytvořeno','Upraveno']];
        for (const n of notes) {
          rows.push([
            n.id,
            (n.title || '').replace(/"/g,'""'),
            (n.content || '').replace(/"/g,'""').replace(/\n/g,' '),
            n.category || '',
            n.color || '',
            n.is_pinned ? 'ano' : 'ne',
            n.job_title || n.job_code || '',
            n.employee_name || '',
            n.party_name || '',
            n.created_at || '',
            n.updated_at || ''
          ]);
        }
        const csv = rows.map(r => r.map(c => '"' + c + '"').join(',')).join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'poznamky-' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
        URL.revokeObjectURL(a.href);
        if (window.showToast) window.showToast('Export dokončen: ' + notes.length + ' poznámek', 'success');
      } catch (e) {
        if (window.showToast) window.showToast('Chyba při exportu', 'error');
      }
    }

    document.querySelectorAll('.note-color-picker .color-dot').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.note-color-picker .color-dot').forEach(d => d.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadNotes();
      loadStats();
    });
  </script>
</body>
</html>
