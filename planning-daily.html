<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control | Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <link rel="stylesheet" href="/static/css/glass-design.css"/>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
    <link rel="stylesheet" href="/static/icons.css">
    <script src="/static/js/debug.js"></script>
    <script src="/app-settings.js"></script>
    <style>
    :root {
        --mc-bg: #080c14;
        --mc-s1: #111827;
        --mc-s2: #1a2332;
        --mc-s3: #243044;
        --mc-brd: #1e2d45;
        --mc-t1: #f1f5f9;
        --mc-t2: #94a3b8;
        --mc-t3: #475569;
        --mc-grn: #4ade80;
        --mc-grn-d: rgba(74,222,128,0.1);
        --mc-red: #f87171;
        --mc-red-d: rgba(248,113,113,0.1);
        --mc-amb: #fbbf24;
        --mc-amb-d: rgba(251,191,36,0.1);
        --mc-blu: #60a5fa;
        --mc-blu-d: rgba(96,165,250,0.1);
        --mc-pur: #a78bfa;
    }

    .mc { max-width: 1400px; margin: 0 auto; padding: 0 16px 100px; }

    /* ── Sub-nav (Dnes/Timeline/Týden/Náklady) ── */
    .mc-subnav {
        display: flex; align-items: center; gap: 8px; padding: 16px 0 14px;
        border-bottom: 1px solid var(--mc-brd); margin-bottom: 24px; flex-wrap: wrap;
        margin-top: 8px;
    }
    .mc-subnav a {
        padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
        text-decoration: none; transition: all 0.15s;
        background: var(--mc-s1); border: 1px solid var(--mc-brd); color: var(--mc-t2);
    }
    .mc-subnav a:hover { background: var(--mc-s2); color: var(--mc-t1); }
    .mc-subnav a.active { background: var(--mc-grn); color: #0a0e11; border-color: var(--mc-grn); }
    .mc-subnav .spacer { flex: 1; }

    /* ── Date strip ── */
    .mc-datestrip {
        display: flex; align-items: center; gap: 10px; justify-content: center;
        margin-bottom: 24px;
    }
    .mc-datestrip button {
        padding: 8px 14px; background: var(--mc-s1); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t2); font-size: 13px; font-weight: 600;
        cursor: pointer; transition: all 0.15s;
    }
    .mc-datestrip button:hover { background: var(--mc-s2); color: var(--mc-t1); border-color: var(--mc-t3); }
    .mc-datestrip button.today-btn { background: var(--mc-grn); color: #0a0e11; border-color: var(--mc-grn); }
    .mc-datestrip .date-display {
        font-size: 20px; font-weight: 800; color: var(--mc-t1); min-width: 220px; text-align: center;
    }
    .mc-datestrip .date-display .day-name {
        font-size: 13px; font-weight: 600; color: var(--mc-grn); text-transform: uppercase;
        letter-spacing: 0.5px; display: block; margin-bottom: 2px;
    }
    .mc-datestrip .date-display:hover { color: var(--mc-grn); transition: color 0.2s; }

    /* ── Score Ring Row ── */
    .mc-score-row {
        display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px;
    }
    @media(max-width:700px){ .mc-score-row { grid-template-columns: 1fr 1fr; } }
    .mc-score-card {
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 14px;
        padding: 18px; display: flex; align-items: center; gap: 14px;
        transition: border-color 0.15s;
    }
    .mc-score-card:hover { border-color: var(--mc-t3); }
    .mc-ring {
        width: 52px; height: 52px; position: relative; flex-shrink: 0;
    }
    .mc-ring svg { width: 52px; height: 52px; transform: rotate(-90deg); }
    .mc-ring .ring-bg { fill: none; stroke: var(--mc-s3); stroke-width: 4; }
    .mc-ring .ring-fg { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }
    .mc-ring .ring-val {
        position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: 800; color: var(--mc-t1);
    }
    .mc-score-info { flex: 1; min-width: 0; }
    .mc-score-label { font-size: 10px; font-weight: 700; color: var(--mc-t3); text-transform: uppercase; letter-spacing: 0.5px; }
    .mc-score-val { font-size: 22px; font-weight: 800; color: var(--mc-t1); margin: 2px 0; }
    .mc-score-sub { font-size: 11px; color: var(--mc-t3); }

    /* ── Signals (alerts) ── */
    .mc-signals { display: grid; gap: 8px; margin-bottom: 24px; }
    .mc-signal {
        display: flex; align-items: center; gap: 12px; padding: 14px 16px;
        border-radius: 10px; font-size: 13px; font-weight: 500;
        cursor: pointer; transition: all 0.12s;
    }
    .mc-signal:hover { transform: translateX(4px); }
    .mc-signal.red { background: var(--mc-red-d); border-left: 3px solid var(--mc-red); color: var(--mc-red); }
    .mc-signal.amber { background: var(--mc-amb-d); border-left: 3px solid var(--mc-amb); color: var(--mc-amb); }
    .mc-signal.blue { background: var(--mc-blu-d); border-left: 3px solid var(--mc-blu); color: var(--mc-blu); }
    .mc-signal.green { background: var(--mc-grn-d); border-left: 3px solid var(--mc-grn); color: var(--mc-grn); }
    .mc-signal svg { width: 18px; height: 18px; flex-shrink: 0; }
    .mc-signal .sig-text { flex: 1; }
    .mc-signal .sig-count {
        font-weight: 800; font-size: 15px; padding: 2px 10px;
        border-radius: 6px; background: rgba(255,255,255,0.06);
    }

    /* ── Sections ── */
    .mc-section { margin-bottom: 28px; }
    .mc-sec-hdr {
        display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
        padding-bottom: 10px; border-bottom: 1px solid var(--mc-brd);
    }
    .mc-sec-hdr svg { width: 20px; height: 20px; stroke: var(--mc-grn); fill: none; stroke-width: 2; }
    .mc-sec-title { font-size: 16px; font-weight: 700; color: var(--mc-t1); }
    .mc-sec-count {
        font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px;
        background: var(--mc-s2); color: var(--mc-t3);
    }
    .mc-sec-action {
        margin-left: auto; font-size: 12px; color: var(--mc-grn); font-weight: 600;
        text-decoration: none; padding: 4px 10px; border-radius: 6px;
    }
    .mc-sec-action:hover { background: var(--mc-grn-d); }

    /* ── Team Grid ── */
    .mc-team-grid { display: grid; gap: 6px; }
    .mc-team-row {
        display: grid; grid-template-columns: 200px 1fr 80px 80px; gap: 12px;
        align-items: start; padding: 12px 14px; background: var(--mc-s1);
        border: 1px solid var(--mc-brd); border-radius: 10px; font-size: 13px;
        transition: border-color 0.12s;
    }
    .mc-team-row > * {
        display: flex; align-items: center;
    }
    .mc-team-row > .mc-emp-name-wrapper {
        align-items: flex-start;
    }
    .mc-team-row:hover { border-color: var(--mc-t3); }
    .mc-team-row.header {
        background: transparent; border: none; font-size: 10px; font-weight: 700;
        color: var(--mc-t3); text-transform: uppercase; letter-spacing: 0.4px;
        padding: 0 14px 4px;
    }
    @media(max-width:600px){ .mc-team-row { grid-template-columns: 1fr 1fr; } .mc-team-row.header { display:none; } }
    .mc-emp-name { font-weight: 600; color: var(--mc-t1); display: flex; align-items: center; gap: 8px; }
    .mc-emp-name-wrapper {
        display: flex; flex-direction: column; gap: 6px; min-width: 0;
    }
    .mc-emp-name-row {
        display: flex; align-items: center; gap: 8px;
    }
    .mc-emp-avatar {
        width: 28px; height: 28px; border-radius: 50%; background: var(--mc-s3);
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 700; color: var(--mc-grn); flex-shrink: 0;
    }
    .mc-emp-capacity {
        display: flex; align-items: center; gap: 8px; font-size: 11px;
    }
    .mc-emp-capacity-bar {
        flex: 1; height: 6px; background: var(--mc-s3); border-radius: 3px; overflow: hidden;
        min-width: 60px;
    }
    .mc-emp-capacity-fill {
        height: 100%; border-radius: 3px; transition: width 0.3s ease, background-color 0.3s ease;
    }
    .mc-emp-capacity-fill.green { background: var(--mc-grn); }
    .mc-emp-capacity-fill.orange { background: var(--mc-amb); }
    .mc-emp-capacity-fill.red { background: var(--mc-red); }
    .mc-emp-capacity-text {
        font-weight: 600; color: var(--mc-t2); white-space: nowrap; font-size: 10px;
    }
    .mc-emp-job { color: var(--mc-t2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mc-emp-hours { font-weight: 700; color: var(--mc-grn); text-align: center; }
    .mc-emp-status { text-align: center; }
    .mc-status-dot {
        display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px;
    }
    .mc-status-dot.active { background: var(--mc-grn); }
    .mc-status-dot.idle { background: var(--mc-t3); }

    /* ── Task List ── */
    .mc-task-list { display: grid; gap: 6px; }
    .mc-task {
        display: flex; align-items: center; gap: 12px; padding: 12px 14px;
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 10px;
        transition: all 0.12s; cursor: pointer;
    }
    .mc-task:hover { border-color: var(--mc-t3); transform: translateX(2px); }
    .mc-task-pri {
        width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0;
    }
    .mc-task-pri.high { background: var(--mc-red); }
    .mc-task-pri.medium { background: var(--mc-amb); }
    .mc-task-pri.low { background: var(--mc-blu); }
    .mc-task-pri.none { background: var(--mc-t3); }
    .mc-task-body { flex: 1; min-width: 0; }
    .mc-task-title { font-size: 14px; font-weight: 600; color: var(--mc-t1); }
    .mc-task-meta { font-size: 11px; color: var(--mc-t3); margin-top: 2px; display: flex; gap: 10px; flex-wrap: wrap; }
    .mc-task-badge {
        padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.2px;
    }
    .mc-task-badge.overdue { background: var(--mc-red-d); color: var(--mc-red); }
    .mc-task-badge.today { background: var(--mc-amb-d); color: var(--mc-amb); }
    .mc-task-badge.upcoming { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-task-badge.nodate { background: rgba(255,255,255,0.05); color: var(--mc-t3); }

    /* ── Job Cards ── */
    .mc-jobs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    .mc-job {
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 12px;
        padding: 16px; cursor: pointer; transition: all 0.15s;
    }
    .mc-job:hover { border-color: var(--mc-grn); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    .mc-job-hdr { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .mc-job-name { font-size: 15px; font-weight: 700; color: var(--mc-t1); }
    .mc-job-status {
        padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase;
    }
    .mc-job-status.plan { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-job-status.active { background: var(--mc-grn-d); color: var(--mc-grn); }
    .mc-job-meta { font-size: 12px; color: var(--mc-t3); display: flex; flex-direction: column; gap: 4px; }
    .mc-job-progress {
        height: 4px; background: var(--mc-s3); border-radius: 2px; margin-top: 10px; overflow: hidden;
    }
    .mc-job-progress-bar { height: 100%; border-radius: 2px; transition: width 0.4s ease; }

    /* ── Suggestions ── */
    .mc-suggest {
        display: flex; gap: 12px; padding: 14px 16px; background: var(--mc-s1);
        border: 1px solid var(--mc-brd); border-radius: 10px; margin-bottom: 6px;
        border-left: 3px solid var(--mc-pur);
    }
    .mc-suggest-icon {
        width: 32px; height: 32px; background: rgba(167,139,250,0.1); border-radius: 8px;
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .mc-suggest-icon svg { width: 16px; height: 16px; stroke: var(--mc-pur); }
    .mc-suggest-body { flex: 1; }
    .mc-suggest-title { font-size: 13px; font-weight: 700; color: var(--mc-t1); }
    .mc-suggest-desc { font-size: 12px; color: var(--mc-t3); margin-top: 2px; }

    /* ── Empty ── */
    .mc-empty {
        text-align: center; padding: 32px; color: var(--mc-t3); font-size: 13px;
    }
    .mc-empty svg { display: block; margin: 0 auto 10px; opacity: 0.2; }

    /* ── Weather Card ── */
    .mc-weather-card {
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 14px;
        padding: 20px; margin-bottom: 24px; position: relative; overflow: hidden;
    }
    .mc-weather-card::before {
        content: ''; position: absolute; inset: 0; opacity: 0.15; pointer-events: none;
        background: linear-gradient(135deg, var(--mc-blu) 0%, var(--mc-s2) 100%);
        z-index: 0;
    }
    .mc-weather-card.weather-clear::before {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }
    .mc-weather-card.weather-clouds::before {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }
    .mc-weather-card.weather-rain::before {
        background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
    }
    .mc-weather-card.weather-error::before {
        background: linear-gradient(135deg, var(--mc-s2) 0%, var(--mc-s3) 100%);
    }
    .mc-weather-content {
        position: relative; z-index: 1; display: grid; grid-template-columns: auto 1fr auto;
        gap: 20px; align-items: start;
    }
    @media(max-width:600px){ .mc-weather-content { grid-template-columns: 1fr; } }
    .mc-weather-main {
        display: flex; flex-direction: column; gap: 8px;
    }
    .mc-weather-title {
        font-size: 13px; font-weight: 700; color: var(--mc-t3); text-transform: uppercase;
        letter-spacing: 0.5px; margin-bottom: 4px;
    }
    .mc-weather-temp {
        font-size: 36px; font-weight: 800; color: var(--mc-t1); line-height: 1;
    }
    .mc-weather-desc {
        font-size: 14px; font-weight: 600; color: var(--mc-t2); margin-top: 4px;
    }
    .mc-weather-feels {
        font-size: 11px; color: var(--mc-t3); margin-top: 2px;
    }
    .mc-weather-details {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; flex: 1;
    }
    @media(max-width:600px){ .mc-weather-details { grid-template-columns: 1fr; } }
    .mc-weather-detail {
        display: flex; flex-direction: column; gap: 4px;
    }
    .mc-weather-detail-label {
        font-size: 10px; font-weight: 700; color: var(--mc-t3); text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .mc-weather-detail-value {
        font-size: 14px; font-weight: 600; color: var(--mc-t1);
    }
    .mc-weather-warning {
        grid-column: 1 / -1; padding: 12px; border-radius: 8px; margin-top: 8px;
        background: var(--mc-red-d); border-left: 3px solid var(--mc-red);
        display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600;
        color: var(--mc-red);
    }
    .mc-weather-warning svg {
        width: 18px; height: 18px; flex-shrink: 0; stroke: var(--mc-red);
    }
    .mc-weather-icon {
        width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); border-radius: 12px; flex-shrink: 0;
    }
    .mc-weather-icon svg {
        width: 48px; height: 48px; stroke: var(--mc-t1); fill: none; stroke-width: 1.5;
    }
    .mc-weather-error {
        text-align: center; padding: 20px; color: var(--mc-t3); font-size: 13px;
    }

    /* ── Task Filters ── */
    .mc-task-filters {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .mc-task-filters select {
        background: var(--mc-s2);
        border: 1px solid var(--mc-brd);
        border-radius: 8px;
        color: var(--mc-t2);
        padding: 6px 12px;
        font-size: 12px;
        font-family: inherit;
        cursor: pointer;
        outline: none;
        min-width: 140px;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
    }
    .mc-task-filters select:hover {
        border-color: var(--mc-t3);
        color: var(--mc-t1);
    }
    .mc-task-filters select:focus {
        border-color: var(--mc-grn);
    }

    /* ── Drag & Drop ── */
    .mc-task[draggable="true"] { cursor: grab; }
    .mc-task.dragging { opacity: 0.4; transform: scale(0.97); }
    .mc-task.drag-over { border-color: var(--mc-grn); box-shadow: 0 0 0 1px var(--mc-grn); }
    .mc-team-row.drop-target { border-color: var(--mc-grn); background: rgba(74,222,128,0.05); }

    /* ── Task Modal ── */
    .task-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    .task-modal-overlay.active {
        display: flex;
    }
    .task-modal {
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 16px;
        width: 90%;
        max-width: 520px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        margin: 0 auto;
    }
    .task-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 22px;
        border-bottom: 1px solid var(--mc-brd);
    }
    .task-modal-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--mc-t1);
    }
    .task-modal-close {
        background: none;
        border: none;
        color: var(--mc-t3);
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
    }
    .task-modal-close:hover { color: var(--mc-t1); background: var(--mc-s2); }
    .task-modal-body { padding: 22px; }
    .task-modal-field {
        margin-bottom: 16px;
    }
    .task-modal-field label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: var(--mc-t3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }
    .task-modal-field input,
    .task-modal-field select,
    .task-modal-field textarea {
        width: 100%;
        background: var(--mc-s2);
        border: 1px solid var(--mc-brd);
        border-radius: 8px;
        color: var(--mc-t1);
        padding: 10px 12px;
        font-size: 14px;
        font-family: inherit;
        outline: none;
        box-sizing: border-box;
    }
    .task-modal-field input:focus,
    .task-modal-field select:focus,
    .task-modal-field textarea:focus {
        border-color: var(--mc-grn);
    }
    .task-modal-field textarea { resize: vertical; }
    .task-modal-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .task-modal-info {
        padding: 8px 12px;
        background: var(--mc-s2);
        border-radius: 8px;
        color: var(--mc-t2);
        font-size: 13px;
    }
    .task-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 16px 22px;
        border-top: 1px solid var(--mc-brd);
    }
    .task-modal-btn {
        padding: 10px 22px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-family: inherit;
    }
    .task-modal-btn.cancel {
        background: var(--mc-s2);
        color: var(--mc-t2);
    }
    .task-modal-btn.cancel:hover { background: var(--mc-s3); color: var(--mc-t1); }
    .task-modal-btn.save {
        background: var(--mc-grn);
        color: #0a0e11;
    }
    .task-modal-btn.save:hover { filter: brightness(1.1); }

    @media (max-width: 600px) {
        .task-modal { width: 95%; max-width: none; }
        .task-modal-row { grid-template-columns: 1fr; }
        .mc-task-filters { flex-direction: column; }
        .mc-task-filters select { min-width: 100%; }
    }

    /* ── Day Plan Grid ── */
    .mc-plan-grid {
        display: grid;
        gap: 4px;
    }
    .mc-plan-header {
        display: grid;
        grid-template-columns: 180px 1fr 80px 100px 50px;
        gap: 8px;
        padding: 8px 12px;
        font-size: 11px;
        font-weight: 700;
        color: var(--mc-t3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--mc-brd);
    }
    .mc-plan-row {
        display: grid;
        grid-template-columns: 180px 1fr 80px 100px 50px;
        gap: 8px;
        padding: 10px 12px;
        align-items: center;
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 10px;
        transition: border-color 0.2s;
    }
    .mc-plan-row:hover { border-color: var(--mc-t3); }
    .mc-plan-row.status-sick { border-left: 3px solid var(--mc-red); opacity: 0.6; }
    .mc-plan-row.status-vacation { border-left: 3px solid var(--mc-blu); opacity: 0.6; }
    .mc-plan-row.status-absent { border-left: 3px solid var(--mc-red); opacity: 0.5; }
    .mc-plan-row.status-uncertain { border-left: 3px solid var(--mc-amb); }
    .mc-plan-row.status-confirmed { border-left: 3px solid var(--mc-grn); background: rgba(74,222,128,0.03); }

    .mc-plan-emp {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .mc-plan-avatar {
        width: 32px; height: 32px;
        border-radius: 50%;
        background: var(--mc-grn);
        color: #0a0e11;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; font-weight: 700;
        flex-shrink: 0;
    }
    .mc-plan-emp-name { font-size: 14px; font-weight: 600; color: var(--mc-t1); }
    .mc-plan-job { font-size: 13px; color: var(--mc-t2); }
    .mc-plan-hours {
        font-size: 14px; font-weight: 700; color: var(--mc-t1);
        text-align: center;
    }
    .mc-plan-status-badge {
        font-size: 11px; font-weight: 600; padding: 3px 8px;
        border-radius: 6px; text-align: center; white-space: nowrap;
    }
    .mc-plan-status-badge.planned { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-plan-status-badge.confirmed { background: var(--mc-grn-d); color: var(--mc-grn); }
    .mc-plan-status-badge.absent { background: var(--mc-red-d); color: var(--mc-red); }
    .mc-plan-status-badge.sick { background: var(--mc-red-d); color: var(--mc-red); }
    .mc-plan-status-badge.vacation { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-plan-status-badge.uncertain { background: var(--mc-amb-d); color: var(--mc-amb); }

    .mc-plan-delete {
        background: none; border: none; color: var(--mc-t3);
        cursor: pointer; padding: 4px; border-radius: 6px; font-size: 16px;
    }
    .mc-plan-delete:hover { color: var(--mc-red); background: var(--mc-red-d); }

    .mc-plan-empty {
        text-align: center; padding: 30px; color: var(--mc-t3);
        font-size: 14px;
    }

    .mc-plan-status-select {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 6px; color: var(--mc-t2); padding: 4px 6px;
        font-size: 11px; font-family: inherit; cursor: pointer; outline: none;
        width: 100%;
    }

    /* ── Potvrzení dne ── */
    .mc-confirm-row {
        display: grid;
        grid-template-columns: 160px 1fr 80px 80px 1fr;
        gap: 8px;
        padding: 10px 12px;
        align-items: center;
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 10px;
        margin-bottom: 4px;
    }
    .mc-confirm-row .actual-input {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-grn); padding: 6px 10px;
        font-size: 14px; font-weight: 700; font-family: inherit;
        width: 100%; text-align: center; outline: none; box-sizing: border-box;
    }
    .mc-confirm-row .actual-input:focus { border-color: var(--mc-grn); }
    .mc-confirm-row .note-input {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t1); padding: 6px 10px;
        font-size: 13px; font-family: inherit;
        width: 100%; outline: none; box-sizing: border-box;
    }
    .mc-confirm-row .note-input:focus { border-color: var(--mc-grn); }
    .mc-confirm-header {
        display: grid;
        grid-template-columns: 160px 1fr 80px 80px 1fr;
        gap: 8px;
        padding: 6px 12px;
        font-size: 11px; font-weight: 700; color: var(--mc-t3);
        text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom: 1px solid var(--mc-brd);
        margin-bottom: 4px;
    }

    .mc-btn-confirm {
        background: var(--mc-grn); color: #0a0e11;
        border: none; border-radius: 10px; padding: 10px 24px;
        font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .mc-btn-confirm:hover { filter: brightness(1.1); }

    .mc-btn-show-confirm {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t2); padding: 6px 14px;
        font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit;
        margin-top: 10px;
    }
    .mc-btn-show-confirm:hover { border-color: var(--mc-grn); color: var(--mc-t1); }

    /* ── Plan Modal ── */
    .plan-modal-overlay {
        display: none; position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        z-index: 9999;
        justify-content: center; align-items: center;
    }
    .plan-modal-overlay.active { display: flex; }
    .plan-modal {
        background: var(--mc-s1); border: 1px solid var(--mc-brd);
        border-radius: 16px; width: 90%; max-width: 480px;
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
    }
    .plan-modal-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 18px 22px; border-bottom: 1px solid var(--mc-brd);
    }
    .plan-modal-header span { font-size: 16px; font-weight: 700; color: var(--mc-t1); }
    .plan-modal-close {
        background: none; border: none; color: var(--mc-t3);
        cursor: pointer; padding: 4px; border-radius: 6px;
    }
    .plan-modal-close:hover { color: var(--mc-t1); background: var(--mc-s2); }
    .plan-modal-body { padding: 22px; }
    .plan-modal-field { margin-bottom: 16px; }
    .plan-modal-field label {
        display: block; font-size: 11px; font-weight: 600; color: var(--mc-t3);
        text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
    }
    .plan-modal-field select,
    .plan-modal-field input {
        width: 100%; background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t1); padding: 10px 12px;
        font-size: 14px; font-family: inherit; outline: none; box-sizing: border-box;
    }
    .plan-modal-field select:focus,
    .plan-modal-field input:focus { border-color: var(--mc-grn); }
    .plan-modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .plan-modal-footer {
        display: flex; justify-content: flex-end; gap: 10px;
        padding: 16px 22px; border-top: 1px solid var(--mc-brd);
    }
    .plan-modal-btn {
        padding: 10px 22px; border-radius: 10px; font-size: 14px;
        font-weight: 600; cursor: pointer; border: none; font-family: inherit;
    }
    .plan-modal-btn.cancel { background: var(--mc-s2); color: var(--mc-t2); }
    .plan-modal-btn.cancel:hover { background: var(--mc-s3); color: var(--mc-t1); }
    .plan-modal-btn.save { background: var(--mc-grn); color: #0a0e11; }
    .plan-modal-btn.save:hover { filter: brightness(1.1); }

    @media (max-width: 768px) {
        .mc-plan-header, .mc-plan-row {
            grid-template-columns: 120px 1fr 60px 80px 40px;
            font-size: 12px;
        }
        .mc-confirm-header, .mc-confirm-row {
            grid-template-columns: 1fr;
            gap: 4px;
        }
        .plan-modal { width: 95%; }
        .plan-modal-row { grid-template-columns: 1fr; }
    }
    </style>
</head>
<body class="has-sidebar">
    <div id="app-header"></div>
    <div id="app-sidebar"></div>

    <div class="page-container">
    <div class="mc">
        <!-- Sub-navigation -->
        <div class="mc-subnav">
            <a href="/planning/daily" class="active">Dnes</a>
            <a href="/planning/timeline">Timeline</a>
            <a href="/planning/week">Týden</a>
            <a href="/planning/costs">Náklady</a>
        </div>

        <!-- Date Navigation -->
        <div class="mc-datestrip">
            <button onclick="MC.go(-1)">← Včera</button>
            <button class="today-btn" onclick="MC.go(0)">Dnes</button>
            <div class="date-display" id="mc-date" onclick="document.getElementById('date-picker').showPicker()" style="cursor:pointer;" title="Klikni pro výběr data"></div>
            <input type="date" id="date-picker" style="position:absolute;opacity:0;pointer-events:none;width:0;height:0;" onchange="MC.goToDate(this.value)">
            <button onclick="MC.go(1)">Zítra →</button>
        </div>

        <!-- Score Cards -->
        <div class="mc-score-row" id="mc-scores"></div>

        <!-- Weather Card -->
        <div class="mc-weather-card" id="mc-weather"></div>

        <!-- Signals -->
        <div class="mc-signals" id="mc-signals"></div>

        <!-- Team Planning -->
        <div class="mc-section" id="sec-team">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                <span class="mc-sec-title">Tým dne</span>
                <span class="mc-sec-count" id="team-count">0</span>
                <button class="mc-sec-action" id="btn-add-plan" onclick="openPlanModal()">+ Přiřadit</button>
                <button class="mc-sec-action" style="margin-left:4px" onclick="copyPreviousDay()">Kopírovat včerejšek</button>
            </div>
            
            <!-- Plánovací grid -->
            <div id="mc-team-grid"></div>
            
            <!-- Toggle pro Potvrzení dne -->
            <div id="confirm-section" style="display:none; margin-top: 16px;">
                <div class="mc-sec-hdr" style="margin-bottom:10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                    <span class="mc-sec-title">Potvrzení dne</span>
                </div>
                <div id="mc-confirm-list"></div>
                <div style="text-align:right; margin-top:12px;">
                    <button class="mc-btn-confirm" onclick="confirmAllPlans()">Potvrdit a vytvořit výkazy</button>
                </div>
            </div>
        </div>

        <!-- Tasks -->
        <div class="mc-section" id="sec-tasks">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                <span class="mc-sec-title">Úkoly</span>
                <span class="mc-sec-count" id="tasks-count">0</span>
                <a href="/tasks.html" class="mc-sec-action">Kanban →</a>
            </div>
            <div class="mc-task-filters" id="task-filters">
                <select id="filter-employee" onchange="applyTaskFilters()">
                    <option value="">Všichni zaměstnanci</option>
                </select>
                <select id="filter-status" onchange="applyTaskFilters()">
                    <option value="">Všechny stavy</option>
                    <option value="todo">K udělání</option>
                    <option value="open">Otevřené</option>
                    <option value="progress">Probíhá</option>
                    <option value="done">Hotovo</option>
                </select>
                <select id="filter-priority" onchange="applyTaskFilters()">
                    <option value="">Všechny priority</option>
                    <option value="urgent">Urgentní</option>
                    <option value="high">Vysoká</option>
                    <option value="medium">Střední</option>
                    <option value="low">Nízká</option>
                </select>
            </div>
            <div class="mc-task-list" id="mc-tasks"></div>
        </div>

        <!-- Active Jobs -->
        <div class="mc-section" id="sec-jobs">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
                <span class="mc-sec-title">Aktivní zakázky</span>
                <span class="mc-sec-count" id="jobs-count">0</span>
                <a href="/jobs.html" class="mc-sec-action">Vše →</a>
            </div>
            <div class="mc-jobs-grid" id="mc-jobs"></div>
        </div>

        <!-- Smart Suggestions -->
        <div class="mc-section" id="sec-suggest">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24" style="stroke:var(--mc-pur)"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                <span class="mc-sec-title">Doporučení</span>
                <span class="mc-sec-count" id="suggest-count">0</span>
            </div>
            <div id="mc-suggest"></div>
        </div>
    </div>
    </div>

    <div id="bottom-nav-container"></div>
    <script src="/static/bottom-nav.js"></script>
    <script src="/static/app-sidebar.js"></script>
    <script src="/static/app-header.js"></script>

    <script>
    // ── Globální proměnné (musí být PŘED IIFE) ──
    let _cachedTasks = [];
    let _cachedEmployees = [];
    let draggedTaskId = null;
    let _dayPlans = [];
    let _activeJobs = [];

    // ── Utility funkce (globální scope) ──
    let curDate = new Date();
    curDate.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
    const ymd = d => d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    const fmtDate = d => d.toLocaleDateString('cs-CZ',{day:'numeric',month:'long',year:'numeric'});
    const fmtDay = d => d.toLocaleDateString('cs-CZ',{weekday:'long'}).replace(/^./,c=>c.toUpperCase());

    const MC = (function(){
    'use strict';
    // curDate, today, esc, ymd, fmtDate, fmtDay are declared globally above

    async function api(url){ try{ const r=await fetch(url,{credentials:'same-origin'}); if(r.ok) return r.json(); }catch(e){} return null; }

    function ring(pct, color){
        const r=20, c=2*Math.PI*r, off=c-(pct/100)*c;
        return `<div class="mc-ring">
            <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="${r}" class="ring-bg"/>
            <circle cx="24" cy="24" r="${r}" class="ring-fg" style="stroke:${color};stroke-dasharray:${c};stroke-dashoffset:${off}"/></svg>
            <div class="ring-val">${Math.round(pct)}%</div></div>`;
    }

    // ── Signal SVGs ──
    const sigIcon = {
        fire: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 12c2-2.96 0-7-1-8 0 3.038-1.773 4.741-3 6-1.226 1.26-2 3.24-2 5a6 6 0 1012 0c0-1.532-1.056-3.94-2-5-1.786 3-2.791 3-4 2z"/></svg>',
        warn: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>',
        ok: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
    };

    async function load(){
        const ds = ymd(curDate);
        document.getElementById('mc-date').innerHTML = `<span class="day-name">${fmtDay(curDate)}</span>${fmtDate(curDate)}`;
        document.getElementById('date-picker').value = ds;

        // Parallel fetch
        const [daily, notif, suggest, allTasks, allEmps, dayPlansResp] = await Promise.all([
            api('/api/planning/daily/'+ds),
            api('/api/planning/notifications'),
            api('/api/planning/suggestions'),
            api('/api/tasks'),
            api('/api/employees'),
            api('/api/planning/day-plans/'+ds)
        ]);
        const dayPlans = dayPlansResp?.plans || [];

        const tasks = daily?.tasks || [];
        const timesheets = daily?.timesheets || [];
        const jobs = daily?.active_jobs || [];
        const allTasksList = allTasks?.tasks || [];
        const employees = allEmps?.employees || [];
        const weather = daily?.weather || null;

        // Cache dat pro modal a filtry
        _cachedTasks = allTasksList;
        _cachedEmployees = employees;

        // ── Compute signals ──
        const overdueTasks = allTasksList.filter(t => t.due_date && t.due_date < ds && t.status !== 'done' && t.status !== 'completed');
        const todayTasks = allTasksList.filter(t => t.due_date === ds && t.status !== 'done');
        const unassigned = allTasksList.filter(t => !t.employee_id && t.status !== 'done' && t.status !== 'completed');
        const noDateTasks = allTasksList.filter(t => !t.due_date && t.status !== 'done' && t.status !== 'completed');
        const activeEmps = employees.filter(e => e.status === 'active' || !e.status);
        // Score karty - použij day plans místo timesheets
        const plannedEmps = new Set(dayPlans.filter(p => p.status !== 'absent' && p.status !== 'vacation').map(p => p.employee_id));
        const workingEmps = plannedEmps; // Pro kompatibilitu
        const idleEmps = activeEmps.filter(e => !plannedEmps.has(e.id));
        const plannedHours = dayPlans.reduce((s,p) => s + (p.status !== 'absent' && p.status !== 'vacation' ? (p.actual_hours || p.planned_hours || 0) : 0), 0);
        const totalHours = plannedHours; // Pro kompatibilitu
        const isToday = ymd(curDate) === ymd(today);

        // Jobs approaching deadline
        const urgentJobs = jobs.filter(j => {
            if (!j.deadline) return false;
            const dl = new Date(j.deadline);
            const diff = (dl - curDate) / 864e5;
            return diff >= 0 && diff <= 7;
        });

        // ── Render Score Cards ──
        const tasksDone = allTasksList.filter(t => t.status === 'done' || t.status === 'completed').length;
        const tasksTotal = allTasksList.length;
        const taskPct = tasksTotal > 0 ? (tasksDone/tasksTotal)*100 : 0;
        const capacityPct = activeEmps.length > 0 ? (workingEmps.size / activeEmps.length)*100 : 0;
        const jobsWithDeadline = jobs.filter(j => j.deadline).length;
        const jobDeadlinePct = jobs.length > 0 ? (jobsWithDeadline/jobs.length)*100 : 0;

        // ── Render Weather ──
        const weatherEl = document.getElementById('mc-weather');
        if (!weather || !weather.temp || weather.description === 'Počasí nedostupné' || weather.is_mock) {
            weatherEl.className = 'mc-weather-card weather-error';
            weatherEl.innerHTML = `
                <div class="mc-weather-error">
                    <div style="font-size: 16px; font-weight: 700; color: var(--mc-t1); margin-bottom: 8px;">Počasí</div>
                    <div style="color: var(--mc-t3);">Nastavte OPENWEATHER_API_KEY</div>
                </div>
            `;
        } else {
            const weatherMain = (weather.description || '').toLowerCase();
            let weatherClass = 'weather-clouds';
            if (weatherMain.includes('jasno') || weatherMain.includes('slunečno') || weatherMain.includes('clear')) {
                weatherClass = 'weather-clear';
            } else if (weatherMain.includes('déšť') || weatherMain.includes('rain') || weatherMain.includes('prší')) {
                weatherClass = 'weather-rain';
            }

            const warningIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';

            weatherEl.className = `mc-weather-card ${weatherClass}`;
            weatherEl.innerHTML = `
                <div class="mc-weather-content">
                    <div class="mc-weather-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            ${weatherMain.includes('déšť') || weatherMain.includes('rain') ? 
                                '<path d="M16 13v8M8 13v8M12 15v8M20 8.5A7.5 7.5 0 1112 3a7.5 7.5 0 017.5 5.5z"/>' :
                            weatherMain.includes('jasno') || weatherMain.includes('clear') || weatherMain.includes('slunečno') ?
                                '<circle cx="12" cy="12" r="5"/><path d="M12 1v4M12 19v4M23 12h-4M5 12H1M19.07 4.93l-2.83 2.83M7.76 16.24l-2.83 2.83M19.07 19.07l-2.83-2.83M7.76 7.76l-2.83-2.83"/>' :
                                '<path d="M18 10h-1.26A8 8 0 106 22h12a8 8 0 000-12z"/>'}
                        </svg>
                    </div>
                    <div class="mc-weather-main">
                        <div class="mc-weather-title">Příbram, CZ</div>
                        <div class="mc-weather-temp">${Math.round(weather.temp)}°C</div>
                        <div class="mc-weather-desc">${esc(weather.description || '—')}</div>
                        ${weather.feels_like ? `<div class="mc-weather-feels">Pocitově ${Math.round(weather.feels_like)}°C</div>` : ''}
                    </div>
                    <div class="mc-weather-details">
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Vlhkost</div>
                            <div class="mc-weather-detail-value">${weather.humidity || '—'}%</div>
                        </div>
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Vítr</div>
                            <div class="mc-weather-detail-value">${weather.wind_speed || '—'} m/s</div>
                        </div>
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Srážky</div>
                            <div class="mc-weather-detail-value">${weather.rain_probability || 0}%</div>
                        </div>
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Status</div>
                            <div class="mc-weather-detail-value" style="color: ${weather.suitable_for_outdoor ? 'var(--mc-grn)' : 'var(--mc-red)'};">
                                ${weather.suitable_for_outdoor ? 'Vhodné' : 'Nevhodné'}
                            </div>
                        </div>
                    </div>
                </div>
                ${!weather.suitable_for_outdoor ? `
                    <div class="mc-weather-warning">
                        ${warningIcon}
                        <span>Nevhodné počasí pro venkovní práce</span>
                    </div>
                ` : ''}
            `;
        }

        document.getElementById('mc-scores').innerHTML = `
            <div class="mc-score-card">
                ${ring(capacityPct, workingEmps.size > 0 ? '#4ade80' : '#475569')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Tým</div>
                    <div class="mc-score-val">${workingEmps.size}/${activeEmps.length}</div>
                    <div class="mc-score-sub">${isToday && workingEmps.size === 0 ? 'Nikdo nepracuje' : totalHours > 0 ? totalHours+'h zalogováno' : 'lidí v práci'}</div>
                </div>
            </div>
            <div class="mc-score-card">
                ${ring(todayTasks.length > 0 ? 50 : (overdueTasks.length > 0 ? 20 : 100), overdueTasks.length > 0 ? '#f87171' : todayTasks.length > 0 ? '#fbbf24' : '#4ade80')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Úkoly dne</div>
                    <div class="mc-score-val">${todayTasks.length}</div>
                    <div class="mc-score-sub">${overdueTasks.length > 0 ? overdueTasks.length+' po termínu' : 'na program'}</div>
                </div>
            </div>
            <div class="mc-score-card">
                ${ring(jobDeadlinePct, jobDeadlinePct > 70 ? '#4ade80' : jobDeadlinePct > 30 ? '#fbbf24' : '#f87171')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Zakázky</div>
                    <div class="mc-score-val">${jobs.length}</div>
                    <div class="mc-score-sub">${jobsWithDeadline} s deadlinem</div>
                </div>
            </div>
            <div class="mc-score-card">
                ${ring(totalHours > 0 ? Math.min((totalHours/(activeEmps.length*8))*100, 100) : 0, '#60a5fa')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Hodiny dnes</div>
                    <div class="mc-score-val">${totalHours}h</div>
                    <div class="mc-score-sub">${timesheets.length} výkazů</div>
                </div>
            </div>
        `;

        // ── Render Signals ──
        let sigs = '';
        if (overdueTasks.length > 0) {
            sigs += `<div class="mc-signal red" onclick="location.href='/tasks.html'">
                ${sigIcon.fire}<span class="sig-text">Zpožděné úkoly po termínu</span><span class="sig-count">${overdueTasks.length}</span></div>`;
        }
        if (urgentJobs.length > 0) {
            sigs += `<div class="mc-signal amber" onclick="location.href='/jobs.html'">
                ${sigIcon.warn}<span class="sig-text">Zakázky s blížícím se deadlinem (7 dní)</span><span class="sig-count">${urgentJobs.length}</span></div>`;
        }
        if (isToday && idleEmps.length > 0 && activeEmps.length > 0) {
            sigs += `<div class="mc-signal amber" onclick="location.href='/employees.html'">
                ${sigIcon.user}<span class="sig-text">Zaměstnanci bez výkazu dnes</span><span class="sig-count">${idleEmps.length}</span></div>`;
        }
        if (unassigned.length > 0) {
            sigs += `<div class="mc-signal blue" onclick="location.href='/tasks.html'">
                ${sigIcon.info}<span class="sig-text">Úkoly bez přiřazeného zaměstnance</span><span class="sig-count">${unassigned.length}</span></div>`;
        }
        if (noDateTasks.length > 0) {
            sigs += `<div class="mc-signal blue" onclick="location.href='/tasks.html'">
                ${sigIcon.info}<span class="sig-text">Úkoly bez termínu</span><span class="sig-count">${noDateTasks.length}</span></div>`;
        }
        if (sigs === '') {
            sigs = `<div class="mc-signal green">${sigIcon.ok}<span class="sig-text">Vše v pořádku — žádné kritické signály</span></div>`;
        }
        document.getElementById('mc-signals').innerHTML = sigs;

        // ── Render Team (Day Plans) ──
        renderPlanGrid(dayPlans, employees, jobs);

        // ── Render Tasks ──
        // Combine: overdue + today + upcoming + no-date
        const allOpen = allTasksList.filter(t => t.status !== 'done' && t.status !== 'completed');
        allOpen.sort((a,b) => {
            // Priority: overdue first, then today, then by date, then no-date last
            const aKey = !a.due_date ? '9999' : (a.due_date < ds ? '0'+a.due_date : a.due_date);
            const bKey = !b.due_date ? '9999' : (b.due_date < ds ? '0'+b.due_date : b.due_date);
            return aKey.localeCompare(bKey);
        });

        document.getElementById('tasks-count').textContent = allOpen.length;
        if (allOpen.length === 0) {
            document.getElementById('mc-tasks').innerHTML = '<div class="mc-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Žádné otevřené úkoly</div>';
        } else {
            let tHtml = '';
            allOpen.slice(0, 20).forEach(t => {
                const isOverdue = t.due_date && t.due_date < ds;
                const isToday = t.due_date === ds;
                const hasDate = !!t.due_date;
                const badgeClass = isOverdue ? 'overdue' : (isToday ? 'today' : (hasDate ? 'upcoming' : 'nodate'));
                const badgeText = isOverdue ? 'Po termínu' : (isToday ? 'Dnes' : (hasDate ? new Date(t.due_date).toLocaleDateString('cs-CZ',{day:'numeric',month:'numeric'}) : 'Bez termínu'));
                const pri = t.priority || (isOverdue ? 'high' : 'none');
                const emp = t.employee_name || t.assigned_employee;

                tHtml += `<div class="mc-task" draggable="true" data-task-id="${t.id}" data-emp-id="${t.employee_id || ''}" data-status="${t.status}" data-priority="${t.priority || 'none'}" onclick="openTaskModal(${t.id})">
                    <div class="mc-task-pri ${pri}"></div>
                    <div class="mc-task-body">
                        <div class="mc-task-title">${esc(t.title)}</div>
                        <div class="mc-task-meta">
                            <span class="mc-task-badge ${badgeClass}">${badgeText}</span>
                            ${t.job_name ? '<span>'+esc(t.job_name)+'</span>' : ''}
                            ${emp ? '<span>→ '+esc(emp)+'</span>' : ''}
                        </div>
                    </div>
                </div>`;
            });
            if (allOpen.length > 20) tHtml += `<div class="mc-empty">…a dalších ${allOpen.length - 20} úkolů</div>`;
            document.getElementById('mc-tasks').innerHTML = tHtml;
        }

        // Naplň filtr zaměstnanců
        const empFilter = document.getElementById('filter-employee');
        if (empFilter && empFilter.options.length <= 1) {
            employees.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.name;
                empFilter.appendChild(opt);
            });
        }

        // ── Render Jobs ──
        document.getElementById('jobs-count').textContent = jobs.length;
        if (jobs.length === 0) {
            document.getElementById('mc-jobs').innerHTML = '<div class="mc-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>Žádné aktivní zakázky</div>';
        } else {
            let jHtml = '';
            jobs.forEach(j => {
                const progress = j.progress || j.completion_percent || 0;
                const statusClass = (j.status === 'Probíhá') ? 'active' : 'plan';
                const deadlineStr = j.deadline ? new Date(j.deadline).toLocaleDateString('cs-CZ',{day:'numeric',month:'numeric',year:'numeric'}) : 'Bez deadlinu';
                const isUrgent = j.deadline && ((new Date(j.deadline) - curDate) / 864e5) <= 7 && ((new Date(j.deadline) - curDate) / 864e5) >= 0;
                const barColor = isUrgent ? 'var(--mc-amb)' : progress > 70 ? 'var(--mc-grn)' : 'var(--mc-blu)';

                jHtml += `<div class="mc-job" onclick="location.href='/job-detail.html?id=${j.id}'">
                    <div class="mc-job-hdr">
                        <div class="mc-job-name">${esc(j.name)}</div>
                        <span class="mc-job-status ${statusClass}">${esc(j.status)}</span>
                    </div>
                    <div class="mc-job-meta">
                        ${j.code ? '<span>Kód: '+esc(j.code)+'</span>' : ''}
                        <span style="${isUrgent ? 'color:var(--mc-amb);font-weight:700' : ''}">Deadline: ${deadlineStr}</span>
                        ${j.client ? '<span>'+esc(j.client)+'</span>' : ''}
                    </div>
                    <div class="mc-job-progress"><div class="mc-job-progress-bar" style="width:${progress}%;background:${barColor}"></div></div>
                </div>`;
            });
            document.getElementById('mc-jobs').innerHTML = jHtml;
        }

        // ── Render Suggestions ──
        const allSuggestions = [];
        if (suggest?.suggestions) {
            suggest.suggestions.forEach(s => allSuggestions.push(s));
        }
        if (notif?.notifications) {
            notif.notifications.forEach(n => {
                if (n.type !== 'warning') allSuggestions.push({ title: n.title, description: n.message, link: n.link });
            });
        }

        // Add computed suggestions
        if (jobs.filter(j => !j.deadline).length > 0) {
            allSuggestions.push({ title: `${jobs.filter(j=>!j.deadline).length} zakázek bez deadlinu`, description: 'Nastav termíny pro lepší plánování a přehled.', link: '/jobs.html' });
        }
        if (noDateTasks.length > 3) {
            allSuggestions.push({ title: `${noDateTasks.length} úkolů bez data`, description: 'Přiřaď termíny úkolům pro efektivní plánování dne.', link: '/tasks.html' });
        }

        document.getElementById('suggest-count').textContent = allSuggestions.length;
        if (allSuggestions.length === 0) {
            document.getElementById('mc-suggest').innerHTML = '<div class="mc-empty">Žádná doporučení</div>';
        } else {
            document.getElementById('mc-suggest').innerHTML = allSuggestions.map(s => `
                <div class="mc-suggest" ${s.link ? 'onclick="location.href=\''+s.link+'\'" style="cursor:pointer"' : ''}>
                    <div class="mc-suggest-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></div>
                    <div class="mc-suggest-body">
                        <div class="mc-suggest-title">${esc(s.title)}</div>
                        <div class="mc-suggest-desc">${esc(s.description)}</div>
                    </div>
                </div>`).join('');
        }
    }

    return {
        go(offset) {
            if (offset === 0) { curDate = new Date(); curDate.setHours(0,0,0,0); }
            else curDate.setDate(curDate.getDate() + offset);
            load();
        },
        goToDate(dateStr) {
            if (!dateStr) return;
            const parts = dateStr.split('-');
            curDate = new Date(parts[0], parts[1]-1, parts[2]);
            curDate.setHours(0,0,0,0);
            load();
        },
        init() { load(); }
    };
    })();

    MC.init();

    // ═══════════════════════════════════════
    // DAY PLANNING SYSTEM
    // ═══════════════════════════════════════

    // ── Render plánovacího gridu ──
    function renderPlanGrid(plans, employees, jobs) {
        _dayPlans = plans;
        _activeJobs = jobs;
        
        const container = document.getElementById('mc-team-grid');
        const plannedEmps = new Set(plans.map(p => p.employee_id));
        
        document.getElementById('team-count').textContent = plannedEmps.size;
        
        if (plans.length === 0) {
            container.innerHTML = `<div class="mc-plan-empty">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
                <div style="margin-top:8px">Nikdo zatím není naplánovaný</div>
                <div style="font-size:12px; margin-top:4px">Klikni "+ Přiřadit" pro přidání zaměstnanců</div>
            </div>`;
            document.getElementById('confirm-section').style.display = 'none';
            return;
        }
        
        const statusLabels = {
            planned: 'Plán', confirmed: 'Potvrzeno', absent: 'Absence',
            sick: 'Nemoc', vacation: 'Dovolená', uncertain: 'Nejistý'
        };
        
        let html = `<div class="mc-plan-grid">
            <div class="mc-plan-header">
                <span>Zaměstnanec</span><span>Zakázka</span><span>Hodiny</span><span>Status</span><span></span>
            </div>`;
        
        plans.forEach(p => {
            const initials = (p.employee_name||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
            const jobText = p.job_name ? (p.job_code ? '['+p.job_code+'] ' : '') + p.job_name : '— Bez zakázky —';
            const statusClass = p.status || 'planned';
            const hrs = p.actual_hours != null ? p.actual_hours : p.planned_hours;
            
            html += `<div class="mc-plan-row status-${statusClass}" data-plan-id="${p.id}">
                <div class="mc-plan-emp">
                    <div class="mc-plan-avatar">${initials}</div>
                    <span class="mc-plan-emp-name">${esc(p.employee_name)}</span>
                </div>
                <div class="mc-plan-job">${esc(jobText)}</div>
                <div class="mc-plan-hours">${hrs}h</div>
                <div>
                    <select class="mc-plan-status-select" onchange="updatePlanStatus(${p.id}, this.value)">
                        ${Object.entries(statusLabels).map(([k,v]) => 
                            `<option value="${k}" ${p.status===k?'selected':''}>${v}</option>`
                        ).join('')}
                    </select>
                </div>
                <button class="mc-plan-delete" onclick="deletePlan(${p.id})" title="Smazat">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>`;
        });
        
        html += '</div>';
        
        const hasUnconfirmed = plans.some(p => p.status === 'planned' || p.status === 'uncertain');
        if (hasUnconfirmed) {
            html += `<button class="mc-btn-show-confirm" onclick="showConfirmSection()">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px; margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                Potvrzení dne — vyplnit skutečné hodiny
            </button>`;
        }
        
        container.innerHTML = html;
    }

    // ── Potvrzení dne ──
    function showConfirmSection() {
        const section = document.getElementById('confirm-section');
        section.style.display = '';
        
        const unconfirmed = _dayPlans.filter(p => p.status === 'planned' || p.status === 'uncertain');
        
        let html = `<div class="mc-confirm-header">
            <span>Zaměstnanec</span><span>Zakázka</span><span>Plán</span><span>Skutečnost</span><span>Poznámka</span>
        </div>`;
        
        unconfirmed.forEach(p => {
            const jobText = p.job_name || '— Bez zakázky —';
            html += `<div class="mc-confirm-row" data-plan-id="${p.id}">
                <div style="font-weight:600; color:var(--mc-t1)">${esc(p.employee_name)}</div>
                <div style="color:var(--mc-t2); font-size:13px">${esc(jobText)}</div>
                <div style="text-align:center; color:var(--mc-t3)">${p.planned_hours}h</div>
                <input type="number" class="actual-input" value="${p.planned_hours}" min="0" max="24" step="0.5" data-plan-id="${p.id}">
                <input type="text" class="note-input" placeholder="Poznámka..." value="${p.note || ''}" data-plan-id="${p.id}">
            </div>`;
        });
        
        document.getElementById('mc-confirm-list').innerHTML = html;
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function confirmAllPlans() {
        const rows = document.querySelectorAll('.mc-confirm-row');
        const confirmations = [];
        
        rows.forEach(row => {
            const planId = row.dataset.planId;
            const actualInput = row.querySelector('.actual-input');
            const noteInput = row.querySelector('.note-input');
            
            confirmations.push({
                id: parseInt(planId),
                actual_hours: parseFloat(actualInput.value) || 0,
                note: noteInput.value || '',
                status: 'confirmed'
            });
        });
        
        if (confirmations.length === 0) return;
        
        try {
            const res = await fetch('/api/planning/day-plans/confirm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ confirmations })
            });
            const data = await res.json();
            
            if (data.success) {
                document.getElementById('confirm-section').style.display = 'none';
                MC.init();
                const btn = document.querySelector('.mc-btn-confirm');
                if (btn) {
                    const orig = btn.textContent;
                    btn.textContent = '✓ Výkazy vytvořeny (' + data.created_timesheets + ')';
                    btn.style.background = 'var(--mc-grn)';
                    setTimeout(() => { btn.textContent = orig; }, 3000);
                }
            } else {
                alert('Chyba: ' + (data.error || 'Neznámá chyba'));
            }
        } catch (err) {
            console.error('Confirm error:', err);
            alert('Chyba při potvrzování');
        }
    }

    // ── Rychlá změna statusu ──
    async function updatePlanStatus(planId, newStatus) {
        try {
            await fetch('/api/planning/day-plans/' + planId, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: newStatus })
            });
            MC.init();
        } catch (err) {
            console.error('Status update error:', err);
        }
    }

    // ── Smazat plán ──
    async function deletePlan(planId) {
        if (!confirm('Smazat toto přiřazení?')) return;
        try {
            await fetch('/api/planning/day-plans/' + planId, { method: 'DELETE' });
            MC.init();
        } catch (err) {
            console.error('Delete error:', err);
        }
    }

    // ── Kopírovat včerejšek ──
    async function copyPreviousDay() {
        const ds = ymd(curDate);
        const yesterday = new Date(curDate);
        yesterday.setDate(yesterday.getDate() - 1);
        const ys = ymd(yesterday);
        
        if (!confirm(`Zkopírovat plány z ${yesterday.toLocaleDateString('cs-CZ')} na ${curDate.toLocaleDateString('cs-CZ')}?`)) return;
        
        try {
            const res = await fetch('/api/planning/day-plans/copy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ from_date: ys, to_date: ds })
            });
            const data = await res.json();
            if (data.success) {
                MC.init();
            } else {
                alert('Chyba: ' + (data.error || ''));
            }
        } catch (err) {
            console.error('Copy error:', err);
        }
    }

    // ── Plan Modal ──
    function openPlanModal(planId) {
        const overlay = document.getElementById('planModalOverlay');
        const empSelect = document.getElementById('plan-employee');
        const jobSelect = document.getElementById('plan-job');
        
        empSelect.innerHTML = '';
        _cachedEmployees.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            empSelect.appendChild(opt);
        });
        
        jobSelect.innerHTML = '<option value="">— Bez zakázky —</option>';
        _activeJobs.forEach(j => {
            const opt = document.createElement('option');
            opt.value = j.id;
            opt.textContent = (j.code ? '['+j.code+'] ' : '') + j.name;
            jobSelect.appendChild(opt);
        });
        
        document.getElementById('plan-modal-id').value = planId || '';
        document.getElementById('plan-hours').value = 8;
        document.getElementById('plan-status').value = 'planned';
        document.getElementById('plan-note').value = '';
        
        if (planId) {
            const plan = _dayPlans.find(p => p.id === planId);
            if (plan) {
                empSelect.value = plan.employee_id;
                jobSelect.value = plan.job_id || '';
                document.getElementById('plan-hours').value = plan.planned_hours;
                document.getElementById('plan-status').value = plan.status;
                document.getElementById('plan-note').value = plan.note || '';
            }
        }
        
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closePlanModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('planModalOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    async function savePlan() {
        const planId = document.getElementById('plan-modal-id').value;
        const data = {
            date: ymd(curDate),
            employee_id: parseInt(document.getElementById('plan-employee').value),
            job_id: document.getElementById('plan-job').value ? parseInt(document.getElementById('plan-job').value) : null,
            planned_hours: parseFloat(document.getElementById('plan-hours').value) || 8,
            status: document.getElementById('plan-status').value,
            note: document.getElementById('plan-note').value
        };
        
        try {
            let url = '/api/planning/day-plans';
            let method = 'POST';
            
            if (planId) {
                url += '/' + planId;
                method = 'PATCH';
            }
            
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closePlanModal();
                MC.init();
            } else {
                const err = await res.json();
                alert('Chyba: ' + (err.error || 'Neznámá chyba'));
            }
        } catch (err) {
            console.error('Save plan error:', err);
        }
    }

    // ── Funkce pro filtry ──
    function applyTaskFilters() {
        const empVal = document.getElementById('filter-employee').value;
        const statusVal = document.getElementById('filter-status').value;
        const priVal = document.getElementById('filter-priority').value;
        
        document.querySelectorAll('.mc-task[data-task-id]').forEach(el => {
            let show = true;
            if (empVal && el.dataset.empId !== empVal) show = false;
            if (statusVal && el.dataset.status !== statusVal) show = false;
            if (priVal && el.dataset.priority !== priVal) show = false;
            el.style.display = show ? '' : 'none';
        });
    }

    // ── Drag & Drop ──
    document.addEventListener('dragstart', (e) => {
        const taskEl = e.target.closest('.mc-task[data-task-id]');
        if (!taskEl) return;
        draggedTaskId = taskEl.dataset.taskId;
        taskEl.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedTaskId);
    });

    document.addEventListener('dragend', (e) => {
        const taskEl = e.target.closest('.mc-task');
        if (taskEl) taskEl.classList.remove('dragging');
        document.querySelectorAll('.drag-over, .drop-target').forEach(el => {
            el.classList.remove('drag-over', 'drop-target');
        });
        draggedTaskId = null;
    });

    document.addEventListener('dragover', (e) => {
        const empRow = e.target.closest('.mc-team-row[data-emp-id]');
        if (empRow && draggedTaskId) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            empRow.classList.add('drop-target');
        }
    });

    document.addEventListener('dragleave', (e) => {
        const empRow = e.target.closest('.mc-team-row[data-emp-id]');
        if (empRow) empRow.classList.remove('drop-target');
    });

    document.addEventListener('drop', async (e) => {
        e.preventDefault();
        const empRow = e.target.closest('.mc-team-row[data-emp-id]');
        if (!empRow || !draggedTaskId) return;
        empRow.classList.remove('drop-target');
        
        const employeeId = empRow.dataset.empId;
        if (!employeeId) return;
        
        try {
            const res = await fetch('/api/tasks', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: parseInt(draggedTaskId), employee_id: parseInt(employeeId) })
            });
            if (res.ok) {
                MC.init();
            } else {
                console.error('Chyba při přeřazení úkolu');
            }
        } catch (err) {
            console.error('Drop error:', err);
        }
    });

    // ── Modal funkce ──
    async function openTaskModal(taskId) {
        const overlay = document.getElementById('taskModalOverlay');
        
        let task = _cachedTasks.find(t => t.id === taskId);
        if (!task) {
            try {
                const res = await fetch('/api/tasks?id=' + taskId);
                const data = await res.json();
                task = data.task || data;
            } catch (e) {
                console.error('Chyba načítání úkolu:', e);
                return;
            }
        }
        
        document.getElementById('modal-task-id').value = task.id;
        document.getElementById('modal-task-title').value = task.title || '';
        document.getElementById('modal-task-status').value = task.status || 'todo';
        document.getElementById('modal-task-priority').value = task.priority || 'medium';
        document.getElementById('modal-task-date').value = task.due_date || '';
        document.getElementById('modal-task-desc').value = task.description || '';
        
        const empSelect = document.getElementById('modal-task-employee');
        empSelect.innerHTML = '<option value="">Nepřiřazeno</option>';
        _cachedEmployees.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            if (e.id == task.employee_id) opt.selected = true;
            empSelect.appendChild(opt);
        });
        
        const jobInfo = document.getElementById('modal-task-job-info');
        const jobName = document.getElementById('modal-task-job-name');
        if (task.job_name || task.job_code) {
            jobInfo.style.display = '';
            jobName.textContent = (task.job_code ? '[' + task.job_code + '] ' : '') + (task.job_name || '');
        } else {
            jobInfo.style.display = 'none';
        }
        
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeTaskModal(e) {
        if (e && e.target !== e.currentTarget) return;
        const overlay = document.getElementById('taskModalOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    async function saveTaskModal() {
        const id = document.getElementById('modal-task-id').value;
        const data = {
            id: parseInt(id),
            title: document.getElementById('modal-task-title').value.trim(),
            status: document.getElementById('modal-task-status').value,
            priority: document.getElementById('modal-task-priority').value,
            employee_id: document.getElementById('modal-task-employee').value ? parseInt(document.getElementById('modal-task-employee').value) : null,
            due_date: document.getElementById('modal-task-date').value || null,
            description: document.getElementById('modal-task-desc').value.trim()
        };
        
        try {
            const res = await fetch('/api/tasks', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeTaskModal();
                MC.init();
            } else {
                const err = await res.json();
                alert('Chyba při ukládání: ' + (err.error || 'Neznámá chyba'));
            }
        } catch (err) {
            console.error('Save error:', err);
            alert('Chyba při ukládání úkolu');
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeTaskModal();
    });
    </script>

    <!-- Task Modal -->
    <div class="task-modal-overlay" id="taskModalOverlay" onclick="closeTaskModal(event)">
        <div class="task-modal" onclick="event.stopPropagation()">
            <div class="task-modal-header">
                <span class="task-modal-title">Detail úkolu</span>
                <button class="task-modal-close" onclick="closeTaskModal()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="task-modal-body">
                <input type="hidden" id="modal-task-id">
                
                <div class="task-modal-field">
                    <label>Název</label>
                    <input type="text" id="modal-task-title" placeholder="Název úkolu">
                </div>
                
                <div class="task-modal-row">
                    <div class="task-modal-field">
                        <label>Stav</label>
                        <select id="modal-task-status">
                            <option value="todo">K udělání</option>
                            <option value="open">Otevřené</option>
                            <option value="progress">Probíhá</option>
                            <option value="done">Hotovo</option>
                            <option value="completed">Dokončeno</option>
                        </select>
                    </div>
                    <div class="task-modal-field">
                        <label>Priorita</label>
                        <select id="modal-task-priority">
                            <option value="low">Nízká</option>
                            <option value="medium">Střední</option>
                            <option value="high">Vysoká</option>
                            <option value="urgent">Urgentní</option>
                        </select>
                    </div>
                </div>
                
                <div class="task-modal-row">
                    <div class="task-modal-field">
                        <label>Zaměstnanec</label>
                        <select id="modal-task-employee">
                            <option value="">Nepřiřazeno</option>
                        </select>
                    </div>
                    <div class="task-modal-field">
                        <label>Termín</label>
                        <input type="date" id="modal-task-date">
                    </div>
                </div>
                
                <div class="task-modal-field">
                    <label>Popis</label>
                    <textarea id="modal-task-desc" rows="3" placeholder="Popis úkolu..."></textarea>
                </div>
                
                <div class="task-modal-field" id="modal-task-job-info" style="display:none">
                    <label>Zakázka</label>
                    <div id="modal-task-job-name" class="task-modal-info"></div>
                </div>
            </div>
            <div class="task-modal-footer">
                <button class="task-modal-btn cancel" onclick="closeTaskModal()">Zrušit</button>
                <button class="task-modal-btn save" onclick="saveTaskModal()">Uložit změny</button>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div class="plan-modal-overlay" id="planModalOverlay" onclick="closePlanModal(event)">
        <div class="plan-modal" onclick="event.stopPropagation()">
            <div class="plan-modal-header">
                <span>Přiřadit zaměstnance</span>
                <button class="plan-modal-close" onclick="closePlanModal()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="plan-modal-body">
                <input type="hidden" id="plan-modal-id">
                <div class="plan-modal-field">
                    <label>Zaměstnanec</label>
                    <select id="plan-employee"></select>
                </div>
                <div class="plan-modal-field">
                    <label>Zakázka</label>
                    <select id="plan-job">
                        <option value="">— Bez zakázky —</option>
                    </select>
                </div>
                <div class="plan-modal-row">
                    <div class="plan-modal-field">
                        <label>Plánované hodiny</label>
                        <input type="number" id="plan-hours" value="8" min="0" max="24" step="0.5">
                    </div>
                    <div class="plan-modal-field">
                        <label>Status</label>
                        <select id="plan-status">
                            <option value="planned">Plánováno</option>
                            <option value="uncertain">Nejistý</option>
                            <option value="sick">Nemoc</option>
                            <option value="vacation">Dovolená</option>
                            <option value="absent">Absence</option>
                        </select>
                    </div>
                </div>
                <div class="plan-modal-field">
                    <label>Poznámka</label>
                    <input type="text" id="plan-note" placeholder="Volitelná poznámka...">
                </div>
            </div>
            <div class="plan-modal-footer">
                <button class="plan-modal-btn cancel" onclick="closePlanModal()">Zrušit</button>
                <button class="plan-modal-btn save" onclick="savePlan()">Uložit</button>
            </div>
        </div>
    </div>
</body>
</html>
