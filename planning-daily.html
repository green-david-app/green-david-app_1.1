<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control | Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <link rel="stylesheet" href="/static/css/glass-design.css"/>
    <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
    <link rel="stylesheet" href="/static/icons.css">
    <script src="/static/js/debug.js"></script>
    <script src="/app-settings.js"></script>
    <style>
    :root {
        --mc-bg: #1a1d1f;
        --mc-s1: #111827;
        --mc-s2: #1a2332;
        --mc-s3: #243044;
        --mc-brd: #1e2d45;
        --mc-t1: #f1f5f9;
        --mc-t2: #94a3b8;
        --mc-t3: #475569;
        --mc-grn: #4ade80;
        --mc-grn-d: rgba(74,222,128,0.1);
        --mc-red: #f87171;
        --mc-red-d: rgba(248,113,113,0.1);
        --mc-amb: #fbbf24;
        --mc-amb-d: rgba(251,191,36,0.1);
        --mc-blu: #60a5fa;
        --mc-blu-d: rgba(96,165,250,0.1);
        --mc-pur: #a78bfa;
    }

    .mc { max-width: 1400px; margin: 0 auto; padding: 0 16px 100px; }

    /* ── Sub-nav (Dnes/Timeline/Týden/Náklady) ── */
    .mc-subnav {
        display: flex; align-items: center; gap: 8px; padding: 16px 0 14px;
        border-bottom: 1px solid var(--mc-brd); margin-bottom: 24px; flex-wrap: wrap;
        margin-top: 8px;
    }
    .mc-subnav a {
        padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
        text-decoration: none; transition: all 0.15s;
        background: var(--mc-s1); border: 1px solid var(--mc-brd); color: var(--mc-t2);
    }
    .mc-subnav a:hover { background: var(--mc-s2); color: var(--mc-t1); }
    .mc-subnav a.active { background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(74,222,128,0.08)); color: #4ade80; border: 1px solid rgba(74,222,128,0.35); box-shadow: 0 0 12px rgba(74,222,128,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .mc-subnav .spacer { flex: 1; }

    /* ── Date strip ── */
    .mc-datestrip {
        display: flex; align-items: center; gap: 10px; justify-content: center;
        margin-bottom: 24px;
    }
    .mc-datestrip button {
        padding: 8px 14px; background: var(--mc-s1); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t2); font-size: 13px; font-weight: 600;
        cursor: pointer; transition: all 0.15s;
    }
    .mc-datestrip button:hover { background: var(--mc-s2); color: var(--mc-t1); border-color: var(--mc-t3); }
    .mc-datestrip button.today-btn { background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(74,222,128,0.08)); color: #4ade80; border: 1px solid rgba(74,222,128,0.35); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .mc-datestrip .date-display {
        font-size: 20px; font-weight: 800; color: var(--mc-t1); min-width: 220px; text-align: center;
    }
    .mc-datestrip .date-display .day-name {
        font-size: 13px; font-weight: 600; color: var(--mc-grn); text-transform: uppercase;
        letter-spacing: 0.5px; display: block; margin-bottom: 2px;
    }
    .mc-datestrip .date-display:hover { color: var(--mc-grn); transition: color 0.2s; }

    /* ── Mission Score ── */
    .mission-score-section {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px 0 16px;
    }

    .mission-score-ring-container {
        text-align: center;
    }

    .mission-score-ring {
        position: relative;
        width: 140px;
        height: 140px;
        margin: 0 auto 12px;
    }

    .mission-score-ring .score-svg,
    .mission-score-ring svg {
        width: 140px;
        height: 140px;
        max-width: 140px;
        max-height: 140px;
        display: block;
    }

    .score-svg {
        transform: rotate(-90deg);
    }

    .score-bg-ring {
        fill: none;
        stroke: var(--mc-brd);
        stroke-width: 8;
    }

    .score-fill-ring {
        fill: none;
        stroke: #4ade80;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease, stroke 0.5s ease;
    }

    .score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        font-weight: 900;
        color: var(--mc-t1);
        line-height: 1;
    }

    .score-label {
        font-size: 16px;
        font-weight: 700;
        color: var(--mc-t1);
        margin-bottom: 4px;
    }

    .score-sublabel {
        font-size: 12px;
        color: var(--mc-t2);
        max-width: 300px;
        margin: 0 auto;
    }

    /* ── Score Ring Row ── */
    .mc-score-row {
        display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px;
    }
    @media(max-width:700px){ .mc-score-row { grid-template-columns: 1fr 1fr; } }
    .mc-score-card {
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 14px;
        padding: 18px; display: flex; align-items: center; gap: 14px;
        transition: border-color 0.15s;
    }
    .mc-score-card:hover { border-color: var(--mc-t3); }
    .mc-ring {
        width: 52px; height: 52px; position: relative; flex-shrink: 0;
    }
    .mc-ring svg { width: 52px; height: 52px; transform: rotate(-90deg); }
    .mc-ring .ring-bg { fill: none; stroke: var(--mc-s3); stroke-width: 4; }
    .mc-ring .ring-fg { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }
    .mc-ring .ring-val {
        position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: 800; color: var(--mc-t1);
    }
    .mc-score-info { flex: 1; min-width: 0; }
    .mc-score-label { font-size: 10px; font-weight: 700; color: var(--mc-t3); text-transform: uppercase; letter-spacing: 0.5px; }
    .mc-score-val { font-size: 22px; font-weight: 800; color: var(--mc-t1); margin: 2px 0; }
    .mc-score-sub { font-size: 11px; color: var(--mc-t3); }

    /* ── Signals (alerts) ── */
    .mc-signals { display: grid; gap: 8px; margin-bottom: 24px; }
    .mc-signal {
        display: flex; align-items: center; gap: 12px; padding: 14px 16px;
        border-radius: 10px; font-size: 13px; font-weight: 500;
        cursor: pointer; transition: all 0.12s;
    }
    .mc-signal:hover { transform: translateX(4px); }
    .mc-signal.red { background: var(--mc-red-d); border-left: 3px solid var(--mc-red); color: var(--mc-red); }
    .mc-signal.amber { background: var(--mc-amb-d); border-left: 3px solid var(--mc-amb); color: var(--mc-amb); }
    .mc-signal.blue { background: var(--mc-blu-d); border-left: 3px solid var(--mc-blu); color: var(--mc-blu); }
    .mc-signal.green { background: var(--mc-grn-d); border-left: 3px solid var(--mc-grn); color: var(--mc-grn); }
    .mc-signal svg { width: 18px; height: 18px; flex-shrink: 0; }
    .mc-signal .sig-text { flex: 1; }
    .mc-signal .sig-count {
        font-weight: 800; font-size: 15px; padding: 2px 10px;
        border-radius: 6px; background: rgba(255,255,255,0.06);
    }

    /* ── Signal Accordion ── */
    .mc-signal {
        position: relative;
    }

    .signal-arrow {
        font-size: 10px;
        color: var(--mc-t3);
        transition: transform 0.3s;
        margin-left: auto;
    }

    .signal-detail {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: var(--mc-s2);
        border-radius: 0 0 10px 10px;
        margin-top: -10px;
        margin-left: -16px;
        margin-right: -16px;
        margin-bottom: -14px;
    }

    .signal-detail-inner {
        padding: 12px 16px;
    }

    .signal-item {
        padding: 10px 0;
        border-bottom: 1px solid var(--mc-brd);
        transition: background-color 0.2s;
    }

    .signal-item:last-child {
        border-bottom: none;
    }

    .signal-item[data-task-id]:hover {
        background-color: var(--mc-s3);
        margin: 0 -12px;
        padding: 10px 12px;
        border-radius: 6px;
    }

    .signal-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .signal-item-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--mc-t1);
    }

    .signal-item-late {
        font-size: 12px;
        font-weight: 600;
    }

    .signal-item-role {
        font-size: 11px;
        color: var(--mc-t2);
    }

    .signal-item-meta {
        font-size: 11px;
        color: var(--mc-t2);
        margin-bottom: 6px;
    }

    .signal-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 6px;
        padding: 4px 10px;
        background: transparent;
        border: 1px solid var(--mc-grn);
        border-radius: 6px;
        color: var(--mc-grn);
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
    }

    .signal-action-btn:hover {
        background: var(--mc-grn-d);
    }

    /* ── Toast Notification ── */
    .mc-toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--mc-s2, #252540);
        border: 1px solid var(--mc-accent, #4ade80);
        border-radius: 12px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--mc-t1, #e2e8f0);
        font-size: 14px;
        z-index: 10000;
        transform: translateX(120%);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        max-width: 400px;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.15); }
    }

    /* ── Trajectory ── */
    .trajectory-section {
        margin: 24px 0;
    }

    .trajectory-section .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: 700;
        color: var(--mc-t1);
        margin: 0 0 16px 0;
    }

    .trajectory-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    @media (max-width: 900px) {
        .trajectory-grid {
            grid-template-columns: 1fr;
        }
    }

    .traj-card {
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 16px;
        padding: 20px;
    }

    .traj-icon-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        color: var(--mc-t2);
    }

    .traj-title {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .traj-body .traj-metric {
        font-size: 28px;
        font-weight: 800;
        line-height: 1.2;
        margin-bottom: 4px;
    }

    .traj-body .traj-desc {
        font-size: 13px;
        color: var(--mc-t2);
        margin-bottom: 12px;
    }

    .traj-body .traj-bar {
        height: 6px;
        background: var(--mc-brd);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .traj-body .traj-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .traj-body .traj-verdict {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
    }

    .traj-trend-up { color: #4ade80; }
    .traj-trend-down { color: #f87171; }
    .traj-trend-flat { color: #fbbf24; }

    /* ── Sections ── */
    .mc-section { margin-bottom: 28px; }
    .mc-sec-hdr {
        display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
        padding-bottom: 10px; border-bottom: 1px solid var(--mc-brd);
    }
    .mc-sec-hdr svg { width: 20px; height: 20px; stroke: var(--mc-grn); fill: none; stroke-width: 2; }
    .mc-sec-title { font-size: 16px; font-weight: 700; color: var(--mc-t1); }
    .mc-sec-count {
        font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px;
        background: var(--mc-s2); color: var(--mc-t3);
    }
    .mc-sec-action {
        margin-left: auto; font-size: 12px; color: var(--mc-grn); font-weight: 600;
        text-decoration: none; padding: 4px 10px; border-radius: 6px;
    }
    .mc-sec-action:hover { background: var(--mc-grn-d); }

    /* ── Team Grid ── */
    .mc-team-grid { display: grid; gap: 6px; }
    .mc-team-row {
        display: grid; grid-template-columns: 200px 1fr 80px 80px; gap: 12px;
        align-items: start; padding: 12px 14px; background: var(--mc-s1);
        border: 1px solid var(--mc-brd); border-radius: 10px; font-size: 13px;
        transition: border-color 0.12s;
    }
    .mc-team-row > * {
        display: flex; align-items: center;
    }
    .mc-team-row > .mc-emp-name-wrapper {
        align-items: flex-start;
    }
    .mc-team-row:hover { border-color: var(--mc-t3); }
    .mc-team-row.header {
        background: transparent; border: none; font-size: 10px; font-weight: 700;
        color: var(--mc-t3); text-transform: uppercase; letter-spacing: 0.4px;
        padding: 0 14px 4px;
    }
    @media(max-width:600px){ .mc-team-row { grid-template-columns: 1fr 1fr; } .mc-team-row.header { display:none; } }
    .mc-emp-name { font-weight: 600; color: var(--mc-t1); display: flex; align-items: center; gap: 8px; }
    .mc-emp-name-wrapper {
        display: flex; flex-direction: column; gap: 6px; min-width: 0;
    }
    .mc-emp-name-row {
        display: flex; align-items: center; gap: 8px;
    }
    .mc-emp-avatar {
        width: 28px; height: 28px; border-radius: 50%; background: var(--mc-s3);
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 700; color: var(--mc-grn); flex-shrink: 0;
    }
    .mc-emp-capacity {
        display: flex; align-items: center; gap: 8px; font-size: 11px;
    }
    .mc-emp-capacity-bar {
        flex: 1; height: 6px; background: var(--mc-s3); border-radius: 3px; overflow: hidden;
        min-width: 60px;
    }
    .mc-emp-capacity-fill {
        height: 100%; border-radius: 3px; transition: width 0.3s ease, background-color 0.3s ease;
    }
    .mc-emp-capacity-fill.green { background: var(--mc-grn); }
    .mc-emp-capacity-fill.orange { background: var(--mc-amb); }
    .mc-emp-capacity-fill.red { background: var(--mc-red); }
    .mc-emp-capacity-text {
        font-weight: 600; color: var(--mc-t2); white-space: nowrap; font-size: 10px;
    }
    .mc-emp-job { color: var(--mc-t2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mc-emp-hours { font-weight: 700; color: var(--mc-grn); text-align: center; }
    .mc-emp-status { text-align: center; }
    .mc-status-dot {
        display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px;
    }
    .mc-status-dot.active { background: var(--mc-grn); }
    .mc-status-dot.idle { background: var(--mc-t3); }

    /* ── Task List ── */
    .mc-task-list { display: grid; gap: 6px; }
    .mc-task {
        display: flex; align-items: center; gap: 12px; padding: 12px 14px;
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 10px;
        transition: all 0.12s; cursor: pointer;
    }
    .mc-task:hover { border-color: var(--mc-t3); transform: translateX(2px); }
    .mc-task-pri {
        width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0;
    }
    .mc-task-pri.high { background: var(--mc-red); }
    .mc-task-pri.medium { background: var(--mc-amb); }
    .mc-task-pri.low { background: var(--mc-blu); }
    .mc-task-pri.none { background: var(--mc-t3); }
    .mc-task-body { flex: 1; min-width: 0; }
    .mc-task-title { font-size: 14px; font-weight: 600; color: var(--mc-t1); }
    .mc-task-meta { font-size: 11px; color: var(--mc-t3); margin-top: 2px; display: flex; gap: 10px; flex-wrap: wrap; }
    .mc-task-badge {
        padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.2px;
    }
    .mc-task-badge.overdue { background: var(--mc-red-d); color: var(--mc-red); }
    .mc-task-badge.today { background: var(--mc-amb-d); color: var(--mc-amb); }
    .mc-task-badge.upcoming { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-task-badge.nodate { background: rgba(255,255,255,0.05); color: var(--mc-t3); }

    /* ── Job Cards ── */
    .mc-jobs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    .mc-job {
        position: relative;
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 12px;
        padding: 16px; cursor: pointer; transition: all 0.15s;
    }
    .mc-job:hover { border-color: var(--mc-grn); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    .mc-job-hdr { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .mc-job-name { font-size: 15px; font-weight: 700; color: var(--mc-t1); }
    .mc-job-status {
        padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase;
    }
    .mc-job-status.plan { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-job-status.active { background: var(--mc-grn-d); color: var(--mc-grn); }
    .mc-job-meta { font-size: 12px; color: var(--mc-t3); display: flex; flex-direction: column; gap: 4px; }
    .mc-job-progress {
        height: 4px; background: var(--mc-s3); border-radius: 2px; margin-top: 10px; overflow: hidden;
    }
    .mc-job-progress-bar { height: 100%; border-radius: 2px; transition: width 0.4s ease; }

    /* ── Risk Indicators ── */
    .job-card-badges {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
    }

    .risk-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
    }

    .risk-reasons {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }

    .risk-tag {
        display: inline-block;
        padding: 2px 8px;
        border: 1px solid;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    /* ── Suggestions ── */
    .mc-suggest {
        display: flex; gap: 12px; padding: 14px 16px; background: var(--mc-s1);
        border: 1px solid var(--mc-brd); border-radius: 10px; margin-bottom: 6px;
        border-left: 3px solid var(--mc-pur);
    }
    .mc-suggest-icon {
        width: 32px; height: 32px; background: rgba(167,139,250,0.1); border-radius: 8px;
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .mc-suggest-icon svg { width: 16px; height: 16px; stroke: var(--mc-pur); }
    .mc-suggest-body { flex: 1; }
    .mc-suggest-title { font-size: 13px; font-weight: 700; color: var(--mc-t1); }
    .mc-suggest-desc { font-size: 12px; color: var(--mc-t3); margin-top: 2px; }

    /* ── Empty ── */
    .mc-empty {
        text-align: center; padding: 32px; color: var(--mc-t3); font-size: 13px;
    }
    .mc-empty svg { display: block; margin: 0 auto 10px; opacity: 0.2; }

    /* ── Weather Card ── */
    .mc-weather-card {
        background: var(--mc-s1); border: 1px solid var(--mc-brd); border-radius: 14px;
        padding: 20px; margin-bottom: 24px; position: relative; overflow: hidden;
    }
    .mc-weather-card::before {
        content: ''; position: absolute; inset: 0; opacity: 0.15; pointer-events: none;
        background: linear-gradient(135deg, var(--mc-blu) 0%, var(--mc-s2) 100%);
        z-index: 0;
    }
    .mc-weather-card.weather-clear::before {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }
    .mc-weather-card.weather-clouds::before {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }
    .mc-weather-card.weather-rain::before {
        background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
    }
    .mc-weather-card.weather-error::before {
        background: linear-gradient(135deg, var(--mc-s2) 0%, var(--mc-s3) 100%);
    }
    .mc-weather-content {
        position: relative; z-index: 1; display: grid; grid-template-columns: auto 1fr auto;
        gap: 20px; align-items: start;
    }
    @media(max-width:600px){ .mc-weather-content { grid-template-columns: 1fr; } }
    .mc-weather-main {
        display: flex; flex-direction: column; gap: 8px;
    }
    .mc-weather-title {
        font-size: 13px; font-weight: 700; color: var(--mc-t3); text-transform: uppercase;
        letter-spacing: 0.5px; margin-bottom: 4px;
    }
    .mc-weather-temp {
        font-size: 36px; font-weight: 800; color: var(--mc-t1); line-height: 1;
    }
    .mc-weather-desc {
        font-size: 14px; font-weight: 600; color: var(--mc-t2); margin-top: 4px;
    }
    .mc-weather-feels {
        font-size: 11px; color: var(--mc-t3); margin-top: 2px;
    }
    .mc-weather-details {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; flex: 1;
    }
    @media(max-width:600px){ .mc-weather-details { grid-template-columns: 1fr; } }
    .mc-weather-detail {
        display: flex; flex-direction: column; gap: 4px;
    }
    .mc-weather-detail-label {
        font-size: 10px; font-weight: 700; color: var(--mc-t3); text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .mc-weather-detail-value {
        font-size: 14px; font-weight: 600; color: var(--mc-t1);
    }
    .mc-weather-warning {
        grid-column: 1 / -1; padding: 12px; border-radius: 8px; margin-top: 8px;
        background: var(--mc-red-d); border-left: 3px solid var(--mc-red);
        display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600;
        color: var(--mc-red);
    }
    .mc-weather-warning svg {
        width: 18px; height: 18px; flex-shrink: 0; stroke: var(--mc-red);
    }
    .mc-weather-icon {
        width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); border-radius: 12px; flex-shrink: 0;
    }
    .mc-weather-icon svg {
        width: 48px; height: 48px; stroke: var(--mc-t1); fill: none; stroke-width: 1.5;
    }
    .mc-weather-error {
        text-align: center; padding: 20px; color: var(--mc-t3); font-size: 13px;
    }

    /* ── Task Filters ── */
    .mc-task-filters {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .mc-task-filters select {
        background: var(--mc-s2);
        border: 1px solid var(--mc-brd);
        border-radius: 8px;
        color: var(--mc-t2);
        padding: 6px 12px;
        font-size: 12px;
        font-family: inherit;
        cursor: pointer;
        outline: none;
        min-width: 140px;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
    }
    .mc-task-filters select:hover {
        border-color: var(--mc-t3);
        color: var(--mc-t1);
    }
    .mc-task-filters select:focus {
        border-color: var(--mc-grn);
    }

    /* ── Drag & Drop ── */
    .mc-task[draggable="true"] { cursor: grab; }
    .mc-task.dragging { opacity: 0.4; transform: scale(0.97); }
    .mc-task.drag-over { border-color: var(--mc-grn); box-shadow: 0 0 0 1px var(--mc-grn); }
    .mc-team-row.drop-target { border-color: var(--mc-grn); background: rgba(74,222,128,0.05); }

    /* ── Task Modal ── */
    .task-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    .task-modal-overlay.active {
        display: flex;
    }
    .task-modal {
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 16px;
        width: 90%;
        max-width: 520px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        margin: 0 auto;
    }
    .task-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 22px;
        border-bottom: 1px solid var(--mc-brd);
    }
    .task-modal-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--mc-t1);
    }
    .task-modal-close {
        background: none;
        border: none;
        color: var(--mc-t3);
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
    }
    .task-modal-close:hover { color: var(--mc-t1); background: var(--mc-s2); }
    .task-modal-body { padding: 22px; }
    .task-modal-field {
        margin-bottom: 16px;
    }
    .task-modal-field label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: var(--mc-t3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }
    .task-modal-field input,
    .task-modal-field select,
    .task-modal-field textarea {
        width: 100%;
        background: var(--mc-s2);
        border: 1px solid var(--mc-brd);
        border-radius: 8px;
        color: var(--mc-t1);
        padding: 10px 12px;
        font-size: 14px;
        font-family: inherit;
        outline: none;
        box-sizing: border-box;
    }
    .task-modal-field input:focus,
    .task-modal-field select:focus,
    .task-modal-field textarea:focus {
        border-color: var(--mc-grn);
    }
    .task-modal-field textarea { resize: vertical; }
    .task-modal-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .task-modal-info {
        padding: 8px 12px;
        background: var(--mc-s2);
        border-radius: 8px;
        color: var(--mc-t2);
        font-size: 13px;
    }
    .task-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 16px 22px;
        border-top: 1px solid var(--mc-brd);
    }
    .task-modal-btn {
        padding: 10px 22px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-family: inherit;
    }
    .task-modal-btn.cancel {
        background: var(--mc-s2);
        color: var(--mc-t2);
    }
    .task-modal-btn.cancel:hover { background: var(--mc-s3); color: var(--mc-t1); }
    .task-modal-btn.save {
        background: var(--mc-grn);
        color: #0a0e11;
    }
    .task-modal-btn.save:hover { filter: brightness(1.1); }

    @media (max-width: 600px) {
        .task-modal { width: 95%; max-width: none; }
        .task-modal-row { grid-template-columns: 1fr; }
        .mc-task-filters { flex-direction: column; }
        .mc-task-filters select { min-width: 100%; }
    }

    /* ── Day Plan Grid ── */
    .mc-plan-grid {
        display: grid;
        gap: 4px;
    }
    .mc-plan-header {
        display: grid;
        grid-template-columns: 180px 1fr 80px 100px 50px;
        gap: 8px;
        padding: 8px 12px;
        font-size: 11px;
        font-weight: 700;
        color: var(--mc-t3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--mc-brd);
    }
    .mc-plan-row {
        display: grid;
        grid-template-columns: 180px 1fr 80px 100px 50px;
        gap: 8px;
        padding: 10px 12px;
        align-items: center;
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 10px;
        transition: border-color 0.2s;
    }
    .mc-plan-row:hover { border-color: var(--mc-t3); }
    .mc-plan-row.status-sick { border-left: 3px solid var(--mc-red); opacity: 0.6; }
    .mc-plan-row.status-vacation { border-left: 3px solid var(--mc-blu); opacity: 0.6; }
    .mc-plan-row.status-absent { border-left: 3px solid var(--mc-red); opacity: 0.5; }
    .mc-plan-row.status-uncertain { border-left: 3px solid var(--mc-amb); }
    .mc-plan-row.status-confirmed { border-left: 3px solid var(--mc-grn); background: rgba(74,222,128,0.03); }

    .mc-plan-emp {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .mc-plan-avatar {
        width: 32px; height: 32px;
        border-radius: 50%;
        background: var(--mc-grn);
        color: #0a0e11;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; font-weight: 700;
        flex-shrink: 0;
    }
    .mc-plan-emp-name { font-size: 14px; font-weight: 600; color: var(--mc-t1); }
    .mc-plan-job { font-size: 13px; color: var(--mc-t2); }
    .mc-plan-hours {
        font-size: 14px; font-weight: 700; color: var(--mc-t1);
        text-align: center;
    }
    .mc-plan-status-badge {
        font-size: 11px; font-weight: 600; padding: 3px 8px;
        border-radius: 6px; text-align: center; white-space: nowrap;
    }
    .mc-plan-status-badge.planned { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-plan-status-badge.confirmed { background: var(--mc-grn-d); color: var(--mc-grn); }
    .mc-plan-status-badge.absent { background: var(--mc-red-d); color: var(--mc-red); }
    .mc-plan-status-badge.sick { background: var(--mc-red-d); color: var(--mc-red); }
    .mc-plan-status-badge.vacation { background: var(--mc-blu-d); color: var(--mc-blu); }
    .mc-plan-status-badge.uncertain { background: var(--mc-amb-d); color: var(--mc-amb); }

    .mc-plan-delete {
        background: none; border: none; color: var(--mc-t3);
        cursor: pointer; padding: 4px; border-radius: 6px; font-size: 16px;
    }
    .mc-plan-delete:hover { color: var(--mc-red); background: var(--mc-red-d); }

    .mc-plan-empty {
        text-align: center; padding: 30px; color: var(--mc-t3);
        font-size: 14px;
    }

    .mc-plan-status-select {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 6px; color: var(--mc-t2); padding: 4px 6px;
        font-size: 11px; font-family: inherit; cursor: pointer; outline: none;
        width: 100%;
    }

    /* ── Potvrzení dne ── */
    .mc-confirm-row {
        display: grid;
        grid-template-columns: 160px 1fr 80px 80px 1fr;
        gap: 8px;
        padding: 10px 12px;
        align-items: center;
        background: var(--mc-s1);
        border: 1px solid var(--mc-brd);
        border-radius: 10px;
        margin-bottom: 4px;
    }
    .mc-confirm-row .actual-input {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-grn); padding: 6px 10px;
        font-size: 14px; font-weight: 700; font-family: inherit;
        width: 100%; text-align: center; outline: none; box-sizing: border-box;
    }
    .mc-confirm-row .actual-input:focus { border-color: var(--mc-grn); }
    .mc-confirm-row .note-input {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t1); padding: 6px 10px;
        font-size: 13px; font-family: inherit;
        width: 100%; outline: none; box-sizing: border-box;
    }
    .mc-confirm-row .note-input:focus { border-color: var(--mc-grn); }
    .mc-confirm-header {
        display: grid;
        grid-template-columns: 160px 1fr 80px 80px 1fr;
        gap: 8px;
        padding: 6px 12px;
        font-size: 11px; font-weight: 700; color: var(--mc-t3);
        text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom: 1px solid var(--mc-brd);
        margin-bottom: 4px;
    }

    .mc-btn-confirm {
        background: var(--mc-grn); color: #0a0e11;
        border: none; border-radius: 10px; padding: 10px 24px;
        font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .mc-btn-confirm:hover { filter: brightness(1.1); }

    .mc-btn-show-confirm {
        background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t2); padding: 6px 14px;
        font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit;
        margin-top: 10px;
    }
    .mc-btn-show-confirm:hover { border-color: var(--mc-grn); color: var(--mc-t1); }

    /* ── Plan Modal ── */
    .plan-modal-overlay {
        display: none; position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        z-index: 9999;
        justify-content: center; align-items: center;
    }
    .plan-modal-overlay.active { display: flex; }
    .plan-modal {
        background: var(--mc-s1); border: 1px solid var(--mc-brd);
        border-radius: 16px; width: 90%; max-width: 480px;
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
    }
    .plan-modal-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 18px 22px; border-bottom: 1px solid var(--mc-brd);
    }
    .plan-modal-header span { font-size: 16px; font-weight: 700; color: var(--mc-t1); }
    .plan-modal-close {
        background: none; border: none; color: var(--mc-t3);
        cursor: pointer; padding: 4px; border-radius: 6px;
    }
    .plan-modal-close:hover { color: var(--mc-t1); background: var(--mc-s2); }
    .plan-modal-body { padding: 22px; }
    .plan-modal-field { margin-bottom: 16px; }
    .plan-modal-field label {
        display: block; font-size: 11px; font-weight: 600; color: var(--mc-t3);
        text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
    }
    .plan-modal-field select,
    .plan-modal-field input {
        width: 100%; background: var(--mc-s2); border: 1px solid var(--mc-brd);
        border-radius: 8px; color: var(--mc-t1); padding: 10px 12px;
        font-size: 14px; font-family: inherit; outline: none; box-sizing: border-box;
    }
    .plan-modal-field select:focus,
    .plan-modal-field input:focus { border-color: var(--mc-grn); }
    .plan-modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .plan-modal-footer {
        display: flex; justify-content: flex-end; gap: 10px;
        padding: 16px 22px; border-top: 1px solid var(--mc-brd);
    }
    .plan-modal-btn {
        padding: 10px 22px; border-radius: 10px; font-size: 14px;
        font-weight: 600; cursor: pointer; border: none; font-family: inherit;
    }
    .plan-modal-btn.cancel { background: var(--mc-s2); color: var(--mc-t2); }
    .plan-modal-btn.cancel:hover { background: var(--mc-s3); color: var(--mc-t1); }
    .plan-modal-btn.save { background: linear-gradient(135deg, rgba(74,222,128,0.85), rgba(34,197,94,0.85)); color: #0a0e11; box-shadow: 0 4px 12px rgba(74,222,128,0.2); backdrop-filter: blur(8px); }
    .plan-modal-btn.save:hover { filter: brightness(1.1); }

    @media (max-width: 768px) {
        .mc-plan-header, .mc-plan-row {
            grid-template-columns: 120px 1fr 60px 80px 40px;
            font-size: 12px;
        }
        .mc-confirm-header, .mc-confirm-row {
            grid-template-columns: 1fr;
            gap: 4px;
        }
        .plan-modal { width: 95%; }
        .plan-modal-row { grid-template-columns: 1fr; }
    }
    </style>
</head>
<body class="has-sidebar">
    <div id="app-header"></div>
    <div id="app-sidebar"></div>

    <div class="page-container">
    <div class="mc">
        <!-- Sub-navigation -->
        <div class="mc-subnav">
            <a href="/planning/daily" class="active">Dnes</a>
            <a href="/planning/timeline">Timeline</a>
            <a href="/planning/week">Týden</a>
            <a href="/planning/costs">Náklady</a>
            <a href="/planning/scenarios">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                    <path d="M15 18l6-6-6-6" opacity="0.5"/>
                </svg>
                Scénáře
            </a>
        </div>

        <!-- Date Navigation -->
        <div class="mc-datestrip">
            <button onclick="MC.go(-1)">← Včera</button>
            <button class="today-btn" onclick="MC.go(0)">Dnes</button>
            <div class="date-display" id="mc-date" onclick="document.getElementById('date-picker').showPicker()" style="cursor:pointer;" title="Klikni pro výběr data"></div>
            <input type="date" id="date-picker" style="position:absolute;opacity:0;pointer-events:none;width:0;height:0;" onchange="MC.goToDate(this.value)">
            <button onclick="MC.go(1)">Zítra →</button>
        </div>

        <!-- Mission Score -->
        <div class="mission-score-section">
            <div class="mission-score-ring-container">
                <div class="mission-score-ring" id="missionScoreRing">
                    <svg viewBox="0 0 120 120" width="140" height="140" class="score-svg">
                        <circle cx="60" cy="60" r="52" class="score-bg-ring"/>
                        <circle cx="60" cy="60" r="52" class="score-fill-ring" id="scoreCircle"
                            stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
                    </svg>
                    <div class="score-value" id="scoreValue">—</div>
                </div>
                <div class="score-label" id="scoreLabel">Načítám...</div>
                <div class="score-sublabel" id="scoreSublabel"></div>
            </div>
        </div>

        <!-- Score Cards -->
        <div class="mc-score-row" id="mc-scores"></div>

        <!-- Weather Card -->
        <div class="mc-weather-card" id="mc-weather"></div>

        <!-- Signals -->
        <div class="mc-signals" id="mc-signals"></div>

        <!-- Trajectory -->
        <div class="trajectory-section">
            <h2 class="section-title">
                <svg style="width:20px;height:20px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                Trajektorie
            </h2>
            <div class="trajectory-grid" id="trajectoryGrid">
                <div class="traj-card" id="trajWeek">
                    <div class="traj-icon-row">
                        <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span class="traj-title">Tento týden</span>
                    </div>
                    <div class="traj-body" id="trajWeekBody">Načítám...</div>
                </div>
                <div class="traj-card" id="trajMonth">
                    <div class="traj-icon-row">
                        <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span class="traj-title">Tento měsíc</span>
                    </div>
                    <div class="traj-body" id="trajMonthBody">Načítám...</div>
                </div>
                <div class="traj-card" id="trajCash">
                    <div class="traj-icon-row">
                        <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        <span class="traj-title">Cash flow</span>
                    </div>
                    <div class="traj-body" id="trajCashBody">Načítám...</div>
                </div>
            </div>
        </div>

        <!-- Team Planning -->
        <div class="mc-section" id="sec-team">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                <span class="mc-sec-title">Tým dne</span>
                <span class="mc-sec-count" id="team-count">0</span>
                <button class="mc-sec-action" id="btn-add-plan" onclick="openPlanModal()">+ Přiřadit</button>
                <button class="mc-sec-action" style="margin-left:4px" onclick="copyPreviousDay()">Kopírovat včerejšek</button>
            </div>
            
            <!-- Plánovací grid -->
            <div id="mc-team-grid"></div>
            
            <!-- Toggle pro Potvrzení dne -->
            <div id="confirm-section" style="display:none; margin-top: 16px;">
                <div class="mc-sec-hdr" style="margin-bottom:10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                    <span class="mc-sec-title">Potvrzení dne</span>
                </div>
                <div id="mc-confirm-list"></div>
                <div style="text-align:right; margin-top:12px;">
                    <button class="mc-btn-confirm" onclick="confirmAllPlans()">Potvrdit a vytvořit výkazy</button>
                </div>
            </div>
        </div>

        <!-- Tasks -->
        <div class="mc-section" id="sec-tasks">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                <span class="mc-sec-title">Úkoly</span>
                <span class="mc-sec-count" id="tasks-count">0</span>
                <a href="/tasks.html" class="mc-sec-action">Kanban →</a>
            </div>
            <div class="mc-task-filters" id="task-filters">
                <select id="filter-employee" onchange="applyTaskFilters()">
                    <option value="">Všichni zaměstnanci</option>
                </select>
                <select id="filter-status" onchange="applyTaskFilters()">
                    <option value="">Všechny stavy</option>
                    <option value="todo">K udělání</option>
                    <option value="open">Otevřené</option>
                    <option value="progress">Probíhá</option>
                    <option value="done">Hotovo</option>
                </select>
                <select id="filter-priority" onchange="applyTaskFilters()">
                    <option value="">Všechny priority</option>
                    <option value="urgent">Urgentní</option>
                    <option value="high">Vysoká</option>
                    <option value="medium">Střední</option>
                    <option value="low">Nízká</option>
                </select>
            </div>
            <div class="mc-task-list" id="mc-tasks"></div>
        </div>

        <!-- Active Jobs -->
        <div class="mc-section" id="sec-jobs">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
                <span class="mc-sec-title">Aktivní zakázky</span>
                <span class="mc-sec-count" id="jobs-count">0</span>
                <a href="/jobs.html" class="mc-sec-action">Vše →</a>
            </div>
            <div class="mc-jobs-grid" id="mc-jobs"></div>
        </div>

        <!-- Smart Suggestions -->
        <div class="mc-section" id="sec-suggest">
            <div class="mc-sec-hdr">
                <svg viewBox="0 0 24 24" style="stroke:var(--mc-pur)"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                <span class="mc-sec-title">Doporučení</span>
                <span class="mc-sec-count" id="suggest-count">0</span>
            </div>
            <div id="mc-suggest"></div>
        </div>
    </div>
    </div>

    <div id="bottom-nav-container"></div>
    <script src="/static/bottom-nav.js"></script>
    <script src="/static/app-sidebar.js"></script>
    <script src="/static/app-header.js"></script>

    <script>
    // ── Globální proměnné (musí být PŘED IIFE) ──
    let _cachedTasks = [];
    let _cachedEmployees = [];
    let draggedTaskId = null;
    let _dayPlans = [];
    let _activeJobs = [];

    // ── Utility funkce (globální scope) ──
    let curDate = new Date();
    curDate.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
    const ymd = d => d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    const fmtDate = d => d.toLocaleDateString('cs-CZ',{day:'numeric',month:'long',year:'numeric'});
    const fmtDay = d => d.toLocaleDateString('cs-CZ',{weekday:'long'}).replace(/^./,c=>c.toUpperCase());

    // ── Mission Score Calculation ──
    function calculateMissionScore(data) {
        let score = 100;
        let penalties = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // -10 za každý zpožděný úkol (due_date < dnes, status != 'done')
        const overdueTasks = (data.tasks || []).filter(t => {
            if (t.status === 'done' || t.status === 'completed') return false;
            if (!t.due_date) return false;
            const dueDate = new Date(t.due_date);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
        });
        if (overdueTasks.length > 0) {
            const penalty = overdueTasks.length * 10;
            score -= penalty;
            penalties.push(`${overdueTasks.length}× zpožděný úkol (-${penalty})`);
        }

        // -5 za zakázku bez deadlinu (aktivní)
        const noDeadlineJobs = (data.jobs || []).filter(j =>
            (j.status === 'Plán' || j.status === 'Probíhá') && !j.deadline
        );
        if (noDeadlineJobs.length > 0) {
            const penalty = noDeadlineJobs.length * 5;
            score -= penalty;
            penalties.push(`${noDeadlineJobs.length}× zakázka bez deadline (-${penalty})`);
        }

        // -15 za zakázku co nestíhá deadline (deadline < 7 dní a progress < 50%)
        const atRiskJobs = (data.jobs || []).filter(j => {
            if (!j.deadline || j.status === 'Dokončeno' || j.status === 'completed') return false;
            const deadline = new Date(j.deadline);
            deadline.setHours(0, 0, 0, 0);
            const daysLeft = (deadline - today) / 86400000;
            const progress = j.completion_percentage || j.progress || 0;
            return daysLeft < 7 && daysLeft >= 0 && progress < 50;
        });
        if (atRiskJobs.length > 0) {
            const penalty = atRiskJobs.length * 15;
            score -= penalty;
            penalties.push(`${atRiskJobs.length}× ohrožená zakázka (-${penalty})`);
        }

        // -3 za nepřiřazený úkol
        const unassigned = (data.tasks || []).filter(t =>
            t.status !== 'done' && t.status !== 'completed' && !t.employee_id
        );
        if (unassigned.length > 0) {
            const penalty = unassigned.length * 3;
            score -= penalty;
            penalties.push(`${unassigned.length}× nepřiřazený úkol (-${penalty})`);
        }

        // Minimum 0
        score = Math.max(0, score);

        // Určení stavu a barvy
        let label, color;
        if (score >= 90) { label = 'Mise běží hladce'; color = '#4ade80'; }
        else if (score >= 70) { label = 'Drobné odchylky v trajektorii'; color = '#fbbf24'; }
        else if (score >= 50) { label = 'Vyžaduje pozornost'; color = '#f97316'; }
        else { label = 'Kritický stav mise'; color = '#f87171'; }

        // Render
        renderMissionScore(score, label, color, penalties);
    }

    function renderMissionScore(score, label, color, penalties) {
        const circumference = 2 * Math.PI * 52; // 326.7
        const offset = circumference - (score / 100) * circumference;

        const circle = document.getElementById('scoreCircle');
        const valueEl = document.getElementById('scoreValue');
        const labelEl = document.getElementById('scoreLabel');
        const subEl = document.getElementById('scoreSublabel');

        if (circle) {
            circle.style.strokeDashoffset = offset;
            circle.style.stroke = color;
        }
        if (valueEl) {
            valueEl.textContent = score;
            valueEl.style.color = color;
        }
        if (labelEl) {
            labelEl.textContent = label;
            labelEl.style.color = color;
        }
        if (subEl) {
            subEl.textContent = penalties.length > 0
                ? penalties.slice(0, 3).join(' · ')
                : 'Žádné problémy';
        }
    }

    // ── Signal Detail Rendering Functions ──
    function renderOverdueDetail(tasks) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let html = '<div class="signal-detail-inner">';
        
        tasks.forEach(t => {
            const dueDate = new Date(t.due_date);
            dueDate.setHours(0, 0, 0, 0);
            const daysLate = Math.floor((today - dueDate) / 86400000);
            const empName = t.employee_name || 'Nepřiřazeno';
            const jobName = t.job_name || 'Bez zakázky';
            
            html += `
            <div class="signal-item" data-task-id="${t.id}" style="cursor:pointer;">
                <div class="signal-item-header">
                    <span class="signal-item-name">${esc(t.title || 'Bez názvu')}</span>
                    <span class="signal-item-late" style="color:#f87171">${daysLate} dní po termínu</span>
                </div>
                <div class="signal-item-meta">
                    ${esc(jobName)} · ${esc(empName)}
                </div>
                <button class="signal-action-btn" onclick="rescheduleTask(${t.id}, this, event)" data-task-id="${t.id}">
                    <svg style="width:12px;height:12px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Přeplánovat
                </button>
            </div>`;
        });
        
        html += '</div>';
        return html;
    }

    function renderDeadlineDetail(jobs) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let html = '<div class="signal-detail-inner">';
        
        jobs.forEach(j => {
            const deadline = new Date(j.deadline);
            deadline.setHours(0, 0, 0, 0);
            const daysLeft = Math.ceil((deadline - today) / 86400000);
            const progress = j.completion_percentage || j.progress || 0;
            
            // Predikce: kolik dní potřebuje při současném tempu
            const startDate = j.start_date ? new Date(j.start_date) : new Date(today.getTime() - 30*86400000);
            startDate.setHours(0, 0, 0, 0);
            const daysElapsed = Math.max(1, (today - startDate) / 86400000);
            const dailyProgress = progress / daysElapsed;
            const daysNeeded = dailyProgress > 0 ? Math.ceil((100 - progress) / dailyProgress) : 999;
            const willMissBy = daysNeeded - daysLeft;
            
            html += `
            <div class="signal-item">
                <div class="signal-item-header">
                    <span class="signal-item-name">${esc(j.name || 'Bez názvu')}</span>
                    <span style="color:${daysLeft <= 3 ? '#f87171' : '#fbbf24'}">${daysLeft} dní</span>
                </div>
                <div class="signal-item-meta">
                    Progress: <b>${progress.toFixed(0)}%</b>
                    ${willMissBy > 0 ? ` · <span style="color:#f87171">Nestihne o ~${willMissBy} dní</span>` : ' · <span style="color:#4ade80">Na trati</span>'}
                </div>
                <div style="height:4px;background:var(--mc-brd);border-radius:2px;margin-top:6px">
                    <div style="height:100%;width:${progress}%;background:${progress > 70 ? '#4ade80' : '#fbbf24'};border-radius:2px"></div>
                </div>
            </div>`;
        });
        
        html += '</div>';
        return html;
    }

    function renderNoTimesheetDetail(idleEmps, allEmployees) {
        let html = '<div class="signal-detail-inner">';
        
        idleEmps.forEach(e => {
            const emp = allEmployees.find(emp => emp.id === e.id) || e;
            const lastJob = emp.last_job_name || 'Neznámá';
            
            html += `
            <div class="signal-item">
                <div class="signal-item-header">
                    <span class="signal-item-name">${esc(emp.name || 'Bez jména')}</span>
                    <span class="signal-item-role">${esc(emp.role || emp.position || '')}</span>
                </div>
                <div class="signal-item-meta">
                    Poslední výkaz: ${emp.last_timesheet_date || 'žádný'} · Zakázka: ${esc(lastJob)}
                </div>
            </div>`;
        });
        
        html += '</div>';
        return html;
    }

    function renderUnassignedDetail(tasks) {
        let html = '<div class="signal-detail-inner">';
        
        tasks.forEach(t => {
            const jobName = t.job_name || 'Bez zakázky';
            html += `
            <div class="signal-item" data-task-id="${t.id}" style="cursor:pointer;">
                <div class="signal-item-header">
                    <span class="signal-item-name">${esc(t.title || 'Bez názvu')}</span>
                </div>
                <div class="signal-item-meta">
                    ${esc(jobName)}${t.due_date ? ' · Termín: ' + t.due_date : ''}
                </div>
            </div>`;
        });
        
        html += '</div>';
        return html;
    }

    function renderNoDateDetail(tasks) {
        let html = '<div class="signal-detail-inner">';
        
        tasks.forEach(t => {
            const empName = t.employee_name || 'Nepřiřazeno';
            const jobName = t.job_name || 'Bez zakázky';
            html += `
            <div class="signal-item" data-task-id="${t.id}" style="cursor:pointer;">
                <div class="signal-item-header">
                    <span class="signal-item-name">${esc(t.title || 'Bez názvu')}</span>
                </div>
                <div class="signal-item-meta">
                    ${esc(jobName)} · ${esc(empName)}
                </div>
            </div>`;
        });
        
        html += '</div>';
        return html;
    }

    function rescheduleTask(taskId, btn, e) {
        if (e) e.stopPropagation();
        else if (window.event) window.event.stopPropagation();
        
        // Nahraď tlačítko date inputem
        const input = document.createElement('input');
        input.type = 'date';
        input.style.cssText = 'background:var(--mc-s2);color:var(--mc-t1);border:1px solid var(--mc-grn);border-radius:6px;padding:4px 8px;font-size:12px;font-family:inherit;';
        input.onclick = (ev) => ev.stopPropagation();
        input.onchange = () => {
            fetch(`/api/tasks`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(taskId), due_date: input.value })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success || data.ok) {
                    load(); // Reload data
                } else {
                    alert('Chyba při přeplánování: ' + (data.error || 'Neznámá chyba'));
                }
            })
            .catch(err => {
                console.error('Reschedule error:', err);
                alert('Chyba při přeplánování úkolu');
            });
        };
        btn.replaceWith(input);
        input.focus();
    }

    // ── Risk Calculation ──
    function calculateJobRisk(job, tasks, today) {
        let risk = 0;
        let reasons = [];
        
        // +30 pokud deadline za méně než 7 dní a progress < 80%
        if (job.deadline) {
            const deadline = new Date(job.deadline);
            deadline.setHours(0, 0, 0, 0);
            const daysLeft = (deadline - today) / 86400000;
            const progress = job.completion_percentage || job.progress || 0;
            if (daysLeft < 7 && daysLeft >= 0 && progress < 80) {
                risk += 30;
                reasons.push(`deadline za ${Math.ceil(daysLeft)}d`);
            }
        }
        
        // +20 pokud nemá žádné úkoly
        const jobTasks = (tasks || []).filter(t => t.job_id == job.id);
        if (jobTasks.length === 0) {
            risk += 20;
            reasons.push('bez úkolů');
        }
        
        // +20 pokud budget spent > 80%
        if (job.budget && job.budget > 0 && job.spent) {
            const budgetPct = (job.spent / job.budget) * 100;
            if (budgetPct > 80) {
                risk += 20;
                reasons.push(`budget ${Math.round(budgetPct)}%`);
            }
        }
        
        // +15 pokud nemá deadline vůbec
        if (!job.deadline) {
            risk += 15;
            reasons.push('bez deadline');
        }
        
        // +10 za každý zpožděný úkol
        const overdueCount = jobTasks.filter(t => {
            if (t.status === 'done' || t.status === 'completed') return false;
            if (!t.due_date) return false;
            const dueDate = new Date(t.due_date);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
        }).length;
        if (overdueCount > 0) {
            risk += overdueCount * 10;
            reasons.push(`${overdueCount} zpožděn${overdueCount === 1 ? 'ý' : overdueCount < 5 ? 'é' : 'ých'} úkol${overdueCount === 1 ? '' : overdueCount < 5 ? 'y' : 'ů'}`);
        }
        
        // +5 pokud nemá přiřazeného project_managera
        if (!job.project_manager && !job.project_manager_id && !job.manager_id) {
            risk += 5;
            reasons.push('bez manažera');
        }
        
        // Cap na 100
        risk = Math.min(100, risk);
        
        // Úroveň a barva
        let level, color;
        if (risk <= 20) { level = 'Nízké'; color = '#4ade80'; }
        else if (risk <= 50) { level = 'Střední'; color = '#fbbf24'; }
        else { level = 'Vysoké'; color = '#f87171'; }
        
        return { risk, level, color, reasons };
    }

    // ── Trajectory Functions ──
    function renderTrajectory(data) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        renderTrajWeek(data, today);
        renderTrajMonth(data, today);
        renderTrajCash(data, today);
    }

    // ═══════════════════════════════════════════
    // 1) TENTO TÝDEN
    // ═══════════════════════════════════════════
    function renderTrajWeek(data, today) {
        const container = document.getElementById('trajWeekBody');
        if (!container) return;

        // Kolik dní zbývá do neděle
        const dayOfWeek = today.getDay(); // 0=ne, 1=po...
        const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;

        // Úkoly s due_date tento týden (po - ne) které nejsou done
        const monday = new Date(today);
        monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        monday.setHours(0, 0, 0, 0);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        sunday.setHours(23, 59, 59, 999);

        const weekTasks = (data.tasks || []).filter(t => {
            if (!t.due_date) return false;
            const d = new Date(t.due_date);
            d.setHours(0, 0, 0, 0);
            return d >= monday && d <= sunday;
        });

        const remaining = weekTasks.filter(t => t.status !== 'done' && t.status !== 'completed').length;
        const completed = weekTasks.filter(t => t.status === 'done' || t.status === 'completed').length;
        const total = weekTasks.length;

        // Tempo — průměr dokončených úkolů za den za posledních 14 dní
        const twoWeeksAgo = new Date(today);
        twoWeeksAgo.setDate(today.getDate() - 14);
        twoWeeksAgo.setHours(0, 0, 0, 0);
        const recentDone = (data.tasks || []).filter(t => {
            if (t.status !== 'done' && t.status !== 'completed') return false;
            // Bez completed_at můžeme jen odhadnout z due_date
            const d = new Date(t.due_date || t.updated_at || today);
            d.setHours(0, 0, 0, 0);
            return d >= twoWeeksAgo && d <= today;
        }).length;
        const avgPerDay = recentDone / 14;

        const canFinish = daysToSunday > 0 ? (avgPerDay * daysToSunday >= remaining) : (remaining === 0);
        const pct = total > 0 ? Math.round((completed / total) * 100) : 100;
        const color = canFinish ? '#4ade80' : '#f87171';

        container.innerHTML = `
            <div class="traj-metric" style="color:${color}">${remaining}</div>
            <div class="traj-desc">úkolů zbývá z ${total} tento týden · ${daysToSunday} dní do neděle</div>
            <div class="traj-bar"><div class="traj-bar-fill" style="width:${pct}%;background:${color}"></div></div>
            <div class="traj-verdict ${canFinish ? 'traj-trend-up' : 'traj-trend-down'}">
                <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${canFinish
                        ? '<polyline points="7 13 12 8 17 13"/>'
                        : '<polyline points="7 11 12 16 17 11"/>'
                    }
                </svg>
                ${canFinish
                    ? `Tempo stačí (${avgPerDay.toFixed(1)} úkolů/den)`
                    : `Tempo nestačí — potřeba ${remaining > 0 && daysToSunday > 0 ? (remaining/daysToSunday).toFixed(1) : '∞'} úkolů/den, průměr ${avgPerDay.toFixed(1)}`
                }
            </div>
        `;
    }

    // ═══════════════════════════════════════════
    // 2) TENTO MĚSÍC
    // ═══════════════════════════════════════════
    function renderTrajMonth(data, today) {
        const container = document.getElementById('trajMonthBody');
        if (!container) return;

        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        monthStart.setHours(0, 0, 0, 0);
        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        monthEnd.setHours(23, 59, 59, 999);

        // Zakázky s deadline tento měsíc
        const monthJobs = (data.jobs || []).filter(j => {
            if (!j.deadline || j.status === 'Dokončeno' || j.status === 'completed') return false;
            const d = new Date(j.deadline);
            d.setHours(0, 0, 0, 0);
            return d >= monthStart && d <= monthEnd;
        });

        let onTrack = 0;
        let delayed = 0;

        monthJobs.forEach(j => {
            const start = j.start_date ? new Date(j.start_date) : monthStart;
            start.setHours(0, 0, 0, 0);
            const deadline = new Date(j.deadline);
            deadline.setHours(0, 0, 0, 0);
            const totalDays = Math.max(1, (deadline - start) / 86400000);
            const elapsedDays = Math.max(0, (today - start) / 86400000);
            const expectedProgress = Math.min(100, (elapsedDays / totalDays) * 100);
            const actualProgress = j.completion_percentage || j.progress || 0;

            if (actualProgress >= expectedProgress) onTrack++;
            else delayed++;
        });

        const total = monthJobs.length;
        const pct = total > 0 ? Math.round((onTrack / total) * 100) : 100;
        const color = delayed === 0 ? '#4ade80' : delayed <= onTrack ? '#fbbf24' : '#f87171';

        container.innerHTML = `
            <div class="traj-metric" style="color:${color}">${onTrack}/${total}</div>
            <div class="traj-desc">zakázek na trati tento měsíc · ${delayed} zpožděných</div>
            <div class="traj-bar"><div class="traj-bar-fill" style="width:${pct}%;background:${color}"></div></div>
            <div class="traj-verdict ${delayed === 0 ? 'traj-trend-up' : 'traj-trend-down'}">
                <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${delayed === 0
                        ? '<polyline points="7 13 12 8 17 13"/>'
                        : '<polyline points="7 11 12 16 17 11"/>'
                    }
                </svg>
                ${delayed === 0
                    ? 'Všechny zakázky na trati'
                    : `${delayed} zakáz${delayed === 1 ? 'ka' : delayed < 5 ? 'ky' : 'ek'} zaostává za plánem`
                }
            </div>
        `;
    }

    // ═══════════════════════════════════════════
    // 3) CASH FLOW
    // ═══════════════════════════════════════════
    function renderTrajCash(data, today) {
        const container = document.getElementById('trajCashBody');
        if (!container) return;

        // Odhadované náklady tento měsíc
        // Průměr hodin/den z timesheets za posledních 30 dní
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        thirtyDaysAgo.setHours(0, 0, 0, 0);

        const recentTimesheets = (data.timesheets || []).filter(ts => {
            if (!ts.date) return false;
            const d = new Date(ts.date);
            d.setHours(0, 0, 0, 0);
            return d >= thirtyDaysAgo && d <= today;
        });

        const totalRecentHours = recentTimesheets.reduce((s, ts) => s + (ts.hours || 0), 0);
        const avgHoursPerDay = totalRecentHours / 30;

        // Průměrná hourly_rate
        const employees = data.employees || [];
        const ratesArr = employees.filter(e => e.hourly_rate && e.hourly_rate > 0).map(e => e.hourly_rate);
        const avgRate = ratesArr.length > 0 ? ratesArr.reduce((a, b) => a + b, 0) / ratesArr.length : 250;

        // Zbývající pracovní dny tohoto měsíce
        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        let workDaysLeft = 0;
        for (let d = new Date(today); d <= monthEnd; d.setDate(d.getDate() + 1)) {
            const dow = d.getDay();
            if (dow !== 0 && dow !== 6) workDaysLeft++;
        }

        const estimatedCost = avgHoursPerDay * workDaysLeft * avgRate;

        // Příjem — součet estimated_value aktivních zakázek
        const activeJobs = (data.jobs || []).filter(j => j.status === 'Probíhá' || j.status === 'Plán');
        const totalRevenue = activeJobs.reduce((s, j) => s + (j.estimated_value || 0), 0);

        const balance = totalRevenue - estimatedCost;
        const isPositive = balance >= 0;
        const color = isPositive ? '#4ade80' : '#f87171';

        const fmt = (n) => Math.round(n).toLocaleString('cs-CZ');

        container.innerHTML = `
            <div class="traj-metric" style="color:${color}">${isPositive ? '+' : ''}${fmt(balance)} Kč</div>
            <div class="traj-desc">odhad bilance tohoto měsíce</div>
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
                <span style="color:var(--mc-t2)">Příjem: <b style="color:#4ade80">${fmt(totalRevenue)} Kč</b></span>
                <span style="color:var(--mc-t2)">Náklady: <b style="color:#f87171">~${fmt(estimatedCost)} Kč</b></span>
            </div>
            <div class="traj-bar">
                <div class="traj-bar-fill" style="width:${totalRevenue > 0 ? Math.min(100, Math.round((estimatedCost / totalRevenue) * 100)) : 100}%;background:${isPositive ? '#4ade80' : '#f87171'}"></div>
            </div>
            <div class="traj-verdict ${isPositive ? 'traj-trend-up' : 'traj-trend-down'}">
                <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${isPositive
                        ? '<polyline points="7 13 12 8 17 13"/>'
                        : '<polyline points="7 11 12 16 17 11"/>'
                    }
                </svg>
                ${isPositive
                    ? `Pozitivní marže · ${workDaysLeft} prac. dní zbývá`
                    : `Záporná bilance · zvažte optimalizaci nákladů`
                }
            </div>
        `;
    }

    const MC = (function(){
    'use strict';
    // curDate, today, esc, ymd, fmtDate, fmtDay are declared globally above

    async function api(url){ try{ const r=await fetch(url,{credentials:'same-origin'}); if(r.ok) return r.json(); }catch(e){} return null; }

    function ring(pct, color){
        const r=20, c=2*Math.PI*r, off=c-(pct/100)*c;
        return `<div class="mc-ring">
            <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="${r}" class="ring-bg"/>
            <circle cx="24" cy="24" r="${r}" class="ring-fg" style="stroke:${color};stroke-dasharray:${c};stroke-dashoffset:${off}"/></svg>
            <div class="ring-val">${Math.round(pct)}%</div></div>`;
    }

    // ── Signal SVGs ──
    const sigIcon = {
        fire: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 12c2-2.96 0-7-1-8 0 3.038-1.773 4.741-3 6-1.226 1.26-2 3.24-2 5a6 6 0 1012 0c0-1.532-1.056-3.94-2-5-1.786 3-2.791 3-4 2z"/></svg>',
        warn: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>',
        ok: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
    };

    async function load(){
        const ds = ymd(curDate);
        document.getElementById('mc-date').innerHTML = `<span class="day-name">${fmtDay(curDate)}</span>${fmtDate(curDate)}`;
        document.getElementById('date-picker').value = ds;

        // Parallel fetch
        const [daily, notif, suggest, allTasks, allEmps, dayPlansResp] = await Promise.all([
            api('/api/planning/daily/'+ds),
            api('/api/planning/notifications'),
            api('/api/planning/suggestions'),
            api('/api/tasks'),
            api('/api/employees'),
            api('/api/planning/day-plans/'+ds)
        ]);
        const dayPlans = dayPlansResp?.plans || [];

        const tasks = daily?.tasks || [];
        const timesheets = daily?.timesheets || [];
        const jobs = daily?.active_jobs || [];
        const allTasksList = allTasks?.tasks || [];
        const employees = allEmps?.employees || [];
        const weather = daily?.weather || null;

        // Cache dat pro modal a filtry
        _cachedTasks = allTasksList;
        _cachedEmployees = employees;

        // ── Compute signals ──
        const overdueTasks = allTasksList.filter(t => t.due_date && t.due_date < ds && t.status !== 'done' && t.status !== 'completed');
        const todayTasks = allTasksList.filter(t => t.due_date === ds && t.status !== 'done');
        const unassigned = allTasksList.filter(t => !t.employee_id && t.status !== 'done' && t.status !== 'completed');
        const noDateTasks = allTasksList.filter(t => !t.due_date && t.status !== 'done' && t.status !== 'completed');
        const activeEmps = employees.filter(e => e.status === 'active' || !e.status);
        // Score karty - použij day plans místo timesheets
        const plannedEmps = new Set(dayPlans.filter(p => p.status !== 'absent' && p.status !== 'vacation').map(p => p.employee_id));
        const workingEmps = plannedEmps; // Pro kompatibilitu
        const idleEmps = activeEmps.filter(e => !plannedEmps.has(e.id));
        const plannedHours = dayPlans.reduce((s,p) => s + (p.status !== 'absent' && p.status !== 'vacation' ? (p.actual_hours || p.planned_hours || 0) : 0), 0);
        const totalHours = plannedHours; // Pro kompatibilitu
        const isToday = ymd(curDate) === ymd(today);

        // Jobs approaching deadline
        const urgentJobs = jobs.filter(j => {
            if (!j.deadline) return false;
            const dl = new Date(j.deadline);
            const diff = (dl - curDate) / 864e5;
            return diff >= 0 && diff <= 7;
        });

        // ── Render Score Cards ──
        const tasksDone = allTasksList.filter(t => t.status === 'done' || t.status === 'completed').length;
        const tasksTotal = allTasksList.length;
        const taskPct = tasksTotal > 0 ? (tasksDone/tasksTotal)*100 : 0;
        const capacityPct = activeEmps.length > 0 ? (workingEmps.size / activeEmps.length)*100 : 0;
        const jobsWithDeadline = jobs.filter(j => j.deadline).length;
        const jobDeadlinePct = jobs.length > 0 ? (jobsWithDeadline/jobs.length)*100 : 0;

        // ── Render Weather ──
        const weatherEl = document.getElementById('mc-weather');
        if (!weather || !weather.temp || weather.description === 'Počasí nedostupné' || weather.is_mock) {
            weatherEl.className = 'mc-weather-card weather-error';
            weatherEl.innerHTML = `
                <div class="mc-weather-error">
                    <div style="font-size: 16px; font-weight: 700; color: var(--mc-t1); margin-bottom: 8px;">Počasí</div>
                    <div style="color: var(--mc-t3);">Nastavte OPENWEATHER_API_KEY</div>
                </div>
            `;
        } else {
            const weatherMain = (weather.description || '').toLowerCase();
            let weatherClass = 'weather-clouds';
            if (weatherMain.includes('jasno') || weatherMain.includes('slunečno') || weatherMain.includes('clear')) {
                weatherClass = 'weather-clear';
            } else if (weatherMain.includes('déšť') || weatherMain.includes('rain') || weatherMain.includes('prší')) {
                weatherClass = 'weather-rain';
            }

            const warningIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';

            weatherEl.className = `mc-weather-card ${weatherClass}`;
            weatherEl.innerHTML = `
                <div class="mc-weather-content">
                    <div class="mc-weather-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            ${weatherMain.includes('déšť') || weatherMain.includes('rain') ? 
                                '<path d="M16 13v8M8 13v8M12 15v8M20 8.5A7.5 7.5 0 1112 3a7.5 7.5 0 017.5 5.5z"/>' :
                            weatherMain.includes('jasno') || weatherMain.includes('clear') || weatherMain.includes('slunečno') ?
                                '<circle cx="12" cy="12" r="5"/><path d="M12 1v4M12 19v4M23 12h-4M5 12H1M19.07 4.93l-2.83 2.83M7.76 16.24l-2.83 2.83M19.07 19.07l-2.83-2.83M7.76 7.76l-2.83-2.83"/>' :
                                '<path d="M18 10h-1.26A8 8 0 106 22h12a8 8 0 000-12z"/>'}
                        </svg>
                    </div>
                    <div class="mc-weather-main">
                        <div class="mc-weather-title">Příbram, CZ</div>
                        <div class="mc-weather-temp">${Math.round(weather.temp)}°C</div>
                        <div class="mc-weather-desc">${esc(weather.description || '—')}</div>
                        ${weather.feels_like ? `<div class="mc-weather-feels">Pocitově ${Math.round(weather.feels_like)}°C</div>` : ''}
                    </div>
                    <div class="mc-weather-details">
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Vlhkost</div>
                            <div class="mc-weather-detail-value">${weather.humidity || '—'}%</div>
                        </div>
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Vítr</div>
                            <div class="mc-weather-detail-value">${weather.wind_speed || '—'} m/s</div>
                        </div>
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Srážky</div>
                            <div class="mc-weather-detail-value">${weather.rain_probability || 0}%</div>
                        </div>
                        <div class="mc-weather-detail">
                            <div class="mc-weather-detail-label">Status</div>
                            <div class="mc-weather-detail-value" style="color: ${weather.suitable_for_outdoor ? 'var(--mc-grn)' : 'var(--mc-red)'};">
                                ${weather.suitable_for_outdoor ? 'Vhodné' : 'Nevhodné'}
                            </div>
                        </div>
                    </div>
                </div>
                ${!weather.suitable_for_outdoor ? `
                    <div class="mc-weather-warning">
                        ${warningIcon}
                        <span>Nevhodné počasí pro venkovní práce</span>
                    </div>
                ` : ''}
            `;
        }

        // Calculate Mission Score
        calculateMissionScore({
            tasks: allTasksList,
            jobs: jobs,
            employees: employees,
            timesheets: timesheets
        });

        // Render Trajectory
        renderTrajectory({
            tasks: allTasksList,
            jobs: jobs,
            employees: employees,
            timesheets: timesheets
        });

        document.getElementById('mc-scores').innerHTML = `
            <div class="mc-score-card">
                ${ring(capacityPct, workingEmps.size > 0 ? '#4ade80' : '#475569')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Tým</div>
                    <div class="mc-score-val">${workingEmps.size}/${activeEmps.length}</div>
                    <div class="mc-score-sub">${isToday && workingEmps.size === 0 ? 'Nikdo nepracuje' : totalHours > 0 ? totalHours+'h zalogováno' : 'lidí v práci'}</div>
                </div>
            </div>
            <div class="mc-score-card">
                ${ring(todayTasks.length > 0 ? 50 : (overdueTasks.length > 0 ? 20 : 100), overdueTasks.length > 0 ? '#f87171' : todayTasks.length > 0 ? '#fbbf24' : '#4ade80')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Úkoly dne</div>
                    <div class="mc-score-val">${todayTasks.length}</div>
                    <div class="mc-score-sub">${overdueTasks.length > 0 ? overdueTasks.length+' po termínu' : 'na program'}</div>
                </div>
            </div>
            <div class="mc-score-card">
                ${ring(jobDeadlinePct, jobDeadlinePct > 70 ? '#4ade80' : jobDeadlinePct > 30 ? '#fbbf24' : '#f87171')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Zakázky</div>
                    <div class="mc-score-val">${jobs.length}</div>
                    <div class="mc-score-sub">${jobsWithDeadline} s deadlinem</div>
                </div>
            </div>
            <div class="mc-score-card">
                ${ring(totalHours > 0 ? Math.min((totalHours/(activeEmps.length*8))*100, 100) : 0, '#60a5fa')}
                <div class="mc-score-info">
                    <div class="mc-score-label">Hodiny dnes</div>
                    <div class="mc-score-val">${totalHours}h</div>
                    <div class="mc-score-sub">${timesheets.length} výkazů</div>
                </div>
            </div>
        `;

        // ── Render Signals ──
        let sigs = '';
        if (overdueTasks.length > 0) {
            sigs += `<div class="mc-signal red signal-clickable" data-signal-type="overdue">
                ${sigIcon.fire}<span class="sig-text">Zpožděné úkoly po termínu</span><span class="sig-count">${overdueTasks.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderOverdueDetail(overdueTasks)}</div>
            </div>`;
        }
        if (urgentJobs.length > 0) {
            sigs += `<div class="mc-signal amber signal-clickable" data-signal-type="deadline">
                ${sigIcon.warn}<span class="sig-text">Zakázky s blížícím se deadlinem (7 dní)</span><span class="sig-count">${urgentJobs.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderDeadlineDetail(urgentJobs)}</div>
            </div>`;
        }
        if (isToday && idleEmps.length > 0 && activeEmps.length > 0) {
            sigs += `<div class="mc-signal amber signal-clickable" data-signal-type="no_timesheet">
                ${sigIcon.user}<span class="sig-text">Zaměstnanci bez výkazu dnes</span><span class="sig-count">${idleEmps.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderNoTimesheetDetail(idleEmps, employees)}</div>
            </div>`;
        }
        if (unassigned.length > 0) {
            sigs += `<div class="mc-signal blue signal-clickable" data-signal-type="unassigned">
                ${sigIcon.info}<span class="sig-text">Úkoly bez přiřazeného zaměstnance</span><span class="sig-count">${unassigned.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderUnassignedDetail(unassigned)}</div>
            </div>`;
        }
        if (noDateTasks.length > 0) {
            sigs += `<div class="mc-signal blue signal-clickable" data-signal-type="no_date">
                ${sigIcon.info}<span class="sig-text">Úkoly bez termínu</span><span class="sig-count">${noDateTasks.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderNoDateDetail(noDateTasks)}</div>
            </div>`;
        }
        if (sigs === '') {
            sigs = `<div class="mc-signal green">${sigIcon.ok}<span class="sig-text">Vše v pořádku — žádné kritické signály</span></div>`;
        }
        document.getElementById('mc-signals').innerHTML = sigs;
        
        // Attach accordion handlers
        document.querySelectorAll('.signal-clickable').forEach(card => {
            card.addEventListener('click', function(e) {
                // Pokud klik přišel z detailu nebo z action button/date input, nic nedělej
                if (e.target.closest('.signal-detail') || e.target.closest('.signal-action-btn') || e.target.closest('input[type="date"]')) {
                    return; // Don't toggle accordion when clicking inside detail
                }
                const detail = this.querySelector('.signal-detail');
                const arrow = this.querySelector('.signal-arrow');
                if (detail && arrow) {
                    if (detail.style.maxHeight) {
                        detail.style.maxHeight = null;
                        arrow.textContent = '▼';
                    } else {
                        detail.style.maxHeight = detail.scrollHeight + 'px';
                        arrow.textContent = '▲';
                    }
                }
            });
        });
        
        // Přidej stopPropagation přímo na detail elementy pro jistotu
        document.querySelectorAll('.signal-detail').forEach(detail => {
            detail.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        
        // Přidej click handler na signal-item pro otevření task modalu
        document.querySelectorAll('.signal-item[data-task-id]').forEach(item => {
            item.addEventListener('click', function(e) {
                // Ignoruj klik na tlačítko nebo input
                if (e.target.closest('button') || e.target.closest('input')) return;
                
                const taskId = parseInt(this.dataset.taskId);
                if (taskId) {
                    openTaskModal(taskId);
                }
            });
        });

        // ── Render Team (Day Plans) ──
        renderPlanGrid(dayPlans, employees, jobs);

        // ── Render Tasks ──
        // Combine: overdue + today + upcoming + no-date
        const allOpen = allTasksList.filter(t => t.status !== 'done' && t.status !== 'completed');
        allOpen.sort((a,b) => {
            // Priority: overdue first, then today, then by date, then no-date last
            const aKey = !a.due_date ? '9999' : (a.due_date < ds ? '0'+a.due_date : a.due_date);
            const bKey = !b.due_date ? '9999' : (b.due_date < ds ? '0'+b.due_date : b.due_date);
            return aKey.localeCompare(bKey);
        });

        document.getElementById('tasks-count').textContent = allOpen.length;
        if (allOpen.length === 0) {
            document.getElementById('mc-tasks').innerHTML = '<div class="mc-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Žádné otevřené úkoly</div>';
        } else {
            let tHtml = '';
            allOpen.slice(0, 20).forEach(t => {
                const isOverdue = t.due_date && t.due_date < ds;
                const isToday = t.due_date === ds;
                const hasDate = !!t.due_date;
                const badgeClass = isOverdue ? 'overdue' : (isToday ? 'today' : (hasDate ? 'upcoming' : 'nodate'));
                const badgeText = isOverdue ? 'Po termínu' : (isToday ? 'Dnes' : (hasDate ? new Date(t.due_date).toLocaleDateString('cs-CZ',{day:'numeric',month:'numeric'}) : 'Bez termínu'));
                const pri = t.priority || (isOverdue ? 'high' : 'none');
                const emp = t.employee_name || t.assigned_employee;

                tHtml += `<div class="mc-task" draggable="true" data-task-id="${t.id}" data-emp-id="${t.employee_id || ''}" data-status="${t.status}" data-priority="${t.priority || 'none'}" onclick="openTaskModal(${t.id})">
                    <div class="mc-task-pri ${pri}"></div>
                    <div class="mc-task-body">
                        <div class="mc-task-title">${esc(t.title)}</div>
                        <div class="mc-task-meta">
                            <span class="mc-task-badge ${badgeClass}">${badgeText}</span>
                            ${t.job_name ? '<span>'+esc(t.job_name)+'</span>' : ''}
                            ${emp ? '<span>→ '+esc(emp)+'</span>' : ''}
                        </div>
                    </div>
                </div>`;
            });
            if (allOpen.length > 20) tHtml += `<div class="mc-empty">…a dalších ${allOpen.length - 20} úkolů</div>`;
            document.getElementById('mc-tasks').innerHTML = tHtml;
        }

        // Naplň filtr zaměstnanců
        const empFilter = document.getElementById('filter-employee');
        if (empFilter && empFilter.options.length <= 1) {
            employees.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.name;
                empFilter.appendChild(opt);
            });
        }

        // ── Render Jobs ──
        // Načti costs data pro budget riziko
        let costsData = null;
        try {
            const costsResp = await api('/api/planning/costs');
            if (costsResp && costsResp.success && costsResp.projects) {
                costsData = costsResp.projects;
                // Přiřaď budget/spent k jobs
                costsData.forEach(p => {
                    const job = jobs.find(j => j.id === p.id);
                    if (job) {
                        job.budget = p.budget;
                        job.spent = p.spent;
                        job.percent_used = p.percent_used;
                    }
                });
            }
        } catch (e) {
            console.warn('Could not load costs data:', e);
        }

        // Přidej riziko ke každé zakázce a seřaď podle rizika
        const todayForRisk = new Date();
        todayForRisk.setHours(0, 0, 0, 0);
        
        const jobsWithRisk = jobs.map(job => ({
            ...job,
            riskData: calculateJobRisk(job, allTasksList, todayForRisk)
        }));
        
        // Seřaď sestupně podle rizika
        jobsWithRisk.sort((a, b) => b.riskData.risk - a.riskData.risk);

        document.getElementById('jobs-count').textContent = jobsWithRisk.length;
        if (jobsWithRisk.length === 0) {
            document.getElementById('mc-jobs').innerHTML = '<div class="mc-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>Žádné aktivní zakázky</div>';
        } else {
            let jHtml = '';
            jobsWithRisk.forEach(j => {
                const progress = j.progress || j.completion_percent || 0;
                const statusClass = (j.status === 'Probíhá') ? 'active' : 'plan';
                const deadlineStr = j.deadline ? new Date(j.deadline).toLocaleDateString('cs-CZ',{day:'numeric',month:'numeric',year:'numeric'}) : 'Bez deadlinu';
                const isUrgent = j.deadline && ((new Date(j.deadline) - curDate) / 864e5) <= 7 && ((new Date(j.deadline) - curDate) / 864e5) >= 0;
                const barColor = isUrgent ? 'var(--mc-amb)' : progress > 70 ? 'var(--mc-grn)' : 'var(--mc-blu)';
                const risk = j.riskData;

                jHtml += `<div class="mc-job" data-job-id="${j.id}" onclick="location.href='/job-detail.html?id=${j.id}'">
                    <div class="job-card-badges">
                        <span class="mc-job-status ${statusClass}">${esc(j.status)}</span>
                        ${risk.risk > 0 ? `<div class="risk-badge" style="background:${risk.color}20;color:${risk.color};border:1px solid ${risk.color}40">
                            <svg style="width:10px;height:10px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            ${risk.level} (${risk.risk})
                        </div>` : ''}
                    </div>
                    <div class="mc-job-hdr">
                        <div class="mc-job-name">${esc(j.name)}</div>
                    </div>
                    <div class="mc-job-meta">
                        ${j.code ? '<span>Kód: '+esc(j.code)+'</span>' : ''}
                        <span style="${isUrgent ? 'color:var(--mc-amb);font-weight:700' : ''}">Deadline: ${deadlineStr}</span>
                        ${j.client ? '<span>'+esc(j.client)+'</span>' : ''}
                    </div>
                    <div class="mc-job-progress" style="position:relative;">
                        <div class="progress-fill mc-job-progress-bar" style="width:${progress}%;background:${barColor}"></div>
                        <span class="progress-text" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--mc-t2);">${progress}%</span>
                    </div>
                    ${risk.reasons.length > 0 ? `<div class="risk-reasons">
                        ${risk.reasons.map(r => 
                            `<span class="risk-tag" style="border-color:${risk.color}40;color:${risk.color}">${esc(r)}</span>`
                        ).join('')}
                    </div>` : ''}
                </div>`;
            });
            document.getElementById('mc-jobs').innerHTML = jHtml;
        }

        // ── Render Suggestions ──
        const allSuggestions = [];
        if (suggest?.suggestions) {
            suggest.suggestions.forEach(s => allSuggestions.push(s));
        }
        if (notif?.notifications) {
            notif.notifications.forEach(n => {
                if (n.type !== 'warning') allSuggestions.push({ title: n.title, description: n.message, link: n.link });
            });
        }

        // Add computed suggestions
        if (jobs.filter(j => !j.deadline).length > 0) {
            allSuggestions.push({ title: `${jobs.filter(j=>!j.deadline).length} zakázek bez deadlinu`, description: 'Nastav termíny pro lepší plánování a přehled.', link: '/jobs.html' });
        }
        if (noDateTasks.length > 3) {
            allSuggestions.push({ title: `${noDateTasks.length} úkolů bez data`, description: 'Přiřaď termíny úkolům pro efektivní plánování dne.', link: '/tasks.html' });
        }

        document.getElementById('suggest-count').textContent = allSuggestions.length;
        if (allSuggestions.length === 0) {
            document.getElementById('mc-suggest').innerHTML = '<div class="mc-empty">Žádná doporučení</div>';
        } else {
            document.getElementById('mc-suggest').innerHTML = allSuggestions.map(s => `
                <div class="mc-suggest" ${s.link ? 'onclick="location.href=\''+s.link+'\'" style="cursor:pointer"' : ''}>
                    <div class="mc-suggest-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></div>
                    <div class="mc-suggest-body">
                        <div class="mc-suggest-title">${esc(s.title)}</div>
                        <div class="mc-suggest-desc">${esc(s.description)}</div>
                    </div>
                </div>`).join('');
        }
    }

    return {
        go(offset) {
            if (offset === 0) { curDate = new Date(); curDate.setHours(0,0,0,0); }
            else curDate.setDate(curDate.getDate() + offset);
            load();
        },
        goToDate(dateStr) {
            if (!dateStr) return;
            const parts = dateStr.split('-');
            curDate = new Date(parts[0], parts[1]-1, parts[2]);
            curDate.setHours(0,0,0,0);
            load();
        },
        init() { load(); }
    };
    })();

    MC.init();

    // ═══════════════════════════════════════
    // DAY PLANNING SYSTEM
    // ═══════════════════════════════════════

    // ── Render plánovacího gridu ──
    function renderPlanGrid(plans, employees, jobs) {
        _dayPlans = plans;
        _activeJobs = jobs;
        
        const container = document.getElementById('mc-team-grid');
        const plannedEmps = new Set(plans.map(p => p.employee_id));
        
        document.getElementById('team-count').textContent = plannedEmps.size;
        
        if (plans.length === 0) {
            container.innerHTML = `<div class="mc-plan-empty">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
                <div style="margin-top:8px">Nikdo zatím není naplánovaný</div>
                <div style="font-size:12px; margin-top:4px">Klikni "+ Přiřadit" pro přidání zaměstnanců</div>
            </div>`;
            document.getElementById('confirm-section').style.display = 'none';
            return;
        }
        
        const statusLabels = {
            planned: 'Plán', confirmed: 'Potvrzeno', absent: 'Absence',
            sick: 'Nemoc', vacation: 'Dovolená', uncertain: 'Nejistý'
        };
        
        let html = `<div class="mc-plan-grid">
            <div class="mc-plan-header">
                <span>Zaměstnanec</span><span>Zakázka</span><span>Hodiny</span><span>Status</span><span></span>
            </div>`;
        
        plans.forEach(p => {
            const initials = (p.employee_name||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
            const jobText = p.job_name ? (p.job_code ? '['+p.job_code+'] ' : '') + p.job_name : '— Bez zakázky —';
            const statusClass = p.status || 'planned';
            const hrs = p.actual_hours != null ? p.actual_hours : p.planned_hours;
            
            html += `<div class="mc-plan-row status-${statusClass}" data-plan-id="${p.id}">
                <div class="mc-plan-emp">
                    <div class="mc-plan-avatar">${initials}</div>
                    <span class="mc-plan-emp-name">${esc(p.employee_name)}</span>
                </div>
                <div class="mc-plan-job">${esc(jobText)}</div>
                <div class="mc-plan-hours">${hrs}h</div>
                <div>
                    <select class="mc-plan-status-select" onchange="updatePlanStatus(${p.id}, this.value)">
                        ${Object.entries(statusLabels).map(([k,v]) => 
                            `<option value="${k}" ${p.status===k?'selected':''}>${v}</option>`
                        ).join('')}
                    </select>
                </div>
                <button class="mc-plan-delete" onclick="deletePlan(${p.id})" title="Smazat">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>`;
        });
        
        html += '</div>';
        
        const hasUnconfirmed = plans.some(p => p.status === 'planned' || p.status === 'uncertain');
        if (hasUnconfirmed) {
            html += `<button class="mc-btn-show-confirm" onclick="showConfirmSection()">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px; margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                Potvrzení dne — vyplnit skutečné hodiny
            </button>`;
        }
        
        container.innerHTML = html;
    }

    // ── Potvrzení dne ──
    function showConfirmSection() {
        const section = document.getElementById('confirm-section');
        section.style.display = '';
        
        const unconfirmed = _dayPlans.filter(p => p.status === 'planned' || p.status === 'uncertain');
        
        let html = `<div class="mc-confirm-header">
            <span>Zaměstnanec</span><span>Zakázka</span><span>Plán</span><span>Skutečnost</span><span>Poznámka</span>
        </div>`;
        
        unconfirmed.forEach(p => {
            const jobText = p.job_name || '— Bez zakázky —';
            html += `<div class="mc-confirm-row" data-plan-id="${p.id}">
                <div style="font-weight:600; color:var(--mc-t1)">${esc(p.employee_name)}</div>
                <div style="color:var(--mc-t2); font-size:13px">${esc(jobText)}</div>
                <div style="text-align:center; color:var(--mc-t3)">${p.planned_hours}h</div>
                <input type="number" class="actual-input" value="${p.planned_hours}" min="0" max="24" step="0.5" data-plan-id="${p.id}">
                <input type="text" class="note-input" placeholder="Poznámka..." value="${p.note || ''}" data-plan-id="${p.id}">
            </div>`;
        });
        
        document.getElementById('mc-confirm-list').innerHTML = html;
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function confirmAllPlans() {
        const rows = document.querySelectorAll('.mc-confirm-row');
        const confirmations = [];
        
        rows.forEach(row => {
            const planId = row.dataset.planId;
            const actualInput = row.querySelector('.actual-input');
            const noteInput = row.querySelector('.note-input');
            
            confirmations.push({
                id: parseInt(planId),
                actual_hours: parseFloat(actualInput.value) || 0,
                note: noteInput.value || '',
                status: 'confirmed'
            });
        });
        
        if (confirmations.length === 0) return;
        
        try {
            const res = await fetch('/api/planning/day-plans/confirm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ confirmations })
            });
            const data = await res.json();
            
            if (data.success) {
                document.getElementById('confirm-section').style.display = 'none';
                MC.init();
                const btn = document.querySelector('.mc-btn-confirm');
                if (btn) {
                    const orig = btn.textContent;
                    btn.textContent = '✓ Výkazy vytvořeny (' + data.created_timesheets + ')';
                    btn.style.background = 'var(--mc-grn)';
                    setTimeout(() => { btn.textContent = orig; }, 3000);
                }
            } else {
                alert('Chyba: ' + (data.error || 'Neznámá chyba'));
            }
        } catch (err) {
            console.error('Confirm error:', err);
            alert('Chyba při potvrzování');
        }
    }

    // ── Rychlá změna statusu ──
    async function updatePlanStatus(planId, newStatus) {
        try {
            await fetch('/api/planning/day-plans/' + planId, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: newStatus })
            });
            MC.init();
        } catch (err) {
            console.error('Status update error:', err);
        }
    }

    // ── Smazat plán ──
    async function deletePlan(planId) {
        if (!confirm('Smazat toto přiřazení?')) return;
        try {
            await fetch('/api/planning/day-plans/' + planId, { method: 'DELETE' });
            MC.init();
        } catch (err) {
            console.error('Delete error:', err);
        }
    }

    // ── Kopírovat včerejšek ──
    async function copyPreviousDay() {
        const ds = ymd(curDate);
        const yesterday = new Date(curDate);
        yesterday.setDate(yesterday.getDate() - 1);
        const ys = ymd(yesterday);
        
        if (!confirm(`Zkopírovat plány z ${yesterday.toLocaleDateString('cs-CZ')} na ${curDate.toLocaleDateString('cs-CZ')}?`)) return;
        
        try {
            const res = await fetch('/api/planning/day-plans/copy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ from_date: ys, to_date: ds })
            });
            const data = await res.json();
            if (data.success) {
                MC.init();
            } else {
                alert('Chyba: ' + (data.error || ''));
            }
        } catch (err) {
            console.error('Copy error:', err);
        }
    }

    // ── Plan Modal ──
    function openPlanModal(planId) {
        const overlay = document.getElementById('planModalOverlay');
        const empSelect = document.getElementById('plan-employee');
        const jobSelect = document.getElementById('plan-job');
        
        empSelect.innerHTML = '';
        _cachedEmployees.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            empSelect.appendChild(opt);
        });
        
        jobSelect.innerHTML = '<option value="">— Bez zakázky —</option>';
        _activeJobs.forEach(j => {
            const opt = document.createElement('option');
            opt.value = j.id;
            opt.textContent = (j.code ? '['+j.code+'] ' : '') + j.name;
            jobSelect.appendChild(opt);
        });
        
        document.getElementById('plan-modal-id').value = planId || '';
        document.getElementById('plan-hours').value = 8;
        document.getElementById('plan-status').value = 'planned';
        document.getElementById('plan-note').value = '';
        
        if (planId) {
            const plan = _dayPlans.find(p => p.id === planId);
            if (plan) {
                empSelect.value = plan.employee_id;
                jobSelect.value = plan.job_id || '';
                document.getElementById('plan-hours').value = plan.planned_hours;
                document.getElementById('plan-status').value = plan.status;
                document.getElementById('plan-note').value = plan.note || '';
            }
        }
        
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closePlanModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('planModalOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    async function savePlan() {
        const planId = document.getElementById('plan-modal-id').value;
        const data = {
            date: ymd(curDate),
            employee_id: parseInt(document.getElementById('plan-employee').value),
            job_id: document.getElementById('plan-job').value ? parseInt(document.getElementById('plan-job').value) : null,
            planned_hours: parseFloat(document.getElementById('plan-hours').value) || 8,
            status: document.getElementById('plan-status').value,
            note: document.getElementById('plan-note').value
        };
        
        try {
            let url = '/api/planning/day-plans';
            let method = 'POST';
            
            if (planId) {
                url += '/' + planId;
                method = 'PATCH';
            }
            
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closePlanModal();
                MC.init();
            } else {
                const err = await res.json();
                alert('Chyba: ' + (err.error || 'Neznámá chyba'));
            }
        } catch (err) {
            console.error('Save plan error:', err);
        }
    }

    // ── Funkce pro filtry ──
    function applyTaskFilters() {
        const empVal = document.getElementById('filter-employee').value;
        const statusVal = document.getElementById('filter-status').value;
        const priVal = document.getElementById('filter-priority').value;
        
        document.querySelectorAll('.mc-task[data-task-id]').forEach(el => {
            let show = true;
            if (empVal && el.dataset.empId !== empVal) show = false;
            if (statusVal && el.dataset.status !== statusVal) show = false;
            if (priVal && el.dataset.priority !== priVal) show = false;
            el.style.display = show ? '' : 'none';
        });
    }

    // ── Drag & Drop ──
    document.addEventListener('dragstart', (e) => {
        const taskEl = e.target.closest('.mc-task[data-task-id]');
        if (!taskEl) return;
        draggedTaskId = taskEl.dataset.taskId;
        taskEl.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedTaskId);
    });

    document.addEventListener('dragend', (e) => {
        const taskEl = e.target.closest('.mc-task');
        if (taskEl) taskEl.classList.remove('dragging');
        document.querySelectorAll('.drag-over, .drop-target').forEach(el => {
            el.classList.remove('drag-over', 'drop-target');
        });
        draggedTaskId = null;
    });

    document.addEventListener('dragover', (e) => {
        const empRow = e.target.closest('.mc-team-row[data-emp-id]');
        if (empRow && draggedTaskId) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            empRow.classList.add('drop-target');
        }
    });

    document.addEventListener('dragleave', (e) => {
        const empRow = e.target.closest('.mc-team-row[data-emp-id]');
        if (empRow) empRow.classList.remove('drop-target');
    });

    document.addEventListener('drop', async (e) => {
        e.preventDefault();
        const empRow = e.target.closest('.mc-team-row[data-emp-id]');
        if (!empRow || !draggedTaskId) return;
        empRow.classList.remove('drop-target');
        
        const employeeId = empRow.dataset.empId;
        if (!employeeId) return;
        
        try {
            const res = await fetch('/api/tasks', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: parseInt(draggedTaskId), employee_id: parseInt(employeeId) })
            });
            if (res.ok) {
                MC.init();
            } else {
                console.error('Chyba při přeřazení úkolu');
            }
        } catch (err) {
            console.error('Drop error:', err);
        }
    });

    // ── Modal funkce ──
    async function openTaskModal(taskId) {
        const overlay = document.getElementById('taskModalOverlay');
        
        let task = _cachedTasks.find(t => t.id === taskId);
        if (!task) {
            try {
                const res = await fetch('/api/tasks?id=' + taskId);
                const data = await res.json();
                task = data.task || data;
            } catch (e) {
                console.error('Chyba načítání úkolu:', e);
                return;
            }
        }
        
        document.getElementById('modal-task-id').value = task.id;
        document.getElementById('modal-task-title').value = task.title || '';
        document.getElementById('modal-task-status').value = task.status || 'todo';
        document.getElementById('modal-task-priority').value = task.priority || 'medium';
        document.getElementById('modal-task-date').value = task.due_date || '';
        document.getElementById('modal-task-desc').value = task.description || '';
        
        const empSelect = document.getElementById('modal-task-employee');
        empSelect.innerHTML = '<option value="">Nepřiřazeno</option>';
        _cachedEmployees.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            if (e.id == task.employee_id) opt.selected = true;
            empSelect.appendChild(opt);
        });
        
        const jobInfo = document.getElementById('modal-task-job-info');
        const jobName = document.getElementById('modal-task-job-name');
        if (task.job_name || task.job_code) {
            jobInfo.style.display = '';
            jobName.textContent = (task.job_code ? '[' + task.job_code + '] ' : '') + (task.job_name || '');
        } else {
            jobInfo.style.display = 'none';
        }
        
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeTaskModal(e) {
        if (e && e.target !== e.currentTarget) return;
        const overlay = document.getElementById('taskModalOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    async function saveTaskModal() {
        const id = document.getElementById('modal-task-id').value;
        const oldTask = _cachedTasks.find(t => t.id == id);
        const oldStatus = oldTask?.status;
        const oldEmployeeId = oldTask?.employee_id;
        
        const data = {
            id: parseInt(id),
            title: document.getElementById('modal-task-title').value.trim(),
            status: document.getElementById('modal-task-status').value,
            priority: document.getElementById('modal-task-priority').value,
            employee_id: document.getElementById('modal-task-employee').value ? parseInt(document.getElementById('modal-task-employee').value) : null,
            due_date: document.getElementById('modal-task-date').value || null,
            description: document.getElementById('modal-task-desc').value.trim()
        };
        
        try {
            const res = await fetch('/api/tasks', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeTaskModal();
                // Real-time refresh místo MC.init()
                await refreshAfterChange(parseInt(id), {
                    status: data.status !== oldStatus ? data.status : null,
                    employee_id: data.employee_id !== oldEmployeeId ? data.employee_id : null
                });
            } else {
                const err = await res.json();
                alert('Chyba při ukládání: ' + (err.error || 'Neznámá chyba'));
            }
        } catch (err) {
            console.error('Save error:', err);
            alert('Chyba při ukládání úkolu');
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeTaskModal();
    });

    // ═══════════════════════════════════════
    // REAL-TIME REFRESH FUNCTIONS
    // ═══════════════════════════════════════

    async function refreshAfterChange(taskId, changes) {
        // 1. Načti čerstvá data
        const ds = ymd(curDate);
        const [dailyRes, jobsRes, tasksRes, timesheetsRes] = await Promise.all([
            api('/api/planning/daily/'+ds),
            api('/api/jobs'),
            api('/api/tasks'),
            api('/api/timesheets')
        ]);
        
        const jobs = jobsRes?.jobs || jobsRes || [];
        const tasks = tasksRes?.tasks || tasksRes || [];
        const timesheets = timesheetsRes?.timesheets || timesheetsRes || [];
        const daily = dailyRes || {};
        
        // Aktualizuj globální reference
        window._jobs = jobs;
        window._tasks = tasks;
        window._timesheets = timesheets;
        
        // 2. Přepočítej a aktualizuj všechny sekce
        animateMissionScore(tasks, jobs);
        updateSignals(tasks, jobs, daily, ds);
        updateJobRisk(taskId, tasks, jobs);
        updateJobProgress(taskId, tasks, jobs);
        renderTrajectory({
            tasks: tasks,
            jobs: jobs,
            employees: window._employees,
            timesheets: timesheets
        });
        
        // Aktualizuj seznam úkolů
        updateTasksList(tasks, ds);
        
        // 3. Zobraz toast
        const task = tasks.find(t => t.id == taskId);
        const job = task ? jobs.find(j => j.id == task.job_id) : null;
        showToast(task, job, changes);
    }

    function animateMissionScore(tasks, jobs) {
        // Přepočítej score
        let score = 100;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const overdueTasks = tasks.filter(t => {
            if (t.status === 'done' || t.status === 'completed') return false;
            if (!t.due_date) return false;
            const dueDate = new Date(t.due_date);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
        });
        score -= overdueTasks.length * 10;
        
        const noDeadlineJobs = jobs.filter(j =>
            (j.status === 'Plán' || j.status === 'Probíhá') && !j.deadline
        );
        score -= noDeadlineJobs.length * 5;
        
        const atRiskJobs = jobs.filter(j => {
            if (!j.deadline || j.status === 'Dokončeno' || j.status === 'completed') return false;
            const deadline = new Date(j.deadline);
            deadline.setHours(0, 0, 0, 0);
            const daysLeft = (deadline - today) / 86400000;
            const progress = j.completion_percentage || j.progress || 0;
            return daysLeft < 7 && daysLeft >= 0 && progress < 50;
        });
        score -= atRiskJobs.length * 15;
        
        const unassigned = tasks.filter(t =>
            t.status !== 'done' && t.status !== 'completed' && !t.employee_id
        );
        score -= unassigned.length * 3;
        
        score = Math.max(0, score);
        
        const valueEl = document.getElementById('scoreValue');
        if (!valueEl) return;
        
        const oldScore = parseInt(valueEl.textContent) || 0;
        
        // Animace počítání
        const duration = 800;
        const start = performance.now();
        
        function tick(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const current = Math.round(oldScore + (score - oldScore) * eased);
            valueEl.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(tick);
            } else {
                // Po dokončení animace zavolej renderMissionScore pro kompletní aktualizaci
                let label, color;
                if (score >= 90) { label = 'Mise běží hladce'; color = '#4ade80'; }
                else if (score >= 70) { label = 'Drobné odchylky v trajektorii'; color = '#fbbf24'; }
                else if (score >= 50) { label = 'Vyžaduje pozornost'; color = '#f97316'; }
                else { label = 'Kritický stav mise'; color = '#f87171'; }
                
                const penalties = [];
                if (overdueTasks.length > 0) penalties.push(`${overdueTasks.length}× zpožděný úkol`);
                if (noDeadlineJobs.length > 0) penalties.push(`${noDeadlineJobs.length}× zakázka bez deadline`);
                if (atRiskJobs.length > 0) penalties.push(`${atRiskJobs.length}× ohrožená zakázka`);
                if (unassigned.length > 0) penalties.push(`${unassigned.length}× nepřiřazený úkol`);
                
                renderMissionScore(score, label, color, penalties);
            }
        }
        
        // Flash efekt
        valueEl.style.transition = 'color 0.3s, transform 0.3s';
        valueEl.style.color = score > oldScore ? '#4ade80' : '#f87171';
        valueEl.style.transform = 'scale(1.2)';
        
        setTimeout(() => {
            valueEl.style.transform = 'scale(1)';
        }, 1000);
        
        requestAnimationFrame(tick);
    }

    function updateSignals(tasks, jobs, daily, ds) {
        // Znovu vypočítej signály (stejná logika jako v MC.init())
        const overdueTasks = tasks.filter(t => t.due_date && t.due_date < ds && t.status !== 'done' && t.status !== 'completed');
        const todayTasks = tasks.filter(t => t.due_date === ds && t.status !== 'done');
        const unassigned = tasks.filter(t => !t.employee_id && t.status !== 'done' && t.status !== 'completed');
        const noDateTasks = tasks.filter(t => !t.due_date && t.status !== 'done' && t.status !== 'completed');
        const activeEmps = window._employees.filter(e => e.status === 'active' || !e.status);
        
        const urgentJobs = jobs.filter(j => {
            if (!j.deadline) return false;
            const dl = new Date(j.deadline);
            const diff = (dl - new Date(ds)) / 864e5;
            return diff >= 0 && diff <= 7;
        });
        
        const isToday = ymd(curDate) === ymd(today);
        const dayPlans = daily?.day_plans || [];
        const plannedEmps = new Set(dayPlans.filter(p => p.status !== 'absent' && p.status !== 'vacation').map(p => p.employee_id));
        const idleEmps = activeEmps.filter(e => !plannedEmps.has(e.id));
        
        // Render signály (stejná logika jako v MC.init())
        const sigIcon = {
            fire: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 003.5 2.5z"/></svg>',
            warn: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            user: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
            ok: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>'
        };
        
        let sigs = '';
        if (overdueTasks.length > 0) {
            sigs += `<div class="mc-signal red signal-clickable" data-signal-type="overdue">
                ${sigIcon.fire}<span class="sig-text">Zpožděné úkoly po termínu</span><span class="sig-count">${overdueTasks.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderOverdueDetail(overdueTasks)}</div>
            </div>`;
        }
        if (urgentJobs.length > 0) {
            sigs += `<div class="mc-signal amber signal-clickable" data-signal-type="deadline">
                ${sigIcon.warn}<span class="sig-text">Zakázky s blížícím se deadlinem (7 dní)</span><span class="sig-count">${urgentJobs.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderDeadlineDetail(urgentJobs)}</div>
            </div>`;
        }
        if (isToday && idleEmps.length > 0 && activeEmps.length > 0) {
            sigs += `<div class="mc-signal amber signal-clickable" data-signal-type="no_timesheet">
                ${sigIcon.user}<span class="sig-text">Zaměstnanci bez výkazu dnes</span><span class="sig-count">${idleEmps.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderNoTimesheetDetail(idleEmps, window._employees)}</div>
            </div>`;
        }
        if (unassigned.length > 0) {
            sigs += `<div class="mc-signal blue signal-clickable" data-signal-type="unassigned">
                ${sigIcon.info}<span class="sig-text">Úkoly bez přiřazeného zaměstnance</span><span class="sig-count">${unassigned.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderUnassignedDetail(unassigned)}</div>
            </div>`;
        }
        if (noDateTasks.length > 0) {
            sigs += `<div class="mc-signal blue signal-clickable" data-signal-type="no_date">
                ${sigIcon.info}<span class="sig-text">Úkoly bez termínu</span><span class="sig-count">${noDateTasks.length}</span>
                <span class="signal-arrow">▼</span>
                <div class="signal-detail">${renderNoDateDetail(noDateTasks)}</div>
            </div>`;
        }
        if (sigs === '') {
            sigs = `<div class="mc-signal green">${sigIcon.ok}<span class="sig-text">Vše v pořádku — žádné kritické signály</span></div>`;
        }
        
        document.getElementById('mc-signals').innerHTML = sigs;
        
        // Attach accordion handlers (stejná logika jako v MC.init())
        document.querySelectorAll('.signal-clickable').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.closest('.signal-detail') || e.target.closest('.signal-action-btn') || e.target.closest('input[type="date"]')) {
                    return;
                }
                const detail = this.querySelector('.signal-detail');
                const arrow = this.querySelector('.signal-arrow');
                if (detail && arrow) {
                    if (detail.style.maxHeight) {
                        detail.style.maxHeight = null;
                        arrow.textContent = '▼';
                    } else {
                        detail.style.maxHeight = detail.scrollHeight + 'px';
                        arrow.textContent = '▲';
                    }
                }
            });
        });
        
        document.querySelectorAll('.signal-detail').forEach(detail => {
            detail.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        
        document.querySelectorAll('.signal-item[data-task-id]').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.closest('button') || e.target.closest('input')) return;
                const taskId = parseInt(this.dataset.taskId);
                if (taskId) {
                    openTaskModal(taskId);
                }
            });
        });
        
        // Animace — blikni sekci signálů
        const signalsSection = document.getElementById('mc-signals');
        if (signalsSection) {
            signalsSection.style.transition = 'opacity 0.3s';
            signalsSection.style.opacity = '0.5';
            setTimeout(() => { signalsSection.style.opacity = '1'; }, 300);
        }
    }

    function updateJobRisk(taskId, tasks, jobs) {
        const task = tasks.find(t => t.id == taskId);
        if (!task || !task.job_id) return;
        
        const job = jobs.find(j => j.id == task.job_id);
        if (!job) return;
        
        // Najdi kartu zakázky v DOM
        let jobCard = document.querySelector(`[data-job-id="${job.id}"]`);
        if (!jobCard) {
            // Pokud karta neexistuje, možná ještě není renderovaná, zkus najít podle onclick
            const allCards = document.querySelectorAll('.mc-job');
            for (const card of allCards) {
                const onclick = card.getAttribute('onclick');
                if (onclick && onclick.includes(`id=${job.id}`)) {
                    jobCard = card;
                    break;
                }
            }
        }
        if (!jobCard) return;
        
        // Přepočítej riziko
        const todayForRisk = new Date();
        todayForRisk.setHours(0, 0, 0, 0);
        const riskScore = calculateJobRisk(job, tasks, todayForRisk);
        
        // Aktualizuj risk badge
        const riskBadge = jobCard.querySelector('.risk-badge');
        if (riskBadge) {
            const oldText = riskBadge.textContent;
            riskBadge.innerHTML = `
                <svg style="width:10px;height:10px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                ${riskScore.level} (${riskScore.risk})
            `;
            riskBadge.style.background = riskScore.color + '20';
            riskBadge.style.color = riskScore.color;
            riskBadge.style.border = '1px solid ' + riskScore.color + '40';
            
            // Animace pokud se změnilo
            if (oldText !== riskBadge.textContent) {
                riskBadge.style.animation = 'pulse 0.5s ease';
                setTimeout(() => { riskBadge.style.animation = ''; }, 500);
            }
        }
    }

    function updateJobProgress(taskId, tasks, jobs) {
        const task = tasks.find(t => t.id == taskId);
        if (!task || !task.job_id) return;
        
        const job = jobs.find(j => j.id == task.job_id);
        if (!job) return;
        
        let jobCard = document.querySelector(`[data-job-id="${job.id}"]`);
        if (!jobCard) {
            const allCards = document.querySelectorAll('.mc-job');
            for (const card of allCards) {
                const onclick = card.getAttribute('onclick');
                if (onclick && onclick.includes(`id=${job.id}`)) {
                    jobCard = card;
                    break;
                }
            }
        }
        if (!jobCard) return;
        
        // Přepočítej progress
        const jobTasks = tasks.filter(t => t.job_id == job.id);
        const done = jobTasks.filter(t => ['done', 'completed', 'dokončeno'].includes((t.status || '').toLowerCase())).length;
        const total = jobTasks.length;
        const pct = total > 0 ? Math.round((done / total) * 100) : 0;
        
        // Aktualizuj progress bar
        const progressBar = jobCard.querySelector('.mc-job-progress-bar');
        if (progressBar) {
            progressBar.style.transition = 'width 0.8s ease';
            progressBar.style.width = pct + '%';
        }
    }

    function updateTasksList(tasks, ds) {
        const allOpen = tasks.filter(t => t.status !== 'done' && t.status !== 'completed');
        allOpen.sort((a,b) => {
            const aKey = !a.due_date ? '9999' : (a.due_date < ds ? '0'+a.due_date : a.due_date);
            const bKey = !b.due_date ? '9999' : (b.due_date < ds ? '0'+b.due_date : b.due_date);
            return aKey.localeCompare(bKey);
        });

        document.getElementById('tasks-count').textContent = allOpen.length;
        if (allOpen.length === 0) {
            document.getElementById('mc-tasks').innerHTML = '<div class="mc-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Žádné otevřené úkoly</div>';
        } else {
            let tHtml = '';
            allOpen.slice(0, 20).forEach(t => {
                const isOverdue = t.due_date && t.due_date < ds;
                const isToday = t.due_date === ds;
                const hasDate = !!t.due_date;
                const badgeClass = isOverdue ? 'overdue' : (isToday ? 'today' : (hasDate ? 'upcoming' : 'nodate'));
                const badgeText = isOverdue ? 'Po termínu' : (isToday ? 'Dnes' : (hasDate ? new Date(t.due_date).toLocaleDateString('cs-CZ',{day:'numeric',month:'numeric'}) : 'Bez termínu'));
                const pri = t.priority || (isOverdue ? 'high' : 'none');
                const emp = t.employee_name || t.assigned_employee;

                tHtml += `<div class="mc-task" draggable="true" data-task-id="${t.id}" data-emp-id="${t.employee_id || ''}" data-status="${t.status}" data-priority="${t.priority || 'none'}" onclick="openTaskModal(${t.id})">
                    <div class="mc-task-pri ${pri}"></div>
                    <div class="mc-task-body">
                        <div class="mc-task-title">${esc(t.title)}</div>
                        <div class="mc-task-meta">
                            <span class="mc-task-badge ${badgeClass}">${badgeText}</span>
                            ${t.job_name ? '<span>'+esc(t.job_name)+'</span>' : ''}
                            ${emp ? '<span>→ '+esc(emp)+'</span>' : ''}
                        </div>
                    </div>
                </div>`;
            });
            if (allOpen.length > 20) tHtml += `<div class="mc-empty">…a dalších ${allOpen.length - 20} úkolů</div>`;
            document.getElementById('mc-tasks').innerHTML = tHtml;
        }
    }

    function showToast(task, job, changes) {
        // Odstraň předchozí toast
        const old = document.querySelector('.mc-toast');
        if (old) old.remove();
        
        const taskName = task?.title || task?.name || 'Úkol';
        const jobName = job?.name || job?.title || '';
        
        let message = `${taskName}`;
        if (changes.status) {
            const statusMap = {
                'done': 'Dokončeno',
                'completed': 'Dokončeno',
                'progress': 'Probíhá',
                'open': 'Otevřené',
                'todo': 'K udělání'
            };
            message += ` → ${statusMap[changes.status] || changes.status}`;
        }
        if (jobName) message += ` | ${jobName}`;
        
        const toast = document.createElement('div');
        toast.className = 'mc-toast';
        toast.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
            <span>${esc(message)}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Animace
        requestAnimationFrame(() => {
            toast.style.transform = 'translateX(0)';
            toast.style.opacity = '1';
        });
        
        setTimeout(() => {
            toast.style.transform = 'translateX(120%)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // Auto-refresh každých 60 sekund
    let lastDataHash = '';
    setInterval(async () => {
        try {
            const [jobsRes, tasksRes] = await Promise.all([
                api('/api/jobs'),
                api('/api/tasks')
            ]);
            
            const jobs = jobsRes?.jobs || jobsRes || [];
            const tasks = tasksRes?.tasks || tasksRes || [];
            
            // Jednoduchý hash pro detekci změn
            const newHash = JSON.stringify(tasks.map(t => t.id + ':' + t.status + ':' + (t.updated_at || t.created_at))).slice(0, 200);
            
            if (lastDataHash && newHash !== lastDataHash) {
                // Data se změnila (někdo jiný udělal úpravu)
                console.log('Auto-refresh: detekována změna');
                const ds = ymd(curDate);
                const dailyRes = await api('/api/planning/daily/'+ds);
                animateMissionScore(tasks, jobs);
                updateSignals(tasks, jobs, dailyRes || {}, ds);
                renderTrajectory({
                    tasks: tasks,
                    jobs: jobs,
                    employees: window._employees,
                    timesheets: window._timesheets
                });
            }
            
            lastDataHash = newHash;
        } catch (e) {
            console.warn('Auto-refresh failed:', e);
        }
    }, 60000);
    </script>

    <!-- Task Modal -->
    <div class="task-modal-overlay" id="taskModalOverlay" onclick="closeTaskModal(event)">
        <div class="task-modal" onclick="event.stopPropagation()">
            <div class="task-modal-header">
                <span class="task-modal-title">Detail úkolu</span>
                <button class="task-modal-close" onclick="closeTaskModal()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="task-modal-body">
                <input type="hidden" id="modal-task-id">
                
                <div class="task-modal-field">
                    <label>Název</label>
                    <input type="text" id="modal-task-title" placeholder="Název úkolu">
                </div>
                
                <div class="task-modal-row">
                    <div class="task-modal-field">
                        <label>Stav</label>
                        <select id="modal-task-status">
                            <option value="todo">K udělání</option>
                            <option value="open">Otevřené</option>
                            <option value="progress">Probíhá</option>
                            <option value="done">Hotovo</option>
                            <option value="completed">Dokončeno</option>
                        </select>
                    </div>
                    <div class="task-modal-field">
                        <label>Priorita</label>
                        <select id="modal-task-priority">
                            <option value="low">Nízká</option>
                            <option value="medium">Střední</option>
                            <option value="high">Vysoká</option>
                            <option value="urgent">Urgentní</option>
                        </select>
                    </div>
                </div>
                
                <div class="task-modal-row">
                    <div class="task-modal-field">
                        <label>Zaměstnanec</label>
                        <select id="modal-task-employee">
                            <option value="">Nepřiřazeno</option>
                        </select>
                    </div>
                    <div class="task-modal-field">
                        <label>Termín</label>
                        <input type="date" id="modal-task-date">
                    </div>
                </div>
                
                <div class="task-modal-field">
                    <label>Popis</label>
                    <textarea id="modal-task-desc" rows="3" placeholder="Popis úkolu..."></textarea>
                </div>
                
                <div class="task-modal-field" id="modal-task-job-info" style="display:none">
                    <label>Zakázka</label>
                    <div id="modal-task-job-name" class="task-modal-info"></div>
                </div>
            </div>
            <div class="task-modal-footer">
                <button class="task-modal-btn cancel" onclick="closeTaskModal()">Zrušit</button>
                <button class="task-modal-btn save" onclick="saveTaskModal()">Uložit změny</button>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div class="plan-modal-overlay" id="planModalOverlay" onclick="closePlanModal(event)">
        <div class="plan-modal" onclick="event.stopPropagation()">
            <div class="plan-modal-header">
                <span>Přiřadit zaměstnance</span>
                <button class="plan-modal-close" onclick="closePlanModal()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="plan-modal-body">
                <input type="hidden" id="plan-modal-id">
                <div class="plan-modal-field">
                    <label>Zaměstnanec</label>
                    <select id="plan-employee"></select>
                </div>
                <div class="plan-modal-field">
                    <label>Zakázka</label>
                    <select id="plan-job">
                        <option value="">— Bez zakázky —</option>
                    </select>
                </div>
                <div class="plan-modal-row">
                    <div class="plan-modal-field">
                        <label>Plánované hodiny</label>
                        <input type="number" id="plan-hours" value="8" min="0" max="24" step="0.5">
                    </div>
                    <div class="plan-modal-field">
                        <label>Status</label>
                        <select id="plan-status">
                            <option value="planned">Plánováno</option>
                            <option value="uncertain">Nejistý</option>
                            <option value="sick">Nemoc</option>
                            <option value="vacation">Dovolená</option>
                            <option value="absent">Absence</option>
                        </select>
                    </div>
                </div>
                <div class="plan-modal-field">
                    <label>Poznámka</label>
                    <input type="text" id="plan-note" placeholder="Volitelná poznámka...">
                </div>
            </div>
            <div class="plan-modal-footer">
                <button class="plan-modal-btn cancel" onclick="closePlanModal()">Zrušit</button>
                <button class="plan-modal-btn save" onclick="savePlan()">Uložit</button>
            </div>
        </div>
    </div>
</body>
</html>
