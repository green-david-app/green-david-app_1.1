<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Sklad materi√°lu | Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <style>
        :root { --bg-primary: #0a0e11; --bg-card: #151a1e; --bg-elevated: #1a2027;
                --border-primary: #2d3439; --text-primary: #e8eef2; --text-secondary: #9ca8b3; --mint: #9FD4A1; }
        body { background: var(--bg-primary); color: var(--text-primary); margin: 0; }
        .container { padding: 20px; max-width: 1600px; margin: 0 auto; }
        
        .materials-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .material-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; 
                        padding: 20px; transition: all 0.2s; cursor: pointer; }
        .material-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .material-card.low-stock { border-left: 4px solid #ff6b6b; }
        .material-name { font-weight: 700; font-size: 18px; margin-bottom: 4px; }
        .material-category { font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; 
                           padding: 4px 8px; background: var(--bg-elevated); border-radius: 4px; display: inline-block; }
        .stock-bar { height: 8px; background: var(--border-primary); border-radius: 4px; overflow: hidden; margin: 12px 0; }
        .stock-fill { height: 100%; background: var(--mint); transition: width 0.3s; }
        .stock-fill.low { background: #ff6b6b; }
        
        button { padding: 10px 20px; background: var(--mint); color: #0a0e11; border: none; border-radius: 8px; 
                font-weight: 600; cursor: pointer; transition: all 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background: var(--bg-elevated); color: var(--text-primary); }
        button.danger { background: #ff6b6b; color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
                z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; }
        .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; background: var(--bg-primary); 
                                                border: 1px solid var(--border-primary); border-radius: 8px; 
                                                color: var(--text-primary); font-size: 14px; }
        .form-actions { display: flex; gap: 12px; margin-top: 24px; }
    </style>
</head>
<body>
    <header style="background: var(--bg-card); border-bottom: 1px solid var(--border-primary); padding: 16px 20px;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <a href="/" style="padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-primary); 
                             border-radius: 8px; text-decoration: none; color: var(--text-primary); font-weight: 600;">‚Üê Dom≈Ø</a>
            <h1 style="margin: 0; font-size: 20px; font-weight: 700;">üì¶ Sklad materi√°lu</h1>
            <button onclick="showAddMaterialModal()" style="margin-left: auto;">+ P≈ôidat materi√°l</button>
        </div>
    </header>

    <div class="container">
        <div class="materials-grid" id="materialsGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-secondary);">Naƒç√≠t√°m materi√°ly...</div>
        </div>
    </div>

    <!-- Add Material Modal -->
    <div class="modal" id="addMaterialModal">
        <div class="modal-content">
            <div class="modal-header">P≈ôidat materi√°l</div>
            <form onsubmit="submitMaterial(event)">
                <div class="form-group">
                    <label>N√°zev *</label>
                    <input type="text" id="name" required placeholder="Substr√°t univerz√°ln√≠">
                </div>
                <div class="form-group">
                    <label>Kategorie</label>
                    <select id="category">
                        <option value="substr√°t">Substr√°t</option>
                        <option value="hnojivo">Hnojivo</option>
                        <option value="mulƒç">Mulƒç</option>
                        <option value="rostliny">Rostliny</option>
                        <option value="n√°≈ôad√≠">N√°≈ôad√≠</option>
                        <option value="ostatn√≠">Ostatn√≠</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Jednotka *</label>
                    <select id="unit" required>
                        <option value="ks">ks</option>
                        <option value="kg">kg</option>
                        <option value="L">L</option>
                        <option value="m3">m¬≥</option>
                        <option value="balen√≠">balen√≠</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Aktu√°ln√≠ stav skladu *</label>
                    <input type="number" id="currentStock" required value="0" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Minim√°ln√≠ stav (alert)</label>
                    <input type="number" id="minStock" value="10" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Cena za jednotku (Kƒç)</label>
                    <input type="number" id="unitPrice" step="0.01" placeholder="50">
                </div>
                <div class="form-group">
                    <label>Dodavatel</label>
                    <input type="text" id="supplier" placeholder="Zahradnictv√≠ XY">
                </div>
                <div class="form-group">
                    <label>Lokace skladu</label>
                    <input type="text" id="location" placeholder="Sklad A, police 3">
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary" onclick="closeModal()">Zru≈°it</button>
                    <button type="submit">P≈ôidat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Movement Modal -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <div class="modal-header" id="stockModalTitle">P≈ô√≠jem materi√°lu</div>
            <form onsubmit="submitMovement(event)">
                <input type="hidden" id="movementMaterialId">
                <input type="hidden" id="movementType">
                <div class="form-group">
                    <label>Mno≈æstv√≠ *</label>
                    <input type="number" id="movementQuantity" required step="0.1" min="0.1">
                </div>
                <div class="form-group">
                    <label>Cena za jednotku (Kƒç)</label>
                    <input type="number" id="movementUnitPrice" step="0.01">
                </div>
                <div class="form-group" id="jobField" style="display:none;">
                    <label>Zak√°zka</label>
                    <select id="movementJob">
                        <option value="">-- Vyberte zak√°zku --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Datum</label>
                    <input type="date" id="movementDate">
                </div>
                <div class="form-group">
                    <label>Pozn√°mka</label>
                    <input type="text" id="movementNotes" placeholder="Dod√°vka od XY">
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary" onclick="closeModal()">Zru≈°it</button>
                    <button type="submit" id="submitMovement">Potvrdit</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allMaterials = [];
        let allJobs = [];

        async function loadMaterials() {
            try {
                const [matsResp, jobsResp] = await Promise.all([
                    fetch('/api/materials'),
                    fetch('/api/jobs')
                ]);
                
                const matsData = await matsResp.json();
                const jobsData = await jobsResp.json();
                
                if (matsData.success) {
                    allMaterials = matsData.materials;
                    renderMaterials();
                }
                
                if (jobsData) {
                    allJobs = jobsData;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('materialsGrid').innerHTML = 
                    '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #ff6b6b;">Chyba naƒç√≠t√°n√≠. Zkontroluj migraci.</div>';
            }
        }

        function renderMaterials() {
            if (allMaterials.length === 0) {
                document.getElementById('materialsGrid').innerHTML = 
                    '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-secondary);">≈Ω√°dn√© materi√°ly. P≈ôidej prvn√≠!</div>';
                return;
            }

            let html = '';
            allMaterials.forEach(m => {
                const stockPercent = m.min_stock > 0 ? (m.current_stock / m.min_stock) * 100 : 100;
                const isLow = m.low_stock_alert;

                html += `<div class="material-card ${isLow ? 'low-stock' : ''}" onclick="event.stopPropagation()">`;
                html += `<div class="material-name">${m.name}</div>`;
                if (m.category) html += `<span class="material-category">${m.category}</span>`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin: 16px 0 8px 0;">`;
                html += `<div style="font-size: 28px; font-weight: 700;">${m.current_stock} ${m.unit}</div>`;
                if (isLow) html += `<span style="color: #ff6b6b; font-size: 12px; font-weight: 600;">‚ö†Ô∏è N√çZK√ù</span>`;
                html += `</div>`;
                html += `<div class="stock-bar"><div class="stock-fill ${isLow ? 'low' : ''}" style="width: ${Math.min(100, stockPercent)}%"></div></div>`;
                html += `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">Min: ${m.min_stock} ${m.unit}</div>`;
                if (m.location) html += `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">üìç ${m.location}</div>`;
                html += `<div style="display: flex; gap: 8px; margin-top: 12px;">`;
                html += `<button onclick="showStockModal(${m.id}, 'in')" style="flex: 1; font-size: 12px; padding: 8px;">‚ûï P≈ô√≠jem</button>`;
                html += `<button onclick="showStockModal(${m.id}, 'out')" class="danger" style="flex: 1; font-size: 12px; padding: 8px;">‚ûñ Spot≈ôeba</button>`;
                html += `</div></div>`;
            });

            document.getElementById('materialsGrid').innerHTML = html;
        }

        function showAddMaterialModal() {
            document.getElementById('addMaterialModal').classList.add('active');
        }

        function showStockModal(materialId, type) {
            document.getElementById('movementMaterialId').value = materialId;
            document.getElementById('movementType').value = type;
            document.getElementById('stockModalTitle').textContent = type === 'in' ? 'P≈ô√≠jem materi√°lu' : 'Spot≈ôeba materi√°lu';
            document.getElementById('jobField').style.display = type === 'out' ? 'block' : 'none';
            document.getElementById('submitMovement').className = type === 'out' ? 'danger' : '';
            
            // Set today
            document.getElementById('movementDate').valueAsDate = new Date();
            
            // Load jobs
            const jobSelect = document.getElementById('movementJob');
            jobSelect.innerHTML = '<option value="">-- Vyberte zak√°zku --</option>';
            allJobs.forEach(j => {
                jobSelect.innerHTML += `<option value="${j.id}">${j.name}</option>`;
            });
            
            document.getElementById('stockModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.querySelectorAll('form').forEach(f => f.reset());
        }

        async function submitMaterial(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                unit: document.getElementById('unit').value,
                current_stock: parseFloat(document.getElementById('currentStock').value),
                min_stock: parseFloat(document.getElementById('minStock').value) || 0,
                unit_price: parseFloat(document.getElementById('unitPrice').value) || null,
                supplier: document.getElementById('supplier').value || null,
                location: document.getElementById('location').value || null
            };

            try {
                const response = await fetch('/api/materials', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('‚úì Materi√°l p≈ôid√°n!');
                    closeModal();
                    loadMaterials();
                } else {
                    alert('Chyba: ' + result.error);
                }
            } catch (error) {
                alert('Chyba: ' + error);
            }
        }

        async function submitMovement(e) {
            e.preventDefault();
            
            const data = {
                material_id: parseInt(document.getElementById('movementMaterialId').value),
                movement_type: document.getElementById('movementType').value,
                quantity: parseFloat(document.getElementById('movementQuantity').value),
                unit_price: parseFloat(document.getElementById('movementUnitPrice').value) || null,
                movement_date: document.getElementById('movementDate').value,
                notes: document.getElementById('movementNotes').value || null
            };

            if (data.movement_type === 'out') {
                const jobId = document.getElementById('movementJob').value;
                if (jobId) data.job_id = parseInt(jobId);
            }

            if (data.unit_price) {
                data.total_price = data.quantity * data.unit_price;
            }

            try {
                const response = await fetch('/api/materials/movement', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(data.movement_type === 'in' ? '‚úì P≈ô√≠jem zaznamen√°n!' : '‚úì Spot≈ôeba zaznamen√°na!');
                    closeModal();
                    loadMaterials();
                } else {
                    alert('Chyba: ' + result.error);
                }
            } catch (error) {
                alert('Chyba: ' + error);
            }
        }

        // Close on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
        });

        loadMaterials();
    </script>
</body>
</html>
