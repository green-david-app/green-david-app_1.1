<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adres√°≈ô | Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <link rel="stylesheet" href="/static/css/glass-design.css"/>
    <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
    <link rel="stylesheet" href="/static/icons.css">
    <script src="/app-settings.js"></script>
    <style>
    /* Page wrapper */
    .page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 10px 16px 100px;
    }

    /* Action Bar */
    .action-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .btn-primary {
        background: rgba(74, 222, 128, 0.15);
        border: 1px solid rgba(74, 222, 128, 0.3);
        color: #4ade80;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 10px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: rgba(74, 222, 128, 0.25);
        border-color: rgba(74, 222, 128, 0.5);
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.15);
    }

    /* Stats */
    .directory-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 12px;
    }

    .stat-card {
        background: rgba(26, 35, 50, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 10px;
        padding: 12px;
        border-left: 3px solid #334155;
        border: 1px solid rgba(74, 222, 128, 0.08);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .stat-card.total { border-left-color: #60a5fa; }
    .stat-card.active { border-left-color: #4ade80; }
    .stat-card.strategic { border-left-color: #a78bfa; }
    .stat-card.leads { border-left-color: #fbbf24; }

    .stat-card .label {
        font-size: 10px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-card .value {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
    }

    .stat-card .sub {
        font-size: 11px;
        color: #64748b;
        margin-top: 2px;
    }

    /* Filter Pills */
    .filter-pills {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        background: rgba(26, 35, 50, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .filter-pill {
        padding: 6px 14px;
        border: 1px solid #334155;
        background: transparent;
        color: #64748b;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .filter-pill:hover {
        border-color: #4ade80;
    }

    .filter-pill.active {
        background: rgba(74, 222, 128, 0.15);
        border-color: #4ade80;
        color: #4ade80;
    }

    /* Filters */
    .directory-filters {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-input,
    .filter-select {
        padding: 8px 14px;
        border-radius: 10px;
        font-size: 13px;
        background: rgba(26, 35, 50, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #f1f5f9;
        outline: none;
    }

    .filter-input {
        flex: 1;
        min-width: 200px;
    }

    .filter-input:focus,
    .filter-select:focus {
        border-color: #4ade80;
    }

    /* Party cards */
    .parties-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .party-card {
        background: #1a2332;
        border: 1px solid #334155;
        border-radius: 10px;
        padding: 16px 20px;
        cursor: pointer;
        transition: border-color 0.2s, transform 0.1s;
    }

    .party-card:hover {
        border-color: #4ade80;
        transform: translateY(-1px);
    }

    .party-card-top {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 12px;
    }

    .party-card-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .party-card-icon.org {
        background: rgba(74,222,128,0.12);
        color: #4ade80;
    }

    .party-card-icon.person {
        background: rgba(96,165,250,0.12);
        color: #60a5fa;
    }

    .party-card-info {
        flex: 1;
        min-width: 0;
    }

    .party-card-name {
        font-weight: 700;
        font-size: 16px;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
    }

    .party-card-contact {
        font-size: 13px;
        color: #64748b;
    }

    .party-card-badges {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .tier-badge {
        font-size: 11px;
        font-weight: 700;
        padding: 3px 10px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tier-oneoff {
        background: rgba(148,163,184,0.15);
        color: #94a3b8;
    }

    .tier-recurring {
        background: rgba(96,165,250,0.15);
        color: #60a5fa;
    }

    .tier-strategic {
        background: rgba(74,222,128,0.15);
        color: #4ade80;
    }

    .party-card-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid rgba(255,255,255,0.05);
    }

    .party-card-stats {
        font-size: 12px;
        color: #64748b;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .party-card-stats .dot {
        opacity: 0.4;
    }

    .party-card-health {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .health-bar {
        width: 60px;
        height: 6px;
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .health-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.6s;
    }

    .health-num {
        font-size: 13px;
        font-weight: 700;
    }

    /* Detail panel */
    #party-detail-panel {
        position: fixed;
        top: 56px;
        right: 0;
        bottom: 0;
        width: 560px;
        max-width: 100%;
        background: rgba(20, 27, 40, 0.85);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
        z-index: 1001;
        overflow-y: auto;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    }

    #party-detail-panel.open {
        transform: translateX(0);
    }

    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: sticky;
        top: 0;
        background: rgba(20, 27, 40, 0.85);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        z-index: 10;
    }

    .detail-header h2 {
        font-size: 20px;
        color: #fff;
        margin: 0;
    }

    .detail-close {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .detail-close:hover {
        color: #fff;
    }

    .detail-tabs {
        display: flex;
        gap: 2px;
        padding: 12px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        overflow-x: auto;
        position: sticky;
        top: 73px;
        background: rgba(20, 27, 40, 0.85);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        z-index: 9;
    }

    .detail-tab {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 13px;
        background: transparent;
        border: none;
        color: #64748b;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .detail-tab.active {
        background: #1a2332;
        color: #fff;
        font-weight: 600;
    }

    .detail-body {
        padding: 20px;
        background: rgba(20, 27, 40, 0.85);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
    }

    .detail-field-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .detail-field {
        margin-bottom: 14px;
    }

    .detail-field label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        margin-bottom: 4px;
        display: block;
    }

    .detail-field span,
    .detail-field p {
        color: #fff;
        font-size: 14px;
    }

    .detail-field select {
        width: 100%;
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(26, 35, 50, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        font-size: 14px;
        outline: none;
    }

    .detail-field select:focus {
        border-color: #4ade80;
    }

    .detail-tab-content {
        display: none;
    }

    .detail-tab-content.active {
        display: block;
    }

    .detail-job-row,
    .detail-contact-row,
    .detail-interaction-row {
        padding: 12px;
        background: rgba(26, 35, 50, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.06);
        transition: all 0.3s ease;
    }

    .detail-job-row:hover,
    .detail-contact-row:hover {
        border-color: rgba(74, 222, 128, 0.3);
        transform: translateX(2px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .detail-contact-row {
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .contact-role {
        font-size: 11px;
        color: #64748b;
        margin-left: 6px;
    }

    .contact-details {
        margin-top: 4px;
        font-size: 13px;
        color: #64748b;
    }

    .detail-interaction-row {
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .interaction-icon {
        font-size: 18px;
    }

    .interaction-date {
        font-size: 12px;
        color: #64748b;
        min-width: 100px;
    }

    .interaction-text {
        flex: 1;
        color: #fff;
        font-size: 13px;
    }

    .index-metric {
        margin-bottom: 20px;
    }

    .index-bar {
        width: 100%;
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0;
    }

    .index-fill {
        height: 100%;
        background: #4ade80;
        border-radius: 4px;
        transition: width 0.6s;
    }

    .index-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 24px;
    }

    .index-summary div {
        padding: 12px;
        background: rgba(26, 35, 50, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .index-summary label {
        font-size: 11px;
        color: #64748b;
        text-transform: uppercase;
        display: block;
        margin-bottom: 4px;
    }

    .index-summary strong {
        font-size: 18px;
        color: #fff;
    }

    .btn-add,
    .btn-edit {
        margin-top: 16px;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        background: rgba(74,222,128,0.1);
        border: 1px solid rgba(74,222,128,0.3);
        color: #4ade80;
        text-align: center;
        transition: all 0.2s;
    }

    .btn-add:hover,
    .btn-edit:hover {
        background: rgba(74,222,128,0.2);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .empty-state svg {
        opacity: 0.3;
        margin-bottom: 16px;
    }

    .empty-note {
        color: #64748b;
        font-size: 13px;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(4px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: rgba(20, 27, 40, 0.85);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #334155;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: #fff;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #334155;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .form-row {
        margin-bottom: 16px;
    }

    .form-row label {
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        margin-bottom: 6px;
    }

    .form-row input,
    .form-row select,
    .form-row textarea {
        width: 100%;
        padding: 10px 14px;
        border-radius: 8px;
        background: rgba(26, 35, 50, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
    }

    .form-row input:focus,
    .form-row select:focus,
    .form-row textarea:focus {
        border-color: #4ade80;
    }

    .form-row-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }

    .chip {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid #334155;
        background: transparent;
        color: #64748b;
        transition: all 0.2s;
    }

    .chip:hover {
        border-color: #4ade80;
        color: #fff;
    }

    .chip.active {
        background: rgba(74,222,128,0.15);
        border-color: #4ade80;
        color: #4ade80;
    }

    .btn-secondary {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        background: transparent;
        color: #64748b;
        border: 1px solid #334155;
        cursor: pointer;
    }

    .btn-secondary:hover {
        background: #1a2332;
        color: #fff;
    }

    @media (max-width: 768px) {
        .directory-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .directory-filters {
            flex-direction: column;
        }

        .filter-input {
            width: 100%;
        }

        #party-detail-panel {
            width: 100%;
        }

        .detail-field-grid {
            grid-template-columns: 1fr;
        }

        .form-row-grid {
            grid-template-columns: 1fr;
        }
    }
    </style>
</head>
<body class="has-sidebar">
    <div id="app-header"></div>
    
    <div class="page">
        <!-- Action Bar -->
        <div class="action-bar">
            <button class="btn-primary" onclick="openNewPartyModal()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                + Nov√Ω klient
            </button>
        </div>

        <!-- Stats -->
        <div class="directory-stats">
            <div class="stat-card total">
                <div class="label">Celkem</div>
                <div class="value" id="stat-total">0</div>
            </div>
            <div class="stat-card active">
                <div class="label">Aktivn√≠ch</div>
                <div class="value" id="stat-active">0</div>
            </div>
            <div class="stat-card strategic">
                <div class="label">Strategick√Ωch</div>
                <div class="value" id="stat-strategic">0</div>
            </div>
            <div class="stat-card leads">
                <div class="label">Nov√Ωch</div>
                <div class="value" id="stat-leads">0</div>
            </div>
        </div>

        <!-- Filter Pills -->
        <div class="filter-pills">
            <button class="filter-pill active" onclick="filterByStatus('')">V≈°ichni</button>
            <button class="filter-pill" onclick="filterByStatus('LEAD')">Nov√© (<span id="tab-count-lead">0</span>)</button>
            <button class="filter-pill" onclick="filterByStatus('ACTIVE')">Aktivn√≠ (<span id="tab-count-active">0</span>)</button>
            <button class="filter-pill" onclick="filterByStatus('RECURRING')">St√°l√≠ (<span id="tab-count-recurring">0</span>)</button>
            <button class="filter-pill" onclick="filterByStatus('DORMANT')">Sp√≠c√≠</button>
        </div>

        <!-- Filters -->
        <div class="directory-filters">
            <input type="text" class="filter-input" id="search-input" placeholder="Hledat podle n√°zvu, IƒåO, emailu..." oninput="onSearch(this.value)">
            <select class="filter-select" id="filter-role" onchange="applyFilters()">
                <option value="">V≈°echny role</option>
                <option value="CLIENT">Klient</option>
                <option value="SUPPLIER">Dodavatel</option>
                <option value="PARTNER">Partner</option>
                <option value="AUTHORITY">√ö≈ôad</option>
            </select>
            <select class="filter-select" id="filter-status" onchange="applyFilters()">
                <option value="">V≈°echny stavy</option>
                <option value="LEAD">Nov√Ω (Lead)</option>
                <option value="ACTIVE">Aktivn√≠</option>
                <option value="DORMANT">Sp√≠c√≠</option>
                <option value="BLOCKED">Blokovan√Ω</option>
            </select>
            <select class="filter-select" id="filter-tier" onchange="applyFilters()">
                <option value="">V≈°echny √∫rovnƒõ</option>
                <option value="ONE_OFF">Jednor√°zov√Ω</option>
                <option value="RECURRING">St√°l√Ω</option>
                <option value="STRATEGIC">Strategick√Ω</option>
            </select>
            <select class="filter-select" id="filter-sort" onchange="applyFilters()">
                <option value="display_name">≈òadit podle n√°zvu</option>
                <option value="total_revenue">≈òadit podle obratu</option>
                <option value="health_index">≈òadit podle zdrav√≠</option>
                <option value="last_job_date">≈òadit podle posledn√≠ zak√°zky</option>
            </select>
        </div>

        <!-- Parties list -->
        <div class="parties-list" id="parties-list"></div>
    </div>

    <!-- Detail panel -->
    <div id="party-detail-panel">
        <!-- Napln√≠ se JavaScriptem -->
    </div>

    <!-- Modal pro novou/editaci protistrany -->
    <div class="modal-overlay" id="party-modal" onclick="if(event.target===this)closePartyModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title">Nov√Ω klient</h3>
                <button class="detail-close" onclick="closePartyModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="party-form">
                    <input type="hidden" id="party-id">
                    
                    <div class="form-row">
                        <label>Typ</label>
                        <div class="chip-group">
                            <button type="button" class="chip active" data-type="ORG" onclick="selectPartyType('ORG', this)">Organizace</button>
                            <button type="button" class="chip" data-type="PERSON" onclick="selectPartyType('PERSON', this)">Osoba</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>N√°zev *</label>
                        <input type="text" id="party-display-name" required>
                    </div>

                    <div class="form-row">
                        <label>Pr√°vn√≠ n√°zev</label>
                        <input type="text" id="party-legal-name">
                    </div>

                    <div class="form-row-grid">
                        <div class="form-row">
                            <label>IƒåO</label>
                            <input type="text" id="party-ico">
                        </div>
                        <div class="form-row">
                            <label>DIƒå</label>
                            <input type="text" id="party-dic">
                        </div>
                    </div>

                    <div class="form-row-grid">
                        <div class="form-row">
                            <label>Email</label>
                            <input type="email" id="party-email">
                        </div>
                        <div class="form-row">
                            <label>Telefon</label>
                            <input type="tel" id="party-phone">
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Web</label>
                        <input type="url" id="party-website">
                    </div>

                    <div class="form-row">
                        <label>Adresa</label>
                        <input type="text" id="party-street" placeholder="Ulice a ƒç√≠slo">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-top: 8px;">
                            <input type="text" id="party-city" placeholder="Mƒõsto">
                            <input type="text" id="party-zip" placeholder="PSƒå">
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Role</label>
                        <div class="chip-group" id="roles-chips">
                            <button type="button" class="chip active" data-role="CLIENT" onclick="toggleRole('CLIENT', this)">Klient</button>
                            <button type="button" class="chip" data-role="SUPPLIER" onclick="toggleRole('SUPPLIER', this)">Dodavatel</button>
                            <button type="button" class="chip" data-role="PARTNER" onclick="toggleRole('PARTNER', this)">Partner</button>
                            <button type="button" class="chip" data-role="AUTHORITY" onclick="toggleRole('AUTHORITY', this)">√ö≈ôad</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>√örove≈à</label>
                        <select id="party-tier">
                            <option value="ONE_OFF">Jednor√°zov√Ω</option>
                            <option value="RECURRING">St√°l√Ω</option>
                            <option value="STRATEGIC">Strategick√Ω</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Status</label>
                        <select id="party-status">
                            <option value="LEAD">Nov√Ω (Lead)</option>
                            <option value="ACTIVE">Aktivn√≠</option>
                            <option value="DORMANT">Sp√≠c√≠</option>
                            <option value="BLOCKED">Blokovan√Ω</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Zdroj</label>
                        <select id="party-source">
                            <option value="">‚Äî Nevybr√°no ‚Äî</option>
                            <option value="Doporuƒçen√≠">Doporuƒçen√≠</option>
                            <option value="Web">Web</option>
                            <option value="Opakovan√Ω">Opakovan√Ω</option>
                            <option value="Reklama">Reklama</option>
                            <option value="Jin√©">Jin√©</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Tagy (oddƒõlen√© ƒç√°rkou)</label>
                        <input type="text" id="party-tags" placeholder="zahrady, √∫dr≈æba, VIP">
                    </div>

                    <div class="form-row">
                        <label>Pozn√°mka</label>
                        <textarea id="party-note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePartyModal()">Zru≈°it</button>
                <button class="btn-primary" onclick="saveParty()">Ulo≈æit</button>
            </div>
        </div>

        <!-- Modal pro kontakt -->
        <div class="modal-overlay" id="contact-modal" onclick="if(event.target===this)closeContactModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>P≈ôidat kontaktn√≠ osobu</h3>
                    <button class="detail-close" onclick="closeContactModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="contact-form">
                        <input type="hidden" id="contact-party-id">
                        <div class="form-row">
                            <label>Jm√©no *</label>
                            <input type="text" id="contact-name" required>
                        </div>
                        <div class="form-row">
                            <label>Role</label>
                            <input type="text" id="contact-role" placeholder="jednatel, stavbyvedouc√≠, √∫ƒçetn√≠...">
                        </div>
                        <div class="form-row-grid">
                            <div class="form-row">
                                <label>Email</label>
                                <input type="email" id="contact-email">
                            </div>
                            <div class="form-row">
                                <label>Telefon</label>
                                <input type="tel" id="contact-phone">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>
                                <input type="checkbox" id="contact-is-primary" style="width: auto; margin-right: 8px;">
                                Hlavn√≠ kontakt
                            </label>
                        </div>
                        <div class="form-row">
                            <label>Pozn√°mka</label>
                            <textarea id="contact-note" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeContactModal()">Zru≈°it</button>
                    <button class="btn-primary" onclick="saveContact()">Ulo≈æit</button>
                </div>
            </div>
        </div>

        <!-- Modal pro interakci -->
        <div class="modal-overlay" id="interaction-modal" onclick="if(event.target===this)closeInteractionModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>P≈ôidat z√°znam</h3>
                    <button class="detail-close" onclick="closeInteractionModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="interaction-form">
                        <input type="hidden" id="interaction-party-id">
                        <div class="form-row">
                            <label>Typ</label>
                            <select id="interaction-type">
                                <option value="CALL">Telefon√°t</option>
                                <option value="EMAIL">Email</option>
                                <option value="MEETING">Sch≈Øzka</option>
                                <option value="NOTE">Pozn√°mka</option>
                                <option value="COMPLAINT">Reklamace</option>
                                <option value="PAYMENT">Platba</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Datum</label>
                            <input type="date" id="interaction-date" value="">
                        </div>
                        <div class="form-row">
                            <label>Popis</label>
                            <textarea id="interaction-summary" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeInteractionModal()">Zru≈°it</button>
                    <button class="btn-primary" onclick="saveInteraction()">Ulo≈æit</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app-sidebar.js"></script>
    <script src="/static/app-header.js"></script>
    <script>
    let allParties = [];
    let currentFilter = { role: '', status: '', tier: '', search: '', sort_by: 'display_name' };
    let currentPartyType = 'ORG';
    let selectedRoles = ['CLIENT'];

    // Naƒçten√≠ dat
    async function loadParties() {
        const params = new URLSearchParams();
        if (currentFilter.role) params.set('role', currentFilter.role);
        if (currentFilter.status) params.set('status', currentFilter.status);
        if (currentFilter.tier) params.set('tier', currentFilter.tier);
        if (currentFilter.search) params.set('search', currentFilter.search);
        params.set('sort_by', currentFilter.sort_by);
        
        try {
            const res = await fetch('/api/parties?' + params.toString());
            const data = await res.json();
            allParties = data.parties || [];
            renderParties(allParties);
            loadStats();
        } catch (e) {
            console.error('Chyba naƒç√≠t√°n√≠ protistran:', e);
        }
    }

    // Statistiky
    async function loadStats() {
        try {
            const res = await fetch('/api/parties/stats');
            const stats = await res.json();
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-active').textContent = stats.active || 0;
            document.getElementById('stat-strategic').textContent = stats.strategic || 0;
            document.getElementById('stat-leads').textContent = stats.leads || 0;
            
            // Aktualizuj poƒçty v tabs
            document.getElementById('tab-count-lead').textContent = stats.leads || 0;
            document.getElementById('tab-count-active').textContent = stats.active || 0;
        } catch (e) {
            console.error('Chyba naƒç√≠t√°n√≠ statistik:', e);
        }
    }

    // Renderov√°n√≠ karet
    function renderParties(parties) {
        const container = document.getElementById('parties-list');
        
        if (parties.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <p>Zat√≠m ≈æ√°dn√© protistrany. P≈ôidej prvn√≠ho klienta.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = parties.map(p => {
            const roles = JSON.parse(p.roles || '[]');
            const isOrg = p.type === 'ORG';
            const tierLabel = { ONE_OFF: 'Jednor√°zov√Ω', RECURRING: 'St√°l√Ω', STRATEGIC: 'Strategick√Ω' }[p.tier] || p.tier;
            const tierClass = { ONE_OFF: 'tier-oneoff', RECURRING: 'tier-recurring', STRATEGIC: 'tier-strategic' }[p.tier] || '';
            const health = p.health_index || 50;
            const healthColor = health >= 70 ? '#4ade80' : health >= 40 ? '#fbbf24' : '#f87171';
            const revenue = p.total_revenue ? Math.round(p.total_revenue).toLocaleString('cs-CZ') + ' Kƒç' : '‚Äî';
            const lastJob = p.last_job_date ? new Date(p.last_job_date).toLocaleDateString('cs-CZ') : '‚Äî';
            
            return `
                <div class="party-card" onclick="openPartyDetail(${p.id})" data-id="${p.id}">
                    <div class="party-card-top">
                        <div class="party-card-icon ${isOrg ? 'org' : 'person'}">
                            ${isOrg ? `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 21h18M3 7v14M21 7v14M6 11h2M6 15h2M10 11h2M10 15h2M14 11h2M14 15h2M18 11h2M18 15h2M6 7V3h12v4"/>
                                </svg>
                            ` : `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            `}
                        </div>
                        <div class="party-card-info">
                            <div class="party-card-name">${escapeHtml(p.display_name)}</div>
                            <div class="party-card-contact">
                                ${p.phone ? escapeHtml(p.phone) : ''}
                                ${p.phone && p.email ? ' ¬∑ ' : ''}
                                ${p.email ? escapeHtml(p.email) : ''}
                            </div>
                        </div>
                        <div class="party-card-badges">
                            <span class="tier-badge ${tierClass}">${tierLabel}</span>
                        </div>
                    </div>
                    <div class="party-card-bottom">
                        <div class="party-card-stats">
                            <span>${p.total_jobs || 0} zak√°zek</span>
                            <span class="dot">¬∑</span>
                            <span>${revenue}</span>
                            <span class="dot">¬∑</span>
                            <span>Posledn√≠: ${lastJob}</span>
                        </div>
                        <div class="party-card-health">
                            <div class="health-bar">
                                <div class="health-fill" style="width:${health}%; background:${healthColor}"></div>
                            </div>
                            <span class="health-num" style="color:${healthColor}">${health}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Pipeline tabs
    function filterByStatus(status) {
        currentFilter.status = status;
        loadParties();
        
        // Aktivn√≠ tab
        document.querySelectorAll('.filter-pill').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Vyhled√°v√°n√≠ (debounced)
    let searchTimeout;
    function onSearch(value) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentFilter.search = value;
            loadParties();
        }, 300);
    }

    // Filtry
    function applyFilters() {
        currentFilter.role = document.getElementById('filter-role').value;
        currentFilter.status = document.getElementById('filter-status').value;
        currentFilter.tier = document.getElementById('filter-tier').value;
        currentFilter.sort_by = document.getElementById('filter-sort').value;
        loadParties();
    }

    // Detail klienta
    async function openPartyDetail(id) {
        try {
            const res = await fetch('/api/parties/' + id);
            const party = await res.json();
            renderPartyDetail(party);
            document.getElementById('party-detail-panel').classList.add('open');
            document.body.style.overflow = 'hidden';
        } catch (e) {
            console.error('Chyba naƒç√≠t√°n√≠ detailu:', e);
            alert('Nepoda≈ôilo se naƒç√≠st detail protistrany');
        }
    }

    function closePartyDetail() {
        document.getElementById('party-detail-panel').classList.remove('open');
        document.body.style.overflow = '';
    }

    // Render detailu ‚Äî tabs
    function renderPartyDetail(party) {
        const panel = document.getElementById('party-detail-panel');
        const tierLabel = { ONE_OFF: 'Jednor√°zov√Ω', RECURRING: 'St√°l√Ω', STRATEGIC: 'Strategick√Ω' }[party.tier] || '';
        
        panel.innerHTML = `
            <div class="detail-header">
                <h2>${escapeHtml(party.display_name)}</h2>
                <button class="detail-close" onclick="closePartyDetail()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="detail-tabs">
                <button class="detail-tab active" onclick="showDetailTab('profile', this)">Profil</button>
                <button class="detail-tab" onclick="showDetailTab('jobs', this)">Zak√°zky (${(party.jobs||[]).length})</button>
                <button class="detail-tab" onclick="showDetailTab('contacts', this)">Kontakty (${(party.contacts||[]).length})</button>
                <button class="detail-tab" onclick="showDetailTab('history', this)">Historie</button>
                <button class="detail-tab" onclick="showDetailTab('index', this)">Index</button>
            </div>
            
            <div class="detail-body">
                <!-- TAB: Profil -->
                <div class="detail-tab-content active" id="tab-profile">
                    <div class="detail-field-grid">
                        <div class="detail-field">
                            <label>Typ</label>
                            <span>${party.type === 'ORG' ? 'Organizace' : 'Osoba'}</span>
                        </div>
                        <div class="detail-field">
                            <label>Status</label>
                            <select onchange="updatePartyField(${party.id}, 'status', this.value)">
                                <option value="LEAD" ${party.status==='LEAD'?'selected':''}>Nov√Ω (Lead)</option>
                                <option value="ACTIVE" ${party.status==='ACTIVE'?'selected':''}>Aktivn√≠</option>
                                <option value="DORMANT" ${party.status==='DORMANT'?'selected':''}>Sp√≠c√≠</option>
                                <option value="BLOCKED" ${party.status==='BLOCKED'?'selected':''}>Blokovan√Ω</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label>√örove≈à</label>
                            <select onchange="updatePartyField(${party.id}, 'tier', this.value)">
                                <option value="ONE_OFF" ${party.tier==='ONE_OFF'?'selected':''}>Jednor√°zov√Ω</option>
                                <option value="RECURRING" ${party.tier==='RECURRING'?'selected':''}>St√°l√Ω</option>
                                <option value="STRATEGIC" ${party.tier==='STRATEGIC'?'selected':''}>Strategick√Ω</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label>IƒåO</label>
                            <span>${party.ico || '‚Äî'}</span>
                        </div>
                        <div class="detail-field">
                            <label>DIƒå</label>
                            <span>${party.dic || '‚Äî'}</span>
                        </div>
                        <div class="detail-field">
                            <label>Adresa</label>
                            <span>${[party.street, party.city, party.zip].filter(Boolean).join(', ') || '‚Äî'}</span>
                        </div>
                        <div class="detail-field">
                            <label>Email</label>
                            <span>${party.email ? '<a href="mailto:'+party.email+'">'+party.email+'</a>' : '‚Äî'}</span>
                        </div>
                        <div class="detail-field">
                            <label>Telefon</label>
                            <span>${party.phone ? '<a href="tel:'+party.phone+'">'+party.phone+'</a>' : '‚Äî'}</span>
                        </div>
                        <div class="detail-field">
                            <label>Web</label>
                            <span>${party.website || '‚Äî'}</span>
                        </div>
                        <div class="detail-field">
                            <label>Zdroj</label>
                            <span>${party.source || '‚Äî'}</span>
                        </div>
                    </div>
                    <div class="detail-field" style="margin-top: 16px;">
                        <label>Pozn√°mka</label>
                        <p>${party.note || '≈Ω√°dn√° pozn√°mka'}</p>
                    </div>
                    <button class="btn-edit" onclick="openEditPartyModal(${party.id})">Upravit profil</button>
                </div>
                
                <!-- TAB: Zak√°zky -->
                <div class="detail-tab-content" id="tab-jobs">
                    ${(party.jobs||[]).length > 0 ? (party.jobs||[]).map(j => `
                        <div class="detail-job-row" onclick="window.location.href='/jobs.html?id=${j.id}'">
                            <div>
                                <strong>${escapeHtml(j.title || j.name || 'Zak√°zka #'+j.id)}</strong>
                                <div class="detail-job-meta" style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                    ${j.status || ''} ¬∑ Deadline: ${j.deadline ? new Date(j.deadline).toLocaleDateString('cs-CZ') : '‚Äî'}
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="empty-note">≈Ω√°dn√© zak√°zky</p>'}
                    <button class="btn-add" onclick="createJobForParty(${party.id}, '${escapeHtml(party.display_name)}')">+ Nov√° zak√°zka pro ${escapeHtml(party.display_name)}</button>
                </div>
                
                <!-- TAB: Kontakty -->
                <div class="detail-tab-content" id="tab-contacts">
                    ${(party.contacts||[]).map(c => `
                        <div class="detail-contact-row">
                            <div>
                                <strong>${escapeHtml(c.name)}</strong> ${c.is_primary ? '‚≠ê' : ''}
                                ${c.role ? '<span class="contact-role">'+escapeHtml(c.role)+'</span>' : ''}
                            </div>
                            <div class="contact-details">
                                ${c.email ? '<a href="mailto:'+c.email+'">'+c.email+'</a>' : ''}
                                ${c.phone ? ' ¬∑ <a href="tel:'+c.phone+'">'+c.phone+'</a>' : ''}
                            </div>
                        </div>
                    `).join('') || '<p class="empty-note">≈Ω√°dn√© kontaktn√≠ osoby</p>'}
                    <button class="btn-add" onclick="addContactModal(${party.id})">+ P≈ôidat kontakt</button>
                </div>
                
                <!-- TAB: Historie -->
                <div class="detail-tab-content" id="tab-history">
                    ${(party.interactions||[]).map(i => {
                        const icons = { CALL: 'üìû', EMAIL: 'üìß', MEETING: 'ü§ù', NOTE: 'üìù', COMPLAINT: '‚ö†', PAYMENT: 'üí∞' };
                        return `
                            <div class="detail-interaction-row">
                                <span class="interaction-icon">${icons[i.type] || 'üìå'}</span>
                                <span class="interaction-date">${i.date || ''}</span>
                                <span class="interaction-text">${escapeHtml(i.summary || '')}</span>
                            </div>
                        `;
                    }).join('') || '<p class="empty-note">≈Ω√°dn√° historie</p>'}
                    <button class="btn-add" onclick="addInteractionModal(${party.id})">+ P≈ôidat z√°znam</button>
                </div>
                
                <!-- TAB: Index -->
                <div class="detail-tab-content" id="tab-index">
                    <div class="index-metric">
                        <label>Zdrav√≠ vztahu</label>
                        <div class="index-bar"><div class="index-fill" style="width:${party.health_index||50}%"></div></div>
                        <span>${party.health_index || 50}/100</span>
                    </div>
                    <div class="index-metric">
                        <label>Platebn√≠ mor√°lka</label>
                        <div class="index-bar"><div class="index-fill" style="width:${party.payment_reliability||50}%"></div></div>
                        <span>${party.payment_reliability || 50}/100</span>
                    </div>
                    <div class="index-summary">
                        <div><label>Obrat celkem</label><strong>${party.total_revenue ? Math.round(party.total_revenue).toLocaleString('cs-CZ') + ' Kƒç' : '‚Äî'}</strong></div>
                        <div><label>Poƒçet zak√°zek</label><strong>${party.total_jobs || 0}</strong></div>
                        <div><label>Pr≈Ømƒõrn√° zak√°zka</label><strong>${party.total_jobs > 0 ? Math.round((party.total_revenue||0)/(party.total_jobs)).toLocaleString('cs-CZ') + ' Kƒç' : '‚Äî'}</strong></div>
                    </div>
                </div>
            </div>
        `;
    }

    function showDetailTab(tabName, btn) {
        document.querySelectorAll('.detail-tab-content').forEach(t => {
            t.classList.remove('active');
            t.style.display = 'none';
        });
        document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
        const tab = document.getElementById('tab-' + tabName);
        if (tab) {
            tab.style.display = 'block';
            tab.classList.add('active');
        }
        btn.classList.add('active');
    }

    async function updatePartyField(id, field, value) {
        try {
            await fetch('/api/parties/' + id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: value })
            });
            loadParties();
            openPartyDetail(id); // Reload detail
        } catch (e) {
            console.error('Chyba aktualizace:', e);
        }
    }

    function createJobForParty(partyId, partyName) {
        window.location.href = '/jobs.html?new=1&party_id=' + partyId + '&party_name=' + encodeURIComponent(partyName);
    }

    // Modal funkce
    function openNewPartyModal() {
        document.getElementById('party-id').value = '';
        document.getElementById('modal-title').textContent = 'Nov√Ω klient';
        document.getElementById('party-form').reset();
        currentPartyType = 'ORG';
        selectedRoles = ['CLIENT'];
        document.querySelectorAll('.chip[data-type]').forEach(c => c.classList.remove('active'));
        document.querySelector('.chip[data-type="ORG"]').classList.add('active');
        document.querySelectorAll('.chip[data-role]').forEach(c => c.classList.remove('active'));
        document.querySelector('.chip[data-role="CLIENT"]').classList.add('active');
        document.getElementById('party-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function openEditPartyModal(id) {
        // Naƒçti data a napl≈à formul√°≈ô
        fetch('/api/parties/' + id)
            .then(r => r.json())
            .then(party => {
                document.getElementById('party-id').value = party.id;
                document.getElementById('modal-title').textContent = 'Upravit protistranu';
                document.getElementById('party-display-name').value = party.display_name || '';
                document.getElementById('party-legal-name').value = party.legal_name || '';
                document.getElementById('party-ico').value = party.ico || '';
                document.getElementById('party-dic').value = party.dic || '';
                document.getElementById('party-email').value = party.email || '';
                document.getElementById('party-phone').value = party.phone || '';
                document.getElementById('party-website').value = party.website || '';
                document.getElementById('party-street').value = party.street || '';
                document.getElementById('party-city').value = party.city || '';
                document.getElementById('party-zip').value = party.zip || '';
                document.getElementById('party-tier').value = party.tier || 'ONE_OFF';
                document.getElementById('party-status').value = party.status || 'LEAD';
                document.getElementById('party-source').value = party.source || '';
                document.getElementById('party-note').value = party.note || '';
                
                const tags = JSON.parse(party.tags || '[]');
                document.getElementById('party-tags').value = tags.join(', ');
                
                currentPartyType = party.type || 'ORG';
                selectedRoles = JSON.parse(party.roles || '["CLIENT"]');
                
                document.querySelectorAll('.chip[data-type]').forEach(c => {
                    c.classList.toggle('active', c.dataset.type === currentPartyType);
                });
                document.querySelectorAll('.chip[data-role]').forEach(c => {
                    c.classList.toggle('active', selectedRoles.includes(c.dataset.role));
                });
                
                document.getElementById('party-modal').classList.add('active');
                document.body.style.overflow = 'hidden';
            });
    }

    function closePartyModal() {
        document.getElementById('party-modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    function selectPartyType(type, btn) {
        currentPartyType = type;
        document.querySelectorAll('.chip[data-type]').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
    }

    function toggleRole(role, btn) {
        if (selectedRoles.includes(role)) {
            selectedRoles = selectedRoles.filter(r => r !== role);
            btn.classList.remove('active');
        } else {
            selectedRoles.push(role);
            btn.classList.add('active');
        }
    }

    async function saveParty() {
        const id = document.getElementById('party-id').value;
        const data = {
            type: currentPartyType,
            display_name: document.getElementById('party-display-name').value.trim(),
            legal_name: document.getElementById('party-legal-name').value.trim() || null,
            ico: document.getElementById('party-ico').value.trim() || null,
            dic: document.getElementById('party-dic').value.trim() || null,
            email: document.getElementById('party-email').value.trim() || null,
            phone: document.getElementById('party-phone').value.trim() || null,
            website: document.getElementById('party-website').value.trim() || null,
            street: document.getElementById('party-street').value.trim() || null,
            city: document.getElementById('party-city').value.trim() || null,
            zip: document.getElementById('party-zip').value.trim() || null,
            tier: document.getElementById('party-tier').value,
            status: document.getElementById('party-status').value,
            source: document.getElementById('party-source').value || null,
            note: document.getElementById('party-note').value.trim() || null,
            roles: selectedRoles,
            tags: document.getElementById('party-tags').value.split(',').map(t => t.trim()).filter(Boolean)
        };

        if (!data.display_name) {
            alert('N√°zev je povinn√Ω');
            return;
        }

        try {
            const url = id ? '/api/parties/' + id : '/api/parties';
            const method = id ? 'PATCH' : 'POST';
            
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closePartyModal();
                loadParties();
            } else {
                const err = await res.json();
                alert('Chyba: ' + (err.error || 'Nezn√°m√° chyba'));
            }
        } catch (e) {
            console.error('Chyba ukl√°d√°n√≠:', e);
            alert('Chyba p≈ôi ukl√°d√°n√≠ protistrany');
        }
    }

    function addContactModal(partyId) {
        document.getElementById('contact-party-id').value = partyId;
        document.getElementById('contact-form').reset();
        document.getElementById('contact-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeContactModal() {
        document.getElementById('contact-modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    async function saveContact() {
        const partyId = document.getElementById('contact-party-id').value;
        const data = {
            name: document.getElementById('contact-name').value.trim(),
            role: document.getElementById('contact-role').value.trim() || null,
            email: document.getElementById('contact-email').value.trim() || null,
            phone: document.getElementById('contact-phone').value.trim() || null,
            is_primary: document.getElementById('contact-is-primary').checked,
            note: document.getElementById('contact-note').value.trim() || null
        };

        if (!data.name) {
            alert('Jm√©no je povinn√©');
            return;
        }

        try {
            const res = await fetch('/api/parties/' + partyId + '/contacts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeContactModal();
                openPartyDetail(partyId); // Reload detail
            } else {
                alert('Chyba p≈ôi ukl√°d√°n√≠ kontaktu');
            }
        } catch (e) {
            console.error('Chyba:', e);
            alert('Chyba p≈ôi ukl√°d√°n√≠ kontaktu');
        }
    }

    function addInteractionModal(partyId) {
        document.getElementById('interaction-party-id').value = partyId;
        document.getElementById('interaction-form').reset();
        document.getElementById('interaction-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('interaction-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeInteractionModal() {
        document.getElementById('interaction-modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    async function saveInteraction() {
        const partyId = document.getElementById('interaction-party-id').value;
        const data = {
            type: document.getElementById('interaction-type').value,
            summary: document.getElementById('interaction-summary').value.trim(),
            date: document.getElementById('interaction-date').value
        };

        if (!data.summary) {
            alert('Popis je povinn√Ω');
            return;
        }

        try {
            const res = await fetch('/api/parties/' + partyId + '/interactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeInteractionModal();
                openPartyDetail(partyId); // Reload detail
            } else {
                alert('Chyba p≈ôi ukl√°d√°n√≠ z√°znamu');
            }
        } catch (e) {
            console.error('Chyba:', e);
            alert('Chyba p≈ôi ukl√°d√°n√≠ z√°znamu');
        }
    }

    // Helper
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // Escape key pro zav≈ôen√≠ modalu
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closePartyDetail();
            closePartyModal();
            closeContactModal();
            closeInteractionModal();
        }
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        loadParties();
        // Nastav defaultn√≠ datum pro interakci
        document.getElementById('interaction-date').value = new Date().toISOString().split('T')[0];
    });
    </script>
</body>
</html>
