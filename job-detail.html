<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail zak√°zky - Green David</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/glass-design.css">
    <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/job-detail.css">
    <script src="/app-settings.js"></script>
    <script src="/static/app-header.js"></script>
    <style>
        .job-detail-container {
            /* max-width a margin jsou u≈æ v .page-container, jen odstran√≠me padding */
            padding: 0;
        }
        
        .job-header {
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
        }
        
        .job-header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        
        .job-meta {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meta-item svg {
            width: 20px;
            height: 20px;
            stroke: #9fd4a1;
        }
        
        .job-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #2d3748;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: #9fd4a1;
            border-bottom-color: #9fd4a1;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: #1a2332;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2d3748;
        }
        
        .info-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #9fd4a1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #2d3748;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #a0aec0;
        }
        
        .info-value {
            color: white;
            font-weight: 500;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            margin: 0;
            color: white;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #2d3748;
        }
        
        .timeline-item {
            position: relative;
            padding: 15px 20px;
            margin-bottom: 15px;
            background: #1a2332;
            border-radius: 8px;
            border-left: 3px solid #9fd4a1;
        }
        
        .timeline-item.completed {
            border-left-color: #48bb78;
        }
        
        .timeline-item.pending {
            border-left-color: #ecc94b;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #9fd4a1;
            border: 3px solid #0d1117;
        }
        
        .timeline-date {
            color: #a0aec0;
            font-size: 14px;
        }
        
        .timeline-title {
            color: white;
            font-weight: 600;
            margin: 5px 0;
        }
        
        .table-container {
            background: #1a2332;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: #2d3748;
            color: #9fd4a1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .table td {
            padding: 12px;
            color: white;
            border-bottom: 1px solid #2d3748;
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #48bb78;
            color: white;
        }
        
        .badge-warning {
            background: #ecc94b;
            color: #1a2332;
        }
        
        .badge-info {
            background: #4299e1;
            color: white;
        }
        
        .badge-danger {
            background: #f56565;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: #4a5568;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon-edit {
            background: #4299e1;
        }
        
        .btn-icon-delete {
            background: #f56565;
        }
        
        .btn-icon svg {
            width: 18px;
            height: 18px;
            stroke: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #9fd4a1, #48bb78);
            transition: width 0.3s;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a2332;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: white;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 24px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #a0aec0;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-body {
            padding: 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2d3748;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #4a5568;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #5a6578;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #9fd4a1;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
</head>
<body class="has-sidebar">
    <div id="app-sidebar"></div>
    <div id="app-header"></div>
    
    <main class="app-shell" style="padding-top: 70px;">
        <div class="page-container">
            <div class="job-detail-container">
            <a href="/jobs.html" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Zpƒõt na zak√°zky
            </a>
            
            <!-- Job Hero Card -->
            <div class="job-hero">
                <div class="job-risk-ring" id="job-risk-ring">
                    <span id="job-risk-score">‚Äî</span>
                </div>
                <div class="job-hero-content">
                    <h1 id="job-title">Naƒç√≠t√°m...</h1>
                    <div class="job-hero-meta">
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                <path d="M8 12h8M12 8v8"></path>
                            </svg>
                            <span id="job-code">‚Äî</span>
                        </div>
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span id="job-client">‚Äî</span>
                        </div>
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span id="job-location">‚Äî</span>
                        </div>
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span id="job-date">‚Äî</span>
                        </div>
                        <div class="meta-item">
                            <span id="job-status-badge" class="badge">‚Äî</span>
                        </div>
                    </div>
                    <div class="job-hero-badges" id="job-hero-badges">
                        <!-- Badges budou p≈ôid√°ny JS -->
                    </div>
                </div>
                <div class="job-hero-actions">
                    <button class="btn-primary" onclick="editJob()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Upravit
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="job-tabs">
                <button class="tab-btn active" data-tab="overview">P≈ôehled</button>
                <button class="tab-btn" data-tab="timeline">Timeline</button>
                <button class="tab-btn" data-tab="ghost-plan">Ghost pl√°n</button>
                <button class="tab-btn" data-tab="finance">Finance</button>
                <button class="tab-btn" data-tab="team">T√Ωm</button>
                <button class="tab-btn" data-tab="materials">Materi√°l</button>
                <button class="tab-btn" data-tab="tasks">√ökoly</button>
                <button class="tab-btn" data-tab="documents">Dokumenty</button>
                <button class="tab-btn" data-tab="history">Historie</button>
            </div>
            
            <!-- Tab: Overview -->
            <div class="tab-content active" id="tab-overview">
                <!-- AI Panel -->
                <div class="ai-panel" id="ai-panel">
                    <div class="ai-panel-header">
                        <div class="ai-avatar">üß†</div>
                        <div class="ai-panel-title">AI Oper√°tor</div>
                        <div class="ai-health-badge" id="ai-health-badge">Sk√≥re: ‚Äî</div>
                    </div>
                    <div class="ai-insights-list" id="ai-insights-list">
                        <!-- Rizika budou p≈ôid√°na JS -->
                    </div>
                    <div class="ai-recommendations" id="ai-recommendations">
                        <!-- Doporuƒçen√≠ budou p≈ôid√°na JS -->
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Finance
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Odhadovan√° hodnota:</span>
                            <span class="info-value" id="overview-estimated">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Skuteƒçn√© n√°klady:</span>
                            <span class="info-value" id="overview-actual">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Zb√Ωv√° rozpoƒçet:</span>
                            <span class="info-value" id="overview-remaining">‚Äî</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ƒåasov√° osa
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Zaƒç√°tek:</span>
                            <span class="info-value" id="overview-start">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Deadline:</span>
                            <span class="info-value" id="overview-deadline">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Dokonƒçen√≠:</span>
                            <span class="info-value" id="overview-completion">‚Äî</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            T√Ωm
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Velikost t√Ωmu:</span>
                            <span class="info-value" id="overview-team-size">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Miln√≠k≈Ø:</span>
                            <span class="info-value" id="overview-milestones">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Materi√°l≈Ø:</span>
                            <span class="info-value" id="overview-materials">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Timeline -->
            <div class="tab-content" id="tab-timeline">
                <div class="section-header">
                    <h2>Timeline zak√°zky</h2>
                </div>
                <div id="job-timeline-container" class="timeline-container">
                    <div class="empty-state">
                        <p>Timeline bude zobrazen po naƒçten√≠ dat</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Ghost pl√°n -->
            <div class="tab-content" id="tab-ghost-plan">
                <div class="section-header">
                    <h2>Ghost pl√°n</h2>
                    <button class="btn-secondary" onclick="generateGhostPlan()">Vygenerovat n√°vrh</button>
                </div>
                <div id="ghost-plan-container" class="ghost-plan-container">
                    <div class="empty-state">
                        <p>≈Ω√°dn√Ω ghost pl√°n. Klikni na "Vygenerovat n√°vrh" pro vytvo≈ôen√≠.</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Finance -->
            <div class="tab-content" id="tab-finance">
                <div class="section-header">
                    <h2>Finance a rozpoƒçet</h2>
                </div>
                <div class="info-grid">
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Rozpoƒçet
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Odhadovan√° hodnota:</span>
                            <span class="info-value" id="finance-estimated">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Skuteƒçn√© n√°klady:</span>
                            <span class="info-value" id="finance-actual">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Zb√Ωv√° rozpoƒçet:</span>
                            <span class="info-value" id="finance-remaining">‚Äî</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Mar≈æe:</span>
                            <span class="info-value" id="finance-margin">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Materials -->
            <div class="tab-content" id="tab-materials">
                <div class="section-header">
                    <h2>Seznam materi√°lu</h2>
                    <button class="btn-primary" onclick="openMaterialModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        P≈ôidat materi√°l
                    </button>
                </div>
                
                <div class="table-container" id="materials-table">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        <p>≈Ω√°dn√Ω materi√°l</p>
                        <button class="btn-primary" onclick="openMaterialModal()">P≈ôidat materi√°l</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Team -->
            <div class="tab-content" id="tab-team">
                <div class="section-header">
                    <h2>P≈ôi≈ôazen√Ω t√Ωm</h2>
                    <button class="btn-primary" onclick="openTeamModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        P≈ôi≈ôadit ƒçlena
                    </button>
                </div>
                
                <div class="table-container" id="team-table">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <p>≈Ω√°dn√Ω t√Ωm</p>
                        <button class="btn-primary" onclick="openTeamModal()">P≈ôi≈ôadit prvn√≠ ƒçleny</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Tasks (√ökoly) -->
            <div class="tab-content" id="tab-tasks">
                <div class="section-header">
                    <h2>√ökoly</h2>
                    <button class="btn-primary" onclick="openTaskModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        P≈ôidat √∫kol
                    </button>
                </div>
                <div id="tasks-container" class="tasks-container">
                    <div class="empty-state">
                        <p>≈Ω√°dn√© √∫koly</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Documents (Dokumenty) -->
            <div class="tab-content" id="tab-documents">
                <div class="section-header">
                    <h2>Dokumenty</h2>
                    <button class="btn-primary" onclick="openDocumentModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        P≈ôidat dokument
                    </button>
                </div>
                <div id="documents-container" class="documents-container">
                    <div class="empty-state">
                        <p>≈Ω√°dn√© dokumenty</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: History (Historie) -->
            <div class="tab-content" id="tab-history">
                <div class="section-header">
                    <h2>Historie zmƒõn</h2>
                </div>
                <div id="history-container" class="history-container">
                    <div class="timeline" id="history-timeline">
                        <div class="empty-state">
                            <p>≈Ω√°dn√° historie</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </main>
    
    <!-- Modal: Client -->
    <div class="modal" id="modal-client">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Informace o klientovi</h2>
                <button class="btn-close" onclick="closeModal('modal-client')">&times;</button>
            </div>
            <form id="form-client" onsubmit="saveClient(event)">
                <div class="form-group">
                    <label>Jm√©no klienta *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Firma</label>
                    <input type="text" name="company">
                </div>
                <div class="form-group">
                    <label>IƒåO</label>
                    <input type="text" name="ico">
                </div>
                <div class="form-group">
                    <label>DIƒå</label>
                    <input type="text" name="dic">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="tel" name="phone">
                </div>
                <div class="form-group">
                    <label>Alternativn√≠ telefon</label>
                    <input type="tel" name="phone_secondary">
                </div>
                <div class="form-group">
                    <label>Fakturaƒçn√≠ adresa</label>
                    <input type="text" name="billing_street" placeholder="Ulice a ƒç√≠slo">
                </div>
                <div class="form-group">
                    <input type="text" name="billing_city" placeholder="Mƒõsto">
                </div>
                <div class="form-group">
                    <input type="text" name="billing_zip" placeholder="PSƒå">
                </div>
                <button type="submit" class="btn-primary">Ulo≈æit</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Location -->
    <div class="modal" id="modal-location">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lokace staveni≈°tƒõ</h2>
                <button class="btn-close" onclick="closeModal('modal-location')">&times;</button>
            </div>
            <form id="form-location" onsubmit="saveLocation(event)">
                <div class="form-group">
                    <label>Ulice a ƒç√≠slo</label>
                    <input type="text" name="street">
                </div>
                <div class="form-group">
                    <label>Mƒõsto</label>
                    <input type="text" name="city">
                </div>
                <div class="form-group">
                    <label>PSƒå</label>
                    <input type="text" name="zip">
                </div>
                <div class="form-group">
                    <label>GPS - Latitude</label>
                    <input type="text" name="lat" placeholder="50.0755">
                </div>
                <div class="form-group">
                    <label>GPS - Longitude</label>
                    <input type="text" name="lng" placeholder="14.4378">
                </div>
                <div class="form-group">
                    <label>Parkov√°n√≠</label>
                    <textarea name="parking" placeholder="Popis mo≈ænost√≠ parkov√°n√≠"></textarea>
                </div>
                <div class="form-group">
                    <label>Pozn√°mky k p≈ô√≠stupu</label>
                    <textarea name="access_notes" placeholder="Kl√≠ƒçe, k√≥dy br√°ny, atd."></textarea>
                </div>
                <div class="form-group">
                    <label>K√≥d br√°ny</label>
                    <input type="text" name="gate_code">
                </div>
                <button type="submit" class="btn-primary">Ulo≈æit</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Milestone -->
    <div class="modal" id="modal-milestone">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov√Ω miln√≠k</h2>
                <button class="btn-close" onclick="closeModal('modal-milestone')">&times;</button>
            </div>
            <form id="form-milestone" onsubmit="saveMilestone(event)">
                <div class="form-group">
                    <label>N√°zev miln√≠ku *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Popis</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>Pl√°novan√© datum</label>
                    <input type="date" name="planned_date">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="pending">ƒåek√°</option>
                        <option value="in_progress">Prob√≠h√°</option>
                        <option value="completed">Dokonƒçeno</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">P≈ôidat miln√≠k</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Material -->
    <div class="modal" id="modal-material">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov√Ω materi√°l</h2>
                <button class="btn-close" onclick="closeModal('modal-material')">&times;</button>
            </div>
            <form id="form-material" onsubmit="saveMaterial(event)">
                <div class="form-group material-autocomplete-container">
                    <label>N√°zev materi√°lu * (zaƒçni ps√°t pro vyhled√°n√≠ ve skladu)</label>
                    <input type="text" id="material-name-input" name="name" autocomplete="off" required 
                           placeholder="Nap≈ô. ≈°t√≠pa, kniphofia...">
                    <div id="material-autocomplete" class="material-autocomplete-dropdown" style="
                        position: absolute;
                        width: 100%;
                        max-height: 300px;
                        overflow-y: auto;
                        background: #1a2332;
                        border: 1px solid #2d3748;
                        border-radius: 8px;
                        display: none;
                        z-index: 1000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    "></div>
                    <div id="material-info" class="material-info"></div>
                </div>
                <div class="form-group">
                    <label>Mno≈æstv√≠ *</label>
                    <input type="number" id="material-qty-input" name="quantity" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Jednotka</label>
                    <input type="text" id="material-unit-input" name="unit" value="ks" readonly>
                </div>
                <div class="form-group">
                    <label>Cena za jednotku (Kƒç)</label>
                    <input type="number" id="material-price-input" name="price_per_unit" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Dodavatel</label>
                    <input type="text" name="supplier">
                </div>
                <button type="submit" class="btn-primary">P≈ôidat materi√°l a rezervovat</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Team -->
    <div class="modal" id="modal-team">
        <div class="modal-content">
            <div class="modal-header">
                <h2>P≈ôi≈ôadit ƒçlena t√Ωmu</h2>
                <button class="btn-close" onclick="closeModal('modal-team')">&times;</button>
            </div>
            <form id="form-team" onsubmit="saveTeamMember(event)">
                <div class="form-group">
                    <label>ƒålen teamu *</label>
                    <select name="employee_id" required id="select-employee">
                        <option value="">Vyberte ƒçlena teamu</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role">
                        <option value="worker">Pracovn√≠k</option>
                        <option value="manager">Vedouc√≠</option>
                        <option value="supervisor">Dozor</option>
                        <option value="assistant">Pomocn√≠k</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pl√°novan√© hodiny</label>
                    <input type="number" name="hours_planned" value="0">
                </div>
                <button type="submit" class="btn-primary">P≈ôi≈ôadit</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Edit Job -->
    <div class="modal" id="modal-edit-job">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2>Upravit zak√°zku</h2>
                <button class="btn-close" onclick="closeModal('modal-edit-job')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-edit-job" onsubmit="saveJobEdit(event)">
                    <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
                        <div class="form-group">
                            <label>N√°zev zak√°zky *</label>
                            <input type="text" name="title" id="edit-title" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>K√≥d *</label>
                            <input type="text" name="code" id="edit-code" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Klient</label>
                        <input type="text" name="client" id="edit-client" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Adresa/Lokace</label>
                        <input type="text" name="address" id="edit-address" class="form-input">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                        <div class="form-group">
                            <label>Datum zad√°n√≠</label>
                            <input type="date" name="created_date" id="edit-created-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Datum zah√°jen√≠</label>
                            <input type="date" name="start_date" id="edit-start-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Deadline</label>
                            <input type="date" name="deadline" id="edit-deadline" class="form-input">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr;gap:16px;">
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" id="edit-status" class="form-select">
                                <option value="Pl√°n">Pl√°n</option>
                                <option value="Aktivn√≠">Aktivn√≠</option>
                                <option value="Pozastaven√©">Pozastaven√©</option>
                                <option value="Dokonƒçeno">Dokonƒçeno</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Odhadovan√° cena (Kƒç)</label>
                        <input type="number" name="estimated_value" id="edit-budget" class="form-input" min="0" step="1000" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Progress (%)</label>
                        <input type="number" name="progress" id="edit-progress" class="form-input" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label>Popis/Pozn√°mky</label>
                        <textarea name="note" id="edit-notes" class="form-textarea" rows="4"></textarea>
                    </div>
                    <div class="modal-footer" style="margin-top:20px;display:flex;justify-content:flex-end;gap:10px;">
                        <button type="button" class="btn-secondary" onclick="closeModal('modal-edit-job')">Zru≈°it</button>
                        <button type="submit" class="btn-primary">Ulo≈æit zmƒõny</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let currentJobId = null;
        let jobData = null;
        
        // Get job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentJobId = urlParams.get('id');
        
        if (!currentJobId) {
            alert('Chyb√≠ ID zak√°zky');
            window.location.href = '/jobs.html';
        }
        
        // Load job data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadJobData();
            loadEmployees();
        });
        
        // Tab switching
        function switchToTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) tabContent.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'ghost-plan') {
                loadGhostPlan();
            }
        }
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchToTab(btn.dataset.tab);
            });
        });
        
        // Handle deep-link from URL hash
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#tab-')) {
                const tabName = hash.substring(5); // Remove '#tab-'
                setTimeout(() => switchToTab(tabName), 100); // Small delay to ensure DOM is ready
            }
        });
        
        async function loadJobData() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/complete`);
                if (!response.ok) throw new Error('Failed to load job');
                
                jobData = await response.json();
                renderJobData();
                
                // Load AI insights
                loadAIInsights();
                
                // Load ghost plan if on timeline tab
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && activeTab.dataset.tab === 'ghost-plan') {
                    loadGhostPlan();
                }
            } catch (error) {
                console.error('Error loading job:', error);
                alert('Nepoda≈ôilo se naƒç√≠st zak√°zku');
            }
        }
        
        async function loadAIInsights() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ai-insights`);
                if (!response.ok) throw new Error('Failed to load AI insights');
                
                const data = await response.json();
                if (data.ok) {
                    renderAIPanel(data);
                }
            } catch (error) {
                console.error('Error loading AI insights:', error);
                // Fallback: show empty state
                renderAIPanel({
                    health_score: 0,
                    risk_score: 0,
                    insights: [],
                    recommendations: []
                });
            }
        }
        
        function renderAIPanel(data) {
            const { health_score, risk_score, insights, recommendations } = data;
            
            // Health Badge
            const healthBadge = document.getElementById('ai-health-badge');
            if (healthBadge) {
                let badgeClass = 'good';
                let badgeText = `Sk√≥re: ${health_score}`;
                
                if (health_score < 50) {
                    badgeClass = 'critical';
                    badgeText = `Sk√≥re: ${health_score} ‚ö†Ô∏è`;
                } else if (health_score < 70) {
                    badgeClass = 'attention';
                    badgeText = `Sk√≥re: ${health_score}`;
                }
                
                healthBadge.className = `ai-health-badge ${badgeClass}`;
                healthBadge.textContent = badgeText;
            }
            
            // Insights List
            const insightsList = document.getElementById('ai-insights-list');
            if (insightsList) {
                if (insights.length === 0) {
                    insightsList.innerHTML = '<div class="ai-insight-item ai-insight-item-success"><span class="insight-score">‚úì</span> ≈Ω√°dn√° rizika</div>';
                } else {
                    insightsList.innerHTML = insights.map(insight => {
                        const priorityClass = insight.priority === 'high' ? 'deadline' : 
                                             insight.type === 'budget' ? 'budget' :
                                             insight.type === 'material' ? 'material' : 'capacity';
                        return `
                            <div class="ai-insight-item ${priorityClass}">
                                <span class="insight-score">${insight.score}</span>
                                ${insight.text}
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // Recommendations
            const recommendationsContainer = document.getElementById('ai-recommendations');
            if (recommendationsContainer) {
                if (recommendations.length === 0) {
                    recommendationsContainer.innerHTML = '<div class="ai-recommendation"><div><div class="ai-recommendation-title">≈Ω√°dn√° doporuƒçen√≠</div><div class="ai-recommendation-priority">V≈°e prob√≠h√° podle pl√°nu</div></div></div>';
                } else {
                    recommendationsContainer.innerHTML = recommendations.map(rec => {
                        const actionBtn = rec.action ? `<button class="ai-recommendation-cta" onclick="handleAIRecommendation('${rec.action}')">Akce</button>` : '';
                        return `
                            <div class="ai-recommendation">
                                <div>
                                    <div class="ai-recommendation-title">${rec.icon} ${rec.title}</div>
                                    <div class="ai-recommendation-priority">${rec.text}</div>
                                </div>
                                ${actionBtn}
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function handleAIRecommendation(action) {
            switch(action) {
                case 'contact_client':
                    alert('Otev≈ô√≠t formul√°≈ô pro kontakt klienta');
                    break;
                case 'add_resources':
                    alert('Otev≈ô√≠t modal pro p≈ôid√°n√≠ zdroj≈Ø');
                    break;
                case 'order_materials':
                    // Navigate to materials tab
                    document.querySelector('[data-tab="materials"]')?.click();
                    break;
                case 'redistribute_work':
                    // Navigate to team tab
                    document.querySelector('[data-tab="team"]')?.click();
                    break;
                case 'review_budget':
                    // Navigate to finance tab
                    document.querySelector('[data-tab="finance"]')?.click();
                    break;
                default:
                    console.log('Unknown action:', action);
            }
        }
        
        function renderJobData() {
            const { job, client, location, milestones, materials, team, summary } = jobData;
            
            // Hero Card
            document.getElementById('job-title').textContent = job.title || 'Bez n√°zvu';
            document.getElementById('job-code').textContent = job.code || '‚Äî';
            document.getElementById('job-client').textContent = client?.name || job.client || '‚Äî';
            document.getElementById('job-location').textContent = location?.city || job.city || '‚Äî';
            document.getElementById('job-date').textContent = job.date || job.deadline || '‚Äî';
            
            const statusBadge = document.getElementById('job-status-badge');
            statusBadge.textContent = job.status || 'Nezn√°m√Ω';
            statusBadge.className = 'badge ' + getStatusClass(job.status);
            
            // Risk Ring
            const riskScore = calculateRiskScore(job);
            const riskRing = document.getElementById('job-risk-ring');
            const riskLevel = riskScore < 30 ? 'low' : riskScore < 70 ? 'medium' : 'high';
            riskRing.className = `job-risk-ring ${riskLevel}`;
            riskRing.querySelector('#job-risk-score').textContent = riskScore;
            
            // Hero Badges
            renderHeroBadges(job, materials);
            
            // Overview
            document.getElementById('overview-estimated').textContent = formatCurrency(job.estimated_value);
            document.getElementById('overview-actual').textContent = formatCurrency(job.actual_value);
            document.getElementById('overview-remaining').textContent = formatCurrency((job.estimated_value || 0) - (job.actual_value || 0));
            document.getElementById('overview-start').textContent = job.start_date || job.date || '‚Äî';
            document.getElementById('overview-deadline').textContent = job.deadline || '‚Äî';
            document.getElementById('overview-completion').textContent = job.actual_end_date || '‚Äî';
            document.getElementById('overview-team-size').textContent = summary.team_size || 0;
            document.getElementById('overview-milestones').textContent = `${summary.milestones_completed || 0} / ${summary.milestones_count || 0}`;
            document.getElementById('overview-materials').textContent = summary.materials_count || 0;
            
            // Finance tab
            const financeEstimated = document.getElementById('finance-estimated');
            const financeActual = document.getElementById('finance-actual');
            const financeRemaining = document.getElementById('finance-remaining');
            const financeMargin = document.getElementById('finance-margin');
            if (financeEstimated) financeEstimated.textContent = formatCurrency(job.estimated_value);
            if (financeActual) financeActual.textContent = formatCurrency(job.actual_value);
            if (financeRemaining) financeRemaining.textContent = formatCurrency((job.estimated_value || 0) - (job.actual_value || 0));
            if (financeMargin) {
                const margin = job.estimated_value && job.actual_value ? ((job.estimated_value - job.actual_value) / job.estimated_value * 100).toFixed(1) : '‚Äî';
                financeMargin.textContent = margin !== '‚Äî' ? `${margin}%` : '‚Äî';
            }
            
            // Materials
            renderMaterials(materials);
            
            // Team
            renderTeam(team);
        }
        
        function calculateRiskScore(job) {
            let score = 0;
            // Deadline risk
            if (job.deadline) {
                const daysUntil = getDaysUntilDeadline(job.deadline);
                if (daysUntil !== null && daysUntil < 0) score += 50;
                else if (daysUntil !== null && daysUntil <= 3) score += 30;
            }
            // Budget risk
            if (job.estimated_value && job.actual_value) {
                const spentPercent = (job.actual_value / job.estimated_value) * 100;
                if (spentPercent > 90) score += 40;
                else if (spentPercent > 80) score += 20;
            }
            // Progress risk
            if (job.progress !== undefined && job.deadline) {
                const daysUntil = getDaysUntilDeadline(job.deadline);
                if (daysUntil !== null && daysUntil > 0 && job.progress < (daysUntil / 30) * 100) {
                    score += 30;
                }
            }
            return Math.min(100, score);
        }
        
        function getDaysUntilDeadline(deadline) {
            if (!deadline) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function renderHeroBadges(job, materials) {
            const badgesContainer = document.getElementById('job-hero-badges');
            if (!badgesContainer) return;
            badgesContainer.innerHTML = '';
            
            // Material badge
            if (materials && materials.length > 0) {
                const missingMaterials = materials.filter(m => m.status === 'missing' || (!m.warehouse_item_id && m.status !== 'delivered'));
                if (missingMaterials.length > 0) {
                    badgesContainer.innerHTML += `<span class="badge badge-warning">üì¶ Chyb√≠ ${missingMaterials.length} materi√°l≈Ø</span>`;
                } else {
                    badgesContainer.innerHTML += `<span class="badge badge-success">üì¶ Materi√°l OK</span>`;
                }
            }
            
            // Finance badge
            if (job.estimated_value && job.actual_value) {
                const spentPercent = (job.actual_value / job.estimated_value) * 100;
                if (spentPercent > 90) {
                    badgesContainer.innerHTML += `<span class="badge badge-danger">üí∏ Rozpoƒçet >90%</span>`;
                } else if (spentPercent > 80) {
                    badgesContainer.innerHTML += `<span class="badge badge-warning">üí∏ Rozpoƒçet >80%</span>`;
                }
            }
            
            // Deadline badge
            if (job.deadline) {
                const daysUntil = getDaysUntilDeadline(job.deadline);
                if (daysUntil !== null && daysUntil < 0) {
                    badgesContainer.innerHTML += `<span class="badge badge-danger">‚è∞ Po term√≠nu</span>`;
                } else if (daysUntil !== null && daysUntil <= 3) {
                    badgesContainer.innerHTML += `<span class="badge badge-warning">‚è∞ Deadline za ${daysUntil}d</span>`;
                }
            }
        }
        
        // Ghost Plan functions
        async function generateGhostPlan() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!response.ok) throw new Error('Failed to generate ghost plan');
                
                const data = await response.json();
                if (data.ok && data.proposal) {
                    renderGhostPlan(data.proposal);
                } else {
                    alert('Nepoda≈ôilo se vygenerovat ghost pl√°n');
                }
            } catch (error) {
                console.error('Error generating ghost plan:', error);
                alert('Chyba p≈ôi generov√°n√≠ ghost pl√°nu');
            }
        }
        
        async function loadGhostPlan() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan`);
                if (!response.ok) throw new Error('Failed to load ghost plan');
                
                const data = await response.json();
                if (data.ok && data.proposal) {
                    renderGhostPlan(data.proposal);
                } else {
                    // Show empty state
                    const container = document.getElementById('ghost-plan-container');
                    if (container) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <p>≈Ω√°dn√Ω ghost pl√°n. Klikni na "Vygenerovat n√°vrh" pro vytvo≈ôen√≠.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading ghost plan:', error);
            }
        }
        
        function renderGhostPlan(proposal) {
            const container = document.getElementById('ghost-plan-container');
            if (!container) return;
            
            const timeline = JSON.parse(proposal.proposed_timeline || '[]');
            const resources = JSON.parse(proposal.proposed_resources || '[]');
            
            let html = `
                <div class="ghost-plan-item">
                    <div class="ghost-plan-header">
                        <div>
                            <div class="ghost-plan-title">${proposal.title}</div>
                            <div class="ghost-plan-description">
                                ${proposal.description || ''}
                            </div>
                        </div>
                        <div class="ghost-plan-actions">
                            <button class="btn-secondary" onclick="rejectGhostPlan(${proposal.id})">Odm√≠tnout</button>
                            <button class="btn-primary" onclick="acceptGhostPlan(${proposal.id})">P≈ôijmout</button>
                        </div>
                    </div>
                    
                    <div class="ghost-plan-section">
                        <h4 class="ghost-plan-section-title">Navr≈æen√° ƒçasov√° osa:</h4>
                        <div class="timeline">
            `;
            
            timeline.forEach((milestone, idx) => {
                html += `
                    <div class="timeline-item">
                        <div class="ghost-plan-milestone-title">
                            ${milestone.milestone}
                        </div>
                        <div class="ghost-plan-milestone-date">
                            ${new Date(milestone.date).toLocaleDateString('cs-CZ')} ‚Ä¢ ${Math.round(milestone.completion)}% dokonƒçeno
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
            `;
            
            if (resources.length > 0) {
                html += `
                    <div class="ghost-plan-section">
                        <h4 class="ghost-plan-section-title">Navr≈æen√© zdroje:</h4>
                        <div class="ghost-plan-resources-list">
                `;
                
                resources.forEach(resource => {
                    html += `
                        <div class="ghost-plan-resource-item">
                            <div class="ghost-plan-resource-name">${resource.name}</div>
                            <div class="ghost-plan-resource-hours">
                                ${resource.current_hours}h/t√Ωden ‚Üí ${resource.suggested_hours}h/t√Ωden
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    <div class="ghost-plan-footer">
                        <div class="ghost-plan-metrics">
                            <div>
                                <span class="ghost-plan-metric-label">Riziko:</span>
                                <span class="ghost-plan-metric-value">${proposal.risk_score}</span>
                            </div>
                            <div>
                                <span class="ghost-plan-metric-label">Health:</span>
                                <span class="ghost-plan-metric-value">${proposal.health_score}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function acceptGhostPlan(proposalId) {
            if (!confirm('Opravdu chce≈° p≈ôijmout tento ghost pl√°n? Zak√°zka bude aktualizov√°na podle n√°vrhu.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan/accept`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({proposal_id: proposalId})
                });
                
                if (!response.ok) throw new Error('Failed to accept ghost plan');
                
                const data = await response.json();
                if (data.ok) {
                    alert('Ghost pl√°n byl p≈ôijat. Zak√°zka byla aktualizov√°na.');
                    loadGhostPlan(); // Reload to show updated state
                    loadJobData(); // Reload job data
                }
            } catch (error) {
                console.error('Error accepting ghost plan:', error);
                alert('Chyba p≈ôi p≈ôij√≠m√°n√≠ ghost pl√°nu');
            }
        }
        
        async function rejectGhostPlan(proposalId) {
            if (!confirm('Opravdu chce≈° odm√≠tnout tento ghost pl√°n?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan/reject`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({proposal_id: proposalId})
                });
                
                if (!response.ok) throw new Error('Failed to reject ghost plan');
                
                const data = await response.json();
                if (data.ok) {
                    loadGhostPlan(); // Reload to show empty state
                }
            } catch (error) {
                console.error('Error rejecting ghost plan:', error);
                alert('Chyba p≈ôi odm√≠t√°n√≠ ghost pl√°nu');
            }
        }
        
        function openTaskModal() {
            alert('P≈ôid√°n√≠ √∫kolu bude implementov√°no');
        }
        
        function openDocumentModal() {
            alert('P≈ôid√°n√≠ dokumentu bude implementov√°no');
        }
        
        function renderClient(client) {
            const container = document.getElementById('client-info');
            if (!client || !client.name) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>≈Ω√°dn√© informace o klientovi</p>
                        <button class="btn-primary" onclick="openClientModal()">P≈ôidat informace</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Jm√©no:</span>
                    <span class="info-value">${client.name}</span>
                </div>
                ${client.company ? `<div class="info-row"><span class="info-label">Firma:</span><span class="info-value">${client.company}</span></div>` : ''}
                ${client.ico ? `<div class="info-row"><span class="info-label">IƒåO:</span><span class="info-value">${client.ico}</span></div>` : ''}
                ${client.dic ? `<div class="info-row"><span class="info-label">DIƒå:</span><span class="info-value">${client.dic}</span></div>` : ''}
                ${client.email ? `<div class="info-row"><span class="info-label">Email:</span><span class="info-value">${client.email}</span></div>` : ''}
                ${client.phone ? `<div class="info-row"><span class="info-label">Telefon:</span><span class="info-value">${client.phone}</span></div>` : ''}
                ${client.phone_secondary ? `<div class="info-row"><span class="info-label">Alt. telefon:</span><span class="info-value">${client.phone_secondary}</span></div>` : ''}
                ${client.billing_street ? `<div class="info-row"><span class="info-label">Adresa:</span><span class="info-value">${client.billing_street}, ${client.billing_city} ${client.billing_zip}</span></div>` : ''}
            `;
        }
        
        function renderLocation(location) {
            const container = document.getElementById('location-info');
            if (!location || !location.street) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>≈Ω√°dn√© informace o lokaci</p>
                        <button class="btn-primary" onclick="openLocationModal()">P≈ôidat informace</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Adresa:</span>
                    <span class="info-value">${location.street}, ${location.city} ${location.zip || ''}</span>
                </div>
                ${location.lat && location.lng ? `<div class="info-row"><span class="info-label">GPS:</span><span class="info-value">${location.lat}, ${location.lng}</span></div>` : ''}
                ${location.parking ? `<div class="info-row"><span class="info-label">Parkov√°n√≠:</span><span class="info-value">${location.parking}</span></div>` : ''}
                ${location.gate_code ? `<div class="info-row"><span class="info-label">K√≥d br√°ny:</span><span class="info-value">${location.gate_code}</span></div>` : ''}
                ${location.access_notes ? `<div class="info-row"><span class="info-label">P≈ô√≠stup:</span><span class="info-value">${location.access_notes}</span></div>` : ''}
            `;
        }
        
        function renderMilestones(milestones) {
            const container = document.getElementById('milestones-list');
            if (!milestones || milestones.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>≈Ω√°dn√© miln√≠ky</p>
                        <button class="btn-primary" onclick="openMilestoneModal()">P≈ôidat prvn√≠ miln√≠k</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = milestones.map(m => `
                <div class="timeline-item ${m.status}">
                    <div class="timeline-date">${m.planned_date || '‚Äî'}</div>
                    <div class="timeline-title">${m.name}</div>
                    ${m.description ? `<p>${m.description}</p>` : ''}
                    <span class="badge ${getStatusClass(m.status)}">${getStatusLabel(m.status)}</span>
                </div>
            `).join('');
        }
        
        function renderMaterials(materials) {
            const container = document.getElementById('materials-table');
            if (!materials || materials.length === 0) {
                container.innerHTML = `
                    <div style="padding:60px;text-align:center;color:#9ca3af;">
                        <div style="font-size:48px;margin-bottom:16px;">üì¶</div>
                        <div style="font-size:16px;margin-bottom:16px;">Zat√≠m ≈æ√°dn√Ω materi√°l</div>
                        <button class="btn-primary" onclick="openMaterialModal()">P≈ôidat prvn√≠ materi√°l</button>
                    </div>
                `;
                return;
            }
            
            // U≈Ω≈†√ç elegantn√≠ tabulka
            container.innerHTML = `
                <div style="background:#1e293b;border-radius:8px;overflow:hidden;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="background:#0f172a;border-bottom:1px solid #334155;">
                                <th style="padding:8px 12px;text-align:left;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;">Materi√°l</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:100px;">Mno≈æstv√≠</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:90px;">Cena/jedn</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:100px;">Celkem</th>
                                <th style="padding:8px 12px;text-align:left;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:140px;">Dodavatel</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:120px;">Status</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:60px;">Akce</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${materials.map(m => {
                                const qty = m.qty || m.quantity || 0;
                                const price = m.price || m.price_per_unit || 0;
                                const total = qty * price;
                                const isReserved = m.warehouse_item_id ? true : false;
                                const status = m.status || 'planned';
                                
                                const statusColors = {
                                    'planned': '#9ca3af',
                                    'ordered': '#60a5fa',
                                    'delivered': '#34d399',
                                    'used': '#a78bfa'
                                };
                                
                                const statusLabels = {
                                    'planned': 'Pl√°nov√°no',
                                    'ordered': 'Objedn√°no',
                                    'delivered': 'Dod√°no',
                                    'used': 'Pou≈æito'
                                };
                                
                                return `
                                <tr style="border-bottom:1px solid #334155;" onmouseenter="this.style.background='#334155'" onmouseleave="this.style.background='transparent'">
                                    <td style="padding:10px 12px;">
                                        <div style="display:flex;align-items:center;gap:6px;">
                                            ${isReserved ? '<span style="font-size:16px;">üì¶</span>' : '<span style="font-size:16px;">üìã</span>'}
                                            <div>
                                                <div style="font-weight:600;color:white;">${escapeHtml(m.name)}</div>
                                                <div style="font-size:11px;color:#9ca3af;margin-top:2px;">
                                                    ${isReserved ? '<span style="color:#9fd4a1;">Ze skladu</span>' : ''}
                                                    ${m.warehouse_location ? ` ‚Ä¢ <svg style="width:12px;height:12px;display:inline-block;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${escapeHtml(m.warehouse_location)}` : ''}
                                                    ${isReserved && m.reserved_qty ? ` ‚Ä¢ <svg style="width:12px;height:12px;display:inline-block;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> ${m.reserved_qty}${m.unit}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding:8px 10px;text-align:center;">
                                        <div id="material-qty-${m.id}" 
                                              onclick="editMaterialField(${m.id}, 'qty', ${qty})"
                                              style="cursor:pointer;padding:3px 6px;font-weight:600;color:white;border-radius:4px;display:inline-block;background:#0f172a;border:2px solid transparent;"
                                              onmouseenter="this.style.borderColor='#9fd4a1'"
                                              onmouseleave="this.style.borderColor='transparent'">
                                            ${qty.toFixed(2)} ${escapeHtml(m.unit || 'ks')}
                                        </div>
                                    </td>
                                    <td style="padding:8px 10px;text-align:center;">
                                        <div id="material-price-${m.id}" 
                                              onclick="editMaterialField(${m.id}, 'price', ${price})"
                                              style="cursor:pointer;padding:3px 6px;font-weight:600;color:white;border-radius:4px;display:inline-block;background:#0f172a;border:2px solid transparent;"
                                              onmouseenter="this.style.borderColor='#9fd4a1'"
                                              onmouseleave="this.style.borderColor='transparent'">
                                            ${price.toFixed(2)} Kƒç
                                        </div>
                                    </td>
                                    <td style="padding:10px 12px;text-align:center;">
                                        <span style="font-weight:700;color:#9fd4a1;">${total.toFixed(2)} Kƒç</span>
                                    </td>
                                    <td style="padding:8px 10px;">
                                        <div id="material-supplier-${m.id}" 
                                              onclick="editMaterialField(${m.id}, 'supplier', '${escapeHtml(m.supplier || '')}')"
                                              style="cursor:pointer;padding:4px 8px;color:white;border-radius:4px;display:inline-block;background:#0f172a;border:2px solid transparent;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                                              onmouseenter="this.style.borderColor='#9fd4a1'"
                                              onmouseleave="this.style.borderColor='transparent'"
                                              title="${escapeHtml(m.supplier || 'Klikni pro √∫pravu')}">
                                            ${m.supplier ? escapeHtml(m.supplier) : '<span style="color:#6b7280;">klikni</span>'}
                                        </div>
                                    </td>
                                    <td style="padding:10px 12px;text-align:center;">
                                        <select onchange="updateMaterialStatus(${m.id}, this.value)" 
                                                style="background:${statusColors[status]};color:white;border:none;padding:5px 10px;border-radius:4px;font-size:12px;font-weight:600;cursor:pointer;width:100%;">
                                            ${Object.keys(statusLabels).map(s => 
                                                `<option value="${s}" ${s === status ? 'selected' : ''}>${statusLabels[s]}</option>`
                                            ).join('')}
                                        </select>
                                    </td>
                                    <td style="padding:10px 12px;text-align:center;">
                                        <button onclick="deleteMaterial(${m.id})" 
                                                style="background:#ef4444;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;"
                                                onmouseenter="this.style.background='#dc2626'"
                                                onmouseleave="this.style.background='#ef4444'"
                                                title="Smazat${isReserved ? ' a uvolnit rezervaci' : ''}">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Editace pole materi√°lu
        let editingMaterialField = null;
        
        function editMaterialField(materialId, field, currentValue) {
            if (editingMaterialField) {
                cancelMaterialEdit();
            }
            
            const div = document.getElementById(`material-${field}-${materialId}`);
            if (!div) return;
            
            const originalHTML = div.innerHTML;
            const inputType = (field === 'qty' || field === 'price') ? 'number' : 'text';
            
            editingMaterialField = { materialId, field, div, originalValue: currentValue, originalHTML };
            
            const input = document.createElement('input');
            input.type = inputType;
            input.value = currentValue;
            input.style.cssText = `
                width: 100%;
                padding: 4px 8px;
                background: #0f172a;
                border: 2px solid #9fd4a1;
                border-radius: 4px;
                color: white;
                font-size: 13px;
                font-weight: 600;
                box-shadow: 0 0 0 3px rgba(159,212,161,0.2);
            `;
            
            if (inputType === 'number') {
                input.step = '0.01';
                input.min = '0';
            }
            
            div.innerHTML = '';
            div.appendChild(input);
            
            input.focus();
            if (inputType === 'text') input.select();
            
            input.onblur = () => saveMaterialField();
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveMaterialField();
                } else if (e.key === 'Escape') {
                    cancelMaterialEdit();
                }
            };
        }
        
        async function saveMaterialField() {
            if (!editingMaterialField) return;
            
            const { materialId, field, div } = editingMaterialField;
            const input = div.querySelector('input');
            if (!input) return;
            
            const newValue = input.type === 'number' ? parseFloat(input.value) || 0 : input.value.trim();
            
            if (newValue === editingMaterialField.originalValue) {
                cancelMaterialEdit();
                return;
            }
            
            // Mapov√°n√≠ n√°zv≈Ø pol√≠ pro API
            const fieldMapping = {
                'qty': 'quantity',
                'price': 'price_per_unit',
                'supplier': 'supplier'
            };
            const apiField = fieldMapping[field] || field;
            
            try {
                const jobId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/jobs/${jobId}/materials/${materialId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [apiField]: newValue })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update');
                }
                
                await loadJobData();
                editingMaterialField = null;
            } catch (error) {
                console.error('Update error:', error);
                alert('Chyba: ' + error.message);
                cancelMaterialEdit();
            }
        }
        
        function cancelMaterialEdit() {
            if (!editingMaterialField) return;
            editingMaterialField.div.innerHTML = editingMaterialField.originalHTML;
            editingMaterialField = null;
        }
        
        async function updateMaterialStatus(materialId, newStatus) {
            try {
                const jobId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/jobs/${jobId}/materials/${materialId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update status');
                }
                
                await loadJobData();
            } catch (error) {
                console.error('Status update error:', error);
                alert('Chyba p≈ôi zmƒõnƒõ statusu: ' + error.message);
                await loadJobData();
            }
        }
        
        async function deleteMaterial(materialId) {
            const material = jobData.materials.find(m => m.id === materialId);
            const isReserved = material && material.warehouse_item_id;
            
            const confirmMsg = isReserved 
                ? 'Opravdu smazat tento materi√°l?\n\nRezervace ze skladu bude automaticky uvolnƒõna.' 
                : 'Opravdu smazat tento materi√°l?';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                const jobId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/jobs/${jobId}/materials/${materialId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                await loadJobData();
                alert(isReserved ? 'Materi√°l smaz√°n a rezervace uvolnƒõna' : 'Materi√°l smaz√°n');
            } catch (error) {
                console.error('Delete error:', error);
                alert('Chyba p≈ôi maz√°n√≠: ' + error.message);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function renderTeam(team) {
            const container = document.getElementById('team-table');
            if (!team || team.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>≈Ω√°dn√Ω t√Ωm</p>
                        <button class="btn-primary" onclick="openTeamModal()">P≈ôi≈ôadit prvn√≠ ƒçleny</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Jm√©no</th>
                            <th>Pozice</th>
                            <th>Role</th>
                            <th>Hodiny</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${team.map(t => `
                            <tr>
                                <td>${t.employee_name || '‚Äî'}</td>
                                <td>${t.position || '‚Äî'}</td>
                                <td>${t.role || '‚Äî'}</td>
                                <td>${t.hours_actual || 0} / ${t.hours_planned || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Modal functions
        function openClientModal() {
            const modal = document.getElementById('modal-client');
            const form = document.getElementById('form-client');
            
            if (jobData.client) {
                form.name.value = jobData.client.name || '';
                form.company.value = jobData.client.company || '';
                form.ico.value = jobData.client.ico || '';
                form.dic.value = jobData.client.dic || '';
                form.email.value = jobData.client.email || '';
                form.phone.value = jobData.client.phone || '';
                form.phone_secondary.value = jobData.client.phone_secondary || '';
                form.billing_street.value = jobData.client.billing_street || '';
                form.billing_city.value = jobData.client.billing_city || '';
                form.billing_zip.value = jobData.client.billing_zip || '';
            }
            
            modal.classList.add('active');
        }
        
        function openLocationModal() {
            const modal = document.getElementById('modal-location');
            const form = document.getElementById('form-location');
            
            if (jobData.location) {
                form.street.value = jobData.location.street || '';
                form.city.value = jobData.location.city || '';
                form.zip.value = jobData.location.zip || '';
                form.lat.value = jobData.location.lat || '';
                form.lng.value = jobData.location.lng || '';
                form.parking.value = jobData.location.parking || '';
                form.access_notes.value = jobData.location.access_notes || '';
                form.gate_code.value = jobData.location.gate_code || '';
            }
            
            modal.classList.add('active');
        }
        
        function openMilestoneModal() {
            document.getElementById('modal-milestone').classList.add('active');
        }
        
        function openMaterialModal() {
            document.getElementById('modal-material').classList.add('active');
        }
        
        function openTeamModal() {
            document.getElementById('modal-team').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Save functions
        async function saveClient(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/client`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-client');
                loadJobData();
                alert('Klient ulo≈æen');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba p≈ôi ukl√°d√°n√≠');
            }
        }
        
        async function saveLocation(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/location`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-location');
                loadJobData();
                alert('Lokace ulo≈æena');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba p≈ôi ukl√°d√°n√≠');
            }
        }
        
        async function saveMilestone(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/milestones`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-milestone');
                e.target.reset();
                loadJobData();
                alert('Miln√≠k p≈ôid√°n');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba p≈ôi ukl√°d√°n√≠');
            }
        }
        
        async function saveMaterial(e) {
            e.preventDefault();
            const form = e.target;
            const nameInput = document.getElementById('material-name-input');
            const qtyInput = document.getElementById('material-qty-input');
            const warehouseItemId = nameInput.dataset.warehouseItemId;
            const jobId = new URLSearchParams(window.location.search).get('id');
            
            if (!jobId) return;
            
            const data = {
                name: form.name.value,
                quantity: parseFloat(form.quantity.value) || 0,
                unit: form.unit.value,
                price_per_unit: parseFloat(form.price_per_unit.value) || 0,
                supplier: form.supplier.value
            };
            
            // Pokud je vybr√°na polo≈æka ze skladu, pou≈æij rezervaƒçn√≠ endpoint
            if (warehouseItemId) {
                try {
                    const response = await fetch(`/api/jobs/${jobId}/materials/reserve`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            warehouse_item_id: parseInt(warehouseItemId),
                            qty: data.quantity
                        })
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        alert('Materi√°l rezervov√°n ze skladu!');
                        closeModal('modal-material');
                        form.reset();
                        delete nameInput.dataset.warehouseItemId;
                        document.getElementById('material-info').style.display = 'none';
                        loadJobData(); // Reload data
                    } else {
                        alert('Chyba: ' + (result.error || 'Nepoda≈ôilo se rezervovat'));
                    }
                } catch (error) {
                    console.error('Reserve error:', error);
                    alert('Chyba p≈ôi rezervaci materi√°lu');
                }
            } else {
                // Standardn√≠ p≈ôid√°n√≠ bez rezervace
                try {
                    const response = await fetch(`/api/jobs/${jobId}/materials`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        alert('Materi√°l p≈ôid√°n!');
                        closeModal('modal-material');
                        form.reset();
                        loadJobData();
                    }
                } catch (error) {
                    console.error('Save error:', error);
                }
            }
        }
        
        async function saveTeamMember(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/team`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-team');
                e.target.reset();
                loadJobData();
                alert('ƒålen t√Ωmu p≈ôi≈ôazen');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba p≈ôi ukl√°d√°n√≠');
            }
        }
        
        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees');
                const data = await response.json();
                const employees = Array.isArray(data) ? data : (data.employees || []);
                
                const select = document.getElementById('select-employee');
                select.innerHTML = '<option value="">Vyberte ƒçlena teamu</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }
        
        // Helper functions
        function formatCurrency(value) {
            if (!value) return '0 Kƒç';
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                minimumFractionDigits: 0
            }).format(value);
        }
        
        function getStatusClass(status) {
            const map = {
                'completed': 'badge-success',
                'in_progress': 'badge-info',
                'pending': 'badge-warning',
                'delivered': 'badge-success',
                'Aktivn√≠': 'badge-success',
                'Dokonƒçen√©': 'badge-info',
                'Pl√°n': 'badge-warning'
            };
            return map[status] || 'badge-info';
        }
        
        function getStatusLabel(status) {
            const map = {
                'pending': 'ƒåek√°',
                'in_progress': 'Prob√≠h√°',
                'completed': 'Hotovo'
            };
            return map[status] || status;
        }
        
        // Edit job function
        function editJob() {
            const modal = document.getElementById('modal-edit-job');
            if (!modal) return;
            
            if (jobData && jobData.job) {
                const job = jobData.job;
                
                // Mapuj status zpƒõt na ƒçeskou hodnotu pokud je intern√≠
                const statusMap = {
                    'new': 'Pl√°n',
                    'active': 'Aktivn√≠',
                    'paused': 'Pozastaven√©',
                    'completed': 'Dokonƒçeno',
                    'Pl√°n': 'Pl√°n',
                    'Aktivn√≠': 'Aktivn√≠',
                    'Pozastaven√©': 'Pozastaven√©',
                    'Dokonƒçeno': 'Dokonƒçeno',
                    'Prob√≠h√°': 'Aktivn√≠'
                };
                
                document.getElementById('edit-title').value = job.title || job.name || '';
                document.getElementById('edit-code').value = job.code || '';
                document.getElementById('edit-client').value = jobData.client?.name || job.client || '';
                document.getElementById('edit-address').value = jobData.location?.city || jobData.location?.address || job.city || job.address || '';
                document.getElementById('edit-deadline').value = job.date || job.deadline ? (job.date || job.deadline).split('T')[0] : '';
                document.getElementById('edit-created-date').value = job.created_date ? job.created_date.split('T')[0] : '';
                document.getElementById('edit-start-date').value = job.start_date ? job.start_date.split('T')[0] : '';
                document.getElementById('edit-status').value = statusMap[job.status] || 'Pl√°n';
                document.getElementById('edit-budget').value = job.estimated_value || job.budget || 0;
                document.getElementById('edit-progress').value = job.progress || job.completion_percentage || 0;
                document.getElementById('edit-notes').value = job.note || job.notes || '';
            }
            
            modal.classList.add('active');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        }
        
        async function saveJobEdit(e) {
            e.preventDefault();
            
            if (!currentJobId) return;
            
            // Validace formul√°≈ôe
            const title = document.getElementById('edit-title').value.trim();
            if (!title) {
                if (typeof showToast === 'function') {
                    showToast('N√°zev zak√°zky je povinn√Ω', 'error');
                } else {
                    alert('N√°zev zak√°zky je povinn√Ω');
                }
                document.getElementById('edit-title').focus();
                return;
            }
            
            // Mapuj status z ƒçesk√©ho n√°zvu na intern√≠ hodnotu
            const statusMapReverse = {
                'Pl√°n': 'new',
                'Aktivn√≠': 'active',
                'Pozastaven√©': 'paused',
                'Dokonƒçeno': 'completed'
            };
            
            // Validace dat
            const createdDate = document.getElementById('edit-created-date').value;
            const startDate = document.getElementById('edit-start-date').value;
            const deadline = document.getElementById('edit-deadline').value;
            
            if (createdDate && startDate) {
                if (new Date(startDate) < new Date(createdDate)) {
                    if (typeof showToast === 'function') {
                        showToast('Datum zah√°jen√≠ mus√≠ b√Ωt po datu zad√°n√≠', 'error');
                    } else {
                        alert('Datum zah√°jen√≠ mus√≠ b√Ωt po datu zad√°n√≠');
                    }
                    document.getElementById('edit-start-date').focus();
                    return;
                }
            }
            
            if (startDate && deadline) {
                if (new Date(deadline) < new Date(startDate)) {
                    if (typeof showToast === 'function') {
                        showToast('Deadline mus√≠ b√Ωt po datu zah√°jen√≠', 'error');
                    } else {
                        alert('Deadline mus√≠ b√Ωt po datu zah√°jen√≠');
                    }
                    document.getElementById('edit-deadline').focus();
                    return;
                }
            }
            
            const statusValue = document.getElementById('edit-status').value;
            const mappedStatus = statusMapReverse[statusValue] || 'new';
            const progressValue = parseInt(document.getElementById('edit-progress').value) || 0;
            const budget = parseInt(document.getElementById('edit-budget').value) || 0;
            
            const updateData = {
                id: parseInt(currentJobId),
                title: title,
                code: document.getElementById('edit-code').value.trim(),
                client: document.getElementById('edit-client').value.trim(),
                city: document.getElementById('edit-address').value.trim(),
                date: deadline || null,
                created_date: createdDate && createdDate.trim() ? new Date(createdDate).toISOString().split('T')[0] : null,
                start_date: startDate && startDate.trim() ? new Date(startDate).toISOString().split('T')[0] : null,
                status: mappedStatus,
                note: document.getElementById('edit-notes').value.trim(),
                progress: progressValue,
                estimated_value: budget
            };
            
            try {
                if (typeof showLoading === 'function') showLoading('Ukl√°d√°m zmƒõny...');
                
                const response = await fetch('/api/jobs', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (typeof hideLoading === 'function') hideLoading();
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save');
                }
                
                closeModal('modal-edit-job');
                await loadJobData(); // Reload data na str√°nce
                
                if (typeof showToast === 'function') {
                    showToast('Zak√°zka ulo≈æena', 'success');
                } else {
                    alert('Zak√°zka ulo≈æena');
                }
            } catch (error) {
                console.error('Error:', error);
                if (typeof showToast === 'function') {
                    showToast('Chyba p≈ôi ukl√°d√°n√≠: ' + error.message, 'error');
                } else {
                    alert('Chyba p≈ôi ukl√°d√°n√≠: ' + error.message);
                }
            }
        }
        
        // Initialize on load
        loadJobData();
    </script>
<script src="/static/js/job-materials-autocomplete.js"></script>
<script src="/static/js/ai-jobs-integration.js"></script>
    <script src="/static/app-sidebar.js"></script>
</body>
</html>
