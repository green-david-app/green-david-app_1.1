<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Detail zakázky - Green David</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/glass-design.css">
    <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/job-detail.css">
    <script src="/app-settings.js"></script>
    <script src="/static/app-header.js"></script>
    <style>
        .job-detail-container {
            /* max-width a margin jsou už v .page-container, jen odstraníme padding */
            padding: 0;
        }
        
        .job-header {
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
        }
        
        .job-header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        
        .job-meta {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meta-item svg {
            width: 20px;
            height: 20px;
            stroke: #4ade80;
        }
        
        .job-tabs {
            display: flex;
            gap: 4px;
            margin-top: 28px;
            margin-bottom: 24px;
            padding-top: 0;
            padding-bottom: 14px;
            border-bottom: 2px solid #2d3748;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 8px 20px 18px;
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: #4ade80;
            border-bottom-color: #4ade80;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: #1a2332;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2d3748;
        }
        
        .info-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #4ade80;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #2d3748;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #a0aec0;
        }
        
        .info-value {
            color: white;
            font-weight: 500;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            margin: 0;
            color: white;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #2d3748;
        }
        
        .timeline-item {
            position: relative;
            padding: 15px 20px;
            margin-bottom: 15px;
            background: #1a2332;
            border-radius: 8px;
            border-left: 3px solid #4ade80;
        }
        
        .timeline-item.completed {
            border-left-color: #22c55e;
        }
        
        .timeline-item.pending {
            border-left-color: #ecc94b;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ade80;
            border: 3px solid #0d1117;
        }
        
        .timeline-date {
            color: #a0aec0;
            font-size: 14px;
        }
        
        .timeline-title {
            color: white;
            font-weight: 600;
            margin: 5px 0;
        }
        
        .table-container {
            background: #1a2332;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: #2d3748;
            color: #4ade80;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .table td {
            padding: 12px;
            color: white;
            border-bottom: 1px solid #2d3748;
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #22c55e;
            color: white;
        }
        
        .badge-warning {
            background: #ecc94b;
            color: #1a2332;
        }
        
        .badge-info {
            background: #4299e1;
            color: white;
        }
        
        .badge-danger {
            background: #f56565;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: #4a5568;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon-edit {
            background: #4299e1;
        }
        
        .btn-icon-delete {
            background: #f56565;
        }
        
        .btn-icon svg {
            width: 18px;
            height: 18px;
            stroke: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.3s;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a2332;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: white;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 24px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #a0aec0;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2d3748;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-body {
            padding: 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2d3748;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #4a5568;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #5a6578;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #4ade80;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
</head>
<body class="has-sidebar">
    <div id="app-sidebar"></div>
    <div id="app-header"></div>
    
    <main class="app-shell" style="padding-top: 70px;">
        <div class="page-container">
            <div class="job-detail-container">
            <a href="/jobs.html" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Zpět na zakázky
            </a>
            
            <!-- Job Hero Card -->
            <div class="job-hero">
                <div class="job-risk-ring" id="job-risk-ring">
                    <span id="job-risk-score">—</span>
                </div>
                <div class="job-hero-content">
                    <h1 id="job-title">Načítám...</h1>
                    <span id="job-type-badge" style="display:none;"></span>
                    <div class="job-hero-meta">
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                <path d="M8 12h8M12 8v8"></path>
                            </svg>
                            <span id="job-code">—</span>
                        </div>
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span id="job-client">—</span>
                        </div>
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span id="job-location">—</span>
                        </div>
                        <div class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span id="job-date">—</span>
                        </div>
                        <div class="meta-item">
                            <span id="job-status-badge" class="badge">—</span>
                        </div>
                    </div>
                    <div class="job-hero-badges" id="job-hero-badges">
                        <!-- Badges budou přidány JS -->
                    </div>
                </div>
                <div class="job-hero-actions">
                    <button class="btn-primary" onclick="editJob()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Upravit
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="job-tabs" style="margin-top:28px;padding-bottom:14px;">
                <button class="tab-btn active" data-tab="overview">Přehled</button>
                <button class="tab-btn" data-tab="timeline">Timeline</button>
                <button class="tab-btn" data-tab="ghost-plan">Ghost plán</button>
                <button class="tab-btn" data-tab="finance">Finance</button>
                <button class="tab-btn" data-tab="team">Tým</button>
                <button class="tab-btn" data-tab="materials">Materiál</button>
                <button class="tab-btn" data-tab="tasks">Úkoly</button>
                <button class="tab-btn" data-tab="documents">Dokumenty</button>
                <button class="tab-btn" data-tab="notes">Poznámky</button>
                <button class="tab-btn" data-tab="history">Historie</button>
            </div>
            
            <!-- Tab: Overview -->
            <div class="tab-content active" id="tab-overview">
                <!-- AI Panel - populated by ai-jobs-integration.js -->
                <div class="ai-panel" id="ai-panel">
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.3);font-size:13px;">Načítám AI analýzu...</div>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Finance
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Odhadovaná hodnota:</span>
                            <span class="info-value" id="overview-estimated">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Skutečné náklady:</span>
                            <span class="info-value" id="overview-actual">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Zbývá rozpočet:</span>
                            <span class="info-value" id="overview-remaining">—</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Časová osa
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Začátek:</span>
                            <span class="info-value" id="overview-start">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Deadline:</span>
                            <span class="info-value" id="overview-deadline">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Dokončení:</span>
                            <span class="info-value" id="overview-completion">—</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Tým
                        </h3>
                        <div class="info-row">
                            <span class="info-label">Velikost týmu:</span>
                            <span class="info-value" id="overview-team-size">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Milníků:</span>
                            <span class="info-value" id="overview-milestones">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Materiálů:</span>
                            <span class="info-value" id="overview-materials">—</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Timeline -->
            <div class="tab-content" id="tab-timeline">
                <div class="section-header">
                    <h2>Timeline zakázky</h2>
                </div>
                <div id="job-timeline-container" class="timeline-container">
                    <div class="empty-state">
                        <p>Timeline bude zobrazen po načtení dat</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Ghost plán -->
            <div class="tab-content" id="tab-ghost-plan">
                <div class="section-header">
                    <h2>Ghost plán</h2>
                    <button class="btn-secondary" onclick="generateGhostPlan()">Vygenerovat návrh</button>
                </div>
                <div id="ghost-plan-container" class="ghost-plan-container">
                    <div class="empty-state">
                        <p>Žádný ghost plán. Klikni na "Vygenerovat návrh" pro vytvoření.</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Finance -->
            <div class="tab-content" id="tab-finance">
                <div id="budget-kpi" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px;"></div>
                <div id="budget-block-material"></div>
                <div id="budget-block-labor"></div>
                <div id="budget-block-extras"></div>
            </div>
            
            <!-- Tab: Materials -->
            <div class="tab-content" id="tab-materials">
                <div class="section-header">
                    <h2>Seznam materiálu</h2>
                    <button class="btn-primary" onclick="openMaterialModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Přidat materiál
                    </button>
                </div>
                
                <div class="table-container" id="materials-table">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        <p>Žádný materiál</p>
                        <button class="btn-primary" onclick="openMaterialModal()">Přidat materiál</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Team -->
            <div class="tab-content" id="tab-team">
                <div class="section-header">
                    <h2>Přiřazený tým</h2>
                    <button class="btn-primary" onclick="openTeamModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Přiřadit člena
                    </button>
                </div>
                
                <div class="table-container" id="team-table">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <p>Žádný tým</p>
                        <button class="btn-primary" onclick="openTeamModal()">Přiřadit první členy</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Tasks (Úkoly) -->
            <div class="tab-content" id="tab-tasks">
                <div class="section-header">
                    <h2>Úkoly</h2>
                    <button class="btn-primary" onclick="openTaskModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Přidat úkol
                    </button>
                </div>
                <div id="tasks-container" class="tasks-container">
                    <div class="empty-state">
                        <p>Žádné úkoly</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Documents (Dokumenty) -->
            <div class="tab-content" id="tab-documents">
                <div class="section-header">
                    <h2>Dokumenty</h2>
                    <button class="btn-primary" onclick="openDocumentModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Přidat dokument
                    </button>
                </div>
                <div id="documents-container" class="documents-container">
                    <div class="empty-state">
                        <p>Žádné dokumenty</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Poznámky -->
            <div class="tab-content" id="tab-notes">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h2 style="display:flex;align-items:center;gap:10px;font-size:18px;font-weight:600;margin:0;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/>
                        </svg>
                        Poznámky k zakázce
                    </h2>
                    <button class="btn-primary" onclick="openJobNoteModal()" style="display:flex;align-items:center;gap:6px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nová poznámka
                    </button>
                </div>
                <div id="job-notes-list"></div>
            </div>
            
            <!-- Tab: History (Historie) -->
            <div class="tab-content" id="tab-history">
                <div class="section-header">
                    <h2>Historie změn</h2>
                </div>
                <div id="history-container" class="history-container">
                    <div class="timeline" id="history-timeline">
                        <div class="empty-state">
                            <p>Žádná historie</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </main>
    
    <!-- Modal: Client -->
    <div class="modal" id="modal-client">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Informace o klientovi</h2>
                <button class="btn-close" onclick="closeModal('modal-client')">&times;</button>
            </div>
            <form id="form-client" onsubmit="saveClient(event)">
                <div class="form-group">
                    <label>Jméno klienta *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Firma</label>
                    <input type="text" name="company">
                </div>
                <div class="form-group">
                    <label>IČO</label>
                    <input type="text" name="ico">
                </div>
                <div class="form-group">
                    <label>DIČ</label>
                    <input type="text" name="dic">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="tel" name="phone">
                </div>
                <div class="form-group">
                    <label>Alternativní telefon</label>
                    <input type="tel" name="phone_secondary">
                </div>
                <div class="form-group">
                    <label>Fakturační adresa</label>
                    <input type="text" name="billing_street" placeholder="Ulice a číslo">
                </div>
                <div class="form-group">
                    <input type="text" name="billing_city" placeholder="Město">
                </div>
                <div class="form-group">
                    <input type="text" name="billing_zip" placeholder="PSČ">
                </div>
                <button type="submit" class="btn-primary">Uložit</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Location -->
    <div class="modal" id="modal-location">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lokace staveniště</h2>
                <button class="btn-close" onclick="closeModal('modal-location')">&times;</button>
            </div>
            <form id="form-location" onsubmit="saveLocation(event)">
                <div class="form-group">
                    <label>Ulice a číslo</label>
                    <input type="text" name="street">
                </div>
                <div class="form-group">
                    <label>Město</label>
                    <input type="text" name="city">
                </div>
                <div class="form-group">
                    <label>PSČ</label>
                    <input type="text" name="zip">
                </div>
                <div class="form-group">
                    <label>GPS - Latitude</label>
                    <input type="text" name="lat" placeholder="50.0755">
                </div>
                <div class="form-group">
                    <label>GPS - Longitude</label>
                    <input type="text" name="lng" placeholder="14.4378">
                </div>
                <div class="form-group">
                    <label>Parkování</label>
                    <textarea name="parking" placeholder="Popis možností parkování"></textarea>
                </div>
                <div class="form-group">
                    <label>Poznámky k přístupu</label>
                    <textarea name="access_notes" placeholder="Klíče, kódy brány, atd."></textarea>
                </div>
                <div class="form-group">
                    <label>Kód brány</label>
                    <input type="text" name="gate_code">
                </div>
                <button type="submit" class="btn-primary">Uložit</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Milestone -->
    <div class="modal" id="modal-milestone">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nový milník</h2>
                <button class="btn-close" onclick="closeModal('modal-milestone')">&times;</button>
            </div>
            <form id="form-milestone" onsubmit="saveMilestone(event)">
                <div class="form-group">
                    <label>Název milníku *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Popis</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>Plánované datum</label>
                    <input type="date" name="planned_date">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="pending">Čeká</option>
                        <option value="in_progress">Probíhá</option>
                        <option value="completed">Dokončeno</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Přidat milník</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Material -->
    <div class="modal" id="modal-material">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nový materiál</h2>
                <button class="btn-close" onclick="closeModal('modal-material')">&times;</button>
            </div>
            <form id="form-material" onsubmit="saveMaterial(event)">
                <div class="form-group material-autocomplete-container">
                    <label>Název materiálu * (začni psát pro vyhledání ve skladu)</label>
                    <input type="text" id="material-name-input" name="name" autocomplete="off" required 
                           placeholder="Např. štípa, kniphofia...">
                    <div id="material-autocomplete" class="material-autocomplete-dropdown" style="
                        position: absolute;
                        width: 100%;
                        max-height: 300px;
                        overflow-y: auto;
                        background: #1a2332;
                        border: 1px solid #2d3748;
                        border-radius: 8px;
                        display: none;
                        z-index: 1000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    "></div>
                    <div id="material-info" class="material-info"></div>
                </div>
                <div class="form-group">
                    <label>Množství *</label>
                    <input type="number" id="material-qty-input" name="quantity" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Jednotka</label>
                    <input type="text" id="material-unit-input" name="unit" value="ks" readonly>
                </div>
                <div class="form-group">
                    <label>Cena za jednotku (Kč)</label>
                    <input type="number" id="material-price-input" name="price_per_unit" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Dodavatel</label>
                    <input type="text" name="supplier">
                </div>
                <button type="submit" class="btn-primary">Přidat materiál a rezervovat</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Team -->
    <div class="modal" id="modal-team">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Přiřadit člena týmu</h2>
                <button class="btn-close" onclick="closeModal('modal-team')">&times;</button>
            </div>
            <form id="form-team" onsubmit="saveTeamMember(event)">
                <div class="form-group">
                    <label>Člen teamu *</label>
                    <select name="employee_id" required id="select-employee">
                        <option value="">Vyberte člena teamu</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role">
                        <option value="worker">Pracovník</option>
                        <option value="manager">Vedoucí</option>
                        <option value="supervisor">Dozor</option>
                        <option value="assistant">Pomocník</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Plánované hodiny</label>
                    <input type="number" name="hours_planned" value="0">
                </div>
                <button type="submit" class="btn-primary">Přiřadit</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Edit Job -->
    <div class="modal" id="modal-edit-job">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2>Upravit zakázku</h2>
                <button class="btn-close" onclick="closeModal('modal-edit-job')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-edit-job" onsubmit="saveJobEdit(event)">
                    <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
                        <div class="form-group">
                            <label>Název zakázky *</label>
                            <input type="text" name="title" id="edit-title" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>Kód *</label>
                            <input type="text" name="code" id="edit-code" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Typ zakázky</label>
                        <select name="job_type" id="edit-job-type" class="form-input">
                            <option value="client">Klientská zakázka</option>
                            <option value="internal">Interní provoz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Klient</label>
                        <input type="text" name="client" id="edit-client" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Adresa/Lokace</label>
                        <input type="text" name="address" id="edit-address" class="form-input">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                        <div class="form-group">
                            <label>Datum zadání</label>
                            <input type="date" name="created_date" id="edit-created-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Datum zahájení</label>
                            <input type="date" name="start_date" id="edit-start-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Deadline</label>
                            <input type="date" name="deadline" id="edit-deadline" class="form-input">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr;gap:16px;">
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" id="edit-status" class="form-select">
                                <option value="Plán">Plán</option>
                                <option value="Aktivní">Aktivní</option>
                                <option value="Pozastavené">Pozastavené</option>
                                <option value="Dokončeno">Dokončeno</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Odhadovaná cena (Kč)</label>
                        <input type="number" name="estimated_value" id="edit-budget" class="form-input" min="0" step="1000" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Progress (%)</label>
                        <input type="number" name="progress" id="edit-progress" class="form-input" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label>Popis/Poznámky</label>
                        <textarea name="note" id="edit-notes" class="form-textarea" rows="4"></textarea>
                    </div>
                    <div class="modal-footer" style="margin-top:20px;display:flex;justify-content:flex-end;gap:10px;">
                        <button type="button" class="btn-secondary" onclick="closeModal('modal-edit-job')">Zrušit</button>
                        <button type="submit" class="btn-primary">Uložit změny</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let currentJobId = null;
        let jobData = null;
        
        // Get job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentJobId = urlParams.get('id');
        
        if (!currentJobId) {
            alert('Chybí ID zakázky');
            window.location.href = '/jobs.html';
        }
        
        // Load job data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadJobData();
            loadEmployees();
        });
        
        // Tab switching
        function switchToTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) tabContent.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'ghost-plan') {
                loadGhostPlan();
            }
            if (tabName === 'notes') {
                loadJobNotes();
            }
            if (tabName === 'finance') {
                loadBudget();
            }
        }
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchToTab(btn.dataset.tab);
            });
        });
        
        // Handle deep-link from URL hash
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#tab-')) {
                const tabName = hash.substring(5); // Remove '#tab-'
                setTimeout(() => switchToTab(tabName), 100); // Small delay to ensure DOM is ready
            }
        });
        
        async function loadJobData() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/complete`);
                if (!response.ok) throw new Error('Failed to load job');
                
                jobData = await response.json();
                renderJobData();
                
                // AI insights handled by ai-jobs-integration.js
                
                // Load ghost plan if on timeline tab
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && activeTab.dataset.tab === 'ghost-plan') {
                    loadGhostPlan();
                }
            } catch (error) {
                console.error('Error loading job:', error);
                alert('Nepodařilo se načíst zakázku');
            }
        }
        
        // AI Panel functions removed — handled by ai-jobs-integration.js
        
        function renderJobData() {
            const { job, client, location, milestones, materials, team, summary } = jobData;
            
            // Hero Card
            document.getElementById('job-title').textContent = job.title || 'Bez názvu';
            document.getElementById('job-code').textContent = job.code || '—';
            document.getElementById('job-client').textContent = client?.name || job.client || '—';
            
            // Job type badge
            const typeBadge = document.getElementById('job-type-badge');
            if (typeBadge) {
                if (job.job_type === 'internal') {
                    typeBadge.textContent = 'INTERNÍ';
                    typeBadge.style.display = 'inline-flex';
                    typeBadge.style.cssText = 'display:inline-flex;align-items:center;font-size:10px;font-weight:700;letter-spacing:0.5px;color:#60a5fa;background:rgba(96,165,250,0.15);border:1px solid rgba(96,165,250,0.25);padding:2px 8px;border-radius:6px;margin-left:8px;';
                } else {
                    typeBadge.style.display = 'none';
                }
            }
            document.getElementById('job-location').textContent = location?.city || job.city || '—';
            document.getElementById('job-date').textContent = job.date || job.deadline || '—';
            
            const statusBadge = document.getElementById('job-status-badge');
            statusBadge.textContent = job.status || 'Neznámý';
            statusBadge.className = 'badge ' + getStatusClass(job.status);
            
            // Risk Ring
            const riskScore = calculateRiskScore(job);
            const riskRing = document.getElementById('job-risk-ring');
            const riskLevel = riskScore < 30 ? 'low' : riskScore < 70 ? 'medium' : 'high';
            riskRing.className = `job-risk-ring ${riskLevel}`;
            riskRing.querySelector('#job-risk-score').textContent = riskScore;
            
            // Hero Badges
            renderHeroBadges(job, materials);
            
            // Overview
            document.getElementById('overview-estimated').textContent = formatCurrency(job.estimated_value);
            document.getElementById('overview-actual').textContent = formatCurrency(job.actual_value);
            document.getElementById('overview-remaining').textContent = formatCurrency((job.estimated_value || 0) - (job.actual_value || 0));
            document.getElementById('overview-start').textContent = job.start_date || job.date || '—';
            document.getElementById('overview-deadline').textContent = job.deadline || '—';
            document.getElementById('overview-completion').textContent = job.actual_end_date || '—';
            document.getElementById('overview-team-size').textContent = summary.team_size || 0;
            document.getElementById('overview-milestones').textContent = `${summary.milestones_completed || 0} / ${summary.milestones_count || 0}`;
            document.getElementById('overview-materials').textContent = summary.materials_count || 0;
            
            // Finance tab
            const financeEstimated = document.getElementById('finance-estimated');
            const financeActual = document.getElementById('finance-actual');
            const financeRemaining = document.getElementById('finance-remaining');
            const financeMargin = document.getElementById('finance-margin');
            if (financeEstimated) financeEstimated.textContent = formatCurrency(job.estimated_value);
            if (financeActual) financeActual.textContent = formatCurrency(job.actual_value);
            if (financeRemaining) financeRemaining.textContent = formatCurrency((job.estimated_value || 0) - (job.actual_value || 0));
            if (financeMargin) {
                const margin = job.estimated_value && job.actual_value ? ((job.estimated_value - job.actual_value) / job.estimated_value * 100).toFixed(1) : '—';
                financeMargin.textContent = margin !== '—' ? `${margin}%` : '—';
            }
            
            // Materials
            renderMaterials(materials);
            
            // Team
            renderTeam(team);
        }
        
        function calculateRiskScore(job) {
            let score = 0;
            // Deadline risk
            if (job.deadline) {
                const daysUntil = getDaysUntilDeadline(job.deadline);
                if (daysUntil !== null && daysUntil < 0) score += 50;
                else if (daysUntil !== null && daysUntil <= 3) score += 30;
            }
            // Budget risk
            if (job.estimated_value && job.actual_value) {
                const spentPercent = (job.actual_value / job.estimated_value) * 100;
                if (spentPercent > 90) score += 40;
                else if (spentPercent > 80) score += 20;
            }
            // Progress risk
            if (job.progress !== undefined && job.deadline) {
                const daysUntil = getDaysUntilDeadline(job.deadline);
                if (daysUntil !== null && daysUntil > 0 && job.progress < (daysUntil / 30) * 100) {
                    score += 30;
                }
            }
            return Math.min(100, score);
        }
        
        function getDaysUntilDeadline(deadline) {
            if (!deadline) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function renderHeroBadges(job, materials) {
            const badgesContainer = document.getElementById('job-hero-badges');
            if (!badgesContainer) return;
            badgesContainer.innerHTML = '';
            
            // Material badge
            if (materials && materials.length > 0) {
                const missingMaterials = materials.filter(m => m.status === 'missing' || (!m.warehouse_item_id && m.status !== 'delivered'));
                if (missingMaterials.length > 0) {
                    badgesContainer.innerHTML += `<span class="badge badge-warning">📦 Chybí ${missingMaterials.length} materiálů</span>`;
                } else {
                    badgesContainer.innerHTML += `<span class="badge badge-success">📦 Materiál OK</span>`;
                }
            }
            
            // Finance badge
            if (job.estimated_value && job.actual_value) {
                const spentPercent = (job.actual_value / job.estimated_value) * 100;
                if (spentPercent > 90) {
                    badgesContainer.innerHTML += `<span class="badge badge-danger">💸 Rozpočet >90%</span>`;
                } else if (spentPercent > 80) {
                    badgesContainer.innerHTML += `<span class="badge badge-warning">💸 Rozpočet >80%</span>`;
                }
            }
            
            // Deadline badge
            if (job.deadline) {
                const daysUntil = getDaysUntilDeadline(job.deadline);
                if (daysUntil !== null && daysUntil < 0) {
                    badgesContainer.innerHTML += `<span class="badge badge-danger">⏰ Po termínu</span>`;
                } else if (daysUntil !== null && daysUntil <= 3) {
                    badgesContainer.innerHTML += `<span class="badge badge-warning">⏰ Deadline za ${daysUntil}d</span>`;
                }
            }
        }
        
        // Ghost Plan functions
        async function generateGhostPlan() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!response.ok) throw new Error('Failed to generate ghost plan');
                
                const data = await response.json();
                if (data.ok && data.proposal) {
                    renderGhostPlan(data.proposal);
                } else {
                    alert('Nepodařilo se vygenerovat ghost plán');
                }
            } catch (error) {
                console.error('Error generating ghost plan:', error);
                alert('Chyba při generování ghost plánu');
            }
        }
        
        async function loadGhostPlan() {
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan`);
                if (!response.ok) throw new Error('Failed to load ghost plan');
                
                const data = await response.json();
                if (data.ok && data.proposal) {
                    renderGhostPlan(data.proposal);
                } else {
                    // Show empty state
                    const container = document.getElementById('ghost-plan-container');
                    if (container) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <p>Žádný ghost plán. Klikni na "Vygenerovat návrh" pro vytvoření.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading ghost plan:', error);
            }
        }
        
        function renderGhostPlan(proposal) {
            const container = document.getElementById('ghost-plan-container');
            if (!container) return;
            
            const timeline = JSON.parse(proposal.proposed_timeline || '[]');
            const resources = JSON.parse(proposal.proposed_resources || '[]');
            
            let html = `
                <div class="ghost-plan-item">
                    <div class="ghost-plan-header">
                        <div>
                            <div class="ghost-plan-title">${proposal.title}</div>
                            <div class="ghost-plan-description">
                                ${proposal.description || ''}
                            </div>
                        </div>
                        <div class="ghost-plan-actions">
                            <button class="btn-secondary" onclick="rejectGhostPlan(${proposal.id})">Odmítnout</button>
                            <button class="btn-primary" onclick="acceptGhostPlan(${proposal.id})">Přijmout</button>
                        </div>
                    </div>
                    
                    <div class="ghost-plan-section">
                        <h4 class="ghost-plan-section-title">Navržená časová osa:</h4>
                        <div class="timeline">
            `;
            
            timeline.forEach((milestone, idx) => {
                html += `
                    <div class="timeline-item">
                        <div class="ghost-plan-milestone-title">
                            ${milestone.milestone}
                        </div>
                        <div class="ghost-plan-milestone-date">
                            ${new Date(milestone.date).toLocaleDateString('cs-CZ')} • ${Math.round(milestone.completion)}% dokončeno
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
            `;
            
            if (resources.length > 0) {
                html += `
                    <div class="ghost-plan-section">
                        <h4 class="ghost-plan-section-title">Navržené zdroje:</h4>
                        <div class="ghost-plan-resources-list">
                `;
                
                resources.forEach(resource => {
                    html += `
                        <div class="ghost-plan-resource-item">
                            <div class="ghost-plan-resource-name">${resource.name}</div>
                            <div class="ghost-plan-resource-hours">
                                ${resource.current_hours}h/týden → ${resource.suggested_hours}h/týden
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    <div class="ghost-plan-footer">
                        <div class="ghost-plan-metrics">
                            <div>
                                <span class="ghost-plan-metric-label">Riziko:</span>
                                <span class="ghost-plan-metric-value">${proposal.risk_score}</span>
                            </div>
                            <div>
                                <span class="ghost-plan-metric-label">Health:</span>
                                <span class="ghost-plan-metric-value">${proposal.health_score}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function acceptGhostPlan(proposalId) {
            if (!confirm('Opravdu chceš přijmout tento ghost plán? Zakázka bude aktualizována podle návrhu.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan/accept`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({proposal_id: proposalId})
                });
                
                if (!response.ok) throw new Error('Failed to accept ghost plan');
                
                const data = await response.json();
                if (data.ok) {
                    alert('Ghost plán byl přijat. Zakázka byla aktualizována.');
                    loadGhostPlan(); // Reload to show updated state
                    loadJobData(); // Reload job data
                }
            } catch (error) {
                console.error('Error accepting ghost plan:', error);
                alert('Chyba při přijímání ghost plánu');
            }
        }
        
        async function rejectGhostPlan(proposalId) {
            if (!confirm('Opravdu chceš odmítnout tento ghost plán?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/ghost-plan/reject`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({proposal_id: proposalId})
                });
                
                if (!response.ok) throw new Error('Failed to reject ghost plan');
                
                const data = await response.json();
                if (data.ok) {
                    loadGhostPlan(); // Reload to show empty state
                }
            } catch (error) {
                console.error('Error rejecting ghost plan:', error);
                alert('Chyba při odmítání ghost plánu');
            }
        }
        
        function openTaskModal() {
            alert('Přidání úkolu bude implementováno');
        }
        
        function openDocumentModal() {
            alert('Přidání dokumentu bude implementováno');
        }
        
        function renderClient(client) {
            const container = document.getElementById('client-info');
            if (!client || !client.name) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Žádné informace o klientovi</p>
                        <button class="btn-primary" onclick="openClientModal()">Přidat informace</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Jméno:</span>
                    <span class="info-value">${client.name}</span>
                </div>
                ${client.company ? `<div class="info-row"><span class="info-label">Firma:</span><span class="info-value">${client.company}</span></div>` : ''}
                ${client.ico ? `<div class="info-row"><span class="info-label">IČO:</span><span class="info-value">${client.ico}</span></div>` : ''}
                ${client.dic ? `<div class="info-row"><span class="info-label">DIČ:</span><span class="info-value">${client.dic}</span></div>` : ''}
                ${client.email ? `<div class="info-row"><span class="info-label">Email:</span><span class="info-value">${client.email}</span></div>` : ''}
                ${client.phone ? `<div class="info-row"><span class="info-label">Telefon:</span><span class="info-value">${client.phone}</span></div>` : ''}
                ${client.phone_secondary ? `<div class="info-row"><span class="info-label">Alt. telefon:</span><span class="info-value">${client.phone_secondary}</span></div>` : ''}
                ${client.billing_street ? `<div class="info-row"><span class="info-label">Adresa:</span><span class="info-value">${client.billing_street}, ${client.billing_city} ${client.billing_zip}</span></div>` : ''}
            `;
        }
        
        function renderLocation(location) {
            const container = document.getElementById('location-info');
            if (!location || !location.street) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Žádné informace o lokaci</p>
                        <button class="btn-primary" onclick="openLocationModal()">Přidat informace</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Adresa:</span>
                    <span class="info-value">${location.street}, ${location.city} ${location.zip || ''}</span>
                </div>
                ${location.lat && location.lng ? `<div class="info-row"><span class="info-label">GPS:</span><span class="info-value">${location.lat}, ${location.lng}</span></div>` : ''}
                ${location.parking ? `<div class="info-row"><span class="info-label">Parkování:</span><span class="info-value">${location.parking}</span></div>` : ''}
                ${location.gate_code ? `<div class="info-row"><span class="info-label">Kód brány:</span><span class="info-value">${location.gate_code}</span></div>` : ''}
                ${location.access_notes ? `<div class="info-row"><span class="info-label">Přístup:</span><span class="info-value">${location.access_notes}</span></div>` : ''}
            `;
        }
        
        function renderMilestones(milestones) {
            const container = document.getElementById('milestones-list');
            if (!milestones || milestones.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Žádné milníky</p>
                        <button class="btn-primary" onclick="openMilestoneModal()">Přidat první milník</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = milestones.map(m => `
                <div class="timeline-item ${m.status}">
                    <div class="timeline-date">${m.planned_date || '—'}</div>
                    <div class="timeline-title">${m.name}</div>
                    ${m.description ? `<p>${m.description}</p>` : ''}
                    <span class="badge ${getStatusClass(m.status)}">${getStatusLabel(m.status)}</span>
                </div>
            `).join('');
        }
        
        function renderMaterials(materials) {
            const container = document.getElementById('materials-table');
            if (!materials || materials.length === 0) {
                container.innerHTML = `
                    <div style="padding:60px;text-align:center;color:#9ca3af;">
                        <div style="font-size:48px;margin-bottom:16px;">📦</div>
                        <div style="font-size:16px;margin-bottom:16px;">Zatím žádný materiál</div>
                        <button class="btn-primary" onclick="openMaterialModal()">Přidat první materiál</button>
                    </div>
                `;
                return;
            }
            
            // UŽŠÍ elegantní tabulka
            container.innerHTML = `
                <div style="background:#1e293b;border-radius:8px;overflow:hidden;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="background:#0f172a;border-bottom:1px solid #334155;">
                                <th style="padding:8px 12px;text-align:left;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;">Materiál</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:100px;">Množství</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:90px;">Cena/jedn</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:100px;">Celkem</th>
                                <th style="padding:8px 12px;text-align:left;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:140px;">Dodavatel</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:120px;">Status</th>
                                <th style="padding:8px 12px;text-align:center;color:#9ca3af;font-size:11px;font-weight:600;text-transform:uppercase;width:60px;">Akce</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${materials.map(m => {
                                const qty = m.qty || m.quantity || 0;
                                const price = m.price || m.price_per_unit || 0;
                                const total = qty * price;
                                const isReserved = m.warehouse_item_id ? true : false;
                                const status = m.status || 'planned';
                                
                                const statusColors = {
                                    'planned': '#9ca3af',
                                    'ordered': '#60a5fa',
                                    'delivered': '#34d399',
                                    'used': '#a78bfa'
                                };
                                
                                const statusLabels = {
                                    'planned': 'Plánováno',
                                    'ordered': 'Objednáno',
                                    'delivered': 'Dodáno',
                                    'used': 'Použito'
                                };
                                
                                return `
                                <tr style="border-bottom:1px solid #334155;" onmouseenter="this.style.background='#334155'" onmouseleave="this.style.background='transparent'">
                                    <td style="padding:10px 12px;">
                                        <div style="display:flex;align-items:center;gap:6px;">
                                            ${isReserved ? '<span style="font-size:16px;">📦</span>' : '<span style="font-size:16px;">📋</span>'}
                                            <div>
                                                <div style="font-weight:600;color:white;">${escapeHtml(m.name)}</div>
                                                <div style="font-size:11px;color:#9ca3af;margin-top:2px;">
                                                    ${isReserved ? '<span style="color:#4ade80;">Ze skladu</span>' : ''}
                                                    ${m.warehouse_location ? ` • <svg style="width:12px;height:12px;display:inline-block;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${escapeHtml(m.warehouse_location)}` : ''}
                                                    ${isReserved && m.reserved_qty ? ` • <svg style="width:12px;height:12px;display:inline-block;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> ${m.reserved_qty}${m.unit}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding:8px 10px;text-align:center;">
                                        <div id="material-qty-${m.id}" 
                                              onclick="editMaterialField(${m.id}, 'qty', ${qty})"
                                              style="cursor:pointer;padding:3px 6px;font-weight:600;color:white;border-radius:4px;display:inline-block;background:#0f172a;border:2px solid transparent;"
                                              onmouseenter="this.style.borderColor='#4ade80'"
                                              onmouseleave="this.style.borderColor='transparent'">
                                            ${qty.toFixed(2)} ${escapeHtml(m.unit || 'ks')}
                                        </div>
                                    </td>
                                    <td style="padding:8px 10px;text-align:center;">
                                        <div id="material-price-${m.id}" 
                                              onclick="editMaterialField(${m.id}, 'price', ${price})"
                                              style="cursor:pointer;padding:3px 6px;font-weight:600;color:white;border-radius:4px;display:inline-block;background:#0f172a;border:2px solid transparent;"
                                              onmouseenter="this.style.borderColor='#4ade80'"
                                              onmouseleave="this.style.borderColor='transparent'">
                                            ${price.toFixed(2)} Kč
                                        </div>
                                    </td>
                                    <td style="padding:10px 12px;text-align:center;">
                                        <span style="font-weight:700;color:#4ade80;">${total.toFixed(2)} Kč</span>
                                    </td>
                                    <td style="padding:8px 10px;">
                                        <div id="material-supplier-${m.id}" 
                                              onclick="editMaterialField(${m.id}, 'supplier', '${escapeHtml(m.supplier || '')}')"
                                              style="cursor:pointer;padding:4px 8px;color:white;border-radius:4px;display:inline-block;background:#0f172a;border:2px solid transparent;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                                              onmouseenter="this.style.borderColor='#4ade80'"
                                              onmouseleave="this.style.borderColor='transparent'"
                                              title="${escapeHtml(m.supplier || 'Klikni pro úpravu')}">
                                            ${m.supplier ? escapeHtml(m.supplier) : '<span style="color:#6b7280;">klikni</span>'}
                                        </div>
                                    </td>
                                    <td style="padding:10px 12px;text-align:center;">
                                        <select onchange="updateMaterialStatus(${m.id}, this.value)" 
                                                style="background:${statusColors[status]};color:white;border:none;padding:5px 10px;border-radius:4px;font-size:12px;font-weight:600;cursor:pointer;width:100%;">
                                            ${Object.keys(statusLabels).map(s => 
                                                `<option value="${s}" ${s === status ? 'selected' : ''}>${statusLabels[s]}</option>`
                                            ).join('')}
                                        </select>
                                    </td>
                                    <td style="padding:10px 12px;text-align:center;">
                                        <button onclick="deleteMaterial(${m.id})" 
                                                style="background:#ef4444;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;"
                                                onmouseenter="this.style.background='#dc2626'"
                                                onmouseleave="this.style.background='#ef4444'"
                                                title="Smazat${isReserved ? ' a uvolnit rezervaci' : ''}">
                                            🗑️
                                        </button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Editace pole materiálu
        let editingMaterialField = null;
        
        function editMaterialField(materialId, field, currentValue) {
            if (editingMaterialField) {
                cancelMaterialEdit();
            }
            
            const div = document.getElementById(`material-${field}-${materialId}`);
            if (!div) return;
            
            const originalHTML = div.innerHTML;
            const inputType = (field === 'qty' || field === 'price') ? 'number' : 'text';
            
            editingMaterialField = { materialId, field, div, originalValue: currentValue, originalHTML };
            
            const input = document.createElement('input');
            input.type = inputType;
            input.value = currentValue;
            input.style.cssText = `
                width: 100%;
                padding: 4px 8px;
                background: #0f172a;
                border: 2px solid #4ade80;
                border-radius: 4px;
                color: white;
                font-size: 13px;
                font-weight: 600;
                box-shadow: 0 0 0 3px rgba(74,222,128,0.2);
            `;
            
            if (inputType === 'number') {
                input.step = '0.01';
                input.min = '0';
            }
            
            div.innerHTML = '';
            div.appendChild(input);
            
            input.focus();
            if (inputType === 'text') input.select();
            
            input.onblur = () => saveMaterialField();
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveMaterialField();
                } else if (e.key === 'Escape') {
                    cancelMaterialEdit();
                }
            };
        }
        
        async function saveMaterialField() {
            if (!editingMaterialField) return;
            
            const { materialId, field, div } = editingMaterialField;
            const input = div.querySelector('input');
            if (!input) return;
            
            const newValue = input.type === 'number' ? parseFloat(input.value) || 0 : input.value.trim();
            
            if (newValue === editingMaterialField.originalValue) {
                cancelMaterialEdit();
                return;
            }
            
            // Mapování názvů polí pro API
            const fieldMapping = {
                'qty': 'quantity',
                'price': 'price_per_unit',
                'supplier': 'supplier'
            };
            const apiField = fieldMapping[field] || field;
            
            try {
                const jobId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/jobs/${jobId}/materials/${materialId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [apiField]: newValue })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update');
                }
                
                await loadJobData();
                editingMaterialField = null;
            } catch (error) {
                console.error('Update error:', error);
                alert('Chyba: ' + error.message);
                cancelMaterialEdit();
            }
        }
        
        function cancelMaterialEdit() {
            if (!editingMaterialField) return;
            editingMaterialField.div.innerHTML = editingMaterialField.originalHTML;
            editingMaterialField = null;
        }
        
        async function updateMaterialStatus(materialId, newStatus) {
            try {
                const jobId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/jobs/${jobId}/materials/${materialId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update status');
                }
                
                await loadJobData();
            } catch (error) {
                console.error('Status update error:', error);
                alert('Chyba při změně statusu: ' + error.message);
                await loadJobData();
            }
        }
        
        async function deleteMaterial(materialId) {
            const material = jobData.materials.find(m => m.id === materialId);
            const isReserved = material && material.warehouse_item_id;
            
            const confirmMsg = isReserved 
                ? 'Opravdu smazat tento materiál?\n\nRezervace ze skladu bude automaticky uvolněna.' 
                : 'Opravdu smazat tento materiál?';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                const jobId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/jobs/${jobId}/materials/${materialId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                await loadJobData();
                alert(isReserved ? 'Materiál smazán a rezervace uvolněna' : 'Materiál smazán');
            } catch (error) {
                console.error('Delete error:', error);
                alert('Chyba při mazání: ' + error.message);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function renderTeam(team) {
            const container = document.getElementById('team-table');
            if (!team || team.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Žádný tým</p>
                        <button class="btn-primary" onclick="openTeamModal()">Přiřadit první členy</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Jméno</th>
                            <th>Pozice</th>
                            <th>Role</th>
                            <th>Hodiny</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${team.map(t => `
                            <tr>
                                <td>${t.employee_name || '—'}</td>
                                <td>${t.position || '—'}</td>
                                <td>${t.role || '—'}</td>
                                <td>${t.hours_actual || 0} / ${t.hours_planned || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Modal functions
        function openClientModal() {
            const modal = document.getElementById('modal-client');
            const form = document.getElementById('form-client');
            
            if (jobData.client) {
                form.name.value = jobData.client.name || '';
                form.company.value = jobData.client.company || '';
                form.ico.value = jobData.client.ico || '';
                form.dic.value = jobData.client.dic || '';
                form.email.value = jobData.client.email || '';
                form.phone.value = jobData.client.phone || '';
                form.phone_secondary.value = jobData.client.phone_secondary || '';
                form.billing_street.value = jobData.client.billing_street || '';
                form.billing_city.value = jobData.client.billing_city || '';
                form.billing_zip.value = jobData.client.billing_zip || '';
            }
            
            modal.classList.add('active');
        }
        
        function openLocationModal() {
            const modal = document.getElementById('modal-location');
            const form = document.getElementById('form-location');
            
            if (jobData.location) {
                form.street.value = jobData.location.street || '';
                form.city.value = jobData.location.city || '';
                form.zip.value = jobData.location.zip || '';
                form.lat.value = jobData.location.lat || '';
                form.lng.value = jobData.location.lng || '';
                form.parking.value = jobData.location.parking || '';
                form.access_notes.value = jobData.location.access_notes || '';
                form.gate_code.value = jobData.location.gate_code || '';
            }
            
            modal.classList.add('active');
        }
        
        function openMilestoneModal() {
            document.getElementById('modal-milestone').classList.add('active');
        }
        
        function openMaterialModal() {
            document.getElementById('modal-material').classList.add('active');
        }
        
        function openTeamModal() {
            document.getElementById('modal-team').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Save functions
        async function saveClient(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/client`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-client');
                loadJobData();
                alert('Klient uložen');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba při ukládání');
            }
        }
        
        async function saveLocation(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/location`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-location');
                loadJobData();
                alert('Lokace uložena');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba při ukládání');
            }
        }
        
        async function saveMilestone(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/milestones`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-milestone');
                e.target.reset();
                loadJobData();
                alert('Milník přidán');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba při ukládání');
            }
        }
        
        async function saveMaterial(e) {
            e.preventDefault();
            const form = e.target;
            const nameInput = document.getElementById('material-name-input');
            const qtyInput = document.getElementById('material-qty-input');
            const warehouseItemId = nameInput.dataset.warehouseItemId;
            const jobId = new URLSearchParams(window.location.search).get('id');
            
            if (!jobId) return;
            
            const data = {
                name: form.name.value,
                quantity: parseFloat(form.quantity.value) || 0,
                unit: form.unit.value,
                price_per_unit: parseFloat(form.price_per_unit.value) || 0,
                supplier: form.supplier.value
            };
            
            // Pokud je vybrána položka ze skladu, použij rezervační endpoint
            if (warehouseItemId) {
                try {
                    const response = await fetch(`/api/jobs/${jobId}/materials/reserve`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            warehouse_item_id: parseInt(warehouseItemId),
                            qty: data.quantity
                        })
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        alert('Materiál rezervován ze skladu!');
                        closeModal('modal-material');
                        form.reset();
                        delete nameInput.dataset.warehouseItemId;
                        document.getElementById('material-info').style.display = 'none';
                        loadJobData(); // Reload data
                    } else {
                        alert('Chyba: ' + (result.error || 'Nepodařilo se rezervovat'));
                    }
                } catch (error) {
                    console.error('Reserve error:', error);
                    alert('Chyba při rezervaci materiálu');
                }
            } else {
                // Standardní přidání bez rezervace
                try {
                    const response = await fetch(`/api/jobs/${jobId}/materials`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        alert('Materiál přidán!');
                        closeModal('modal-material');
                        form.reset();
                        loadJobData();
                    }
                } catch (error) {
                    console.error('Save error:', error);
                }
            }
        }
        
        async function saveTeamMember(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/api/jobs/${currentJobId}/team`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal('modal-team');
                e.target.reset();
                loadJobData();
                alert('Člen týmu přiřazen');
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba při ukládání');
            }
        }
        
        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees');
                const data = await response.json();
                const employees = Array.isArray(data) ? data : (data.employees || []);
                
                const select = document.getElementById('select-employee');
                select.innerHTML = '<option value="">Vyberte člena teamu</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }
        
        // Helper functions
        function formatCurrency(value) {
            if (!value) return '0 Kč';
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                minimumFractionDigits: 0
            }).format(value);
        }
        
        function getStatusClass(status) {
            const map = {
                'completed': 'badge-success',
                'in_progress': 'badge-info',
                'pending': 'badge-warning',
                'delivered': 'badge-success',
                'Aktivní': 'badge-success',
                'Dokončené': 'badge-info',
                'Plán': 'badge-warning'
            };
            return map[status] || 'badge-info';
        }
        
        function getStatusLabel(status) {
            const map = {
                'pending': 'Čeká',
                'in_progress': 'Probíhá',
                'completed': 'Hotovo'
            };
            return map[status] || status;
        }
        
        // Edit job function
        function editJob() {
            const modal = document.getElementById('modal-edit-job');
            if (!modal) return;
            
            if (jobData && jobData.job) {
                const job = jobData.job;
                
                // Mapuj status zpět na českou hodnotu pokud je interní
                const statusMap = {
                    'new': 'Plán',
                    'active': 'Aktivní',
                    'paused': 'Pozastavené',
                    'completed': 'Dokončeno',
                    'Plán': 'Plán',
                    'Aktivní': 'Aktivní',
                    'Pozastavené': 'Pozastavené',
                    'Dokončeno': 'Dokončeno',
                    'Probíhá': 'Aktivní'
                };
                
                document.getElementById('edit-title').value = job.title || job.name || '';
                document.getElementById('edit-code').value = job.code || '';
                document.getElementById('edit-job-type').value = job.job_type || 'client';
                document.getElementById('edit-client').value = jobData.client?.name || job.client || '';
                document.getElementById('edit-address').value = jobData.location?.city || jobData.location?.address || job.city || job.address || '';
                document.getElementById('edit-deadline').value = job.date || job.deadline ? (job.date || job.deadline).split('T')[0] : '';
                document.getElementById('edit-created-date').value = job.created_date ? job.created_date.split('T')[0] : '';
                document.getElementById('edit-start-date').value = job.start_date ? job.start_date.split('T')[0] : '';
                document.getElementById('edit-status').value = statusMap[job.status] || 'Plán';
                document.getElementById('edit-budget').value = job.estimated_value || job.budget || 0;
                document.getElementById('edit-progress').value = job.progress || job.completion_percentage || 0;
                document.getElementById('edit-notes').value = job.note || job.notes || '';
            }
            
            modal.classList.add('active');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        }
        
        async function saveJobEdit(e) {
            e.preventDefault();
            
            if (!currentJobId) return;
            
            // Validace formuláře
            const title = document.getElementById('edit-title').value.trim();
            if (!title) {
                if (typeof showToast === 'function') {
                    showToast('Název zakázky je povinný', 'error');
                } else {
                    alert('Název zakázky je povinný');
                }
                document.getElementById('edit-title').focus();
                return;
            }
            
            // Mapuj status z českého názvu na interní hodnotu
            const statusMapReverse = {
                'Plán': 'new',
                'Aktivní': 'active',
                'Pozastavené': 'paused',
                'Dokončeno': 'completed'
            };
            
            // Validace dat
            const createdDate = document.getElementById('edit-created-date').value;
            const startDate = document.getElementById('edit-start-date').value;
            const deadline = document.getElementById('edit-deadline').value;
            
            if (createdDate && startDate) {
                if (new Date(startDate) < new Date(createdDate)) {
                    if (typeof showToast === 'function') {
                        showToast('Datum zahájení musí být po datu zadání', 'error');
                    } else {
                        alert('Datum zahájení musí být po datu zadání');
                    }
                    document.getElementById('edit-start-date').focus();
                    return;
                }
            }
            
            if (startDate && deadline) {
                if (new Date(deadline) < new Date(startDate)) {
                    if (typeof showToast === 'function') {
                        showToast('Deadline musí být po datu zahájení', 'error');
                    } else {
                        alert('Deadline musí být po datu zahájení');
                    }
                    document.getElementById('edit-deadline').focus();
                    return;
                }
            }
            
            const statusValue = document.getElementById('edit-status').value;
            const mappedStatus = statusMapReverse[statusValue] || 'new';
            const progressValue = parseInt(document.getElementById('edit-progress').value) || 0;
            const budget = parseInt(document.getElementById('edit-budget').value) || 0;
            
            const updateData = {
                id: parseInt(currentJobId),
                title: title,
                code: document.getElementById('edit-code').value.trim(),
                client: document.getElementById('edit-client').value.trim(),
                city: document.getElementById('edit-address').value.trim(),
                date: deadline || null,
                created_date: createdDate && createdDate.trim() ? new Date(createdDate).toISOString().split('T')[0] : null,
                start_date: startDate && startDate.trim() ? new Date(startDate).toISOString().split('T')[0] : null,
                status: mappedStatus,
                note: document.getElementById('edit-notes').value.trim(),
                progress: progressValue,
                estimated_value: budget,
                job_type: document.getElementById('edit-job-type').value
            };
            
            try {
                if (typeof showLoading === 'function') showLoading('Ukládám změny...');
                
                const response = await fetch('/api/jobs', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (typeof hideLoading === 'function') hideLoading();
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save');
                }
                
                closeModal('modal-edit-job');
                await loadJobData(); // Reload data na stránce
                
                if (typeof showToast === 'function') {
                    showToast('Zakázka uložena', 'success');
                } else {
                    alert('Zakázka uložena');
                }
            } catch (error) {
                console.error('Error:', error);
                if (typeof showToast === 'function') {
                    showToast('Chyba při ukládání: ' + error.message, 'error');
                } else {
                    alert('Chyba při ukládání: ' + error.message);
                }
            }
        }
        
        // =============================================
        // POZNÁMKY K ZAKÁZCE — PLNÝ CRUD
        // =============================================
        
        function getJobIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id') || params.get('jobId');
        }
        
        let selectedJNoteColor = 'default';
        
        const jnoteCategoryLabels = {
            'general': 'Obecné', 'measurement': 'Výměry', 'observation': 'Postřehy',
            'idea': 'Nápady', 'reminder': 'Připomínky', 'issue': 'Problémy'
        };
        
        const jnoteColorMap = {
            'default': '#64748b', 'green': '#4ade80', 'blue': '#60a5fa',
            'yellow': '#fbbf24', 'red': '#f87171', 'purple': '#a78bfa'
        };
        
        function pickJNoteColor(color) {
            selectedJNoteColor = color;
            document.querySelectorAll('.jnote-color-opt').forEach(el => {
                el.style.border = el.dataset.color === color ? '2px solid #fff' : '2px solid transparent';
            });
        }
        
        async function loadJobNotes() {
            const jobId = getJobIdFromUrl();
            if (!jobId) return;
            
            try {
                const res = await fetch('/api/notes?job_id=' + jobId + '&sort_by=created_at');
                if (!res.ok) { console.error('Notes API error', res.status); return; }
                const data = await res.json();
                const notes = data.notes || [];
                const container = document.getElementById('job-notes-list');
                if (!container) return;
                
                if (notes.length === 0) {
                    container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="1.5" width="48" height="48"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><p>Žádné poznámky k této zakázce</p></div>';
                    return;
                }
                
                container.innerHTML = notes.map(note => {
                    const color = jnoteColorMap[note.color] || '#64748b';
                    const cat = jnoteCategoryLabels[note.category] || note.category;
                    const date = new Date(note.created_at);
                    const dateStr = date.toLocaleDateString('cs-CZ') + ' ' + date.toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit'});
                    
                    return '<div style="background:var(--bg-card,#1a2332);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;margin-bottom:12px;border-top:3px solid ' + color + ';">' +
                        '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">' +
                            '<div>' +
                                '<span style="display:inline-block;padding:2px 10px;border-radius:20px;font-size:11px;font-weight:500;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">' + cat + '</span>' +
                                (note.is_pinned ? ' <svg viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" width="14" height="14" style="vertical-align:middle;"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg>' : '') +
                                (note.title ? '<h4 style="font-size:15px;font-weight:600;color:#e2e8f0;margin:6px 0 0;">' + escapeHtmlJN(note.title) + '</h4>' : '') +
                            '</div>' +
                            '<div style="display:flex;gap:6px;">' +
                                '<button onclick="editJobNote(' + note.id + ')" style="background:none;border:none;cursor:pointer;padding:4px;" title="Upravit"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>' +
                                '<button onclick="deleteJobNote(' + note.id + ')" style="background:none;border:none;cursor:pointer;padding:4px;" title="Smazat"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>' +
                            '</div>' +
                        '</div>' +
                        '<p style="font-size:13px;color:rgba(255,255,255,0.5);line-height:1.6;margin:0 0 8px;white-space:pre-wrap;">' + escapeHtmlJN(note.content) + '</p>' +
                        '<div style="display:flex;gap:12px;font-size:11px;color:rgba(255,255,255,0.3);">' +
                            '<span>' + dateStr + '</span>' +
                            (note.employee_name ? '<span>👤 ' + escapeHtmlJN(note.employee_name) + '</span>' : '') +
                        '</div>' +
                    '</div>';
                }).join('');
                
            } catch(e) {
                console.error('Chyba při načítání poznámek:', e);
            }
        }
        
        function openJobNoteModal(noteData) {
            const modal = document.getElementById('jobNoteModal');
            modal.style.display = 'flex';
            
            document.getElementById('jobNoteModalTitle').textContent = noteData ? 'Upravit poznámku' : 'Nová poznámka';
            document.getElementById('jnote-id').value = noteData ? noteData.id : '';
            document.getElementById('jnote-title').value = noteData ? (noteData.title || '') : '';
            document.getElementById('jnote-content').value = noteData ? (noteData.content || '') : '';
            document.getElementById('jnote-category').value = noteData ? (noteData.category || 'general') : 'general';
            
            const empSelect = document.getElementById('jnote-employee');
            empSelect.value = noteData ? (noteData.employee_id || '') : '';
            
            pickJNoteColor(noteData ? (noteData.color || 'default') : 'default');
            
            loadJobNoteEmployees();
            
            modal.onclick = function(e) { if (e.target === modal) closeJobNoteModal(); };
        }
        
        function closeJobNoteModal() {
            document.getElementById('jobNoteModal').style.display = 'none';
        }
        
        async function loadJobNoteEmployees() {
            try {
                const res = await fetch('/api/employees');
                const data = await res.json();
                const employees = Array.isArray(data) ? data : (data.employees || []);
                const select = document.getElementById('jnote-employee');
                const currentVal = select.value;
                
                select.innerHTML = '<option value="">— Bez přiřazení —</option>';
                employees.forEach(emp => {
                    const name = emp.name || ((emp.first_name || '') + ' ' + (emp.last_name || '')).trim() || 'Zaměstnanec';
                    select.innerHTML += '<option value="' + emp.id + '">' + escapeHtmlJN(name) + '</option>';
                });
                
                if (currentVal) select.value = currentVal;
            } catch(e) {
                console.error('Chyba při načítání zaměstnanců:', e);
            }
        }
        
        async function saveJobNote() {
            const jobId = getJobIdFromUrl();
            const noteId = document.getElementById('jnote-id').value;
            const content = document.getElementById('jnote-content').value.trim();
            
            if (!content) {
                alert('Obsah poznámky je povinný');
                return;
            }
            
            const payload = {
                title: document.getElementById('jnote-title').value.trim() || null,
                content: content,
                category: document.getElementById('jnote-category').value,
                color: selectedJNoteColor,
                job_id: parseInt(jobId),
                employee_id: document.getElementById('jnote-employee').value ? parseInt(document.getElementById('jnote-employee').value) : null
            };
            
            try {
                const url = noteId ? '/api/notes/' + noteId : '/api/notes';
                const method = noteId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                
                if (data.ok || data.id) {
                    closeJobNoteModal();
                    loadJobNotes();
                    if (typeof showToast === 'function') showToast(noteId ? 'Poznámka upravena' : 'Poznámka vytvořena', 'success');
                } else {
                    alert('Chyba: ' + (data.error || 'Neznámá chyba'));
                }
            } catch(e) {
                console.error('Chyba při ukládání:', e);
                alert('Chyba při ukládání poznámky');
            }
        }
        
        async function editJobNote(noteId) {
            try {
                const res = await fetch('/api/notes/' + noteId);
                const data = await res.json();
                if (data.id || data.note) {
                    openJobNoteModal(data.note || data);
                }
            } catch(e) {
                console.error('Chyba:', e);
            }
        }
        
        async function deleteJobNote(noteId) {
            if (!confirm('Opravdu smazat tuto poznámku?')) return;
            try {
                const res = await fetch('/api/notes/' + noteId, { method: 'DELETE' });
                const data = await res.json();
                if (data.ok) {
                    loadJobNotes();
                    if (typeof showToast === 'function') showToast('Poznámka smazána', 'success');
                }
            } catch(e) {
                console.error('Chyba:', e);
            }
        }
        
        async function togglePinJobNote(noteId) {
            try {
                await fetch('/api/notes/' + noteId + '/pin', { method: 'PUT' });
                loadJobNotes();
            } catch(e) {
                console.error('Chyba:', e);
            }
        }
        
        function escapeHtmlJN(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }
        
        // =============================================
        // ROZPOČET ZAKÁZKY v3 — MATERIÁL / PRÁCE / VÍCEPRÁCE
        // =============================================

        function fmtCZK(v) {
            return new Intl.NumberFormat('cs-CZ', {minimumFractionDigits:0, maximumFractionDigits:2}).format(v||0) + ' Kč';
        }
        function escB(s) { if(!s)return''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

        const BUDGET_CAT = {
            material: {
                label: 'MATERIÁL',
                color: '#60a5fa',
                icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
                link: '🔗 Propojeno se skladem',
                emptyText: 'Přidej podsekci a rozepíšeš materiál (rostliny, substráty, stavební prvky...)'
            },
            labor: {
                label: 'PRÁCE',
                color: '#4ade80',
                icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>',
                link: '🔗 Propojeno s výkazy hodin',
                emptyText: 'Přidej podsekci a rozepíšeš práce (zemní, sadovnické, instalační...)'
            },
            extras: {
                label: 'VÍCEPRÁCE',
                color: '#fbbf24',
                icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                link: '',
                emptyText: 'Vícepráce se přidávají průběžně během zakázky'
            }
        };

        async function loadBudget() {
            const jobId = getJobIdFromUrl();
            if (!jobId) return;
            try {
                const res = await fetch('/api/jobs/' + jobId + '/budget');
                const data = await res.json();
                if (!data.ok) return;
                window._budgetActualLabor = data.actual_labor || null;
                renderBudgetKPI(data.summary);
                const grouped = { material: [], labor: [], extras: [] };
                data.sections.forEach(s => { if (grouped[s.section_type]) grouped[s.section_type].push(s); });
                renderBudgetBlock('material', grouped.material, data.summary.total_material);
                renderBudgetBlock('labor', grouped.labor, data.summary.total_labor);
                renderBudgetBlock('extras', grouped.extras, data.summary.total_extras);
            } catch(e) { console.error('Budget load error:', e); }
        }

        function renderBudgetKPI(s) {
            const el = document.getElementById('budget-kpi');
            if (!el) return;
            const actual = window._budgetActualLabor;
            const cards = [
                { label: 'Materiál', val: s.total_material, color: '#60a5fa' },
                {
                    label: 'Práce',
                    val: s.total_labor,
                    color: '#4ade80',
                    subtitle: actual ? `Skutečnost: ${fmtCZK(actual.total_cost)}` : null,
                    subtitleColor: actual && actual.total_cost > s.total_labor ? '#ef4444' : '#4ade80'
                },
                { label: 'Vícepráce', val: s.total_extras, color: '#fbbf24' },
                { label: 'Celkem bez DPH', val: s.grand_total, color: '#e2e8f0' }
            ];
            el.innerHTML = cards.map(c => `
                <div style="background:var(--bg-card,#1a2332);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;border-left:3px solid ${c.color};">
                    <div style="font-size:11px;color:rgba(255,255,255,0.45);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">${c.label}</div>
                    <div style="font-size:22px;font-weight:700;color:${c.color};">${fmtCZK(c.val)}</div>
                    ${c.subtitle ? `<div style="font-size:11px;color:${c.subtitleColor};margin-top:4px;">${c.subtitle}</div>` : ''}
                </div>
            `).join('');
        }

        function renderBudgetBlock(type, sections, total) {
            const cat = BUDGET_CAT[type];
            const el = document.getElementById('budget-block-' + type);
            if (!el) return;
            let html = `
            <div style="margin-bottom:32px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid ${cat.color};">
                    <div style="display:flex;align-items:center;gap:10px;">
                        ${cat.icon}
                        <h3 style="margin:0;font-size:17px;font-weight:700;color:${cat.color};">${cat.label}</h3>
                        <span style="font-size:13px;color:rgba(255,255,255,0.4);font-weight:600;">${fmtCZK(total)}</span>
                    </div>
                    <button onclick="addBudgetSubsection('${type}')" style="display:flex;align-items:center;gap:5px;background:rgba(255,255,255,0.05);border:1px solid ${cat.color}40;border-radius:8px;padding:6px 14px;color:${cat.color};cursor:pointer;font-size:12px;font-weight:500;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Nová podsekce
                    </button>
                </div>`;
            if (!sections.length) {
                html += `<div style="text-align:center;padding:24px;color:rgba(255,255,255,0.25);font-size:13px;font-style:italic;">${cat.emptyText}</div>`;
            } else {
                sections.forEach(sec => { html += renderSubsection(sec, cat.color); });
            }
            if (type === 'labor' && window._budgetActualLabor) {
                const actual = window._budgetActualLabor;
                const diff = total - actual.total_cost;
                const diffClass = diff >= 0 ? '#4ade80' : '#ef4444';
                const diffLabel = diff >= 0 ? 'Pod rozpočtem' : 'Nad rozpočtem';
                html += `
                <div style="margin-top:16px;padding:16px;background:rgba(74,222,128,0.05);border:1px solid rgba(74,222,128,0.15);border-radius:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <h4 style="margin:0;font-size:14px;font-weight:600;color:#4ade80;display:flex;align-items:center;gap:8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                            </svg>
                            Skutečné náklady z výkazů
                        </h4>
                        <span style="font-size:16px;font-weight:700;color:#e2e8f0;">${fmtCZK(actual.total_cost)}</span>
                    </div>
                    <div style="display:flex;gap:24px;margin-bottom:12px;padding:10px 14px;background:rgba(255,255,255,0.03);border-radius:8px;">
                        <div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;">Rozpočet PRÁCE</div>
                            <div style="font-size:15px;font-weight:600;color:#e2e8f0;">${fmtCZK(total)}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;">Skutečnost</div>
                            <div style="font-size:15px;font-weight:600;color:#e2e8f0;">${fmtCZK(actual.total_cost)}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;">Rozdíl</div>
                            <div style="font-size:15px;font-weight:600;color:${diffClass};">${diff >= 0 ? '+' : ''}${fmtCZK(Math.abs(diff))}</div>
                            <div style="font-size:10px;color:${diffClass};">${diffLabel}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;">Celkem hodin</div>
                            <div style="font-size:15px;font-weight:600;color:#e2e8f0;">${actual.total_hours}h</div>
                        </div>
                    </div>
                    ${actual.by_employee.length ? `
                    <table style="width:100%;border-collapse:collapse;font-size:12px;">
                        <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08);">
                            <th style="text-align:left;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;text-transform:uppercase;">Zaměstnanec</th>
                            <th style="text-align:right;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:80px;">Sazba</th>
                            <th style="text-align:right;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:80px;">Hodiny</th>
                            <th style="text-align:right;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:120px;">Náklady</th>
                        </tr></thead>
                        <tbody>
                            ${actual.by_employee.map(emp => `
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.03);">
                                <td style="padding:6px 8px;color:#e2e8f0;">${escB(emp.name)}</td>
                                <td style="text-align:right;padding:6px 8px;color:rgba(255,255,255,0.5);">${emp.hourly_rate} Kč/h</td>
                                <td style="text-align:right;padding:6px 8px;color:#e2e8f0;">${emp.hours}h</td>
                                <td style="text-align:right;padding:6px 8px;font-weight:600;color:#e2e8f0;">${fmtCZK(emp.cost)}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>` : '<div style="text-align:center;color:rgba(255,255,255,0.3);font-size:12px;">Žádné výkazy na této zakázce</div>'}
                </div>`;
            }
            if (cat.link) {
                html += `<div style="margin-top:8px;padding:8px 12px;font-size:12px;color:rgba(255,255,255,0.3);display:flex;align-items:center;gap:6px;">${cat.link}</div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }

        function renderSubsection(sec, accentColor) {
            let itemsHtml = '';
            if (sec.items && sec.items.length) {
                itemsHtml = `<table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;">
                    <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08);">
                        <th style="text-align:left;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;text-transform:uppercase;">Popis</th>
                        <th style="text-align:center;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:60px;">MJ</th>
                        <th style="text-align:right;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:90px;">Množství</th>
                        <th style="text-align:right;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:120px;">Jedn. cena</th>
                        <th style="text-align:right;padding:4px 8px;color:rgba(255,255,255,0.35);font-weight:500;font-size:11px;width:130px;">Celkem</th>
                        <th style="width:50px;"></th>
                    </tr></thead><tbody>`;
                sec.items.forEach(item => {
                    itemsHtml += `<tr style="border-bottom:1px solid rgba(255,255,255,0.03);">
                        <td style="padding:6px 8px;color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;">${escB(item.description)}${item.note ? '<br><span style="font-size:11px;color:rgba(255,255,255,0.25);">' + escB(item.note) + '</span>' : ''}</td>
                        <td style="text-align:center;padding:6px 8px;color:rgba(255,255,255,0.45);">${item.unit||''}</td>
                        <td style="text-align:right;padding:6px 8px;color:#e2e8f0;">${item.quantity||0}</td>
                        <td style="text-align:right;padding:6px 8px;color:#e2e8f0;">${fmtCZK(item.unit_price)}</td>
                        <td style="text-align:right;padding:6px 8px;font-weight:600;color:#e2e8f0;">${fmtCZK(item.total)}</td>
                        <td style="text-align:center;padding:4px;white-space:nowrap;">
                            <button onclick="editBudgetItem(${item.id})" style="background:none;border:none;cursor:pointer;padding:2px;" title="Upravit"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2" width="13" height="13"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button onclick="deleteBudgetItem(${item.id})" style="background:none;border:none;cursor:pointer;padding:2px;" title="Smazat"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" width="13" height="13"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
                        </td>
                    </tr>`;
                });
                itemsHtml += '</tbody></table>';
            }
            const nameEsc = (sec.name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            return `<div style="background:var(--bg-card,#1a2332);border:1px solid rgba(255,255,255,0.06);border-radius:12px;margin-bottom:10px;overflow:hidden;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(255,255,255,0.02);">
                    <h4 style="margin:0;font-size:14px;font-weight:600;color:#e2e8f0;">${escB(sec.name)}</h4>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <span style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);">${fmtCZK(sec.subtotal)}</span>
                        <button onclick="renameBudgetSec(${sec.id},'${nameEsc}')" style="background:none;border:none;cursor:pointer;padding:2px;" title="Přejmenovat"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2" width="12" height="12"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                        <button onclick="deleteBudgetSec(${sec.id})" style="background:none;border:none;cursor:pointer;padding:2px;" title="Smazat"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" width="12" height="12"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
                    </div>
                </div>
                <div style="padding:2px 6px 10px;">
                    ${itemsHtml}
                    <button onclick="openBIModal(${sec.id})" style="margin-top:8px;display:flex;align-items:center;gap:5px;background:none;border:1px dashed rgba(255,255,255,0.1);border-radius:8px;padding:7px;color:rgba(255,255,255,0.35);cursor:pointer;font-size:12px;width:100%;justify-content:center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Přidat položku
                    </button>
                </div>
            </div>`;
        }

        async function addBudgetSubsection(sectionType) {
            const label = BUDGET_CAT[sectionType]?.label || sectionType;
            const name = prompt('Nová podsekce (' + label + '):\n\nNapříklad: Rostliny, Substráty, Zemní práce, Sadovnické...');
            if (!name || !name.trim()) return;
            const jobId = getJobIdFromUrl();
            try {
                await fetch('/api/jobs/' + jobId + '/budget/sections', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ name: name.trim(), section_type: sectionType })
                });
                loadBudget();
            } catch(e) { console.error(e); }
        }

        async function renameBudgetSec(id, current) {
            const name = prompt('Nový název:', current);
            if (!name || !name.trim()) return;
            try {
                await fetch('/api/budget/sections/' + id, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ name: name.trim() })
                });
                loadBudget();
            } catch(e) { console.error(e); }
        }

        async function deleteBudgetSec(id) {
            if (!confirm('Smazat podsekci včetně všech položek?')) return;
            try {
                await fetch('/api/budget/sections/' + id, { method: 'DELETE' });
                loadBudget();
                if (window.showToast) showToast('Podsekce smazána', 'success');
            } catch(e) { console.error(e); }
        }

        function openBIModal(sectionId, itemData) {
            let m = document.getElementById('biModal');
            if (!m) {
                m = document.createElement('div');
                m.id = 'biModal';
                m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;display:none;align-items:center;justify-content:center;';
                m.innerHTML = `
                <div style="background:var(--bg-card,#1a2332);border:1px solid rgba(255,255,255,0.1);border-radius:16px;width:90%;max-width:480px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08);">
                        <h3 id="biTitle" style="margin:0;font-size:16px;font-weight:600;">Nová položka</h3>
                        <button onclick="closeBIModal()" style="background:none;border:none;cursor:pointer;color:rgba(255,255,255,0.4);font-size:20px;">&times;</button>
                    </div>
                    <div style="padding:20px;">
                        <input type="hidden" id="bi-sec"><input type="hidden" id="bi-id">
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:4px;">Popis *</label>
                            <input type="text" id="bi-desc" placeholder="např. Mulčovací kůra, Hloubení jamek..." style="width:100%;padding:9px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-size:14px;box-sizing:border-box;">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;">
                            <div>
                                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:4px;">MJ</label>
                                <select id="bi-unit" style="width:100%;padding:9px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-size:14px;">
                                    <option value="ks">ks</option><option value="m2">m²</option><option value="m">m</option>
                                    <option value="m3">m³</option><option value="kg">kg</option><option value="hod">hod</option>
                                    <option value="kpl">kpl</option><option value="l">l</option><option value="t">t</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:4px;">Množství</label>
                                <input type="number" id="bi-qty" step="0.01" min="0" value="0" style="width:100%;padding:9px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-size:14px;box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:4px;">Jedn. cena (Kč)</label>
                                <input type="number" id="bi-price" step="0.01" min="0" value="0" style="width:100%;padding:9px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-size:14px;box-sizing:border-box;">
                            </div>
                        </div>
                        <div style="margin-bottom:12px;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:6px;text-align:right;">
                            <span style="color:rgba(255,255,255,0.4);font-size:12px;">Celkem: </span>
                            <span id="bi-preview" style="font-weight:700;font-size:16px;color:#4ade80;">0 Kč</span>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:4px;">Poznámka</label>
                            <input type="text" id="bi-note" placeholder="Volitelná poznámka..." style="width:100%;padding:9px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-size:14px;box-sizing:border-box;">
                        </div>
                        <div style="display:flex;justify-content:flex-end;gap:10px;">
                            <button class="btn-secondary" onclick="closeBIModal()">Zrušit</button>
                            <button class="btn-primary" onclick="saveBudgetItem()">Uložit</button>
                        </div>
                    </div>
                </div>`;
                document.body.appendChild(m);
                ['bi-qty','bi-price'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', function() {
                        const t = (parseFloat(document.getElementById('bi-qty').value)||0) * (parseFloat(document.getElementById('bi-price').value)||0);
                        document.getElementById('bi-preview').textContent = fmtCZK(t);
                    });
                });
                m.addEventListener('click', function(e) { if(e.target===m) closeBIModal(); });
            }
            document.getElementById('bi-sec').value = sectionId;
            document.getElementById('bi-id').value = itemData ? itemData.id : '';
            document.getElementById('biTitle').textContent = itemData ? 'Upravit položku' : 'Nová položka';
            document.getElementById('bi-desc').value = itemData ? itemData.description : '';
            document.getElementById('bi-unit').value = itemData ? (itemData.unit||'ks') : 'ks';
            document.getElementById('bi-qty').value = itemData ? itemData.quantity : 0;
            document.getElementById('bi-price').value = itemData ? itemData.unit_price : 0;
            document.getElementById('bi-note').value = itemData ? (itemData.note||'') : '';
            const t = (parseFloat(document.getElementById('bi-qty').value)||0) * (parseFloat(document.getElementById('bi-price').value)||0);
            document.getElementById('bi-preview').textContent = fmtCZK(t);
            m.style.display = 'flex';
        }

        function closeBIModal() { const m=document.getElementById('biModal'); if(m) m.style.display='none'; }

        async function saveBudgetItem() {
            const secId = document.getElementById('bi-sec').value;
            const itemId = document.getElementById('bi-id').value;
            const desc = document.getElementById('bi-desc').value.trim();
            if (!desc) { alert('Popis je povinný'); return; }
            const payload = {
                description: desc,
                unit: document.getElementById('bi-unit').value,
                quantity: parseFloat(document.getElementById('bi-qty').value)||0,
                unit_price: parseFloat(document.getElementById('bi-price').value)||0,
                note: document.getElementById('bi-note').value.trim()||null
            };
            try {
                const url = itemId ? '/api/budget/items/'+itemId : '/api/budget/sections/'+secId+'/items';
                const res = await fetch(url, {
                    method: itemId ? 'PUT' : 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.ok || data.id) {
                    closeBIModal();
                    loadBudget();
                    if (window.showToast) showToast(itemId ? 'Upraveno' : 'Přidáno', 'success');
                }
            } catch(e) { console.error(e); alert('Chyba při ukládání'); }
        }

        async function editBudgetItem(itemId) {
            const jobId = getJobIdFromUrl();
            try {
                const res = await fetch('/api/jobs/'+jobId+'/budget');
                const data = await res.json();
                for (const sec of (data.sections || [])) {
                    const item = sec.items?.find(i => i.id === itemId);
                    if (item) { openBIModal(sec.id, item); return; }
                }
            } catch(e) { console.error(e); }
        }

        async function deleteBudgetItem(itemId) {
            if (!confirm('Smazat položku?')) return;
            try {
                await fetch('/api/budget/items/'+itemId, {method:'DELETE'});
                loadBudget();
                if (window.showToast) showToast('Smazáno', 'success');
            } catch(e) { console.error(e); }
        }
        
        // Initialize on load
        loadJobData();
    </script>
<script src="/static/js/job-materials-autocomplete.js"></script>
<script src="/static/js/ai-jobs-integration.js"></script>
    <script src="/static/app-sidebar.js"></script>

<!-- Modal: Poznámka k zakázce -->
<div class="modal-overlay" id="jobNoteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:var(--bg-card,#1a2332);border:1px solid rgba(255,255,255,0.1);border-radius:16px;width:90%;max-width:560px;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);">
            <h3 id="jobNoteModalTitle" style="margin:0;font-size:18px;font-weight:600;">Nová poznámka</h3>
            <button onclick="closeJobNoteModal()" style="background:none;border:none;cursor:pointer;color:rgba(255,255,255,0.5);font-size:20px;">&times;</button>
        </div>
        <div style="padding:24px;">
            <input type="hidden" id="jnote-id" value="">
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:6px;">Název (volitelné)</label>
                <input type="text" id="jnote-title" placeholder="Název poznámky..." style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#e2e8f0;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:6px;">Obsah *</label>
                <textarea id="jnote-content" rows="5" placeholder="Text poznámky..." style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#e2e8f0;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                <div>
                    <label style="display:block;font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:6px;">Kategorie</label>
                    <select id="jnote-category" style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#e2e8f0;font-size:14px;">
                        <option value="general">Obecné</option>
                        <option value="measurement">Výměry</option>
                        <option value="observation">Postřehy</option>
                        <option value="idea">Nápady</option>
                        <option value="reminder">Připomínky</option>
                        <option value="issue">Problémy</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:6px;">Barva</label>
                    <div id="jnote-color-picker" style="display:flex;gap:8px;padding-top:4px;">
                        <span class="jnote-color-opt" data-color="default" onclick="pickJNoteColor('default')" style="width:28px;height:28px;border-radius:50%;background:#64748b;cursor:pointer;border:2px solid transparent;"></span>
                        <span class="jnote-color-opt" data-color="green" onclick="pickJNoteColor('green')" style="width:28px;height:28px;border-radius:50%;background:#4ade80;cursor:pointer;border:2px solid transparent;"></span>
                        <span class="jnote-color-opt" data-color="blue" onclick="pickJNoteColor('blue')" style="width:28px;height:28px;border-radius:50%;background:#60a5fa;cursor:pointer;border:2px solid transparent;"></span>
                        <span class="jnote-color-opt" data-color="yellow" onclick="pickJNoteColor('yellow')" style="width:28px;height:28px;border-radius:50%;background:#fbbf24;cursor:pointer;border:2px solid transparent;"></span>
                        <span class="jnote-color-opt" data-color="red" onclick="pickJNoteColor('red')" style="width:28px;height:28px;border-radius:50%;background:#f87171;cursor:pointer;border:2px solid transparent;"></span>
                        <span class="jnote-color-opt" data-color="purple" onclick="pickJNoteColor('purple')" style="width:28px;height:28px;border-radius:50%;background:#a78bfa;cursor:pointer;border:2px solid transparent;"></span>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block;font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:6px;">Přiřadit zaměstnance (volitelné)</label>
                <select id="jnote-employee" style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#e2e8f0;font-size:14px;">
                    <option value="">— Bez přiřazení —</option>
                </select>
            </div>
            
            <div style="display:flex;justify-content:flex-end;gap:12px;">
                <button class="btn-secondary" onclick="closeJobNoteModal()">Zrušit</button>
                <button class="btn-primary" onclick="saveJobNote()">Uložit poznámku</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
