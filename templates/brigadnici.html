{% extends "layout.html" %}
{% block content %}
<div class="page-pad">
  <div class="tabs sticky">
    <a href="/calendar">Kalendář</a>
    <a href="/timesheets.html">Výkazy hodin</a>
    <a href="/jobs">Zakázky</a>
    <a href="/tasks">Úkoly</a>
    <a href="/employees">Zaměstnanci</a>
    <a class="active" href="/brigadnici.html">Brigádníci</a>
    <a href="/stock">Sklad</a>
    <a href="/users">Uživatelé</a>
  
<!-- GLOBAL SEARCH (tables/lists) -->
<div class="card card-dark" style="margin-bottom:10px">
  <div class="card-c">
    <input id="__globalSearch" class="inp" type="search" placeholder="Hledat…">
  </div>
</div>
<script>
(function(){
  const input=document.getElementById('__globalSearch');
  if(!input) return;
  function getSets(){
    const sets=[];
    document.querySelectorAll('table').forEach(t=>{
      const b=t.tBodies&&t.tBodies[0]||t.querySelector('tbody');
      if(b){ const rows=Array.from(b.querySelectorAll('tr')); if(rows.length) sets.push(rows); }
    });
    document.querySelectorAll('.card-list,.jobs-list,.employees-list').forEach(list=>{
      sets.push(Array.from(list.children));
    });
    return sets;
  }
  function apply(){
    const q=(input.value||'').toLowerCase().trim();
    const sets=getSets();
    sets.forEach(rows=>rows.forEach(row=>{
      const text=(row.getAttribute('data-search')||row.innerText||'').toLowerCase();
      row.style.display=!q||text.includes(q)?'':'none';
    }));
  }
  ['input','keyup','search','change'].forEach(ev=>input.addEventListener(ev,apply));
  new MutationObserver(apply).observe(document.body,{childList:true,subtree:true});
  apply();
})();
</script>
<!-- /GLOBAL SEARCH (tables/lists) -->

  <div class="card card-dark">
    <div class="card-h"><strong>Nový brigádník</strong></div>
    <div class="card-c">
      <div class="row">
        <input id="newName" type="text" placeholder="Jméno" class="inp"/>
        <button id="btnAdd" class="btn btn-primary">Přidat</button>
      </div>
    </div>
  </div>

  <div class="card card-dark">
    <div class="card-h"><strong>Seznam</strong></div>
    <div class="card-c">
      <table class="tbl">
        <thead><tr><th>ID</th><th>Jméno</th><th>Role</th></tr></thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(async function(){
  const listBody = document.getElementById('listBody');
  const newName = document.getElementById('newName');
  const btnAdd = document.getElementById('btnAdd');

  async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function apiJSON(url, options){
    const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, options||{}));
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  btnAdd.addEventListener('click', async ()=>{
    const name = newName.value.trim();
    if(!name) return;
    await apiJSON('/api/employees', { method:'POST', body: JSON.stringify({ name, role: 'brigádník' }) });
    newName.value=''; await render();
  });

  async function render(){
    listBody.innerHTML = '<tr><td colspan="3" class="muted">Načítám…</td></tr>';
    const data = await fetchJSON('/api/employees');
    const rows = (data.employees || []).filter(e => String(e.role||'').toLowerCase()==='brigádník');
    if(rows.length===0){
      listBody.innerHTML = '<tr><td colspan="3" class="muted">Žádní brigádníci</td></tr>';
      return;
    }
    listBody.innerHTML = '';
    for(const e of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.id}</td><td>${e.name}</td><td>${e.role||'brigádník'}</td>`;
      listBody.appendChild(tr);
    }
  }
  await render();
})();
</script>
{% endblock %}
