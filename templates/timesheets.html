
{% extends "layout.html" %}
{% block content %}
<div class="topbar" style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
  <a href="/" class="btn back-btn" style="text-decoration:none;">‚Üê Zpƒõt na hlavn√≠</a>
  <h1 style="margin:0;">V√Ωkazy hodin ‚Äî t√Ωden</h1>
</div>

<style>
/* Try to blend with app look: dark cards, soft green bg accents, rounded corners */
:root{
  --gd-green:#2e7d32;
  --gd-bg-soft:#e7f1eb;
  --gd-border:#3a4345;
  --gd-card:#232a2f;
  --gd-card-2:#1f2529;
  --gd-text:#e7ecea;
  --gd-muted:#a2b2aa;
}

body .card{ background:var(--gd-card); border:1px solid var(--gd-border); color:var(--gd-text); }
body .card-h{ background:var(--gd-card-2); border-bottom:1px solid var(--gd-border); color:var(--gd-text); }
body .table th, body .table td{ color:var(--gd-text); }

.btn{ padding:8px 12px; border-radius:10px; border:1px solid #3e4c42; background:#2b342f; color:var(--gd-text); cursor:pointer; }
.btn:hover{ filter:brightness(1.08); }
.btn.primary{ background:var(--gd-green); border-color:var(--gd-green); color:#fff; }
.btn.ghost{ background:transparent; }
.btn.danger{ background:#5a1f1f; border-color:#7d2e2e; color:#ffd6d6; }
.btn.back-btn{ background:transparent; border-color:#3e4c42; }

input, select, textarea{
  background:#1a2023; color:var(--gd-text);
  border:1px solid #3a4345; border-radius:10px; padding:8px 10px;
}

/* === Horizontal lanes (one per day) === */
.week-toolbar { display:flex; gap:8px; align-items:center; margin:10px 0 14px; flex-wrap:wrap; }
.week-toolbar .spacer { flex:1; }
.smallmuted{ font-size:12px; color:var(--gd-muted); }

.week-lanes { display:flex; flex-direction:column; gap:14px; }
.lane { background:var(--gd-card); border:1px solid var(--gd-border); border-radius:14px; overflow:hidden; }
.lane-head { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#23302a; }
.lane-head .title { font-weight:700; color:#fff; }
.lane-head small { color:var(--gd-muted); font-weight:400; }

.lane-body { padding:12px; display:flex; flex-direction:column; gap:10px; }

/* Entry pill: full-width horizontal item */
.entry-pill{
  display:flex; align-items:center; gap:12px;
  background:#1d2427; border:1px solid #344046; border-radius:12px;
  padding:10px 12px; width:100%;
}
.entry-hours{
  min-width:46px; text-align:center; padding:4px 8px; border-radius:999px;
  background:#1c3c22; border:1px solid #2f5f3a; color:#d7f2e0; font-weight:600;
}
.entry-main{ display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
.entry-top{ display:flex; align-items:center; gap:8px; }
.entry-job{ font-weight:700; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.entry-meta{ font-size:12px; color:var(--gd-muted); display:flex; gap:12px; flex-wrap:wrap; }
.entry-actions{ display:flex; gap:8px; }
.add-row{ display:flex; justify-content:flex-end; padding:10px 12px; border-top:1px dashed #344046; }
.add-pill{ border:1px dashed #4a5c55; border-radius:999px; padding:8px 14px; background:#1b2225; color:#cfe2d6; cursor:pointer; }

/* Modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal{ width:min(560px, 92vw); background:#1c2124; border-radius:14px; border:1px solid #3a4345; overflow:hidden; color:var(--gd-text); }
.modal-h{ padding:12px 14px; font-weight:600; border-bottom:1px solid #3a4345; background:#21282c; }
.modal-c{ padding:14px; display:grid; gap:10px; }
.modal-f{ padding:12px 14px; display:flex; justify-content:flex-end; border-top:1px solid #3a4345; gap:8px; background:#1a2023; }
.form-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.form-row > label{ display:flex; flex-direction:column; gap:4px; font-size:13px; }

/* date input tweaks for dark */
input[type="date"]::-webkit-calendar-picker-indicator{ filter:invert(1) hue-rotate(120deg); }
</style>

<div class="card">
  <div class="card-c">
    <div class="week-toolbar">
      <label>T√Ωden od <input id="weekStart" type="date"/></label>
      <button id="prevWeek" class="btn ghost">‚Üê P≈ôedchoz√≠</button>
      <button id="nextWeek" class="btn ghost">N√°sleduj√≠c√≠ ‚Üí</button>
      <span id="weekLabel" class="smallmuted"></span>
      <div class="spacer"></div>
      <label>Filtrovat zamƒõstnance
        <select id="filterEmployee"><option value="">V≈°ichni</option></select>
      </label>
      <label>Filtrovat zak√°zku
        <select id="filterJob"><option value="">V≈°e</option></select>
      </label>
      <button id="exportCsv" class="btn">Export CSV (t√Ωden)</button>
    </div>

    <div id="lanes" class="week-lanes"></div>
    <div class="smallmuted" style="margin-top:8px;">Ka≈æd√Ω den je vodorovn√Ω pruh; z√°znamy jsou horizont√°ln√≠ bu≈àky pod sebou.</div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-h" id="modalTitle">Nov√Ω z√°znam</div>
    <div class="modal-c">
      <div class="form-row">
        <label>Zamƒõstnanec
          <select id="fEmployee"></select>
        </label>
        <label>Zak√°zka
          <select id="fJob"></select>
        </label>
        <label>Datum
          <input id="fDate" type="date"/>
        </label>
      </div>
      <div class="form-row">
        <label>Hodin
          <input id="fHours" type="number" min="0" step="0.25" placeholder="8"/>
        </label>
        <label>M√≠sto
          <input id="fPlace" type="text" placeholder=""/>
        </label>
      </div>
      <div class="form-row" style="flex-direction:column; align-items:stretch;">
        <label>ƒåinnost
          <textarea id="fActivity" rows="2" placeholder=""></textarea>
        </label>
      </div>
    </div>
    <div class="modal-f">
      <button id="btnDelete" class="btn danger" style="display:none;">Smazat</button>
      <div style="flex:1"></div>
      <button id="btnCancel" class="btn ghost">Zru≈°it</button>
      <button id="btnSave" class="btn primary">Ulo≈æit</button>
    </div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
function toISO(d){ const z = new Date(d.getTime() - d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
function fromISO(s){ const [y,m,d]=s.split('-').map(Number); const dt = new Date(Date.UTC(y,m-1,d)); return new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate()); }
function mondayOf(d){ const day=d.getDay()||7; const nd = new Date(d); nd.setDate(d.getDate() - (day-1)); nd.setHours(0,0,0,0); return nd; }
function addDays(d,n){ const nd=new Date(d); nd.setDate(d.getDate()+n); return nd; }
function fmtCZ(d){ return d.toLocaleDateString('cs-CZ', {weekday:'short', day:'2-digit', month:'2-digit'}).replace(/^./, c=>c.toUpperCase()); }
function toCZ(s){ try{ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; }catch(e){ return s; } }

let employees=[], jobs=[], rows=[];
let weekStart = mondayOf(new Date());
let modalState = { mode:"create", id:null };

async function api(url, opts){ const r = await fetch(url, {credentials:'same-origin', ...opts}); if(!r.ok) throw new Error(await r.text()); const ct=r.headers.get('content-type')||''; return ct.includes('application/json')? r.json() : r; }

function updateWeekControls(){
  $("#weekStart").value = toISO(weekStart);
  const ws = new Date(weekStart);
  const we = addDays(ws,6);
  $("#weekLabel").innerText = `(${fmtCZ(ws)} ‚Äî ${fmtCZ(we)})`;
}

function buildLanes(){
  const lanes = $("#lanes"); lanes.innerHTML="";
  for(let i=0;i<7;i++){
    const d = addDays(weekStart,i);
    const iso = toISO(d);
    const lane = document.createElement("div");
    lane.className="lane";
    lane.innerHTML = `
      <div class="lane-head"><div class="title">${fmtCZ(d)}</div><small>${toCZ(iso)}</small></div>
      <div class="lane-body" data-day="${iso}"></div>
      <div class="add-row"><div class="add-pill" data-add="${iso}">Ôºã P≈ôidat z√°znam</div></div>
    `;
    lanes.appendChild(lane);
  }
}

function renderEntries(){
  const empFilter = $("#filterEmployee").value;
  const jobFilter = $("#filterJob").value;
  $$(".lane-body").forEach(n=>n.innerHTML="");
  for(const r of rows){
    if(empFilter && String(r.employee_id)!==String(empFilter)) continue;
    if(jobFilter && String(r.job_id)!==String(jobFilter)) continue;
    const body = document.querySelector(`.lane-body[data-day="${r.date}"]`);
    if(!body) continue;
    const card = document.createElement("div");
    card.className = "entry-pill";
    card.innerHTML = `
      <div class="entry-hours">${r.hours} h</div>
      <div class="entry-main">
        <div class="entry-top">
          <div class="entry-job">${r.job_title || ("Zak√°zka #"+r.job_id)}</div>
        </div>
        <div class="entry-meta">
          <span>üë§ ${r.employee_name || r.employee_id}</span>
          ${r.place? `<span>üìç ${r.place}</span>`:""}
        </div>
        ${r.activity? `<div class="smallmuted">${r.activity}</div>`:""}
      </div>
      <div class="entry-actions">
        <button class="btn ghost" data-edit="${r.id}" title="Upravit">‚úèÔ∏è</button>
      </div>
    `;
    body.appendChild(card);
  }
}

function fillSelect(el, items, idKey, labelKey){
  el.innerHTML="";
  for(const it of items){
    const opt = document.createElement("option");
    opt.value = it[idKey]; opt.textContent = it[labelKey];
    el.appendChild(opt);
  }
}

async function loadAll(){
  const ws = toISO(weekStart), we = toISO(addDays(weekStart,6));
  const [emps, js, ts] = await Promise.all([
    api("/api/employees"),
    api("/api/jobs"),
    api(`/api/timesheets?from=${ws}&to=${we}`),
  ]);
  employees = (emps.employees||[]).sort((a,b)=>String(a.name).localeCompare(b.name));
  jobs = (js.jobs||[]).sort((a,b)=>String(a.title).localeCompare(b.title));
  rows = ts.rows || [];

  const filterEmp = $("#filterEmployee");
  const filterJob = $("#filterJob");
  filterEmp.innerHTML = `<option value="">V≈°ichni</option>` + employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  filterJob.innerHTML = `<option value="">V≈°e</option>` + jobs.map(j=>`<option value="${j.id}">${j.title}</option>`).join("");

  fillSelect($("#fEmployee"), employees, "id", "name");
  fillSelect($("#fJob"), jobs, "id", "title");

  buildLanes();
  renderEntries();
}

function openModal(mode, data){
  modalState = {mode, id: data?.id||null};
  $("#modalTitle").innerText = mode==="edit"? "Upravit z√°znam" : "Nov√Ω z√°znam";
  $("#btnDelete").style.display = mode==="edit"? "" : "none";
  if(mode==="edit"){
    $("#fEmployee").value = String(data.employee_id);
    $("#fJob").value = String(data.job_id);
    $("#fDate").value = data.date;
    $("#fHours").value = data.hours;
    $("#fPlace").value = data.place || "";
    $("#fActivity").value = data.activity || "";
  }else{
    $("#fEmployee").value = "";
    $("#fJob").value = "";
    $("#fDate").value = data?.date || toISO(new Date());
    $("#fHours").value = "";
    $("#fPlace").value = "";
    $("#fActivity").value = "";
  }
  $("#modal").style.display = "flex";
}

function closeModal(){ $("#modal").style.display="none"; }

async function saveModal(){
  const payload = {
    employee_id: Number($("#fEmployee").value),
    job_id: Number($("#fJob").value),
    date: $("#fDate").value,
    hours: Number($("#fHours").value || 0),
    place: $("#fPlace").value || "",
    activity: $("#fActivity").value || ""
  };
  if(modalState.mode==="edit"){
    payload.id = modalState.id;
    await api("/api/timesheets", {method:"PATCH", headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }else{
    await api("/api/timesheets", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }
  closeModal();
  await loadAll();
}

async function deleteModal(){
  if(!confirm("Smazat z√°znam?")) return;
  await api("/api/timesheets?id="+modalState.id, {method:"DELETE"});
  closeModal();
  await loadAll();
}

// Events
$("#prevWeek").addEventListener("click", ()=>{ weekStart = new Date(weekStart.getTime()-7*86400000); updateWeekControls(); loadAll(); });
$("#nextWeek").addEventListener("click", ()=>{ weekStart = new Date(weekStart.getTime()+7*86400000); updateWeekControls(); loadAll(); });
$("#weekStart").addEventListener("change", (e)=>{ weekStart = mondayOf(fromISO(e.target.value)); updateWeekControls(); loadAll(); });
$("#filterEmployee").addEventListener("change", renderEntries);
$("#filterJob").addEventListener("change", renderEntries);

document.addEventListener("click", (e)=>{
  const add = e.target.closest("[data-add]");
  if(add){ openModal("create", {date:add.getAttribute("data-add")}); }
  const editBtn = e.target.closest("[data-edit]");
  if(editBtn){
    const id = Number(editBtn.getAttribute("data-edit"));
    const item = rows.find(r=>r.id===id);
    if(item){ openModal("edit", item); }
  }
});

$("#btnSave").addEventListener("click", ()=>saveModal().catch(err=>alert(err.message||String(err))));
$("#btnCancel").addEventListener("click", ()=>closeModal());
$("#btnDelete").addEventListener("click", ()=>deleteModal().catch(err=>alert(err.message||String(err))));

$("#exportCsv").addEventListener("click", async ()=>{
  const ws = toISO(weekStart), we = toISO(addDays(weekStart,6));
  const emp = $("#filterEmployee").value;
  const job = $("#filterJob").value;
  const url = new URL(location.origin + "/api/timesheets/export");
  url.searchParams.set("from", ws); url.searchParams.set("to", we);
  if(emp) url.searchParams.set("employee_id", emp);
  if(job) url.searchParams.set("job_id", job);
  const r = await fetch(url.toString());
  if(!r.ok){ alert("Export selhal"); return; }
  const blob = await r.blob();
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `timesheets_${ws}_${we}.csv`;
  link.click();
  URL.revokeObjectURL(link.href);
});

(function init(){
  weekStart = mondayOf(new Date());
  updateWeekControls();
  loadAll().catch(err=>alert(err.message||String(err)));
})();
</script>
{% endblock %}
