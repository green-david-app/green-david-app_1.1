{% extends "layout.html" %}
{% block content %}
<div class="ts-card">
  <a href="/" class="btn ghost ts-ghost">← Zpět na hlavní</a>
  <h1 class="ts-title">Výkazy hodin — týden</h1>

  <div class="toolbar ts-toolbar">
    <label>Týden od <input id="weekStart" type="date"/></label>
    <button id="prevWeek" class="ghost ts-chip">← Předchozí</button>
    <button id="nextWeek" class="ghost ts-chip">Následující →</button>
    <div class="spacer"></div>
    <label>Filtrovat zakázku <select id="filterJob"><option value="">Vše</option></select></label>
    <label>Filtrovat zaměstnance <select id="filterEmployee"><option value="">Všichni</option></select></label>
  </div>

  <div class="subbar ts-toolbar">
    <button id="exportCsv" class="ts-primary">Export CSV (týden)</button>
    <span id="weekRange" class="muted small"></span>
  </div>
</div>

<div id="week" class="week"></div>

<style>
  /* === Top card: GRAY like other cards; inverted contrast === */
  .ts-card{
    background:#e6e6e6; /* šedá karta */
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    padding:14px 16px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.24);
    margin-bottom:16px;
    color:#1b5e20; /* default text v kartě jemně do zelena */
  }
  .ts-title{
    font-size:16px; /* požadovaných ~16 */
    line-height:1.25;
    margin:10px 0 12px;
    font-weight:800;
    color:#2e7d32; /* sytější zelená pro titulek */
  }
  .ts-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .spacer{flex:1;}
  /* invertované "chip" prvky (předchozí/následující, datumy apod.) */
  .ts-chip{
    background:#2e7d32; /* zelené pozadí */
    color:#e6e6e6;      /* šedé/bílé písmo na zeleném */
    border:none;
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
  }
  /* ghost odkaz v šedé kartě – zelený text, šedé orámování */
  .ts-ghost{
    border:1px solid rgba(46,125,50,.35);
    color:#2e7d32;
    border-radius:10px;
    padding:8px 12px;
    text-decoration:none;
    background:transparent;
  }
  /* selecty a inputy – neutrální, ať ladí se šedou kartou */
  .ts-card select, .ts-card input[type=date]{
    padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,.12);
    background:#f4f4f4;color:#1b5e20;
  }
  /* hlavní akční tlačítko – zelené, s bílým textem */
  .ts-primary{
    background:#2e7d32;color:#ffffff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;
  }
  .small{font-size:12px} .muted{opacity:.65}

  /* === Týdenní bloky (ponecháno tmavé) === */
  .week{display:flex;flex-direction:column;gap:14px;}
  .day{background:#0b0b0b; color:#f1f5f1; border-radius:14px; padding:12px 14px;}
  .day-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;opacity:.9}
  .entry{background:#e8f3ea;color:#0c2b14;border-radius:12px;padding:10px 12px;margin:8px 0;display:flex;gap:10px;align-items:center;}
  .pill{display:inline-block;border-radius:999px;padding:3px 8px;background:#cfead5;margin-left:6px;font-size:12px;}
  .day-empty{opacity:.6;font-style:italic}
</style>

<script>
(function(){
  const elWeek = document.getElementById('week');
  const elWeekStart = document.getElementById('weekStart');
  const elPrev = document.getElementById('prevWeek');
  const elNext = document.getElementById('nextWeek');
  const elRange = document.getElementById('weekRange');
  const elFJob = document.getElementById('filterJob');
  const elFEmp = document.getElementById('filterEmployee');
  const elExport = document.getElementById('exportCsv');

  const fmt = (d)=> d.toISOString().slice(0,10);
  const parse = (s)=> { const [y,m,dd] = s.split('-').map(x=>parseInt(x,10)); return new Date(y, m-1, dd); };
  const monday = (d)=>{ const x = new Date(d); const wd = x.getDay(); const diff = (wd===0?6:wd-1); x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; };
  const addDays = (d,n)=>{ const x = new Date(d); x.setDate(x.getDate()+n); return x; };

  async function fetchJSON(url){
    const r = await fetch(url, {credentials:'same-origin'});
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function loadFilters(){
    try{
      const jobs = await fetchJSON('/api/jobs');
      jobs.jobs.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j.id; opt.textContent = j.title + (j.code?(' ('+j.code+')'):''); elFJob.appendChild(opt);
      });
    }catch(e){}
    try{
      const emps = await fetchJSON('/api/employees');
      (emps.employees||[]).forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id; opt.textContent = e.name; elFEmp.appendChild(opt);
      });
    }catch(e){}
  }

  async function renderWeek(){
    const start = monday(parse(elWeekStart.value));
    const end = addDays(start, 6);
    elRange.textContent = '(' + start.toLocaleDateString('cs-CZ') + ' — ' + end.toLocaleDateString('cs-CZ') + ')';

    const q = new URLSearchParams();
    q.set('from', fmt(start));
    q.set('to', fmt(end));
    if(elFJob.value) q.set('job_id', elFJob.value);
    if(elFEmp.value) q.set('employee_id', elFEmp.value);

    const data = await fetchJSON('/api/timesheets?' + q.toString());
    const rows = (data.rows||[]);
    const byDate = {};
    for(const r of rows){
      const d = (r.date||'').slice(0,10);
      (byDate[d] ||= []).push(r);
    }
    elWeek.innerHTML='';
    for(let i=0;i<7;i++){
      const d = addDays(start, i);
      const dstr = fmt(d);
      const box = document.createElement('div'); box.className='day';
      const head = document.createElement('div'); head.className='day-h';
      head.innerHTML = '<div><strong>'+d.toLocaleDateString('cs-CZ', {weekday:'short'})+'</strong> <span class="muted small">'+d.toLocaleDateString('cs-CZ')+'</span></div>' +
                       '<div class="muted small">'+(byDate[dstr]? byDate[dstr].length : 0)+' záznamů</div>';
      box.appendChild(head);
      const list = document.createElement('div');
      const items = (byDate[dstr]||[]);
      if(items.length===0){
        const empty = document.createElement('div'); empty.className='day-empty'; empty.textContent='Žádné záznamy';
        list.appendChild(empty);
      }else{
        for(const r of items){
          const it = document.createElement('div'); it.className='entry';
          const hours = document.createElement('span'); hours.className='pill'; hours.textContent = (r.hours||0)+' h';
          it.innerHTML = '<strong>'+ (r.employee_name||('ID '+r.employee_id)) +'</strong>' +
                         ' · ' + (r.job_title||('Zakázka '+r.job_id)) +
                         (r.place? ' · '+r.place : '') +
                         (r.activity? ' — '+r.activity : '');
          it.appendChild(hours);
          list.appendChild(it);
        }
      }
      box.appendChild(list);
      elWeek.appendChild(box);
    }
  }

  document.getElementById('prevWeek').addEventListener('click', ()=>{ const d=parse(elWeekStart.value); d.setDate(d.getDate()-7); elWeekStart.value=fmt(d); renderWeek().catch(console.error); });
  document.getElementById('nextWeek').addEventListener('click', ()=>{ const d=parse(elWeekStart.value); d.setDate(d.getDate()+7); elWeekStart.value=fmt(d); renderWeek().catch(console.error); });
  document.getElementById('filterJob').addEventListener('change', ()=>renderWeek().catch(console.error));
  document.getElementById('filterEmployee').addEventListener('change', ()=>renderWeek().catch(console.error));
  document.getElementById('exportCsv').addEventListener('click', ()=>{
    const start = monday(parse(elWeekStart.value));
    const end = addDays(start, 6);
    const q = new URLSearchParams();
    q.set('from', fmt(start)); q.set('to', fmt(end));
    const fj = document.getElementById('filterJob').value;
    const fe = document.getElementById('filterEmployee').value;
    if(fj) q.set('job_id', fj);
    if(fe) q.set('employee_id', fe);
    window.location.href = '/api/timesheets/export?' + q.toString();
  });

  const today = new Date();
  const startMonday = (new Date(today.setDate(today.getDate() - ((today.getDay()+6)%7))));
  startMonday.setHours(0,0,0,0);
  document.getElementById('weekStart').value = startMonday.toISOString().slice(0,10);
  loadFilters().finally(()=>renderWeek().catch(console.error));
})();
</script>
{% endblock %}