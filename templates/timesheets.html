{% extends "layout.html" %}
{% block content %}
<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
  <a href="/dashboard" class="btn ghost" style="text-decoration:none;">‚Üê Zpƒõt na hlavn√≠</a>
  <h1 style="margin:0;">V√Ωkazy hodin ‚Äî t√Ωden</h1>
</div>

<style>
/* Only minimal overrides; inherit fonts/colors from the app */
.week-toolbar { display:flex; gap:8px; align-items:center; margin:10px 0 14px; flex-wrap:wrap; }
.week-toolbar .spacer { flex:1; }
.smallmuted{ font-size:12px; opacity:0.75; }

.week-lanes { display:flex; flex-direction:column; gap:14px; }
.lane { border:1px solid #e0e6e2; border-radius:14px; background:#f3f7f5; overflow:hidden; }
.lane-head { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#e8f2ec; }
.lane-head .title { font-weight:700; }
.lane-head small { opacity:0.7; }

.lane-body { padding:10px; display:flex; flex-direction:column; gap:8px; }

/* Slim entry: rounded, light green, horizontal; ORDER: name -> place -> hours -> activity */
.entry-pill{
  display:flex; align-items:center; gap:10px;
  background:#eaf4ed; border:1px solid #cfe3d5; border-radius:12px;
  padding:6px 10px; width:100%;
}
.entry-main{ display:flex; flex-direction:row; align-items:center; gap:14px; flex-wrap:wrap; flex:1; min-width:0; }
.entry-name{ font-weight:700; }
.entry-place{ opacity:0.8; }
.entry-hours{
  padding:2px 8px; border-radius:999px; border:1px solid #b7d2c0; background:#dff0e6;
  font-weight:600;
}
.entry-activity{ opacity:0.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:50vw; }
.entry-actions{ display:flex; gap:6px; }
.add-row{ display:flex; justify-content:flex-end; padding:8px 10px; border-top:1px dashed #d6e6de; }
.add-pill{ border:1px dashed #b7c7bd; border-radius:999px; padding:6px 12px; background:#f9fbfa; cursor:pointer; }
</style>

<div class="card">
  <div class="card-c">
    <div class="week-toolbar">
      <label>T√Ωden od <input id="weekStart" type="date"/></label>
      <button id="prevWeek" class="ghost">‚Üê P≈ôedchoz√≠</button>
      <button id="nextWeek" class="ghost">N√°sleduj√≠c√≠ ‚Üí</button>
      <span id="weekLabel" class="smallmuted"></span>
      <div class="spacer"></div>
      <label>Filtrovat zamƒõstnance
        <select id="filterEmployee"><option value="">V≈°ichni</option></select>
      </label>
      <label>Filtrovat zak√°zku
        <select id="filterJob"><option value="">V≈°e</option></select>
      </label>
      <button id="exportCsv">Export CSV (t√Ωden)</button>
    </div>

    <div id="lanes" class="week-lanes"></div>
    <div class="add-row">
      <button class="add-pill" data-add>+ P≈ôidat z√°znam</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="card" style="min-width:640px; max-width:95%;">
    <div class="card-h"><div id="modalTitle">Nov√Ω z√°znam</div></div>
    <div class="card-c">
      <div class="form-row">
        <label>Zamƒõstnanec <select id="fEmployee"></select></label>
        <label>Zak√°zka <select id="fJob"></select></label>
        <label>Datum <input id="fDate" type="date"/></label>
        <label>Hodin <input id="fHours" type="number" step="0.25"/></label>
      </div>
      <div class="form-row">
        <input id="fPlace" placeholder="M√≠sto" style="flex:1"/>
        <input id="fActivity" placeholder="Popis ƒçinnosti" style="flex:2"/>
      </div>
    </div>
    <div class="card-f" style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="btnDelete" class="ghost" style="display:none">Smazat</button>
      <button id="btnCancel" class="ghost">Zru≈°it</button>
      <button id="btnSave" class="btn">Ulo≈æit</button>
    </div>
  </div>
</div>

<script>
// --- Helper utilities (keep tiny to avoid style drift) ---
function $(s){ return document.querySelector(s); }
function addDays(d, n){ const x = new Date(d.getTime()+n*86400000); return x; }
function mondayOf(d){ const x = new Date(d); const day=(x.getDay()||7)-1; x.setHours(0,0,0,0); return addDays(x, -day); }
function toISO(d){ return new Date(d).toISOString().slice(0,10); }
function fromISO(s){ const [y,m,dd]=s.split('-').map(Number); return new Date(y, m-1, dd); }
let weekStart = mondayOf(new Date());
let rows=[], employees=[], jobs=[], modalState={mode:'create', id:null};

function api(path, opts){ return fetch(path, opts).then(r=>r.json()); }

function updateWeekControls(){
  $("#weekStart").value = toISO(weekStart);
  $("#weekLabel").textContent = `(Po ${toISO(weekStart)} ‚Äî Ne ${toISO(addDays(weekStart,6))})`;
}

function buildLanes(){
  const lanes = $("#lanes"); lanes.innerHTML = "";
  for(let i=0;i<7;i++){
    const d = addDays(weekStart,i);
    const el = document.createElement("div");
    el.className="lane";
    el.innerHTML = '<div class="lane-head"><div class="title">'
      + d.toLocaleDateString('cs-CZ', { weekday:'short', day:'2-digit', month:'2-digit'}) +
      '</div><small data-count></small></div><div class="lane-body" data-day="'+toISO(d)+'"></div>';
    lanes.appendChild(el);
  }
}

function renderEntries(){
  document.querySelectorAll(".lane-body").forEach(b=>b.innerHTML="");
  const byDate = {};
  for(const r of rows){ (byDate[r.date]=byDate[r.date]||[]).push(r); }
  document.querySelectorAll(".lane").forEach(lane=>{
    const body = lane.querySelector(".lane-body");
    const date = body.getAttribute("data-day");
    const list = byDate[date]||[];
    lane.querySelector("[data-count]").textContent = list.length ? list.length + " z√°znam≈Ø" : "";
    for(const r of list){
      const card = document.createElement("div");
      card.className = "entry-pill";
      card.innerHTML = `
        <div class="entry-main">
          <div class="entry-name">${r.employee_name || r.employee_id}</div>
          ${r.place? `<div class="entry-place">üìç ${r.place}</div>`:""}
          <div class="entry-hours">${r.hours} h</div>
          ${r.activity? `<div class="entry-activity">${r.activity}</div>`:""}
        </div>
        <div class="entry-actions">
          <button class="ghost" data-edit="${r.id}" title="Upravit">‚úèÔ∏è</button>
        </div>
      `;
      body.appendChild(card);
    }
  });
}

function fillSelect(el, items, idKey, labelKey){
  el.innerHTML="";
  for(const it of items){
    const opt = document.createElement("option");
    opt.value = it[idKey]; opt.textContent = it[labelKey];
    el.appendChild(opt);
  }
}

async function loadAll(){
  const ws = toISO(weekStart), we = toISO(addDays(weekStart,6));
  const [emps, js, ts] = await Promise.all([
    api("/api/employees"),
    api("/api/jobs"),
    api(`/api/timesheets?from=${ws}&to=${we}`),
  ]);
  employees = (emps.employees||[]).sort((a,b)=>String(a.name).localeCompare(b.name));
  jobs = (js.jobs||[]).sort((a,b)=>String(a.title).localeCompare(b.title));
  rows = ts.rows || [];

  $("#filterEmployee").innerHTML = `<option value="">V≈°ichni</option>` + employees.map(e=>`<option value="\${e.id}">\${e.name}</option>`).join("");
  $("#filterJob").innerHTML = `<option value="">V≈°e</option>` + jobs.map(j=>`<option value="\${j.id}">\${j.title}</option>`).join("");

  fillSelect($("#fEmployee"), employees, "id", "name");
  fillSelect($("#fJob"), jobs, "id", "title");

  buildLanes();
  renderEntries();
}

function openModal(mode, data){
  modalState = {mode, id: data?.id||null};
  $("#modalTitle").innerText = mode==="edit"? "Upravit z√°znam" : "Nov√Ω z√°znam";
  $("#btnDelete").style.display = mode==="edit"? "" : "none";
  if(mode==="edit"){
    $("#fEmployee").value = String(data.employee_id);
    $("#fJob").value = String(data.job_id);
    $("#fDate").value = data.date;
    $("#fHours").value = data.hours;
    $("#fPlace").value = data.place || "";
    $("#fActivity").value = data.activity || "";
  }else{
    $("#fEmployee").value = "";
    $("#fJob").value = "";
    $("#fDate").value = data?.date || toISO(new Date());
    $("#fHours").value = "";
    $("#fPlace").value = "";
    $("#fActivity").value = "";
  }
  $("#modal").style.display = "flex";
}

function closeModal(){ $("#modal").style.display="none"; }

async function saveModal(){
  const payload = {
    employee_id: Number($("#fEmployee").value),
    job_id: Number($("#fJob").value),
    date: $("#fDate").value,
    hours: Number($("#fHours").value || 0),
    place: $("#fPlace").value || "",
    activity: $("#fActivity").value || ""
  };
  if(modalState.mode==="edit"){
    payload.id = modalState.id;
    await fetch("/api/timesheets", {method:"PATCH", headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }else{
    await fetch("/api/timesheets", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }
  closeModal();
  await loadAll();
}

async function deleteModal(){
  if(!confirm("Smazat z√°znam?")) return;
  await fetch("/api/timesheets?id="+modalState.id, {method:"DELETE"});
  closeModal();
  await loadAll();
}

// Events
$("#prevWeek").addEventListener("click", ()=>{ weekStart = new Date(weekStart.getTime()-7*86400000); updateWeekControls(); loadAll(); });
$("#nextWeek").addEventListener("click", ()=>{ weekStart = new Date(weekStart.getTime()+7*86400000); updateWeekControls(); loadAll(); });
$("#weekStart").addEventListener("change", (e)=>{ weekStart = mondayOf(fromISO(e.target.value)); updateWeekControls(); loadAll(); });

document.addEventListener("click", (e)=>{
  const add = e.target.closest("[data-add]");
  if(add){ openModal("create", {date:toISO(weekStart)}); }
  const editBtn = e.target.closest("[data-edit]");
  if(editBtn){
    const id = Number(editBtn.getAttribute("data-edit"));
    const item = rows.find(r=>r.id===id);
    if(item){ openModal("edit", item); }
  }
});

$("#btnSave").addEventListener("click", ()=>saveModal().catch(err=>alert(err.message||String(err))));
$("#btnCancel").addEventListener("click", ()=>closeModal());
$("#btnDelete").addEventListener("click", ()=>deleteModal().catch(err=>alert(err.message||String(err))));

(function init(){
  weekStart = mondayOf(new Date());
  updateWeekControls();
  loadAll().catch(err=>alert(err.message||String(err)));
})();
</script>
{% endblock %}
