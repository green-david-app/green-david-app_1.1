{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="container">
    <!-- Page Header -->
    <div class="ts-page-header">
      <h1 class="ts-page-title">V√Ωkazy hodin</h1>
      <p class="ts-page-subtitle">Modern√≠ timeline view s barevn√Ωm k√≥dov√°n√≠m a statistikami</p>
    </div>

    <!-- View Toggle -->
    <div class="ts-view-toggle">
      <button id="viewList" class="ts-view-btn active">üìã Seznam</button>
      <button id="viewTimeline" class="ts-view-btn">üìÖ Timeline</button>
      <button id="viewStats" class="ts-view-btn">üìä Statistiky</button>
    </div>

    <!-- Toolbar -->
    <div class="ts-toolbar">
      <div class="ts-week-nav">
        <button id="prevWeek" class="ts-nav-btn">‚Üê P≈ôedchoz√≠</button>
        <div id="weekLabel" class="ts-week-label">23. - 29. prosince 2025</div>
        <button id="nextWeek" class="ts-nav-btn">Dal≈°√≠ ‚Üí</button>
      </div>
      <div class="ts-actions">
        <button id="toggleFilters" class="btn btn-secondary">üîç Filtry</button>
        <button id="bulkActions" class="btn btn-secondary" style="display:none;">‚öôÔ∏è Hromadn√© akce</button>
        <button id="exportCsv" class="btn btn-secondary">üìä Export</button>
        <button id="copyWeek" class="btn btn-secondary">üìã Kop√≠rovat t√Ωden</button>
        <button id="addTimesheet" class="btn btn-primary">+ P≈ôidat v√Ωkaz</button>
      </div>
    </div>

    <!-- Filters -->
    <div id="filtersPanel" class="ts-filters-panel" style="display:none;">
      <div class="ts-filter-group">
        <label>Zamƒõstnanec:</label>
        <select id="filterEmployee" class="form-select" style="width:auto;"><option value="">v≈°ichni</option></select>
      </div>
      <div class="ts-filter-group">
        <label>Zak√°zka:</label>
        <select id="filterJob" class="form-select" style="width:auto;"><option value="">v≈°e</option></select>
      </div>
    </div>

    <!-- Project Color Legend -->
    <div id="projectLegend" class="ts-legend">
      <div class="ts-legend-title">Barevn√© k√≥dov√°n√≠ projekt≈Ø:</div>
      <div id="legendItems" class="ts-legend-items"></div>
    </div>

    <!-- Enhanced Summary Bar -->
    <div class="ts-summary-bar">
      <div class="ts-summary-item">
        <div class="ts-summary-label">Celkem hodin</div>
        <div id="summaryTotal" class="ts-summary-value">0h</div>
      </div>
      <div class="ts-summary-item">
        <div class="ts-summary-label">Pr≈Ømƒõr na den</div>
        <div id="summaryAvg" class="ts-summary-value">0h</div>
      </div>
      <div class="ts-summary-item">
        <div class="ts-summary-label">Aktivn√≠ch projekt≈Ø</div>
        <div id="summaryProjects" class="ts-summary-value">0</div>
      </div>
      <div class="ts-summary-item">
        <div class="ts-summary-label">Overtime</div>
        <div id="summaryOvertime" class="ts-summary-value" style="color:var(--text-secondary);">0h</div>
      </div>
      <div class="ts-summary-item">
        <div class="ts-summary-label">vs. minul√Ω t√Ωden</div>
        <div id="summaryTrend" class="ts-summary-value" style="color:var(--text-secondary);">‚Äî</div>
      </div>
    </div>

    <!-- Heat Map Week -->
    <div id="heatMapWeek" class="ts-heatmap">
      <div class="ts-heatmap-title">Vizualizace zat√≠≈æen√≠ t√Ωdne</div>
      <div id="heatMapDays" class="ts-heatmap-days"></div>
    </div>

    <!-- Statistics Panel -->
    <div id="statsPanel" class="ts-stats-panel" style="display:none;">
      <div class="ts-stats-grid">
        <div class="ts-stat-card">
          <div class="ts-stat-title">Rozpad hodin po projektech</div>
          <div id="donutChart" class="ts-chart"></div>
        </div>
        <div class="ts-stat-card">
          <div class="ts-stat-title">Trend hodin (4 t√Ωdny)</div>
          <div id="lineChart" class="ts-chart"></div>
        </div>
        <div class="ts-stat-card">
          <div class="ts-stat-title">Top 5 projekt≈Ø tento t√Ωden</div>
          <div id="topProjects" class="ts-top-list"></div>
        </div>
      </div>
    </div>

    <!-- Timeline View -->
    <div id="timelineView" class="ts-timeline-view" style="display:none;">
      <div class="ts-timeline-header">
        <div class="ts-timeline-time-col">ƒåas</div>
        <div class="ts-timeline-days">
          <div class="ts-timeline-day" data-day="0">Po</div>
          <div class="ts-timeline-day" data-day="1">√öt</div>
          <div class="ts-timeline-day" data-day="2">St</div>
          <div class="ts-timeline-day" data-day="3">ƒåt</div>
          <div class="ts-timeline-day" data-day="4">P√°</div>
          <div class="ts-timeline-day" data-day="5">So</div>
          <div class="ts-timeline-day" data-day="6">Ne</div>
        </div>
      </div>
      <div class="ts-timeline-body">
        <div class="ts-timeline-hours">
          <!-- Hours 8:00 - 18:00 will be generated -->
        </div>
        <div class="ts-timeline-grid">
          <!-- Timeline blocks will be generated here -->
        </div>
      </div>
    </div>

    <!-- List View (Original) -->
    <div id="listView" class="ts-list-view" style="display:block;">
      <div id="weekGrid" class="ts-week-grid"></div>
    </div>
  </div>
</div>

<!-- Floating Action Button (Mobile) -->
<button id="fabAdd" class="ts-fab" style="display:none;">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <line x1="12" y1="5" x2="12" y2="19"></line>
    <line x1="5" y1="12" x2="19" y2="12"></line>
  </svg>
</button>

<!-- Modal -->
<div id="modal" class="modal-backdrop" style="display:none;">
  <div class="card modal-card">
    <div class="card-h">
      <div id="modalTitle" class="modal-title">upravit z√°znam</div>
    </div>
    <div class="card-c">
      <div class="form-grid">
      <input type="hidden" id="mId"/>
        <div class="form-group">
          <label class="form-label">zamƒõstnanec</label>
          <select id="mEmployee" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">zak√°zka</label>
          <select id="mJob" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">datum</label>
          <input id="mDate" type="date" class="form-input"/>
        </div>
        <div class="form-group">
          <label class="form-label">hodin</label>
          <input id="mHours" type="number" min="0" step="0.25" placeholder="8" class="form-input"/>
        </div>
        <div class="form-group">
          <label class="form-label">m√≠sto</label>
          <input id="mPlace" type="text" class="form-input"/>
        </div>
        <div class="form-group span2">
          <label class="form-label">ƒçinnost</label>
          <textarea id="mActivity" rows="2" class="form-textarea"></textarea>
        </div>
      </div>
    </div>
    <div class="card-f actions">
      <button id="mDelete" class="btn btn-danger" style="margin-right:auto;display:none;">smazat</button>
      <button id="mCopy" class="btn btn-secondary" style="margin-right:auto;display:none;">üìã Kop√≠rovat</button>
      <button id="mCancel" class="btn btn-ghost">zru≈°it</button>
      <button id="mSave" class="btn btn-primary">ulo≈æit</button>
    </div>
  </div>
</div>

<style>
  /* Page Header */
  .ts-page-header {
    margin-bottom: 24px;
  }
  .ts-page-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 6px;
    color: var(--text-primary);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-page-subtitle {
    color: var(--text-tertiary);
    font-size: 14px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Toolbar */
  .ts-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .ts-week-nav {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .ts-week-label {
    font-size: 15px;
    font-weight: 600;
    min-width: 150px;
    text-align: center;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 0 8px;
  }
  .ts-nav-btn {
    padding: 10px 16px;
    background: linear-gradient(135deg, var(--bg-card) 0%, #252a2f 100%);
    border: 1px solid var(--border-medium);
    border-radius: 12px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    font-weight: 500;
  }
  .ts-nav-btn:hover {
    background: var(--mint);
    border-color: var(--mint);
  }
  .ts-actions {
    display: flex;
    gap: 12px;
  }

  /* Summary Bar */
  .ts-summary-bar {
    background: linear-gradient(135deg, var(--bg-card) 0%, #252a2f 100%);
    border: 1px solid var(--border-medium);
    border-radius: 16px;
    padding: 20px 24px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-around;
    align-items: center;
  }
  .ts-summary-item {
    text-align: center;
  }
  .ts-summary-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .ts-summary-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--mint);
  }
  @media (max-width: 768px) {
    .ts-page-title {
      font-size: 20px;
    }
    .ts-page-subtitle {
      font-size: 12px;
    }
    .ts-week-label {
      font-size: 13px;
      min-width: 120px;
    }
    .ts-summary-value {
      font-size: 18px;
    }
    .ts-summary-label {
      font-size: 10px;
    }
  }

  /* Week Grid */
  .ts-week-grid {
    background: linear-gradient(135deg, var(--bg-card) 0%, #252a2f 100%);
    border: 1px solid var(--border-medium);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 100px;
  }
  .ts-grid-header {
    display: table;
    width: 100%;
    table-layout: fixed;
    background: #252a2f;
    border-bottom: 2px solid var(--border-medium);
  }
  .ts-grid-cell {
    display: table-cell;
    padding: 12px 8px;
    border-right: 1px solid #2a3036;
    text-align: center;
    vertical-align: middle;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-grid-cell:first-child {
    text-align: left;
    padding-left: 16px;
    width: 140px;
    min-width: 120px;
  }
  .ts-grid-cell:last-child {
    border-right: none;
  }
  .ts-day-header {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-primary);
    margin-bottom: 2px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-day-date {
    font-size: 11px;
    color: var(--text-tertiary);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-day-header.today {
    color: var(--mint);
  }
  .ts-grid-row {
    display: table-row;
    border-bottom: 1px solid #2a3036;
  }
  .ts-grid-row:last-child {
    border-bottom: none;
  }
  .ts-grid-row:hover {
    background: rgba(62, 167, 106, 0.05);
  }
  .ts-employee-cell {
    display: table-cell;
    padding: 12px 8px 12px 16px;
    border-right: 1px solid #2a3036;
    background: transparent;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-employee-cell > div {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .ts-avatar {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: linear-gradient(135deg, var(--mint) 0%, #4bb878 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 12px;
    flex-shrink: 0;
  }
  .ts-employee-name {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
  }
  .ts-day-cell {
    display: table-cell;
    padding: 8px;
    border-right: 1px solid #2a3036;
    min-height: 50px;
    vertical-align: top;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-day-cell:last-child {
    border-right: none;
  }
  .ts-time-entry {
    background: rgba(62, 167, 106, 0.15);
    border: 1px solid rgba(62, 167, 106, 0.3);
    border-radius: 6px;
    padding: 6px 8px;
    margin-bottom: 6px;
    width: 100%;
    max-width: 100%;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-time-entry:hover {
    background: rgba(62, 167, 106, 0.25);
    border-color: var(--mint);
  }
  .ts-entry-hours {
    font-weight: 700;
    color: var(--mint);
    margin-bottom: 2px;
    font-size: 13px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-entry-project {
    color: var(--text-tertiary);
    font-size: 10px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
    line-height: 1.3;
  }
  .ts-add-btn {
    width: 100%;
    padding: 6px 8px;
    background: rgba(62, 167, 106, 0.1);
    border: 1px dashed rgba(62, 167, 106, 0.4);
    border-radius: 6px;
    color: var(--mint);
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .ts-add-btn:hover {
    background: rgba(62, 167, 106, 0.2);
    border-color: var(--mint);
  }

  /* View Toggle */
  .ts-view-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .ts-view-btn {
    padding: 8px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    font-weight: 500;
  }
  .ts-view-btn:hover {
    background: var(--bg-elevated);
    border-color: var(--mint);
  }
  .ts-view-btn.active {
    background: var(--mint);
    color: var(--text-dark);
    border-color: var(--mint);
  }

  /* Enhanced Filters */
  .ts-filters-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .ts-filter-group {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .ts-filter-group label {
    font-weight: 600;
    color: var(--text-primary);
    min-width: 120px;
  }
  .ts-quick-filter {
    padding: 6px 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-medium);
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
  }
  .ts-quick-filter:hover {
    background: var(--mint);
    color: var(--text-dark);
    border-color: var(--mint);
  }
  .ts-multi-select {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .ts-multi-select-item {
    padding: 4px 10px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-medium);
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .ts-multi-select-item.selected {
    background: var(--mint);
    color: var(--text-dark);
    border-color: var(--mint);
  }

  /* Project Legend */
  .ts-legend {
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 16px;
  }
  .ts-legend-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 13px;
  }
  .ts-legend-items {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .ts-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
  }
  .ts-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
  }

  /* Heat Map */
  .ts-heatmap {
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .ts-heatmap-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    font-size: 14px;
  }
  .ts-heatmap-days {
    display: flex;
    gap: 8px;
  }
  .ts-heatmap-day {
    flex: 1;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dark);
    transition: all 0.2s;
  }

  /* Statistics Panel */
  .ts-stats-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .ts-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
  }
  .ts-stat-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 16px;
  }
  .ts-stat-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    font-size: 13px;
  }
  .ts-chart {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-tertiary);
    font-size: 12px;
  }
  .ts-top-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .ts-top-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: var(--bg-card);
    border-radius: 6px;
    font-size: 12px;
  }

  /* Timeline View */
  .ts-timeline-view {
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .ts-timeline-header {
    display: grid;
    grid-template-columns: 80px 1fr;
    background: var(--bg-elevated);
    border-bottom: 2px solid var(--border-medium);
  }
  .ts-timeline-time-col {
    padding: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 12px;
    border-right: 1px solid var(--border-medium);
  }
  .ts-timeline-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
  }
  .ts-timeline-day {
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 12px;
    border-right: 1px solid var(--border-medium);
  }
  .ts-timeline-day:last-child {
    border-right: none;
  }
  .ts-timeline-body {
    position: relative;
    min-height: 400px;
  }
  .ts-timeline-hours {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 80px;
    border-right: 1px solid var(--border-medium);
  }
  .ts-timeline-hour {
    height: 40px;
    padding: 4px 8px;
    font-size: 11px;
    color: var(--text-tertiary);
    border-bottom: 1px solid var(--border-primary);
  }
  .ts-timeline-grid {
    margin-left: 80px;
    position: relative;
    min-height: 400px;
  }
  .ts-timeline-block {
    position: absolute;
    border-radius: 4px;
    padding: 4px 6px;
    font-size: 11px;
    color: var(--text-dark);
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .ts-timeline-block:hover {
    transform: scale(1.05);
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  /* Floating Action Button (Mobile) */
  .ts-fab {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--mint);
    color: var(--text-dark);
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: all 0.2s;
  }
  .ts-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }
  @media (min-width: 769px) {
    .ts-fab {
      display: none;
    }
  }

  /* Bulk Selection */
  .ts-entry-checkbox {
    margin-right: 8px;
  }
  .ts-bulk-actions-bar {
    position: fixed;
    bottom: 80px;
    left: 0;
    right: 0;
    background: var(--mint);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 999;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
  }

</style>

<script>
(function(){
  const elWeekGrid = document.getElementById('weekGrid');
  let elWeekStart = document.getElementById('weekStart');
  // If weekStart doesn't exist, create it
  if (!elWeekStart) {
    elWeekStart = document.createElement('input');
    elWeekStart.type = 'date';
    elWeekStart.id = 'weekStart';
    elWeekStart.style.display = 'none';
    document.body.appendChild(elWeekStart);
  }
  const elPrev = document.getElementById('prevWeek');
  const elNext = document.getElementById('nextWeek');
  let elFJob = document.getElementById('filterJob');
  let elFEmp = document.getElementById('filterEmployee');
  const elWeekLabel = document.getElementById('weekLabel');
  
  // Create filter selects if they don't exist
  if (!elFJob) {
    const filtersPanel = document.getElementById('filtersPanel');
    if (filtersPanel) {
      const jobGroup = filtersPanel.querySelector('.ts-filter-group:last-child');
      if (jobGroup) {
        elFJob = document.createElement('select');
        elFJob.id = 'filterJob';
        elFJob.className = 'form-select';
        elFJob.style.width = 'auto';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'v≈°e';
        elFJob.appendChild(opt);
        jobGroup.appendChild(elFJob);
      }
    }
  }
  if (!elFEmp) {
    const filtersPanel = document.getElementById('filtersPanel');
    if (filtersPanel) {
      const empGroup = filtersPanel.querySelector('.ts-filter-group:first-child');
      if (empGroup) {
        elFEmp = document.createElement('select');
        elFEmp.id = 'filterEmployee';
        elFEmp.className = 'form-select';
        elFEmp.style.width = 'auto';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'v≈°ichni';
        elFEmp.appendChild(opt);
        empGroup.appendChild(elFEmp);
      }
    }
  }
  const elSummaryTotal = document.getElementById('summaryTotal');
  const elSummaryAvg = document.getElementById('summaryAvg');
  const elSummaryProjects = document.getElementById('summaryProjects');
  const elSummaryOvertime = document.getElementById('summaryOvertime');
  const elSummaryTrend = document.getElementById('summaryTrend');
  
  // View elements
  const elViewList = document.getElementById('viewList');
  const elViewTimeline = document.getElementById('viewTimeline');
  const elViewStats = document.getElementById('viewStats');
  const elListView = document.getElementById('listView');
  const elTimelineView = document.getElementById('timelineView');
  const elStatsPanel = document.getElementById('statsPanel');
  
  // Filter elements
  const elFiltersPanel = document.getElementById('filtersPanel');
  const elToggleFilters = document.getElementById('toggleFilters');
  
  // Project colors
  const projectColors = {};
  const colorPalette = [
    '#4ade80', '#3ea76a', '#2d8f55', '#1f6b3d', '#155d31',
    '#5aee90', '#6bd08c', '#7cc5ff', '#60a5fa', '#4a90e2'
  ];
  
  let currentView = 'list';
  let selectedEntries = new Set();

  // modal elems
  const modal = document.getElementById('modal');
  const mId = document.getElementById('mId');
  const mEmployee = document.getElementById('mEmployee');
  const mJob = document.getElementById('mJob');
  const mDate = document.getElementById('mDate');
  const mHours = document.getElementById('mHours');
  const mPlace = document.getElementById('mPlace');
  const mActivity = document.getElementById('mActivity');
  const mTitle = document.getElementById('modalTitle');
  const mSave = document.getElementById('mSave');
  const mCancel = document.getElementById('mCancel');
  const mDelete = document.getElementById('mDelete');

  // Store employees list
  let employeesList = [];
  let jobsList = [];

  // --- Local date helpers (no UTC conversion) ---
  const fmtLocal = (d)=>{
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+dd;
  };
  const parse = (s)=> { const [y,m,dd] = s.split('-').map(x=>parseInt(x,10)); return new Date(y, m-1, dd); };
  const monday = (d)=>{ const x = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const wd = x.getDay(); const diff = (wd===0?6:wd-1); x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; };
  const addDays = (d,n)=>{ const x = new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; };
  const formatDateRange = (start, end) => {
    const fmt = (d) => d.toLocaleDateString('cs-CZ', {day: 'numeric', month: 'long', year: 'numeric'});
    return fmt(start) + ' - ' + fmt(end);
  };

  async function apiJSON(url, options){
    const r = await fetch(url, Object.assign({
      credentials: 'same-origin',
      headers:{'Content-Type':'application/json'}
    }, options||{}));
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json();
  }
  async function fetchJSON(url){ 
    const r = await fetch(url, {credentials: 'same-origin'}); 
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json(); 
  }

  async function loadFilters(){
    try{
      const jobs = await fetchJSON('/api/jobs');
      jobsList = jobs.jobs || [];
      jobsList.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j.id; opt.textContent = j.title + (j.code?(' ('+j.code+')'):''); 
        elFJob.appendChild(opt);
        const opt2 = opt.cloneNode(true); mJob.appendChild(opt2);
      });
    }catch(e){}
    try{
      const emps = await fetchJSON('/api/employees');
      employeesList = emps.employees || [];
      employeesList.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id; opt.textContent = e.name; 
        elFEmp.appendChild(opt);
        const opt2 = opt.cloneNode(true); mEmployee.appendChild(opt2);
      });
    }catch(e){}
  }

  async function renderWeek(){
    if (!elWeekStart || !elWeekStart.value) {
      const today = new Date();
      const startMonday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - ((today.getDay()+6)%7));
      startMonday.setHours(0,0,0,0);
      if (elWeekStart) {
        elWeekStart.value = fmtLocal(startMonday);
      }
    }
    
    const start = monday(parse(elWeekStart.value));
    const end = addDays(start, 6);
    if (elWeekLabel) elWeekLabel.textContent = formatDateRange(start, end);

    const q = new URLSearchParams();
    q.set('from', fmtLocal(start));
    q.set('to', fmtLocal(end));
    if(elFJob && elFJob.value) q.set('job_id', elFJob.value);
    if(elFEmp && elFEmp.value) q.set('employee_id', elFEmp.value);

    const data = await fetchJSON('/api/timesheets?' + q.toString());
    const rows = (data.rows||[]);
    
    // Group by employee and date
    const byEmployee = {};
    const byDate = {};
    let totalHours = 0;
    const projectSet = new Set();
    
    for(const r of rows){
      const empId = r.employee_id;
      const d = (r.date||'').slice(0,10);
      if(!byEmployee[empId]) {
        byEmployee[empId] = {};
        const emp = employeesList.find(e => e.id === empId);
        byEmployee[empId].name = emp ? emp.name : ('ID '+empId);
        byEmployee[empId].initials = emp ? (emp.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2)) : '?';
        byEmployee[empId].entries = {};
      }
      if(!byEmployee[empId].entries[d]) byEmployee[empId].entries[d] = [];
      byEmployee[empId].entries[d].push(r);
      
      if(!byDate[d]) byDate[d] = [];
      byDate[d].push(r);
      
      totalHours += (r.hours || 0);
      if(r.job_id) projectSet.add(r.job_id);
    }

    // Update summary
    elSummaryTotal.textContent = totalHours.toFixed(1) + 'h';
    elSummaryAvg.textContent = (totalHours / 7).toFixed(1) + 'h';
    elSummaryProjects.textContent = projectSet.size;

    // Get active employees (those with entries or all if no filter)
    const activeEmployees = (elFEmp && elFEmp.value) 
      ? [employeesList.find(e => e.id == elFEmp.value)].filter(Boolean)
      : employeesList.filter(e => byEmployee[e.id] || !elFEmp || !elFEmp.value);
    
    // If no employees, show all
    if(activeEmployees.length === 0) activeEmployees.push(...employeesList);

    // Build simple day list (original design)
    elWeekGrid.innerHTML = '';
    
    for(let i=0; i<7; i++){
      const d = addDays(start, i);
      const dstr = fmtLocal(d);
      const isToday = dstr === fmtLocal(new Date());
      
      const dayCard = document.createElement('div');
      dayCard.className = 'card';
      dayCard.style.marginBottom = '16px';
      
      const dayHeader = document.createElement('div');
      dayHeader.className = 'card-h';
      dayHeader.style.display = 'flex';
      dayHeader.style.justifyContent = 'space-between';
      dayHeader.style.alignItems = 'center';
      dayHeader.style.gap = '12px';
      
      const dayTitle = document.createElement('div');
      dayTitle.style.fontWeight = '600';
      dayTitle.style.fontSize = '14px';
      dayTitle.style.color = isToday ? 'var(--mint)' : 'var(--text-primary)';
      dayTitle.style.flex = '1';
      dayTitle.style.minWidth = '0';
      dayTitle.style.wordWrap = 'break-word';
      dayTitle.style.overflowWrap = 'break-word';
      dayTitle.style.lineHeight = '1.3';
      dayTitle.textContent = d.toLocaleDateString('cs-CZ', {weekday: 'long'}) + ' ' + 
                           d.toLocaleDateString('cs-CZ', {day: '2-digit', month: '2-digit', year: 'numeric'});
      dayHeader.appendChild(dayTitle);
      
      const addBtn = document.createElement('button');
      addBtn.className = 'btn btn-primary btn-sm';
      addBtn.textContent = '+ P≈ôidat';
      addBtn.style.fontSize = '11px';
      addBtn.style.padding = '5px 8px';
      addBtn.style.whiteSpace = 'nowrap';
      addBtn.style.flexShrink = '0';
      addBtn.style.marginLeft = '8px';
      addBtn.addEventListener('click', () => openModal({date: dstr}));
      dayHeader.appendChild(addBtn);
      
      dayCard.appendChild(dayHeader);
      
      const dayBody = document.createElement('div');
      dayBody.className = 'card-c';
      
      const dayEntries = byDate[dstr] || [];
      if(dayEntries.length === 0){
        dayBody.innerHTML = '<div style="color:var(--text-tertiary);padding:12px;text-align:center;font-size:12px;">≈Ω√°dn√© z√°znamy</div>';
      } else {
        dayEntries.forEach(r => {
          const entry = document.createElement('div');
          entry.className = 'card';
          entry.style.marginBottom = '8px';
          entry.style.cursor = 'pointer';
          entry.style.padding = '10px';
          entry.style.background = 'var(--bg-tertiary)';
          entry.style.border = '0.5px solid var(--border-primary)';
          entry.style.borderRadius = 'var(--radius-md)';
          entry.style.wordWrap = 'break-word';
          entry.style.overflowWrap = 'break-word';
          entry.setAttribute('data-job-id', r.job_id || '');
          entry.addEventListener('click', () => {
            openModal({
              id: r.id, employee_id: r.employee_id, job_id: r.job_id, 
              date: r.date, hours: r.hours, place: r.place, activity: r.activity
            });
          });
          
          const emp = employeesList.find(e => e.id === r.employee_id);
          const empName = (emp ? emp.name : 'Nezn√°m√Ω');
          const jobTitle = (r.job_title || ('Zak√°zka '+r.job_id));
          const color = r.job_id ? getProjectColor(r.job_id) : '#4ade80';
          entry.style.background = color + '33';
          entry.style.borderColor = color;
          entry.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;gap:8px;">' +
                           '<div style="flex:1;min-width:0;word-wrap:break-word;overflow-wrap:break-word;"><div style="fontWeight:600;color:var(--text-primary);margin-bottom:3px;word-wrap:break-word;overflow-wrap:break-word;font-size:13px;line-height:1.3;">' + empName + '</div>' +
                           '<div style="fontSize:12px;color:' + color + ';fontWeight:600;">' + (r.hours||0) + 'h</div></div>' +
                           '</div>' +
                           '<div style="fontSize:11px;color:var(--text-secondary);marginBottom:3px;word-wrap:break-word;overflow-wrap:break-word;line-height:1.3;">' + jobTitle + '</div>' +
                           (r.activity ? '<div style="fontSize:10px;color:var(--text-tertiary);word-wrap:break-word;overflow-wrap:break-word;line-height:1.3;">' + r.activity + '</div>' : '');
          dayBody.appendChild(entry);
        });
      }
      
      dayCard.appendChild(dayBody);
      elWeekGrid.appendChild(dayCard);
    }
  }

  function openModal(data){
    mId.value = data.id || '';
    mTitle.textContent = data.id ? 'upravit z√°znam' : 'nov√Ω z√°znam';
    if(data.employee_id) mEmployee.value = String(data.employee_id);
    if(data.job_id) mJob.value = String(data.job_id);
    mDate.value = (data.date ? data.date.slice(0,10) : elWeekStart.value);
    mHours.value = (data.hours!=null ? data.hours : '');
    mPlace.value = (data.place || '');
    mActivity.value = (data.activity || '');
    mDelete.style.display = data.id ? '' : 'none';
    modal.style.display='flex';
  }
  function closeModal(){ modal.style.display='none'; }

  mCancel.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  mSave.addEventListener('click', async ()=>{
    const empId = Number(mEmployee.value||0);
    const jobId = Number(mJob.value||0);
    const hours = Number(mHours.value||0);
    
    if(!empId || empId <= 0){
      alert('Vyber zamƒõstnance');
      return;
    }
    if(!jobId || jobId <= 0){
      alert('Vyber zak√°zku');
      return;
    }
    if(!mDate.value){
      alert('Vypl≈à datum');
      return;
    }
    if(!hours || hours <= 0){
      alert('Vypl≈à poƒçet hodin');
      return;
    }
    
    const payload = {
      employee_id: empId,
      job_id: jobId,
      date: mDate.value,
      hours: hours,
      place: mPlace.value || '',
      activity: mActivity.value || ''
    };
    try{
      if(mId.value){
        payload.id = Number(mId.value);
        await apiJSON('/api/timesheets', {method:'PATCH', body: JSON.stringify(payload)});
      }else{
        await apiJSON('/api/timesheets', {method:'POST', body: JSON.stringify(payload)});
      }
      closeModal();
      renderWeek().catch(console.error);
      // Show success notification if available
      if(typeof showNotification === 'function'){
        showNotification('V√Ωkaz √∫spƒõ≈°nƒõ ulo≈æen', 'success');
      }
    }catch(e){
      const errorMsg = 'Chyba p≈ôi ukl√°d√°n√≠: ' + (e.message || String(e));
      alert(errorMsg);
      console.error('Timesheet save error:', e);
      if(typeof showNotification === 'function'){
        showNotification(errorMsg, 'error');
      }
    }
  });

  mDelete.addEventListener('click', async ()=>{
    if(!mId.value) return;
    if(!confirm('Opravdu smazat z√°znam?')) return;
    try{
      const url = '/api/timesheets?id=' + encodeURIComponent(mId.value);
      const r = await fetch(url, {method:'DELETE', credentials: 'same-origin'});
      if(!r.ok) {
        const errorText = await r.text();
        let errorMsg = errorText;
        try {
          const errorJson = JSON.parse(errorText);
          errorMsg = errorJson.error || errorJson.message || errorText;
        } catch {}
        throw new Error(errorMsg);
      }
      closeModal(); 
      renderWeek().catch(console.error);
      if(typeof showNotification === 'function'){
        showNotification('V√Ωkaz smaz√°n', 'success');
      }
    }catch(e){
      const errorMsg = 'Chyba p≈ôi maz√°n√≠: ' + (e.message || String(e));
      alert(errorMsg);
      console.error('Timesheet delete error:', e);
      if(typeof showNotification === 'function'){
        showNotification(errorMsg, 'error');
      }
    }
  });

  if (elPrev) elPrev.addEventListener('click', ()=>{ const d=parse(elWeekStart.value); d.setDate(d.getDate()-7); elWeekStart.value=fmtLocal(d); renderWeek().catch(console.error); });
  if (elNext) elNext.addEventListener('click', ()=>{ const d=parse(elWeekStart.value); d.setDate(d.getDate()+7); elWeekStart.value=fmtLocal(d); renderWeek().catch(console.error); });
  if (elFJob) elFJob.addEventListener('change', ()=>renderWeek().catch(console.error));
  if (elFEmp) elFEmp.addEventListener('change', ()=>renderWeek().catch(console.error));
  document.getElementById('exportCsv').addEventListener('click', ()=>{
    const d0 = monday(parse(elWeekStart.value)); const d6 = addDays(d0,6);
    const q = new URLSearchParams(); q.set('from', fmtLocal(d0)); q.set('to', fmtLocal(d6));
    const fj = elFJob.value;
    const fe = elFEmp.value;
    if(fj) q.set('job_id', fj); if(fe) q.set('employee_id', fe);
    window.location.href = '/api/timesheets/export?' + q.toString();
  });
  document.getElementById('addTimesheet').addEventListener('click', ()=>{
    openModal({date: elWeekStart.value});
  });

  // Project Color Function (projectColors and colorPalette already declared above)
  function getProjectColor(jobId) {
    if (!projectColors[jobId]) {
      const index = Object.keys(projectColors).length % colorPalette.length;
      projectColors[jobId] = colorPalette[index];
    }
    return projectColors[jobId];
  }
  
  // View Toggle Functions
  function switchView(view) {
    currentView = view;
    
    // Update button states
    if (elViewList) {
      elViewList.classList.remove('active');
      if (view === 'list') elViewList.classList.add('active');
    }
    if (elViewTimeline) {
      elViewTimeline.classList.remove('active');
      if (view === 'timeline') elViewTimeline.classList.add('active');
    }
    if (elViewStats) {
      elViewStats.classList.remove('active');
      if (view === 'stats') elViewStats.classList.add('active');
    }
    
    // Show/hide views
    if (elListView) elListView.style.display = view === 'list' ? 'block' : 'none';
    if (elTimelineView) elTimelineView.style.display = view === 'timeline' ? 'block' : 'none';
    if (elStatsPanel) elStatsPanel.style.display = view === 'stats' ? 'block' : 'none';
    
    // Render specific views
    if (view === 'timeline') {
      renderTimeline();
    } else if (view === 'stats') {
      renderStats();
    } else if (view === 'list') {
      // Ensure week grid is visible
      if (elWeekGrid) elWeekGrid.style.display = 'block';
    }
  }
  
  function renderTimeline() {
    const timelineGrid = document.querySelector('.ts-timeline-grid');
    const timelineHours = document.querySelector('.ts-timeline-hours');
    if (!timelineGrid || !timelineHours) return;
    timelineHours.innerHTML = '';
    for (let h = 8; h <= 18; h++) {
      const hourEl = document.createElement('div');
      hourEl.className = 'ts-timeline-hour';
      hourEl.textContent = h + ':00';
      timelineHours.appendChild(hourEl);
    }
  }
  
  function renderStats() {
    const donutEl = document.getElementById('donutChart');
    const lineEl = document.getElementById('lineChart');
    const topEl = document.getElementById('topProjects');
    if (donutEl) donutEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary);">Donut chart - implementace s Chart.js</div>';
    if (lineEl) lineEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary);">Line chart - implementace s Chart.js</div>';
    if (topEl) topEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary);">Top 5 projekt≈Ø - naƒç√≠t√°n√≠ dat...</div>';
  }
  
  // Attach view toggle listeners (elements already declared above)
  if (elViewList) elViewList.addEventListener('click', () => switchView('list'));
  if (elViewTimeline) elViewTimeline.addEventListener('click', () => switchView('timeline'));
  if (elViewStats) elViewStats.addEventListener('click', () => switchView('stats'));
  
  // Copy Week
  const elCopyWeek = document.getElementById('copyWeek');
  if (elCopyWeek) {
    elCopyWeek.addEventListener('click', async () => {
      if (!confirm('Kop√≠rovat v≈°echny v√Ωkazy z tohoto t√Ωdne do p≈ô√≠≈°t√≠ho t√Ωdne?')) return;
      const start = monday(parse(elWeekStart.value));
      const end = addDays(start, 6);
      const nextStart = addDays(start, 7);
      const q = new URLSearchParams();
      q.set('from', fmtLocal(start));
      q.set('to', fmtLocal(end));
      try {
        const data = await fetchJSON('/api/timesheets?' + q.toString());
        const rows = data.rows || [];
        for (const row of rows) {
          const oldDate = parse(row.date.slice(0, 10));
          const newDate = addDays(oldDate, 7);
          const payload = {employee_id: row.employee_id, job_id: row.job_id, date: fmtLocal(newDate), hours: row.hours, place: row.place || '', activity: row.activity || ''};
          await apiJSON('/api/timesheets', {method: 'POST', body: JSON.stringify(payload)});
        }
        alert('T√Ωden √∫spƒõ≈°nƒõ zkop√≠rov√°n!');
        elWeekStart.value = fmtLocal(nextStart);
        renderWeek().catch(console.error);
      } catch (e) {
        alert('Chyba p≈ôi kop√≠rov√°n√≠: ' + e.message);
      }
    });
  }
  
  // Copy Entry
  const elMCopy = document.getElementById('mCopy');
  if (elMCopy) {
    elMCopy.addEventListener('click', () => {
      if (!mId.value) return;
      mId.value = '';
      mTitle.textContent = 'nov√Ω z√°znam (kopie)';
      mDelete.style.display = 'none';
    });
  }
  
  // Heat Map
  function renderHeatMap(byDate) {
    const heatMapEl = document.getElementById('heatMapDays');
    if (!heatMapEl) return;
    heatMapEl.innerHTML = '';
    const weekStart = monday(parse(elWeekStart.value));
    const dayNames = ['Po', '√öt', 'St', 'ƒåt', 'P√°', 'So', 'Ne'];
    for (let i = 0; i < 7; i++) {
      const d = addDays(weekStart, i);
      const dstr = fmtLocal(d);
      const entries = byDate[dstr] || [];
      const totalHours = entries.reduce((sum, e) => sum + (e.hours || 0), 0);
      const intensity = Math.min((totalHours / 8) * 100, 100);
      const dayEl = document.createElement('div');
      dayEl.className = 'ts-heatmap-day';
      dayEl.style.background = `rgba(74, 222, 128, ${intensity / 100})`;
      dayEl.innerHTML = `<div><div style="font-size:10px;margin-bottom:2px;">${dayNames[i]}</div><div style="font-size:11px;">${totalHours.toFixed(1)}h</div></div>`;
      heatMapEl.appendChild(dayEl);
    }
  }
  
  // Enhanced renderWeek with heat map and colors - WRAPPER
  const originalRenderWeek = renderWeek;
  renderWeek = async function() {
    // Ensure listView is visible when rendering
    if (currentView === 'list' && elListView) {
      elListView.style.display = 'block';
    }
    
    // Call original renderWeek first to show days
    await originalRenderWeek();
    
    // Then add enhancements
    try {
      const start = monday(parse(elWeekStart.value));
      const end = addDays(start, 6);
      const q = new URLSearchParams();
      q.set('from', fmtLocal(start));
      q.set('to', fmtLocal(end));
      if(elFJob && elFJob.value) q.set('job_id', elFJob.value);
      if(elFEmp && elFEmp.value) q.set('employee_id', elFEmp.value);
      
      const data = await fetchJSON('/api/timesheets?' + q.toString());
      const rows = data.rows || [];
      const byDate = {};
      rows.forEach(r => {
        const d = (r.date || '').slice(0, 10);
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(r);
      });
      renderHeatMap(byDate);
      
      // Render project legend
      const legendEl = document.getElementById('legendItems');
      if (legendEl) {
        legendEl.innerHTML = '';
        const uniqueJobs = [...new Set(rows.map(r => r.job_id).filter(Boolean))];
        uniqueJobs.forEach(jobId => {
          const job = jobsList.find(j => j.id === jobId);
          if (job) {
            const item = document.createElement('div');
            item.className = 'ts-legend-item';
            const color = getProjectColor(jobId);
            item.innerHTML = `<div class="ts-legend-color" style="background:${color};"></div><span>${job.title || 'Projekt ' + jobId}</span>`;
            legendEl.appendChild(item);
          }
        });
      }
      
      const totalHours = rows.reduce((sum, r) => sum + (r.hours || 0), 0);
      const overtime = Math.max(0, totalHours - 40);
      if (elSummaryOvertime) {
        elSummaryOvertime.textContent = overtime > 0 ? overtime.toFixed(1) + 'h' : '0h';
        elSummaryOvertime.style.color = overtime > 0 ? '#ff4d4d' : 'var(--text-secondary)';
      }
    } catch (e) {
      console.error('Error in enhanced renderWeek:', e);
    }
  };
  
  // FAB Handler
  const elFab = document.getElementById('fabAdd');
  if (elFab) {
    elFab.addEventListener('click', () => {
      openModal({date: elWeekStart.value});
    });
    // Show FAB on mobile
    if (window.innerWidth < 769) {
      elFab.style.display = 'flex';
    }
    window.addEventListener('resize', () => {
      elFab.style.display = window.innerWidth < 769 ? 'flex' : 'none';
    });
  }

  // Initialize
  // Set default view to 'list'
  currentView = 'list';
  switchView('list');
  
  const today = new Date();
  const startMonday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - ((today.getDay()+6)%7));
  startMonday.setHours(0,0,0,0);
  if (elWeekStart) {
    elWeekStart.value = fmtLocal(startMonday);
  } else {
    // Create hidden weekStart input if it doesn't exist
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'date';
    hiddenInput.id = 'weekStart';
    hiddenInput.style.display = 'none';
    hiddenInput.value = fmtLocal(startMonday);
    document.body.appendChild(hiddenInput);
    elWeekStart = hiddenInput;
  }
  
  // Load filters and render
  loadFilters().then(() => {
    // Populate filter selects
    if (elFJob && jobsList.length > 0) {
      jobsList.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j.id;
        opt.textContent = j.title + (j.code ? (' (' + j.code + ')') : '');
        elFJob.appendChild(opt);
      });
    }
    if (elFEmp && employeesList.length > 0) {
      employeesList.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = e.name;
        elFEmp.appendChild(opt);
      });
    }
    return renderWeek();
  }).catch(console.error);
})();
</script>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="/" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    <div class="nav-label">Dom≈Ø</div>
  </a>
  <a href="/?tab=jobs" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('jobs'); } else { window.location.href='/?tab=jobs'; }" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
    <div class="nav-label">Zak√°zky</div>
  </a>
  <a href="/timesheets.html" class="nav-item active">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
    <div class="nav-label">V√Ωkazy</div>
  </a>
  <a href="/calendar.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="nav-label">Kalend√°≈ô</div>
  </a>
  <a href="#" id="more-menu-btn" class="nav-item" onclick="event.preventDefault(); document.getElementById('more-menu').classList.toggle('show');">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
    <div class="nav-label">V√≠ce</div>
  </a>
  <a href="/settings.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/></svg></div>
    <div class="nav-label">Nastaven√≠</div>
  </a>
</nav>

<!-- More Menu (Expandable) -->
<div id="more-menu" class="more-menu">
  <div class="more-menu-backdrop" onclick="document.getElementById('more-menu').classList.remove('show');"></div>
  <div class="more-menu-panel">
    <div class="more-menu-header">
      <div style="font-size:18px;font-weight:600;color:#e8eef2;">Navigace</div>
      <button onclick="document.getElementById('more-menu').classList.remove('show');" style="background:none;border:none;color:#9ca8b3;cursor:pointer;font-size:24px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">√ó</button>
    </div>
    <div class="more-menu-content">
      <a href="/" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('dashboard'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>p≈ôehled</span>
      </a>
      <a href="/calendar.html" class="more-menu-item">
        <span>kalend√°≈ô</span>
      </a>
      <a href="/timesheets.html" class="more-menu-item">
        <span>v√Ωkazy hodin</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('jobs'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>zak√°zky</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('tasks'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>√∫koly</span>
      </a>
      <a href="/employees.html" class="more-menu-item">
        <span>zamƒõstnanci</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('warehouse'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>sklad</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('archive'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>archiv zak√°zek</span>
      </a>
      <a href="#" id="users-menu-item" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('users'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item" style="display:none;">
        <span>u≈æivatel√©</span>
      </a>
      <a href="/settings.html" class="more-menu-item">
        <span>‚öôÔ∏è nastaven√≠</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}
