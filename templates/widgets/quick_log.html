<div class="quick-log-widget">
    <form id="quickLogForm" onsubmit="submitQuickLog(event)">
        <input type="hidden" name="job_id" id="quickLogJobId" value="{{ context.current_job.id if context and context.current_job else '' }}">
        
        <div class="duration-chips">
            <button type="button" class="chip" data-duration="30">30 min</button>
            <button type="button" class="chip" data-duration="60">1 hod</button>
            <button type="button" class="chip active" data-duration="120">2 hod</button>
            <button type="button" class="chip" data-duration="240">4 hod</button>
            <button type="button" class="chip" data-duration="480">8 hod</button>
        </div>
        
        <div class="work-type-select">
            <select name="work_type_id" id="workTypeSelect">
                <option value="">Vyberte typ práce</option>
                {% if work_types %}
                    {% for wt in work_types %}
                    <option value="{{ wt.id }}" {% if wt.id == context.last_work_type %}selected{% endif %}>
                        {{ wt.name }}
                    </option>
                    {% endfor %}
                {% else %}
                    <option value="1">Obecná práce</option>
                {% endif %}
            </select>
        </div>
        
        <details class="log-details">
            <summary>Více detailů</summary>
            <textarea name="note" placeholder="Poznámka (volitelné)"></textarea>
        </details>
        
        <button type="submit" class="btn btn-primary btn-full">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Zaznamenat
        </button>
    </form>
</div>

<script>
let selectedDuration = 120;

document.querySelectorAll('.duration-chips .chip').forEach(chip => {
    chip.addEventListener('click', (e) => {
        document.querySelectorAll('.duration-chips .chip').forEach(c => c.classList.remove('active'));
        e.target.classList.add('active');
        selectedDuration = parseInt(e.target.dataset.duration);
    });
});

async function submitQuickLog(event) {
    event.preventDefault();
    
    const form = event.target;
    const jobId = form.job_id.value;
    const workTypeId = form.work_type_id.value;
    const note = form.note?.value || '';
    
    if (!jobId) {
        alert('Nejdřív vyber zakázku');
        return;
    }
    
    if (!workTypeId) {
        alert('Vyberte typ práce');
        return;
    }
    
    const data = {
        job_id: parseInt(jobId),
        work_type_id: parseInt(workTypeId),
        duration: selectedDuration,
        note: note,
        created_at: new Date().toISOString()
    };
    
    try {
        const response = await fetch('/api/worklogs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Záznam uložen');
            form.reset();
            document.querySelector('.chip[data-duration="120"]').classList.add('active');
            selectedDuration = 120;
        } else {
            alert('Chyba při ukládání');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Chyba: ' + error.message);
    }
}
</script>
