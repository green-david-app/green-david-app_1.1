{% extends "layout.html" %}
{% block content %}
<h1>Výkazy</h1>
<div class="card">
  <div class="card-h">
    <div>Filtr</div>
    <div class="card-actions">
      <a class="ghost" href="/export/employee_hours.xlsx">Export XLSX</a>
      <button id="csv" class="ghost">Export CSV</button>
    </div>
  </div>
  <div class="card-c">
    <div class="form-row">
      <select id="emp" style="width:220px"></select>
      <input id="from" placeholder="Od (YYYY-MM-DD)"/>
      <input id="to" placeholder="Do (YYYY-MM-DD)"/>
      <button id="reload">Načíst</button>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-h"><div>Přehled</div></div>
  <div class="card-c">
    <table class="table" id="tbl">
      <thead><tr><th>Zaměstnanec</th><th>Datum</th><th>Hodiny</th><th>Místo</th><th>Činnost</th><th>Zakázka</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small" id="sum" style="margin-top:8px"></div>
  </div>
</div>

<script>
(async ()=>{
  async function api(u){ const r=await fetch(u); return await r.json(); }
  const empSel = document.getElementById("emp");
  const from = document.getElementById("from");
  const to = document.getElementById("to");
  const tblBody = document.querySelector("#tbl tbody");
  const sumDiv = document.getElementById("sum");
  const csvBtn = document.getElementById("csv");
  const reloadBtn = document.getElementById("reload");
  const emps = (await api("/api/employees")).employees || [];
  empSel.innerHTML = '<option value="">(všichni zaměstnanci)</option>' + emps.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  async function load(){
    const ts = (await api("/api/timesheets")).rows || [];
    const filtered = ts.filter(r => (!empSel.value || String(r.employee_id)===String(empSel.value)) && (!from.value || r.date>=from.value) && (!to.value || r.date<=to.value));
    tblBody.innerHTML = filtered.map(r => `<tr><td>${r.employee||("ID "+r.employee_id)}</td><td>${r.date}</td><td>${r.hours}</td><td>${r.place||""}</td><td>${r.activity||""}</td><td>${r.job_id||""}</td></tr>`).join("");
    const map = {}; filtered.forEach(r => map[r.employee||("ID "+r.employee_id)] = (map[r.employee||("ID "+r.employee_id)]||0) + Number(r.hours||0));
    sumDiv.innerHTML = Object.entries(map).map(([k,v])=> `${k}: <b>${v.toFixed(2)} h</b>`).join("<br/>");
    csvBtn.onclick = () => {
      const cols=["employee","date","hours","place","activity","job_id"];
      const lines=[cols.join(",")].concat(filtered.map(r=> cols.map(c=> (`"${String(r[c]??"").replace(/"/g,'""')}"`)).join(",")));
      const blob=new Blob([lines.join("\n")], {type:"text/csv"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="vykazy.csv"; a.click();
      URL.revokeObjectURL(url);
    };
  }
  reloadBtn.onclick = load;
  load();
})();
</script>
{% endblock %}
