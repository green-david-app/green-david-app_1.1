<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or 'green david app' }}</title>
  <link rel="stylesheet" href="/style.css"/>
  <link rel="stylesheet" href="/static/icons.css"/>
  <link rel="stylesheet" href="/hide-top-nav.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body, * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif !important;
    }
  </style>
  <style>
    /* Dark theme header styling */
    header.header { 
      position: relative; 
      padding: 12px 16px; 
      background: #242424;
      border-bottom: 1px solid #333333;
    }
    .brand-wrap { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 12px; 
    }
    .brand-logo { 
      height: 32px; 
      width: 32px; 
      border-radius: 8px; 
      object-fit: cover;
      background: #2a2a2a;
    }
    .brand-title { 
      font-weight: 600; 
      font-size: 18px;
      letter-spacing: -0.01em;
      color: #ffffff;
    }
    .brand-sub { 
      font-size: 12px; 
      color: #a3a3a3;
      margin-top: 2px;
    }
    .logout-abs { 
      position: absolute; 
      right: 16px; 
      top: 50%;
      transform: translateY(-50%);
    }
    #logoutBtn {
      padding: 6px 12px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 13px;
      color: #d4d4d4;
    }
    #logoutBtn:hover {
      background: #2f2f2f;
      color: #ffffff;
    }
    @media (max-width: 480px) {
      header.header {
        padding: 10px 12px;
      }
      .brand-title {
        font-size: 16px;
      }
      .brand-sub {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand-wrap">
      <img class="brand-logo" src="/logo.jpg" alt="green david logo">
      <div>
        <div class="brand-title">green david app</div>
        <div class="brand-sub">interní systém</div>
      </div>
    </div>
    {% if session.get('uid') %}
      <div class="logout-abs">
        <button id="logoutBtn" class="ghost" style="border:none;background:none;cursor:pointer;">Odhlásit</button>
      </div>
    {% endif %}
  </header>
<div id="archive-cta" style="display:none; text-align:right; max-width:1200px; margin:0 auto; padding:6px 8px;">
  <a href="/archive" style="display:inline-block; padding:8px 14px; border-radius:10px; background:#2f7d32; color:#fff; text-decoration:none; font-weight:600; box-shadow:0 1px 0 rgba(0,0,0,.2)">
    archiv zakázek
  </a>
</div>


  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <footer class="footer" style="padding:24px 16px;font-size:12px;color:#737373;">© green david s.r.o.</footer>

  <script>
  (function(){
    var btn = document.getElementById('logoutBtn');
    if(btn){
      btn.addEventListener('click', async function(){
        try{ await fetch('/api/logout', {method:'POST'}); }catch(e){}
        window.location.href = '/';
      });
    }
  })();
  </script>

<script>
(function(){
  function ensureSearch(container){
    if(!container) return;
    if(container.querySelector('#globalSearch')) return;
    var form = document.createElement('form');
    form.id = 'globalSearch';
    form.className = 'tabs-search';
    form.action = '/search';
    form.method = 'GET';
    form.innerHTML = '<input type="search" name="q" placeholder="Hledat…" aria-label="Hledat"/>' +
                     '<button type="submit" class="btn small">Hledat</button>';
    container.appendChild(form);
  }
  function findTabs(){
    document.querySelectorAll('.tabs').forEach(ensureSearch);
  }
  document.addEventListener('DOMContentLoaded', function(){
    findTabs();
    var obs = new MutationObserver(findTabs);
    obs.observe(document.body, {subtree:true, childList:true});
  });
})();
</script>

<!-- Deep-link handler for opening Job detail from /?tab=jobs&jobId=... -->

<script>
// SPA deep link helper: ?tab=jobs&jobId=123 or ?tab=employees
(function(){
  function qs(name){ return new URLSearchParams(window.location.search).get(name); }
  const tab = qs('tab');
  if (tab) {
    // Try to switch initial tab by simulating click on the tab header if present
    document.addEventListener('DOMContentLoaded', () => {
      const map = {
        'jobs': 'zakázky', 'employees': 'zaměstnanci',
        'calendar': 'kalendář','timesheets':'výkazy hodin','tasks':'úkoly','warehouse':'sklad','users':'uživatelé'
      };
      const label = map[tab] || null;
      if (label) {
        // try click tab with given label
        const clickTab = () => {
          const tabs = Array.from(document.querySelectorAll('.tab'));
          const t = tabs.find(el => el.textContent.trim() === label);
          if (t) t.click();
        };
        clickTab();
        // also observe in case it renders later
        const obs = new MutationObserver(clickTab);
        obs.observe(document.body, {subtree:true, childList:true});
        setTimeout(()=>obs.disconnect(), 5000);
      }
    });
  }
  const jobId = qs('jobId');
  if (jobId) {
    // After jobs list is rendered, try to open the detail of that job
    const tryOpen = () => {
      // Find card/item that contains the ID number (ID column or data-id attr)
      const selectorCandidates = [
        `[data-job-id="${jobId}"] .btn, [data-id="${jobId}"] .btn`,
        `.job-row[data-id="${jobId}"] .btn`,
        `.job-item[data-id="${jobId}"] .btn`,
        `tr:has(td:first-child:contains("${jobId}")) .btn`,
        `a[href*="detail"][data-id="${jobId}"]`, `button:contains("Otevřít detail")`
      ];
      // Basic contains polyfill for querySelectorAll
      (function(){
        function containsSelectorPolyfill(){
          // no native :contains in querySelector; we implement manual scan
          const rows = Array.from(document.querySelectorAll('tr, .job-item, .job-row, [data-job-id], [data-id]'));
          for (const el of rows) {
            if (el.dataset && (el.dataset.jobId === jobId || el.dataset.id === jobId)) {
              const btn = el.querySelector('a,button');
              if (btn) { btn.click(); return true; }
            }
            if (el.querySelector) {
              const tds = el.querySelectorAll('td,div,span');
              for (const td of tds) {
                if (td.textContent && td.textContent.trim() === jobId) {
                  const btn = el.querySelector('a,button');
                  if (btn) { btn.click(); return true; }
                }
              }
            }
          }
          // fallback: click first "Otevřít detail" on page
          const any = Array.from(document.querySelectorAll('a,button')).find(b => /Otevřít detail/i.test(b.textContent));
          if (any) { any.click(); return true; }
          return false;
        }
        window.__openJobDetailById = containsSelectorPolyfill;
      })();

      if (window.__openJobDetailById && window.__openJobDetailById()) return;
    };
    document.addEventListener('DOMContentLoaded', ()=>{
      tryOpen();
      const obs = new MutationObserver(()=>tryOpen());
      obs.observe(document.body, {subtree:true, childList:true});
      setTimeout(()=>obs.disconnect(), 5000);
    });
  }
})();
</script>

<script src="/archive-cta.js"></script>
</body>
</html>