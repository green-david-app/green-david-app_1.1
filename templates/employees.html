{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="container">
    <!-- Page Header -->
    <div style="margin-bottom:24px;">
      <h1 style="font-size:24px;font-weight:700;margin-bottom:6px;color:var(--text-primary);word-wrap:break-word;overflow-wrap:break-word;">Tým</h1>
      <p style="color:var(--text-tertiary);font-size:14px;word-wrap:break-word;overflow-wrap:break-word;">Správa zaměstnanců a brigádníků</p>
    </div>

    <!-- Add Employee Card -->
    <div class="card" style="margin-bottom:var(--space-lg);">
      <div class="card-h"><strong>Nový zaměstnanec</strong></div>
      <div class="card-c">
        <div class="form-row">
          <input id="newName" type="text" placeholder="Jméno" class="form-input" style="flex:2;" />
          <select id="newRole" class="form-select" style="flex:2;">
            <option value="Zahradník">Zahradník</option>
            <option value="Svářeč">Svářeč</option>
            <option value="Brigádník">Brigádník</option>
            <option value="Jiné">Jiné</option>
          </select>
          <button id="btnAdd" class="btn btn-primary">Přidat</button>
        </div>
      </div>
    </div>

    <!-- List Card -->
    <div class="card">
      <div class="card-h">
        <strong>Seznam</strong>
        <div class="chips" style="margin-top:8px;display:flex;gap:8px;">
          <button data-scope="all" class="chip chip-on">Všichni</button>
          <button data-scope="employees" class="chip">zaměstnanci</button>
          <button data-scope="brig" class="chip">brigádníci</button>
        </div>
      </div>
      <div class="card-c">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr><th>ID</th><th>Jméno</th><th>Role</th><th style="width:200px;text-align:right;">Akce</th></tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .chip {
    padding: 6px 12px;
    border-radius: var(--radius-md);
    border: 0.5px solid var(--border-primary);
    background: var(--bg-card);
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: all var(--transition);
    font-weight: 500;
  }
  .chip:hover {
    border-color: var(--mint);
    color: var(--text-primary);
    background: var(--bg-card-hover);
  }
  .chip.chip-on {
    background: var(--mint);
    color: #000;
    border-color: var(--mint);
    font-weight: 600;
  }
  .emp-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
    align-items: center;
  }
  .emp-actions button {
    padding: 4px 8px;
    font-size: 12px;
  }
  .emp-edit-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .emp-edit-row input {
    flex: 1;
    padding: 6px 10px;
    font-size: 13px;
  }
</style>

<script>
(async function(){
  const listBody = document.getElementById('listBody');
  const newName = document.getElementById('newName');
  const newRole = document.getElementById('newRole');
  const btnAdd = document.getElementById('btnAdd');
  const chips = Array.from(document.querySelectorAll('.chips .chip'));
  let scope = 'all';
  let editId = null;
  let changeIdFor = null;

  async function fetchJSON(url){ 
    const r = await fetch(url, {credentials: 'same-origin'}); 
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json(); 
  }
  async function apiJSON(url, options){
    const r = await fetch(url, Object.assign({
      credentials: 'same-origin',
      headers:{'Content-Type':'application/json'}
    }, options||{}));
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json();
  }

  function showNotification(msg, type){
    if(typeof window.showNotification === 'function'){
      window.showNotification(msg, type);
    } else {
      alert(msg);
    }
  }

  btnAdd.addEventListener('click', async ()=>{
    const name = newName.value.trim();
    const role = newRole.value;
    if(!name) return;
    try {
      await apiJSON('/api/employees', { method:'POST', body: JSON.stringify({ name, role }) });
      newName.value=''; 
      await render();
      showNotification('Zaměstnanec přidán', 'success');
    } catch(e) {
      const errorMsg = 'Chyba při přidávání zaměstnance: ' + (e.message || String(e));
      showNotification(errorMsg, 'error');
      console.error('Employee add error:', e);
    }
  });

  chips.forEach(chip => chip.addEventListener('click', ()=>{
    chips.forEach(c=>c.classList.remove('chip-on'));
    chip.classList.add('chip-on');
    scope = chip.getAttribute('data-scope');
    render();
  }));

  async function startEdit(e){
    editId = e.id;
    render();
  }

  async function cancelEdit(){
    editId = null;
    render();
  }

  async function saveEdit(e){
    const nameInput = document.getElementById(`edit-name-${e.id}`);
    const roleInput = document.getElementById(`edit-role-${e.id}`);
    if(!nameInput || !roleInput) return;
    const name = nameInput.value.trim();
    const role = roleInput.value.trim();
    if(!name || !role) {
      showNotification('Vyplňte jméno a roli', 'error');
      return;
    }
    try {
      await apiJSON('/api/employees', {method:'PATCH', body: JSON.stringify({id:e.id, name, role})});
      editId = null;
      await render();
      showNotification('Zaměstnanec upraven', 'success');
    } catch(err) {
      showNotification('Chyba při úpravě: ' + err.message, 'error');
    }
  }

  async function startChangeId(e){
    changeIdFor = e.id;
    render();
  }

  async function cancelChangeId(){
    changeIdFor = null;
    render();
  }

  async function saveChangeId(e){
    const newIdInput = document.getElementById(`change-id-${e.id}`);
    if(!newIdInput) return;
    const nid = parseInt(newIdInput.value, 10);
    if(!nid || nid<=0){
      showNotification('Zadejte platné číslo ID', 'error');
      return;
    }
    try {
      await apiJSON('/api/employees/reassign_id', {method:'POST', body: JSON.stringify({old_id:e.id,new_id:nid})});
      changeIdFor = null;
      await render();
      showNotification('ID změněno', 'success');
    } catch(err) {
      showNotification('Chyba při změně ID: ' + err.message, 'error');
    }
  }

  async function del(id){
    if(!confirm("Smazat zaměstnance?")) return;
    try {
      await apiJSON('/api/employees?id='+id, {method:'DELETE'});
      await render();
      showNotification('Zaměstnanec smazán', 'success');
    } catch(err) {
      showNotification('Chyba při mazání: ' + err.message, 'error');
    }
  }

  async function render(){
    listBody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">Načítám…</td></tr>';
    const data = await fetchJSON('/api/employees');
    let rows = data.employees || [];
    if(scope==='brig'){
      rows = rows.filter(e => String(e.role||'').toLowerCase()==='brigádník');
    }else if(scope==='employees'){
      rows = rows.filter(e => String(e.role||'').toLowerCase()!=='brigádník');
    }
    if(rows.length===0){
      listBody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">Žádné položky</td></tr>';
      return;
    }
    listBody.innerHTML = '';
    for(const e of rows){
      const tr = document.createElement('tr');
      tr.id = `emp-${e.id}`;
      
      if(editId === e.id){
        tr.innerHTML = `
          <td>${e.id}</td>
          <td><input id="edit-name-${e.id}" type="text" value="${e.name}" class="form-input" style="width:100%;padding:6px 10px;"/></td>
          <td><input id="edit-role-${e.id}" type="text" value="${e.role||''}" class="form-input" style="width:100%;padding:6px 10px;"/></td>
          <td>
            <div class="emp-actions">
              <button class="btn btn-primary btn-sm" onclick="window.saveEdit(${e.id})">Uložit</button>
              <button class="btn btn-ghost btn-sm" onclick="window.cancelEdit()">Zrušit</button>
            </div>
          </td>
        `;
      } else if(changeIdFor === e.id){
        tr.innerHTML = `
          <td>${e.id}</td>
          <td>${e.name}</td>
          <td>${e.role||''}</td>
          <td>
            <div class="emp-edit-row">
              <input id="change-id-${e.id}" type="number" value="${e.id}" placeholder="Nové ID" class="form-input" style="width:80px;padding:6px 10px;"/>
              <button class="btn btn-primary btn-sm" onclick="window.saveChangeId(${e.id})">Uložit</button>
              <button class="btn btn-ghost btn-sm" onclick="window.cancelChangeId()">Zrušit</button>
            </div>
          </td>
        `;
      } else {
        tr.innerHTML = `
          <td>${e.id}</td>
          <td>${e.name}</td>
          <td>${e.role||''}</td>
          <td>
            <div class="emp-actions">
              <button class="btn btn-ghost btn-sm" onclick="window.startEdit(${e.id})" title="Upravit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button class="btn btn-ghost btn-sm" onclick="window.startChangeId(${e.id})" title="Změnit ID">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              </button>
              <button class="btn btn-ghost btn-sm" onclick="window.del(${e.id})" title="Smazat" style="color:#ff6b6b;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </td>
        `;
      }
      listBody.appendChild(tr);
    }
    
    // Store functions globally for onclick handlers
    window.startEdit = startEdit;
    window.cancelEdit = cancelEdit;
    window.saveEdit = saveEdit;
    window.startChangeId = startChangeId;
    window.cancelChangeId = cancelChangeId;
    window.saveChangeId = saveChangeId;
    window.del = del;
  }
  await render();

  // If URL contains #emp-<id>, scroll and highlight
  const hash = window.location.hash;
  if (hash && hash.startsWith('#emp-')) {
    const target = document.querySelector(hash);
    if (target) {
      target.classList.add('pulse-highlight');
      target.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>target.classList.remove('pulse-highlight'), 2000);
    }
  }

})();
</script>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="/" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    <div class="nav-label">Domů</div>
  </a>
  <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('jobs');" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
    <div class="nav-label">Zakázky</div>
  </a>
  <a href="/timesheets.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
    <div class="nav-label">Výkazy</div>
  </a>
  <a href="/calendar.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="nav-label">Kalendář</div>
  </a>
  <a href="#" id="more-menu-btn" class="nav-item active" onclick="event.preventDefault(); document.getElementById('more-menu').classList.toggle('show');">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
    <div class="nav-label">Více</div>
  </a>
</nav>

<!-- More Menu (Expandable) -->
<div id="more-menu" class="more-menu">
  <div class="more-menu-backdrop" onclick="document.getElementById('more-menu').classList.remove('show');"></div>
  <div class="more-menu-panel">
    <div class="more-menu-header">
      <div style="font-size:18px;font-weight:600;color:#e8eef2;">Navigace</div>
      <button onclick="document.getElementById('more-menu').classList.remove('show');" style="background:none;border:none;color:#9ca8b3;cursor:pointer;font-size:24px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">×</button>
    </div>
    <div class="more-menu-content">
      <a href="/" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('dashboard'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>přehled</span>
      </a>
      <a href="/calendar.html" class="more-menu-item">
        <span>kalendář</span>
      </a>
      <a href="/timesheets.html" class="more-menu-item">
        <span>výkazy hodin</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('jobs'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>zakázky</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('tasks'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>úkoly</span>
      </a>
      <a href="/employees.html" class="more-menu-item">
        <span>zaměstnanci</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('warehouse'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>sklad</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('archive'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>archiv zakázek</span>
      </a>
      <a href="#" id="users-menu-item" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('users'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item" style="display:none;">
        <span>uživatelé</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}

<script src="/static/js/brigadnici-embed.js"></script>
