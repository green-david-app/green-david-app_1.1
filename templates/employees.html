{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="container">
    <!-- Page Header -->
    <div class="ts-page-header">
      <h1 class="ts-page-title">Tým</h1>
      <p class="ts-page-subtitle">Správa zaměstnanců a brigádníků</p>
    </div>

    <div class="card">
      <div class="card-h"><strong>Nový zaměstnanec</strong></div>
      <div class="card-c">
        <div class="form-row">
          <input id="newName" type="text" placeholder="Jméno" class="form-input" style="flex:2;" />
          <select id="newRole" class="form-select" style="flex:2;">
            <option value="zahradník">Zahradník</option>
            <option value="svářeč">Svářeč</option>
            <option value="brigádník">Brigádník</option>
            <option value="jiné">Jiné</option>
          </select>
          <button id="btnAdd" class="btn btn-primary">Přidat</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:var(--space-lg);">
      <div class="card-h">
        <strong>Seznam</strong>
        <div class="chips" style="margin-top:8px;display:flex;gap:8px;">
          <button data-scope="all" class="chip chip-on">Všichni</button>
          <button data-scope="employees" class="chip">zaměstnanci</button>
          <button data-scope="brig" class="chip">brigádníci</button>
        </div>
      </div>
      <div class="card-c">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr><th>ID</th><th>Jméno</th><th>Role</th><th style="width:220px"></th></tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .chip {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-medium);
    background: var(--bg-card);
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .chip:hover {
    border-color: var(--mint);
    color: var(--text-primary);
  }
  .chip.chip-on {
    background: var(--mint);
    color: white;
    border-color: var(--mint);
  }
</style>

<script>
(async function(){
  const listBody = document.getElementById('listBody');
  const newName = document.getElementById('newName');
  const newRole = document.getElementById('newRole');
  const btnAdd = document.getElementById('btnAdd');
  const chips = Array.from(document.querySelectorAll('.chips .chip'));
  let scope = 'all';

  async function fetchJSON(url){ 
    const r = await fetch(url, {credentials: 'same-origin'}); 
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json(); 
  }
  async function apiJSON(url, options){
    const r = await fetch(url, Object.assign({
      credentials: 'same-origin',
      headers:{'Content-Type':'application/json'}
    }, options||{}));
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json();
  }

  btnAdd.addEventListener('click', async ()=>{
    const name = newName.value.trim();
    const role = newRole.value;
    if(!name) return;
    try {
      await apiJSON('/api/employees', { method:'POST', body: JSON.stringify({ name, role }) });
      newName.value=''; 
      await render();
      if(typeof showNotification === 'function'){
        showNotification('Zaměstnanec přidán', 'success');
      }
    } catch(e) {
      const errorMsg = 'Chyba při přidávání zaměstnance: ' + (e.message || String(e));
      alert(errorMsg);
      console.error('Employee add error:', e);
      if(typeof showNotification === 'function'){
        showNotification(errorMsg, 'error');
      }
    }
  });

  chips.forEach(chip => chip.addEventListener('click', ()=>{
    chips.forEach(c=>c.classList.remove('chip-on'));
    chip.classList.add('chip-on');
    scope = chip.getAttribute('data-scope');
    render();
  }));

  async function render(){
    listBody.innerHTML = '<tr><td colspan="4" class="muted">Načítám…</td></tr>';
    const data = await fetchJSON('/api/employees');
    let rows = data.employees || [];
    if(scope==='brig'){
      rows = rows.filter(e => String(e.role||'').toLowerCase()==='brigádník');
    }else if(scope==='employees'){
      rows = rows.filter(e => String(e.role||'').toLowerCase()!=='brigádník');
    }
    if(rows.length===0){
      listBody.innerHTML = '<tr><td colspan="4" class="muted">Žádné položky</td></tr>';
      return;
    }
    listBody.innerHTML = '';
    for(const e of rows){
      const tr = document.createElement('tr');
      tr.id = `emp-${e.id}`;
      tr.innerHTML = `<td>${e.id}</td><td>${e.name}</td><td>${e.role||''}</td><td></td>`;
      listBody.appendChild(tr);
    }
  }
  await render();

  // If URL contains #emp-<id>, scroll and highlight
  const hash = window.location.hash;
  if (hash && hash.startsWith('#emp-')) {
    const target = document.querySelector(hash);
    if (target) {
      target.classList.add('pulse-highlight');
      target.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>target.classList.remove('pulse-highlight'), 2000);
    }
  }

})();
</script>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="/" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    <div class="nav-label">Přehled</div>
  </a>
  <a href="/timesheets.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="nav-label">Výkazy</div>
  </a>
  <a href="/calendar.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="nav-label">Kalendář</div>
  </a>
  <a href="/employees.html" class="nav-item active">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
    <div class="nav-label">Tým</div>
  </a>
</nav>
{% endblock %}

<script src="/static/js/brigadnici-embed.js"></script>
