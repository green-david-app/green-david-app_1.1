{% extends "base.html" %}
{% block body %}

<div class="card">
  <h2>Nový zaměstnanec</h2>
  <form id="emp-form" style="display:flex; gap:12px; align-items:center;">
    <input id="emp-name" name="name" placeholder="Jméno" required>
    <input id="emp-role" name="role" placeholder="Zahradník" value="zahradník">
    <button type="submit" class="btn">Přidat</button>
  </form>
</div>

<div class="card">
  <h2 style="margin-bottom:10px">Seznam</h2>

  <!-- přepínač sekcí -->
  <div style="display:flex; gap:16px; border-bottom:1px solid #3a3f46; margin-bottom:12px;">
    <button class="tab-btn active" data-target="tab-staff" style="border:none;background:none;padding:8px 0; border-bottom:3px solid #2e7d32; color:#e5e7eb; cursor:pointer;">Zaměstnanci</button>
    <button class="tab-btn" data-target="tab-temps" style="border:none;background:none;padding:8px 0; color:#e5e7eb; cursor:pointer;">Brigádníci</button>
  </div>

  <!-- tab: zaměstnanci -->
  <div id="tab-staff" class="tab-pane">
    <table class="table" id="tbl-staff">
      <thead>
        <tr>
          <th style="width:80px">ID</th>
          <th>Jméno</th>
          <th style="width:180px">Role</th>
          <th style="width:220px"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- tab: brigádníci -->
  <div id="tab-temps" class="tab-pane" style="display:none">
    <table class="table" id="tbl-temps">
      <thead>
        <tr>
          <th style="width:80px">ID</th>
          <th>Jméno</th>
          <th style="width:180px">Role</th>
          <th style="width:220px"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ---- helpers ----
function el(html){const t=document.createElement('template');t.innerHTML=html.trim();return t.content.firstChild}
function fillTable(tbody, rows){
  tbody.innerHTML='';
  for(const r of rows){
    const tr = el(`<tr>
      <td>${r.id}</td>
      <td>${r.name}</td>
      <td>${r.role}</td>
      <td style="text-align:right;">
        <a class="btn btn-small" href="/employees/${r.id}">Detail</a>
        <button class="btn btn-small btn-outline" data-del="${r.id}">Smazat</button>
      </td>
    </tr>`);
    tbody.appendChild(tr);
  }
  // mazání
  tbody.querySelectorAll('[data-del]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      if(!confirm('Smazat?')) return;
      const id = b.getAttribute('data-del');
      const res = await fetch('/api/employees/'+id, {method:'DELETE'});
      if(res.ok) loadData();
    });
  });
}

// ---- tabs ----
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>{
      b.classList.remove('active');
      b.style.borderBottom = 'none';
    });
    document.querySelectorAll('.tab-pane').forEach(p=>p.style.display='none');
    btn.classList.add('active');
    btn.style.borderBottom='3px solid #2e7d32';
    const target = document.getElementById(btn.dataset.target);
    target.style.display = '';
  });
});

// ---- data load ----
async function loadData(){
  const res = await fetch('/api/employees');
  const payload = await res.json();
  const items = payload.employees || payload || [];

  const brig = items.filter(x => (x.role || '').toLowerCase() === 'brigádník');
  const staff = items.filter(x => (x.role || '').toLowerCase() !== 'brigádník');

  fillTable(document.querySelector('#tbl-staff tbody'), staff);
  fillTable(document.querySelector('#tbl-temps tbody'), brig);
}

// ---- add form ----
document.getElementById('emp-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('emp-name').value.trim();
  const role = document.getElementById('emp-role').value.trim() || 'zahradník';
  if(!name) return;

  const res = await fetch('/api/employees', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name, role})
  });
  if(res.ok){
    document.getElementById('emp-name').value='';
    await loadData();
  }
});

// start
loadData();
</script>
{% endblock %}
