{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="container">
    <!-- Page Header -->
    <div style="margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
      <div>
        <h1 style="font-size:28px;font-weight:700;margin-bottom:6px;color:var(--text-primary);word-wrap:break-word;overflow-wrap:break-word;">üë• Zamƒõstnanci</h1>
        <p style="color:var(--text-tertiary);font-size:14px;word-wrap:break-word;overflow-wrap:break-word;">Modern√≠ HR syst√©m pro spr√°vu t√Ωmu</p>
      </div>
      <button id="btnAddEmployee" class="btn btn-primary" style="padding:10px 20px;">+ Nov√Ω zamƒõstnanec</button>
    </div>

    <!-- Filters -->
    <div style="margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <div style="flex:1;min-width:200px;">
        <input type="search" id="searchInput" placeholder="üîç Hledat zamƒõstnance..." style="width:100%;padding:10px 16px;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;">
      </div>
      <div class="chips" style="display:flex;gap:8px;">
        <button data-scope="all" class="chip chip-on">V≈°ichni</button>
        <button data-scope="employees" class="chip">Zamƒõstnanci</button>
        <button data-scope="brig" class="chip">Brig√°dn√≠ci</button>
      </div>
    </div>

    <!-- Employee Grid -->
    <div id="listBody" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-bottom:100px;"></div>
  </div>
</div>

<style>
  :root {
    --mint: #b0fba5;
    --mint-dark: #b0fba5;
    --warning: #fb923c;
    --danger: #f87171;
  }

  .chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .chip {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border-primary);
    background: var(--bg-card);
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }
  .chip:hover {
    border-color: var(--mint);
    color: var(--text-primary);
    background: var(--bg-elevated);
  }
  .chip.chip-on {
    background: var(--mint);
    color: #000;
    border-color: var(--mint);
    font-weight: 600;
  }

  .employee-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
  }
  .employee-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    border-color: var(--mint);
  }

  .employee-header {
    position: relative;
    margin-bottom: 16px;
    text-align: center;
  }

  .employee-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--mint);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    font-size: 32px;
    font-weight: bold;
    color: #0a0e11;
    border: 3px solid var(--bg-secondary);
    position: relative;
  }

  .status-dot {
    position: absolute;
    bottom: 8px;
    right: calc(50% - 40px + 8px);
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 3px solid var(--bg-secondary);
  }
  .status-dot.online {
    background: var(--mint);
  }
  .status-dot.pause {
    background: var(--warning);
  }
  .status-dot.away {
    background: var(--danger);
  }
  .status-dot.offline {
    background: #6b7580;
  }

  .employee-card h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 4px 0;
    text-align: center;
  }

  .employee-card .role {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    margin: 0 0 16px 0;
  }

  .employee-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--bg-elevated);
    border-radius: 8px;
  }

  .employee-stats .stat {
    text-align: center;
  }

  .employee-stats .label {
    display: block;
    font-size: 11px;
    color: var(--text-tertiary);
    margin-bottom: 4px;
  }

  .employee-stats .value {
    display: block;
    font-size: 18px;
    font-weight: bold;
    color: var(--text-primary);
  }

  .employee-actions {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding-top: 16px;
    border-top: 1px solid var(--border-primary);
  }

  .btn-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .btn-icon:hover {
    background: var(--mint);
    border-color: var(--mint);
    color: #0a0e11;
    transform: scale(1.1);
  }

  /* Modal */
  .employee-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
  }

  .employee-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: var(--bg-secondary);
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--border-primary);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-primary);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 24px;
    color: var(--text-primary);
  }

  .close-modal {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 32px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
  }

  .close-modal:hover {
    color: var(--text-primary);
  }

  .modal-body {
    padding: 20px;
  }

  .detail-section {
    margin-bottom: 24px;
  }

  .detail-section h4 {
    color: var(--text-primary);
    font-size: 18px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
  }

  .info-item {
    padding: 12px;
    background: var(--bg-card);
    border-radius: 8px;
    border: 1px solid var(--border-primary);
  }

  .info-item .label {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-bottom: 4px;
  }

  .info-item .value {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 500;
  }

  .chart-container {
    height: 200px;
    background: var(--bg-card);
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
  }

  .simple-bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    height: 150px;
  }

  .bar {
    flex: 1;
    background: var(--mint);
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    position: relative;
  }

  .bar-label {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    #listBody {
      grid-template-columns: 1fr !important;
    }
    .employee-stats {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Employee Detail Modal -->
<div class="employee-modal" id="employeeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Detail zamƒõstnance</h2>
      <button class="close-modal" onclick="closeEmployeeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>

<script>
(async function(){
  const listBody = document.getElementById('listBody');
  const searchInput = document.getElementById('searchInput');
  const btnAddEmployee = document.getElementById('btnAddEmployee');
  const chips = Array.from(document.querySelectorAll('.chips .chip'));
  let scope = 'all';
  let employees = [];
  let jobs = [];
  let tasks = [];
  let timesheets = [];
  let currentEmployeeId = null;

  async function fetchJSON(url){ 
    const r = await fetch(url, {credentials: 'same-origin'}); 
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json(); 
  }
  async function apiJSON(url, options){
    const r = await fetch(url, Object.assign({
      credentials: 'same-origin',
      headers:{'Content-Type':'application/json'}
    }, options||{}));
    if(!r.ok) {
      const errorText = await r.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.error || errorJson.message || errorText;
      } catch {}
      throw new Error(errorMsg);
    }
    return r.json();
  }

  function showNotification(msg, type){
    if(typeof window.showNotification === 'function'){
      window.showNotification(msg, type);
    } else {
      alert(msg);
    }
  }

  async function render(){
    listBody.innerHTML = '<div class="muted" style="text-align:center;padding:20px;grid-column:1/-1;">Naƒç√≠t√°m‚Ä¶</div>';
    
    let filtered = [...employees];
    
    // Filter by scope
    if(scope==='brig'){
      filtered = filtered.filter(e => String(e.role||'').toLowerCase()==='brig√°dn√≠k');
    }else if(scope==='employees'){
      filtered = filtered.filter(e => String(e.role||'').toLowerCase()!=='brig√°dn√≠k');
    }
    
    // Filter by search
    const search = searchInput.value.toLowerCase();
    if(search){
      filtered = filtered.filter(e => 
        (e.name || '').toLowerCase().includes(search) ||
        (e.role || '').toLowerCase().includes(search)
      );
    }
    
    if(filtered.length===0){
      listBody.innerHTML = '<div class="muted" style="text-align:center;padding:40px;grid-column:1/-1;">≈Ω√°dn√≠ zamƒõstnanci</div>';
      return;
    }
    
    listBody.innerHTML = '';
    for(const emp of filtered){
      const card = createEmployeeCard(emp);
      listBody.appendChild(card);
    }
  }

  function createEmployeeCard(emp) {
    const card = document.createElement('div');
    card.className = 'employee-card';
    card.id = `emp-${emp.id}`;
    
    const stats = getEmployeeStats(emp.id);
    const status = getEmployeeStatus(emp.id);
    const initials = (emp.name || '').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '?';
    
    card.innerHTML = `
      <div class="employee-header">
        <div class="employee-avatar">${initials}</div>
        <div class="status-dot ${status}"></div>
      </div>
      <h3>${escapeHtml(emp.name || 'Bez jm√©na')}</h3>
      <p class="role">${escapeHtml(emp.role || '‚Äî')}</p>
      
      <div class="employee-stats">
        <div class="stat">
          <span class="label">Tento t√Ωden</span>
          <span class="value">${stats.weeklyHours.toFixed(1)}h</span>
        </div>
        <div class="stat">
          <span class="label">Aktivn√≠ zak√°zky</span>
          <span class="value">${stats.activeJobs}</span>
        </div>
        <div class="stat">
          <span class="label">√ökoly</span>
          <span class="value">${stats.tasks}</span>
        </div>
      </div>
      
      <div class="employee-actions">
        <button class="btn-icon" title="Zavolat" onclick="callEmployee(${emp.id})">üìû</button>
        <button class="btn-icon" title="Email" onclick="emailEmployee(${emp.id})">üìß</button>
        <button class="btn-icon" title="Detail" onclick="openEmployeeDetail(${emp.id})">üë§</button>
      </div>
    `;
    
    return card;
  }

  function getEmployeeStats(empId) {
    const today = new Date();
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    weekStart.setHours(0, 0, 0, 0);
    
    const weeklyHours = timesheets
      .filter(ts => ts.employee_id === empId && new Date(ts.date) >= weekStart)
      .reduce((sum, ts) => sum + (ts.hours || 0), 0);
    
    const activeJobs = jobs.filter(j => {
      const assignments = tasks.filter(t => t.job_id === j.id && t.employee_id === empId);
      return assignments.length > 0 && j.status !== 'Dokonƒçeno';
    }).length;
    
    const empTasks = tasks.filter(t => t.employee_id === empId && t.status !== 'completed').length;
    
    return {
      weeklyHours,
      activeJobs,
      tasks: empTasks
    };
  }

  function getEmployeeStatus(empId) {
    // Simplified status - could be enhanced with real-time data
    const hasRecentActivity = timesheets.some(ts => {
      if (ts.employee_id !== empId) return false;
      const tsDate = new Date(ts.date);
      const today = new Date();
      const diff = (today - tsDate) / (1000 * 60 * 60);
      return diff < 24; // Activity in last 24 hours
    });
    
    return hasRecentActivity ? 'online' : 'offline';
  }

  function openEmployeeDetail(empId) {
    currentEmployeeId = empId;
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    
    document.getElementById('modalTitle').textContent = emp.name || 'Detail zamƒõstnance';
    document.getElementById('modalBody').innerHTML = renderEmployeeDetail(emp);
    document.getElementById('employeeModal').classList.add('show');
  }

  function renderEmployeeDetail(emp) {
    const stats = getEmployeeStats(emp.id);
    const empTimesheets = timesheets.filter(ts => ts.employee_id === emp.id);
    const empJobs = jobs.filter(j => {
      const assignments = tasks.filter(t => t.job_id === j.id && t.employee_id === emp.id);
      return assignments.length > 0;
    });
    const empTasks = tasks.filter(t => t.employee_id === emp.id);
    
    // Calculate monthly hours
    const monthlyHours = calculateMonthlyHours(emp.id);
    
    const extended = getEmployeeExtended(emp.id) || {};
    
    return `
      <div class="detail-section">
        <h4>üìã Osobn√≠ informace</h4>
        <div class="info-grid">
          <div class="info-item">
            <div class="label">Jm√©no</div>
            <div class="value">${escapeHtml(emp.name || '‚Äî')}</div>
          </div>
          <div class="info-item">
            <div class="label">Role</div>
            <div class="value">${escapeHtml(emp.role || '‚Äî')}</div>
          </div>
          <div class="info-item">
            <div class="label">Email</div>
            <div class="value">${escapeHtml(extended.email || '‚Äî')}</div>
          </div>
          <div class="info-item">
            <div class="label">Telefon</div>
            <div class="value">${escapeHtml(extended.phone || '‚Äî')}</div>
          </div>
          <div class="info-item">
            <div class="label">Adresa</div>
            <div class="value">${escapeHtml(extended.address || '‚Äî')}</div>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>üíº Smlouva</h4>
        <div class="info-grid">
          <div class="info-item">
            <div class="label">Typ smlouvy</div>
            <div class="value">${escapeHtml(extended.contractType || 'HPP')}</div>
          </div>
          <div class="info-item">
            <div class="label">Zaƒç√°tek</div>
            <div class="value">${extended.contractStart ? new Date(extended.contractStart).toLocaleDateString('cs-CZ') : '‚Äî'}</div>
          </div>
          <div class="info-item">
            <div class="label">Sazba</div>
            <div class="value">${extended.hourlyRate ? extended.hourlyRate + ' Kƒç/h' : '‚Äî'}</div>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>üìä Statistiky</h4>
        <div class="info-grid">
          <div class="info-item">
            <div class="label">Tento t√Ωden</div>
            <div class="value">${stats.weeklyHours.toFixed(1)}h</div>
          </div>
          <div class="info-item">
            <div class="label">Aktivn√≠ zak√°zky</div>
            <div class="value">${stats.activeJobs}</div>
          </div>
          <div class="info-item">
            <div class="label">Otev≈ôen√© √∫koly</div>
            <div class="value">${stats.tasks}</div>
          </div>
          <div class="info-item">
            <div class="label">Celkem hodin (mƒõs√≠c)</div>
            <div class="value">${monthlyHours.toFixed(1)}h</div>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>üìà Hodiny za mƒõs√≠c</h4>
        <div class="chart-container">
          <div class="simple-bar-chart">
            ${renderMonthlyChart(emp.id)}
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>üìã Aktivn√≠ zak√°zky</h4>
        <div class="info-grid">
          ${empJobs.slice(0, 5).map(j => `
            <div class="info-item">
              <div class="label">${escapeHtml(j.title || 'Zak√°zka ' + j.id)}</div>
              <div class="value">${escapeHtml(j.status || '‚Äî')}</div>
            </div>
          `).join('')}
          ${empJobs.length === 0 ? '<div class="info-item"><div class="value">≈Ω√°dn√© aktivn√≠ zak√°zky</div></div>' : ''}
        </div>
      </div>
      
      <div class="detail-section">
        <h4>‚úÖ √ökoly</h4>
        <div class="info-grid">
          ${empTasks.slice(0, 5).map(t => `
            <div class="info-item">
              <div class="label">${escapeHtml(t.title || '√ökol ' + t.id)}</div>
              <div class="value">${escapeHtml(t.status || '‚Äî')}</div>
            </div>
          `).join('')}
          ${empTasks.length === 0 ? '<div class="info-item"><div class="value">≈Ω√°dn√© √∫koly</div></div>' : ''}
        </div>
      </div>
      
      <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="assignToJob(${emp.id})">P≈ôi≈ôadit na zak√°zku</button>
        <button class="btn btn-secondary" onclick="sendTask(${emp.id})">Odeslat √∫kol</button>
        <button class="btn btn-secondary" onclick="viewTimesheets(${emp.id})">Zobrazit v√Ωkazy</button>
        <button class="btn btn-secondary" onclick="editProfile(${emp.id})">Upravit profil</button>
      </div>
    `;
  }

  function calculateMonthlyHours(empId) {
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    return timesheets
      .filter(ts => {
        if (ts.employee_id !== empId) return false;
        const tsDate = new Date(ts.date);
        return tsDate >= monthStart;
      })
      .reduce((sum, ts) => sum + (ts.hours || 0), 0);
  }

  function renderMonthlyChart(empId) {
    const now = new Date();
    const weeks = [];
    for (let i = 3; i >= 0; i--) {
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - (now.getDay() + 7 * i));
      weekStart.setHours(0, 0, 0, 0);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      const hours = timesheets
        .filter(ts => {
          if (ts.employee_id !== empId) return false;
          const tsDate = new Date(ts.date);
          return tsDate >= weekStart && tsDate <= weekEnd;
        })
        .reduce((sum, ts) => sum + (ts.hours || 0), 0);
      
      weeks.push({ hours, label: `T-${i}` });
    }
    
    const maxHours = Math.max(...weeks.map(w => w.hours), 1);
    
    return weeks.map((week, idx) => {
      const height = (week.hours / maxHours) * 100;
      return `
        <div class="bar" style="height: ${height}%;">
          <div class="bar-label">${week.label}<br>${week.hours.toFixed(1)}h</div>
        </div>
      `;
    }).join('');
  }

  function getEmployeeExtended(empId) {
    const key = `employee_extended_${empId}`;
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : null;
  }

  function saveEmployeeExtended(empId, data) {
    const key = `employee_extended_${empId}`;
    localStorage.setItem(key, JSON.stringify(data));
  }

  function closeEmployeeModal() {
    document.getElementById('employeeModal').classList.remove('show');
    currentEmployeeId = null;
  }

  function callEmployee(empId) {
    const emp = employees.find(e => e.id === empId);
    const extended = getEmployeeExtended(empId) || {};
    const phone = extended.phone || '';
    if (phone) {
      window.location.href = `tel:${phone}`;
    } else {
      alert('Telefonn√≠ ƒç√≠slo nen√≠ k dispozici');
    }
  }

  function emailEmployee(empId) {
    const emp = employees.find(e => e.id === empId);
    const extended = getEmployeeExtended(empId) || {};
    const email = extended.email || '';
    if (email) {
      window.location.href = `mailto:${email}`;
    } else {
      alert('Email nen√≠ k dispozici');
    }
  }

  function assignToJob(empId) {
    if (jobs.length === 0) {
      alert('Nejsou k dispozici ≈æ√°dn√© zak√°zky');
      return;
    }
    const jobOptions = jobs.map(j => `${j.id}: ${j.title || 'Zak√°zka ' + j.id}`).join('\n');
    const jobId = prompt(`Vyberte zak√°zku (ID):\n${jobOptions}`);
    if (jobId) {
      // Create task assignment
      alert(`P≈ôi≈ôazen√≠ na zak√°zku ${jobId} - funkce bude implementov√°na`);
    }
  }

  function sendTask(empId) {
    const title = prompt('N√°zev √∫kolu:');
    if (!title) return;
    // Create task
    alert(`Odesl√°n√≠ √∫kolu "${title}" - funkce bude implementov√°na`);
  }

  function viewTimesheets(empId) {
    window.location.href = `/timesheets.html?employee=${empId}`;
  }

  function editProfile(empId) {
    const emp = employees.find(e => e.id === empId);
    const extended = getEmployeeExtended(empId) || {};
    
    const email = prompt('Email:', extended.email || '');
    const phone = prompt('Telefon:', extended.phone || '');
    const address = prompt('Adresa:', extended.address || '');
    const contractType = prompt('Typ smlouvy (HPP/DPP/DPƒå):', extended.contractType || 'HPP');
    const hourlyRate = prompt('Sazba (Kƒç/h):', extended.hourlyRate || '');
    
    if (email !== null) {
      saveEmployeeExtended(empId, {
        ...extended,
        email: email || '',
        phone: phone || '',
        address: address || '',
        contractType: contractType || 'HPP',
        hourlyRate: hourlyRate || ''
      });
      openEmployeeDetail(empId);
      showNotification('Profil upraven', 'success');
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Event listeners
  searchInput.addEventListener('input', render);
  
  chips.forEach(chip => chip.addEventListener('click', ()=>{
    chips.forEach(c=>c.classList.remove('chip-on'));
    chip.classList.add('chip-on');
    scope = chip.getAttribute('data-scope');
    render();
  }));

  // Close modal on backdrop click
  document.getElementById('employeeModal').addEventListener('click', (e) => {
    if (e.target.id === 'employeeModal') {
      closeEmployeeModal();
    }
  });

  // Load all data
  async function loadAllData() {
    try {
      const [empsRes, jobsRes, tasksRes, timesheetsRes] = await Promise.all([
        fetchJSON('/api/employees'),
        fetchJSON('/api/jobs'),
        fetchJSON('/api/tasks'),
        fetchJSON('/api/timesheets')
      ]);
      
      employees = empsRes.employees || empsRes || [];
      jobs = jobsRes.jobs || jobsRes || [];
      tasks = tasksRes.tasks || tasksRes || [];
      timesheets = timesheetsRes.rows || timesheetsRes.timesheets || timesheetsRes || [];
      
      render();
    } catch (e) {
      console.error('Error loading data:', e);
      showNotification('Chyba p≈ôi naƒç√≠t√°n√≠ dat: ' + e.message, 'error');
    }
  }

  // Initialize
  await loadAllData();

  // If URL contains #emp-<id>, scroll and highlight
  const hash = window.location.hash;
  if (hash && hash.startsWith('#emp-')) {
    const target = document.querySelector(hash);
    if (target) {
      target.classList.add('pulse-highlight');
      target.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>target.classList.remove('pulse-highlight'), 2000);
    }
  }

})();
</script>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="/" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    <div class="nav-label">Dom≈Ø</div>
  </a>
  <a href="/?tab=jobs" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('jobs'); } else { window.location.href='/?tab=jobs'; }" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
    <div class="nav-label">Zak√°zky</div>
  </a>
  <a href="/timesheets.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
    <div class="nav-label">V√Ωkazy</div>
  </a>
  <a href="/calendar.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="nav-label">Kalend√°≈ô</div>
  </a>
  <a href="#" id="more-menu-btn" class="nav-item" onclick="event.preventDefault(); document.getElementById('more-menu').classList.toggle('show');">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
    <div class="nav-label">V√≠ce</div>
  </a>
  <a href="/settings.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/></svg></div>
    <div class="nav-label">Nastaven√≠</div>
  </a>
</nav>

<!-- More Menu (Expandable) -->
<div id="more-menu" class="more-menu">
  <div class="more-menu-backdrop" onclick="document.getElementById('more-menu').classList.remove('show');"></div>
  <div class="more-menu-panel">
    <div class="more-menu-header">
      <div style="font-size:18px;font-weight:600;color:#e8eef2;">Navigace</div>
      <button onclick="document.getElementById('more-menu').classList.remove('show');" style="background:none;border:none;color:#9ca8b3;cursor:pointer;font-size:24px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">√ó</button>
    </div>
    <div class="more-menu-content">
      <a href="/" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('dashboard'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>p≈ôehled</span>
      </a>
      <a href="/calendar.html" class="more-menu-item">
        <span>kalend√°≈ô</span>
      </a>
      <a href="/timesheets.html" class="more-menu-item">
        <span>v√Ωkazy hodin</span>
      </a>
      <a href="/jobs.html" class="more-menu-item">
        <span>zak√°zky</span>
      </a>
      <a href="/tasks.html" class="more-menu-item">
        <span>√∫koly</span>
      </a>
      <a href="/employees.html" class="more-menu-item">
        <span>zamƒõstnanci</span>
      </a>
      <a href="/warehouse.html" class="more-menu-item">
        <span>sklad</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('archive'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>archiv zak√°zek</span>
      </a>
      <a href="#" id="users-menu-item" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('users'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item" style="display:none;">
        <span>u≈æivatel√©</span>
      </a>
      <a href="/settings.html" class="more-menu-item">
        <span>‚öôÔ∏è nastaven√≠</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}

<script src="/static/js/brigadnici-embed.js"></script>
