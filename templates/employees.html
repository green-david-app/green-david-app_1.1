{% extends "layout.html" %}
{% block content %}
<div class="page-pad">
  <div class="tabs sticky">
    <a class="tab" href="/calendar.html">Kalendář</a>
    <a class="tab" href="/timesheets.html">Výkazy hodin</a>
    <a class="tab" href="/?tab=jobs">Zakázky</a>
    <a class="tab" href="/?tab=tasks">Úkoly</a>
    <a class="tab active" href="/zamestnanci">Zaměstnanci</a>
    <a class="tab" href="/brigadnici.html">Brigádníci</a>
    <a class="tab" href="/?tab=warehouse">Sklad</a>
    <a class="tab" href="/?tab=users">Uživatelé</a>
  </div>

  <div class="card card-dark">
    <div class="card-h"><strong>Nový zaměstnanec</strong></div>
    <div class="card-c">
      <div class="row">
        <input id="newName" type="text" class="inp" placeholder="Jméno" style="flex:1"/>
        <input id="newRole" type="text" class="inp" placeholder="Role (např. zahradník, vedoucí zahradník, …)" list="roleList" style="flex:1"/>
        <datalist id="roleList">
          <option value="zahradník"></option>
          <option value="vedoucí zahradník"></option>
          <option value="závlahář"></option>
          <option value="svářeč"></option>
          <option value="brigádník"></option>
          <option value="administrativa"></option>
          <option value="jiné"></option>
        </datalist>
        <button id="btnAdd" class="btn">Přidat</button>
      </div>
    </div>
  </div>

  <div class="card card-dark">
    <div class="card-h">
      <strong>Seznam</strong>
      <div class="chips" style="margin-top:8px;">
        <span class="chip chip-on" data-scope="all">Všichni</span>
        <span class="chip" data-scope="employees">Zaměstnanci</span>
        <span class="chip" data-scope="brig">Brigádníci</span>
      </div>
    </div>
    <div class="card-c">
      <table class="tbl">
        <thead>
          <tr><th style="width:70px">ID</th><th>Jméno</th><th>Role</th><th style="width:260px"></th></tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(async function(){
  const listBody = document.getElementById('listBody');
  const newName = document.getElementById('newName');
  const newRole = document.getElementById('newRole');
  const btnAdd = document.getElementById('btnAdd');
  const chips = Array.from(document.querySelectorAll('.chips .chip'));
  let scope = 'all';

  async function fetchJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function apiJSON(url, options){
    const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, options||{}));
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  btnAdd.addEventListener('click', async () => {
    const name = (newName.value || '').trim();
    const role = (newRole.value || '').trim();
    if(!name) return;
    await apiJSON('/api/employees', { method:'POST', body: JSON.stringify({ name, role }) });
    newName.value=''; newRole.value='';
    await render();
  });

  chips.forEach(chip => chip.addEventListener('click', ()=>{
    chips.forEach(c=>c.classList.remove('chip-on'));
    chip.classList.add('chip-on');
    scope = chip.getAttribute('data-scope');
    render();
  }));

  async function render(){
    listBody.innerHTML = '<tr><td colspan="4" class="muted">Načítám…</td></tr>';
    const data = await fetchJSON('/api/employees');
    let rows = data.employees || [];
    if(scope==='brig'){
      rows = rows.filter(e => String(e.role||'').toLowerCase()==='brigádník');
    }else if(scope==='employees'){
      rows = rows.filter(e => String(e.role||'').toLowerCase()!=='brigádník');
    }
    if(rows.length===0){
      listBody.innerHTML = '<tr><td colspan="4" class="muted">Žádné položky</td></tr>';
      return;
    }
    listBody.innerHTML = '';
    for(const e of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.id}</td><td>${e.name}</td><td>${e.role||''}</td>
        <td>
          <button class="ghost small" data-act="edit">Upravit</button>
          <button class="ghost small" data-act="reid">Změnit ID</button>
          <button class="ghost small" data-act="del">Smazat</button>
        </td>`;
      listBody.appendChild(tr);
    }
  }
  await render();

  // Delegated actions: edit / delete / reassign id
  listBody.addEventListener('click', async (ev)=>{
    const b = ev.target.closest('button[data-act]');
    if(!b) return;
    const tr = b.closest('tr');
    const oldId = parseInt(tr.children[0].textContent,10);
    const name = tr.children[1].textContent;
    const role = tr.children[2].textContent;
    const act = b.getAttribute('data-act');
    if(act === 'del'){
      if(!confirm('Opravdu smazat zaměstnance #'+oldId+'?')) return;
      const res = await fetch('/api/employees?id='+oldId, { method:'DELETE' });
      if(res.ok){ await render(); } else { alert(await res.text()); }
    } else if(act === 'edit'){
      const newName = prompt('Upravit jméno:', name) ?? name;
      const newRole = prompt('Upravit roli:', role) ?? role;
      const body = {};
      if(newName && newName !== name) body.name = newName.trim();
      if(newRole && newRole !== role) body.role = newRole.trim();
      if(Object.keys(body).length === 0) return;
      body.id = oldId;
      const res = await fetch('/api/employees', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(res.ok){ await render(); } else { alert(await res.text()); }
    } else if(act === 'reid'){
      const ask = prompt("Zadejte nové ID číslo pro zaměstnance "+oldId+":");
      if(!ask) return;
      const newId = parseInt(ask,10);
      if(!newId || newId<=0){ alert("Neplatné číslo."); return; }
      const res = await fetch('/api/employees/reassign_id', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ old_id: oldId, new_id: newId }) });
      if(res.ok){ await render(); } else { alert(await res.text()); }
    }
  });

})();
</script>
{% endblock %}