{# Unified header component ‚Äî pou≈æij: {% include 'components/header.html' %} #}
<header class="app-header" style="position: fixed; top: 0; left: 200px; right: 0; z-index: 1000; background: #161b22; border-radius: 12px; padding: 8px 16px; display: flex; align-items: center; gap: 12px; margin: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
  
  {# 1. Hamburger menu #}
  <button class="app-header-sidebar-toggle" id="app-header-sidebar-toggle" type="button" title="Toggle sidebar" style="background: none; border: none; cursor: pointer; color: #e6edf3; padding: 4px; display: flex; align-items: center; justify-content: center;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>

  {# 2. N√°zev str√°nky #}
  <span class="app-header-page-title" id="app-header-page-title" style="color: #e6edf3; font-size: 18px; font-weight: 600; white-space: nowrap;">{{ page_title|default('Green David') }}</span>

  {# 3. Vyhled√°vac√≠ pole #}
  <div class="app-header-search" id="app-header-search-container" style="flex: 1; max-width: 400px; margin: 0 auto; position: relative;">
    <svg style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #8b949e; pointer-events: none; z-index: 1;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <input type="text" id="app-header-search-input" class="app-header-search-input" placeholder="Vyhledat v aplikaci..." style="width: 100%; padding: 6px 12px 6px 34px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; color: #e6edf3; font-size: 14px; outline: none; transition: border-color 0.2s;" autocomplete="off">
    <div class="global-search-results" id="global-search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-height: 400px; overflow-y: auto; z-index: 1000;"></div>
  </div>

  {# 4-8. Prav√° strana #}
  <div style="display: flex; align-items: center; gap: 12px; margin-left: auto; white-space: nowrap;">
    
    {# √ökoly #}
    <span id="header-tasks-count" style="color: #8b949e; font-size: 14px;">√ökoly: <strong style="color: #e6edf3;">0</strong></span>

    {# AI Oper√°tor ikona + badge + dropdown #}
    <div class="app-header-ai-operator" id="app-header-ai-operator" style="position: relative;">
      <button class="app-header-ai-toggle" id="app-header-ai-toggle" type="button" title="AI Oper√°tor" aria-label="AI Oper√°tor" style="background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; position: relative; color: #8b949e; transition: color 0.2s;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7Z"/>
          <path d="M9 12h6"/>
          <path d="M12 9v6"/>
        </svg>
        <span id="ai-operator-badge" class="ai-operator-badge" style="display:none; position: absolute; top: 4px; right: 4px; background: #ef4444; color: #fff; font-size: 10px; font-weight: 600; padding: 2px 5px; border-radius: 10px; min-width: 16px; text-align: center;">0</span>
      </button>
      <div class="ai-operator-dropdown" id="ai-operator-dropdown" style="display:none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 300px; max-width: 400px; z-index: 1000; overflow: hidden;">
        <div class="ai-operator-dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; font-size: 14px; color: #e6edf3;">AI Oper√°tor</div>
        <div class="ai-operator-dropdown-content" id="ai-operator-dropdown-content" style="max-height: 400px; overflow-y: auto;">
          <div class="ai-operator-loading" style="padding: 24px 16px; text-align: center; color: #8b949e; font-size: 14px;">Naƒç√≠t√°m upozornƒõn√≠...</div>
        </div>
      </div>
    </div>

    {# Notifikace ikona + badge #}
    <a href="/notifications.html" class="app-header-notifications" title="Notifikace" aria-label="Notifikace" style="display: flex; align-items: center; justify-content: center; padding: 8px; color: #8b949e; text-decoration: none; transition: color 0.2s; position: relative;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" />
        <path d="M13.73 21a2 2 0 01-3.46 0" />
      </svg>
      <span id="notif-badge" class="notif-badge" style="display:none; position: absolute; top: 4px; right: 4px; background: #ef4444; color: #fff; font-size: 10px; font-weight: 600; padding: 2px 5px; border-radius: 10px; min-width: 16px; text-align: center;">0</span>
    </a>

    {# Nastaven√≠ #}
    <a href="/settings.html" class="app-header-settings" title="Nastaven√≠" style="display: flex; align-items: center; justify-content: center; padding: 8px; color: #8b949e; text-decoration: none; transition: color 0.2s;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
      </svg>
    </a>

    {# Odhl√°sit #}
    <a href="/logout" id="header-logout-btn" style="color: #8b949e; text-decoration: none; font-size: 14px; padding: 4px 12px; border: 1px solid #30363d; border-radius: 6px; transition: all 0.2s;">Odhl√°sit</a>

  </div>
</header>

<script>
// Initialize header functionality
(function() {
  // Sidebar toggle + header position update
  const sidebarToggle = document.getElementById('app-header-sidebar-toggle');
  const header = document.querySelector('.app-header');
  
  function updateHeaderPosition() {
    if (!header) return;
    const sidebar = document.getElementById('app-sidebar') || document.querySelector('.app-sidebar');
    const isCollapsed = sidebar && (sidebar.classList.contains('collapsed') || sidebar.classList.contains('closed'));
    const isMobile = window.innerWidth < 768;
    
    if (isMobile || isCollapsed) {
      header.style.left = '0';
    } else {
      header.style.left = '200px'; // ≈°√≠≈ôka sidebaru podle CSS
    }
  }
  
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', () => {
      if (window.appSidebar) {
        window.appSidebar.toggle();
        // Poƒçkat na dokonƒçen√≠ animace a aktualizovat pozici headeru
        setTimeout(updateHeaderPosition, 300);
      }
    });
  }
  
  // Aktualizovat p≈ôi zmƒõnƒõ velikosti okna
  window.addEventListener('resize', updateHeaderPosition);
  
  // Aktualizovat p≈ôi naƒçten√≠
  updateHeaderPosition();
  
  // Sledovat zmƒõny sidebaru (MutationObserver nebo event)
  const sidebar = document.getElementById('app-sidebar') || document.querySelector('.app-sidebar');
  if (sidebar) {
    const observer = new MutationObserver(() => {
      updateHeaderPosition();
    });
    observer.observe(sidebar, { attributes: true, attributeFilter: ['class'] });
  }

  // Load user data (tasks count, logout)
  async function initUserData() {
    try {
      const res = await fetch("/api/me", { credentials: "same-origin" });
      const j = await res.json();
      
      if (j.authenticated) {
        // Update tasks count
        const tasksCountEl = document.getElementById('header-tasks-count');
        if (tasksCountEl) {
          const count = j.tasks_count || 0;
          tasksCountEl.innerHTML = `√ökoly: <strong style="color: #e6edf3;">${count}</strong>`;
        }

        // Update notifications badge
        const badge = document.getElementById('notif-badge');
        if (badge) {
          const cnt = Number(j.unread_notifications || 0) || 0;
          badge.textContent = String(cnt);
          badge.style.display = cnt > 0 ? 'inline-flex' : 'none';
        }

        // Logout button handler
        const logoutBtn = document.getElementById('header-logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
              await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
              location.reload();
            } catch (err) {
              debugLog('Logout error:', err);
              location.href = '/logout';
            }
          });
        }
      }
    } catch (e) {
      debugLog('User data load error:', e);
    }
  }

  // AI Operator dropdown toggle
  const aiToggle = document.getElementById('app-header-ai-toggle');
  const aiDropdown = document.getElementById('ai-operator-dropdown');
  if (aiToggle && aiDropdown) {
    aiToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = aiDropdown.style.display !== 'none';
      aiDropdown.style.display = isOpen ? 'none' : 'block';
      
      if (!isOpen) {
        loadAIOperatorData();
      }
    });

    document.addEventListener('click', (e) => {
      if (!aiToggle.contains(e.target) && !aiDropdown.contains(e.target)) {
        aiDropdown.style.display = 'none';
      }
    });
  }

  // Load AI Operator data
  async function loadAIOperatorData() {
    const contentEl = document.getElementById('ai-operator-dropdown-content');
    if (!contentEl) return;

    try {
      const res = await fetch('/api/jobs/overview');
      const data = await res.json();
      const jobs = data.jobs || [];

      const today = new Date().toISOString().split('T')[0];
      const overdueJobs = jobs.filter(j => {
        const deadline = j.planned_end_date || j.deadline;
        if (!deadline) return false;
        return deadline < today && !['Dokonƒçeno', 'completed', 'archived', 'cancelled'].includes(j.status);
      });

      const materialIssues = jobs.filter(j => {
        const metrics = j.metrics || {};
        const material = metrics.material || {};
        return material.status === 'missing';
      });

      let html = '';
      let totalCount = 0;

      if (overdueJobs.length > 0) {
        totalCount += overdueJobs.length;
        html += `<div class="ai-operator-alert danger" style="display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); border-left: 3px solid #ef4444;">
          <div style="font-size: 20px; flex-shrink: 0;">‚è∞</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 14px; color: #e6edf3; margin-bottom: 4px;">${overdueJobs.length} zak√°zek po term√≠nu</div>
            <div style="font-size: 12px; color: #8b949e;">Vy≈æaduje okam≈æitou pozornost</div>
          </div>
        </div>`;
      }

      if (materialIssues.length > 0) {
        totalCount += materialIssues.length;
        html += `<div class="ai-operator-alert warning" style="display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); border-left: 3px solid #fbbf24;">
          <div style="font-size: 20px; flex-shrink: 0;">üì¶</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 14px; color: #e6edf3; margin-bottom: 4px;">${materialIssues.length} zak√°zek chyb√≠ materi√°l</div>
            <div style="font-size: 12px; color: #8b949e;">Kontrola z√°sob nutn√°</div>
          </div>
        </div>`;
      }

      if (html === '') {
        html = '<div style="padding: 24px 16px; text-align: center; color: #8b949e; font-size: 14px;">V≈°e v po≈ô√°dku! ≈Ω√°dn√° upozornƒõn√≠.</div>';
      }

      contentEl.innerHTML = html;

      const badge = document.getElementById('ai-operator-badge');
      if (badge) {
        badge.textContent = totalCount;
        badge.style.display = totalCount > 0 ? 'inline-flex' : 'none';
      }
    } catch (e) {
      contentEl.innerHTML = '<div style="padding: 24px 16px; text-align: center; color: #8b949e; font-size: 14px;">Chyba p≈ôi naƒç√≠t√°n√≠ dat</div>';
      debugLog('AI Operator data load error:', e);
    }
  }

  // Search input - integrate with global-search.js if available
  const searchInput = document.getElementById('app-header-search-input');
  if (searchInput) {
    // If global-search.js is loaded, it will handle this
    if (window.globalSearch) {
      // Already initialized
    } else {
      // Basic search functionality
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = searchInput.value.trim();
          if (q.length >= 2) {
            window.location.href = `/search.html?q=${encodeURIComponent(q)}`;
          }
        }
      });
    }
  }

  // Initialize user data
  initUserData();
})();
</script>

<style>
/* Hover effects */
.app-header-sidebar-toggle:hover,
.app-header-ai-toggle:hover,
.app-header-notifications:hover,
.app-header-settings:hover {
  color: #e6edf3 !important;
}

#header-logout-btn:hover {
  background: rgba(255,255,255,0.05);
  border-color: #8b949e;
  color: #e6edf3;
}

#app-header-search-input:focus {
  border-color: #4ade80;
}

/* Responsive - hide search on mobile */
@media (max-width: 768px) {
  .app-header-search {
    display: none !important;
  }
}
</style>
