{% extends "layouts/layout_mobile_" + mobile_mode + ".html" %}

{% block content %}
<div class="mobile-page mobile-tasks" data-mode="{{ mobile_mode }}">
    <div class="page-header">
        <h1>Moje úkoly</h1>
    </div>
    
    {% if tasks %}
        <div class="tasks-list">
            {% for task in tasks %}
            <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                    <h3>{{ task.title }}</h3>
                    <span class="task-status status-{{ task.status }}">
                        {% if task.status == 'open' %}Otevřený
                        {% elif task.status == 'in_progress' %}V řešení
                        {% elif task.status == 'done' %}Hotovo
                        {% else %}{{ task.status }}{% endif %}
                    </span>
                </div>
                
                {% if task.description %}
                <p class="task-description">{{ task.description }}</p>
                {% endif %}
                
                <div class="task-meta">
                    {% if task.job_title %}
                    <span class="task-job">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                            <rect x="9" y="3" width="6" height="4" rx="1"/>
                        </svg>
                        {{ task.job_title }}
                        {% if task.job_code %}({{ task.job_code }}){% endif %}
                    </span>
                    {% endif %}
                    
                    {% if task.due_date %}
                    <span class="task-due {% if task.due_date < now().date() %}overdue{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Termín: {{ task.due_date }}
                    </span>
                    {% endif %}
                </div>
                
                <div class="task-actions">
                    {% if task.status != 'done' %}
                    <button class="btn btn-sm btn-primary" onclick="updateTaskStatus({{ task.id }}, 'in_progress')">
                        Začít
                    </button>
                    <button class="btn btn-sm btn-success" onclick="updateTaskStatus({{ task.id }}, 'done')">
                        Hotovo
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <p>Nemáte žádné úkoly</p>
        </div>
    {% endif %}
</div>

<script>
function updateTaskStatus(taskId, status) {
    fetch(`/api/tasks/${taskId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(res => res.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('Chyba: ' + (data.error || 'Nepodařilo se aktualizovat úkol'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Chyba při komunikaci se serverem');
    });
}
</script>

<style>
.mobile-tasks {
    padding: 1rem;
}

.page-header {
    margin-bottom: 1.5rem;
}

.page-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.tasks-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.task-card {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.task-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    flex: 1;
}

.task-status {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-open {
    background: #fef3c7;
    color: #92400e;
}

.status-in_progress {
    background: #dbeafe;
    color: #1e40af;
}

.status-done {
    background: #d1fae5;
    color: #065f46;
}

.task-description {
    color: #6b7280;
    font-size: 0.9rem;
    margin: 0.5rem 0;
}

.task-meta {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin: 0.75rem 0;
    font-size: 0.85rem;
    color: #6b7280;
}

.task-job,
.task-due {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.task-due.overdue {
    color: #dc2626;
    font-weight: 600;
}

.task-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
}
</style>
{% endblock %}
