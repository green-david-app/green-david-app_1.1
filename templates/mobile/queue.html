{% extends "layouts/layout_mobile_" + mobile_mode + ".html" %}

{% block content %}
<div class="mobile-page mobile-queue" data-mode="{{ mobile_mode }}">
    <div class="queue-header">
        <h1>Synchronizace</h1>
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot"></span>
            <span class="status-text">Kontroluji...</span>
        </div>
    </div>
    
    <!-- Pending Queue (z localStorage) -->
    <section class="queue-section">
        <h2>Čeká na odeslání</h2>
        <div id="pendingQueue" class="queue-list">
            <p class="empty-state">Žádné položky ve frontě</p>
        </div>
        <div class="queue-actions" id="queueActions" style="display: none;">
            <button class="btn btn-primary" onclick="OfflineQueue.forceSync()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Synchronizovat nyní
            </button>
            <button class="btn btn-secondary" onclick="clearFailedEvents()">
                Smazat chybné
            </button>
        </div>
    </section>
    
    <!-- Failed Events -->
    <section class="queue-section">
        <h2>Nepodařilo se odeslat</h2>
        <div id="failedQueue" class="queue-list">
            <p class="empty-state">Žádné chyby</p>
        </div>
    </section>
    
    <!-- Recent Synced (z DB) -->
    <section class="queue-section">
        <h2>Nedávno synchronizováno</h2>
        <div class="queue-list">
            {% if recent_events %}
                {% for event in recent_events %}
                <div class="queue-item synced">
                    <div class="item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-type">{{ event.event_type | event_type_label }}</span>
                        <span class="item-time">{{ event.created_at[:16] if event.created_at else '' }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="empty-state">Žádná nedávná synchronizace</p>
            {% endif %}
        </div>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateQueueUI();
    updateConnectionStatus();
    
    // Aktualizuj každých 5 sekund
    setInterval(updateQueueUI, 5000);
    setInterval(updateConnectionStatus, 10000);
});

function updateQueueUI() {
    if (typeof OfflineQueue === 'undefined') {
        console.warn('OfflineQueue není dostupný');
        return;
    }
    
    const queue = OfflineQueue.getQueue();
    const pending = queue.filter(e => !e.status || e.status === 'pending' || e.status === 'syncing');
    const failed = queue.filter(e => e.status === 'failed' || (e.retries && e.retries >= 3));
    
    // Pending
    const pendingContainer = document.getElementById('pendingQueue');
    const queueActions = document.getElementById('queueActions');
    
    if (pending.length > 0) {
        pendingContainer.innerHTML = pending.map(e => `
            <div class="queue-item pending">
                <div class="item-icon ${e.status === 'syncing' ? 'syncing' : ''}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="item-content">
                    <span class="item-type">${getEventTypeLabel(e.type)}</span>
                    <span class="item-time">${formatTimeAgo(e.created_at)}</span>
                </div>
                <div class="item-status">${e.status === 'syncing' ? 'Odesílám...' : 'Čeká'}</div>
            </div>
        `).join('');
        queueActions.style.display = 'flex';
    } else {
        pendingContainer.innerHTML = '<p class="empty-state">Žádné položky ve frontě</p>';
        queueActions.style.display = 'none';
    }
    
    // Failed
    const failedContainer = document.getElementById('failedQueue');
    if (failed.length > 0) {
        failedContainer.innerHTML = failed.map(e => `
            <div class="queue-item failed">
                <div class="item-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                </div>
                <div class="item-content">
                    <span class="item-type">${getEventTypeLabel(e.type)}</span>
                    <span class="item-error">Pokusů: ${e.retries || 0}</span>
                </div>
                <button class="btn btn-sm" onclick="retryEvent('${e.id}')">Zkusit znovu</button>
            </div>
        `).join('');
    } else {
        failedContainer.innerHTML = '<p class="empty-state">Žádné chyby</p>';
    }
}

function updateConnectionStatus() {
    const container = document.getElementById('connectionStatus');
    const isOnline = navigator.onLine;
    
    container.innerHTML = `
        <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
        <span class="status-text">${isOnline ? 'Online' : 'Offline'}</span>
    `;
}

function getEventTypeLabel(type) {
    const labels = {
        'worklog_create': 'Zápis práce',
        'photo_add': 'Fotografie',
        'material_use': 'Výdej materiálu',
        'blocker_create': 'Nahlášení problému'
    };
    return labels[type] || type;
}

function formatTimeAgo(dateStr) {
    if (!dateStr) return 'právě teď';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    
    if (diff < 60) return 'právě teď';
    if (diff < 3600) return `před ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `před ${Math.floor(diff / 3600)} hod`;
    return date.toLocaleDateString('cs');
}

function clearFailedEvents() {
    if (confirm('Opravdu smazat všechny chybné položky?')) {
        if (typeof OfflineQueue !== 'undefined' && OfflineQueue.clearFailed) {
            OfflineQueue.clearFailed();
        } else {
            // Fallback - smaž z localStorage
            const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
            const filtered = queue.filter(e => e.status !== 'failed' && (!e.retries || e.retries < 3));
            localStorage.setItem('offline_queue', JSON.stringify(filtered));
        }
        updateQueueUI();
    }
}

function retryEvent(eventId) {
    if (typeof OfflineQueue !== 'undefined') {
        const queue = OfflineQueue.getQueue();
        const event = queue.find(e => e.id === eventId);
        if (event) {
            event.status = 'pending';
            event.retries = 0;
            OfflineQueue.saveQueue(queue);
            OfflineQueue.sync();
            updateQueueUI();
        }
    }
}

// Přidej forceSync do OfflineQueue pokud neexistuje
if (typeof OfflineQueue !== 'undefined') {
    OfflineQueue.forceSync = function() {
        this.sync();
    };
    
    OfflineQueue.clearFailed = function() {
        const queue = this.getQueue();
        const filtered = queue.filter(e => e.status !== 'failed' && (!e.retries || e.retries < 3));
        this.saveQueue(filtered);
    };
}
</script>

<style>
.mobile-queue {
    padding: 1rem;
}

.queue-header {
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.queue-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #9ca3af;
}

.status-dot.online {
    background: #10b981;
}

.status-dot.offline {
    background: #ef4444;
}

.queue-section {
    margin-bottom: 2rem;
}

.queue-section h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #374151;
}

.queue-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.queue-item {
    background: white;
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.queue-item.pending {
    border-left: 3px solid #3b82f6;
}

.queue-item.failed {
    border-left: 3px solid #ef4444;
}

.queue-item.synced {
    border-left: 3px solid #10b981;
}

.item-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    color: #6b7280;
    flex-shrink: 0;
}

.item-icon.syncing {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.item-type {
    font-weight: 500;
    color: #111827;
}

.item-time {
    font-size: 0.75rem;
    color: #6b7280;
}

.item-error {
    font-size: 0.75rem;
    color: #ef4444;
}

.item-status {
    font-size: 0.85rem;
    color: #6b7280;
}

.queue-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
}

.empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: #9ca3af;
    font-size: 0.9rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}
