{% extends "layout.html" %}
{% block content %}
<h1>Kalendář</h1>

<div class="cal-controls">
  <button id="prev">◀</button>
  <div id="monthLabel" class="month-label"></div>
  <button id="next">▶</button>
  <div class="spacer"></div>
  <button id="addNote" class="btn">+ Poznámka</button>
  <button id="addTask" class="btn">+ Úkol</button>
  <button id="addJob" class="btn">+ Zakázka</button>
</div>

<div id="calendar" class="calendar-grid"></div>

<!-- iPhone-like day detail list -->
<div id="dayDetail" class="day-detail hidden">
  <div class="day-detail-header">
    <div class="day-detail-date" id="dayDetailDate">—</div>
    <div class="day-detail-actions">
      <button id="quickAddNote" class="btn ghost">+ Pozn.</button>
      <button id="quickAddTask" class="btn ghost">+ Úkol</button>
      <button id="quickAddJob" class="btn ghost">+ Zak.</button>
    </div>
  </div>
  <ul id="dayEvents" class="day-events"></ul>
</div>

<dialog id="eventDlg">
  <form method="dialog" id="eventForm">
    <h3 id="dlgTitle">Událost</h3>
    <input type="hidden" name="id"/>
    <input type="hidden" name="kind"/>
    <label>Datum
      <input type="date" name="date" required/>
    </label>
    <label id="titleRow">Název
      <input type="text" name="title" placeholder="Název"/>
    </label>
    <label>Popis
      <textarea name="description" rows="3" placeholder="Podrobnosti"></textarea>
    </label>
    <menu>
      <button value="cancel" class="btn ghost">Zavřít</button>
      <button id="saveBtn" value="default" class="btn">Uložit</button>
    </menu>
  </form>
</dialog>

<style>
/* Month grid */
.calendar-grid{
  display:grid;
  grid-template-columns: repeat(7, minmax(0,1fr));
  gap:6px;
}
.cal-cell{
  background: var(--panel);
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px;
  min-height:68px;
  position:relative;
  cursor:pointer;
  transition:transform .08s ease;
}
.cal-cell:hover{ transform: translateY(-1px); }
.cal-cell.muted{ opacity:.45; }
.cal-date{ font-weight:700; font-size:14px; color: var(--txt-inv); }
.cal-events{ display:flex; flex-direction:column; gap:4px; margin-top:4px; }
.badge{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; background: var(--accent); color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.badge.task{ background:#2d6cdf; }
.badge.job{ background:#9b59b6; }
.cal-cell.selected{ outline:2px solid var(--accent); outline-offset:2px; }

/* Day detail strip */
.day-detail{
  margin-top:12px;
  background: var(--panel);
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px;
  animation: slideDown .18s ease;
}
@keyframes slideDown{ from{ opacity:0; transform: translateY(-6px)} to{ opacity:1; transform:none } }
.day-detail.hidden{ display:none; }
.day-detail-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.day-detail-date{ font-weight:800; font-size:16px; color:var(--txt-inv); }
.day-detail-actions .btn.ghost{ padding:6px 10px; font-size:12px; }

.day-events{ list-style:none; padding:0; margin:8px 0 0 0; display:flex; flex-direction:column; gap:8px; }
.day-event{ display:flex; align-items:center; justify-content:space-between; gap:12px; background: var(--panel-2); border:1px solid var(--line); border-radius:12px; padding:8px 10px; color: var(--txt-inv); }
.day-event .meta{ display:flex; align-items:center; gap:8px; }
.day-event .title{ font-weight:700; }
.day-event .kind{ font-size:12px; opacity:.8; }
.day-event .actions button{ padding:6px 8px; font-size:12px; }

.month-label{ font-weight:800; font-size:18px; }
.cal-controls{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.cal-controls .spacer{ flex:1; }
dialog{ border:none; border-radius:12px; padding:0; }
dialog form{ padding:14px; background:var(--panel); color:var(--txt-inv); border:1px solid var(--line); border-radius:12px; min-width:300px; }
dialog input, dialog textarea{ width:100%; }
menu{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
.btn.ghost{ background:transparent; border-color:var(--line); color:var(--txt-inv); }
</style>

<script>
const grid = document.getElementById("calendar");
const label = document.getElementById("monthLabel");
const dlg = document.getElementById("eventDlg");
const form = document.getElementById("eventForm");
const dayDetail = document.getElementById("dayDetail");
const dayDetailDate = document.getElementById("dayDetailDate");
const dayEventsList = document.getElementById("dayEvents");

let cur = new Date(); cur.setDate(1);
let monthItems = []; // cache for current month
let selectedDate = null;

function fmtMonth(d){return d.toLocaleDateString('cs-CZ',{month:'long',year:'numeric'});}
function fmtDayLong(d){return d.toLocaleDateString('cs-CZ',{weekday:'long', day:'numeric', month:'long'});}
function ymd(d){return d./*utc-cut*/;}

async function loadMonth() {
  label.textContent = fmtMonth(cur);
  grid.innerHTML = "";
  dayDetail.classList.add('hidden');
  selectedDate = null;

  const first = new Date(cur); const startDow = (first.getDay()+6)%7; // Mon=0
  first.setDate(1-startDow);
  for (let i=0;i<42;i++){
    const day = new Date(first); day.setDate(first.getDate()+i);
    const cell = document.createElement("div");
    cell.className = "cal-cell"+(day.getMonth()==cur.getMonth()?"":" muted");
    cell.innerHTML = `<div class="cal-date">${day.getDate()}.</div><div class="cal-events"></div>`;
    cell.dataset.date = ymd(day);
    cell.addEventListener("click", ()=>selectDay(ymd(day), cell));
    cell.addEventListener("dblclick", ()=>openDlg({date: ymd(day)}));
    grid.appendChild(cell);
  }
  const from = ymd(new Date(cur.getFullYear(),cur.getMonth(),1));
  const to = ymd(new Date(cur.getFullYear(),cur.getMonth()+1,0));
  const resp = await fetch(`/gd/api/calendar?from=${from}&to=${to}`);
  const data = await resp.json();
  monthItems = data.items||[];
  renderEvents(monthItems);
}

function renderEvents(items){
  // clear event pills
  grid.querySelectorAll(".cal-events").forEach(e=>e.innerHTML="");
  for (const ev of items){
    const container = grid.querySelector(`.cal-cell[data-date="${ev.date}"] .cal-events`);
    if (!container) continue;
    const pill = document.createElement("div");
    const kind = ev.kind || ev.type || 'note';
    pill.className = "badge " + (kind=='task'?'task':(kind=='job'?'job':''));
    pill.textContent = ev.title || ev.name || ev.description || '(bez názvu)';
    container.appendChild(pill);
  }
}

function selectDay(dateStr, cellEl){
  // highlight selected cell
  grid.querySelectorAll(".cal-cell.selected").forEach(c=>c.classList.remove("selected"));
  if (cellEl) cellEl.classList.add("selected");

  selectedDate = dateStr;
  const d = new Date(dateStr+"T00:00:00");
  dayDetailDate.textContent = fmtDayLong(d);
  // fill list
  const events = monthItems.filter(x => x.date === dateStr);
  dayEventsList.innerHTML = "";
  if (events.length===0){
    const li = document.createElement("li");
    li.className = "day-event";
    li.innerHTML = '<div class="meta"><span class="kind">Žádné události</span></div><div class="actions"><button class="btn" onclick="openDlg({date:selectedDate})">+ Přidat</button></div>';
    dayEventsList.appendChild(li);
  } else {
    for (const ev of events){
      const li = document.createElement("li");
      const kind = ev.kind || ev.type || 'note';
      li.className = "day-event";
      li.innerHTML = `<div class="meta"><span class="badge ${kind=='task'?'task':(kind=='job'?'job':'')}">${kind}</span><span class="title">${ev.title || ev.name || '(bez názvu)'}</span></div>
                      <div class="actions">
                        <button class="btn ghost" onclick='openDlg(${JSON.stringify({id:"__ID__",kind:"__K__",date:"__D__",title:"__T__",description:"__DS__"})}
                          .replace("__ID__", ev.id || "")
                          .replace("__K__", kind)
                          .replace("__D__", ev.date || "")
                          .replace("__T__", (ev.title||ev.name||"").replaceAll("'", "\\'"))
                          .replace("__DS__", (ev.description||"").replaceAll("'", "\\'"))
                        )'>Upravit</button>
                      </div>`;
      dayEventsList.appendChild(li);
    }
  }
  dayDetail.classList.remove('hidden');
  // scroll into view on mobile
  dayDetail.scrollIntoView({behavior:'smooth', block:'nearest'});
}

// dialog logic
function openDlg(data){
  const f = form;
  f.reset();
  f.kind.value = data.kind || data.type || 'note';
  f.date.value = data.date || (selectedDate || ymd(new Date()));
  f.title.value = data.title || data.name || '';
  f.description.value = data.description || '';
  f.id.value = data.id || '';
  document.getElementById("dlgTitle").textContent = (data.id?'Upravit':'Přidat') + ' ' + (f.kind.value==='task'?'úkol':(f.kind.value==='job'?'zakázku':'poznámku'));
  dlg.showModal();
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const payload = Object.fromEntries(fd.entries());
  const url = "/gd/api/calendar";
  let method = "POST";
  if (payload.id){ method="PATCH"; }
  const resp = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if (resp.ok){ dlg.close(); await loadMonth(); if (selectedDate) selectDay(selectedDate, grid.querySelector(`.cal-cell[data-date="${selectedDate}"]`)); }
  else { alert("Uložení selhalo"); }
});

document.getElementById("prev").onclick=()=>{cur.setMonth(cur.getMonth()-1); loadMonth();};
document.getElementById("next").onclick=()=>{cur.setMonth(cur.getMonth()+1); loadMonth();};
document.getElementById("addNote").onclick=()=>openDlg({kind:"note", date: ymd(new Date(cur.getFullYear(),cur.getMonth(),1))});
document.getElementById("addTask").onclick=()=>openDlg({kind:"task", date: ymd(new Date(cur.getFullYear(),cur.getMonth(),1))});
document.getElementById("addJob").onclick=()=>openDlg({kind:"job", date: ymd(new Date(cur.getFullYear(),cur.getMonth(),1))});

document.getElementById("quickAddNote").onclick=()=>openDlg({kind:"note", date: selectedDate || ymd(new Date())});
document.getElementById("quickAddTask").onclick=()=>openDlg({kind:"task", date: selectedDate || ymd(new Date())});
document.getElementById("quickAddJob").onclick=()=>openDlg({kind:"job", date: selectedDate || ymd(new Date())});

// auto select today if in current month
function autoSelectToday(){
  const today = new Date();
  if (today.getFullYear()===cur.getFullYear() && today.getMonth()===cur.getMonth()){
    const ds = ymd(today);
    const cell = grid.querySelector(`.cal-cell[data-date="${ds}"]`);
    if (cell) selectDay(ds, cell);
  }
}

loadMonth().then(autoSelectToday);
</script>
{% endblock %}
