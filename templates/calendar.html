{% extends "layout.html" %}
{% block content %}
<h1>Kalendář</h1>
<div id="calhost"></div>
<script>
(function(){
  function mount(node, html){ node.innerHTML = html; }
  function html(){
    return `
    <div class="card">
      <div class="card-h"><div>Měsíční kalendář</div>
        <div class="card-actions"><button id="cprev" class="ghost">◀︎</button><div id="clabel" style="min-width:140px;text-align:center"></div><button id="cnext" class="ghost">▶︎</button></div>
      </div>
      <div class="card-c"><div class="calendar-grid" id="cgrid"></div></div>
    </div>`;
  }
  function setup(){
    const host=document.getElementById('calhost'); mount(host, html());
    const grid=document.getElementById("cgrid"), label=document.getElementById("clabel");
    let y=new Date().getFullYear(), m=new Date().getMonth()+1;
    const fmt=(y,m,d)=>y+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0");
    const dim=(y,m)=>new Date(y,m,0).getDate();
    async function load(){
      label.textContent=y+"-"+String(m).padStart(2,"0");
      const js=await (await fetch(`/gd/api/calendar?year=${y}&month=${m}`)).json(); const ev=js.events||[];
      const firstDow=new Date(y,m-1,1).getDay()||7, total=dim(y,m);
      const frag=document.createDocumentFragment();
      ["Po","Út","St","Čt","Pá","So","Ne"].forEach(d=>{const h=document.createElement("div");h.className="cal-head";h.textContent=d;frag.appendChild(h);});
      for(let i=1;i<firstDow;i++){frag.appendChild(document.createElement("div"));}
      for(let d=1; d<=total; d++){
        const cell=document.createElement("div"); cell.className="cal-cell";
        const day=document.createElement("div"); day.className="cal-day"; day.textContent=d; cell.appendChild(day);
        const list=document.createElement("div"); list.className="cal-evts"; cell.appendChild(list);
        ev.filter(e=>e.date===fmt(y,m,d)).forEach(e=>{const tag=document.createElement("div"); tag.className="tag "+e.kind; tag.textContent=e.title; list.appendChild(tag);});
        frag.appendChild(cell);
      }
      grid.innerHTML=""; grid.appendChild(frag);
    }
    document.getElementById('cprev').onclick=()=>{m--; if(m<1){m=12;y--;} load();};
    document.getElementById('cnext').onclick=()=>{m++; if(m>12){m=1;y++;} load();};
    load();
  }
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',setup);} else {setup();}
})();
</script>
{% endblock %}
