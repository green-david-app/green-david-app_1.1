{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="container">
    <div class="card">
      <div class="card-h">
        <div class="card-title">Detail zak√°zky</div>
      </div>
      <div class="card-c" id="jobBox">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h" style="display:flex;justify-content:space-between;align-items:center">
        <div class="card-title">V√Ωkazy pro tuto zak√°zku</div>
        <button id="btnExpCSV" class="btn btn-ghost btn-sm">Export CSV</button>
      </div>
      <div class="card-c">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Zamƒõstnanec</th>
                <th>Hodin</th>
                <th>M√≠sto</th>
                <th>ƒåinnost</th>
              </tr>
            </thead>
            <tbody id="tsBody">
              <tr><td colspan="5" class="text-center text-muted">Naƒç√≠t√°m‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(async function(){
  const jid = {{ job_id|int }};

  function toCZ(d){
    if(!d) return '';
    const [y,m,da] = d.split('-');
    return `${da}.${m}.${y}`;
  }

  async function fetchJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  const jobBox = document.getElementById('jobBox');
  const tsBody = document.getElementById('tsBody');
  const btnCSV = document.getElementById('btnExpCSV');

  // load job info
  try{
    const j = await fetchJSON('/api/jobs/'+jid);
    const job = j.job;
    jobBox.innerHTML = `
      <div class="kv"><span>üìõ</span><span><strong>${job.title||''}</strong> <span class="muted">#${job.code||''}</span></span></div>
      <div class="kv"><span>üèôÔ∏è</span><span>${job.city||''}</span></div>
      <div class="kv"><span>üë§</span><span>${job.client||''}</span></div>
      <div class="kv"><span>üìÖ</span><span>${toCZ(job.date||'')}</span></div>
      <div class="kv"><span>‚ÑπÔ∏è</span><span>${job.status||''}</span></div>
      ${job.note ? `<div class="kv"><span>üìù</span><span>${job.note}</span></div>` : ''}
    `;
  }catch(e){
    jobBox.textContent = 'Zak√°zka nenalezena';
  }

  // load timesheets for this job
  const data = await fetchJSON('/api/timesheets?job_id='+jid);
  const rows = data.rows || [];
  if(rows.length===0){
    tsBody.innerHTML = '<tr><td colspan="5" class="muted">≈Ω√°dn√© v√Ωkazy pro tuto zak√°zku</td></tr>';
  }else{
    tsBody.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${toCZ(r.date)}</td><td>${r.employee_name||('#'+r.employee_id)}</td><td>${r.hours}</td><td>${r.place||''}</td><td>${r.activity||''}</td>`;
      tsBody.appendChild(tr);
    }
  }

  // CSV export (client-side)
  btnCSV.addEventListener('click', async ()=>{
    const d = await fetchJSON('/api/timesheets/export?job_id='+jid);
    const rows = d.rows || [];
    if(rows.length===0){ alert('Nic k exportu'); return; }
    const headers = Object.keys(rows[0]);
    const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>`"${String(r[h]??'').replaceAll('"','""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'timesheets_job_'+jid+'.csv';
    a.click();
  });

})();
</script>
{% endblock %}