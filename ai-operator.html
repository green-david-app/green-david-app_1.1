<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Operátor | Green David</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/icons.css">
    <script src="/app-settings.js"></script>
    <script src="/static/app-header.js"></script>
    <script src="/static/bottom-nav.js"></script>
    <style>
        * { box-sizing: border-box; }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Page Header - same style as jobs.html */
        .page-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .page-header h1 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: #fff;
        }

        .page-header h1 svg {
            width: 32px;
            height: 32px;
            stroke: #9FD4A1;
        }

        /* Health Score Card */
        .health-score-card {
            background: linear-gradient(135deg, #1f2940 0%, #16213e 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 32px;
            border: 1px solid #2d3748;
            flex-wrap: wrap;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            background: conic-gradient(
                #4ade80 calc(var(--score, 0) * 1%),
                #1a1a2e 0%
            );
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 90px;
            height: 90px;
            background: #1f2940;
            border-radius: 50%;
        }

        .score-number {
            position: relative;
            font-size: 36px;
            z-index: 1;
            color: #fff;
        }

        .score-label {
            position: relative;
            font-size: 12px;
            color: #a0a0a0;
            z-index: 1;
        }

        .score-info {
            flex: 1;
            min-width: 200px;
        }

        .score-info h2 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: #fff;
        }

        .score-info p {
            margin: 0;
            color: #a0a0a0;
        }

        .quick-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .stat-box {
            text-align: center;
            padding: 12px 20px;
            background: #16213e;
            border-radius: 12px;
            min-width: 80px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-number.red { color: #f87171; }
        .stat-number.yellow { color: #fbbf24; }
        .stat-number.blue { color: #60a5fa; }
        .stat-number.green { color: #4ade80; }

        .stat-label {
            font-size: 11px;
            color: #a0a0a0;
            text-transform: uppercase;
        }

        /* Today Actions */
        .today-card {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, #1f2940 100%);
            border: 1px solid #4ade80;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .today-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .today-header h3 {
            margin: 0;
            color: #4ade80;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .today-header h3 svg {
            width: 20px;
            height: 20px;
            stroke: #4ade80;
        }

        .today-date {
            color: #a0a0a0;
            font-size: 14px;
        }

        .today-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .today-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #16213e;
            border-radius: 12px;
            border-left: 4px solid #4ade80;
            cursor: pointer;
            transition: all 0.2s;
        }

        .today-item:hover {
            background: #1f2940;
        }

        .today-item.critical { border-left-color: #f87171; }
        .today-item.high { border-left-color: #fbbf24; }
        .today-item.medium { border-left-color: #60a5fa; }
        .today-item.ok { border-left-color: #4ade80; }

        .today-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .today-icon svg {
            width: 24px;
            height: 24px;
        }

        .today-item.critical .today-icon svg { stroke: #f87171; }
        .today-item.high .today-icon svg { stroke: #fbbf24; }
        .today-item.medium .today-icon svg { stroke: #60a5fa; }
        .today-item.ok .today-icon svg { stroke: #4ade80; }

        .today-content {
            flex: 1;
        }

        .today-text {
            font-weight: 500;
            margin-bottom: 4px;
            color: #fff;
        }

        .today-detail {
            font-size: 13px;
            color: #a0a0a0;
        }

        .today-action {
            padding: 8px 16px;
            background: #1f2940;
            border: 1px solid #2d3748;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .today-action:hover {
            background: #4ade80;
            color: #1a1a2e;
            border-color: #4ade80;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #1f2940;
            border: 1px solid #2d3748;
            border-radius: 8px;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        .tab:hover {
            background: #16213e;
            color: #fff;
        }

        .tab.active {
            background: #4ade80;
            color: #1a1a2e;
            border-color: #4ade80;
        }

        .tab-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .tab.active .tab-badge {
            background: rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: #1f2940;
            border-radius: 12px;
            border: 1px solid #2d3748;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #2d3748;
        }

        .card-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
        }

        .card-title svg {
            width: 20px;
            height: 20px;
            stroke: #9FD4A1;
        }

        .card-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-critical { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .badge-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-info { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .badge-success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }

        .card-content {
            padding: 16px;
        }

        /* Alert Items */
        .alert-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #16213e;
            border-left: 3px solid #2d3748;
        }

        .alert-item:last-child { margin-bottom: 0; }

        .alert-item.critical { border-left-color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .alert-item.high { border-left-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .alert-item.warning { border-left-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .alert-item.medium { border-left-color: #60a5fa; }
        .alert-item.low { border-left-color: #4ade80; }

        .alert-item h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #fff;
        }

        .alert-item p {
            margin: 0;
            font-size: 13px;
            color: #a0a0a0;
        }

        .alert-item .recommendation {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #2d3748;
            font-size: 12px;
        }

        .alert-item .recommendation a {
            color: #4ade80;
            text-decoration: none;
        }

        /* Material Items */
        .material-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #2d3748;
        }

        .material-item:last-child { border-bottom: none; }

        .material-icon svg {
            width: 24px;
            height: 24px;
            stroke: #9FD4A1;
        }

        .material-info { flex: 1; }

        .material-name { font-weight: 500; color: #fff; }

        .material-stock {
            font-size: 12px;
            color: #a0a0a0;
        }

        .days-remaining {
            text-align: right;
        }

        .days-number {
            font-size: 20px;
            font-weight: bold;
        }

        .days-label {
            font-size: 10px;
            color: #a0a0a0;
        }

        /* Weather Forecast */
        .forecast-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 16px;
        }

        .forecast-day {
            flex: 0 0 80px;
            text-align: center;
            padding: 12px;
            background: #16213e;
            border-radius: 12px;
        }

        .forecast-day.risk-critical {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid #f87171;
        }

        .forecast-day.risk-high {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
        }

        .forecast-date {
            font-size: 12px;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .forecast-icon svg {
            width: 28px;
            height: 28px;
            stroke: #60a5fa;
            margin-bottom: 8px;
        }

        .forecast-temp {
            font-weight: bold;
            color: #fff;
        }

        /* Workload Chart */
        .workload-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .workload-name {
            width: 100px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .workload-track {
            flex: 1;
            height: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            overflow: hidden;
        }

        .workload-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .workload-hours {
            width: 50px;
            text-align: right;
            font-size: 13px;
            color: #a0a0a0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #a0a0a0;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            stroke: #4ade80;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            margin: 0 0 8px 0;
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .health-score-card { flex-direction: column; text-align: center; }
            .quick-stats { justify-content: center; }
            .cards-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Standardní app header jako index.html -->
    <header class="app-header">
        <div class="app-header-container">
            <a href="/" class="app-header-brand">
                <img src="/logo.jpg" alt="green david app" class="app-header-logo" onerror="this.src='/static/logo.svg'"/>
                <div class="app-header-text">
                    <div class="app-header-title">green david</div>
                    <div class="app-header-subtitle">AI Operátor</div>
                </div>
            </a>
            <div class="global-search-container"></div>
            <div class="app-header-actions">
                <!-- Notifikace zvoneček -->
                <div class="notification-bell" onclick="toggleNotificationPanel()" style="position: relative; cursor: pointer; margin-right: 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notifBadge" class="notif-badge" style="display: none; position: absolute; top: -5px; right: -5px; background: #f87171; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold;">0</span>
                </div>
                <div id="userbox" class="app-header-user"></div>
                <a href="/settings.html" class="app-header-settings" title="Nastavení">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Page Header - same style as jobs.html -->
        <div class="page-header">
            <h1>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
                    <path d="M16 14h.01M8 14h.01"/>
                    <path d="M12 17v3"/>
                    <path d="M20 12c0 4.418-3.582 8-8 8s-8-3.582-8-8"/>
                    <circle cx="12" cy="12" r="10"/>
                </svg>
                <span>AI Operátor</span>
            </h1>
        </div>

        <!-- Health Score -->
        <div class="health-score-card">
            <div class="score-circle" id="scoreCircle" style="--score: 0">
                <div class="score-number" id="scoreNumber">--</div>
                <div class="score-label">SKÓRE</div>
            </div>
            <div class="score-info">
                <h2>Zdraví firmy</h2>
                <p id="scoreDescription">Načítání...</p>
            </div>
            <div class="quick-stats">
                <div class="stat-box">
                    <div class="stat-number red" id="criticalCount">0</div>
                    <div class="stat-label">Kritické</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number yellow" id="warningsCount">0</div>
                    <div class="stat-label">Varování</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number blue" id="infoCount">0</div>
                    <div class="stat-label">Info</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number green" id="approvalCount">0</div>
                    <div class="stat-label">Ke schválení</div>
                </div>
            </div>
        </div>

        <!-- Today Actions -->
        <div class="today-card">
            <div class="today-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Prioritní úkoly dnes
                </h3>
                <span class="today-date" id="todayDate"></span>
            </div>
            <div class="today-list" id="todayList">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <p>Načítání...</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="overview">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="9"/>
                    <rect x="14" y="3" width="7" height="5"/>
                    <rect x="14" y="12" width="7" height="9"/>
                    <rect x="3" y="16" width="7" height="5"/>
                </svg>
                Přehled
                <span class="tab-badge" id="overviewBadge">0</span>
            </div>
            <div class="tab" data-tab="inbox">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-6l-2 3h-4l-2-3H2"/>
                    <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                </svg>
                Inbox
                <span class="tab-badge" id="inboxBadge">0</span>
            </div>
            <div class="tab" data-tab="drafts">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="9" y1="15" x2="15" y2="15"/>
                </svg>
                Ke schválení
                <span class="tab-badge" id="draftsBadge">0</span>
            </div>
            <div class="tab" data-tab="weather">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/>
                </svg>
                Počasí
                <span class="tab-badge" id="weatherBadge">0</span>
            </div>
            <div class="tab" data-tab="materials">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
                Materiál
                <span class="tab-badge" id="materialsBadge">0</span>
            </div>
            <div class="tab" data-tab="workload">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Vytížení
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content active" id="overview">
            <div class="cards-grid" id="overviewGrid">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <p>Načítání dat...</p>
                </div>
            </div>
        </div>

        <!-- INSIGHT INBOX TAB -->
        <div class="tab-content" id="inbox">
            <!-- Filtry -->
            <div class="inbox-filters" style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <select id="filterStatus" class="filter-select" style="padding: 8px 12px; background: #1f2940; border: 1px solid #2d3748; border-radius: 8px; color: #fff;">
                    <option value="">Všechny stavy</option>
                    <option value="open" selected>Otevřené</option>
                    <option value="snoozed">Odložené</option>
                    <option value="resolved">Vyřešené</option>
                    <option value="dismissed">Zamítnuté</option>
                </select>
                <select id="filterSeverity" class="filter-select" style="padding: 8px 12px; background: #1f2940; border: 1px solid #2d3748; border-radius: 8px; color: #fff;">
                    <option value="">Všechny priority</option>
                    <option value="CRITICAL">Kritické</option>
                    <option value="WARN">Varování</option>
                    <option value="INFO">Info</option>
                </select>
                <select id="filterType" class="filter-select" style="padding: 8px 12px; background: #1f2940; border: 1px solid #2d3748; border-radius: 8px; color: #fff;">
                    <option value="">Všechny typy</option>
                    <option value="BUDGET_OVERRUN_LABOR">Rozpočet - práce</option>
                    <option value="BUDGET_OVERRUN_MATERIAL">Rozpočet - materiál</option>
                    <option value="JOB_BEHIND_SCHEDULE">Skluz zakázky</option>
                    <option value="TASK_OVERDUE">Zpožděné úkoly</option>
                    <option value="NO_ACTIVITY_ON_JOB">Bez aktivity</option>
                    <option value="EMPLOYEE_OVERLOAD">Přetížení</option>
                    <option value="EMPLOYEE_IDLE">Volná kapacita</option>
                    <option value="LOW_STOCK">Nízký stav skladu</option>
                    <option value="RESERVATION_EXCEEDS_STOCK">Konflikt rezervací</option>
                    <option value="MISSING_LOCATION">Chybí lokace</option>
                    <option value="MISSING_ESTIMATES">Chybí odhady</option>
                    <option value="MISSING_PHOTO_DOC">Chybí foto</option>
                    <option value="COMPLETED_NOT_INVOICED">K fakturaci</option>
                    <option value="WEATHER_RISK_OUTDOOR">Počasí</option>
                    <option value="INVENTORY_VARIANCE">Odchylka spotřeby</option>
                </select>
                <button onclick="loadInsights()" style="padding: 8px 16px; background: #4ade80; border: none; border-radius: 8px; color: #1a1a2e; cursor: pointer; font-weight: 500;">
                    Filtrovat
                </button>
            </div>
            
            <!-- Seznam insightů -->
            <div id="insightsList" class="insights-list">
                <div class="empty-state">
                    <p>Načítání...</p>
                </div>
            </div>
        </div>

        <!-- ACTION DRAFTS TAB -->
        <div class="tab-content" id="drafts">
            <div id="draftsList" class="drafts-list">
                <div class="empty-state">
                    <p>Načítání...</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="weather">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        Předpověď 7 dní
                    </div>
                </div>
                <div class="forecast-row" id="forecastRow"></div>
            </div>
            <div class="cards-grid" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            Ohrožené zakázky
                        </div>
                    </div>
                    <div class="card-content" id="weatherAlerts"></div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="materials">
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                            Kriticky dochází
                        </div>
                        <span class="card-badge badge-critical" id="criticalMaterialsBadge">0</span>
                    </div>
                    <div id="criticalMaterials"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                            K objednání
                        </div>
                    </div>
                    <div id="orderMaterials"></div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="workload">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                        Vytížení zaměstnanců tento týden
                    </div>
                </div>
                <div class="card-content" id="workloadChart"></div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION PANEL (slide-in) -->
    <div id="notificationPanel" style="display: none; position: fixed; top: 60px; right: 20px; width: 380px; max-height: 500px; background: #1f2940; border-radius: 16px; border: 1px solid #2d3748; z-index: 999; box-shadow: 0 10px 40px rgba(0,0,0,0.5); overflow: hidden;">
        <div style="padding: 16px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #fff; font-size: 16px;">Notifikace</h3>
            <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: #4ade80; cursor: pointer; font-size: 12px;">Označit vše jako přečtené</button>
        </div>
        <div id="notificationList" style="max-height: 400px; overflow-y: auto; padding: 8px;">
            <div style="text-align: center; padding: 20px; color: #666;">Načítání...</div>
        </div>
        <div style="padding: 12px; border-top: 1px solid #2d3748; text-align: center;">
            <a href="#" onclick="showDigestModal(); return false;" style="color: #60a5fa; text-decoration: none; font-size: 13px;">Zobrazit ranní digest</a>
        </div>
    </div>

    <!-- DIGEST MODAL -->
    <div id="digestModal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; overflow-y: auto;">
        <div class="modal-content" style="max-width: 600px; margin: 40px auto; background: #1f2940; border-radius: 16px; border: 1px solid #2d3748;">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #fff;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                    </svg>
                    Ranní Digest
                </h3>
                <button onclick="closeDigestModal()" style="background: none; border: none; color: #a0a0a0; cursor: pointer; font-size: 24px;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="digestContent">
                    <p style="color: #666; text-align: center;">Načítání...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- INSIGHT DETAIL MODAL -->
    <div id="insightModal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; overflow-y: auto;">
        <div class="modal-content" style="max-width: 600px; margin: 40px auto; background: #1f2940; border-radius: 16px; border: 1px solid #2d3748;">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center;">
                <h3 id="modalTitle" style="margin: 0; color: #fff;"></h3>
                <button onclick="closeModal()" style="background: none; border: none; color: #a0a0a0; cursor: pointer; font-size: 24px;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="modalSeverity" style="margin-bottom: 16px;"></div>
                <p id="modalSummary" style="color: #a0a0a0; margin-bottom: 20px;"></p>
                
                <h4 style="color: #9FD4A1; margin-bottom: 12px;">Důkazy</h4>
                <div id="modalEvidence" style="background: #16213e; border-radius: 8px; padding: 16px; margin-bottom: 20px;"></div>
                
                <h4 style="color: #9FD4A1; margin-bottom: 12px;">Doporučené akce</h4>
                <div id="modalActions" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>
            <div class="modal-footer" style="padding: 20px; border-top: 1px solid #2d3748; display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="snoozeInsight()" style="padding: 10px 20px; background: #60a5fa; border: none; border-radius: 8px; color: #fff; cursor: pointer;">
                    Odložit
                </button>
                <button onclick="showDismissModal()" style="padding: 10px 20px; background: #f87171; border: none; border-radius: 8px; color: #fff; cursor: pointer;">
                    Zamítnout
                </button>
                <button onclick="resolveInsight()" style="padding: 10px 20px; background: #4ade80; border: none; border-radius: 8px; color: #1a1a2e; cursor: pointer;">
                    Vyřešeno
                </button>
            </div>
        </div>
    </div>

    <!-- DISMISS MODAL -->
    <div id="dismissModal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1001; padding: 20px;">
        <div class="modal-content" style="max-width: 400px; margin: 100px auto; background: #1f2940; border-radius: 16px; border: 1px solid #2d3748;">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #2d3748;">
                <h3 style="margin: 0; color: #fff;">Důvod zamítnutí</h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <select id="dismissReason" style="width: 100%; padding: 12px; background: #16213e; border: 1px solid #2d3748; border-radius: 8px; color: #fff; margin-bottom: 16px;">
                    <option value="false_positive">Falešný poplach</option>
                    <option value="accepted_risk">Akceptované riziko</option>
                    <option value="already_handled">Již vyřešeno jinak</option>
                    <option value="not_relevant">Není relevantní</option>
                    <option value="other">Jiný důvod</option>
                </select>
                <textarea id="dismissNote" placeholder="Volitelná poznámka..." style="width: 100%; padding: 12px; background: #16213e; border: 1px solid #2d3748; border-radius: 8px; color: #fff; min-height: 80px; resize: vertical;"></textarea>
            </div>
            <div class="modal-footer" style="padding: 20px; border-top: 1px solid #2d3748; display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeDismissModal()" style="padding: 10px 20px; background: #2d3748; border: none; border-radius: 8px; color: #fff; cursor: pointer;">
                    Zrušit
                </button>
                <button onclick="confirmDismiss()" style="padding: 10px 20px; background: #f87171; border: none; border-radius: 8px; color: #fff; cursor: pointer;">
                    Zamítnout
                </button>
            </div>
        </div>
    </div>

    <!-- SNOOZE MODAL -->
    <div id="snoozeModal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1001; padding: 20px;">
        <div class="modal-content" style="max-width: 400px; margin: 100px auto; background: #1f2940; border-radius: 16px; border: 1px solid #2d3748;">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #2d3748;">
                <h3 style="margin: 0; color: #fff;">Odložit do</h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="snoozeFor(1)" class="snooze-btn" style="padding: 12px; background: #16213e; border: 1px solid #2d3748; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">Zítra</button>
                    <button onclick="snoozeFor(3)" class="snooze-btn" style="padding: 12px; background: #16213e; border: 1px solid #2d3748; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">Za 3 dny</button>
                    <button onclick="snoozeFor(7)" class="snooze-btn" style="padding: 12px; background: #16213e; border: 1px solid #2d3748; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">Za týden</button>
                    <button onclick="snoozeFor(14)" class="snooze-btn" style="padding: 12px; background: #16213e; border: 1px solid #2d3748; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">Za 2 týdny</button>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px; border-top: 1px solid #2d3748;">
                <button onclick="closeSnoozeModal()" style="width: 100%; padding: 10px 20px; background: #2d3748; border: none; border-radius: 8px; color: #fff; cursor: pointer;">
                    Zrušit
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <bottom-nav active="ai"></bottom-nav>

    <script>
        // SVG Icons for dynamic content
        const SVG_ICONS = {
            alert: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            lightbulb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>',
            box: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>',
            sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>',
            cloud: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>',
            rain: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>',
            snow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><line x1="8" y1="16" x2="8.01" y2="16"/><line x1="8" y1="20" x2="8.01" y2="20"/><line x1="12" y1="18" x2="12.01" y2="18"/><line x1="12" y1="22" x2="12.01" y2="22"/><line x1="16" y1="16" x2="16.01" y2="16"/><line x1="16" y1="20" x2="16.01" y2="20"/></svg>',
            zap: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
        };

        // Current insight for modal
        let currentInsightId = null;

        // Set today's date
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('cs-CZ', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                // Load data for specific tabs
                if (tab.dataset.tab === 'inbox') loadInsights();
                if (tab.dataset.tab === 'drafts') loadDrafts();
            });
        });

        // ========== INSIGHT INBOX ==========
        async function loadInsights() {
            const status = document.getElementById('filterStatus').value;
            const severity = document.getElementById('filterSeverity').value;
            const type = document.getElementById('filterType').value;
            
            let url = '/api/ai/insights?';
            if (status) url += `status=${status}&`;
            if (severity) url += `severity=${severity}&`;
            if (type) url += `type=${type}&`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                renderInsights(data.insights || []);
                document.getElementById('inboxBadge').textContent = data.total || 0;
            } catch (e) {
                console.error('Error loading insights:', e);
            }
        }

        function renderInsights(insights) {
            const container = document.getElementById('insightsList');
            
            if (!insights.length) {
                container.innerHTML = '<div class="empty-state"><p>Žádné insighty k zobrazení</p></div>';
                return;
            }
            
            container.innerHTML = insights.map(i => `
                <div class="insight-item ${i.severity.toLowerCase()}" onclick="openInsightDetail(${i.id})" style="
                    padding: 16px; margin-bottom: 12px; background: #16213e; border-radius: 12px;
                    border-left: 4px solid ${i.severity === 'CRITICAL' ? '#f87171' : i.severity === 'WARN' ? '#fbbf24' : '#60a5fa'};
                    cursor: pointer; transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #fff; margin-bottom: 4px;">${i.title}</div>
                            <div style="font-size: 13px; color: #a0a0a0;">${i.summary || ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge-${i.severity.toLowerCase()}" style="
                                padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
                                background: ${i.severity === 'CRITICAL' ? 'rgba(248,113,113,0.2)' : i.severity === 'WARN' ? 'rgba(251,191,36,0.2)' : 'rgba(96,165,250,0.2)'};
                                color: ${i.severity === 'CRITICAL' ? '#f87171' : i.severity === 'WARN' ? '#fbbf24' : '#60a5fa'};
                            ">${i.severity}</span>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">${i.type}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function openInsightDetail(id) {
            currentInsightId = id;
            
            try {
                const res = await fetch(`/api/ai/insights/${id}`);
                const insight = await res.json();
                
                document.getElementById('modalTitle').textContent = insight.title;
                document.getElementById('modalSummary').textContent = insight.summary;
                document.getElementById('modalSeverity').innerHTML = `
                    <span style="padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
                        background: ${insight.severity === 'CRITICAL' ? 'rgba(248,113,113,0.2)' : insight.severity === 'WARN' ? 'rgba(251,191,36,0.2)' : 'rgba(96,165,250,0.2)'};
                        color: ${insight.severity === 'CRITICAL' ? '#f87171' : insight.severity === 'WARN' ? '#fbbf24' : '#60a5fa'};">
                        ${insight.severity}
                    </span>
                    <span style="margin-left: 12px; color: #666; font-size: 12px;">Confidence: ${insight.confidence || 'HIGH'}</span>
                `;
                
                // Evidence
                const evidence = insight.evidence || {};
                document.getElementById('modalEvidence').innerHTML = Object.entries(evidence).map(([key, val]) => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2d3748;">
                        <span style="color: #a0a0a0;">${key}</span>
                        <span style="color: #fff; font-weight: 500;">${typeof val === 'object' ? JSON.stringify(val) : val}</span>
                    </div>
                `).join('') || '<p style="color: #666;">Žádné důkazy</p>';
                
                // Actions
                const actions = insight.actions || [];
                document.getElementById('modalActions').innerHTML = actions.map(a => {
                    if (a.type === 'link') {
                        return `<a href="${a.url}" style="padding: 12px 16px; background: #2d3748; border-radius: 8px; color: #fff; text-decoration: none; display: block;">${a.label}</a>`;
                    }
                    return `<button onclick="createDraft(${id}, '${a.type}', ${JSON.stringify(a.payload || {}).replace(/"/g, '&quot;')})" style="
                        padding: 12px 16px; background: #4ade80; border: none; border-radius: 8px; color: #1a1a2e; cursor: pointer; text-align: left; font-weight: 500;
                    ">${a.label}</button>`;
                }).join('') || '<p style="color: #666;">Žádné dostupné akce</p>';
                
                document.getElementById('insightModal').style.display = 'block';
            } catch (e) {
                console.error('Error loading insight detail:', e);
            }
        }

        function closeModal() {
            document.getElementById('insightModal').style.display = 'none';
            currentInsightId = null;
        }

        function snoozeInsight() {
            document.getElementById('snoozeModal').style.display = 'block';
        }

        function closeSnoozeModal() {
            document.getElementById('snoozeModal').style.display = 'none';
        }

        async function snoozeFor(days) {
            if (!currentInsightId) return;
            
            const until = new Date();
            until.setDate(until.getDate() + days);
            
            try {
                await fetch(`/api/ai/insights/${currentInsightId}/snooze`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ until: until.toISOString() })
                });
                closeSnoozeModal();
                closeModal();
                loadInsights();
                loadData();
            } catch (e) {
                console.error('Error snoozing insight:', e);
            }
        }

        function showDismissModal() {
            document.getElementById('dismissModal').style.display = 'block';
        }

        function closeDismissModal() {
            document.getElementById('dismissModal').style.display = 'none';
        }

        async function confirmDismiss() {
            if (!currentInsightId) return;
            
            const reason = document.getElementById('dismissReason').value;
            const note = document.getElementById('dismissNote').value;
            
            try {
                await fetch(`/api/ai/insights/${currentInsightId}/dismiss`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ reason_code: reason, note: note })
                });
                closeDismissModal();
                closeModal();
                loadInsights();
                loadData();
            } catch (e) {
                console.error('Error dismissing insight:', e);
            }
        }

        async function resolveInsight() {
            if (!currentInsightId) return;
            
            try {
                await fetch(`/api/ai/insights/${currentInsightId}/resolve`, { method: 'POST' });
                closeModal();
                loadInsights();
                loadData();
            } catch (e) {
                console.error('Error resolving insight:', e);
            }
        }

        async function createDraft(insightId, actionType, payload) {
            try {
                await fetch('/api/ai/action-drafts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        insight_id: insightId,
                        action_type: actionType,
                        title: `Akce: ${actionType}`,
                        payload: payload || {}
                    })
                });
                alert('Návrh akce vytvořen!');
                loadDrafts();
            } catch (e) {
                console.error('Error creating draft:', e);
            }
        }

        // ========== ACTION DRAFTS ==========
        async function loadDrafts() {
            try {
                const res = await fetch('/api/ai/action-drafts?status=proposed');
                const data = await res.json();
                renderDrafts(data.drafts || []);
                document.getElementById('draftsBadge').textContent = data.total || 0;
                document.getElementById('approvalCount').textContent = data.total || 0;
            } catch (e) {
                console.error('Error loading drafts:', e);
            }
        }

        function renderDrafts(drafts) {
            const container = document.getElementById('draftsList');
            
            if (!drafts.length) {
                container.innerHTML = '<div class="empty-state"><p>Žádné návrhy ke schválení</p></div>';
                return;
            }
            
            container.innerHTML = drafts.map(d => `
                <div class="draft-item" style="
                    padding: 16px; margin-bottom: 12px; background: #16213e; border-radius: 12px;
                    border-left: 4px solid #fbbf24;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #fff; margin-bottom: 4px;">${d.title || d.action_type}</div>
                            <div style="font-size: 13px; color: #a0a0a0;">${d.action_type}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="approveDraft(${d.id})" style="padding: 8px 16px; background: #4ade80; border: none; border-radius: 8px; color: #1a1a2e; cursor: pointer; font-weight: 500;">
                                Schválit
                            </button>
                            <button onclick="rejectDraft(${d.id})" style="padding: 8px 16px; background: #f87171; border: none; border-radius: 8px; color: #fff; cursor: pointer;">
                                Zamítnout
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function approveDraft(id) {
            try {
                await fetch(`/api/ai/action-drafts/${id}/approve`, { method: 'POST' });
                // Execute immediately after approval
                await fetch(`/api/ai/action-drafts/${id}/execute`, { method: 'POST' });
                alert('Akce schválena a provedena!');
                loadDrafts();
                loadData();
            } catch (e) {
                console.error('Error approving draft:', e);
            }
        }

        async function rejectDraft(id) {
            const reason = prompt('Důvod zamítnutí:');
            if (reason === null) return;
            
            try {
                await fetch(`/api/ai/action-drafts/${id}/reject`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ reason: reason })
                });
                loadDrafts();
            } catch (e) {
                console.error('Error rejecting draft:', e);
            }
        }

        // Load all data
        async function loadData() {
            try {
                const dashRes = await fetch('/api/ai/dashboard');
                const data = await dashRes.json();
                renderDashboard(data);
                
                // Update inbox badge
                document.getElementById('inboxBadge').textContent = data.health?.total_open || 0;

                try {
                    const weatherRes = await fetch('/api/ai/weather-forecast');
                    const weatherData = await weatherRes.json();
                    renderForecast(weatherData);
                } catch (e) { console.log('Weather not available'); }
                
                // Load drafts count
                loadDrafts();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('overviewGrid').innerHTML = `
                    <div class="empty-state">
                        ${SVG_ICONS.alert}
                        <p>Nepodařilo se načíst data.</p>
                    </div>
                `;
            }
        }

        function renderDashboard(data) {
            const score = data.score || 0;
            document.getElementById('scoreCircle').style.setProperty('--score', score);
            document.getElementById('scoreNumber').textContent = score;
            
            const scoreDesc = score >= 80 ? 'Výborný stav firmy' :
                             score >= 60 ? 'Dobrý stav s několika varováními' :
                             score >= 40 ? 'Pozor! Několik problémů vyžaduje řešení' :
                             'Kritický stav! Okamžitě řešte problémy';
            document.getElementById('scoreDescription').textContent = scoreDesc;

            // Stats
            const critical = (data.warnings || []).filter(w => w.severity === 'critical').length;
            const warnings = (data.warnings || []).filter(w => w.severity === 'high').length;
            const info = (data.recommendations || []).length;
            
            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('warningsCount').textContent = warnings;
            document.getElementById('infoCount').textContent = info;
            document.getElementById('approvalCount').textContent = data.pending_approvals || 0;

            document.getElementById('overviewBadge').textContent = (data.warnings?.length || 0) + info;
            document.getElementById('weatherBadge').textContent = data.weather_alerts?.length || 0;
            document.getElementById('materialsBadge').textContent = data.material_predictions?.length || 0;

            renderTodayActions(data.today_actions || []);
            renderOverview(data);
            renderMaterials(data.material_predictions || []);
            renderWorkload(data.workload_balance || {});
            renderWeatherAlerts(data.weather_alerts || []);
        }

        function renderTodayActions(actions) {
            const container = document.getElementById('todayList');
            
            if (!actions.length) {
                container.innerHTML = `
                    <div class="today-item ok">
                        <div class="today-icon">${SVG_ICONS.check}</div>
                        <div class="today-content">
                            <div class="today-text">Vše v pořádku</div>
                            <div class="today-detail">Žádné urgentní úkoly</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = actions.map(a => {
                const severity = a.severity || 'medium';
                const icon = severity === 'critical' || severity === 'high' ? SVG_ICONS.alert : 
                            severity === 'ok' ? SVG_ICONS.check : SVG_ICONS.lightbulb;
                const text = a.text || a.title || 'Bez názvu';
                const detail = a.detail || a.summary || '';
                
                return `
                    <div class="today-item ${severity}" onclick="handleAction(${JSON.stringify(a.action || {}).replace(/"/g, '&quot;')})">
                        <div class="today-icon">${icon}</div>
                        <div class="today-content">
                            <div class="today-text">${escapeHtml(text)}</div>
                            <div class="today-detail">${escapeHtml(detail)}</div>
                        </div>
                        ${a.action?.url ? `<button class="today-action" onclick="event.stopPropagation(); window.location.href='${a.action.url}'">${a.action.label || 'Zkontrolovat'}</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderOverview(data) {
            let html = '';

            if (data.warnings?.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${SVG_ICONS.alert} Varování</div>
                            <span class="card-badge badge-critical">${data.warnings.length}</span>
                        </div>
                        <div class="card-content">
                            ${data.warnings.slice(0, 5).map(w => `
                                <div class="alert-item ${w.severity || 'warning'}">
                                    <h4>${escapeHtml(w.title || '')}</h4>
                                    <p>${escapeHtml(w.detail || '')}</p>
                                    ${w.action?.url ? `<div class="recommendation"><a href="${w.action.url}">${w.action.label || 'Zobrazit'}</a></div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (data.recommendations?.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${SVG_ICONS.lightbulb} Doporučení</div>
                            <span class="card-badge badge-info">${data.recommendations.length}</span>
                        </div>
                        <div class="card-content">
                            ${data.recommendations.slice(0, 5).map(r => `
                                <div class="alert-item ${r.priority || 'medium'}">
                                    <h4>${escapeHtml(r.title || '')}</h4>
                                    <p>${escapeHtml(r.detail || r.suggestion || '')}</p>
                                    ${r.action?.url ? `<div class="recommendation"><a href="${r.action.url}">${r.action.label || 'Zobrazit'}</a></div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (!html) {
                html = `<div class="empty-state" style="grid-column: 1/-1">${SVG_ICONS.check}<h3>Vše v pořádku!</h3><p>Momentálně nejsou žádná kritická varování.</p></div>`;
            }

            document.getElementById('overviewGrid').innerHTML = html;
        }

        function renderForecast(forecast) {
            const weatherIcons = { sunny: SVG_ICONS.sun, cloudy: SVG_ICONS.cloud, rain: SVG_ICONS.rain, storm: SVG_ICONS.zap, snow: SVG_ICONS.snow };
            const html = (forecast || []).map(day => {
                const date = new Date(day.date);
                return `
                    <div class="forecast-day ${day.risk_level === 'critical' ? 'risk-critical' : day.risk_level === 'high' ? 'risk-high' : ''}">
                        <div class="forecast-date">${date.toLocaleDateString('cs-CZ', { weekday: 'short' })}<br>${date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' })}</div>
                        <div class="forecast-icon">${weatherIcons[day.condition] || SVG_ICONS.sun}</div>
                        <div class="forecast-temp">${day.temp || day.temperature || '?'}°C</div>
                    </div>
                `;
            }).join('');
            document.getElementById('forecastRow').innerHTML = html || '<div class="empty-state"><p>Předpověď není k dispozici</p></div>';
        }

        function renderWeatherAlerts(alerts) {
            const container = document.getElementById('weatherAlerts');
            if (!alerts.length) {
                container.innerHTML = `<div class="empty-state">${SVG_ICONS.check}<p>Žádné zakázky nejsou ohroženy počasím.</p></div>`;
                return;
            }
            container.innerHTML = alerts.map(a => `
                <div class="alert-item warning">
                    <h4>${escapeHtml(a.client || '')} - ${a.date || ''}</h4>
                    <p>${escapeHtml(a.recommendation || a.message || '')}</p>
                </div>
            `).join('');
        }

        function renderMaterials(materials) {
            const critical = materials.filter(m => m.urgency === 'critical' || (m.current_qty || m.qty || 0) < (m.min_qty || m.minStock || 1));
            document.getElementById('criticalMaterialsBadge').textContent = critical.length;
            
            const criticalHtml = critical.length ? critical.map(m => `
                <div class="material-item">
                    <div class="material-icon">${SVG_ICONS.box}</div>
                    <div class="material-info">
                        <div class="material-name">${escapeHtml(m.name || '')}</div>
                        <div class="material-stock">${m.current_qty || m.qty || 0} ${m.unit || 'ks'} skladem</div>
                    </div>
                    <div class="days-remaining">
                        <div class="days-number" style="color: #f87171">${Math.round(m.days_until_empty || 0)}</div>
                        <div class="days-label">dní do vyčerpání</div>
                    </div>
                </div>
            `).join('') : `<div class="empty-state">${SVG_ICONS.check}<p>Žádný kritický nedostatek</p></div>`;
            document.getElementById('criticalMaterials').innerHTML = criticalHtml;
            
            const orderHtml = materials.length ? materials.map(m => `
                <div class="material-item">
                    <div class="material-icon">${SVG_ICONS.box}</div>
                    <div class="material-info">
                        <div class="material-name">${escapeHtml(m.name || '')}</div>
                        <div class="material-stock">${m.current_qty || m.qty || 0} / ${m.min_qty || m.minStock || '?'} ${m.unit || 'ks'}</div>
                    </div>
                </div>
            `).join('') : '<div class="empty-state"><p>Žádné položky k objednání</p></div>';
            document.getElementById('orderMaterials').innerHTML = orderHtml;
        }

        function renderWorkload(workload) {
            const employees = workload.employees || [];
            if (!employees.length) {
                document.getElementById('workloadChart').innerHTML = '<div class="empty-state"><p>Žádná data o vytížení</p></div>';
                return;
            }
            const maxHours = Math.max(...employees.map(e => e.hours || 0), 45);
            document.getElementById('workloadChart').innerHTML = employees.map(e => {
                const hours = e.hours || 0;
                const percent = (hours / maxHours) * 100;
                const color = hours > 45 ? '#f87171' : hours > 35 ? '#fbbf24' : '#4ade80';
                return `
                    <div class="workload-bar">
                        <div class="workload-name">${escapeHtml(e.name || '')}</div>
                        <div class="workload-track">
                            <div class="workload-fill" style="width: ${percent}%; background: ${color}"></div>
                        </div>
                        <div class="workload-hours">${hours.toFixed(1)}h</div>
                    </div>
                `;
            }).join('');
        }

        function handleAction(action) {
            if (action?.url) window.location.href = action.url;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // =============================================================================
        // NOTIFIKACE
        // =============================================================================
        
        let notificationPanelOpen = false;
        
        async function loadNotificationCount() {
            try {
                const res = await fetch('/api/ai/notifications/unread-count');
                const data = await res.json();
                const badge = document.getElementById('notifBadge');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (e) {
                console.log('Notifications not available');
            }
        }
        
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            notificationPanelOpen = !notificationPanelOpen;
            
            if (notificationPanelOpen) {
                panel.style.display = 'block';
                loadNotifications();
            } else {
                panel.style.display = 'none';
            }
        }
        
        async function loadNotifications() {
            try {
                const res = await fetch('/api/ai/notifications?limit=20');
                const data = await res.json();
                
                const container = document.getElementById('notificationList');
                
                if (!data.notifications || data.notifications.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #666;">
                            ${SVG_ICONS.check}
                            <p style="margin-top: 10px;">Žádné notifikace</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.notifications.map(n => {
                    const isUnread = !n.read_at;
                    const severityColor = n.severity === 'CRITICAL' ? '#f87171' : 
                                         n.severity === 'WARN' ? '#fbbf24' : '#60a5fa';
                    const timeAgo = getTimeAgo(n.created_at);
                    
                    return `
                        <div class="notification-item" onclick="markNotificationRead(${n.id}, ${n.insight_id})" 
                             style="padding: 12px; border-bottom: 1px solid #2d3748; cursor: pointer; 
                                    background: ${isUnread ? '#16213e' : 'transparent'}; 
                                    transition: background 0.2s;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="width: 8px; height: 8px; border-radius: 50%; background: ${severityColor}; margin-top: 6px; flex-shrink: 0;"></div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: ${isUnread ? '600' : '400'}; color: #fff; font-size: 13px; margin-bottom: 4px;">
                                        ${escapeHtml(n.title)}
                                    </div>
                                    <div style="color: #888; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${escapeHtml(n.message || '')}
                                    </div>
                                    <div style="color: #666; font-size: 11px; margin-top: 4px;">${timeAgo}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading notifications:', e);
            }
        }
        
        async function markNotificationRead(notifId, insightId) {
            try {
                await fetch(`/api/ai/notifications/${notifId}/read`, { method: 'POST' });
                loadNotificationCount();
                
                if (insightId) {
                    toggleNotificationPanel();
                    openInsightDetail(insightId);
                }
            } catch (e) {
                console.error('Error marking notification read:', e);
            }
        }
        
        async function markAllNotificationsRead() {
            try {
                await fetch('/api/ai/notifications/read-all', { method: 'POST' });
                loadNotificationCount();
                loadNotifications();
            } catch (e) {
                console.error('Error marking all read:', e);
            }
        }
        
        function getTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'právě teď';
            if (diffMins < 60) return `před ${diffMins} min`;
            if (diffHours < 24) return `před ${diffHours} hod`;
            if (diffDays < 7) return `před ${diffDays} dny`;
            return date.toLocaleDateString('cs-CZ');
        }
        
        // =============================================================================
        // DIGEST
        // =============================================================================
        
        function showDigestModal() {
            document.getElementById('digestModal').style.display = 'flex';
            toggleNotificationPanel();
            loadMorningDigest();
        }
        
        function closeDigestModal() {
            document.getElementById('digestModal').style.display = 'none';
        }
        
        async function loadMorningDigest() {
            const container = document.getElementById('digestContent');
            
            try {
                const res = await fetch('/api/ai/digest/morning');
                const data = await res.json();
                
                let html = `
                    <div style="margin-bottom: 24px;">
                        <h4 style="color: #f87171; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            ${SVG_ICONS.alert}
                            Top prioritní upozornění
                        </h4>
                `;
                
                if (data.top_insights && data.top_insights.length > 0) {
                    html += data.top_insights.map(i => `
                        <div style="background: #16213e; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 3px solid ${i.severity === 'CRITICAL' ? '#f87171' : '#fbbf24'};">
                            <div style="font-weight: 600; color: #fff;">${escapeHtml(i.title)}</div>
                            <div style="color: #888; font-size: 13px; margin-top: 4px;">${escapeHtml(i.summary || '')}</div>
                        </div>
                    `).join('');
                } else {
                    html += '<p style="color: #4ade80;">Žádná kritická upozornění</p>';
                }
                
                html += '</div>';
                
                // Dnešní zakázky
                html += `
                    <div style="margin-bottom: 24px;">
                        <h4 style="color: #60a5fa; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            ${SVG_ICONS.calendar}
                            Dnešní zakázky
                        </h4>
                `;
                
                if (data.todays_jobs && data.todays_jobs.length > 0) {
                    html += data.todays_jobs.map(j => `
                        <div style="background: #16213e; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <a href="/jobs.html?id=${j.id}" style="color: #fff; text-decoration: none; font-weight: 500;">${escapeHtml(j.name || j.client)}</a>
                        </div>
                    `).join('');
                } else {
                    html += '<p style="color: #888;">Žádné naplánované zakázky</p>';
                }
                
                html += '</div>';
                
                // Dnešní úkoly
                html += `
                    <div>
                        <h4 style="color: #4ade80; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            ${SVG_ICONS.check}
                            Dnešní úkoly
                        </h4>
                `;
                
                if (data.todays_tasks && data.todays_tasks.length > 0) {
                    html += data.todays_tasks.map(t => `
                        <div style="background: #16213e; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <span style="color: #fff;">${escapeHtml(t.title)}</span>
                        </div>
                    `).join('');
                } else {
                    html += '<p style="color: #888;">Žádné úkoly na dnes</p>';
                }
                
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = '<p style="color: #f87171;">Nepodařilo se načíst digest</p>';
            }
        }
        
        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notificationPanel');
            const bell = document.querySelector('.notification-bell');
            
            if (notificationPanelOpen && !panel.contains(e.target) && !bell.contains(e.target)) {
                toggleNotificationPanel();
            }
        });
        
        // Load notification count on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadNotificationCount();
            
            // Refresh notification count every 60 seconds
            setInterval(loadNotificationCount, 60000);
        });
    </script>
</body>
</html>
