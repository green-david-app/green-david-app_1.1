<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sklad - Green David</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <link rel="stylesheet" href="/static/css/app.css"/>
  <script src="/app-settings.js"></script>
</head>
<body>
  <div id="app-header"></div>

  <div class="warehouse-page">
    <h1 style="display:flex;align-items:center;gap:12px;">
      <svg style="width:32px;height:32px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
        <line x1="3" y1="6" x2="21" y2="6"/>
        <path d="M16 10a4 4 0 01-8 0"/>
      </svg>
      Sklad
    </h1>
    <div class="header-actions">
      <button class="btn-secondary" onclick="exportData()">
        <svg style="width:18px;height:18px;stroke:#B2FBA5;display:inline-block;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export
      </button>
      <button class="btn-primary" onclick="openNewItemModal()">+ Nov√° polo≈æka</button>
    </div>
  </div>

  <!-- Statistics -->
  <div class="warehouse-stats">
    <div class="stat-box">
      <div class="stat-number" id="statTotalValue">0 Kƒç</div>
      <div class="stat-label">Celkov√° hodnota</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="statTotalItems">0</div>
      <div class="stat-label">Celkem polo≈æek</div>
    </div>
    <div class="stat-box warning">
      <div class="stat-number" id="statLowStock">0</div>
      <div class="stat-label" style="display:flex;align-items:center;gap:6px;">
        <svg style="width:16px;height:16px;stroke:#fb923c" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        N√≠zk√Ω stav
      </div>
    </div>
    <div class="stat-box danger">
      <div class="stat-number" id="statOutOfStock">0</div>
      <div class="stat-label" style="display:flex;align-items:center;gap:6px;">
        <svg style="width:16px;height:16px;stroke:#f87171" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Nedostupn√©
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input type="search" id="searchInput" placeholder="Hledat polo≈æky..." oninput="filterItems()">
    </div>
    <select class="filter-select" id="filterCategory" onchange="filterItems()">
      <option value="">V≈°echny kategorie</option>
      <option value="substr√°t">Substr√°t</option>
      <option value="hnojivo">Hnojivo</option>
      <option value="mulƒç">Mulƒç</option>
      <option value="rostliny">Rostliny</option>
      <option value="n√°≈ôad√≠">N√°≈ôad√≠</option>
      <option value="ostatn√≠">Ostatn√≠</option>
    </select>
    <select class="filter-select" id="filterStatus" onchange="filterItems()">
      <option value="">V≈°echny stavy</option>
      <option value="in_stock">Skladem</option>
      <option value="low_stock">M√°lo</option>
      <option value="out_of_stock">Nedostupn√©</option>
    </select>
  </div>

  <!-- Inventory Table -->
  <div class="inventory-table">
    <div class="table-header">
      <div>Polo≈æka</div>
      <div>Kategorie</div>
      <div>Mno≈æstv√≠</div>
      <div>Jednotka</div>
      <div>Cena/j</div>
      <div>Status</div>
      <div>Akce</div>
    </div>
    <div id="itemsList"></div>
  </div>

  <!-- Movement History -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:24px;margin-top:24px;">
    <div class="history-section">
      <div class="section-header">
        <h3>üìú Historie pohyb≈Ø</h3>
        <button class="btn-secondary" style="padding:6px 12px;font-size:12px;" onclick="clearHistory()">Vymazat</button>
      </div>
      <div id="historyList"></div>
    </div>

    <div class="history-section">
      <div class="section-header">
        <h3>‚≠ê Nejpou≈æ√≠vanƒõj≈°√≠ polo≈æky</h3>
      </div>
      <div id="topItemsList" class="top-items-list"></div>
    </div>
  </div>

  <!-- New Item Modal -->
  <div class="item-modal" id="itemModal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Nov√° polo≈æka</h2>
        <button class="close-modal" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>N√°zev *</label>
          <input type="text" id="itemName" required placeholder="Substr√°t univerz√°ln√≠">
        </div>
        <div class="form-group">
          <label>Kategorie</label>
          <select id="itemCategory">
            <option value="substr√°t">Substr√°t</option>
            <option value="hnojivo">Hnojivo</option>
            <option value="mulƒç">Mulƒç</option>
            <option value="rostliny">Rostliny</option>
            <option value="n√°≈ôad√≠">N√°≈ôad√≠</option>
            <option value="ostatn√≠">Ostatn√≠</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mno≈æstv√≠ *</label>
          <input type="number" id="itemQuantity" required value="0" min="0" step="0.1">
        </div>
        <div class="form-group">
          <label>Jednotka *</label>
          <select id="itemUnit">
            <option value="ks">ks</option>
            <option value="kg">kg</option>
            <option value="L">L</option>
            <option value="m3">m¬≥</option>
            <option value="balen√≠">balen√≠</option>
          </select>
        </div>
        <div class="form-group">
          <label>Cena za jednotku (Kƒç)</label>
          <input type="number" id="itemPrice" step="0.01" placeholder="50">
        </div>
        <div class="form-group">
          <label>Minim√°ln√≠ stav (alert)</label>
          <input type="number" id="itemMinStock" value="10" min="0" step="0.1">
        </div>
        <div class="form-group">
          <label>Dodavatel</label>
          <input type="text" id="itemSupplier" placeholder="Zahradnictv√≠ XY">
        </div>
        <div class="form-group">
          <label>Lokace skladu</label>
          <input type="text" id="itemLocation" placeholder="Sklad A, police 3">
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;padding:20px;border-top:1px solid var(--border-primary);">
        <button class="btn-secondary" onclick="closeModal()">Zav≈ô√≠t</button>
        <button class="btn-primary" onclick="saveItem()">Ulo≈æit</button>
      </div>
    </div>
  </div>

  <!-- Movement Modal (P≈ô√≠jem/Spot≈ôeba) -->
  <div class="item-modal" id="movementModal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="movementTitle">P≈ô√≠jem materi√°lu</h2>
        <button class="close-modal" onclick="closeMovementModal()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="movementItemId">
        <input type="hidden" id="movementType">
        <div class="form-group">
          <label>Polo≈æka</label>
          <input type="text" id="movementItemName" readonly style="background:#1a2027;">
        </div>
        <div class="form-group">
          <label>Mno≈æstv√≠ *</label>
          <input type="number" id="movementQuantity" required step="0.1" min="0.1">
        </div>
        <div class="form-group">
          <label>Cena za jednotku (Kƒç)</label>
          <input type="number" id="movementPrice" step="0.01">
        </div>
        <div class="form-group" id="jobField" style="display:none;">
          <label>Zak√°zka (spot≈ôeba)</label>
          <select id="movementJob">
            <option value="">-- Vyberte zak√°zku --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Datum</label>
          <input type="date" id="movementDate">
        </div>
        <div class="form-group">
          <label>Pozn√°mka</label>
          <input type="text" id="movementNotes" placeholder="Dod√°vka od XY">
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;padding:20px;border-top:1px solid var(--border-primary);">
        <button class="btn-secondary" onclick="closeMovementModal()">Zav≈ô√≠t</button>
        <button class="btn-primary" id="submitMovement" onclick="submitMovement()">Potvrdit</button>
      </div>
    </div>
  </div>

  <div id="bottom-nav"></div>
  <script src="/static/bottom-nav.js"></script>
  <script src="/static/app-header.js"></script>
  <script src="/static/navigation.js"></script>
  <script src="/static/toast.js"></script>
  <script src="/static/loading.js"></script>

  <script>
    let items = [];
    let history = [];
    let allJobs = [];
    let currentEditId = null;

    async function loadData() {
      try {
        // Load materials from new unified API
        const [matsResp, jobsResp] = await Promise.all([
          fetch('/api/materials'),
          fetch('/api/jobs')
        ]);
        
        const matsData = await matsResp.json();
        const jobsData = await jobsResp.json();
        
        if (matsData.success) {
          items = matsData.materials || [];
        }
        
        allJobs = jobsData || [];
        
        // Load history
        const histResp = await fetch('/api/materials/movements');
        if (histResp.ok) {
          const histData = await histResp.json();
          history = histData.movements || [];
        }
        
        renderItems();
        updateStats();
        renderHistory();
        renderTopItems();
      } catch (error) {
        console.error('Error loading:', error);
        // Fallback to localStorage
        const stored = localStorage.getItem('warehouse_items');
        items = stored ? JSON.parse(stored) : [];
        renderItems();
        updateStats();
      }
    }

    function renderItems() {
      const list = document.getElementById('itemsList');
      if (items.length === 0) {
        list.innerHTML = '<div style="padding:40px;text-align:center;color:#6b7580;">≈Ω√°dn√© polo≈æky. P≈ôidej prvn√≠!</div>';
        return;
      }

      let html = '';
      items.forEach(item => {
        const status = getStatus(item);
        const statusClass = status === 'out_of_stock' ? 'danger' : status === 'low_stock' ? 'warning' : 'success';
        const statusText = status === 'out_of_stock' ? 'Nedostupn√©' : status === 'low_stock' ? 'N√≠zk√Ω stav' : 'Skladem';
        
        html += `<div class="table-row">`;
        html += `<div><strong>${item.name}</strong></div>`;
        html += `<div><span class="badge">${item.category || '-'}</span></div>`;
        html += `<div><strong>${item.current_stock}</strong></div>`;
        html += `<div>${item.unit}</div>`;
        html += `<div>${item.unit_price ? item.unit_price + ' Kƒç' : '-'}</div>`;
        html += `<div><span class="badge badge-${statusClass}">${statusText}</span></div>`;
        html += `<div class="action-buttons">`;
        html += `<button class="btn-sm btn-success" onclick="openMovementModal(${item.id}, 'in')" title="P≈ô√≠jem">‚ûï</button>`;
        html += `<button class="btn-sm btn-danger" onclick="openMovementModal(${item.id}, 'out')" title="Spot≈ôeba">‚ûñ</button>`;
        html += `<button class="btn-sm btn-secondary" onclick="editItem(${item.id})">‚úèÔ∏è</button>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      list.innerHTML = html;
    }

    function getStatus(item) {
      if (item.current_stock === 0) return 'out_of_stock';
      if (item.current_stock < item.min_stock) return 'low_stock';
      return 'in_stock';
    }

    function updateStats() {
      const totalValue = items.reduce((sum, item) => sum + (item.current_stock * (item.unit_price || 0)), 0);
      const lowStock = items.filter(item => item.current_stock > 0 && item.current_stock < item.min_stock).length;
      const outOfStock = items.filter(item => item.current_stock === 0).length;
      
      document.getElementById('statTotalValue').textContent = Math.round(totalValue).toLocaleString('cs-CZ') + ' Kƒç';
      document.getElementById('statTotalItems').textContent = items.length;
      document.getElementById('statLowStock').textContent = lowStock;
      document.getElementById('statOutOfStock').textContent = outOfStock;
    }

    function filterItems() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('filterCategory').value;
      const status = document.getElementById('filterStatus').value;
      
      const list = document.getElementById('itemsList');
      const rows = list.querySelectorAll('.table-row');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchSearch = text.includes(search);
        const matchCategory = !category || row.querySelector('.badge')?.textContent === category;
        
        let matchStatus = true;
        if (status) {
          const itemStatus = row.querySelector('.badge-success, .badge-warning, .badge-danger');
          if (status === 'in_stock') matchStatus = itemStatus?.classList.contains('badge-success');
          if (status === 'low_stock') matchStatus = itemStatus?.classList.contains('badge-warning');
          if (status === 'out_of_stock') matchStatus = itemStatus?.classList.contains('badge-danger');
        }
        
        row.style.display = matchSearch && matchCategory && matchStatus ? '' : 'none';
      });
    }

    function openNewItemModal() {
      document.getElementById('modalTitle').textContent = 'Nov√° polo≈æka';
      currentEditId = null;
      document.getElementById('itemModal').style.display = 'flex';
      clearForm();
    }

    function editItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;
      
      document.getElementById('modalTitle').textContent = 'Upravit polo≈æku';
      currentEditId = id;
      
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemCategory').value = item.category || '';
      document.getElementById('itemQuantity').value = item.current_stock;
      document.getElementById('itemUnit').value = item.unit;
      document.getElementById('itemPrice').value = item.unit_price || '';
      document.getElementById('itemMinStock').value = item.min_stock;
      document.getElementById('itemSupplier').value = item.supplier || '';
      document.getElementById('itemLocation').value = item.location || '';
      
      document.getElementById('itemModal').style.display = 'flex';
    }

    function clearForm() {
      document.getElementById('itemName').value = '';
      document.getElementById('itemCategory').value = 'substr√°t';
      document.getElementById('itemQuantity').value = '0';
      document.getElementById('itemUnit').value = 'ks';
      document.getElementById('itemPrice').value = '';
      document.getElementById('itemMinStock').value = '10';
      document.getElementById('itemSupplier').value = '';
      document.getElementById('itemLocation').value = '';
    }

    async function saveItem() {
      const data = {
        name: document.getElementById('itemName').value,
        category: document.getElementById('itemCategory').value,
        current_stock: parseFloat(document.getElementById('itemQuantity').value),
        unit: document.getElementById('itemUnit').value,
        unit_price: parseFloat(document.getElementById('itemPrice').value) || null,
        min_stock: parseFloat(document.getElementById('itemMinStock').value) || 0,
        supplier: document.getElementById('itemSupplier').value || null,
        location: document.getElementById('itemLocation').value || null
      };

      try {
        const url = currentEditId ? `/api/materials/${currentEditId}` : '/api/materials';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
          showToast(currentEditId ? 'Polo≈æka upravena!' : 'Polo≈æka p≈ôid√°na!', 'success');
          closeModal();
          loadData();
        } else {
          showToast('Chyba: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Chyba: ' + error, 'error');
      }
    }

    function openMovementModal(itemId, type) {
      const item = items.find(i => i.id === itemId);
      if (!item) return;
      
      document.getElementById('movementItemId').value = itemId;
      document.getElementById('movementType').value = type;
      document.getElementById('movementItemName').value = item.name;
      document.getElementById('movementTitle').textContent = type === 'in' ? 'P≈ô√≠jem materi√°lu' : 'Spot≈ôeba materi√°lu';
      document.getElementById('movementDate').valueAsDate = new Date();
      document.getElementById('jobField').style.display = type === 'out' ? 'block' : 'none';
      
      // Load jobs
      const jobSelect = document.getElementById('movementJob');
      jobSelect.innerHTML = '<option value="">-- Vyberte zak√°zku --</option>';
      allJobs.forEach(j => {
        jobSelect.innerHTML += `<option value="${j.id}">${j.name}</option>`;
      });
      
      document.getElementById('movementModal').style.display = 'flex';
    }

    async function submitMovement() {
      const data = {
        material_id: parseInt(document.getElementById('movementItemId').value),
        movement_type: document.getElementById('movementType').value,
        quantity: parseFloat(document.getElementById('movementQuantity').value),
        unit_price: parseFloat(document.getElementById('movementPrice').value) || null,
        movement_date: document.getElementById('movementDate').value,
        notes: document.getElementById('movementNotes').value || null
      };

      if (data.movement_type === 'out') {
        const jobId = document.getElementById('movementJob').value;
        if (jobId) data.job_id = parseInt(jobId);
      }

      if (data.unit_price) data.total_price = data.quantity * data.unit_price;

      try {
        const response = await fetch('/api/materials/movement', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
          showToast(data.movement_type === 'in' ? 'P≈ô√≠jem zaznamen√°n!' : 'Spot≈ôeba zaznamen√°na!', 'success');
          closeMovementModal();
          loadData();
        } else {
          showToast('Chyba: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Chyba: ' + error, 'error');
      }
    }

    function closeModal() {
      document.getElementById('itemModal').style.display = 'none';
      clearForm();
      currentEditId = null;
    }

    function closeMovementModal() {
      document.getElementById('movementModal').style.display = 'none';
      document.getElementById('movementQuantity').value = '';
      document.getElementById('movementPrice').value = '';
      document.getElementById('movementNotes').value = '';
    }

    function renderHistory() {
      const list = document.getElementById('historyList');
      if (history.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#6b7580;font-size:13px;">Zat√≠m ≈æ√°dn√° historie</div>';
        return;
      }
      
      let html = '';
      history.slice(0, 10).forEach(h => {
        const icon = h.movement_type === 'in' ? '‚ûï' : '‚ûñ';
        const color = h.movement_type === 'in' ? '#B2FBA5' : '#f87171';
        html += `<div style="padding:12px;border-bottom:1px solid var(--border-primary);font-size:13px;">`;
        html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">`;
        html += `<span style="color:${color}">${icon}</span>`;
        html += `<strong>${h.material_name || 'Materi√°l'}</strong>`;
        html += `<span style="margin-left:auto;color:#6b7580;">${h.quantity} ${h.unit}</span>`;
        html += `</div>`;
        if (h.job_name) html += `<div style="color:#6b7580;font-size:12px;">üìã ${h.job_name}</div>`;
        html += `<div style="color:#6b7580;font-size:11px;">${h.movement_date}</div>`;
        html += `</div>`;
      });
      list.innerHTML = html;
    }

    function renderTopItems() {
      const list = document.getElementById('topItemsList');
      const topItems = items.filter(i => i.current_stock > 0).sort((a,b) => b.current_stock - a.current_stock).slice(0, 5);
      
      if (topItems.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#6b7580;font-size:13px;">Zat√≠m ≈æ√°dn√© polo≈æky</div>';
        return;
      }
      
      let html = '';
      topItems.forEach((item, idx) => {
        html += `<div style="display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--border-primary);">`;
        html += `<div style="font-size:20px;font-weight:700;color:#6b7580;min-width:24px;">#${idx+1}</div>`;
        html += `<div style="flex:1;">`;
        html += `<div style="font-weight:600;font-size:14px;">${item.name}</div>`;
        html += `<div style="font-size:12px;color:#6b7580;">${item.current_stock} ${item.unit}</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      list.innerHTML = html;
    }

    function clearHistory() {
      if (!confirm('Opravdu smazat celou historii?')) return;
      history = [];
      localStorage.removeItem('warehouse_history');
      renderHistory();
    }

    function exportData() {
      let csv = 'N√°zev,Kategorie,Mno≈æstv√≠,Jednotka,Cena/j,Min stav,Dodavatel,Lokace\n';
      items.forEach(item => {
        csv += `"${item.name}","${item.category || ''}",${item.current_stock},"${item.unit}",${item.unit_price || ''},${item.min_stock},"${item.supplier || ''}","${item.location || ''}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sklad_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function showToast(message, type) {
      if (window.showToast) {
        window.showToast(message, type);
      } else {
        alert(message);
      }
    }

    // Close modals on outside click
    document.getElementById('itemModal').addEventListener('click', (e) => {
      if (e.target.id === 'itemModal') closeModal();
    });
    document.getElementById('movementModal').addEventListener('click', (e) => {
      if (e.target.id === 'movementModal') closeMovementModal();
    });

    loadData();
  </script>
</body>
</html>
