<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Kalendář — green david app</title>
  <link rel="icon" href="/logo.svg">
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{
      --gd-bg: #eaf4ef;
      --gd-card: #0f1f1a;
      --gd-ink: #dfe9e4;
      --gd-accent: #6bd08c;
      --gd-accent-2: #b78bf6;
      --gd-danger: #ff6b6b;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body{
      margin:0;
      background: var(--gd-bg);
      color:#111;
      -webkit-font-smoothing: antialiased;
      font-family: system-ui, -apple-system, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    }
    .header-hero{
      position: sticky; top: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0));
      backdrop-filter: saturate(140%) blur(10px);
      padding: calc(10px + var(--safe-top)) 16px 12px;
      z-index:10;
    }
    .hero-row{ display:flex; align-items:center; gap:12px; }
    .logo{ width:36px; height:36px; border-radius:10px; background:#dff1e7 url('/logo.svg') center/70% no-repeat; flex:0 0 auto; }
    .h1{ font-weight:800; font-size: clamp(22px, 6vw, 34px); line-height:1.05; }
    .sub{ color:#667; font-size:12px; }
    .back{ color:#0a6040; text-decoration:none; font-weight:600; }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px; }
    .toolbar .month{
      font-size: clamp(22px,5.5vw,28px); font-weight:800;
      letter-spacing: -0.3px;
    }
    .navbtn{
      border:0; background:#0a6040; color:white; padding:10px 12px; border-radius:14px; font-weight:700;
    }
    .navbtn.ghost{ background:transparent; color:#0a6040; border:2px solid #0a6040; }
    .grid-wrap{ padding: 6px 10px 20px; }
    .weekday{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; padding: 0 2px 6px; color:#4d635a; font-weight:700; }
    .weekday span{ text-align:center; font-size:12px; }
    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .day{
      position:relative;
      background:#1a2a23;
      border-radius:18px;
      min-height: 74px;
      padding:10px 8px 8px;
      color: var(--gd-ink);
      box-shadow: 0 1px 0 rgba(0,0,0,.07) inset;
    }
    .day.out{ opacity:.35; }
    .num{ font-weight:800; font-size: 14px; opacity:.95; }
    .badge-dot{ display:inline-block; width:7px; height:7px; border-radius:50%; margin-right:5px; vertical-align:middle; }
    .events{ margin-top:6px; display:flex; flex-direction:column; gap:4px; }
    .chip{
      display:inline-flex; align-items:center; max-width:100%;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
      background:#24362f; color:var(--gd-ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      border:1px solid rgba(255,255,255,.08);
    }
    .chip .t{ overflow:hidden; text-overflow:ellipsis; }
    .chip.green{ border-color:#4ed296; }
    .chip.purple{ border-color:#b78bf6; }
    .chip.blue{ border-color:#7cc5ff; }
    .chip.orange{ border-color:#ffb86b; }
    .today{ outline:2px solid var(--gd-accent); outline-offset:-2px; }
    .legend{ display:flex; gap:10px; align-items:center; padding:8px 10px; color:#4d635a; }
    .legend .item{ display:flex; align-items:center; gap:6px; font-size:12px; }
    /* Desktop tweaks */
    @media (min-width: 800px){
      .grid-wrap{ max-width: 1000px; margin: 0 auto; }
      .day{ min-height: 120px; padding:12px; border-radius:20px; }
      .num{ font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="header-hero">
    <div class="hero-row">
      <a class="back" href="/">&larr; Zpět do aplikace</a>
    </div>
    <div class="toolbar">
      <button class="navbtn ghost" id="prevBtn">&#x25C0;</button>
      <div class="month" id="monthLabel">Měsíc</div>
      <button class="navbtn" id="nextBtn">&#x25B6;</button>
    </div>
  </div>

  <div class="grid-wrap">
    <div class="weekday"><span>P</span><span>Ú</span><span>S</span><span>Č</span><span>P</span><span>S</span><span>N</span></div>
    <div id="cal" class="cal" aria-live="polite"></div>
    <div class="legend">
      <div class="item"><span class="badge-dot" style="background:#4ed296"></span> zakázky</div>
      <div class="item"><span class="badge-dot" style="background:#b78bf6"></span> připomínky</div>
      <div class="item"><span class="badge-dot" style="background:#7cc5ff"></span> ostatní</div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const monthLabel = $('#monthLabel');
    const cal = $('#cal');
    const state = { d: new Date() };

    function fmtMonth(d){
      return d.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' })
              .replace(/^./, c => c.toUpperCase());
    }
    function ymd(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function mondayOfWeek(d){
      const copy = new Date(d); const wd = (copy.getDay()+6)%7; // 0=Mon
      copy.setDate(copy.getDate() - wd); return copy;
    }
    function monthStart(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function monthEnd(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

    async function fetchEvents(d){
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      try{
        const res = await fetch(`/api/calendar?month=${ym}`, {credentials:"same-origin"});
        if(!res.ok) throw new Error(res.statusText);
        const j = await res.json();
        return (j.events||[]).map(e => ({
          id: e.id,
          title: e.title || e.name || 'bez názvu',
          start: e.start || e.date_start || e.date || e.when,
          end: e.end || e.date_end || e.until || e.start,
          type: e.type || 'other' // 'job'|'reminder'|'other'
        }));
      }catch(e){
        // Graceful fallback: no events
        return [];
      }
    }

    function render(d, events){
      monthLabel.textContent = fmtMonth(d);
      cal.innerHTML = '';
      const start = monthStart(d);
      const end = monthEnd(d);
      const from = mondayOfWeek(start);
      const to = new Date(mondayOfWeek(new Date(end.getFullYear(), end.getMonth(), end.getDate()+6)));
      const today = new Date(); today.setHours(0,0,0,0);

      // Index events by day
      const byDay = {};
      function spread(e){
        const s = new Date(e.start); const eEnd = new Date(e.end || e.start);
        s.setHours(0,0,0,0); eEnd.setHours(0,0,0,0);
        for(let t=new Date(s); t<=eEnd; t.setDate(t.getDate()+1)){
          const key = ymd(t);
          (byDay[key] = byDay[key] || []).push(e);
        }
      }
      events.forEach(spread);

      for(let dt = new Date(from); dt <= to; dt.setDate(dt.getDate()+1)){
        const key = ymd(dt);
        const div = document.createElement('div');
        div.className = 'day' + (dt.getMonth()!==d.getMonth() ? ' out' : '');
        if(+dt === +today) div.classList.add('today');
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = dt.getDate();
        div.appendChild(num);

        const evs = (byDay[key]||[]);
        if(evs.length){
          const wrap = document.createElement('div'); wrap.className='events';
          evs.slice(0,3).forEach(e => {
            const chip = document.createElement('div');
            chip.className = 'chip ' + (e.type==='job' ? 'green' : e.type==='reminder' ? 'purple' : 'blue');
            const t = document.createElement('span'); t.className='t'; t.textContent = e.title;
            chip.appendChild(t);
            wrap.appendChild(chip);
          });
          if(evs.length>3){
            const more = document.createElement('div'); more.className='chip orange'; more.textContent = `+${evs.length-3} další`;
            wrap.appendChild(more);
          }
          div.appendChild(wrap);
        }

        cal.appendChild(div);
      }
    }

    async function load(){
      const events = await fetchEvents(state.d);
      render(state.d, events);
    }

    $('#prevBtn').addEventListener('click', ()=>{ state.d = new Date(state.d.getFullYear(), state.d.getMonth()-1, 1); load(); });
    $('#nextBtn').addEventListener('click', ()=>{ state.d = new Date(state.d.getFullYear(), state.d.getMonth()+1, 1); load(); });

    load();
  </script>
</body>
</html>
