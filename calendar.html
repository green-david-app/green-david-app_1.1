<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalendář</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#0f1717; color:#e7f2ef}
    .page{max-width:1200px; margin:0 auto; padding:24px}
    .toolbar{display:flex; gap:12px; align-items:center}
    .btn{background:#134e4a; border:none; color:#e7f2ef; padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn.ghost{background:#0f1717; outline:1px solid #134e4a}
    h1{font-size:40px; font-weight:800; margin:20px 0}
    .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:16px}
    .day{background:#071112; border-radius:22px; min-height:120px; padding:10px; position:relative}
    .day.muted{background:#2a3434; color:#a9b8b3}
    .day h3{margin:0 0 6px 0; font-size:14px; font-weight:700; opacity:.9}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#042f2e; margin:4px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%}
    dialog{border:none; border-radius:16px; max-width:1024px; width:96vw; background:#0a1616; color:#e7f2ef}
    dialog .head{display:flex; gap:8px; align-items:center; padding:12px 16px}
    dialog .tabs{display:flex; gap:8px; padding:0 16px 8px}
    dialog .tabs button{flex:1; padding:10px; border-radius:10px; border:1px solid #134e4a; background:#0f1717; color:#aee}
    dialog .tabs button.active{background:#0e3b39}
    dialog form{display:grid; gap:10px; padding:0 16px 16px}
    input, select, textarea{width:100%; padding:10px; border-radius:10px; border:1px solid #264c4a; background:#0f1717; color:#e7f2ef}
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row-actions{display:flex; gap:8px; padding:8px 16px 16px}
    .toast{position:fixed; left:16px; right:16px; bottom:16px; background:#330b0b; color:#ffd9d9; border:1px solid #5f1b1b; padding:8px 12px; border-radius:12px; display:none}
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <a href="/" class="btn ghost">← Zpět do aplikace</a>
      <div style="flex:1"></div>
      <button class="btn" id="prevBtn">‹</button>
      <button class="btn ghost" id="todayBtn">Dnes</button>
      <button class="btn" id="nextBtn">›</button>
    </div>
    <h1 id="monthTitle">Měsíc</h1>
    <div class="grid" id="monthGrid" aria-live="polite"></div>
  </div>

  <dialog id="dayDlg">
    <div class="head">
      <span id="dlgBadge" class="pill">ostatní</span>
      <strong id="dlgTitle" style="font-size:18px">—</strong>
      <div style="flex:1"></div>
      <button class="btn ghost" id="btnDetail">Detail</button>
      <button class="btn" id="btnEdit">Upravit</button>
      <button class="btn" id="btnDelete">Smazat</button>
    </div>

    <div class="tabs">
      <button type="button" class="" data-tab="zakazka">Zakázka</button>
      <button type="button" class="" data-tab="ukol">Úkol</button>
      <button type="button" class="active" data-tab="poznamka">Poznámka</button>
    </div>

    <form id="taskForm">
      <input type="hidden" name="id"/>
      <input type="hidden" name="date"/>
      <div class="form-row">
        <input name="title" placeholder="Název / text*" required />
        <input name="code" placeholder="Kód (např. 2025-091)"/>
      </div>
      <div class="form-row">
        <select name="plan">
          <option value="">Plán</option>
          <option>Plán</option>
          <option>Hotovo</option>
        </select>
        <input name="city" placeholder="Město"/>
      </div>
      <textarea name="note" placeholder="Poznámka"></textarea>
      <div class="row-actions">
        <button type="button" class="btn ghost" id="btnCancel">Zrušit</button>
        <div style="flex:1"></div>
        <button type="submit" class="btn" id="btnSave">Uložit</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast"></div>

<script>
(() => {
  // ---- Utilities ----------------------------------------------------------
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];
  const toast = (msg) => { const t=$("#toast"); t.textContent = msg; t.style.display="block"; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display="none", 5000); }
  window.addEventListener("error", (e) => toast(String(e.error || e.message || e.filename+':'+e.lineno+':'+e.colno)) );

  const fmtMonth = (d) => d.toLocaleDateString('cs-CZ', { year:'numeric', month:'long' });
  const ymStr = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  const ymd = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

  // GET calendar prefers /gd/api, falls back to /api
  async function getCalendar(year, month){
    const monthStr = `${year}-${String(month).padStart(2,'0')}`;
    try {
      const r = await fetch(`/gd/api/calendar?month=${monthStr}`);
      if (!r.ok) throw new Error('gd fail');
      return await r.json();
    } catch {
      const r2 = await fetch(`/api/calendar?month=${monthStr}`);
      if (!r2.ok) throw new Error('calendar GET failed');
      return await r2.json();
    }
  }

  // Mutations go straight to /api to avoid 405 on /gd
  const api = {
    async listTasks(){
      const r = await fetch(`/api/tasks`);
      if(!r.ok) throw new Error('GET /api/tasks failed');
      return await r.json();
    },
    async saveTask(payload){
      const r = await fetch(`/api/tasks`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      if(!r.ok) throw new Error('POST /api/tasks failed');
      return await r.json().catch(()=>({ok:true}));
    },
    async deleteTask(id){
      const r = await fetch(`/api/tasks?id=${encodeURIComponent(id)}`, { method:'DELETE' });
      if(!r.ok) throw new Error('DELETE /api/tasks failed');
      return true;
    }
  };

  // ---- Month rendering ----------------------------------------------------
  let current = new Date();
  let monthData = null;        // structure returned from calendar API
  let tasksCache = [];         // list from /api/tasks for detail/edit

  async function refreshAll(){
    $("#monthTitle").textContent = fmtMonth(current);
    const y = current.getFullYear();
    const m = current.getMonth()+1;
    monthData = await getCalendar(y,m);
    tasksCache = await api.listTasks().catch(()=>[]);
    renderMonth();
  }

  function renderMonth(){
    const grid = $("#monthGrid");
    grid.innerHTML = "";
    const days = monthData?.days || monthData || []; // tolerate different shapes
    for(const day of days){
      const box = document.createElement("div");
      box.className = "day" + (day.outside ? " muted": "");
      box.dataset.date = day.date || day.day || day.d; // accept various keys
      const dnum = (day.date || day.day || day.d || "").split("-").pop() || "";
      box.innerHTML = `<h3>${dnum}</h3>`;

      const items = (day.items || day.events || day.tasks || []);
      for(const it of items){
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "pill";
        pill.textContent = it.title || it.name || it.text || "(bez názvu)";
        pill.addEventListener("click", () => openDay(it, box.dataset.date));
        box.appendChild(pill);
      }

      // click empty to add note quickly
      box.addEventListener("dblclick", () => openDay({type:'note', title:'', id:null}, box.dataset.date));
      grid.appendChild(box);
    }
  }

  // ---- Day dialog ---------------------------------------------------------
  const dlg = $("#dayDlg");
  const form = $("#taskForm");

  function setActiveTab(tab){
    $$(".tabs button").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  }

  function fillForm(task, dateStr){
    form.reset();
    form.elements.id.value = task?.id || "";
    form.elements.date.value = dateStr || task?.date || "";
    form.elements.title.value = task?.title || task?.name || task?.text || "";
    form.elements.code.value = task?.code || "";
    form.elements.plan.value = task?.plan || "";
    form.elements.city.value = task?.city || "";
    form.elements.note.value = task?.note || "";
  }

  async function openDay(task, dateStr){
    const t = task || {};
    $("#dlgBadge").textContent = (t.type || 'ostatní');
    $("#dlgTitle").textContent = (t.title || t.name || t.text || "—");
    setActiveTab((t.type==='job'?'zakazka': t.type==='task'?'ukol':'poznamka'));
    fillForm(t, dateStr);
    dlg.showModal();
  }

  // Buttons in header
  $("#btnDetail").addEventListener("click", async () => {
    try {
      const id = form.elements.id.value;
      if(!id){ toast("Není vybraná položka."); return; }
      const full = tasksCache.find(x => String(x.id)===String(id));
      if(!full){ toast("Položka nenalezena v seznamu."); return; }
      alert(JSON.stringify(full, null, 2));
    } catch (e) { toast(String(e.message||e)); }
  });

  $("#btnEdit").addEventListener("click", async () => {
    try {
      // nothing special; the form is already editable
      form.elements.title.focus();
    } catch (e) { toast(String(e.message||e)); }
  });

  $("#btnDelete").addEventListener("click", async () => {
    try {
      const id = form.elements.id.value;
      if(!id){ toast("Tahle položka zatím neexistuje (nemá ID)."); return; }
      if(!confirm("Opravdu smazat?")) return;
      await api.deleteTask(id);
      dlg.close();
      await refreshAll();
    } catch (e) { toast(String(e.message||e)); }
  });

  $("#btnCancel").addEventListener("click", () => dlg.close());

  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    try {
      const payload = {
        id: form.elements.id.value || undefined,
        date: form.elements.date.value || ymd(current),
        title: form.elements.title.value,
        code: form.elements.code.value || null,
        plan: form.elements.plan.value || null,
        city: form.elements.city.value || null,
        note: form.elements.note.value || null,
        type: $$(".tabs button.active")[0]?.dataset.tab === "zakazka" ? "job" :
              $$(".tabs button.active")[0]?.dataset.tab === "ukol" ? "task" : "note"
      };
      await api.saveTask(payload);
      dlg.close();
      await refreshAll();
    } catch (e) { toast(String(e.message||e)); }
  });

  $$(".tabs button").forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));

  // ---- Month navigation ---------------------------------------------------
  $("#todayBtn").addEventListener("click", async () => { current = new Date(); await refreshAll(); });
  $("#prevBtn").addEventListener("click", async () => { current.setMonth(current.getMonth()-1); await refreshAll(); });
  $("#nextBtn").addEventListener("click", async () => { current.setMonth(current.getMonth()+1); await refreshAll(); });

  // ---- Init ---------------------------------------------------------------
  (async function init(){
    try{
      await refreshAll();
    }catch(e){
      toast(String(e.message||e));
    }
  })();
})();
</script>
</body>
</html>