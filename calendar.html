
<!doctype html><html lang="cs"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kalendář – green david app</title>
<link rel="stylesheet" href="/style.css"/>
<style>
.weekbar{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;margin:8px 0 4px 0;color:#cfd8dc}
.daygrid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;width:100%}
.day{border:1px solid #607d8b55;border-radius:16px;min-height:110px;padding:6px 8px;background:#263238;position:relative}
.day .d{font-weight:600;color:#b0bec5;margin-bottom:4px}
.day.out{opacity:.45}
.pill{border-radius:12px;padding:4px 8px;margin:2px 0;display:flex;justify-content:space-between;align-items:center;color:#fff}
.pill .ellipsis{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.row-gap{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.day.selected{outline:2px solid var(--accent); outline-offset:2px}
.day-detail{margin-top:12px;background:#263238;border:1px solid #607d8b55;border-radius:16px;padding:10px}
.day-detail.hidden{display:none}
.day-detail-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.day-detail-header .date{font-weight:800;color:#eaf6ef}
.day-events{list-style:none;margin:8px 0 0 0;padding:0;display:flex;flex-direction:column;gap:8px}
.day-event{display:flex;align-items:center;justify-content:space-between;gap:12px;background:#1f262b;border:1px solid #607d8b55;border-radius:12px;padding:8px 10px;color:#eaf6ef}
.day-event .meta{display:flex;align-items:center;gap:8px}
.badge.task{background:#2d6cdf}
.badge.job{background:#9b59b6}
</style>
</head><body>
<header class="header">
  <div class="brand">
    <img src="/logo.jpg" class="brand-logo" alt="green david"/>
    <div><div class="brand-title">green david app</div><div class="brand-sub">Kalendář</div></div>
    <div class="right small"><a class="ghost" href="/">← Zpět do aplikace</a></div>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="card-h">
      <div>Kalendář</div>
      <div class="row-gap">
        <button id="prev" class="ghost">◀</button>
        <b id="label">měsíc</b>
        <button id="next" class="ghost">▶</button>
        <span class="spacer"></span>
        <button class="btn" data-type="note">+ Poznámka</button>
        <button class="btn" data-type="task">+ Úkol</button>
        <button class="btn" data-type="job">+ Zakázka</button>
      </div>
    </div>
    <div class="card-b">
      <div class="weekbar"><div>Po</div><div>Út</div><div>St</div><div>Čt</div><div>Pá</div><div>So</div><div>Ne</div></div>
      <div id="grid" class="daygrid"></div>
<div id="dayDetail" class="day-detail hidden">
  <div class="day-detail-header">
    <div class="date" id="dayDetailDate">—</div>
    <div class="row-gap">
      <button class="ghost" id="quickNote">+ Pozn.</button>
      <button class="ghost" id="quickTask">+ Úkol</button>
      <button class="ghost" id="quickJob">+ Zak.</button>
    </div>
  </div>
  <ul class="day-events" id="dayEvents"></ul>
</div>
    </div>
  </div>
</main>

<dialog id="dlg">
  <form class="form-vert" method="dialog" style="min-width:320px">
    <h3>Přidat záznam</h3>
    <label>Datum <input type="date" id="fDate" required></label>
    <label>Nadpis <input type="text" id="fTitle" required placeholder="Název"></label>
    <label>Podrobnosti <textarea id="fNote" rows="3" placeholder="volitelné"></textarea></label>
    <label>Barva <input type="color" id="fColor" value="#2e7d32"></label>
    <input type="hidden" id="fType" value="note"/>
    <menu>
      <button class="ghost" value="cancel">Zrušit</button>
      <button class="btn" id="btnSave" value="default">Uložit</button>
    </menu>
    <div id="err" class="small" style="color:#d32f2f;display:none"></div>
  </form>
</dialog>


<script>
(function(){
  var grid = document.getElementById('grid');
  var label = document.getElementById('label');
  var prev = document.getElementById('prev');
  var next = document.getElementById('next');
  var dlg = document.getElementById('dlg');
  var fDate = document.getElementById('fDate');
  var fTitle = document.getElementById('fTitle');
  var fNote = document.getElementById('fNote');
  var fColor = document.getElementById('fColor');
  var fType = document.getElementById('fType');
  var err = document.getElementById('err');
  var dayDetail = document.getElementById('dayDetail');
  var dayDetailDate = document.getElementById('dayDetailDate');
  var dayEvents = document.getElementById('dayEvents');

  var cur = new Date(); cur.setDate(1);
  var monthItems = [];
  var selectedDate = null;

  function iso(d){ return d.toISOString().slice(0,10); }
  function fmtMonth(d){ try { return d.toLocaleDateString('cs-CZ',{month:'long',year:'numeric'}); } catch(e){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); } }

  function renderGrid(){
    if (label) label.textContent = fmtMonth(cur);
    if (grid) grid.innerHTML = '';
    if (dayDetail) dayDetail.classList.add('hidden');
    selectedDate = null;

    var first = new Date(cur.getFullYear(), cur.getMonth(), 1);
    var startDow = (first.getDay()+6)%7; // Mon=0
    first.setDate(first.getDate()-startDow);
    for(var i=0;i<42;i++){
      var day = new Date(first);
      day.setDate(first.getDate()+i);
      var cell = document.createElement('div');
      cell.className = 'day' + (day.getMonth()===cur.getMonth() ? '' : ' out');
      cell.setAttribute('data-date', iso(day));
      var head = document.createElement('div'); head.className='d'; head.textContent = day.getDate()+'.';
      cell.appendChild(head);
      cell.onclick = (function(ds, el){ return function(){ selectDay(ds, el); }; })(iso(day), cell);
      grid.appendChild(cell);
    }
  }

  function renderPills(items){
    var pills = grid.querySelectorAll('.day .row-gap');
    for (var i=0;i<pills.length;i++){ var n=pills[i]; if(n.parentNode) n.parentNode.removeChild(n); }
    for (var j=0;j<items.length;j++){
      var ev = items[j];
      var cont = grid.querySelector('.day[data-date="'+ev.date+'"]');
      if(!cont) continue;
      var wrap = cont.querySelector('.row-gap');
      if(!wrap){ wrap = document.createElement('div'); wrap.className='row-gap'; cont.appendChild(wrap); }
      var pill = document.createElement('div');
      var kind = ev.type || ev.kind || 'note';
      pill.className = 'pill badge ' + (kind==='task'?'task':(kind==='job'?'job':''));
      var title = ev.title || ev.name || ev.description || '(bez názvu)';
      pill.innerHTML = '<span class="ellipsis">'+title+'</span>';
      wrap.appendChild(pill);
    }
  }

  function renderDayDetail(ds){
    if (dayDetailDate){ 
      try { dayDetailDate.textContent = new Date(ds+'T00:00:00').toLocaleDateString('cs-CZ', {weekday:'long', day:'numeric', month:'long'}); }
      catch(e){ dayDetailDate.textContent = ds; }
    }
    var evs = [];
    for (var i=0;i<monthItems.length;i++){ if(monthItems[i].date===ds) evs.push(monthItems[i]); }
    dayEvents.innerHTML='';
    if(evs.length===0){
      var li = document.createElement('li'); li.className='day-event';
      li.innerHTML = '<div class="meta"><span>Žádné události</span></div><div><button class="btn" id="btnQuickAdd">+ Přidat</button></div>';
      dayEvents.appendChild(li);
      setTimeout(function(){
        var b = document.getElementById('btnQuickAdd');
        if(b) b.onclick = function(){ openModal(ds, 'note'); };
      },0);
    } else {
      for (var k=0;k<evs.length;k++){
        var ev = evs[k];
        var li2 = document.createElement('li'); li2.className='day-event';
        var kind2 = ev.type || ev.kind || 'note';
        var title2 = ev.title || ev.name || '(bez názvu)';
        li2.innerHTML = '<div class="meta"><span class="badge '+(kind2==='task'?'task':(kind2==='job'?'job':''))+'">'+kind2+'</span><span class="title">'+title2+'</span></div><div class="actions"><button class="ghost">Upravit</button></div>';
        (function(ds2, kind3, ev3, liEl){
          var btn = liEl.querySelector('button');
          if(btn) btn.onclick = function(){ openModal(ds2, kind3, ev3); };
        })(ds, kind2, ev, li2);
        dayEvents.appendChild(li2);
      }
    }
    dayDetail.classList.remove('hidden');
    try { dayDetail.scrollIntoView({behavior:'smooth', block:'nearest'}); } catch(e){}
  }

  function selectDay(ds, cell){
    var selected = grid.querySelectorAll('.day.selected');
    for (var i=0;i<selected.length;i++){ selected[i].classList.remove('selected'); }
    if(cell) cell.classList.add('selected');
    selectedDate = ds;
    renderDayDetail(ds);
  }

  function openModal(dateStr, type, existing){
    err.style.display='none'; err.textContent='';
    fDate.value = dateStr || (selectedDate || iso(new Date()));
    fType.value = type || 'note';
    fTitle.value = existing && (existing.title || existing.name) ? (existing.title || existing.name) : '';
    fNote.value = existing && existing.description ? existing.description : '';
    fColor.value = existing && existing.color ? existing.color : '#2e7d32';
    dlg._existing = existing || null;
    if (dlg && dlg.showModal) dlg.showModal();
  }

  document.getElementById('quickNote').onclick=function(){ openModal(selectedDate||iso(new Date()), 'note'); };
  document.getElementById('quickTask').onclick=function(){ openModal(selectedDate||iso(new Date()), 'task'); };
  document.getElementById('quickJob').onclick=function(){ openModal(selectedDate||iso(new Date()), 'job'); };

  document.getElementById('btnSave').onclick = function(e){
    e.preventDefault();
    err.style.display='none'; err.textContent='';
    var payload = {
      id: dlg._existing ? dlg._existing.id : undefined,
      date: fDate.value,
      kind: fType.value,
      title: fTitle.value,
      description: fNote.value,
      color: fColor.value
    };
    var method = payload.id ? 'PATCH' : 'POST';
    fetch('/gd/api/calendar', {method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
      .then(function(r){ if(!r.ok) return r.text().then(function(t){ throw new Error(t); }); return r.json().catch(function(){ return {}; }); })
      .then(function(){ if(dlg && dlg.close) dlg.close(); return load(); })
      .then(function(){ if(selectedDate){ var c = grid.querySelector('.day[data-date="'+selectedDate+'"]'); if(c) selectDay(selectedDate, c); } })
      .catch(function(ex){ err.style.display='block'; err.textContent = 'Uložení selhalo: ' + ex.message; });
  };

  prev.onclick = function(){ cur.setMonth(cur.getMonth()-1); load(); };
  next.onclick = function(){ cur.setMonth(cur.getMonth()+1); load(); };

  // Top add buttons
  var tops = document.querySelectorAll('button.btn[data-type]');
  for (var i=0;i<tops.length;i++){
    (function(b){ b.addEventListener('click', function(){ openModal(iso(new Date()), b.dataset.type); }); })(tops[i]);
  }

  function load(){
    try { renderGrid(); } catch(e){ console.error('renderGrid error', e); }
    // Fetch is best-effort
    var from = iso(new Date(cur.getFullYear(),cur.getMonth(),1));
    var to = iso(new Date(cur.getFullYear(),cur.getMonth()+1,0));
    fetch('/gd/api/calendar?from='+from+'&to='+to)
      .then(function(r){ return r.ok ? r.json() : {items:[]}; })
      .then(function(data){ monthItems = data && (data.items || data.events) ? (data.items || data.events) : []; renderPills(monthItems); })
      .catch(function(){ /* ignore */ });
  }

  load();
})();
</script>


</body></html>
