<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Kalendář — green david app</title>
  <link rel="icon" href="/logo.jpg">
  <link rel="stylesheet" href="/style.css">
  <style>
    /* jen drobné doplňky – hlavní vzhled nechává /style.css */
    .header-hero{position:sticky;top:0;background:linear-gradient(180deg, rgba(234,244,239,.95), rgba(234,244,239,.75));padding:calc(10px + env(safe-area-inset-top)) 16px 12px;z-index:10}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:6px}
    .month{font-size:clamp(22px,5.5vw,28px);font-weight:800;letter-spacing:-.3px}
    .navbtn{border:0;background:#0a6040;color:#fff;padding:10px 12px;border-radius:14px;font-weight:700;cursor:pointer}
    .navbtn.ghost{background:transparent;color:#0a6040;border:2px solid #0a6040}
    .grid-wrap{padding:6px 10px 20px}
    .weekday{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:0 2px 6px;color:#4d635a;font-weight:700}
    .weekday span{text-align:center;font-size:12px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;min-height:40vh}
    .day{position:relative;background:#0f2123;border-radius:22px;padding:12px 10px 10px;color:#dfe9e4;box-shadow:0 8px 20px rgba(0,0,0,.12),0 1px 0 rgba(0,0,0,.07) inset;cursor:pointer;overflow:hidden;min-height:92px}
    .day.out{opacity:.35}
    .num{font-weight:800;font-size:14px;opacity:.95}
    .events{margin-top:6px;display:flex;flex-direction:column;gap:6px}
    .chip{display:inline-flex;align-items:center;gap:8px;max-width:100%;font-size:12px;background:#11332b;border-radius:18px;padding:6px 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip.dot-job::before{content:'';width:8px;height:8px;border-radius:99px;background:#5dd0ab;display:inline-block}
    .chip.dot-task::before{content:'';width:8px;height:8px;border-radius:99px;background:#76a1ff;display:inline-block}
    .chip.dot-note::before{content:'';width:8px;height:8px;border-radius:99px;background:#d3b560;display:inline-block}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:24px 24px 0 0;box-shadow:0 -20px 60px rgba(0,0,0,.2);transform:translateY(110%);transition:.28s transform ease;z-index:50}
    .sheet.open{transform:translateY(0)}
    .sheet header{padding:14px 16px 0;text-align:center}
    .tabs{display:flex;gap:10px;justify-content:space-between;margin:10px 16px 8px}
    .tabs button{flex:1;border-radius:12px;padding:10px;border:0;background:#12352c;color:#dfe9e4;font-weight:700;cursor:pointer}
    .tabs button.active{background:#0a6040}
    .fieldset{display:flex;flex-direction:column;gap:10px;margin:10px 16px 18px}
    .fieldset input,.fieldset textarea,.fieldset select{width:100%;padding:10px 12px;border-radius:12px;border:2px solid #0a6040;background:#fff;font-size:14px}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .sheet footer{display:flex;justify-content:flex-end;gap:12px;padding:12px 16px 16px}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#0a6040;color:#fff}
    .btn.ghost{background:transparent;color:#0a6040;border:2px solid #0a6040}
    .err{display:none;background:#fee;border:2px solid #d33;color:#600;margin:12px 16px;padding:8px 10px;border-radius:12px}
  </style>
</head>
<body style="background:#eaf4ef;color:#111">
  <div class="header-hero">
    <a class="back" href="/">← Zpět do aplikace</a>
    <div class="toolbar">
      <div class="month" id="monthTitle">Měsíc</div>
      <div style="display:flex;gap:8px">
        <button class="navbtn ghost" id="prevBtn">◀︎</button>
        <button class="navbtn" id="todayBtn">Dnes</button>
        <button class="navbtn ghost" id="nextBtn">▶︎</button>
      </div>
    </div>
  </div>

  <div class="grid-wrap">
    <div class="weekday">
      <span>P</span><span>Ú</span><span>S</span><span>Č</span><span>P</span><span>S</span><span>N</span>
    </div>
    <div class="cal" id="cal"></div>
  </div>

  <div id="err" class="err"></div>

  <!-- spodní sheet -->
  <div class="sheet" id="sheet">
    <header>
      <div id="sheetTitle" style="font-weight:800"></div>
      <div style="display:flex;gap:10px;justify-content:center;margin:10px 0">
        <button class="btn ghost" id="btnDetail">Detail</button>
        <button class="btn ghost" id="btnEdit">Upravit</button>
        <button class="btn ghost" id="btnDelete">Smazat</button>
      </div>
    </header>

    <div class="tabs" id="tabs">
      <button data-tab="job" class="active">Zakázka</button>
      <button data-tab="task">Úkol</button>
      <button data-tab="note">Poznámka</button>
    </div>

    <div class="fieldset" id="form">
      <!-- Zakázka -->
      <div data-pane="job">
        <input id="job_title" placeholder="Název zakázky*">
        <div class="row">
          <input id="job_customer" placeholder="Zákazník*">
          <input id="job_city" placeholder="Město">
        </div>
        <div class="row">
          <select id="job_plan">
            <option value="plan">Plán</option>
            <option value="done">Hotovo</option>
          </select>
          <input id="job_code" placeholder="Kód (např. 2025-091)">
        </div>
        <textarea id="job_note" placeholder="Poznámka"></textarea>
      </div>
      <!-- Úkol -->
      <div data-pane="task" hidden>
        <input id="task_title" placeholder="Název úkolu*">
        <div class="row">
          <input id="task_due" type="date" placeholder="Termín">
          <select id="task_status">
            <option value="open">Otevřený</option>
            <option value="done">Hotovo</option>
          </select>
        </div>
        <textarea id="task_desc" placeholder="Popis"></textarea>
      </div>
      <!-- Poznámka -->
      <div data-pane="note" hidden>
        <textarea id="note_text" placeholder="Poznámka"></textarea>
      </div>
    </div>

    <footer>
      <button class="btn ghost" id="btnCancel">Zrušit</button>
      <button class="btn primary" id="btnSave">Uložit</button>
    </footer>
  </div>

<script>
// ---------- Error surfacing ----------
function showErr(msg){
  const el = document.getElementById('err');
  el.textContent = typeof msg === 'string' ? msg : (msg && msg.message) || 'Neznámá chyba';
  el.style.display = 'block';
  console.error(msg);
}
window.addEventListener('error', e => showErr(e.error || e.message || e));
window.addEventListener('unhandledrejection', e => showErr(e.reason || e));

// ---------- Helpers ----------
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const byId = id => document.getElementById(id);

function fmtMonth(d){
  return d.toLocaleDateString('cs-CZ', {month:'long', year:'numeric'}).replace(/^./, c=>c.toUpperCase());
}
function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function pad2(n){ return String(n).padStart(2,'0'); }
function firstDayOfGrid(d){
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const dow = (first.getDay()+6)%7; // Po=0
  const grid = new Date(first); grid.setDate(first.getDate()-dow);
  return grid;
}
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

async function fetchJSON(url, opts){
  const res = await fetch(url, {credentials:'same-origin', headers:{'Content-Type':'application/json'}, ...opts});
  if(res.ok){
    const txt = await res.text();
    try { return txt ? JSON.parse(txt) : null; } catch(e){ return txt; }
  }
  const err = await res.text().catch(()=>'');
  throw new Error(`${res.status} ${res.statusText} — ${err}`);
}

// ---------- State ----------
const state = {
  month: new Date(), // current visible month
  data: { days: [] },
  selected: null, // {type,id,date,title}
};

// ---------- Rendering ----------
async function loadMonth(){
  const ym = `${state.month.getFullYear()}-${pad2(state.month.getMonth()+1)}`;
  const data = await fetchJSON(`/gd/api/calendar?month=${ym}`);
  state.data = data || {days:[]};
  render();
}

function render(){
  byId('monthTitle').textContent = fmtMonth(state.month);
  const cal = byId('cal'); cal.innerHTML = '';

  // 6 týdnů grid
  const start = firstDayOfGrid(state.month);
  for(let i=0;i<42;i++){
    const d = addDays(start, i);
    const cell = document.createElement('div');
    cell.className = 'day' + (d.getMonth()===state.month.getMonth() ? '' : ' out');
    const num = document.createElement('div'); num.className='num'; num.textContent=d.getDate(); cell.appendChild(num);

    // Najdi události pro tento den
    const ymdStr = ymd(d);
    const dayData = (state.data.days || []).find(x => x.date === ymdStr);
    const evBox = document.createElement('div'); evBox.className='events';
    if(dayData){
      (dayData.jobs || []).forEach(j=>{
        const chip = document.createElement('div'); chip.className='chip dot-job'; chip.textContent = j.title || j.name || '(bez názvu)';
        chip.addEventListener('click', (e)=>{ e.stopPropagation(); openSheet({type:'job', id:j.id, date:ymdStr, title:chip.textContent}); });
        evBox.appendChild(chip);
      });
      (dayData.tasks || []).forEach(t=>{
        const chip = document.createElement('div'); chip.className='chip dot-task'; chip.textContent = t.title || '(úkol)';
        chip.addEventListener('click', (e)=>{ e.stopPropagation(); openSheet({type:'task', id:t.id, date:ymdStr, title:chip.textContent}); });
        evBox.appendChild(chip);
      });
      (dayData.notes || dayData.other || []).forEach(n=>{
        const chip = document.createElement('div'); chip.className='chip dot-note'; chip.textContent = n.title || n.text || '(poznámka)';
        chip.addEventListener('click', (e)=>{ e.stopPropagation(); openSheet({type:'note', id:n.id, date:ymdStr, title:chip.textContent}); });
        evBox.appendChild(chip);
      });
    }
    cell.appendChild(evBox);
    cell.addEventListener('click', ()=> openSheet({type:'task', id:null, date:ymdStr, title:ymdToCZ(ymdStr)}));
    cal.appendChild(cell);
  }
}

// ---------- Sheet / CRUD ----------
function switchTab(tab){
  $$('#tabs button').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
  $$('#form [data-pane]').forEach(p=> p.hidden = (p.getAttribute('data-pane')!==tab));
}
function fillForm(evt){
  byId('sheetTitle').textContent = evt.title || ymdToCZ(evt.date);
  switchTab(evt.type);
  state.selected = evt;
}

function openSheet(evt){
  fillForm(evt);
  byId('sheet').classList.add('open');
}
function closeSheet(){
  byId('sheet').classList.remove('open');
  state.selected = null;
}

async function onRowDetail(){
  // Zobrazit detail načtením dat – zatím jen načte seznam pro typ
  const s = state.selected; if(!s || !s.id){ return; }
  const endpoint = s.type==='job' ? `/api/jobs?id=${s.id}` : `/api/tasks?id=${s.id}`;
  const data = await fetchJSON(endpoint);
  alert(JSON.stringify(data, null, 2));
}

async function onRowDelete(){
  const s = state.selected; if(!s){ return; }
  if(!s.id){ closeSheet(); return; } // nic k mazání
  if(!confirm('Opravdu smazat?')) return;
  const endpoint = s.type==='job' ? `/api/jobs?id=${s.id}` : `/api/tasks?id=${s.id}`;
  await fetchJSON(endpoint, { method: 'DELETE' });
  await loadMonth();
  closeSheet();
}

async function onSave(){
  const s = state.selected;
  const body = {};
  let url = '', method = 'POST';
  if(s.type==='job'){
    url = '/api/jobs';
    Object.assign(body, {
      title: byId('job_title').value.trim(),
      customer: byId('job_customer').value.trim(),
      city: byId('job_city').value.trim(),
      status: byId('job_plan').value || 'plan',
      code: byId('job_code').value.trim(),
      note: byId('job_note').value.trim(),
      date: s.date
    });
  }else if(s.type==='task'){
    url = '/api/tasks';
    Object.assign(body, {
      title: byId('task_title').value.trim(),
      description: byId('task_desc').value.trim(),
      status: byId('task_status').value || 'open',
      due_date: byId('task_due').value || s.date,
      created_at: new Date().toISOString().slice(0,19).replace('T',' ')
    });
  }else{
    url = '/api/tasks';
    Object.assign(body, { title: byId('note_text').value.trim(), status:'open', due_date:s.date, created_at:new Date().toISOString().slice(0,19).replace('T',' ') });
  }
  if(s.id){ method = 'PATCH'; url += `?id=${s.id}`; }
  await fetchJSON(url, { method, body: JSON.stringify(body) });
  await loadMonth();
  closeSheet();
}

// ---------- events ----------
byId('btnCancel').addEventListener('click', closeSheet);
byId('btnSave').addEventListener('click', onSave);
byId('btnEdit').addEventListener('click', ()=>{ const s=state.selected; if(s){ /* přepnout do režimu editace – nic speciálního tu není */ }});
byId('btnDetail').addEventListener('click', onRowDetail);
byId('btnDelete').addEventListener('click', onRowDelete);
$('#tabs').addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-tab]'); if(!b) return;
  switchTab(b.dataset.tab);
});

// navigace měsíců
byId('todayBtn').addEventListener('click', ()=>{ state.month = new Date(); loadMonth(); });
byId('prevBtn').addEventListener('click', ()=>{ const d=new Date(state.month); d.setMonth(d.getMonth()-1); state.month=d; loadMonth(); });
byId('nextBtn').addEventListener('click', ()=>{ const d=new Date(state.month); d.setMonth(d.getMonth()+1); state.month=d; loadMonth(); });

// ---------- bootstrap ----------
function ymdToCZ(s){ const m=String(s||'').match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/); return m?`${m[3]}.${m[2]}.${m[1]}`:s; }
loadMonth();
</script>
</body>
</html>
