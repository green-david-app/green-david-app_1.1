<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kalendář – green david app</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <header class="header">
    <div class="brand">
      <img src="/logo.jpg" alt="green david"/>
      <div>
        <div class="brand-title">green david app</div>
        <div class="brand-sub">Kalendář</div>
      </div>
      <div class="right"><a class="ghost" href="/">Zpět do aplikace</a></div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div class="card-h">
        <div class="controls">
          <button id="prev" class="btn ghost">◀</button>
          <div id="label" class="label">měsíc</div>
          <button id="next" class="btn ghost">▶</button>
        </div>
        <div class="controls">
          <button class="btn" data-type="note">+ Poznámka</button>
          <button class="btn" data-type="task">+ Úkol</button>
          <button class="btn" data-type="job">+ Zakázka</button>
        </div>
      </div>
      <div class="card-b">
        <div class="weekbar"><div>Po</div><div>Út</div><div>St</div><div>Čt</div><div>Pá</div><div>So</div><div>Ne</div></div>
        <div id="grid" class="daygrid"></div>
      </div>
    </div>
  </main>

  <dialog id="sheet">
    <div class="sheet-h">
      <div id="sheet-date">Den</div>
      <button id="sheet-close" class="btn ghost">Zavřít</button>
    </div>
    <div class="sheet-b" id="sheet-body"></div>
  </dialog>

  <dialog id="dlg">
    <form class="form-vert" method="dialog" style="min-width:320px">
      <div class="sheet-h"><b>Přidat záznam</b></div>
      <div class="sheet-b">
        <label>Datum <input type="date" id="fDate" required></label><br/>
        <label>Nadpis <input type="text" id="fTitle" required placeholder="Název"></label><br/>
        <label>Podrobnosti <textarea id="fNote" rows="3" placeholder="volitelné"></textarea></label><br/>
        <label>Barva <input type="color" id="fColor" value="#2e7d32"></label>
        <input type="hidden" id="fType" value="note"/>
        <div id="err" class="small" style="color:#d32f2f;display:none"></div>
      </div>
      <div class="sheet-h" style="gap:8px;justify-content:flex-end">
        <button class="btn ghost" value="cancel">Zrušit</button>
        <button class="btn" id="btnSave" value="default">Uložit</button>
      </div>
    </form>
  </dialog>

  <script>
  (function(){
    const grid = document.getElementById('grid');
    const label = document.getElementById('label');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const sheet = document.getElementById('sheet');
    const sheetDate = document.getElementById('sheet-date');
    const sheetBody = document.getElementById('sheet-body');
    const fDate = document.getElementById('fDate');
    const fTitle = document.getElementById('fTitle');
    const fNote = document.getElementById('fNote');
    const fColor = document.getElementById('fColor');
    const fType = document.getElementById('fType');
    const err = document.getElementById('err');

    const qs = s=>document.querySelector(s);

    let cur = new Date(); cur.setDate(1);
    const iso = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const monthLabel = d => d.toLocaleString('cs-CZ',{month:'long',year:'numeric'});

    async function api(url, opts){
      const r = await fetch(url, {credentials:'same-origin', headers:{'Content-Type':'application/json'}, ...(opts||{})});
      const ct = r.headers.get('content-type')||'';
      const body = ct.includes('application/json') ? await r.json() : await r.text();
      if(!r.ok) throw new Error(typeof body==='string'?body:JSON.stringify(body));
      return body;
    }

    async function load(){
      label.textContent = monthLabel(cur);
      const start = new Date(cur.getFullYear(), cur.getMonth(), 1);
      const end = new Date(cur.getFullYear(), cur.getMonth()+1, 0);
      const items = await api(`/gd/api/calendar?from=${iso(start)}&to=${iso(end)}`);
      render(items||[]);
    }

    function render(items){
      grid.innerHTML='';
      const first = new Date(cur.getFullYear(), cur.getMonth(), 1);
      const pad = (first.getDay()+6)%7;
      const start = new Date(first); start.setDate(first.getDate()-pad);

      // index by date
      const by = {};
      (items||[]).forEach(x=>{
        const key = iso(new Date(x.date || Date.now()));
        (by[key] ||= []).push(x);
      });

      for(let i=0;i<42;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        const k = iso(d);
        const cell = document.createElement('div'); cell.className='day'+(d.getMonth()!==cur.getMonth()?' out':'');
        const head = document.createElement('div'); head.className='d'; head.textContent = d.getDate()+'.';
        cell.appendChild(head);

        const list = by[k]||[];
        // show at most 2 pills in the cell (like iOS) and a "+N"
        list.slice(0,2).forEach(ev => {
          const row = document.createElement('div'); row.className='pill'; row.style.background = ev.color || '#2e7d32';
          const txt = document.createElement('div'); txt.className='txt'; txt.textContent = ev.title || ev.note || '';
          const del = document.createElement('button'); del.className='del'; del.textContent='×'; del.title='Smazat';
          del.onclick = async (e)=>{ e.stopPropagation(); if(confirm('Smazat záznam?')){ await api('/gd/api/calendar?'+new URLSearchParams({id:String(ev.id)}), {method:'DELETE'}); load(); } };
          row.appendChild(txt); row.appendChild(del);
          cell.appendChild(row);
        });
        if(list.length>2){
          const more = document.createElement('div'); more.className='more'; more.textContent = `+${list.length-2} další`;
          cell.appendChild(more);
        }

        cell.onclick = ()=> openDay(k, list);
        grid.appendChild(cell);
      }
    }

    function openDay(key, list){
      sheetDate.textContent = new Date(key).toLocaleDateString('cs-CZ',{weekday:'long', day:'numeric', month:'long', year:'numeric'});
      sheetBody.innerHTML = '';
      if(!list || list.length===0){
        sheetBody.textContent = 'Žádné záznamy'; sheet.showModal(); return;
      }
      list.forEach(ev=>{
        const row = document.createElement('div'); row.className='sheet-ev';
        const c = document.createElement('div'); c.className='color'; c.style.background = ev.color || '#2e7d32';
        const col = document.createElement('div');
        col.innerHTML = `<div class="title">${ev.title || '(bez názvu)'}</div>` + (ev.note? `<div class="note">${ev.note}</div>`:'');
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent = 'Smazat';
        del.onclick = async ()=>{ if(confirm('Smazat záznam?')){ await api('/gd/api/calendar?'+new URLSearchParams({id:String(ev.id)}), {method:'DELETE'}); sheet.close(); load(); } };
        row.appendChild(c); row.appendChild(col); row.appendChild(del);
        sheetBody.appendChild(row);
      });
      sheet.showModal();
    }

    document.getElementById('sheet-close').onclick = ()=> sheet.close();

    document.querySelectorAll('button.btn[data-type]').forEach(b=> b.onclick = ()=> {
      const today = new Date(); fDate.value = iso(today); fType.value = b.dataset.type;
      fColor.value = b.dataset.type==='note' ? '#1976d2' : (b.dataset.type==='job' ? '#ef6c00' : '#2e7d32');
      fTitle.value = ''; fNote.value = ''; err.style.display='none'; err.textContent='';
      document.getElementById('dlg').showModal();
    });

    document.getElementById('btnSave').onclick = async (e)=>{
      e.preventDefault();
      try{
        await api('/gd/api/calendar', {method:'POST', body: JSON.stringify({
          date: fDate.value, title: fTitle.value, kind: fType.value, note: fNote.value, color: fColor.value
        })});
        document.getElementById('dlg').close(); load();
      }catch(ex){
        err.style.display='block'; err.textContent = 'Uložení selhalo: ' + ex.message;
      }
    };

    prev.onclick = ()=>{ cur.setMonth(cur.getMonth()-1); load(); };
    next.onclick = ()=>{ cur.setMonth(cur.getMonth()+1); load(); };

    load();
  })();
  </script>
</body>
</html>
