
<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalendář</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Neinvazivní doplňky pro layout – drží se existujících barev */
    .cal-wrap { max-width: 1200px; margin: 0 auto; padding: 16px 20px 120px; }
    .cal-header { display:flex; justify-content:space-between; align-items:center; margin: 8px 0 12px; }
    .cal-title { font-size: 40px; font-weight: 800; letter-spacing: .3px; }
    .cal-nav { display:flex; gap:8px; align-items:center; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap: 18px; }
    .cal-cell { position: relative; border-radius: 24px; padding: 12px 12px 46px; min-height: 120px; background: var(--card-bg, #101c1b); box-shadow: inset 0 0 0 1px rgba(255,255,255,.04); }
    .cal-cell.muted { background: rgba(0,0,0,.15); opacity: .6; }
    .cal-weekday { display:grid; grid-template-columns: repeat(7, 1fr); gap: 18px; margin-bottom: 8px; color: rgba(255,255,255,.65); font-weight:600; }
    .cal-weekday div { text-align:center; }
    .cal-daynum { position:absolute; top:10px; left:12px; font-weight:700; opacity:.9; }
    .pill { display:inline-block; max-width: 100%; margin: 6px 6px 0 0; padding: 3px 8px; border-radius: 999px; font-size: 12px; line-height: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border:1px solid rgba(255,255,255,.1) }
    .pill.job { background: rgba(0,180,140,.18); }
    .pill.task { background: rgba(0,120,255,.18); }
    .pill.note { background: rgba(200,200,200,.15); }
    .legend { display:flex; gap:20px; align-items:center; margin: 14px 0 22px; font-size:14px; }
    .legend .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px;}
    .dot.job{ background:#00b48c }
    .dot.task{ background:#0078ff }
    .dot.note{ background:#9ea3a5 }
    .fab { position: fixed; right: 20px; bottom: 20px; z-index:3; }
    .sheet { position: fixed; left: 0; right:0; bottom: -100%; background: #0e1716; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -8px 30px rgba(0,0,0,.35); padding: 14px 16px 18px; transition: bottom .28s ease; z-index: 50; }
    .sheet.open { bottom: 0; }
    .sheet .title { font-weight:800; margin-bottom:8px; }
    .sheet .row { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0; }
    .btn { background:#0f3; color:#031; padding:.5rem .9rem; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .btn.minor { background:#1e2b2a; color:#dfe; }
    .btn.danger { background:#b92e2e; color:white; }
    .btn:disabled { opacity:.5; cursor:not-allowed }
    .muted { opacity:.75 }
    .errorbar { position:fixed; left:16px; right:16px; bottom:84px; background:#361417; color:#ffb4c0; border:1px solid #703e46; border-radius:12px; padding:10px 12px; font-size:13px; display:none; z-index:60 }
    .errorbar.show{ display:block }
    .hidden { display:none }
  </style>
</head>
<body>
  <div class="cal-wrap">
    <a href="/" style="color:inherit;text-decoration:none">← Zpět do aplikace</a>
    <div class="cal-header">
      <div class="cal-title" id="calTitle">Měsíc</div>
      <div class="cal-nav">
        <button id="prevBtn" class="btn minor" aria-label="Předchozí">◀︎</button>
        <button id="todayBtn" class="btn minor">Dnes</button>
        <button id="nextBtn" class="btn minor" aria-label="Další">▶︎</button>
      </div>
    </div>

    <div class="legend">
      <div><span class="dot job"></span> zakázky</div>
      <div><span class="dot task"></span> úkoly / připomínky</div>
      <div><span class="dot note"></span> ostatní</div>
    </div>

    <div class="cal-weekday">
      <div>P</div><div>Ú</div><div>S</div><div>Č</div><div>P</div><div>S</div><div>N</div>
    </div>

    <div class="cal-grid" id="calGrid"></div>
  </div>

  <!-- Bottom sheet -->
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="title" id="sheetTitle">Detail</div>
    <div id="sheetBody"></div>
    <div class="row">
      <button class="btn minor" id="closeSheet">Zavřít</button>
      <button class="btn" id="editBtn">Upravit</button>
      <button class="btn danger" id="deleteBtn">Smazat</button>
    </div>
  </div>

  <div id="errorbar" class="errorbar"></div>

<script>
(() => {
  const grid = document.getElementById('calGrid');
  const titleEl = document.getElementById('calTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const todayBtn = document.getElementById('todayBtn');
  const errorbar = document.getElementById('errorbar');

  const sheet = document.getElementById('sheet');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetBody = document.getElementById('sheetBody');
  const closeSheet = document.getElementById('closeSheet');
  const editBtn = document.getElementById('editBtn');
  const deleteBtn = document.getElementById('deleteBtn');

  let current = new Date();
  let monthCache = {}; // YYYY-MM -> items by date
  let selectedItem = null;

  function fmtMonthKey(d) {
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
  }
  function fmtDateKey(d) {
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }
  function csMonthName(d){
    const names = ['Leden','Únor','Březen','Duben','Květen','Červen','Červenec','Srpen','Září','Říjen','Listopad','Prosinec'];
    return names[d.getMonth()] + ' ' + d.getFullYear();
  }
  function showError(msg){
    errorbar.textContent = msg;
    errorbar.classList.add('show');
    setTimeout(()=>errorbar.classList.remove('show'), 5000);
  }
  function openSheet(item){
    selectedItem = item;
    sheetTitle.textContent = (item.typeLabel || item.type || 'Detail') + ' — ' + (item.title || item.name || '(bez názvu)');
    sheetBody.innerHTML = `
      <div class="muted">Datum: ${item.date || item.day || item.due_date || ''}</div>
      <div style="margin-top:6px">${(item.description || item.note || '')}</div>
      <div class="muted" style="margin-top:8px">ID: ${item.id || item.task_id || item.job_id || ''}</div>
    `;
    sheet.classList.add('open');
    sheet.setAttribute('aria-hidden','false');
  }
  function closeSheetFn(){
    sheet.classList.remove('open');
    sheet.setAttribute('aria-hidden','true');
    selectedItem = null;
  }

  closeSheet.addEventListener('click', closeSheetFn);

  editBtn.addEventListener('click', async () => {
    if(!selectedItem){ return; }
    try{
      const id = selectedItem.id || selectedItem.task_id || selectedItem.job_id;
      const type = selectedItem.type || selectedItem.kind || (selectedItem.task_id ? 'task' : (selectedItem.job_id ? 'job' : 'note'));
      // jednoduchá PATCH – pošle beze změn (jen demonstrace rozhraní). V praxi by se zde otevřel formulář.
      const endpoint = type === 'job' ? '/api/jobs' : (type === 'task' ? '/api/tasks' : '/api/tasks');
      const resp = await fetch(endpoint + '?id=' + encodeURIComponent(id), {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ title: selectedItem.title || selectedItem.name || 'upraveno' })
      });
      if(!resp.ok){ throw new Error('Upravit selhalo: ' + resp.status); }
      await reload();
      closeSheetFn();
    }catch(e){ showError(String(e)); }
  });

  deleteBtn.addEventListener('click', async () => {
    if(!selectedItem){ return; }
    try{
      const id = selectedItem.id || selectedItem.task_id || selectedItem.job_id;
      const type = selectedItem.type || selectedItem.kind || (selectedItem.task_id ? 'task' : (selectedItem.job_id ? 'job' : 'task'));
      const endpoint = type === 'job' ? '/api/jobs' : '/api/tasks';
      const resp = await fetch(endpoint + '?id=' + encodeURIComponent(id), { method: 'DELETE' });
      if(!resp.ok){ throw new Error('Smazat selhalo: ' + resp.status); }
      await reload();
      closeSheetFn();
    }catch(e){ showError(String(e)); }
  });

  prevBtn.addEventListener('click', () => { current.setMonth(current.getMonth()-1); render(); });
  nextBtn.addEventListener('click', () => { current.setMonth(current.getMonth()+1); render(); });
  todayBtn.addEventListener('click', () => { current = new Date(); render(); });

  async function loadMonth(key){
    if(monthCache[key]) return monthCache[key];
    try{
      const res = await fetch('/gd/api/calendar?month=' + key);
      if(!res.ok){ throw new Error('Načítání dat selhalo (' + res.status + ')'); }
      const data = await res.json();
      // Adaptér – zkusí různé tvary backendu
      const byDate = {};
      function push(date, item){
        if(!byDate[date]) byDate[date] = [];
        byDate[date].push(item);
      }
      if(Array.isArray(data)){
        for(const it of data){
          const date = it.date || it.day || it.due_date;
          if(!date) continue;
          const type = it.type || it.kind || (it.job_id?'job':(it.task_id?'task':'note'));
          push(date, normalizeItem(it, type));
        }
      } else if (data && typeof data === 'object') {
        if (data.days) {
          for (const [date, bucket] of Object.entries(data.days)) {
            const addAll = (arr, type) => (Array.isArray(arr)?arr:[]).forEach(it => push(date, normalizeItem(it, type)));
            addAll(bucket.jobs || bucket.job || [], 'job');
            addAll(bucket.tasks || bucket.task || [], 'task');
            addAll(bucket.notes || bucket.note || [], 'note');
          }
        } else if (data.items) {
          for(const it of data.items){
            const date = it.date || it.day || it.due_date;
            if(!date) continue;
            const type = it.type || it.kind || (it.job_id?'job':(it.task_id?'task':'note'));
            push(date, normalizeItem(it, type));
          }
        }
      }
      monthCache[key] = byDate;
      return byDate;
    }catch(e){
      showError(String(e));
      monthCache[key] = {};
      return {};
    }
  }

  function normalizeItem(it, type){
    const title = it.title || it.name || it.customer || it.note || '(bez názvu)';
    const id = it.id || it.task_id || it.job_id || it.note_id;
    const date = it.date || it.day || it.due_date;
    return {
      id, type, title,
      description: it.description || it.note || '',
      date,
      typeLabel: type === 'job' ? 'Zakázka' : (type === 'task' ? 'Úkol' : 'Poznámka'),
      raw: it
    };
  }

  function cellTemplate(day, muted){
    return `<div class="cal-cell ${muted?'muted':''}" data-date="${day.toISOString().slice(0,10)}">
              <div class="cal-daynum">${day.getDate()}</div>
              <div class="pills"></div>
            </div>`;
  }

  async function render(){
    titleEl.textContent = csMonthName(current);
    const key = fmtMonthKey(current);
    const dataByDate = await loadMonth(key);

    // první den v měsíci
    const first = new Date(current.getFullYear(), current.getMonth(), 1);
    const startWeekday = (first.getDay() + 6) % 7; // Po=0 .. Ne=6
    const start = new Date(first);
    start.setDate(first.getDate() - startWeekday);

    grid.innerHTML = '';
    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const muted = d.getMonth() !== current.getMonth();
      grid.insertAdjacentHTML('beforeend', cellTemplate(d, muted));
    }

    // naplnění dat
    for(const cell of grid.querySelectorAll('.cal-cell')){
      const day = cell.dataset.date;
      const list = dataByDate[day] || [];
      const pills = cell.querySelector('.pills');
      if(list.length === 0){ continue; }
      for(const item of list){
        const span = document.createElement('span');
        span.className = 'pill ' + (item.type === 'job' ? 'job' : (item.type === 'task' ? 'task' : 'note'));
        span.textContent = item.title;
        span.title = item.typeLabel + ' • ' + (item.description || '');
        span.addEventListener('click', (ev)=>{ ev.stopPropagation(); openSheet(item); });
        pills.appendChild(span);
      }
    }
  }

  async function reload(){
    monthCache[fmtMonthKey(current)] = null;
    await render();
  }

  render();
})();
</script>
</body>
</html>
