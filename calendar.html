<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Kalendář — green david app</title>
  <link rel="icon" href="/logo.svg">
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{ --bg:#eaf4ef; --ink:#0b2b20; --accent:#0a6040; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--ink); font:14px/1.5 system-ui,-apple-system,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif; }
    .header{ position:sticky; top:0; z-index:5; padding:14px 16px; background:linear-gradient(#ffffffcc,#ffffffaa 40%,#ffffff00); backdrop-filter:saturate(130%) blur(8px); }
    .back{ color:var(--accent); text-decoration:none; font-weight:700; }
    h1{ margin:8px 0 0; font-size:24px; }
    .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:10px; padding:16px; }
    .cell{ border-radius:14px; padding:8px; min-height:90px; background:#0f3225; color:#fff; position:relative; }
    .cell.dim{ background:#dfe9e4; color:#334; }
    .cell .label{ position:absolute; top:8px; left:10px; font-weight:800; opacity:.8; font-size:12px; }
    .dot{ display:inline-block; padding:2px 8px; margin:4px 4px 0 0; border-radius:999px; font-size:11px; border:1px solid #fff3; }
    .dot.job{ background:#e8fff2; color:#007e3a; border-color:#b3f4cd; }
    .dot.task{ background:#f4ebff; color:#6a2df5; border-color:#dcc7ff; }
    .sheet{ position:fixed; left:0; right:0; bottom:-100%; background:#fff; border-radius:16px 16px 0 0; box-shadow:0 -16px 40px #0002; transition:bottom .25s ease; padding:10px 12px 16px; z-index:10; }
    .sheet.open{ bottom:0; }
    .row{ display:flex; align-items:center; gap:8px; padding:8px 6px; border-bottom:1px dotted #e7ecee; }
    .row:last-child{ border-bottom:0; }
    .tag{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; }
    .tag.job{ background:#e8fff2; color:#007e3a; border:1px solid #b3f4cd; }
    .tag.task{ background:#f4ebff; color:#6a2df5; border:1px solid #dcc7ff; }
    .btn{ appearance:none; border:0; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer; }
    .btn.small{ font-size:12px; padding:4px 8px; }
    .btn.primary{ background:var(--accent); color:#fff; }
    .btn.gray{ background:#eef3f2; }
    .tabs{ display:flex; gap:12px; margin:10px 0; }
    .tabs button{ flex:1; }
    .field{ display:flex; gap:8px; margin:6px 0; }
    .field input, .field textarea{ width:100%; padding:8px 10px; border:1px solid #e3eaeb; border-radius:12px; }
  </style>
</head>
<body>
  <div class="header">
    <a class="back" href="/">← Zpět do aplikace</a>
    <h1 id="monthTitle">Kalendář</h1>
  </div>

  <div id="weekdays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:10px;padding:0 16px 8px;">
    <div>P</div><div>Ú</div><div>S</div><div>Č</div><div>P</div><div>S</div><div>N</div>
  </div>
  <div id="grid" class="grid"></div>

  <div id="sheet" class="sheet" aria-hidden="true">
    <div style="width:42px;height:5px;background:#ccd;border-radius:999px;margin:6px auto 10px;"></div>
    <div id="sheetDate" style="text-align:center;font-weight:800;margin-bottom:8px;"></div>
    <div class="tabs">
      <button id="tabJobs" class="btn gray">Zakázka</button>
      <button id="tabTasks" class="btn gray">Úkol</button>
      <button id="tabNotes" class="btn gray">Poznámka</button>
    </div>
    <div id="dayList"></div>

    <!-- Forms -->
    <div id="formJob" style="display:none">
      <div class="field"><input id="jTitle" placeholder="Název"></div>
      <div class="field"><input id="jClient" placeholder="Klient"></div>
      <div class="field"><input id="jCity" placeholder="Město"></div>
      <div class="field"><input id="jCode" placeholder="Kód"></div>
      <div class="field"><textarea id="jNote" placeholder="Poznámka"></textarea></div>
    </div>

    <div id="formTask" style="display:none">
      <div class="field"><input id="tTitle" placeholder="Název úkolu"></div>
      <div class="field"><input id="tDue" placeholder="Termín (YYYY-MM-DD)"></div>
      <div class="field"><textarea id="tDesc" placeholder="Popis"></textarea></div>
    </div>

    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="saveBtn" class="btn primary">Uložit</button>
      <button id="cancelBtn" class="btn gray">Zavřít</button>
    </div>
  </div>

  <script>
  const byId = (id)=>document.getElementById(id);
  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

  const state = { d:new Date(), month:'', data:null, focusDate:null, editing:null };

  function fmtDate(d){ return d.toISOString().slice(0,10); }
  function openSheet(dateStr){ state.focusDate=dateStr; byId('sheet').classList.add('open'); byId('sheet').setAttribute('aria-hidden','false'); byId('sheetDate').textContent = 'Den: '+dateStr; }
  function closeSheet(){ byId('sheet').classList.remove('open'); byId('sheet').setAttribute('aria-hidden','true'); state.editing=null; }

  async function fetchJSON(url, opts){
    opts = opts || {};
    opts.headers = Object.assign({'Accept':'application/json'}, opts.headers||{});
    if(opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)){
      opts.headers['Content-Type']='application/json';
      opts.body = JSON.stringify(opts.body);
    }
    const res = await fetch(url, opts);
    const ct = res.headers.get('content-type')||'';
    const data = ct.includes('application/json') ? await res.json() : await res.text();
    if(!res.ok){ throw new Error((data && data.error) || res.statusText || 'HTTP error'); }
    return data;
  }

  function monthKey(d){ return d.toISOString().slice(0,7); }

  async function load(){
    const key = monthKey(state.d);
    state.month = key;
    byId('monthTitle').textContent = new Date(key+'-01').toLocaleDateString('cs-CZ',{month:'long', year:'numeric'});
    const data = await fetchJSON(`/gd/api/calendar?month=${key}`);
    state.data = data;
    renderGrid();
  }

  function renderGrid(){
    const root = byId('grid'); root.innerHTML='';
    const d = new Date(state.month+'-01');
    const startDay = (new Date(d.getFullYear(), d.getMonth(), 1).getDay()+6)%7; // Mon=0
    const daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    // previous month trailing cells
    for(let i=0;i<startDay;i++){ const c = document.createElement('div'); c.className='cell dim'; root.appendChild(c); }
    for(let day=1; day<=daysInMonth; day++){
      const c = document.createElement('div'); c.className='cell'; const dateStr = `${state.month}-${String(day).padStart(2,'0')}`;
      const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent=day; c.appendChild(lbl);
      const dayData = (state.data && state.data[dateStr]) || [];
      dayData.slice(0,3).forEach(item=>{
        const b = document.createElement('div'); b.className='dot '+(item.type||'other'); b.textContent=(item.title||item.name||''); c.appendChild(b);
      });
      c.addEventListener('click', async ()=>{ await renderDayList(dateStr); openSheet(dateStr); });
      root.appendChild(c);
    }
  }

  async function renderDayList(dateStr){
    const wrap = byId('dayList'); wrap.innerHTML='';
    const list = (state.data && state.data[dateStr]) || [];
    if(!list.length){ wrap.innerHTML='<div style="opacity:.7;padding:6px 4px;">Žádné položky pro tento den.</div>'; }
    list.forEach(row=>{
      const el = document.createElement('div'); el.className='row';
      const tag = document.createElement('span'); tag.className='tag '+(row.type||'other'); tag.textContent=(row.type||''); el.appendChild(tag);
      const title = document.createElement('div'); title.style.flex='1'; title.textContent = row.title || row.name || '(bez názvu)'; el.appendChild(title);

      const btnDetail = document.createElement('button'); btnDetail.className='btn small gray'; btnDetail.textContent='Detail';
      btnDetail.onclick = ()=> onRowDetail(row.type, row.id);
      const btnEdit = document.createElement('button'); btnEdit.className='btn small gray'; btnEdit.textContent='Upravit';
      btnEdit.onclick = ()=> onRowEdit(row.type, row.id);
      const btnDel = document.createElement('button'); btnDel.className='btn small gray'; btnDel.textContent='Smazat';
      btnDel.onclick = ()=> onRowDelete(row.type, row.id);
      el.append(btnDetail, btnEdit, btnDel);
      wrap.appendChild(el);
    });
    return list;
  }

  async function fetchDetailBy(type, id){
    if(type==='job'){
      const d = await fetchJSON(`/api/jobs/${id}`);
      return {type:'job', data:(d && d.job)||{}};
    }else{
      try{
        const d = await fetchJSON(`/api/tasks/${id}`);
        const row = (d && (d.task || d.data || d)) || {};
        return {type:'task', data: row};
      }catch(e){
        const list = await fetchJSON('/api/tasks');
        const rows = list.rows || list.tasks || list || [];
        const found = rows.find(r => String(r.id)===String(id));
        return {type:'task', data:found||{id}};
      }
    }
  }

  async function onRowDetail(type, id){
    const {data} = await fetchDetailBy(type, id);
    alert(JSON.stringify(data, null, 2));
  }

  async function onRowEdit(type, id){
    const {data} = await fetchDetailBy(type, id);
    state.editing = {type, id};
    if(type==='job'){
      byId('formJob').style.display='block'; byId('formTask').style.display='none';
      byId('jTitle').value = data.title || '';
      byId('jClient').value = data.client || '';
      byId('jCity').value = data.city || '';
      byId('jCode').value = data.code || '';
      byId('jNote').value = data.note || '';
    }else{
      byId('formJob').style.display='none'; byId('formTask').style.display='block';
      byId('tTitle').value = data.title || '';
      byId('tDue').value = (data.due_date || state.focusDate || '');
      byId('tDesc').value = data.description || '';
    }
  }

  async function onRowDelete(type, id){
    if(!confirm('Opravdu smazat?')) return;
    if(type==='job'){ await fetchJSON(`/api/jobs?id=${encodeURIComponent(id)}`, {method:'DELETE'}); }
    else{ await fetchJSON(`/api/tasks?id=${encodeURIComponent(id)}`, {method:'DELETE'}); }
    await load(); await renderDayList(state.focusDate);
  }

  // Save handler (PATCH for edits only)
  (function(){
    const saveBtn = byId('saveBtn'), cancelBtn = byId('cancelBtn');
    saveBtn.addEventListener('click', async ()=>{
      if(!state.editing){ alert('Nic k uložení.'); return; }
      const dateStr = state.focusDate;
      if(state.editing.type==='job'){
        const payload = {
          id:Number(state.editing.id),
          title: (byId('jTitle').value||'').trim(),
          client:(byId('jClient').value||'').trim(),
          city:(byId('jCity').value||'').trim(),
          code:(byId('jCode').value||'').trim(),
          note:(byId('jNote').value||'').trim(), date:dateStr
        };
        await fetchJSON('/api/jobs', {method:'PATCH', body:payload});
      }else{
        const payload = {
          id:Number(state.editing.id),
          title:(byId('tTitle').value||'').trim(),
          description:(byId('tDesc').value||'').trim(),
          status:'open',
          due_date:(byId('tDue').value||dateStr)
        };
        await fetchJSON('/api/tasks', {method:'PATCH', body:payload});
      }
      state.editing=null; closeSheet(); await load(); await renderDayList(dateStr);
    });
    cancelBtn.addEventListener('click', ()=>{ state.editing=null; closeSheet(); });
  })();

  // Intercept generic POST to /api/tasks to ensure created_at exists
  (function(){
    const origFetch = window.fetch.bind(window);
    window.fetch = async (input, init={})=>{
      let url = (typeof input==='string') ? input : (input && input.url) || '';
      const method = ((init && init.method) || 'GET').toUpperCase();
      if(method==='POST' && url.includes('/api/tasks')){
        let body = init.body;
        if(body && typeof body === 'object'){
          if(!('created_at' in body)){
            body.created_at = new Date().toISOString();
          }
          init.body = JSON.stringify(body);
          init.headers = Object.assign({'Content-Type':'application/json','Accept':'application/json'}, init.headers||{});
        }else if(typeof body === 'string' && body.trim().starts_with('{')){
          try{ const obj = JSON.parse(body); if(!('created_at' in obj)){ obj.created_at = new Date().toISOString(); } init.body = JSON.stringify(obj); }catch(e){}
        }
      }
      return origFetch(input, init);
    };
  })();

  load();
  </script>
</body>
</html>