<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Zak√°zky - Green David</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <link rel="stylesheet" href="/static/css/global-search.css"/>
    <script src="/app-settings.js"></script>
    <script src="/static/app-header.js"></script>
    <script src="/static/global-search.js"></script>
    <style>
        :root {
            --bg-primary: #1a1d1f;
            --bg-card: rgba(255,255,255,0.06);
            --bg-card-hover: #1a2332;
            --border: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #4ade80;
            --accent-blue: #60a5fa;
            --accent-yellow: #fbbf24;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --accent-cyan: #22d3ee;
            --margin-high: #22c55e;
            --margin-medium: #eab308;
            --margin-low: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header Section */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-title .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* View Switcher */
        .view-switcher {
            display: flex;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .view-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-btn:hover {
            color: var(--text-primary);
            background: var(--bg-card-hover);
        }

        .view-btn.active {
            background: var(--accent-green);
            color: #000;
        }

        .view-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Action Buttons */
        .btn-primary {
            padding: 12px 24px;
            background: var(--accent-green);
            color: #000;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
        }

        .btn-secondary {
            padding: 10px 16px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.green::before { background: var(--accent-green); }
        .stat-card.blue::before { background: var(--accent-blue); }
        .stat-card.yellow::before { background: var(--accent-yellow); }
        .stat-card.red::before { background: var(--accent-red); }
        .stat-card.purple::before { background: var(--accent-purple); }

        .stat-card h3 {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-trend {
            font-size: 12px;
            color: var(--accent-green);
            margin-top: 4px;
        }

        .stat-trend.negative { color: var(--accent-red); }

        /* AI Summary Bar */
        .ai-summary-bar {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(96, 165, 250, 0.1));
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .ai-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .ai-message {
            flex: 1;
        }

        .ai-message h4 {
            font-size: 14px;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .ai-message p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .ai-badges {
            display: flex;
            gap: 8px;
        }

        .ai-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ai-badge.warning {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }

        .ai-badge.danger {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }

        .ai-badge.success {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }

        /* Search & Filters */
        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .search-box svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            stroke: var(--text-muted);
        }

        .filter-select {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 140px;
        }

        /* ======================= */
        /* KANBAN VIEW             */
        /* ======================= */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .kanban-column {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            min-width: 280px;
        }

        .column-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .column-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .column-dot.new { background: var(--accent-blue); }
        .column-dot.active { background: var(--accent-green); }
        .column-dot.paused { background: var(--accent-yellow); }
        .column-dot.completed { background: var(--accent-purple); }

        .column-title h3 {
            font-size: 15px;
            font-weight: 600;
        }

        .column-count {
            background: var(--bg-card-hover);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .column-value {
            font-size: 12px;
            color: var(--text-muted);
        }

        .cards-container {
            padding: 12px;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Job Card - Enhanced */
        .job-card {
            background: var(--bg-card-hover);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent;
        }

        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        /* Risk Ring around card */
        .job-card.risk-low { border-color: var(--accent-green); }
        .job-card.risk-medium { border-color: var(--accent-yellow); }
        .job-card.risk-high { border-color: var(--accent-red); }

        /* Margin indicator - left border */
        .job-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 12px;
            bottom: 12px;
            width: 4px;
            border-radius: 2px;
        }

        .job-card.margin-high::before { background: var(--margin-high); }
        .job-card.margin-medium::before { background: var(--margin-medium); }
        .job-card.margin-low::before { background: var(--margin-low); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-client {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Badges Container */
        .card-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: help;
        }

        .badge.ai {
            background: rgba(167, 139, 250, 0.2);
            color: var(--accent-purple);
        }

        .badge.material {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }

        .badge.material.ok {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }

        .badge.finance {
            background: rgba(34, 211, 238, 0.2);
            color: var(--accent-cyan);
        }

        .badge.weather {
            background: rgba(96, 165, 250, 0.2);
            color: var(--accent-blue);
        }

        .badge.overdue {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }

        /* Micro Progress Bars */
        .micro-progress {
            margin: 12px 0;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .progress-label {
            font-size: 11px;
            color: var(--text-muted);
            width: 50px;
        }

        .progress-track {
            flex: 1;
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .progress-fill.time { background: var(--accent-blue); }
        .progress-fill.budget { background: var(--accent-green); }
        .progress-fill.over { background: var(--accent-red); }

        .progress-value {
            font-size: 11px;
            color: var(--text-secondary);
            width: 40px;
            text-align: right;
        }

        /* Card Footer */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .card-team {
            display: flex;
            gap: -8px;
        }

        .team-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 2px solid var(--bg-card-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #000;
            margin-left: -8px;
        }

        .team-avatar:first-child { margin-left: 0; }
        .team-avatar.overload { border-color: var(--accent-red); }

        .card-deadline {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-deadline.urgent { color: var(--accent-red); }
        .card-deadline.soon { color: var(--accent-yellow); }

        /* ======================= */
        /* LIST VIEW               */
        /* ======================= */
        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .list-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .list-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th {
            background: var(--bg-card-hover);
            padding: 14px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        .list-table th:hover {
            color: var(--text-primary);
        }

        .list-table th svg {
            width: 14px;
            height: 14px;
            margin-left: 4px;
            vertical-align: middle;
            opacity: 0.5;
        }

        .list-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .list-table tr:hover td {
            background: var(--bg-card-hover);
        }

        .list-table tr:last-child td {
            border-bottom: none;
        }

        /* List specific cells */
        .cell-job {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cell-job .risk-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .risk-indicator.low { background: var(--accent-green); }
        .risk-indicator.medium { background: var(--accent-yellow); }
        .risk-indicator.high { background: var(--accent-red); }

        .cell-risk {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-bar {
            width: 60px;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }

        .risk-bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .cell-team-load {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .load-indicator {
            width: 50px;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }

        .load-indicator-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .cell-margin {
            font-weight: 600;
        }

        .cell-margin.high { color: var(--margin-high); }
        .cell-margin.medium { color: var(--margin-medium); }
        .cell-margin.low { color: var(--margin-low); }

        .cell-material {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .material-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .material-status.ok {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }

        .material-status.missing {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }

        .cell-weather {
            font-size: 18px;
        }

        .cell-ai-score {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-score-ring {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        /* ======================= */
        /* TIMELINE VIEW           */
        /* ======================= */
        .timeline-view {
            display: none;
        }

        .timeline-view.active {
            display: block;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .timeline-nav {
            display: flex;
            gap: 8px;
        }

        .timeline-nav button {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-nav button:hover,
        .timeline-nav button.active {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .timeline-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .timeline-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
        }

        .timeline-sidebar {
            border-right: 1px solid var(--border);
        }

        .timeline-sidebar-header {
            padding: 16px;
            background: var(--bg-card-hover);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .timeline-job-row {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 60px;
        }

        .timeline-job-info {
            flex: 1;
        }

        .timeline-job-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .timeline-job-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .timeline-job-badges {
            display: flex;
            gap: 4px;
        }

        .timeline-chart {
            overflow-x: auto;
        }

        .timeline-dates {
            display: flex;
            background: var(--bg-card-hover);
            border-bottom: 1px solid var(--border);
        }

        .timeline-date {
            min-width: 40px;
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            border-right: 1px solid var(--border);
        }

        .timeline-date.today {
            background: rgba(74, 222, 128, 0.1);
            color: var(--accent-green);
        }

        .timeline-date.weekend {
            background: rgba(0, 0, 0, 0.2);
        }

        .timeline-bars {
            position: relative;
        }

        .timeline-bar-row {
            height: 60px;
            position: relative;
            border-bottom: 1px solid var(--border);
        }

        .timeline-bar {
            position: absolute;
            top: 12px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            font-weight: 500;
            color: #000;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-bar:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }

        .timeline-bar.status-new { background: var(--accent-blue); }
        .timeline-bar.status-active { background: var(--accent-green); }
        .timeline-bar.status-paused { background: var(--accent-yellow); }
        .timeline-bar.status-completed { background: var(--accent-purple); }

        /* Ghost Plan (AI suggestion) */
        .timeline-bar.ghost {
            opacity: 0.4;
            border: 2px dashed currentColor;
            background: transparent !important;
            color: var(--text-secondary);
        }

        /* Capacity color overlay */
        .timeline-bar.overload::after {
            content: '‚ö†Ô∏è';
            position: absolute;
            right: 8px;
            font-size: 14px;
        }

        /* Today line */
        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent-red);
            z-index: 5;
        }

        .today-line::before {
            content: 'DNES';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--accent-red);
            font-weight: 600;
        }

        /* AI markers on timeline */
        .timeline-ai-marker {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            z-index: 15;
        }

        /* Material marker */
        .timeline-material-marker {
            position: absolute;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 4px;
            background: var(--accent-yellow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* ======================= */
        /* JOB DETAIL MODAL        */
        /* ======================= */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .modal-title h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        /* AI Panel in Modal */
        .ai-panel {
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1), rgba(96, 165, 250, 0.1));
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ai-panel-header h3 {
            font-size: 16px;
            color: var(--accent-purple);
        }

        .ai-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .ai-metric {
            background: rgba(0, 0, 0, 0.2);
            padding: 16px;
            border-radius: 12px;
        }

        .ai-metric-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .ai-metric-value {
            font-size: 24px;
            font-weight: 700;
        }

        .ai-metric-value.warning { color: var(--accent-yellow); }
        .ai-metric-value.danger { color: var(--accent-red); }
        .ai-metric-value.success { color: var(--accent-green); }

        .ai-recommendation {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Detail Grid */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .detail-section {
            background: var(--bg-card-hover);
            border-radius: 16px;
            padding: 20px;
        }

        .detail-section h4 {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Hide views by default */
        #kanban-view { display: grid; }
        #list-view { display: none; }
        #timeline-view { display: none; }

        #kanban-view.active { display: grid; }
        #list-view.active { display: block; }
        #timeline-view.active { display: block; }

        /* Responsive */
        @media (max-width: 1200px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .ai-summary-bar {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
    <link rel="stylesheet" href="/static/css/glass-design.css"/>
  <link rel="stylesheet" href="/static/css/mobile-fix.css">
</head>
<body class="has-sidebar">
  <div id="app-header"></div>
        <div id="app-sidebar"></div>
<header class="app-header">
        <div class="app-header-container">
            <a href="/" class="app-header-brand">
                <img src="/logo.jpg" alt="green david app" class="app-header-logo" onerror="this.src='/logo.svg'"/>
                <div class="app-header-text">
                    <div class="app-header-title">green david app</div>
                    <div class="app-header-subtitle">intern√≠ syst√©m</div>
                </div>
            </a>
            <div class="global-search-container"></div>
            <div class="app-header-actions">
                <div id="userbox" class="app-header-user"></div>
                <a href="/settings.html" class="app-header-settings" title="Nastaven√≠">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m11-9h-6m-6 0H3"/>
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <div class="pulse-dot"></div>
                <h1>Zak√°zky</h1>
            </div>
            <div class="header-actions">
                <div class="view-switcher">
                    <button class="view-btn active" data-view="kanban">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                        </svg>
                        Kanban
                    </button>
                    <button class="view-btn" data-view="list">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"/>
                            <line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <circle cx="4" cy="6" r="1"/>
                            <circle cx="4" cy="12" r="1"/>
                            <circle cx="4" cy="18" r="1"/>
                        </svg>
                        Seznam
                    </button>
                    <button class="view-btn" data-view="timeline">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        Timeline
                    </button>
                </div>
                <button class="btn-secondary" id="btn-filters">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    Filtry
                </button>
                <button class="btn-primary" onclick="openNewJobModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nov√° zak√°zka
                </button>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-grid">
            <div class="stat-card green">
                <h3>Celkov√° hodnota</h3>
                <div class="stat-value" id="stat-total-value">0 Kƒç</div>
                <div class="stat-trend" id="stat-trend">+12% tento mƒõs√≠c</div>
            </div>
            <div class="stat-card blue">
                <h3>Aktivn√≠ zak√°zky</h3>
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-trend">kapacita 78%</div>
            </div>
            <div class="stat-card yellow">
                <h3>Bl√≠≈æ√≠ se deadline</h3>
                <div class="stat-value" id="stat-urgent">0</div>
                <div class="stat-trend negative">do 7 dn√≠</div>
            </div>
            <div class="stat-card red">
                <h3>Rizikov√©</h3>
                <div class="stat-value" id="stat-risky">0</div>
                <div class="stat-trend negative">vy≈æaduje pozornost</div>
            </div>
            <div class="stat-card purple">
                <h3>AI sk√≥re firmy</h3>
                <div class="stat-value" id="stat-ai-score">85</div>
                <div class="stat-trend">zdrav√≠ portfolia</div>
            </div>
        </div>

        <!-- AI Summary Bar -->
        <div class="ai-summary-bar" id="ai-summary">
            <div class="ai-avatar">üß†</div>
            <div class="ai-message">
                <h4>AI Oper√°tor ≈ô√≠k√°:</h4>
                <p id="ai-message-text">Analyzuji zak√°zky...</p>
            </div>
            <div class="ai-badges" id="ai-badges">
                <!-- Badges will be inserted here -->
            </div>
        </div>

        <!-- Filters Bar -->
        <div class="filters-bar">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="search-input" placeholder="Hledat zak√°zky...">
            </div>
            <select class="filter-select" id="filter-status">
                <option value="">V≈°echny stavy</option>
                <option value="new">Nov√©</option>
                <option value="active">Aktivn√≠</option>
                <option value="paused">Pozastaven√©</option>
                <option value="completed">Dokonƒçen√©</option>
            </select>
            <select class="filter-select" id="filter-risk">
                <option value="">V≈°echna rizika</option>
                <option value="low">N√≠zk√© riziko</option>
                <option value="medium">St≈ôedn√≠ riziko</option>
                <option value="high">Vysok√© riziko</option>
            </select>
            <select class="filter-select" id="filter-margin">
                <option value="">V≈°echny mar≈æe</option>
                <option value="high">Vysok√° mar≈æe (&gt;30%)</option>
                <option value="medium">St≈ôedn√≠ mar≈æe (15-30%)</option>
                <option value="low">N√≠zk√° mar≈æe (&lt;15%)</option>
            </select>
        </div>

        <!-- KANBAN VIEW -->
        <div id="kanban-view" class="kanban-board active">
            <div class="kanban-column" data-status="new">
                <div class="column-header">
                    <div class="column-title">
                        <div class="column-dot new"></div>
                        <h3>Nov√©</h3>
                        <span class="column-count" id="count-new">0</span>
                    </div>
                    <span class="column-value" id="value-new">0 Kƒç</span>
                </div>
                <div class="cards-container" id="cards-new"></div>
            </div>
            <div class="kanban-column" data-status="active">
                <div class="column-header">
                    <div class="column-title">
                        <div class="column-dot active"></div>
                        <h3>Aktivn√≠</h3>
                        <span class="column-count" id="count-active">0</span>
                    </div>
                    <span class="column-value" id="value-active">0 Kƒç</span>
                </div>
                <div class="cards-container" id="cards-active"></div>
            </div>
            <div class="kanban-column" data-status="paused">
                <div class="column-header">
                    <div class="column-title">
                        <div class="column-dot paused"></div>
                        <h3>Pozastaven√©</h3>
                        <span class="column-count" id="count-paused">0</span>
                    </div>
                    <span class="column-value" id="value-paused">0 Kƒç</span>
                </div>
                <div class="cards-container" id="cards-paused"></div>
            </div>
            <div class="kanban-column" data-status="completed">
                <div class="column-header">
                    <div class="column-title">
                        <div class="column-dot completed"></div>
                        <h3>Dokonƒçen√©</h3>
                        <span class="column-count" id="count-completed">0</span>
                    </div>
                    <span class="column-value" id="value-completed">0 Kƒç</span>
                </div>
                <div class="cards-container" id="cards-completed"></div>
            </div>
        </div>

        <!-- LIST VIEW -->
        <div id="list-view" class="list-view">
            <div class="list-table">
                <table>
                    <thead>
                        <tr>
                            <th>Zak√°zka</th>
                            <th>Klient</th>
                            <th>Riziko</th>
                            <th>T√Ωm</th>
                            <th>Mar≈æe</th>
                            <th>AI</th>
                            <th>Materi√°l</th>
                            <th>Poƒças√≠</th>
                            <th>Deadline</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="list-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TIMELINE VIEW -->
        <div id="timeline-view" class="timeline-view">
            <div class="timeline-header">
                <div class="timeline-nav">
                    <button class="active" data-zoom="month">Mƒõs√≠c</button>
                    <button data-zoom="quarter">Kvart√°l</button>
                    <button data-zoom="year">Rok</button>
                </div>
                <div class="timeline-nav">
                    <button id="timeline-prev">‚Üê P≈ôedchoz√≠</button>
                    <button id="timeline-today">Dnes</button>
                    <button id="timeline-next">Dal≈°√≠ ‚Üí</button>
                </div>
            </div>
            <div class="timeline-container" id="timeline-container">
                <!-- Timeline will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal-overlay" id="job-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <div class="risk-indicator" id="modal-risk-indicator"></div>
                    <h2 id="modal-job-title">Detail zak√°zky</h2>
                </div>
                <button class="modal-close" onclick="closeJobModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // DATA & STATE
        // =============================================
        let jobs = [];
        let filteredJobs = [];
        let employees = [];
        let warehouse = [];
        let weather = null;
        let aiInsights = [];
        let currentView = 'kanban';
        let timelineZoom = 'month';
        let timelineOffset = 0;

        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            setupEventListeners();
            render();
        });

        async function loadAllData() {
            try {
                // Load jobs
                const jobsRes = await fetch('/api/jobs');
                jobs = await jobsRes.json();
                
                // Enrich jobs with calculated fields
                jobs = jobs.map(enrichJob);
                filteredJobs = [...jobs];

                // Load employees
                try {
                    const empRes = await fetch('/api/employees');
                    employees = await empRes.json();
                } catch(e) { employees = []; }

                // Load warehouse
                try {
                    const whRes = await fetch('/api/warehouse/items');
                    warehouse = await whRes.json();
                } catch(e) { warehouse = []; }

                // Load weather
                try {
                    const weatherRes = await fetch('/api/weather');
                    weather = await weatherRes.json();
                } catch(e) { weather = null; }

                // Load AI insights
                try {
                    const aiRes = await fetch('/api/ai/insights?status=new');
                    aiInsights = await aiRes.json();
                } catch(e) { aiInsights = []; }

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Enrich job with calculated AI fields
        function enrichJob(job) {
            const now = new Date();
            const deadline = job.deadline ? new Date(job.deadline) : null;
            const startDate = job.start_date ? new Date(job.start_date) : null;

            // Days until deadline
            const daysUntil = deadline ? Math.ceil((deadline - now) / (1000 * 60 * 60 * 24)) : null;

            // Progress calculation
            const progress = job.progress || 0;

            // Time progress (how much time has passed)
            let timeProgress = 0;
            if (startDate && deadline) {
                const totalDays = (deadline - startDate) / (1000 * 60 * 60 * 24);
                const elapsedDays = (now - startDate) / (1000 * 60 * 60 * 24);
                timeProgress = Math.min(100, Math.max(0, (elapsedDays / totalDays) * 100));
            }

            // Budget calculation
            const budgetTotal = (job.budget_labor || 0) + (job.budget_material || 0);
            const budgetSpent = (job.spent_labor || 0) + (job.spent_material || 0);
            const budgetProgress = budgetTotal > 0 ? (budgetSpent / budgetTotal) * 100 : 0;

            // Margin calculation
            const estimatedValue = job.estimated_value || job.budget || 0;
            const margin = estimatedValue > 0 ? ((estimatedValue - budgetSpent) / estimatedValue) * 100 : 0;
            let marginLevel = 'medium';
            if (margin > 30) marginLevel = 'high';
            else if (margin < 15) marginLevel = 'low';

            // Risk calculation (0-100)
            let riskScore = 0;
            
            // Time risk
            if (daysUntil !== null) {
                if (daysUntil < 0) riskScore += 40; // overdue
                else if (daysUntil < 3) riskScore += 30;
                else if (daysUntil < 7) riskScore += 15;
            }

            // Progress vs time risk
            if (timeProgress > 0 && progress < timeProgress - 20) {
                riskScore += 25; // behind schedule
            }

            // Budget risk
            if (budgetProgress > 100) riskScore += 25;
            else if (budgetProgress > 80 && progress < 80) riskScore += 15;

            // Determine risk level
            let riskLevel = 'low';
            if (riskScore >= 50) riskLevel = 'high';
            else if (riskScore >= 25) riskLevel = 'medium';

            // AI score (inverse of risk, 0-100)
            const aiScore = Math.max(0, 100 - riskScore);

            // Material status (simplified - would connect to real reservations)
            const materialStatus = Math.random() > 0.3 ? 'ok' : 'missing';

            // Weather risk for outdoor jobs
            let weatherRisk = false;
            let weatherIcon = '‚òÄÔ∏è';
            if (weather && job.type !== 'indoor') {
                if (weather.rain_chance > 50) {
                    weatherRisk = true;
                    weatherIcon = 'üåßÔ∏è';
                } else if (weather.temperature < 0) {
                    weatherRisk = true;
                    weatherIcon = '‚ùÑÔ∏è';
                } else if (weather.wind > 10) {
                    weatherIcon = 'üí®';
                }
            }

            // Team load
            const teamSize = job.team?.length || 0;
            const teamLoad = teamSize > 0 ? Math.min(100, (job.estimated_hours || 40) / (teamSize * 40) * 100) : 0;

            // Has AI recommendations
            const hasAiRecommendation = aiInsights.some(i => i.entity_id === job.id && i.entity_type === 'job');

            return {
                ...job,
                daysUntil,
                progress,
                timeProgress,
                budgetTotal,
                budgetSpent,
                budgetProgress,
                margin,
                marginLevel,
                riskScore,
                riskLevel,
                aiScore,
                materialStatus,
                weatherRisk,
                weatherIcon,
                teamLoad,
                hasAiRecommendation
            };
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        function setupEventListeners() {
            // View switcher
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    
                    document.getElementById('kanban-view').classList.remove('active');
                    document.getElementById('list-view').classList.remove('active');
                    document.getElementById('timeline-view').classList.remove('active');
                    document.getElementById(`${currentView}-view`).classList.add('active');
                    
                    render();
                });
            });

            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                applyFilters();
            });

            // Filters
            document.getElementById('filter-status').addEventListener('change', applyFilters);
            document.getElementById('filter-risk').addEventListener('change', applyFilters);
            document.getElementById('filter-margin').addEventListener('change', applyFilters);

            // Timeline zoom
            document.querySelectorAll('.timeline-nav button[data-zoom]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.timeline-nav button[data-zoom]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    timelineZoom = btn.dataset.zoom;
                    renderTimeline();
                });
            });

            // Timeline navigation
            document.getElementById('timeline-prev')?.addEventListener('click', () => {
                timelineOffset--;
                renderTimeline();
            });
            document.getElementById('timeline-next')?.addEventListener('click', () => {
                timelineOffset++;
                renderTimeline();
            });
            document.getElementById('timeline-today')?.addEventListener('click', () => {
                timelineOffset = 0;
                renderTimeline();
            });
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('filter-status').value;
            const risk = document.getElementById('filter-risk').value;
            const margin = document.getElementById('filter-margin').value;

            filteredJobs = jobs.filter(job => {
                // Search
                if (search && !job.title?.toLowerCase().includes(search) && 
                    !job.client?.toLowerCase().includes(search)) {
                    return false;
                }
                // Status
                if (status && job.status !== status) return false;
                // Risk
                if (risk && job.riskLevel !== risk) return false;
                // Margin
                if (margin && job.marginLevel !== margin) return false;

                return true;
            });

            render();
        }

        // =============================================
        // RENDER
        // =============================================
        function render() {
            updateStats();
            updateAISummary();

            switch(currentView) {
                case 'kanban':
                    renderKanban();
                    break;
                case 'list':
                    renderList();
                    break;
                case 'timeline':
                    renderTimeline();
                    break;
            }
        }

        function updateStats() {
            const activeJobs = filteredJobs.filter(j => j.status === 'active');
            const totalValue = filteredJobs.reduce((sum, j) => sum + (j.budget || j.estimated_value || 0), 0);
            const urgentJobs = filteredJobs.filter(j => j.daysUntil !== null && j.daysUntil <= 7 && j.daysUntil >= 0);
            const riskyJobs = filteredJobs.filter(j => j.riskLevel === 'high');
            const avgAiScore = filteredJobs.length > 0 ? 
                Math.round(filteredJobs.reduce((sum, j) => sum + j.aiScore, 0) / filteredJobs.length) : 0;

            document.getElementById('stat-total-value').textContent = formatCurrency(totalValue);
            document.getElementById('stat-active').textContent = activeJobs.length;
            document.getElementById('stat-urgent').textContent = urgentJobs.length;
            document.getElementById('stat-risky').textContent = riskyJobs.length;
            document.getElementById('stat-ai-score').textContent = avgAiScore;
        }

        function updateAISummary() {
            const riskyJobs = filteredJobs.filter(j => j.riskLevel === 'high');
            const overdueJobs = filteredJobs.filter(j => j.daysUntil !== null && j.daysUntil < 0);
            const materialIssues = filteredJobs.filter(j => j.materialStatus === 'missing');

            let message = 'V≈°e v po≈ô√°dku! Portfolio zak√°zek je zdrav√©.';
            let badges = [];

            if (overdueJobs.length > 0) {
                message = `${overdueJobs.length} zak√°zek po term√≠nu vy≈æaduje okam≈æitou pozornost.`;
                badges.push({ type: 'danger', text: `${overdueJobs.length} po term√≠nu`, icon: '‚è∞' });
            } else if (riskyJobs.length > 0) {
                message = `${riskyJobs.length} zak√°zek m√° zv√Ω≈°en√© riziko. Doporuƒçuji provƒõ≈ôit.`;
                badges.push({ type: 'warning', text: `${riskyJobs.length} rizikov√Ωch`, icon: '‚ö†Ô∏è' });
            }

            if (materialIssues.length > 0) {
                badges.push({ type: 'warning', text: `${materialIssues.length} chyb√≠ materi√°l`, icon: 'üì¶' });
            }

            document.getElementById('ai-message-text').textContent = message;
            
            const badgesContainer = document.getElementById('ai-badges');
            badgesContainer.innerHTML = badges.map(b => `
                <span class="ai-badge ${b.type}">${b.icon} ${b.text}</span>
            `).join('');
        }

        // =============================================
        // KANBAN RENDER
        // =============================================
        function renderKanban() {
            const statuses = ['new', 'active', 'paused', 'completed'];
            
            statuses.forEach(status => {
                const container = document.getElementById(`cards-${status}`);
                const statusJobs = filteredJobs.filter(j => j.status === status);
                const totalValue = statusJobs.reduce((sum, j) => sum + (j.budget || j.estimated_value || 0), 0);

                document.getElementById(`count-${status}`).textContent = statusJobs.length;
                document.getElementById(`value-${status}`).textContent = formatCurrency(totalValue);

                container.innerHTML = statusJobs.map(job => createJobCard(job)).join('');
            });
        }

        function createJobCard(job) {
            const teamAvatars = (job.team || []).slice(0, 3).map((member, i) => {
                const initials = member.name ? member.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                const overload = member.hours > 45 ? 'overload' : '';
                return `<div class="team-avatar ${overload}" title="${member.name || 'ƒålen'}">${initials}</div>`;
            }).join('');

            const deadlineClass = job.daysUntil < 0 ? 'urgent' : job.daysUntil <= 7 ? 'soon' : '';
            const deadlineText = job.daysUntil === null ? '‚Äî' : 
                job.daysUntil < 0 ? `${Math.abs(job.daysUntil)}d po term√≠nu` : 
                `${job.daysUntil}d`;

            return `
                <div class="job-card risk-${job.riskLevel} margin-${job.marginLevel}" 
                     onclick="openJobModal(${job.id})" data-job-id="${job.id}">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${escapeHtml(job.title || 'Bez n√°zvu')}</div>
                            <div class="card-client">${escapeHtml(job.client || '‚Äî')}</div>
                        </div>
                        <div class="card-badges">
                            ${job.hasAiRecommendation ? '<div class="badge ai" title="AI doporuƒçen√≠">üß†</div>' : ''}
                            ${job.materialStatus === 'missing' ? '<div class="badge material" title="Chyb√≠ materi√°l">üì¶</div>' : '<div class="badge material ok" title="Materi√°l OK">‚úì</div>'}
                            ${job.budgetProgress > 80 ? '<div class="badge finance" title="Rozpoƒçet">üí∏</div>' : ''}
                            ${job.weatherRisk ? '<div class="badge weather" title="Poƒças√≠">' + job.weatherIcon + '</div>' : ''}
                            ${job.daysUntil < 0 ? '<div class="badge overdue" title="Po term√≠nu">!</div>' : ''}
                        </div>
                    </div>
                    
                    <div class="micro-progress">
                        <div class="progress-row">
                            <span class="progress-label">ƒåas</span>
                            <div class="progress-track">
                                <div class="progress-fill time" style="width: ${job.timeProgress}%"></div>
                            </div>
                            <span class="progress-value">${Math.round(job.timeProgress)}%</span>
                        </div>
                        <div class="progress-row">
                            <span class="progress-label">Rozpoƒçet</span>
                            <div class="progress-track">
                                <div class="progress-fill ${job.budgetProgress > 100 ? 'over' : 'budget'}" style="width: ${Math.min(100, job.budgetProgress)}%"></div>
                            </div>
                            <span class="progress-value">${Math.round(job.budgetProgress)}%</span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="card-team">
                            ${teamAvatars || '<span style="color: var(--text-muted); font-size: 12px;">Nep≈ôi≈ôazeno</span>'}
                        </div>
                        <div class="card-deadline ${deadlineClass}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <rect x="3" y="4" width="18" height="18" rx="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            ${deadlineText}
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // LIST RENDER
        // =============================================
        function renderList() {
            const tbody = document.getElementById('list-tbody');
            
            tbody.innerHTML = filteredJobs.map(job => {
                const riskColor = job.riskLevel === 'high' ? 'var(--accent-red)' : 
                    job.riskLevel === 'medium' ? 'var(--accent-yellow)' : 'var(--accent-green)';
                
                const loadColor = job.teamLoad > 100 ? 'var(--accent-red)' : 
                    job.teamLoad > 80 ? 'var(--accent-yellow)' : 'var(--accent-green)';

                const aiScoreColor = job.aiScore >= 70 ? 'var(--accent-green)' : 
                    job.aiScore >= 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';

                return `
                    <tr onclick="openJobModal(${job.id})" style="cursor: pointer;">
                        <td>
                            <div class="cell-job">
                                <div class="risk-indicator ${job.riskLevel}"></div>
                                <div>
                                    <strong>${escapeHtml(job.title || 'Bez n√°zvu')}</strong>
                                    <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(job.address || '‚Äî')}</div>
                                </div>
                            </div>
                        </td>
                        <td>${escapeHtml(job.client || '‚Äî')}</td>
                        <td>
                            <div class="cell-risk">
                                <div class="risk-bar">
                                    <div class="risk-bar-fill" style="width: ${job.riskScore}%; background: ${riskColor};"></div>
                                </div>
                                <span>${job.riskScore}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="cell-team-load">
                                <div class="load-indicator">
                                    <div class="load-indicator-fill" style="width: ${Math.min(100, job.teamLoad)}%; background: ${loadColor};"></div>
                                </div>
                                <span>${Math.round(job.teamLoad)}%</span>
                            </div>
                        </td>
                        <td class="cell-margin ${job.marginLevel}">${Math.round(job.margin)}%</td>
                        <td>
                            <div class="cell-ai-score">
                                <div class="ai-score-ring" style="background: ${aiScoreColor}20; color: ${aiScoreColor};">
                                    ${job.aiScore}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="material-status ${job.materialStatus}">
                                ${job.materialStatus === 'ok' ? '‚úì OK' : '‚ö† Chyb√≠'}
                            </span>
                        </td>
                        <td class="cell-weather">${job.weatherIcon}</td>
                        <td>
                            <span class="${job.daysUntil < 0 ? 'deadline-badge urgent' : job.daysUntil <= 7 ? 'deadline-badge soon' : ''}">
                                ${formatDate(job.deadline)}
                            </span>
                        </td>
                        <td>
                            <button class="btn-secondary" onclick="event.stopPropagation(); openJobModal(${job.id})">Detail</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // =============================================
        // TIMELINE RENDER
        // =============================================
        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const today = new Date();
            
            // Calculate date range based on zoom
            let startDate, endDate, dayWidth;
            if (timelineZoom === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth() + timelineOffset, 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + timelineOffset + 1, 0);
                dayWidth = 40;
            } else if (timelineZoom === 'quarter') {
                const quarter = Math.floor(today.getMonth() / 3) + timelineOffset;
                startDate = new Date(today.getFullYear(), quarter * 3, 1);
                endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
                dayWidth = 15;
            } else {
                startDate = new Date(today.getFullYear() + timelineOffset, 0, 1);
                endDate = new Date(today.getFullYear() + timelineOffset, 11, 31);
                dayWidth = 3;
            }

            // Generate days
            const days = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                days.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const totalWidth = days.length * dayWidth;

            // Calculate today position
            const todayOffset = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const todayPosition = todayOffset * dayWidth;

            // Jobs with timeline data
            const timelineJobs = filteredJobs.filter(j => j.deadline).map(job => {
                const deadline = new Date(job.deadline);
                const start = job.start_date ? new Date(job.start_date) : 
                    new Date(deadline.getTime() - 14 * 24 * 60 * 60 * 1000);
                
                const startOffset = Math.max(0, Math.floor((start - startDate) / (1000 * 60 * 60 * 24)));
                const endOffset = Math.floor((deadline - startDate) / (1000 * 60 * 60 * 24));
                const width = Math.max(dayWidth, (endOffset - startOffset + 1) * dayWidth);

                return { ...job, startOffset, endOffset, width, startPx: startOffset * dayWidth };
            });

            // Build HTML
            let html = '<div class="timeline-grid">';
            
            // Sidebar
            html += '<div class="timeline-sidebar">';
            html += '<div class="timeline-sidebar-header">Zak√°zka</div>';
            timelineJobs.forEach(job => {
                html += `
                    <div class="timeline-job-row">
                        <div class="risk-indicator ${job.riskLevel}"></div>
                        <div class="timeline-job-info">
                            <div class="timeline-job-title">${escapeHtml(job.title || 'Bez n√°zvu')}</div>
                            <div class="timeline-job-meta">${escapeHtml(job.client || '‚Äî')}</div>
                        </div>
                        <div class="timeline-job-badges">
                            ${job.hasAiRecommendation ? '<div class="badge ai">üß†</div>' : ''}
                            ${job.materialStatus === 'missing' ? '<div class="badge material">üì¶</div>' : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            // Chart area
            html += '<div class="timeline-chart" style="overflow-x: auto;">';
            
            // Date headers
            html += '<div class="timeline-dates" style="width: ' + totalWidth + 'px;">';
            days.forEach((day, i) => {
                const isToday = day.toDateString() === today.toDateString();
                const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                html += `<div class="timeline-date ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}" style="width: ${dayWidth}px;">
                    ${day.getDate()}
                </div>`;
            });
            html += '</div>';

            // Bars
            html += '<div class="timeline-bars" style="width: ' + totalWidth + 'px; position: relative;">';
            
            // Today line
            if (todayOffset >= 0 && todayOffset < days.length) {
                html += `<div class="today-line" style="left: ${todayPosition}px;"></div>`;
            }

            timelineJobs.forEach(job => {
                const barClass = `status-${job.status}`;
                const overloadClass = job.teamLoad > 100 ? 'overload' : '';
                
                html += `
                    <div class="timeline-bar-row">
                        <div class="timeline-bar ${barClass} ${overloadClass}" 
                             style="left: ${job.startPx}px; width: ${job.width}px;"
                             onclick="openJobModal(${job.id})"
                             title="${escapeHtml(job.title)}">
                            ${job.width > 80 ? escapeHtml(job.title?.substring(0, 15) || '') : ''}
                            ${job.hasAiRecommendation ? '<div class="timeline-ai-marker" style="right: -10px;">üß†</div>' : ''}
                            ${job.materialStatus === 'missing' ? '<div class="timeline-material-marker" style="right: 10px;">üì¶</div>' : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div></div></div>';

            container.innerHTML = html;
        }

        // =============================================
        // JOB DETAIL MODAL
        // =============================================
        function openJobModal(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            document.getElementById('modal-job-title').textContent = job.title || 'Detail zak√°zky';
            document.getElementById('modal-risk-indicator').className = `risk-indicator ${job.riskLevel}`;

            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <!-- AI Panel -->
                <div class="ai-panel">
                    <div class="ai-panel-header">
                        <div class="ai-avatar" style="width: 40px; height: 40px; font-size: 20px;">üß†</div>
                        <h3>AI Anal√Ωza zak√°zky</h3>
                    </div>
                    <div class="ai-metrics">
                        <div class="ai-metric">
                            <div class="ai-metric-label">Riziko term√≠nu</div>
                            <div class="ai-metric-value ${job.riskScore > 50 ? 'danger' : job.riskScore > 25 ? 'warning' : 'success'}">${job.riskScore}%</div>
                        </div>
                        <div class="ai-metric">
                            <div class="ai-metric-label">AI Sk√≥re</div>
                            <div class="ai-metric-value ${job.aiScore >= 70 ? 'success' : job.aiScore >= 40 ? 'warning' : 'danger'}">${job.aiScore}</div>
                        </div>
                        <div class="ai-metric">
                            <div class="ai-metric-label">Mar≈æe</div>
                            <div class="ai-metric-value ${job.marginLevel === 'high' ? 'success' : job.marginLevel === 'low' ? 'danger' : 'warning'}">${Math.round(job.margin)}%</div>
                        </div>
                        <div class="ai-metric">
                            <div class="ai-metric-label">Materi√°l</div>
                            <div class="ai-metric-value ${job.materialStatus === 'ok' ? 'success' : 'danger'}">${job.materialStatus === 'ok' ? 'OK' : 'Chyb√≠'}</div>
                        </div>
                    </div>
                    ${job.riskScore > 25 || job.materialStatus === 'missing' ? `
                        <div class="ai-recommendation">
                            <span>üí°</span>
                            <span>Doporuƒçen√≠: ${getAIRecommendation(job)}</span>
                        </div>
                    ` : ''}
                </div>

                <!-- Detail Grid -->
                <div class="detail-grid">
                    <!-- Finance Section -->
                    <div class="detail-section">
                        <h4>Finance</h4>
                        <div class="detail-row">
                            <span class="detail-label">Celkov√° hodnota</span>
                            <span class="detail-value">${formatCurrency(job.estimated_value || job.budget || 0)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rozpoƒçet pr√°ce</span>
                            <span class="detail-value">${formatCurrency(job.budget_labor || 0)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rozpoƒçet materi√°l</span>
                            <span class="detail-value">${formatCurrency(job.budget_material || 0)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Spot≈ôebov√°no</span>
                            <span class="detail-value">${formatCurrency(job.budgetSpent)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mar≈æe</span>
                            <span class="detail-value cell-margin ${job.marginLevel}">${Math.round(job.margin)}%</span>
                        </div>
                    </div>

                    <!-- Timeline Section -->
                    <div class="detail-section">
                        <h4>ƒåasov√° osa</h4>
                        <div class="detail-row">
                            <span class="detail-label">Zaƒç√°tek</span>
                            <span class="detail-value">${formatDate(job.start_date)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Deadline</span>
                            <span class="detail-value">${formatDate(job.deadline)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Zb√Ωv√°</span>
                            <span class="detail-value ${job.daysUntil < 0 ? 'cell-margin low' : ''}">${job.daysUntil !== null ? (job.daysUntil < 0 ? `${Math.abs(job.daysUntil)} dn√≠ po term√≠nu` : `${job.daysUntil} dn√≠`) : '‚Äî'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progres ƒçasu</span>
                            <span class="detail-value">${Math.round(job.timeProgress)}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progres pr√°ce</span>
                            <span class="detail-value">${job.progress}%</span>
                        </div>
                    </div>

                    <!-- Team Section -->
                    <div class="detail-section">
                        <h4>üë• T√Ωm</h4>
                        ${(job.team || []).length > 0 ? (job.team || []).map(member => `
                            <div class="detail-row">
                                <span class="detail-label">${escapeHtml(member.name || 'ƒålen')}</span>
                                <span class="detail-value">${member.hours || 0}h</span>
                            </div>
                        `).join('') : '<div style="color: var(--text-muted);">Nep≈ôi≈ôazeno</div>'}
                        <div class="detail-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <span class="detail-label">Vyt√≠≈æen√≠ t√Ωmu</span>
                            <span class="detail-value ${job.teamLoad > 100 ? 'cell-margin low' : ''}">${Math.round(job.teamLoad)}%</span>
                        </div>
                    </div>

                    <!-- Material Section -->
                    <div class="detail-section">
                        <h4>Materi√°l</h4>
                        <div class="detail-row">
                            <span class="detail-label">Stav</span>
                            <span class="material-status ${job.materialStatus}">${job.materialStatus === 'ok' ? '‚úì V≈°e skladem' : '‚ö† Chyb√≠ polo≈æky'}</span>
                        </div>
                        <div style="margin-top: 16px; color: var(--text-muted); font-size: 13px;">
                            <a href="/warehouse.html?job=${job.id}" style="color: var(--accent-blue);">‚Üí Zobrazit rezervace ve skladu</a>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="window.location.href='/jobs.html?edit=${job.id}'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Upravit
                    </button>
                    <button class="btn-primary" onclick="window.location.href='/job-detail.html?id=${job.id}'">
                        Otev≈ô√≠t detail ‚Üí
                    </button>
                </div>
            `;

            document.getElementById('job-modal').classList.add('active');
        }

        function closeJobModal() {
            document.getElementById('job-modal').classList.remove('active');
        }

        function getAIRecommendation(job) {
            if (job.daysUntil < 0) {
                return `Zak√°zka je ${Math.abs(job.daysUntil)} dn√≠ po term√≠nu. Kontaktujte klienta.`;
            }
            if (job.materialStatus === 'missing') {
                return 'Chyb√≠ materi√°l. Zkontrolujte sklad a objednejte.';
            }
            if (job.teamLoad > 100) {
                return 'T√Ωm je p≈ôet√≠≈æen√Ω. Zva≈æte p≈ôesun term√≠nu nebo pos√≠len√≠.';
            }
            if (job.budgetProgress > 80 && job.progress < 60) {
                return 'Rozpoƒçet je t√©mƒõ≈ô vyƒçerp√°n, ale pr√°ce nen√≠ dokonƒçena.';
            }
            if (job.riskScore > 50) {
                return 'Vysok√© riziko nedodr≈æen√≠ term√≠nu. Provƒõ≈ôte kapacity.';
            }
            return 'Zva≈æte optimalizaci zdroj≈Ø.';
        }

        function openNewJobModal() {
            window.location.href = '/jobs.html?new=1';
        }

        // Close modal on outside click
        document.getElementById('job-modal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeJobModal();
            }
        });

        // =============================================
        // UTILITIES
        // =============================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('cs-CZ', { 
                style: 'currency', 
                currency: 'CZK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const date = new Date(dateStr);
            return date.toLocaleDateString('cs-CZ');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
    <script src="/static/app-sidebar.js"></script>
</body>
</html>
