<!doctype html>
<html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Green David App</title><link rel="stylesheet" href="style.css"></head>
<body>
<div class="header"><div class="brand container"><img class="brand-logo" src="logo.svg" alt="logo"><div><div class="brand-title">Green David</div><div class="brand-sub">Zakázky • Úkoly • Sklad • Kalendář</div></div><div class="right"><div class="badge">Verze 2025</div></div></div></div>
<div class="container" id="app"></div>
<div class="footer"><div id="footer-user">Nepřihlášen</div><div style="margin-top:6px;font-size:12px;color:#6c7a72">© 2025 Green David</div></div>
<script>
const h=(t,p={},...c)=>{const e=document.createElement(t);for(const[k,v]of Object.entries(p||{})){if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.substring(2),v);else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v)}for(const x of c.flat()){if(x==null)continue;if(typeof x==='string')e.appendChild(document.createTextNode(x));else e.appendChild(x)}return e};
const api=(u,o={})=>fetch(u,{credentials:'same-origin',headers:{'Content-Type':'application/json'},...o}).then(async r=>{const ct=r.headers.get('Content-Type')||'';const b=ct.includes('application/json')?await r.json():await r.text();if(!r.ok)throw new Error((b&&b.error)||r.statusText);return b});
const toISODateFlex=v=>{if(!v)return v;const d=String(v).replace(/\\D+/g,'');if(d.length!==8)return v;const yFirst=parseInt(d.slice(0,4),10);let y,m,day;if(yFirst>=1900&&yFirst<=2100){y=yFirst;m=parseInt(d.slice(4,6),10);day=parseInt(d.slice(6,8),10)}else{day=parseInt(d.slice(0,2),10);m=parseInt(d.slice(2,4),10);y=parseInt(d.slice(4,8),10)}const pad=n=>String(n).padStart(2,'0');return `${y}-${pad(m)}-${pad(day)}`};
const toCZ=iso=>{if(!iso)return'';const m=String(iso).match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);if(!m)return iso;const[_,y,mm,dd]=m;return `${dd}.${mm}.${y}`};
const MONTHS=["leden","únor","březen","duben","květen","červen","červenec","srpen","září","říjen","listopad","prosinec"];const DOWS=["Po","Út","St","Čt","Pá","So","Ne"];
let state={me:null,tab:'calendar',events:[],jobs:[],tasks:[],items:[],notes:[],employees:[]};
function setFooterUser(){const f=document.getElementById('footer-user');if(!state.me||!state.me.authenticated)f.textContent='Nepřihlášen';else f.textContent=`Přihlášen: ${state.me.user.name} (${state.me.user.role})`}
async function boot(){try{state.me=await api('/api/me');if(!state.me.authenticated){renderLogin();return}setFooterUser();renderApp()}catch(e){document.getElementById('app').innerHTML='<div class="error-overlay">Chyba: '+e.message+'</div>'}}
function renderLogin(){const el=h('div',{},h('div',{class:'card'},h('div',{class:'card-h'},'Přihlášení'),h('div',{class:'card-c'},h('form',{onsubmit:async e=>{e.preventDefault();const email=e.target.email.value.trim();const password=e.target.password.value;try{await api('/api/login',{method:'POST',body:JSON.stringify({email,password})});state.me=await api('/api/me');setFooterUser();renderApp()}catch(err){alert('Nepodařilo se přihlásit')}}},h('div',{class:'form-row'},h('input',{type:'email',name:'email',placeholder:'E-mail',value:'admin@greendavid.local',required:true}),h('input',{type:'password',name:'password',placeholder:'Heslo',value:'admin123',required:true}),h('button',{type:'submit'},'Přihlásit'))))));const root=document.getElementById('app');root.innerHTML='';root.appendChild(el)}
function tabs(){const t=['calendar','jobs','tasks','items','employees','notes'];const L={calendar:'Kalendář',jobs:'Zakázky',tasks:'Úkoly',items:'Sklad',employees:'Zaměstnanci',notes:'Poznámky'};return h('div',{class:'tabs'},...t.map(k=>h('div',{class:'tab'+(state.tab===k?' active':''),onclick:()=>{state.tab=k;renderApp()}},L[k])))}
async function loadCalendar(y,m){const first=new Date(y,m,1),next=new Date(y,m+1,1);const from=`${first.getFullYear()}-${String(m+1).padStart(2,'0')}-01`;const to=`${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}-01`;const res=await api(`/api/calendar?from=${from}&to=${to}`);state.events=res.events||[]}
function dayEvents(iso){return state.events.filter(e=>e.date===iso)}
function Calendar(){const today=new Date();let y=Calendar._y??today.getFullYear();let m=Calendar._m??today.getMonth();const head=h('div',{class:'card'},h('div',{class:'card-h'},h('div',{},`${MONTHS[m]} ${y}`),h('div',{},h('button',{class:'ghost',onclick:async()=>{if(--m<0){m=11;y--}Calendar._y=y;Calendar._m=m;await loadCalendar(y,m);renderApp()}},'◀'),h('button',{style:'margin-left:8px',onclick:async()=>{if(++m>11){m=0;y++}Calendar._y=y;Calendar._m=m;await loadCalendar(y,m);renderApp()}},'▶'))),h('div',{class:'card-c'},h('div',{class:'cal-grid-head'},...DOWS.map(d=>h('div',{},d))),(function(){const grid=h('div',{class:'cal-grid'});const firstDay=new Date(y,m,1);const startOffset=(firstDay.getDay()+6)%7;let day=1-startOffset;for(let i=0;i<42;i++){const cellDate=new Date(y,m,day);const iso=`${cellDate.getFullYear()}-${String(cellDate.getMonth()+1).padStart(2,'0')}-${String(cellDate.getDate()).padStart(2,'0')}`;const inMonth=cellDate.getMonth()===m;const cell=h('div',{class:'cal-cell'+(inMonth?'':' dim')},h('div',{class:'cal-day'},String(cellDate.getDate())),...dayEvents(iso).slice(0,3).map(ev=>h('div',{class:'cal-pill '+(ev.kind)},ev.title)));cell.addEventListener('click',()=>{const evs=dayEvents(iso);alert(evs.length?evs.map(e=>'• '+e.title).join('\\n'):'Žádné události')});grid.appendChild(cell);day++}return grid})()));loadCalendar(y,m).then(()=>{});return head}
async function loadJobs(){state.jobs=(await api('/api/jobs')).jobs||[]}
function Jobs(){const el=h('div',{class:'card'},h('div',{class:'card-h'},'Zakázky'),h('div',{class:'card-c'},h('form',{class:'form-row',onsubmit:async e=>{e.preventDefault();const form=Object.fromEntries(new FormData(e.target).entries());form.date=toISODateFlex(form.date);try{await api('/api/jobs',{method:'POST',body:JSON.stringify(form)});e.target.reset();await loadJobs();renderApp()}catch(err){alert('Chyba: '+err.message)}}},h('input',{name:'title',placeholder:'Název',required:true}),h('input',{name:'client',placeholder:'Zákazník',required:true}),h('select',{name:'status'},h('option',{value:'Plán'},'Plán'),h('option',{value:'Probíhá'},'Probíhá'),h('option',{value:'Dokončeno'},'Dokončeno')),h('input',{name:'city',placeholder:'Město',required:true}),h('input',{name:'code',placeholder:'Kód',required:true}),h('input',{name:'date',placeholder:'DD.MM.RRRR',required:true}),h('button',{},'Přidat')),h('table',{class:'table',style:'margin-top:10px'},h('thead',{},h('tr',{},h('th','Datum'),h('th','Název'),h('th','Zákazník'),h('th','Město'),h('th','Kód'),h('th','Akce'))),h('tbody',{},...(state.jobs||[]).map(j=>h('tr',{},h('td',toCZ(j.date)),h('td',j.title),h('td',j.client),h('td',j.city),h('td',j.code),h('td',h('span',{class:'linklike',onclick:()=>deductPrompt(j.id)},'Odečíst ze skladu'),' | ',h('span',{class:'linklike',onclick:async()=>{await api('/api/jobs?'+new URLSearchParams({id:j.id}),{method:'DELETE'});await loadJobs();renderApp()}},'Smazat'))))))));loadJobs();return el}
async function deductPrompt(jobId){try{const items=(await api('/api/items')).items||[];if(!items.length){alert('Ve skladu nejsou položky.');return}const choices=items.map(it=>`${it.id}:${it.name} (${it.qty} ${it.unit})`).join('\\n');const pick=prompt('Zadej ve tvaru: item_id:qty\\n\\n'+choices+'\\n\\nNapř.: 3:2');if(!pick)return;const m=pick.match(/^(\\d+):(\\d+(?:\\.\\d+)?)$/);if(!m){alert('Neplatný formát.');return}const payload={items:[{item_id:Number(m[1]),qty:Number(m[2])}]};await api('/api/jobs/'+jobId+'/deduct',{method:'POST',body:JSON.stringify(payload)});alert('Odečteno.')}catch(e){alert('Chyba: '+e.message)}}
async function loadTasks(){state.tasks=(await api('/api/tasks')).tasks||[]}
function Tasks(){const el=h('div',{class:'card'},h('div',{class:'card-h'},'Úkoly'),h('div',{class:'card-c'},h('form',{class:'form-row',onsubmit:async e=>{e.preventDefault();const form=Object.fromEntries(new FormData(e.target).entries());form.due_date=toISODateFlex(form.due_date);try{await api('/api/tasks',{method:'POST',body:JSON.stringify(form)});e.target.reset();await loadTasks();renderApp()}catch(err){alert('Chyba: '+err.message)}}},h('input',{name:'title',placeholder:'Název',required:true}),h('input',{name:'description',placeholder:'Popis'}),h('input',{name:'due_date',placeholder:'DD.MM.RRRR'}),h('input',{name:'employee_id',placeholder:'ID zaměstnance'}),h('input',{name:'job_id',placeholder:'ID zakázky'}),h('button',{},'Přidat')),h('table',{class:'table',style:'margin-top:10px'},h('thead',{},h('tr',{},h('th','Termín'),h('th','Název'),h('th','Popis'),h('th','Stav'),h('th','Akce'))),h('tbody',{},...(state.tasks||[]).map(t=>h('tr',{},h('td',toCZ(t.due_date||'')),h('td',t.title),h('td',t.description||''),h('td',t.status||'nový'),h('td',h('span',{class:'linklike',onclick:async()=>{await api('/api/tasks',{method:'PATCH',body:JSON.stringify({id:t.id,status:'hotovo'})});await loadTasks();renderApp()}},'Hotovo'),' | ',h('span',{class:'linklike',onclick:async()=>{await api('/api/tasks?'+new URLSearchParams({id:t.id}),{method:'DELETE'});await loadTasks();renderApp()}},'Smazat'))))))));loadTasks();return el}
async function loadItems(){state.items=(await api('/api/items')).items||[]}
function Items(){const el=h('div',{class:'card'},h('div',{class:'card-h'},'Sklad'),h('div',{class:'card-c'},h('form',{class:'form-row',onsubmit:async e=>{e.preventDefault();const form=Object.fromEntries(new FormData(e.target).entries());try{await api('/api/items',{method:'POST',body:JSON.stringify(form)});e.target.reset();await loadItems();renderApp()}catch(err){alert('Chyba: '+err.message)}}},h('input',{name:'site',placeholder:'Pobočka (lipnik/praha)',value:'lipnik'}),h('input',{name:'category',placeholder:'Kategorie',value:'materiál zahrada'}),h('input',{name:'name',placeholder:'Název',required:true}),h('input',{name:'qty',placeholder:'Množství',type:'number',step:'0.01',value:'1'}),h('input',{name:'unit',placeholder:'Jednotka',value:'ks'}),h('button',{},'Přidat')),h('table',{class:'table',style:'margin-top:10px'},h('thead',{},h('tr',{},h('th','Pobočka'),h('th','Kategorie'),h('th','Název'),h('th','Množství'),h('th','Jedn.'),h('th','Akce'))),h('tbody',{},...(state.items||[]).map(i=>h('tr',{},h('td',i.site),h('td',i.category),h('td',i.name),h('td',String(i.qty)),h('td',i.unit),h('td',h('span',{class:'linklike',onclick:async()=>{await api('/api/items?'+new URLSearchParams({id:i.id}),{method:'DELETE'});await loadItems();renderApp()}},'Smazat'))))))),h('div',{class:'small',style:'margin-top:8px'},'Export skladu: ',h('a',{href:'/export/warehouse.xlsx'},'warehouse.xlsx')));loadItems();return el}
async function loadEmployees(){state.employees=(await api('/api/employees')).employees||[]}
function Employees(){const el=h('div',{class:'card'},h('div',{class:'card-h'},'Zaměstnanci'),h('div',{class:'card-c'},h('form',{class:'form-row',onsubmit:async e=>{e.preventDefault();const form=Object.fromEntries(new FormData(e.target).entries());try{await api('/api/employees',{method:'POST',body:JSON.stringify(form)});e.target.reset();await loadEmployees();renderApp()}catch(err){alert('Chyba: '+err.message)}}},h('input',{name:'name',placeholder:'Jméno',required:true}),h('input',{name:'role',placeholder:'Role',value:'Zahradník'}),h('button',{},'Přidat')),h('table',{class:'table',style:'margin-top:10px'},h('thead',{},h('tr',{},h('th','Jméno'),h('th','Role'),h('th','Akce'))),h('tbody',{},...(state.employees||[]).map(e=>h('tr',{},h('td',e.name),h('td',e.role),h('td',h('span',{class:'linklike',onclick:async()=>{await api('/api/employees?'+new URLSearchParams({id:e.id}),{method:'DELETE'});await loadEmployees();renderApp()}},'Smazat')))))));loadEmployees();return el}
async function loadNotes(){state.notes=(await api('/api/notes')).notes||[]}
function Notes(){const el=h('div',{class:'card'},h('div',{class:'card-h'},'Poznámky'),h('div',{class:'card-c'},h('form',{class:'form-row',onsubmit:async e=>{e.preventDefault();const form=Object.fromEntries(new FormData(e.target).entries());try{await api('/api/notes',{method:'POST',body:JSON.stringify(form)});e.target.reset();await loadNotes();renderApp()}catch(err){alert('Chyba: '+err.message)}}},h('input',{name:'content',placeholder:'Text poznámky',required:true}),h('input',{name:'job_id',placeholder:'ID zakázky'}),h('input',{name:'task_id',placeholder:'ID úkolu'}),h('button',{},'Přidat')),h('ul',{},...(state.notes||[]).map(n=>h('li',{},`[${n.created_at}] `,n.content,' ',h('span',{class:'linklike',onclick:async()=>{await api('/api/notes?'+new URLSearchParams({id:n.id}),{method:'DELETE'});await loadNotes();renderApp()}},'Smazat'))))));loadNotes();return el}
async function renderApp(){const root=document.getElementById('app');root.innerHTML='';root.appendChild(tabs());if(state.tab==='calendar')root.appendChild(Calendar());if(state.tab==='jobs')root.appendChild(Jobs());if(state.tab==='tasks')root.appendChild(Tasks());if(state.tab==='items')root.appendChild(Items());if(state.tab==='employees')root.appendChild(Employees());if(state.tab==='notes')root.appendChild(Notes())}
boot();
</script>
</body></html>
