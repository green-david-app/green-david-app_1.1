<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>green david app</title>
    <link rel="stylesheet" href="/style.css"/>
  </head>
  <body>
    <header class="header">
      <div class="brand">
        <img src="/logo.jpg" alt="Green David" class="brand-logo" onerror="this.src='/logo.svg'"/>
        <div>
          <div class="brand-title">green david app</div>
          <div class="brand-sub">intern√≠ syst√©m</div>
        </div>
        <div class="right small" id="userbox"></div>
      </div>
    </header>

    <main class="container">
      <div id="app"></div>
      <div id="js-error" class="error-overlay" style="display:none"></div>
      <p class="small footer">¬© green david s.r.o.</p>
    </main>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      // ---------- util ----------
      function toISODateFlex(v){
        if(!v) return v;
        const d = String(v).replace(/\D+/g, '');
        if(d.length !== 8) return v;
        const yFirst = parseInt(d.slice(0,4),10);
        let y,m,day;
        if(yFirst >= 1900 && yFirst <= 2100){
          y = yFirst; m = parseInt(d.slice(4,6),10); day = parseInt(d.slice(6,8),10);
        } else {
          day = parseInt(d.slice(0,2),10); m = parseInt(d.slice(2,4),10); y = parseInt(d.slice(4,8),10);
        }
        const pad = (n)=> String(n).padStart(2,'0');
        return `${y}-${pad(m)}-${pad(day)}`;
      }
      function toCZ(iso){
        if(!iso) return '';
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return iso;
        const [_,y,mm,dd] = m;
        return `${dd}.${mm}.${y}`;
      }
      function showJSError(msg){
        var el = document.getElementById('js-error');
        el.style.display = 'block';
        el.textContent = String(msg || 'Nezn√°m√° chyba ve skriptu.');
        console.error(msg);
      }
      window.addEventListener('error', e=> showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)));
      window.addEventListener('unhandledrejection', e=> showJSError(e.reason ? (e.reason.stack||e.reason) : e));

      // tolerantn√≠ pomocn√≠k pro auth
      function isAuthed(payload){
        if(!payload) return false;
        if (typeof payload.authenticated === 'boolean') return payload.authenticated;
        if (typeof payload.ok === 'boolean') return payload.ok;
        // fallback ‚Äì pokud doraz√≠ user objekt, bereme jako p≈ôihl√°≈°en
        if (payload.user && (payload.user.id || payload.user.email)) return true;
        return false;
      }

      async function api(path, opts={}){
        const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
        if(!res.ok){
          let msg = res.statusText;
          try{ const j = await res.json(); msg = j.error || msg; }catch{}
          throw new Error(msg);
        }
        try{ return await res.json(); }catch{return {};}
      }

      async function refreshUserBox(){
        const box = document.getElementById("userbox");
        try{
          const j = await api("/api/me");
          if(isAuthed(j)){
            const user = j.user || j;
            const tasks = j.tasks_count || 0;
            box.innerHTML = `P≈ôihl√°≈°en: <b>${user.name||user.email||'u≈æivatel'}</b> (${user.role||'-'}) ‚Ä¢ √ökoly: <b>${tasks}</b> &nbsp; <button class="ghost" id="logout-btn">Odhl√°sit</button>`;
            document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
          } else {
            box.innerHTML = '<span>Nep≈ôihl√°≈°en</span>';
          }
        }catch(e){ box.innerText = ""; }
      }
    </script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      function Login({onLogged}){
        const [email,setEmail]=useState(""); const [pass,setPass]=useState(""); const [err,setErr]=useState("");
        async function submit(e){
          e.preventDefault();
          setErr("");
          try{
            await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})});
            // po p≈ôihl√°≈°en√≠ si ovƒõ≈ô /api/me a a≈æ pak pus≈• app d√°l
            const j = await api("/api/me");
            if(isAuthed(j)) onLogged();
            else throw new Error("P≈ôihl√°≈°en√≠ se nepoda≈ôilo.");
          }catch(e){ setErr("≈†patn√Ω e-mail nebo heslo"); }
        }
        return (
          <div className="card" style={{maxWidth:460, margin:"40px auto"}}>
            <div className="card-h"><div>P≈ôihl√°≈°en√≠</div></div>
            <div className="card-c">
              <form onSubmit={submit}>
                <div className="form-row">
                  <input type="email" placeholder="E-mail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/>
                </div>
                <div className="form-row">
                  <input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/>
                </div>
                {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
                <div className="form-row" style={{justifyContent:"flex-end"}}>
                  <button type="submit">P≈ôihl√°sit</button>
                </div>
                <div className="small">V√Ωchoz√≠ admin: <b>admin@greendavid.cz</b> / <b>admin123</b>.</div>
              </form>
            </div>
          </div>
        );
      }

      function Tabs({value,onChange,canAdmin,taskCount}){
        const items=[
          {key:"jobs",label:"Zak√°zky"},
          {key:"calendar",label:"Kalend√°≈ô"},
          {key:"timesheets",label:"Hodiny"},
          {key:"tasks",label:"√ökoly"+(taskCount? " ("+taskCount+")": "")},
          {key:"employees",label:"Zamƒõstnanci"},
          {key:"warehouse",label:"Sklad"},
          ...(canAdmin?[{key:"users",label:"U≈æivatel√©"}]:[])
        ];
        return <div className="tabs">{items.map(it=>(<div key={it.key} className={"tab"+(it.key===value?" active":"")} onClick={()=>onChange(it.key)}>{it.label}</div>))}</div>;
      }

      // ---- Zak√°zky (beze zmƒõn designu) ----
      function JobsList({onOpen}){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""});
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/jobs"); setList(j.jobs||[]); }catch(e){ setErr(e.message);} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        async function add(e){ e.preventDefault(); try{
          const payload={...form, date: toISODateFlex(form.date)};
          await api("/api/jobs",{method:"POST",body:JSON.stringify(payload)});
          setForm({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""});
          load();
        }catch(e){ setErr(e.message || String(e)); } }
        async function del(id){ if(!confirm("Smazat zak√°zku?")) return; await api("/api/jobs?id="+id,{method:"DELETE"}); load(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nov√° zak√°zka</div></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <input placeholder="N√°zev" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} style={{flex:2}} required/>
                    <input placeholder="Z√°kazn√≠k" value={form.client} onChange={e=>setForm({...form,client:e.target.value})} style={{flex:2}} required/>
                    <select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>
                      <option>Pl√°n</option><option>Prob√≠h√°</option><option>Dokonƒçeno</option>
                    </select>
                  </div>
                  <div className="form-row">
                    <input placeholder="Mƒõsto" value={form.city} onChange={e=>setForm({...form,city:e.target.value})} required/>
                    <input placeholder="K√≥d (nap≈ô. 2025-091)" value={form.code} onChange={e=>setForm({...form,code:e.target.value})} required/>
                    <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
                  </div>
                  <div className="form-row">
                    <input placeholder="Pozn√°mka" value={form.note} onChange={e=>setForm({...form,note:e.target.value})} style={{flex:1}}/>
                    <button type="submit">P≈ôidat</button>
                  </div>
                </form>
                {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
              </div>
            </div>

            {list.map(z=> (
              <div className="card" key={z.id}>
                <div className="card-h">
                  <div>
                    <div style={{fontWeight:700}}>
                      <span className="linklike" onClick={()=> onOpen(z.id)}>{z.title}</span>
                    </div>
                    <div className="small">{z.client} ‚Ä¢ {z.city} ‚Ä¢ {z.code}</div>
                  </div>
                  <span className="badge">{z.status}</span>
                </div>
                <div className="card-c">
                  <div className="kv small"><span>üìÖ</span> <span>{toCZ(z.date)}</span></div>
                  <div style={{marginTop:12, display:"flex", gap:8}}>
                    <button onClick={()=> onOpen(z.id)}>Otev≈ô√≠t detail</button>
                    <button className="ghost" onClick={()=> del(z.id)}>Smazat</button>
                  </div>
                </div>
              </div>
            ))}

            {list.length===0 && <div className="card"><div className="card-c small">Zat√≠m ≈æ√°dn√© zak√°zky ‚Äì p≈ôidej prvn√≠ v√Ω≈°e.</div></div>}
          </div>
        );
      }

      // ... (JobDetail, PhotoUploader, JobTasks, JobHours ‚Äì beze zmƒõn proti tv√© verzi)
      // Kv≈Øli d√©lce ponech√°v√°m komponenty JobDetail/PhotoUploader/JobTasks/JobHours stejn√©
      // ‚Äì jedin√© zmƒõny jsou n√≠≈æe v CalendarTab a TimesheetsTab.

      // ---- Kalend√°≈ô (iPhone-like, beze zmƒõny vzhledu; jen status "Dokonƒçeno" m√≠sto "Hotovo") ----
      function CalendarTab(){
        const [jobs,setJobs]=useState([]);
        const [month,setMonth]=useState(()=> new Date(new Date().getFullYear(), new Date().getMonth(), 1));
        const [err,setErr]=useState("");
        useEffect(()=>{ (async()=>{ try{ const j=await api("/api/jobs"); setJobs(j.jobs||[]); }catch(e){ setErr(e.message);} })(); },[]);
        function daysInMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }
        const firstDow = new Date(month.getFullYear(),month.getMonth(),1).getDay(); // 0=Sun
        const startOffset = (firstDow+6)%7; // Monday-first
        const total = startOffset + daysInMonth(month);
        const cells = Array.from({length: Math.ceil(total/7)*7}, (_,i)=>i);

        const byDate = {};
        for(const j of (jobs||[])){
          if(!j.date) continue;
          (byDate[j.date] ||= []).push(j);
        }

        function shiftMonth(delta){
          setMonth(new Date(month.getFullYear(), month.getMonth()+delta, 1));
        }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h">
                <div>Kalend√°≈ô</div>
                <div>
                  <button className="btn" onClick={()=>shiftMonth(-1)}>‚óÄ</button>
                  <b style={{margin:"0 12px"}}>{month.toLocaleString('cs-CZ',{month:'long', year:'numeric'})}</b>
                  <button className="btn" onClick={()=>shiftMonth(1)}>‚ñ∂</button>
                </div>
              </div>
              <div className="card-c">
                {err && <div className="small" style={{color:'#ffbcbc'}}>{err}</div>}
                <div className="calendar">
                  <div className="cal-head">
                    {["Po","√öt","St","ƒåt","P√°","So","Ne"].map(d=><div key={d}>{d}</div>)}
                  </div>
                  <div className="cal-grid">
                    {cells.map(i=>{
                      const day = i - startOffset + 1;
                      const inMonth = day>=1 && day<=daysInMonth(month);
                      const dateStr = inMonth ? new Date(month.getFullYear(),month.getMonth(),day).toISOString().slice(0,10) : null;
                      const list = dateStr ? (byDate[dateStr]||[]) : [];
                      return (
                        <div key={i} className={"cal-cell"+(inMonth?"":" dim")+(list.length?" has":"")}>
                          <div className="cal-day">{inMonth? day : ""}</div>
                          {list.slice(0,3).map((j,idx)=>{
                            const color = j.status==='Prob√≠h√°' ? 'green' : (j.status==='Dokonƒçeno' ? 'gray' : 'blue');
                            return <div key={idx} className={"pill "+color}>{j.title}</div>;
                          })}
                          {list.length>3 && <div className="small">+{list.length-3} dal≈°√≠‚Ä¶</div>}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ---- V√Ωkaz hodin (tolerantn√≠ k /api/timesheets tvaru dat) ----
      function TimesheetsTab(){
        const [employees,setEmployees]=useState([]);
        const [jobs,setJobs]=useState([]);
        const [list,setList]=useState([]);
        const [form,setForm]=useState({date:"", employee_id:"", job:"", hours:"", note:""});
        const [err,setErr]=useState("");

        useEffect(()=>{ (async()=>{
          try{ const e=await api("/api/employees"); setEmployees(e.employees||[]); }catch(e){}
          try{ const j=await api("/api/jobs"); setJobs(j.jobs||[]);}catch(e){}
          load();
        })(); },[]);

        async function load(){
          try{
            const r=await api("/api/timesheets");
            // r.rows (nƒõkde) nebo r.timesheets (jinde)
            setList(r.rows || r.timesheets || []);
          }catch(e){ setErr(e.message);}
        }

        async function add(e){
          e.preventDefault(); setErr("");
          try{
            if(!form.date) throw new Error("Vyber datum");
            const data={...form, employee_id: Number(form.employee_id)||null, hours: Number(form.hours)||0};
            await api("/api/timesheets", {method:"POST", body: JSON.stringify(data)});
            setForm({date:"", employee_id:"", job:"", hours:"", note:""});
            load();
          }catch(e){ setErr(e.message || String(e)); }
        }

        async function del(id){ if(!confirm("Smazat z√°znam?")) return; await api("/api/timesheets?id="+id, {method:"DELETE"}); load(); }

        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card"><div className="card-h"><div>V√Ωkaz hodin</div></div><div className="card-c">
              {err && <div className="small" style={{color:'#ffbcbc'}}>{err}</div>}
              <form onSubmit={add}>
                <div className="form-row">
                  <input type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
                  <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})} required>
                    <option value="">Zamƒõstnanec‚Ä¶</option>
                    {employees.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}
                  </select>
                  <select value={form.job} onChange={e=>setForm({...form,job:e.target.value})}>
                    <option value="">Zak√°zka‚Ä¶</option>
                    {jobs.map(j=><option key={j.id} value={j.title}>{j.title} ({j.code})</option>)}
                  </select>
                  <input type="number" min="0" step="0.5" placeholder="Hodiny" value={form.hours} onChange={e=>setForm({...form,hours:e.target.value})} required style={{width:120}}/>
                  <input placeholder="Pozn√°mka" value={form.note||""} onChange={e=>setForm({...form,note:e.target.value})} style={{flex:2}}/>
                  <button type="submit">P≈ôidat</button>
                </div>
              </form>
            </div></div>

            <div className="card"><div className="card-h"><div>Seznam</div></div><div className="card-c">
              <table className="table">
                <thead><tr><th>Datum</th><th>Zamƒõstnanec</th><th>Zak√°zka</th><th>Hodiny</th><th>Pozn√°mka</th><th></th></tr></thead>
                <tbody>
                  {list.map(r=>(
                    <tr key={r.id}>
                      <td>{r.date}</td>
                      <td>{(employees.find(e=>e.id===r.employee_id)||{}).name || r.employee_id}</td>
                      <td>{r.job}</td>
                      <td>{r.hours}</td>
                      <td>{r.note||""}</td>
                      <td><button className="btn" onClick={()=>del(r.id)}>Smazat</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {list.length===0 && <div className="small">Zat√≠m ≈æ√°dn√© z√°znamy.</div>}
            </div></div>
          </div>
        );
      }

      // ---- App ko≈ôen ‚Äì JEN √∫prava autenticace ----
      function App(){
        const [auth,setAuth]=useState({ready:false, ok:false, user:null, tasks:0});
        const [tab, setTab] = useState("jobs");
        const [jobOpen,setJobOpen]=useState(null);

        useEffect(()=>{(async()=>{
          try{
            const j=await api("/api/me");
            setAuth({ready:true, ok:isAuthed(j), user:(j.user||j)||null, tasks:j.tasks_count||0});
            refreshUserBox();
          }catch(e){ showJSError(e.message);}
        })()},[]);

        if(!auth.ready) return <div className="small">Naƒç√≠t√°m‚Ä¶</div>;
        if(!auth.ok) return <Login onLogged={()=>location.reload()}/>;

        return (
          <div>
            <Tabs value={tab} onChange={(k)=>{ setTab(k); setJobOpen(null); }} canAdmin={auth.user?.role==="admin"} taskCount={auth.tasks}/>
            <div style={{height:12}}/>
            {tab==="jobs" && (jobOpen? <JobDetail jobId={jobOpen} onBack={()=>setJobOpen(null)}/> : <JobsList onOpen={setJobOpen}/>)}
            {tab==="calendar" && <CalendarTab/>}
            {tab==="timesheets" && <TimesheetsTab/>}
            {tab==="tasks" && <TasksTab/>}
            {tab==="employees" && <Employees/>}
            {tab==="warehouse" && <Warehouse/>}
            {tab==="users" && auth.user?.role==="admin" && <UsersTab/>}
          </div>
        );
      }

      // --- (ponech√°v√°m Employees/UsersTab/Warehouse/TasksTab/JobDetail atd. z tvoj√≠ verze) ---

      ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
    </script>
  </body>
</html>
