<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>green david app</title>
    <link rel="stylesheet" href="/style.css"/>
    <meta http-equiv="cache-control" content="no-cache"/>
  </head>
  <body>
    <header class="header">
      <div class="brand">
        <img src="/logo.jpg" alt="Green David" class="brand-logo" onerror="this.src='/logo.svg'"/>
        <div>
          <div class="brand-title">green david app</div>
          <div class="brand-sub">interní systém</div>
        </div>
        <div class="right small" id="userbox"></div>
      </div>
    </header>

    <main class="container">
      <div id="app" class="small" style="opacity:.8;margin:18px 0">
        Načítám aplikaci… Pokud se nic nestane, <a href="/calendar">přejdi do Kalendáře</a>.
      </div>
      <div id="js-error" class="error-overlay" style="display:none"></div>
      <p class="small footer">© green david s.r.o.</p>
    </main>

    <script>
      // DATE UTILITIES (fixed)
      function toISODateFlex(v){
        if(!v) return v;
        const s = String(v).trim();
        const m = s.match(/^(\d{1,2})[\.\s-](\d{1,2})[\.\s-](\d{4})$/);
        if(m){
          const dd = m[1].padStart(2,'0');
          const mm = m[2].padStart(2,'0');
          const yyyy = m[3];
          return `${yyyy}-${mm}-${dd}`;
        }
        if(/^(\d{4})-(\d{2})-(\d{2})$/.test(s)) return s;
        const d = s.replace(/\D+/g, '');
        if(d.length === 8){
          const yFirst = parseInt(d.slice(0,4),10);
          let y, mm, dd;
          if(yFirst >= 1900 && yFirst <= 2100){
            y = yFirst; mm = parseInt(d.slice(4,6),10); dd = parseInt(d.slice(6,8),10);
          } else {
            dd = parseInt(d.slice(0,2),10); mm = parseInt(d.slice(2,4),10); y = parseInt(d.slice(4,8),10);
          }
          const pad = (n)=> String(n).padStart(2,'0');
          if(y && mm>=1 && mm<=12 && dd>=1 && dd<=31) return `${y}-${pad(mm)}-${pad(dd)}`;
        }
        return v;
      }
      function toCZ(iso){
        if(!iso) return iso||'';
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return iso;
        const [_,y,mm,dd] = m;
        return `${dd}.${mm}.${y}`;
      }
      function normalizeDate(v){
        if(!v) return v;
        var m=v.match(/^(\d{1,2})[\.\s-](\d{1,2})[\.\s-](\d{4})$/);
        if(m){ var d=m[1].padStart(2,'0'); var M=m[2].padStart(2,'0'); var y=m[3]; return y+"-"+M+"-"+d; }
        return v;
      }
      function showJSError(msg){
        var el = document.getElementById('js-error');
        el.style.display = 'block';
        el.textContent = String(msg || 'Neznámá chyba ve skriptu.');
        console.error(msg);
      }
      window.addEventListener('error', function(e){ showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)); });
      window.addEventListener('unhandledrejection', function(e){ showJSError(e.reason ? (e.reason.stack||e.reason) : e); });

      // Non-destructive behavior: automaticky přesměruj na kalendář
      (function(){
        var redirected = false;
        function go(){ if(redirected) return; redirected=true; try{ window.location.replace('/calendar'); }catch(e){ window.location.href='/calendar'; } }
        if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', go); } else { go(); }
        // fallback if browser blocks replace()
        setTimeout(function(){ if(!redirected) go(); }, 1000);
      })();
    </script>
  </body>
</html>
