<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>green david app</title>
    <link rel="stylesheet" href="/style.css"/>
    <script src="/app-settings.js"></script>
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
  </head>
  <body>
    <header class="header" style="background:rgba(31,36,40,0.85);backdrop-filter:blur(20px);border-bottom:1px solid #353b41;padding:16px 24px;position:sticky;top:0;z-index:100;">
      <div style="max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <img src="/logo.jpg" alt="green david app" style="height:36px;width:auto;border-radius:8px;" onerror="this.src='/logo.svg'"/>
          <div>
            <div style="font-size:18px;font-weight:600;color:#e8eef2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;">green david app</div>
            <div style="font-size:12px;color:#9ca8b3;">intern√≠ syst√©m</div>
          </div>
        </div>
        <div id="userbox" style="display:flex;align-items:center;gap:12px;font-size:14px;color:#9ca8b3;">
        </div>
      </div>
    </header>

    <main class="container">
      <div id="app"></div>
      <div id="js-error" class="error-overlay" style="display:none"></div>
      <p class="small footer">¬© green david s.r.o.</p>
    </main>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>

      function toISODateFlex(v){
        if(!v) return v;
        const d = String(v).replace(/\D+/g, '');
        if(d.length !== 8) return v;
        const yFirst = parseInt(d.slice(0,4),10);
        let y,m,day;
        if(yFirst >= 1900 && yFirst <= 2100){
          y = yFirst; m = parseInt(d.slice(4,6),10); day = parseInt(d.slice(6,8),10);
        } else {
          day = parseInt(d.slice(0,2),10); m = parseInt(d.slice(2,4),10); y = parseInt(d.slice(4,8),10);
        }
        if(!(y && m && day)) return v;
        const pad = (n)=> String(n).padStart(2,'0');
        return `${y}-${pad(m)}-${pad(day)}`;
      }
      function toCZ(iso){
        if(!iso) return iso||'';
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return iso;
        const [_,y,mm,dd] = m;
        return `${dd}.${mm}.${y}`;
      }

      function normalizeDate(v){
        if(!v) return v;
        var m=v.match(/^(\d{1,2})[\.\s-](\d{1,2})[\.\s-](\d{4})$/);
        if(m){
          var d=m[1].padStart(2,'0'); var M=m[2].padStart(2,'0'); var y=m[3];
          return y+"-"+M+"-"+d;
        }
        return v;
      }
      // Notification System (global)
      let notificationContainer = null;
      function showNotification(message,type="info"){
        if(!notificationContainer) {
          notificationContainer = document.createElement('div');
          notificationContainer.id = 'notification-container';
          notificationContainer.style.cssText = 'position:fixed;top:80px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:8px;max-width:400px;';
          document.body.appendChild(notificationContainer);
        }
        const notif = document.createElement('div');
        const colors = {success:'#3ea76a',error:'#ef4444',info:'#3b82f6',warning:'#f59e0b'};
        notif.style.cssText = `padding:12px 16px;background:${colors[type]||colors.info}20;border:1px solid ${colors[type]||colors.info}40;border-radius:12px;color:#e8eef2;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;`;
        notif.textContent = message;
        notificationContainer.appendChild(notif);
        setTimeout(()=>{
          notif.style.animation = 'slideOut 0.3s ease';
          setTimeout(()=>notif.remove(),300);
        },4000);
      }
      
      function showJSError(msg){
        var el = document.getElementById('js-error');
        el.style.display = 'block';
        el.textContent = String(msg || 'Nezn√°m√° chyba ve skriptu.');
        console.error(msg);
      }
      window.addEventListener('error', function(e){ showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)); });
      window.addEventListener('unhandledrejection', function(e){ showJSError(e.reason ? (e.reason.stack||e.reason) : e); });
      async function api(path, opts={}){
        const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
        if(!res.ok){ let msg = res.statusText; try{ const j = await res.json(); msg = j.error || msg; }catch{} throw new Error(msg); }
        try{ return await res.json(); }catch{return {};}
      }
      async function refreshUserBox(){
        const box = document.getElementById("userbox");
        try{
          const j = await api("/api/me");
          if(j.authenticated){
            box.innerHTML = `<span>√ökoly: <strong style="color:#e8eef2;">${j.tasks_count}</strong></span> &nbsp; <button class="btn btn-ghost btn-sm" id="logout-btn" style="padding:6px 12px;font-size:13px;">Odhl√°sit</button>`;
            document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
          } else {
            box.innerHTML = '<span>Nep≈ôihl√°≈°en</span>';
          }
        }catch(e){ box.innerText = ""; }
      }
    </script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      function Login({onLogged}){
        const [email,setEmail]=useState(""); const [pass,setPass]=useState(""); const [err,setErr]=useState("");
        async function submit(e){ e.preventDefault(); setErr(""); try{ await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})}); onLogged(); }catch(e){ setErr("≈†patn√Ω e‚Äëmail nebo heslo"); } }
        return (<div className="card" style={{maxWidth:460, margin:"40px auto"}}><div className="card-h"><div>P≈ôihl√°≈°en√≠</div></div><div className="card-c">
          <form onSubmit={submit}><div className="form-row"><input type="email" placeholder="E‚Äëmail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/></div>
          <div className="form-row"><input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/></div>
          {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}<div className="form-row" style={{justifyContent:"flex-end"}}><button type="submit">P≈ôihl√°sit</button></div>
          <div className="small">V√Ωchoz√≠ admin: <b>admin@greendavid.local</b> / <b>admin123</b>.</div></form></div></div>);
      }

      function Tabs({value,onChange,canAdmin,taskCount}){
        const items = [
          {key:"dashboard",label:"p≈ôehled"},
          {key:"calendar",label:"kalend√°≈ô",href:"/calendar.html"},
          {key:"timesheets",label:"v√Ωkazy hodin",href:"/timesheets.html"},
          {key:"jobs",label:"zak√°zky"},
          {key:"tasks",label:"√∫koly"},
          {key:"employees",label:"zamƒõstnanci"},
          {key:"warehouse",label:"sklad"},
          {key:"archive",label:"archiv zak√°zek"},
          ...(canAdmin ? [{key:"users",label:"u≈æivatel√©"}] : [])
        ];
        return <div className="tabs">
          {items.map(it => (
            it.href
              ? <a key={it.key} className={"tab"+(value===it.key?" active":"")} href={it.href}>{it.label}</a>
              : <div key={it.key} className={"tab"+(value===it.key?" active":"")} onClick={()=>onChange(it.key)}>{it.label}</div>
          ))}
        </div>;
      }

      function JobsList({onOpen}){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""});
        const [err,setErr]=useState("");
        // Default to list view on mobile, kanban on desktop
        const [viewMode,setViewMode]=useState(()=>{
          if(typeof window !== 'undefined' && window.innerWidth < 768) return "list";
          return "kanban";
        }); // "kanban" or "list"
        const [draggedJob,setDraggedJob]=useState(null);

        // NEW: edit mode state
        const [editId, setEditId] = useState(null);
        const [edit, setEdit] = useState({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""});

        async function load(){ try{ const j=await api("/api/jobs"); setList(j.jobs||[]); }catch(e){ setErr(e.message); showNotification("Chyba p≈ôi naƒç√≠t√°n√≠ zak√°zek: "+e.message,"error");} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        
        // Drag & Drop handlers
        function handleDragStart(e,job){
          setDraggedJob(job);
          e.dataTransfer.effectAllowed = "move";
        }
        function handleDragOver(e){
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }
        async function handleDrop(e,newStatus){
          e.preventDefault();
          if(!draggedJob || draggedJob.status===newStatus) return;
          try{
            await api("/api/jobs",{method:"PATCH",body:JSON.stringify({id:draggedJob.id,status:newStatus})});
            showNotification(`Zak√°zka "${draggedJob.title}" p≈ôesunuta do ${newStatus}`,"success");
            load();
          }catch(e){
            showNotification("Chyba p≈ôi p≈ôesunu zak√°zky: "+e.message,"error");
          }
          setDraggedJob(null);
        }
        
        const columns = [
          {id:"Pl√°n",label:"Pl√°n",color:"#3b82f6"},
          {id:"Prob√≠h√°",label:"Prob√≠h√°",color:"#3ea76a"},
          {id:"Dokonƒçeno",label:"Dokonƒçeno",color:"#6b7580"}
        ];

        async function add(e){ e.preventDefault(); try{ const payload={...form, date: toISODateFlex(form.date)}; await api("/api/jobs",{method:"POST",body:JSON.stringify(payload)}); setForm({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""}); showNotification("Zak√°zka p≈ôid√°na","success"); load(); }catch(e){ setErr(e.message || String(e)); showNotification("Chyba p≈ôi p≈ôid√°v√°n√≠ zak√°zky: "+e.message,"error"); } }
        async function del(id){ if(!confirm("Smazat zak√°zku?")) return; try{ await api("/api/jobs?id="+id,{method:"DELETE"}); showNotification("Zak√°zka smaz√°na","success"); load(); }catch(e){ showNotification("Chyba p≈ôi maz√°n√≠: "+e.message,"error"); } }

        // NEW: start/cancel/save edit
        function startEdit(z){
          setEditId(z.id);
          setEdit({
            title: z.title || "",
            client: z.client || "",
            status: z.status || "Pl√°n",
            city: z.city || "",
            code: z.code || "",
            date: toCZ(z.date || ""),
            note: z.note || ""
          });
        }
        function cancelEdit(){ setEditId(null); }
        async function saveEdit(e){
          e.preventDefault();
          try{
            const payload = { id: editId, ...edit, date: toISODateFlex(edit.date) };
            await api("/api/jobs", { method:"PATCH", body: JSON.stringify(payload) });
            setEditId(null);
            showNotification("Zak√°zka upravena","success");
            load();
          }catch(e){ setErr(e.message || String(e)); showNotification("Chyba p≈ôi ukl√°d√°n√≠: "+e.message,"error"); }
        }

        return (<div style={{paddingBottom:100}}>
          {/* View Mode Toggle */}
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <h2 style={{fontSize:22,fontWeight:700,color:"#e8eef2"}}>Zak√°zky</h2>
            <div style={{display:"flex",gap:8}}>
              <button className="btn btn-ghost" style={{padding:"6px 12px",fontSize:12,background:viewMode==="kanban"?"rgba(62, 167, 106, 0.15)":"transparent"}} onClick={()=>setViewMode("kanban")}>Kanban</button>
              <button className="btn btn-ghost" style={{padding:"6px 12px",fontSize:12,background:viewMode==="list"?"rgba(62, 167, 106, 0.15)":"transparent"}} onClick={()=>setViewMode("list")}>Seznam</button>
            </div>
          </div>
          
          {/* Kanban Board View */}
          {viewMode==="kanban" ? (
            <div style={{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:16,marginBottom:24}} className="kanban-board">
              {columns.map(col=>{
                const colJobs = list.filter(j=>j.status===col.id);
                return <div key={col.id} className="card" style={{minHeight:400}} onDragOver={handleDragOver} onDrop={(e)=>handleDrop(e,col.id)}>
                  <div className="card-h" style={{background:col.color+"20",borderBottom:`2px solid ${col.color}`}}>
                    <div style={{fontWeight:600,color:"#e8eef2"}}>{col.label}</div>
                    <span className="badge" style={{background:col.color+"30",color:col.color}}>{colJobs.length}</span>
                  </div>
                  <div className="card-c" style={{display:"flex",flexDirection:"column",gap:12}}>
                    {colJobs.map(job=>(
                      <div key={job.id} className="card" draggable onDragStart={(e)=>handleDragStart(e,job)} style={{cursor:"move",opacity:draggedJob?.id===job.id?0.5:1}}>
                        <div style={{fontWeight:600,color:"#e8eef2",marginBottom:4,overflow:"hidden",textOverflow:"ellipsis"}}>{job.title}</div>
                        <div className="small" style={{color:"#9ca8b3",marginBottom:8}}>{job.client} ‚Ä¢ {job.city}</div>
                        <div className="small" style={{color:"#6b7580",marginBottom:8}}>{toCZ(job.date)} ‚Ä¢ {job.code}</div>
                        <div style={{display:"flex",gap:4}}>
                          <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11}} onClick={()=>onOpen(job.id)}>Detail</button>
                          <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11}} onClick={()=>del(job.id)}>Smazat</button>
                        </div>
                      </div>
                    ))}
                    {colJobs.length===0 && <div style={{textAlign:"center",color:"#6b7580",padding:20,fontSize:13}}>≈Ω√°dn√© zak√°zky</div>}
                  </div>
                </div>;
              })}
            </div>
          ) : (
            /* List View */
            <div className="grid" style={{gridTemplateColumns:"1fr"}}>
              <div className="card"><div className="card-h"><div>Nov√° zak√°zka</div></div><div className="card-c">
            <form onSubmit={add}><div className="form-row">
              <input placeholder="N√°zev" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} style={{flex:2}} required/>
              <input placeholder="Z√°kazn√≠k" value={form.client} onChange={e=>setForm({...form,client:e.target.value})} style={{flex:2}} required/>
              <select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}><option>Pl√°n</option><option>Prob√≠h√°</option><option>Dokonƒçeno</option></select>
            </div><div className="form-row">
              <input placeholder="Mƒõsto" value={form.city} onChange={e=>setForm({...form,city:e.target.value})} required/>
              <input placeholder="K√≥d (nap≈ô. 2025-091)" value={form.code} onChange={e=>setForm({...form,code:e.target.value})} required/>
              <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
            </div><div className="form-row">
              <input placeholder="Pozn√°mka" value={form.note} onChange={e=>setForm({...form,note:e.target.value})} style={{flex:1}}/>
              <button type="submit">P≈ôidat</button>
            </div></form>{err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}</div></div>

          {list.map(z=> (
            <div className="card" key={z.id}>
              <div className="card-h">
                <div>
                  <div style={{fontWeight:700}}><span className="linklike" onClick={()=> onOpen(z.id)}>{z.title}</span></div>
                  <div className="small">{z.client} ‚Ä¢ {z.city} ‚Ä¢ {z.code}</div>
                </div>
                <span className="badge">{z.status}</span>
              </div>

              <div className="card-c">
                <div className="kv small"><span>üìÖ</span> <span>{toCZ(z.date)}</span></div>

                {/* EDIT MODE UI */}
                {editId === z.id ? (
                  <form onSubmit={saveEdit} className="small" style={{marginTop:12}}>
                    <div className="form-row">
                      <input placeholder="N√°zev" value={edit.title} onChange={e=>setEdit({...edit,title:e.target.value})} style={{flex:2}} required/>
                      <input placeholder="Z√°kazn√≠k" value={edit.client} onChange={e=>setEdit({...edit,client:e.target.value})} style={{flex:2}} required/>
                      <select value={edit.status} onChange={e=>setEdit({...edit,status:e.target.value})}>
                        <option>Pl√°n</option><option>Prob√≠h√°</option><option>Dokonƒçeno</option>
                      </select>
                    </div>
                    <div className="form-row">
                      <input placeholder="Mƒõsto" value={edit.city} onChange={e=>setEdit({...edit,city:e.target.value})} required/>
                      <input placeholder="K√≥d (nap≈ô. 2025-091)" value={edit.code} onChange={e=>setEdit({...edit,code:e.target.value})} required/>
                      <input type="text" placeholder="DD.MM.RRRR" value={edit.date} onChange={e=>setEdit({...edit,date:e.target.value})} required/>
                    </div>
                    <div className="form-row">
                      <input placeholder="Pozn√°mka" value={edit.note} onChange={e=>setEdit({...edit,note:e.target.value})} style={{flex:1}}/>
                      <div>
                        <button type="submit">Ulo≈æit</button>
                        <button type="button" className="ghost" onClick={cancelEdit} style={{marginLeft:6}}>Zru≈°it</button>
                      </div>
                    </div>
                  </form>
                ) : null}

                <div style={{marginTop:12, display:"flex", gap:8}}>
                  <button onClick={()=> onOpen(z.id)}>Otev≈ô√≠t detail</button>
                  {/* NEW EDIT BUTTON next to Delete */}
                  {editId === z.id ? (
                    <button className="ghost" onClick={cancelEdit}>Zru≈°it √∫pravy</button>
                  ) : (
                    <button className="ghost" onClick={()=> startEdit(z)}>Upravit</button>
                  )}
                  <button className="ghost" onClick={()=> del(z.id)}>Smazat</button>
                </div>
              </div>
            </div>
          ))}

              {list.length===0 && <div className="card"><div className="card-c small">Zat√≠m ≈æ√°dn√© zak√°zky ‚Äì p≈ôidej prvn√≠ v√Ω≈°e.</div></div>}
            </div>
          )}
        </div>);
      }

      function PhotoUploader({jobId,onUploaded}){
        function compressAndSend(file){
          var reader = new FileReader();
          reader.onload = function(){
            var img = new Image();
            img.onload = async function(){
              var maxSide = 1600, quality = 0.82;
              var scale = (img.width>img.height) ? maxSide/img.width : maxSide/img.height;
              var w = Math.min(maxSide, Math.round(img.width*scale));
              var h = Math.min(maxSide, Math.round(img.height*scale));
              var c = document.createElement("canvas"); c.width=w; c.height=h;
              var ctx = c.getContext("2d"); ctx.drawImage(img,0,0,w,h);
              var dataUrl = c.toDataURL("image/jpeg", quality);
              await api(`/api/jobs/${jobId}/photos`, {method:"POST", body: JSON.stringify({data_url:dataUrl})});
              onUploaded && onUploaded();
            };
            img.src = reader.result;
          };
          reader.readAsDataURL(file);
        }
        return (<label><input type="file" accept="image/*" onChange={e=>{ var f=e.target.files && e.target.files[0]; if(f) compressAndSend(f); }}/><button className="ghost">Nahr√°t fotku</button></label>);
      }

      function JobTasks({jobId}){
        const [list,setList]=useState([]);
        const [employees,setEmployees]=useState([]);
        const [form,setForm]=useState({title:"",description:"",due_date:"",employee_id:""});
        async function load(){ try{ const [t,e]=await Promise.all([api("/api/tasks?job_id="+jobId), api("/api/employees")]); setList(t.tasks||[]); setEmployees(e.employees||[]); }catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[jobId]);
        async function add(e){ e.preventDefault(); await api("/api/tasks",{method:"POST",body:JSON.stringify({...form, due_date: toISODateFlex(form.due_date), job_id: jobId || null})}); setForm({title:"",description:"",due_date:"",employee_id:""}); load(); }
        async function setStatus(t, status){ await api("/api/tasks",{method:"PATCH",body:JSON.stringify({id:t.id,status})}); load(); }
        async function del(t){ if(!confirm("Smazat √∫kol?")) return; await api("/api/tasks?id="+t.id,{method:"DELETE"}); load(); }
        return (<div className="card"><div className="card-h"><div>√ökoly zak√°zky</div></div><div className="card-c">
          <form onSubmit={add}><div className="form-row">
            <input placeholder="Nadpis √∫kolu" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} required style={{flex:2}}/>
            <input placeholder="Do kdy (YYYY-MM-DD)" value={form.due_date} onChange={e=>setForm({...form,due_date:e.target.value})}/>
            <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})}><option value="">Nep≈ôi≈ôazovat</option>{employees.map(emp=>(<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select>
            <button type="submit">P≈ôidat</button>
          </div><div className="form-row"><input placeholder="Popis" value={form.description} onChange={e=>setForm({...form,description:e.target.value})} style={{flex:1}}/></div></form>
          <table className="table"><thead><tr><th>Stav</th><th>N√°zev</th><th>P≈ôi≈ôazeno</th><th>Term√≠n</th><th></th></tr></thead><tbody>
            {list.map(t=>(<tr key={t.id}><td><span className="badge">{t.status}</span></td><td>{t.title}</td><td>{t.employee_id || "-"}</td><td>{t.due_date || "-"}</td><td className="small">
              <button className="ghost" onClick={()=>setStatus(t,"nov√Ω")}>nov√Ω</button><button className="ghost" onClick={()=>setStatus(t,"prob√≠h√°")}>prob√≠h√°</button><button className="ghost" onClick={()=>setStatus(t,"hotovo")}>hotovo</button><button className="ghost" onClick={()=>del(t)}>smazat</button></td></tr>))}
          </tbody></table>{list.length===0 && <div className="small">≈Ω√°dn√© √∫koly.</div>}</div></div>);
      }

      function JobHours({jobId}){
        const [rows,setRows]=useState([]);
        const [employees,setEmployees]=useState([]);
        const [form,setForm]=useState({employee_id:"",date:"",hours:0,place:"",activity:""});
        async function load(){ try{ const [h,e]=await Promise.all([api("/api/timesheets?job_id="+jobId), api("/api/employees")]); setRows(h.rows||[]); setEmployees(e.employees||[]);}catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[jobId]);
        async function add(e){ e.preventDefault(); await api("/api/timesheets",{method:"POST",body:JSON.stringify({job_id:jobId, ...form})}); setForm({employee_id:"",date:"",hours:0,place:"",activity:""}); load(); }
        async function del(id){ if(!confirm("Smazat z√°znam?")) return; await api("/api/timesheets?id="+id,{method:"DELETE"}); load(); }
        return (<div className="card"><div className="card-h"><div>Hodiny na zak√°zce</div></div><div className="card-c">
          <form onSubmit={add}><div className="form-row">
            <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})} required><option value="">Zamƒõstnanec‚Ä¶</option>{employees.map(emp=>(<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select>
            <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
            <input type="number" step="0.25" value={form.hours} onChange={e=>setForm({...form,hours:e.target.value})} required/>
          </div>
          <div className="form-row">
            <input placeholder="M√≠sto" value={form.place} onChange={e=>setForm({...form,place:e.target.value})} style={{flex:1}}/>
            <input placeholder="Popis ƒçinnosti" value={form.activity} onChange={e=>setForm({...form,activity:e.target.value})} style={{flex:2}}/>
            <button type="submit">P≈ôidat</button>
          </div></form>
          <table className="table"><thead><tr><th>Datum</th><th>Hodiny</th><th>Zamƒõstnanec</th><th>M√≠sto</th><th>Popis ƒçinnosti</th><th></th></tr></thead><tbody>
            {rows.map(r=>(<tr key={r.id}><td>{toCZ(r.date)}</td><td>{r.hours}</td><td>{r.employee_name || r.employee_id}</td><td>{r.place||"-"}</td><td>{r.activity||"-"}</td>
              <td><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></td></tr>))}
          </tbody></table>{rows.length===0 && <div className="small">Zat√≠m ≈æ√°dn√© hodiny.</div>}
        </div></div>);
      }

      function JobDetail({jobId,onBack}){
        const [data,setData]=useState(null); const [employees,setEmployees]=useState([]); const [selEmp,setSelEmp]=useState([]);
        const [mat,setMat]=useState({name:"",qty:0,unit:"ks"}); const [tool,setTool]=useState({name:"",qty:0,unit:"ks"});
        const [err,setErr]=useState("");
        async function load(){ try{ const [d, e] = await Promise.all([api(`/api/jobs/${jobId}`), api("/api/employees")]); setData(d); setEmployees(e.employees||[]); setSelEmp(d.assignments||[]);}catch(e){ setErr(e.message);} }
        useEffect(()=>{ load().catch(()=>{}); },[jobId]);
        async function addMat(e){ e.preventDefault(); await api(`/api/jobs/${jobId}/materials`,{method:"POST",body:JSON.stringify(mat)}); setMat({name:"",qty:0,unit:"ks"}); load(); }
        async function addTool(e){ e.preventDefault(); await api(`/api/jobs/${jobId}/tools`,{method:"POST",body:JSON.stringify(tool)}); setTool({name:"",qty:0,unit:"ks"}); load(); }
        async function delMat(id){ await api(`/api/jobs/${jobId}/materials?id=${id}`,{method:"DELETE"}); load(); }
        async function delTool(id){ await api(`/api/jobs/${jobId}/tools?id=${id}`,{method:"DELETE"}); load(); }
        async function setAssign(){ await api(`/api/jobs/${jobId}/assignments`,{method:"POST",body:JSON.stringify({employee_ids:selEmp})}); load(); }
        if(!data) return <div className="small">Naƒç√≠t√°m‚Ä¶</div>;
        const j = data.job;
        return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
          <button className="ghost" onClick={onBack}>‚Üê Zpƒõt na seznam</button>
          <div className="card"><div className="card-h"><div><div style={{fontWeight:800,fontSize:18}}>{j.title}</div><div className="small">{j.client} ‚Ä¢ {j.city} ‚Ä¢ {j.code}</div></div><span className="badge">{j.status}</span></div>
            <div className="card-c"><div className="kv small"><span>üìÖ</span> <span>{toCZ(j.date)}</span></div>{j.note && <div className="small" style={{marginTop:8}}>{j.note}</div>}</div></div>
          <div className="card"><div className="card-h"><div>P≈ôi≈ôazen√≠ zamƒõstnanci</div><button onClick={setAssign}>Ulo≈æit p≈ôi≈ôazen√≠</button></div>
            <div className="card-c small"><div className="row h"><div style={{gridColumn:"span 6"}}>Jm√©no</div><div style={{gridColumn:"span 6"}}>P≈ôi≈ôazen</div></div>
              {employees.map(e=> (<div className="row" key={e.id}><div style={{gridColumn:"span 6"}}>{e.name}</div><div style={{gridColumn:"span 6"}}><input type="checkbox" checked={selEmp.includes(e.id)} onChange={(ev)=>{ const checked=ev.target.checked; setSelEmp(s=> checked? [...new Set([...s, e.id])] : s.filter(x=>x!==e.id)); }}/></div></div>))}
            </div></div>
          <JobTasks jobId={jobId}/>
          <JobHours jobId={jobId}/>
          <div className="card"><div className="card-h"><div>Materi√°l</div><a className="ghost" href={`/export/job_materials.xlsx?job_id=${jobId}`}>Export XLSX</a></div>
            <div className="card-c"><form onSubmit={addMat}><div className="form-row">
              <input placeholder="N√°zev" value={mat.name} onChange={e=>setMat({...mat,name:e.target.value})} required style={{flex:2}}/>
              <input type="number" step="0.01" placeholder="Mno≈æstv√≠" value={mat.qty} onChange={e=>setMat({...mat,qty:e.target.value})} required style={{width:120}}/>
              <input placeholder="Jedn." value={mat.unit} onChange={e=>setMat({...mat,unit:e.target.value})} required style={{width:80}}/>
              <button type="submit">P≈ôidat</button></div></form>
              <div className="row h"><div style={{gridColumn:"span 7"}}>N√°zev</div><div style={{gridColumn:"span 2",textAlign:"right"}}>Mno≈æstv√≠</div><div style={{gridColumn:"span 1"}}>Jedn.</div><div style={{gridColumn:"span 2",textAlign:"right"}}></div></div>
              {(data.materials||[]).map(r=> (<div className="row small" key={r.id}><div style={{gridColumn:"span 7"}}>{r.name}</div><div style={{gridColumn:"span 2",textAlign:"right"}}>{r.qty}</div><div style={{gridColumn:"span 1"}}>{r.unit}</div><div style={{gridColumn:"span 2",textAlign:"right"}}><button className="ghost" onClick={()=>delMat(r.id)}>Smazat</button></div></div>))}
              {data.materials?.length===0 && <div className="small">Zat√≠m ≈æ√°dn√Ω materi√°l.</div>}</div></div>
          <div className="card"><div className="card-h"><div>N√°≈ôad√≠</div></div>
            <div className="card-c"><form onSubmit={addTool}><div className="form-row">
              <input placeholder="N√°zev" value={tool.name} onChange={e=>setTool({...tool,name:e.target.value})} required style={{flex:2}}/>
              <input type="number" step="0.01" placeholder="Mno≈æstv√≠" value={tool.qty} onChange={e=>setTool({...tool,qty:e.target.value})} required style={{width:120}}/>
              <input placeholder="Jedn." value={tool.unit} onChange={e=>setTool({...tool,unit:e.target.value})} required style={{width:80}}/>
              <button type="submit">P≈ôidat</button></div></form>
              <div className="row h"><div style={{gridColumn:"span 7"}}>N√°zev</div><div style={{gridColumn:"span 2",textAlign:"right"}}>Mno≈æstv√≠</div><div style={{gridColumn:"span 1"}}>Jedn.</div><div style={{gridColumn:"span 2",textAlign:"right"}}></div></div>
              {(data.tools||[]).map(r=> (<div className="row small" key={r.id}><div style={{gridColumn:"span 7"}}>{r.name}</div><div style={{gridColumn:"span 2",textAlign:"right"}}>{r.qty}</div><div style={{gridColumn:"span 1"}}>{r.unit}</div><div style={{gridColumn:"span 2",textAlign:"right"}}><button className="ghost" onClick={()=>delTool(r.id)}>Smazat</button></div></div>))}
              {data.tools?.length===0 && <div className="small">Zat√≠m ≈æ√°dn√© n√°≈ôad√≠.</div>}</div></div>
          <div className="card"><div className="card-h"><div>Fotky</div></div>
            <div className="card-c"><PhotoUploader jobId={jobId} onUploaded={load}/>
              <div className="grid" style={{gridTemplateColumns:"repeat(5,1fr)"}}>
                {(data.photos||[]).map(p=> (<div key={p.id}><img className="img-preview" src={`/uploads/${p.filename}`} alt="foto"/></div>))}
              </div>
              {data.photos?.length===0 && <div className="small">Zat√≠m ≈æ√°dn√© fotky.</div>}
            </div></div>
        </div>);
      }

      function EmployeeDetail({employee,onBack}){
        const [rows,setRows]=useState([]);
        const [jobs,setJobs]=useState([]);
        const [form,setForm]=useState({job_id:"",date:"",hours:0,place:"",activity:""});
        async function load(){ try{ const [t,j] = await Promise.all([api("/api/timesheets?employee_id="+employee.id), api("/api/jobs")]); setRows(t.rows||[]); setJobs(j.jobs||[]); }catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[employee.id]);
        async function add(e){ e.preventDefault(); await api("/api/timesheets",{method:"POST",body:JSON.stringify({employee_id:employee.id, ...form})}); setForm({job_id:"",date:"",hours:0,place:"",activity:""}); load(); }
        async function del(id){ if(!confirm("Smazat z√°znam?")) return; await api("/api/timesheets?id="+id,{method:"DELETE"}); load(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <button className="ghost" onClick={onBack}>‚Üê Zpƒõt na seznam</button>
            <div className="card">
              <div className="card-h"><div>{employee.name} ‚Äî v√Ωkazy hodin</div><a className="ghost" href={`/export/employee_hours.xlsx?employee_id=${employee.id}`}>Export XLSX</a></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <select value={form.job_id} onChange={e=>setForm({...form,job_id:e.target.value})} required>
                      <option value="">Vyber zak√°zku‚Ä¶</option>
                      {jobs.map(j=>(<option key={j.id} value={j.id}>{j.title} ({j.code})</option>))}
                    </select>
                    <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
                    <input type="number" step="0.25" value={form.hours} onChange={e=>setForm({...form,hours:e.target.value})} required/>
                  </div>
                  <div className="form-row">
                    <input placeholder="M√≠sto (nap≈ô. Praha 6)" value={form.place} onChange={e=>setForm({...form,place:e.target.value})} style={{flex:1}}/>
                    <input placeholder="Popis ƒçinnosti" value={form.activity} onChange={e=>setForm({...form,activity:e.target.value})} style={{flex:2}}/>
                    <button type="submit">P≈ôidat</button>
                  </div>
                </form>
                <table className="table">
                  <thead><tr><th>Datum</th><th>Hodiny</th><th>Zak√°zka</th><th>M√≠sto</th><th>Popis ƒçinnosti</th><th></th></tr></thead>
                  <tbody>
                    {rows.map(r=>(
                      <tr key={r.id}>
                        <td>{toCZ(r.date)}</td><td>{r.hours}</td><td>{r.job_title}</td><td>{r.place||"-"}</td><td>{r.activity||"-"}</td>
                        <td><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {rows.length===0 && <div className="small">Zat√≠m ≈æ√°dn√© z√°znamy.</div>}
              </div>
            </div>
          </div>
        );
      }

      const CATS = ['trvalky','tr√°vy','d≈ôeviny','stromy','cibuloviny','hnojiva/post≈ôiky','materi√°l zahrada','materi√°l stavba'];
      function Warehouse(){
        const [site,setSite]=useState("lipnik"); const [list,setList]=useState([]); const [form,setForm]=useState({category:CATS[0],name:"",qty:0,unit:"ks"}); const [q,setQ]=useState("");
        async function load(){ try{ const j=await api("/api/items?site="+site); setList(j.items||[]); }catch(e){ console.error(e);} } useEffect(()=>{ load().catch(()=>{}); },[site]);
        async function add(e){ e.preventDefault(); await api("/api/items",{method:"POST",body:JSON.stringify({...form,site})}); setForm({category:CATS[0],name:"",qty:0,unit:"ks"}); load(); }
        async function del(id){ if(!confirm("Smazat polo≈æku?")) return; await api("/api/items?id="+id,{method:"DELETE"}); load(); }
        const filtered = React.useMemo(()=> list.filter(r=> (r.name||"").toLowerCase().includes(q.toLowerCase())), [list,q]);
        return (<div><div style={{display:"flex",gap:8,alignItems:"center",margin:"8px 0 12px"}}>
          <div className="tabs"><div className={"tab"+(site==="lipnik"?" active":"")} onClick={()=>setSite("lipnik")}>Lipn√≠k</div><div className={"tab"+(site==="praha"?" active":"")} onClick={()=>setSite("praha")}>Praha</div></div>
          <div className="search" style={{flex:1}}><input value={q} onChange={e=> setQ(e.target.value)} placeholder="Hledat polo≈æku‚Ä¶"/><button className="ghost">Hledat</button></div>
          <a className="ghost" href="/export/warehouse.xlsx">Export XLSX</a></div>
          <div className="card"><div className="card-h"><div>Nov√° polo≈æka</div></div><div className="card-c">
            <form onSubmit={add}><div className="form-row">
              <select value={form.category} onChange={e=>setForm({...form,category:e.target.value})}>{CATS.map(c=>(<option key={c}>{c}</option>))}</select>
              <input placeholder="N√°zev" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:2}}/>
              <input type="number" step="0.01" placeholder="Mno≈æstv√≠" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} required style={{width:120}}/>
              <input placeholder="Jedn." value={form.unit} onChange={e=>setForm({...form,unit:e.target.value})} required style={{width:80}}/>
              <button type="submit">P≈ôidat</button></div></form></div></div>
          <div className="card"><div className="card-h"><div>Invent√°≈ô ‚Äì {site==="lipnik"?"Lipn√≠k":"Praha"}</div></div><div className="card-c">
            <div className="row h"><div style={{gridColumn:"span 4"}}>Kategorie</div><div style={{gridColumn:"span 6"}}>N√°zev</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Mno≈æstv√≠</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Jedn.</div></div>
            {filtered.length===0 && <div className="small">Pr√°zdn√© ‚Äì p≈ôidej polo≈æky v√Ω≈°e.</div>}
            {filtered.map(r=> (<div className="row small" key={r.id}><div style={{gridColumn:"span 4"}}>{r.category}</div><div style={{gridColumn:"span 6"}}>{r.name}</div><div style={{gridColumn:"span 1",textAlign:"right"}}>{r.qty}</div><div style={{gridColumn:"span 1",textAlign:"right"}}>{r.unit}</div>
              <div style={{gridColumn:"span 12",textAlign:"right"}}><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></div></div>))}
          </div></div></div>);
      }

      function UsersTab(){
        const [list,setList]=useState([]); const [form,setForm]=useState({email:"",name:"",role:"worker",password:""}); const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/users"); setList(j.users||[]); }catch(e){ setErr(e.message);} } useEffect(()=>{load().catch(()=>{}); },[]);
        async function create(e){ e.preventDefault(); await api("/api/users",{method:"POST",body:JSON.stringify(form)}); setForm({email:"",name:"",role:"worker",password:""}); load(); }
        async function setRole(id,role){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id,role})}); load(); }
        async function toggleActive(u){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id:u.id,active:!u.active})}); load(); }
        return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
          <div className="card"><div className="card-h"><div>Nov√Ω u≈æivatel</div></div><div className="card-c">
            <form onSubmit={create}><div className="form-row">
              <input placeholder="E‚Äëmail" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required style={{flex:1}}/>
              <input placeholder="Jm√©no" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/></div>
              <div className="form-row"><select value={form.role} onChange={e=>setForm({...form,role:e.target.value})}><option value="worker">worker</option><option value="manager">manager</option><option value="admin">admin</option></select>
              <input type="password" placeholder="Heslo" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} required/><button type="submit">Vytvo≈ôit</button></div></form>
          </div></div>
          <div className="card"><div className="card-h"><div>U≈æivatel√©</div></div><div className="card-c">
            {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
            <table className="table"><thead><tr><th>ID</th><th>E‚Äëmail</th><th>Jm√©no</th><th>Role</th><th>Aktivn√≠</th><th></th></tr></thead><tbody>
              {list.map(u=>(<tr key={u.id}><td>{u.id}</td><td>{u.email}</td><td>{u.name}</td><td>{u.role}</td><td>{u.active? "ano":"ne"}</td>
                <td className="small"><button className="ghost" onClick={()=>setRole(u.id,"worker")}>worker</button>
                  <button className="ghost" onClick={()=>setRole(u.id,"manager")}>manager</button>
                  <button className="ghost" onClick={()=>setRole(u.id,"admin")}>admin</button>
                  <button className="ghost" onClick={()=>toggleActive(u)}>{u.active?"deaktivovat":"aktivovat"}</button></td></tr>))}
            </tbody></table>
          </div></div>
        </div>);
      }


      function ArchiveTab({onOpen}){
        const [monthsData,setMonthsData] = useState({});
        const [years,setYears] = useState([]);
        const [activeYear,setActiveYear] = useState("");
        const [err,setErr] = useState("");

        useEffect(() => {
          (async () => {
            try{
              const j = await api("/api/jobs/archive");
              const months = j.months || {};
              const byYear = {};
              Object.keys(months).forEach(ym => {
                if(!ym || ym === "unknown") return;
                const parts = String(ym).split("-");
                if(parts.length < 2) return;
                const year = parts[0];
                const monthIdx = parseInt(parts[1],10) - 1;
                if(monthIdx < 0 || monthIdx > 11) return;
                if(!byYear[year]) byYear[year] = Array.from({length:12}, () => []);
                byYear[year][monthIdx] = months[ym] || [];
              });
              const yearsSorted = Object.keys(byYear).sort().reverse();
              setYears(yearsSorted);
              if(yearsSorted.length && !activeYear){
                setActiveYear(yearsSorted[0]);
              }
              setMonthsData(byYear);
            }catch(e){
              console.error(e);
              setErr(e.message || String(e));
            }
          })();
        }, []);

        const monthNames = ["Leden","√önor","B≈ôezen","Duben","Kvƒõten","ƒåerven","ƒåervenec","Srpen","Z√°≈ô√≠","≈ò√≠jen","Listopad","Prosinec"];

        const yearData = (activeYear && monthsData[activeYear]) || [];

        function openJob(id){
          if(onOpen) onOpen(id);
        }

        return (
          <div className="card">
            <div className="card-h">
              <div>Archiv zak√°zek</div>
              {years.length > 0 && (
                <div style={{marginLeft:"auto"}}>
                  <select value={activeYear} onChange={e=>setActiveYear(e.target.value)}>
                    {years.map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
              )}
            </div>
            <div className="card-c">
              {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
              {years.length === 0 && !err && (
                <div className="small">Zat√≠m ≈æ√°dn√© dokonƒçen√© zak√°zky.</div>
              )}
              {years.length > 0 && (
                <div className="archive-grid">
                  {monthNames.map((name, idx) => {
                    const jobs = (yearData && yearData[idx]) || [];
                    return (
                      <div className="archive-month-card" key={idx}>
                        <div className="archive-month-head">
                          <div className="archive-month-title">{name}</div>
                          {jobs.length > 0 && (
                            <div className="archive-month-count small">
                              {jobs.length} zak√°zek
                            </div>
                          )}
                        </div>
                        <div className="archive-month-body small">
                          {jobs.length === 0 && (
                            <div>≈Ω√°dn√© dokonƒçen√© zak√°zky.</div>
                          )}
                          {jobs.map(j => (
                            <div className="archive-job-row" key={j.id}>
                              <div className="archive-job-main">
                                <div className="archive-job-title">{j.title}</div>
                              </div>
                              <div className="archive-job-actions">
                                <button type="button" onClick={() => openJob(j.id)}>Otev≈ô√≠t detail</button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      }

      function TasksTab(){
        const [list,setList]=useState([]);
        const [employees,setEmployees]=useState([]);
        const [jobs,setJobs]=useState([]);
        const [form,setForm]=useState({title:"",description:"",due_date:"",employee_id:"",job_id:""});
        async function load(){ try{ const [t,e,j]=await Promise.all([api("/api/tasks"), api("/api/employees"), api("/api/jobs")]); setList(t.tasks||[]); setEmployees(e.employees||[]); setJobs(j.jobs||[]); }catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        async function add(e){ e.preventDefault(); await api("/api/tasks",{method:"POST",body:JSON.stringify({...form, due_date: toISODateFlex(form.due_date)})}); setForm({title:"",description:"",due_date:"",employee_id:"",job_id:""}); load(); }
        async function setStatus(t, status){ await api("/api/tasks",{method:"PATCH",body:JSON.stringify({id:t.id,status})}); load(); }
        async function del(t){ if(!confirm("Smazat √∫kol?")) return; await api("/api/tasks?id="+t.id,{method:"DELETE"}); load(); }
        return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
          <div className="card"><div className="card-h"><div>√ökoly</div></div><div className="card-c">
            <form onSubmit={add}><div className="form-row">
              <input placeholder="Nadpis" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} required style={{flex:2}}/>
              <input placeholder="Term√≠n (YYYY-MM-DD)" value={form.due_date} onChange={e=>setForm({...form,due_date:e.target.value})}/>
              <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})}><option value="">Bez p≈ôi≈ôazen√≠</option>{employees.map(emp=>(<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select>
              <select value={form.job_id} onChange={e=>setForm({...form,job_id:e.target.value})}><option value="">Bez zak√°zky</option>{jobs.map(j=>(<option key={j.id} value={j.id}>{j.title}</option>))}</select>
              <button type="submit">P≈ôidat</button>
            </div><div className="form-row"><input placeholder="Popis" value={form.description} onChange={e=>setForm({...form,description:e.target.value})} style={{flex:1}}/></div></form>
            <table className="table"><thead><tr><th>Stav</th><th>N√°zev</th><th>Zamƒõstnanec</th><th>Zak√°zka</th><th>Term√≠n</th><th></th></tr></thead><tbody>
              {list.map(t=>(<tr key={t.id}><td><span className="badge">{t.status}</span></td><td>{t.title}</td><td>{t.employee_id || "-"}</td><td>{t.job_id || "-"}</td><td>{t.due_date || "-"}</td>
              <td className="small"><button className="ghost" onClick={()=>setStatus(t,"nov√Ω")}>nov√Ω</button><button className="ghost" onClick={()=>setStatus(t,"prob√≠h√°")}>prob√≠h√°</button><button className="ghost" onClick={()=>setStatus(t,"hotovo")}>hotovo</button><button className="ghost" onClick={()=>del(t)}>smazat</button></td></tr>))}
            </tbody></table>
            {list.length===0 && <div className="small">Zat√≠m ≈æ√°dn√© √∫koly.</div>}
          </div></div>
        </div>);
      }

      function Dashboard({user, taskCount}){
        const [stats,setStats]=useState({
          activeJobs:0,employees:0,tasks:0,
          totalHoursWeek:0,totalHoursMonth:0,
          topEmployee:null,upcomingTasks:0,
          pendingTasks:0,urgentTasks:0,
          onlineEmployees:0,totalEmployees:0
        });
        const [activeJobs,setActiveJobs]=useState([]);
        const [todayEvents,setTodayEvents]=useState([]);
        const [teamStatus,setTeamStatus]=useState([]);
        const [notifications,setNotifications]=useState([]);
        const [chartData,setChartData]=useState({monthly:[],breakdown:[]});
        const [chartPeriod,setChartPeriod]=useState("week");
        
        useEffect(()=>{
          (async()=>{
            try{
              // Get this week's timesheets
              const today = new Date();
              const monday = new Date(today);
              monday.setDate(today.getDate() - ((today.getDay()+6)%7));
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6);
              const fmt = (d)=>d.toISOString().slice(0,10);
              const timesheets = await api(`/api/timesheets?from=${fmt(monday)}&to=${fmt(sunday)}`);
              const totalHWeek = (timesheets.rows||[]).reduce((s,r)=>s+(r.hours||0),0);
              
              // Get this month's timesheets
              const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
              const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              const timesheetsMonth = await api(`/api/timesheets?from=${fmt(monthStart)}&to=${fmt(monthEnd)}`);
              const totalHMonth = (timesheetsMonth.rows||[]).reduce((s,r)=>s+(r.hours||0),0);
              
              // Get jobs
              const jobs = await api("/api/jobs");
              const active = (jobs.jobs||[]).filter(j=>j.status==="Prob√≠h√°"||j.status==="Pl√°n").length;
              const activeList = (jobs.jobs||[]).filter(j=>j.status==="Prob√≠h√°"||j.status==="Pl√°n").slice(0,5);
              
              // Get employees
              const emps = await api("/api/employees");
              const empCount = (emps.employees||[]).length;
              
              // Get tasks
              const tasks = await api("/api/tasks");
              const taskCount = (tasks.tasks||[]).length;
              const pending = (tasks.tasks||[]).filter(t=>t.status==="open"||t.status==="in-progress").length;
              const todayDate = today.toISOString().slice(0,10);
              const urgent = (tasks.tasks||[]).filter(t=>t.due_date===todayDate&&t.status!=="completed").length;
              const upcoming = (tasks.tasks||[]).filter(t=>t.status!=="completed"&&t.due_date&&new Date(t.due_date)>=today).length;
              
              // Get today's events (deadlines, tasks)
              const events = [];
              (tasks.tasks||[]).filter(t=>t.due_date===todayDate).forEach(t=>{
                events.push({time:"09:00",type:"deadline",title:`‚ö†Ô∏è Deadline - ${t.title}`,description:"Dokonƒçen√≠ prac√≠",urgent:true});
              });
              
              // Get team status (simplified - based on recent activity)
              const empStatus = [];
              (emps.employees||[]).forEach(emp=>{
                const empTimesheets = (timesheets.rows||[]).filter(ts=>ts.employee_id===emp.id);
                const hasRecentActivity = empTimesheets.some(ts=>{
                  const tsDate = new Date(ts.date);
                  const diff = (today - tsDate) / (1000 * 60 * 60);
                  return diff < 24;
                });
                if(hasRecentActivity){
                  const jobHours = {};
                  empTimesheets.forEach(ts=>{
                    const job = (jobs.jobs||[]).find(j=>j.id===ts.job_id);
                    if(job) jobHours[job.title||`Zak√°zka ${job.id}`] = (jobHours[job.title||`Zak√°zka ${job.id}`]||0) + (ts.hours||0);
                  });
                  const currentJob = Object.entries(jobHours).sort((a,b)=>b[1]-a[1])[0];
                  empStatus.push({
                    id:emp.id,
                    name:emp.name,
                    status:hasRecentActivity?'online':'offline',
                    currentWork:currentJob ? `üìã ${currentJob[0]}` : '‚òï Pauza',
                    hours:currentJob ? currentJob[1].toFixed(1) : '0'
                  });
                }
              });
              
              // Calculate online employees
              const onlineCount = empStatus.filter(e=>e.status==='online').length;
              
              // Monthly chart data (last 30 days)
              const monthlyData = [];
              for(let i=29;i>=0;i--){
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dayTimesheets = (timesheetsMonth.rows||[]).filter(ts=>ts.date===date.toISOString().slice(0,10));
                const hours = dayTimesheets.reduce((s,r)=>s+(r.hours||0),0);
                monthlyData.push({date:date.toLocaleDateString('cs-CZ',{day:'2-digit',month:'2-digit'}),hours});
              }
              
              // Time breakdown (simplified - by job type)
              const breakdownData = [];
              const jobTypes = {};
              (timesheets.rows||[]).forEach(r=>{
                const job = (jobs.jobs||[]).find(j=>j.id===r.job_id);
                const type = job ? (job.status||'Jin√©') : 'Jin√©';
                jobTypes[type] = (jobTypes[type]||0) + (r.hours||0);
              });
              Object.entries(jobTypes).forEach(([type,hours])=>{
                breakdownData.push({name:type,hours});
              });
              
              // Notifications
              const notifs = [];
              if(urgent>0){
                notifs.push({icon:"‚ö†Ô∏è",type:"warning",title:"Deadline bl√≠≈æ√≠!",text:`${urgent} √∫kol${urgent>1?'y':'≈Ø'} konƒç√≠ dnes`,time:"p≈ôed 10 min",unread:true});
              }
              if(stats.totalHoursWeek>0){
                notifs.push({icon:"‚úÖ",type:"success",title:"V√Ωkaz schv√°len",text:"Tv≈Øj v√Ωkaz za minul√Ω t√Ωden byl schv√°len",time:"p≈ôed 1h",unread:false});
              }
              
              // Calculate top employee
              const empHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const name = r.employee_name || 'Nezn√°m√Ω';
                empHours[name] = (empHours[name]||0) + (r.hours||0);
              });
              const topEmp = Object.entries(empHours).sort((a,b)=>b[1]-a[1])[0];
              
              // Chart data - hours per employee
              const empChartData = Object.entries(empHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              // Chart data - hours per job
              const jobHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const title = r.job_title || `Zak√°zka ${r.job_id}`;
                jobHours[title] = (jobHours[title]||0) + (r.hours||0);
              });
              const jobChartData = Object.entries(jobHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              setStats({
                activeJobs: active,
                employees: empCount,
                tasks: taskCount,
                totalHoursWeek: totalHWeek,
                totalHoursMonth: totalHMonth,
                topEmployee: topEmp ? {name:topEmp[0],hours:topEmp[1]} : null,
                upcomingTasks: upcoming,
                pendingTasks: pending,
                urgentTasks: urgent,
                onlineEmployees: onlineCount,
                totalEmployees: empCount
              });
              
              setActiveJobs(activeList);
              setTodayEvents(events);
              setTeamStatus(empStatus);
              setNotifications(notifs);
              setChartData({monthly:monthlyData,breakdown:breakdownData});
            }catch(e){console.error(e);}
          })();
        },[]);
        
        // Attach search event listeners
        useEffect(() => {
          const searchInput = document.getElementById('global-search');
          const searchBtn = document.getElementById('search-btn');
          if(searchInput && searchBtn){
            function doSearch(){
              const query = searchInput.value.trim();
              if(!query) return;
              window.location.href = '/search?q=' + encodeURIComponent(query);
            }
            searchBtn.onclick = doSearch;
            searchInput.onkeypress = function(e){
              if(e.key === 'Enter') doSearch();
            };
          }
        }, [stats]);
        
        // Simple SVG Bar Chart Component
        const BarChart = ({data,height=200,color="#3ea76a"})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          const max = Math.max(...data.map(d=>d.hours),1);
          const barWidth = 280 / data.length;
          return <svg width="100%" height={height} style={{overflow:"visible"}}>
            {data.map((d,i)=>{
              const barHeight = Math.max(0, (d.hours/max)*150);
              const rectWidth = Math.max(1, barWidth-10);
              return <g key={i}>
                <rect x={i*barWidth+10} y={height-barHeight-20} width={rectWidth} height={barHeight} fill={color} opacity={0.8} rx={4}/>
                <text x={i*barWidth+barWidth/2+5} y={height-5} fontSize="10" fill="#9ca8b3" textAnchor="middle">{d.name.substring(0,8)}</text>
                <text x={i*barWidth+barWidth/2+5} y={height-barHeight-25} fontSize="11" fill="#e8eef2" textAnchor="middle" fontWeight="600">{d.hours.toFixed(1)}h</text>
              </g>;
            })}
          </svg>;
        };
        
        // Simple SVG Pie Chart Component
        const PieChart = ({data,size=200,colors=["#3ea76a","#4bb878","#2d8f55","#1f6b42","#0d4d2a"]})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          const total = data.reduce((s,d)=>s+d.hours,0);
          if(total===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          let currentAngle = -90;
          const center = size/2;
          const radius = size/2-20;
          return <svg width={size} height={size} style={{margin:"0 auto",display:"block"}}>
            {data.map((d,i)=>{
              const angle = (d.hours/total)*360;
              const startAngle = currentAngle;
              const endAngle = currentAngle + angle;
              currentAngle += angle;
              const x1 = center + radius*Math.cos(startAngle*Math.PI/180);
              const y1 = center + radius*Math.sin(startAngle*Math.PI/180);
              const x2 = center + radius*Math.cos(endAngle*Math.PI/180);
              const y2 = center + radius*Math.sin(endAngle*Math.PI/180);
              const largeArc = angle>180?1:0;
              return <path key={i} d={`M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={colors[i%colors.length]} opacity={0.8} stroke="#0a0e11" strokeWidth="2"/>
            })}
            <text x={center} y={center+5} fontSize="14" fill="#e8eef2" textAnchor="middle" fontWeight="600">{total.toFixed(1)}h</text>
            <text x={center} y={center+20} fontSize="11" fill="#9ca8b3" textAnchor="middle">Celkem</text>
          </svg>;
        };
        
        const today = new Date();
        const todayStr = today.toLocaleDateString('cs-CZ',{day:'numeric',month:'long',year:'numeric'});
        const weekGoal = 200;
        const weekProgress = stats.totalHoursWeek / weekGoal * 100;
        
        return (<div style={{paddingBottom:100,padding:"20px",maxWidth:"1600px",margin:"0 auto"}}>
          <style>{`
            .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
            .metric-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px; display: flex; gap: 16px; align-items: center; transition: all 0.3s; }
            .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-color: var(--mint); }
            .metric-card.primary { border-left: 4px solid #3b82f6; }
            .metric-card.success { border-left: 4px solid #3ea76a; }
            .metric-card.warning { border-left: 4px solid #fb923c; }
            .metric-card.info { border-left: 4px solid #60a5fa; }
            .metric-icon { font-size: 48px; line-height: 1; }
            .metric-data { flex: 1; }
            .metric-data h2 { font-size: 32px; font-weight: 700; color: #e8eef2; margin: 0 0 4px 0; }
            .metric-data p { font-size: 14px; color: #9ca8b3; margin: 0 0 8px 0; }
            .trend { font-size: 12px; color: #9ca8b3; }
            .trend.up { color: #3ea76a; }
            .progress-mini { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 8px 0 4px 0; }
            .progress-mini .fill { height: 100%; background: linear-gradient(90deg, #3ea76a, #22c55e); transition: width 0.3s; }
            
            .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
            .action-btn { flex: 1; min-width: 150px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 14px; font-weight: 500; }
            .action-btn:hover { background: var(--mint); border-color: var(--mint); color: #0a0e11; transform: translateY(-2px); }
            .action-btn .icon { font-size: 20px; }
            
            .today-timeline { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .today-timeline h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .timeline-item { display: flex; gap: 16px; padding: 12px; border-radius: 8px; margin-bottom: 12px; background: var(--bg-elevated); }
            .timeline-item.urgent { background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fb923c; }
            .timeline-item .time { font-size: 14px; font-weight: 600; color: var(--text-primary); min-width: 60px; }
            .timeline-item .event h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .timeline-item .event p { font-size: 12px; color: var(--text-secondary); margin: 0; }
            
            .active-projects { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .active-projects h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .project-preview { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; }
            .project-info { flex: 1; }
            .project-info h4 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .project-info p { font-size: 12px; color: var(--text-secondary); margin: 0; }
            .project-progress { position: relative; width: 60px; height: 60px; }
            .progress-circle { width: 60px; height: 60px; position: relative; }
            .progress-circle svg { transform: rotate(-90deg); }
            .progress-circle circle { fill: none; stroke: var(--mint); stroke-width: 6; stroke-dasharray: 188; stroke-dashoffset: 47; transition: stroke-dashoffset 0.3s; }
            .progress-circle span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 600; color: var(--text-primary); }
            .project-deadline .warning { color: #fb923c; font-size: 12px; font-weight: 500; }
            
            .team-status { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .team-status h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .team-member { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; position: relative; }
            .team-member .avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--mint); display: flex; align-items: center; justify-content: center; color: #0a0e11; font-weight: 600; font-size: 18px; }
            .member-info { flex: 1; }
            .member-info h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .member-info .current-work { font-size: 12px; color: var(--text-secondary); margin: 0 0 2px 0; }
            .member-info .time { font-size: 11px; color: var(--text-tertiary); }
            .status-dot { width: 12px; height: 12px; border-radius: 50%; position: absolute; top: 12px; right: 12px; }
            .team-member.online .status-dot { background: var(--mint); }
            .team-member.pause .status-dot { background: #fb923c; }
            
            .dashboard-chart { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .dashboard-chart h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            
            .notifications-widget { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; }
            .notifications-widget h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .notification { display: flex; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; }
            .notification.unread { background: rgba(60, 165, 250, 0.1); border-left: 3px solid #3b82f6; }
            .notif-icon { font-size: 24px; }
            .notif-content { flex: 1; }
            .notif-content p { margin: 0 0 4px 0; font-size: 13px; color: var(--text-primary); }
            .notif-content .time { font-size: 11px; color: var(--text-tertiary); }
            .view-all { width: 100%; padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 14px; margin-top: 8px; }
            .view-all:hover { background: var(--mint); border-color: var(--mint); color: #0a0e11; }
            
            @media (max-width: 768px) {
              .dashboard-stats { grid-template-columns: 1fr; }
              .quick-actions { flex-direction: column; }
              .action-btn { width: 100%; }
            }
          `}</style>
          
          {/* Top Stat Cards */}
          <div className="dashboard-stats">
            <div className="metric-card primary" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('jobs');}}>
              <div className="metric-icon">üìã</div>
              <div className="metric-data">
                <h2>{stats.activeJobs}</h2>
                <p>Aktivn√≠ zak√°zky</p>
                <span className="trend up">‚Üë 12% vs minul√Ω mƒõs√≠c</span>
              </div>
            </div>
            
            <div className="metric-card success">
              <div className="metric-icon">‚è±Ô∏è</div>
              <div className="metric-data">
                <h2>{stats.totalHoursWeek.toFixed(0)}h</h2>
                <p>Hodiny tento t√Ωden</p>
                <div className="progress-mini">
                  <div className="fill" style={{width: `${Math.min(weekProgress, 100)}%`}}></div>
                </div>
                <span>{Math.round(weekProgress)}% t√Ωdenn√≠ho c√≠le ({weekGoal}h)</span>
              </div>
            </div>
            
            <div className="metric-card warning" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>
              <div className="metric-icon">‚ö†Ô∏è</div>
              <div className="metric-data">
                <h2>{stats.pendingTasks}</h2>
                <p>ƒåekaj√≠c√≠ √∫koly</p>
                <span className="trend">{stats.urgentTasks} s deadline dnes</span>
              </div>
            </div>
            
            <div className="metric-card info" style={{cursor:"pointer"}} onClick={()=>window.location.href="/employees.html"}>
              <div className="metric-icon">üë•</div>
              <div className="metric-data">
                <h2>{stats.onlineEmployees}/{stats.totalEmployees}</h2>
                <p>T√Ωm online</p>
                <span>{stats.totalEmployees>0 ? Math.round(stats.onlineEmployees/stats.totalEmployees*100) : 0}% dostupnost</span>
              </div>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="quick-actions">
            <button className="action-btn" onClick={()=>{if(window.setAppTab) window.setAppTab('jobs');}}>
              <span className="icon">‚ûï</span>
              <span>Nov√° zak√°zka</span>
            </button>
            <button className="action-btn" onClick={()=>window.location.href="/timesheets.html"}>
              <span className="icon">‚è±Ô∏è</span>
              <span>P≈ôidat v√Ωkaz</span>
            </button>
            <button className="action-btn" onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>
              <span className="icon">‚úÖ</span>
              <span>Nov√Ω √∫kol</span>
            </button>
            <button className="action-btn" onClick={()=>{if(window.setAppTab) window.setAppTab('statistics');}}>
              <span className="icon">üìä</span>
              <span>Generovat report</span>
            </button>
          </div>

          {/* Main Grid */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(400px, 1fr))",gap:"24px"}}>
            {/* Left Column */}
            <div>
              {/* Today Timeline */}
              <div className="today-timeline">
                <h3>üìÖ Dnes - {todayStr}</h3>
                {todayEvents.length > 0 ? todayEvents.map((e,i)=><div key={i} className={`timeline-item ${e.urgent?'urgent':''}`}>
                  <div className="time">{e.time}</div>
                  <div className="event">
                    <h4>{e.title}</h4>
                    <p>{e.description}</p>
                  </div>
                </div>) : <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√© ud√°losti na dnes</div>}
              </div>

              {/* Active Projects */}
              <div className="active-projects">
                <h3>üî® Top aktivn√≠ projekty</h3>
                {activeJobs.slice(0,5).map(j=>{
                  const progress = Math.random()*100; // Simplified - would calculate from actual data
                  const daysLeft = j.date ? Math.ceil((new Date(j.date) - today) / (1000*60*60*24)) : null;
                  return <div key={j.id} className="project-preview" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('jobs');}}>
                    <div className="project-info">
                      <h4>{j.title || `Zak√°zka ${j.id}`}</h4>
                      <p>{j.client || '‚Äî'} ‚Ä¢ {j.city || '‚Äî'}</p>
                    </div>
                    <div className="project-progress">
                      <div className="progress-circle" data-progress={progress}>
                        <svg width="60" height="60">
                          <circle cx="30" cy="30" r="30" strokeDashoffset={188 - (Math.max(0, Math.min(100, progress))/100)*188}></circle>
                        </svg>
                        <span>{Math.round(Math.max(0, Math.min(100, progress)))}%</span>
                      </div>
                    </div>
                    {daysLeft !== null && daysLeft >= 0 && daysLeft <= 7 && <div className="project-deadline">
                      <span className="warning">Konƒç√≠ za {daysLeft} {daysLeft===1?'den':daysLeft<5?'dny':'dn√≠'}</span>
                    </div>}
                  </div>;
                })}
                {activeJobs.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√© aktivn√≠ projekty</div>}
              </div>
            </div>

            {/* Right Column */}
            <div>
              {/* Team Status */}
              <div className="team-status">
                <h3>üë• T√Ωm pr√°vƒõ teƒè</h3>
                {teamStatus.slice(0,5).map(m=>{
                  const initials = (m.name||'').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) || '?';
                  return <div key={m.id} className={`team-member ${m.status}`}>
                    <div className="avatar">{initials}</div>
                    <div className="member-info">
                      <h4>{m.name}</h4>
                      <p className="current-work">{m.currentWork}</p>
                      <span className="time">pracuje {m.hours}h</span>
                    </div>
                    <div className="status-dot"></div>
                  </div>;
                })}
                {teamStatus.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√≠ aktivn√≠ zamƒõstnanci</div>}
              </div>

              {/* Charts */}
              <div className="dashboard-chart">
                <h3>üìà V√Ωkon za mƒõs√≠c</h3>
                <BarChart data={chartData.monthly.map(d=>({name:d.date,hours:d.hours}))} height={200} color="#3ea76a"/>
              </div>

              <div className="dashboard-chart">
                <h3>‚è±Ô∏è Rozlo≈æen√≠ ƒçasu</h3>
                <PieChart data={chartData.breakdown} size={200} colors={["#3ea76a","#4bb878","#2d8f55","#1f6b42","#0d4d2a"]}/>
              </div>

              {/* Notifications */}
              <div className="notifications-widget">
                <h3>üîî Upozornƒõn√≠</h3>
                {notifications.map((n,i)=><div key={i} className={`notification ${n.unread?'unread':''}`}>
                  <div className={`notif-icon ${n.type}`}>{n.icon}</div>
                  <div className="notif-content">
                    <p><strong>{n.title}</strong></p>
                    <p>{n.text}</p>
                    <span className="time">{n.time}</span>
                  </div>
                </div>)}
                {notifications.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√° upozornƒõn√≠</div>}
                <button className="view-all" onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>Zobrazit v≈°echny</button>
              </div>
            </div>
          </div>

        </div>);
      }

      function App(){
        const [auth,setAuth]=useState({ready:false, ok:false, user:null, tasks:0}); const [tab, setTab] = useState("dashboard"); const [jobOpen,setJobOpen]=useState(null);
        useEffect(()=>{(async()=>{ try{ const j=await api("/api/me"); setAuth({ready:true, ok:j.authenticated, user:j.user||null, tasks:j.tasks_count||0}); refreshUserBox(); }catch(e){ showJSError(e.message);} })()},[]);
        if(!auth.ready) return <div className="small">Naƒç√≠t√°m‚Ä¶</div>;
        if(!auth.ok) return <Login onLogged={()=>location.reload()}/>;
        // Store setTab in window for menu access
        window.setAppTab = (k) => { setTab(k); setJobOpen(null); };
        window.appTab = tab;
        window.appCanAdmin = auth.user?.role==="admin";
        
        return (<div>
          {/* Tabs moved to "V√≠ce" menu */}
          {tab==="dashboard" && <Dashboard user={auth.user} taskCount={auth.tasks}/>}
          {tab==="jobs" && (jobOpen? <JobDetail jobId={jobOpen} onBack={()=>setJobOpen(null)}/> : <JobsList onOpen={setJobOpen}/>)}
          {tab==="archive" && <ArchiveTab onOpen={(id)=>{ setJobOpen(id); setTab("jobs"); }}/>}
          {tab==="tasks" && <TasksTab/>}
          {tab==="employees" && <Employees/>}
          {tab==="warehouse" && <Warehouse/>}
          {tab==="users" && auth.user?.role==="admin" && <UsersTab/>}
          {tab==="statistics" && <StatisticsTab user={auth.user}/>}
        </div>);
      }

      // Employees root (needs after App def)
      function Employees(){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({name:"",role:"Zahradn√≠k"});
        const [editId,setEditId]=useState(null);
        const [edit,setEdit]=useState({name:"",role:""});
        const [changeIdFor,setChangeIdFor]=useState(null);
        const [newId,setNewId]=useState("");
        const [open,setOpen]=useState(null);
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/employees"); setList(j.employees||[]); }catch(e){ setErr(e.message);} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        async function add(e){ e.preventDefault(); await api("/api/employees",{method:"POST",body:JSON.stringify(form)}); setForm({name:"",role:"Zahradn√≠k"}); load(); }
        async function del(id){ if(!confirm("Smazat zamƒõstnance?")) return; await api("/api/employees?id="+id,{method:"DELETE"}); load(); }
        
        async function startEdit(e){ setEditId(e.id); setEdit({name:e.name, role:e.role}); }
        async function cancelEdit(){ setEditId(null); setEdit({name:"",role:""}); }
        async function saveEdit(e){
          await api("/api/employees",{method:"PATCH", body: JSON.stringify({id:e.id, name:edit.name, role:edit.role})});
          setEditId(null); setEdit({name:"",role:""}); load();
        }

        async function startChangeId(e){ setChangeIdFor(e.id); setNewId(String(e.id)); }
        async function cancelChangeId(){ setChangeIdFor(null); setNewId(""); }
        async function saveChangeId(e){
          const nid = parseInt(newId, 10);
          if(!nid || nid<=0){ alert("Zadej platn√© ƒç√≠slo ID"); return; }
          await api("/api/employees/reassign_id",{method:"POST", body: JSON.stringify({old_id:e.id,new_id:nid})});
          setChangeIdFor(null); setNewId(""); load();
        }
if(open){ const emp=list.find(x=>x.id===open); if(emp) return <EmployeeDetail employee={emp} onBack={()=>setOpen(null)}/>; }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nov√Ω zamƒõstnanec</div></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <input placeholder="Jm√©no" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/>
                    <input placeholder="Role (nap≈ô. Zahradn√≠k)" value={form.role} onChange={e=>setForm({...form,role:e.target.value})} required style={{flex:1}}/>
                    <button type="submit">P≈ôidat</button>
                  </div>
                </form>
              </div>
            </div>
            <div className="card">
              <div className="card-h"><div>Seznam</div></div>
              <div className="card-c">
                {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
                <table className="table">
                  <thead><tr><th>ID</th><th>Jm√©no</th><th>Role</th><th></th></tr></thead>
                  <tbody>
                    {list.map(e=>(
                      <tr key={e.id}>
                        <td>{e.id}</td>
                        <td>{editId===e.id ? (<input value={edit.name} onChange={ev=>setEdit({...edit,name:ev.target.value})} placeholder="Jm√©no"/>) : (<span className="link" onClick={()=>setOpen(e.id)}>{e.name}</span>)}</td>
                        <td>{editId===e.id ? (<input value={edit.role} onChange={ev=>setEdit({...edit,role:ev.target.value})} placeholder="Role"/>) : e.role}</td>
                        <td>
                          {editId===e.id ? (
                            <>
                              <button onClick={()=>saveEdit(e)}>Ulo≈æit</button>
                              <button className="ghost" onClick={cancelEdit} style={{marginLeft:6}}>Zru≈°it</button>
                            </>
                          ) : changeIdFor===e.id ? (
                            <>
                              <input type="number" value={newId} onChange={ev=>setNewId(ev.target.value)} placeholder="Nov√© ID" style={{width:100}}/>
                              <button onClick={()=>saveChangeId(e)} style={{marginLeft:6}}>Ulo≈æit ID</button>
                              <button className="ghost" onClick={cancelChangeId} style={{marginLeft:6}}>Zru≈°it</button>
                            </>
                          ) : (
                            <>
                              <button onClick={()=>setOpen(e.id)}>Detail</button>
                              <button className="ghost" onClick={()=>startEdit(e)} style={{marginLeft:6}}>Upravit</button>
                              <button className="ghost" onClick={()=>startChangeId(e)} style={{marginLeft:6}}>Zmƒõnit ID</button>
                              <button className="ghost" onClick={()=>del(e.id)} style={{marginLeft:6}}>Smazat</button>
                            </>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {list.length===0 && <div className="small">Zat√≠m ≈æ√°dn√≠ zamƒõstnanci ‚Äì p≈ôidej prvn√≠ho v√Ω≈°e.</div>}
              </div>
            </div>
          </div>
        );
      }

      function ReportsTab({user}){
        const [stats,setStats]=useState({
          activeJobs:0,employees:0,tasks:0,
          totalHoursWeek:0,totalHoursMonth:0,
          topEmployee:null,upcomingTasks:0,
          pendingTasks:0,urgentTasks:0,
          onlineEmployees:0,totalEmployees:0
        });
        const [activeJobs,setActiveJobs]=useState([]);
        const [todayEvents,setTodayEvents]=useState([]);
        const [teamStatus,setTeamStatus]=useState([]);
        const [notifications,setNotifications]=useState([]);
        const [chartData,setChartData]=useState({monthly:[],breakdown:[]});
        const [chartPeriod,setChartPeriod]=useState("week");
        
        useEffect(()=>{
          (async()=>{
            try{
              // Get this week's timesheets
              const today = new Date();
              const monday = new Date(today);
              monday.setDate(today.getDate() - ((today.getDay()+6)%7));
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6);
              const fmt = (d)=>d.toISOString().slice(0,10);
              const timesheets = await api(`/api/timesheets?from=${fmt(monday)}&to=${fmt(sunday)}`);
              const totalHWeek = (timesheets.rows||[]).reduce((s,r)=>s+(r.hours||0),0);
              
              // Get this month's timesheets
              const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
              const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              const timesheetsMonth = await api(`/api/timesheets?from=${fmt(monthStart)}&to=${fmt(monthEnd)}`);
              const totalHMonth = (timesheetsMonth.rows||[]).reduce((s,r)=>s+(r.hours||0),0);
              
              // Get jobs
              const jobs = await api("/api/jobs");
              const active = (jobs.jobs||[]).filter(j=>j.status==="Prob√≠h√°"||j.status==="Pl√°n").length;
              const activeList = (jobs.jobs||[]).filter(j=>j.status==="Prob√≠h√°"||j.status==="Pl√°n").slice(0,5);
              
              // Get employees
              const emps = await api("/api/employees");
              const empCount = (emps.employees||[]).length;
              
              // Get tasks
              const tasks = await api("/api/tasks");
              const taskCount = (tasks.tasks||[]).length;
              const pending = (tasks.tasks||[]).filter(t=>t.status==="open"||t.status==="in-progress").length;
              const todayDate = today.toISOString().slice(0,10);
              const urgent = (tasks.tasks||[]).filter(t=>t.due_date===todayDate&&t.status!=="completed").length;
              const upcoming = (tasks.tasks||[]).filter(t=>t.status!=="completed"&&t.due_date&&new Date(t.due_date)>=today).length;
              
              // Get today's events (deadlines, tasks)
              const events = [];
              (tasks.tasks||[]).filter(t=>t.due_date===todayDate).forEach(t=>{
                events.push({time:"09:00",type:"deadline",title:`‚ö†Ô∏è Deadline - ${t.title}`,description:"Dokonƒçen√≠ prac√≠",urgent:true});
              });
              
              // Get team status (simplified - based on recent activity)
              const empStatus = [];
              (emps.employees||[]).forEach(emp=>{
                const empTimesheets = (timesheets.rows||[]).filter(ts=>ts.employee_id===emp.id);
                const hasRecentActivity = empTimesheets.some(ts=>{
                  const tsDate = new Date(ts.date);
                  const diff = (today - tsDate) / (1000 * 60 * 60);
                  return diff < 24;
                });
                if(hasRecentActivity){
                  const jobHours = {};
                  empTimesheets.forEach(ts=>{
                    const job = (jobs.jobs||[]).find(j=>j.id===ts.job_id);
                    if(job) jobHours[job.title||`Zak√°zka ${job.id}`] = (jobHours[job.title||`Zak√°zka ${job.id}`]||0) + (ts.hours||0);
                  });
                  const currentJob = Object.entries(jobHours).sort((a,b)=>b[1]-a[1])[0];
                  empStatus.push({
                    id:emp.id,
                    name:emp.name,
                    status:hasRecentActivity?'online':'offline',
                    currentWork:currentJob ? `üìã ${currentJob[0]}` : '‚òï Pauza',
                    hours:currentJob ? currentJob[1].toFixed(1) : '0'
                  });
                }
              });
              
              // Calculate online employees
              const onlineCount = empStatus.filter(e=>e.status==='online').length;
              
              // Monthly chart data (last 30 days)
              const monthlyData = [];
              for(let i=29;i>=0;i--){
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dayTimesheets = (timesheetsMonth.rows||[]).filter(ts=>ts.date===date.toISOString().slice(0,10));
                const hours = dayTimesheets.reduce((s,r)=>s+(r.hours||0),0);
                monthlyData.push({date:date.toLocaleDateString('cs-CZ',{day:'2-digit',month:'2-digit'}),hours});
              }
              
              // Time breakdown (simplified - by job type)
              const breakdownData = [];
              const jobTypes = {};
              (timesheets.rows||[]).forEach(r=>{
                const job = (jobs.jobs||[]).find(j=>j.id===r.job_id);
                const type = job ? (job.status||'Jin√©') : 'Jin√©';
                jobTypes[type] = (jobTypes[type]||0) + (r.hours||0);
              });
              Object.entries(jobTypes).forEach(([type,hours])=>{
                breakdownData.push({name:type,hours});
              });
              
              // Notifications
              const notifs = [];
              if(urgent>0){
                notifs.push({icon:"‚ö†Ô∏è",type:"warning",title:"Deadline bl√≠≈æ√≠!",text:`${urgent} √∫kol${urgent>1?'y':'≈Ø'} konƒç√≠ dnes`,time:"p≈ôed 10 min",unread:true});
              }
              if(totalHWeek>0){
                notifs.push({icon:"‚úÖ",type:"success",title:"V√Ωkaz schv√°len",text:"Tv≈Øj v√Ωkaz za minul√Ω t√Ωden byl schv√°len",time:"p≈ôed 1h",unread:false});
              }
              
              // Calculate top employee
              const empHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const name = r.employee_name || 'Nezn√°m√Ω';
                empHours[name] = (empHours[name]||0) + (r.hours||0);
              });
              const topEmp = Object.entries(empHours).sort((a,b)=>b[1]-a[1])[0];
              
              // Chart data - hours per employee
              const empChartData = Object.entries(empHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              // Chart data - hours per job
              const jobHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const title = r.job_title || `Zak√°zka ${r.job_id}`;
                jobHours[title] = (jobHours[title]||0) + (r.hours||0);
              });
              const jobChartData = Object.entries(jobHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              setStats({
                activeJobs: active,
                employees: empCount,
                tasks: taskCount,
                totalHoursWeek: totalHWeek,
                totalHoursMonth: totalHMonth,
                topEmployee: topEmp ? {name:topEmp[0],hours:topEmp[1]} : null,
                upcomingTasks: upcoming,
                pendingTasks: pending,
                urgentTasks: urgent,
                onlineEmployees: onlineCount,
                totalEmployees: empCount
              });
              
              setActiveJobs(activeList);
              setTodayEvents(events);
              setTeamStatus(empStatus);
              setNotifications(notifs);
              setChartData({monthly:monthlyData,breakdown:breakdownData,employees:empChartData,jobs:jobChartData});
            }catch(e){console.error(e);}
          })();
        },[]);
        
        // Simple SVG Bar Chart Component
        const BarChart = ({data,height=200,color="#3ea76a"})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          const max = Math.max(...data.map(d=>d.hours),1);
          const barWidth = 280 / data.length;
          return <svg width="100%" height={height} style={{overflow:"visible"}}>
            {data.map((d,i)=>{
              const barHeight = Math.max(0, (d.hours/max)*150);
              const rectWidth = Math.max(1, barWidth-10);
              return <g key={i}>
                <rect x={i*barWidth+10} y={height-barHeight-20} width={rectWidth} height={barHeight} fill={color} opacity={0.8} rx={4}/>
                <text x={i*barWidth+barWidth/2+5} y={height-5} fontSize="10" fill="#9ca8b3" textAnchor="middle">{d.name.substring(0,8)}</text>
                <text x={i*barWidth+barWidth/2+5} y={height-barHeight-25} fontSize="11" fill="#e8eef2" textAnchor="middle" fontWeight="600">{d.hours.toFixed(1)}h</text>
              </g>;
            })}
          </svg>;
        };
        
        // Simple SVG Pie Chart Component
        const PieChart = ({data,size=200,colors=["#3ea76a","#4bb878","#2d8f55","#1f6b42","#0d4d2a"]})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          const total = data.reduce((s,d)=>s+d.hours,0);
          if(total===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          let currentAngle = -90;
          const center = size/2;
          const radius = size/2-20;
          return <svg width={size} height={size} style={{margin:"0 auto",display:"block"}}>
            {data.map((d,i)=>{
              const angle = (d.hours/total)*360;
              const startAngle = currentAngle;
              const endAngle = currentAngle + angle;
              currentAngle += angle;
              const x1 = center + radius*Math.cos(startAngle*Math.PI/180);
              const y1 = center + radius*Math.sin(startAngle*Math.PI/180);
              const x2 = center + radius*Math.cos(endAngle*Math.PI/180);
              const y2 = center + radius*Math.sin(endAngle*Math.PI/180);
              const largeArc = angle>180?1:0;
              return <path key={i} d={`M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={colors[i%colors.length]} opacity={0.8} stroke="#0a0e11" strokeWidth="2"/>
            })}
            <text x={center} y={center+5} fontSize="14" fill="#e8eef2" textAnchor="middle" fontWeight="600">{total.toFixed(1)}h</text>
            <text x={center} y={center+20} fontSize="11" fill="#9ca8b3" textAnchor="middle">Celkem</text>
          </svg>;
        };
        
        const today = new Date();
        const todayStr = today.toLocaleDateString('cs-CZ',{day:'numeric',month:'long',year:'numeric'});
        const weekGoal = 200;
        const weekProgress = stats.totalHoursWeek / weekGoal * 100;
        
        return (<div style={{paddingBottom:100,padding:"20px",maxWidth:"1600px",margin:"0 auto"}}>
          <style>{`
            .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
            .metric-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px; display: flex; gap: 16px; align-items: center; transition: all 0.3s; }
            .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-color: var(--mint); }
            .metric-card.primary { border-left: 4px solid #3b82f6; }
            .metric-card.success { border-left: 4px solid #3ea76a; }
            .metric-card.warning { border-left: 4px solid #fb923c; }
            .metric-card.info { border-left: 4px solid #60a5fa; }
            .metric-icon { font-size: 48px; line-height: 1; }
            .metric-data { flex: 1; }
            .metric-data h2 { font-size: 32px; font-weight: 700; color: #e8eef2; margin: 0 0 4px 0; }
            .metric-data p { font-size: 14px; color: #9ca8b3; margin: 0 0 8px 0; }
            .trend { font-size: 12px; color: #9ca8b3; }
            .trend.up { color: #3ea76a; }
            .progress-mini { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 8px 0 4px 0; }
            .progress-mini .fill { height: 100%; background: linear-gradient(90deg, #3ea76a, #22c55e); transition: width 0.3s; }
            
            .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
            .action-btn { flex: 1; min-width: 150px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 14px; font-weight: 500; }
            .action-btn:hover { background: var(--mint); border-color: var(--mint); color: #0a0e11; transform: translateY(-2px); }
            .action-btn .icon { font-size: 20px; }
            
            .today-timeline { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .today-timeline h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .timeline-item { display: flex; gap: 16px; padding: 12px; border-radius: 8px; margin-bottom: 12px; background: var(--bg-elevated); }
            .timeline-item.urgent { background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fb923c; }
            .timeline-item .time { font-size: 14px; font-weight: 600; color: var(--text-primary); min-width: 60px; }
            .timeline-item .event h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .timeline-item .event p { font-size: 12px; color: var(--text-secondary); margin: 0; }
            
            .active-projects { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .active-projects h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .project-preview { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; }
            .project-info { flex: 1; }
            .project-info h4 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .project-info p { font-size: 12px; color: var(--text-secondary); margin: 0; }
            .project-progress { position: relative; width: 60px; height: 60px; }
            .progress-circle { width: 60px; height: 60px; position: relative; }
            .progress-circle svg { transform: rotate(-90deg); }
            .progress-circle circle { fill: none; stroke: var(--mint); stroke-width: 6; stroke-dasharray: 188; stroke-dashoffset: 47; transition: stroke-dashoffset 0.3s; }
            .progress-circle span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 600; color: var(--text-primary); }
            .project-deadline .warning { color: #fb923c; font-size: 12px; font-weight: 500; }
            
            .team-status { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .team-status h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .team-member { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; position: relative; }
            .team-member .avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--mint); display: flex; align-items: center; justify-content: center; color: #0a0e11; font-weight: 600; font-size: 18px; }
            .member-info { flex: 1; }
            .member-info h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .member-info .current-work { font-size: 12px; color: var(--text-secondary); margin: 0 0 2px 0; }
            .member-info .time { font-size: 11px; color: var(--text-tertiary); }
            .status-dot { width: 12px; height: 12px; border-radius: 50%; position: absolute; top: 12px; right: 12px; }
            .team-member.online .status-dot { background: var(--mint); }
            .team-member.pause .status-dot { background: #fb923c; }
            
            .dashboard-chart { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .dashboard-chart h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            
            .notifications-widget { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; }
            .notifications-widget h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .notification { display: flex; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; }
            .notification.unread { background: rgba(60, 165, 250, 0.1); border-left: 3px solid #3b82f6; }
            .notif-icon { font-size: 24px; }
            .notif-content { flex: 1; }
            .notif-content p { margin: 0 0 4px 0; font-size: 13px; color: var(--text-primary); }
            .notif-content .time { font-size: 11px; color: var(--text-tertiary); }
            .view-all { width: 100%; padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 14px; margin-top: 8px; }
            .view-all:hover { background: var(--mint); border-color: var(--mint); color: #0a0e11; }
            
            @media (max-width: 768px) {
              .dashboard-stats { grid-template-columns: 1fr; }
              .quick-actions { flex-direction: column; }
              .action-btn { width: 100%; }
            }
          `}</style>
          
          <h1 style={{fontSize:28,fontWeight:700,color:"#e8eef2",marginBottom:24}}>üìä P≈ôehledy</h1>
          
          {/* Top Stat Cards */}
          <div className="dashboard-stats">
            <div className="metric-card primary" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('jobs');}}>
              <div className="metric-icon">üìã</div>
              <div className="metric-data">
                <h2>{stats.activeJobs}</h2>
                <p>Aktivn√≠ zak√°zky</p>
                <span className="trend up">‚Üë 12% vs minul√Ω mƒõs√≠c</span>
              </div>
            </div>
            
            <div className="metric-card success">
              <div className="metric-icon">‚è±Ô∏è</div>
              <div className="metric-data">
                <h2>{stats.totalHoursWeek.toFixed(0)}h</h2>
                <p>Hodiny tento t√Ωden</p>
                <div className="progress-mini">
                  <div className="fill" style={{width: `${Math.min(weekProgress, 100)}%`}}></div>
                </div>
                <span>{Math.round(weekProgress)}% t√Ωdenn√≠ho c√≠le ({weekGoal}h)</span>
              </div>
            </div>
            
            <div className="metric-card warning" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>
              <div className="metric-icon">‚ö†Ô∏è</div>
              <div className="metric-data">
                <h2>{stats.pendingTasks}</h2>
                <p>ƒåekaj√≠c√≠ √∫koly</p>
                <span className="trend">{stats.urgentTasks} s deadline dnes</span>
              </div>
            </div>
            
            <div className="metric-card info" style={{cursor:"pointer"}} onClick={()=>window.location.href="/employees.html"}>
              <div className="metric-icon">üë•</div>
              <div className="metric-data">
                <h2>{stats.onlineEmployees}/{stats.totalEmployees}</h2>
                <p>T√Ωm online</p>
                <span>{stats.totalEmployees>0 ? Math.round(stats.onlineEmployees/stats.totalEmployees*100) : 0}% dostupnost</span>
              </div>
            </div>
          </div>
          
          {/* Quick Actions */}
          <div className="quick-actions">
            <button className="action-btn" onClick={()=>{if(window.setAppTab) window.setAppTab('jobs');}}>
              <span className="icon">‚ûï</span>
              <span>Nov√° zak√°zka</span>
            </button>
            <button className="action-btn" onClick={()=>window.location.href="/timesheets.html"}>
              <span className="icon">‚è±Ô∏è</span>
              <span>P≈ôidat v√Ωkaz</span>
            </button>
            <button className="action-btn" onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>
              <span className="icon">‚úÖ</span>
              <span>Nov√Ω √∫kol</span>
            </button>
            <button className="action-btn" onClick={()=>window.location.href="/reports.html"}>
              <span className="icon">üìä</span>
              <span>Generovat report</span>
            </button>
          </div>
          
          {/* Main Grid */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(400px, 1fr))",gap:"24px"}}>
            {/* Left Column */}
            <div>
              {/* Today Timeline */}
              <div className="today-timeline">
                <h3>üìÖ Dnes - {todayStr}</h3>
                {todayEvents.length > 0 ? todayEvents.map((e,i)=><div key={i} className={`timeline-item ${e.urgent?'urgent':''}`}>
                  <div className="time">{e.time}</div>
                  <div className="event">
                    <h4>{e.title}</h4>
                    <p>{e.description}</p>
                  </div>
                </div>) : <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√© ud√°losti na dnes</div>}
              </div>

              {/* Active Projects */}
              <div className="active-projects">
                <h3>üî® Top aktivn√≠ projekty</h3>
                {activeJobs.slice(0,5).map(j=>{
                  const progress = Math.random()*100; // Simplified - would calculate from actual data
                  const daysLeft = j.date ? Math.ceil((new Date(j.date) - today) / (1000*60*60*24)) : null;
                  return <div key={j.id} className="project-preview" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('jobs');}}>
                    <div className="project-info">
                      <h4>{j.title || `Zak√°zka ${j.id}`}</h4>
                      <p>{j.client || '‚Äî'} ‚Ä¢ {j.city || '‚Äî'}</p>
                    </div>
                    <div className="project-progress">
                      <div className="progress-circle" data-progress={progress}>
                        <svg width="60" height="60">
                          <circle cx="30" cy="30" r="30" strokeDashoffset={188 - (Math.max(0, Math.min(100, progress))/100)*188}></circle>
                        </svg>
                        <span>{Math.round(Math.max(0, Math.min(100, progress)))}%</span>
                      </div>
                    </div>
                    {daysLeft !== null && daysLeft >= 0 && daysLeft <= 7 && <div className="project-deadline">
                      <span className="warning">Konƒç√≠ za {daysLeft} {daysLeft===1?'den':daysLeft<5?'dny':'dn√≠'}</span>
                    </div>}
                  </div>;
                })}
                {activeJobs.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√© aktivn√≠ projekty</div>}
              </div>
            </div>

            {/* Right Column */}
            <div>
              {/* Team Status */}
              <div className="team-status">
                <h3>üë• T√Ωm pr√°vƒõ teƒè</h3>
                {teamStatus.slice(0,5).map(emp=>{
                  const status = emp.status || 'offline';
                  const initials = (emp.name || '').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '?';
                  return <div key={emp.id} className={`team-member ${status}`}>
                    <div className="avatar">{initials}</div>
                    <div className="member-info">
                      <h4>{emp.name || 'Bez jm√©na'}</h4>
                      <p className="current-work">{emp.currentWork || '‚Äî'}</p>
                      <span className="time">{emp.hours || '0'}h</span>
                    </div>
                    <div className="status-dot"></div>
                  </div>;
                })}
                {teamStatus.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√≠ ƒçlenov√© t√Ωmu</div>}
              </div>
              
              {/* Monthly Performance Chart */}
              <div className="dashboard-chart">
                <h3>üìà V√Ωkon za mƒõs√≠c</h3>
                <BarChart data={chartData.monthly.map(d=>({name:d.date,hours:d.hours}))} height={200} color="#3ea76a"/>
              </div>
              
              {/* Time Breakdown Chart */}
              <div className="dashboard-chart">
                <h3>‚è±Ô∏è Rozlo≈æen√≠ ƒçasu</h3>
                <PieChart data={chartData.breakdown} size={200}/>
              </div>
              
              {/* Notifications */}
              <div className="notifications-widget">
                <h3>üîî Upozornƒõn√≠</h3>
                {notifications.length > 0 ? (
                  <>
                    {notifications.slice(0,3).map((notif, idx) => (
                      <div key={idx} className={`notification ${notif.unread ? 'unread' : ''}`}>
                        <div className={`notif-icon ${notif.type}`}>{notif.icon}</div>
                        <div className="notif-content">
                          <p><strong>{notif.title}</strong></p>
                          <p>{notif.text}</p>
                          <span className="time">{notif.time}</span>
                        </div>
                      </div>
                    ))}
                    <button className="view-all" onClick={()=>{if(window.setAppTab) window.setAppTab('notifications');}}>Zobrazit v≈°echny</button>
                  </>
                ) : (
                  <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>≈Ω√°dn√° upozornƒõn√≠</div>
                )}
              </div>
            </div>
          </div>
        </div>);
      }
      
      function StatisticsTab({user}){
        const [chartData,setChartData]=useState({employees:[],jobs:[]});
        const [chartPeriod,setChartPeriod]=useState("week");
        
        useEffect(()=>{
          (async()=>{
            try{
              const today = new Date();
              const monday = new Date(today);
              monday.setDate(today.getDate() - ((today.getDay()+6)%7));
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6);
              const fmt = (d)=>d.toISOString().slice(0,10);
              const timesheets = await api(`/api/timesheets?from=${fmt(monday)}&to=${fmt(sunday)}`);
              
              // Chart data - hours per employee
              const empHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const name = r.employee_name || 'Nezn√°m√Ω';
                empHours[name] = (empHours[name]||0) + (r.hours||0);
              });
              const empChartData = Object.entries(empHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              // Chart data - hours per job
              const jobHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const title = r.job_title || `Zak√°zka ${r.job_id}`;
                jobHours[title] = (jobHours[title]||0) + (r.hours||0);
              });
              const jobChartData = Object.entries(jobHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              setChartData({employees:empChartData,jobs:jobChartData});
            }catch(e){console.error(e);}
          })();
        },[]);
        
        const BarChart = ({data,height=200,color="#3ea76a"})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          const max = Math.max(...data.map(d=>d.hours),1);
          const barWidth = 280 / data.length;
          return <svg width="100%" height={height} style={{overflow:"visible"}}>
            {data.map((d,i)=>{
              const barHeight = Math.max(0, (d.hours/max)*150);
              const rectWidth = Math.max(1, barWidth-10);
              return <g key={i}>
                <rect x={i*barWidth+10} y={height-barHeight-20} width={rectWidth} height={barHeight} fill={color} opacity={0.8} rx={4}/>
                <text x={i*barWidth+barWidth/2+5} y={height-5} fontSize="10" fill="#9ca8b3" textAnchor="middle">{d.name.substring(0,8)}</text>
                <text x={i*barWidth+barWidth/2+5} y={height-barHeight-25} fontSize="11" fill="#e8eef2" textAnchor="middle" fontWeight="600">{d.hours.toFixed(1)}h</text>
              </g>;
            })}
          </svg>;
        };
        
        const PieChart = ({data,size=200,colors=["#3ea76a","#4bb878","#2d8f55","#1f6b42","#0d4d2a"]})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          const total = data.reduce((s,d)=>s+d.hours,0);
          if(total===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>≈Ω√°dn√° data</div>;
          let currentAngle = -90;
          const center = size/2;
          const radius = size/2-20;
          return <svg width={size} height={size} style={{margin:"0 auto",display:"block"}}>
            {data.map((d,i)=>{
              const angle = (d.hours/total)*360;
              const startAngle = currentAngle;
              const endAngle = currentAngle + angle;
              currentAngle += angle;
              const x1 = center + radius*Math.cos(startAngle*Math.PI/180);
              const y1 = center + radius*Math.sin(startAngle*Math.PI/180);
              const x2 = center + radius*Math.cos(endAngle*Math.PI/180);
              const y2 = center + radius*Math.sin(endAngle*Math.PI/180);
              const largeArc = angle>180?1:0;
              return <path key={i} d={`M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={colors[i%colors.length]} opacity={0.8} stroke="#0a0e11" strokeWidth="2"/>
            })}
            <text x={center} y={center+5} fontSize="14" fill="#e8eef2" textAnchor="middle" fontWeight="600">{total.toFixed(1)}h</text>
            <text x={center} y={center+20} fontSize="11" fill="#9ca8b3" textAnchor="middle">Celkem</text>
          </svg>;
        };
        
        return (<div style={{paddingBottom:100,padding:"16px"}}>
          <h1 style={{fontSize:24,fontWeight:700,color:"#e8eef2",marginBottom:24}}>Statistiky</h1>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,margin:"0 0 24px 0"}}>
            <div className="card" style={{padding:20}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
                <div style={{fontSize:16,fontWeight:600,color:"#e8eef2"}}>Hodiny per zamƒõstnanec</div>
                <div style={{display:"flex",gap:4}}>
                  <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11,background:chartPeriod==="week"?"rgba(62, 167, 106, 0.15)":"transparent"}} onClick={()=>setChartPeriod("week")}>T√Ωden</button>
                  <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11,background:chartPeriod==="month"?"rgba(62, 167, 106, 0.15)":"transparent"}} onClick={()=>setChartPeriod("month")}>Mƒõs√≠c</button>
                </div>
              </div>
              <BarChart data={chartData.employees} height={200} color="#3ea76a"/>
            </div>
            <div className="card" style={{padding:20}}>
              <div style={{fontSize:16,fontWeight:600,color:"#e8eef2",marginBottom:16}}>Rozdƒõlen√≠ hodin</div>
              <PieChart data={chartData.jobs} size={200}/>
              <div style={{marginTop:12,display:"flex",flexDirection:"column",gap:4}}>
                {chartData.jobs.slice(0,3).map((d,i)=>(
                  <div key={i} style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#9ca8b3"}}>
                    <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"120px"}}>{d.name}</span>
                    <span style={{fontWeight:600,color:"#e8eef2"}}>{d.hours.toFixed(1)}h</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>);
      }

      ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
    </script>
  <script>
// Hide old green shortcut row "Kalend√°≈ô V√Ωkazy hodin" if it exists (we keep only the tabs bar)
document.addEventListener('DOMContentLoaded', function(){
  const anchors = Array.from(document.querySelectorAll('a'));
  const kal = anchors.find(a => a.textContent && a.textContent.trim().match(/^Kalend[a√°]≈ô$/));
  if (kal && kal.parentElement){
    const sib = kal.parentElement.querySelector('a + a');
    const txt = sib ? sib.textContent.trim() : "";
    if (/^V[√Ωy]kazy\s*hodin$/i.test(txt)) {
      // Hide the whole container row
      kal.parentElement.style.display = 'none';
    }
  }
});
</script>

<script>
(function(){
  function ensureSearch(container){
    if(!container) return;
    if(container.querySelector('#globalSearch')) return;
    var form = document.createElement('form');
    form.id = 'globalSearch';
    form.className = 'tabs-search';
    form.action = '/search';
    form.method = 'GET';
    form.innerHTML = '<input type="search" name="q" placeholder="Hledat‚Ä¶" aria-label="Hledat"/>' +
                     '<button type="submit" class="btn small">Hledat</button>';
    container.appendChild(form);
  }
  function findTabs(){
    document.querySelectorAll('.tabs').forEach(ensureSearch);
  }
  document.addEventListener('DOMContentLoaded', function(){
    findTabs();
    var obs = new MutationObserver(findTabs);
    obs.observe(document.body, {subtree:true, childList:true});
  });
})();
</script>


<script>
// SPA deep link helper: ?tab=jobs&jobId=123 or ?tab=employees
(function(){
  function qs(name){ return new URLSearchParams(window.location.search).get(name); }
  const tab = qs('tab');
  if (tab) {
    // Try to switch initial tab by simulating click on the tab header if present
    document.addEventListener('DOMContentLoaded', () => {
      const map = {
        'jobs': 'Zak√°zky', 'employees': 'Zamƒõstnanci',
        'calendar': 'Kalend√°≈ô','timesheets':'V√Ωkazy hodin','tasks':'√ökoly','warehouse':'Sklad','users':'U≈æivatel√©'
      };
      const label = map[tab] || null;
      if (label) {
        // try click tab with given label
        const clickTab = () => {
          const tabs = Array.from(document.querySelectorAll('.tab'));
          const t = tabs.find(el => el.textContent.trim() === label);
          if (t) t.click();
        };
        clickTab();
        // also observe in case it renders later
        const obs = new MutationObserver(clickTab);
        obs.observe(document.body, {subtree:true, childList:true});
        setTimeout(()=>obs.disconnect(), 5000);
      }
    });
  }
  const jobId = qs('jobId');
  if (jobId) {
    // After jobs list is rendered, try to open the detail of that job
    const tryOpen = () => {
      // Find card/item that contains the ID number (ID column or data-id attr)
      const selectorCandidates = [
        `[data-job-id="${jobId}"] .btn, [data-id="${jobId}"] .btn`,
        `.job-row[data-id="${jobId}"] .btn`,
        `.job-item[data-id="${jobId}"] .btn`,
        `tr:has(td:first-child:contains("${jobId}")) .btn`,
        `a[href*="detail"][data-id="${jobId}"]`, `button:contains("Otev≈ô√≠t detail")`
      ];
      // Basic contains polyfill for querySelectorAll
      (function(){
        function containsSelectorPolyfill(){
          // no native :contains in querySelector; we implement manual scan
          const rows = Array.from(document.querySelectorAll('tr, .job-item, .job-row, [data-job-id], [data-id]'));
          for (const el of rows) {
            if (el.dataset && (el.dataset.jobId === jobId || el.dataset.id === jobId)) {
              const btn = el.querySelector('a,button');
              if (btn) { btn.click(); return true; }
            }
            if (el.querySelector) {
              const tds = el.querySelectorAll('td,div,span');
              for (const td of tds) {
                if (td.textContent && td.textContent.trim() === jobId) {
                  const btn = el.querySelector('a,button');
                  if (btn) { btn.click(); return true; }
                }
              }
            }
          }
          // fallback: click first "Otev≈ô√≠t detail" on page
          const any = Array.from(document.querySelectorAll('a,button')).find(b => /Otev≈ô√≠t detail/i.test(b.textContent));
          if (any) { any.click(); return true; }
          return false;
        }
        window.__openJobDetailById = containsSelectorPolyfill;
      })();

      if (window.__openJobDetailById && window.__openJobDetailById()) return;
    };
    document.addEventListener('DOMContentLoaded', ()=>{
      tryOpen();
      const obs = new MutationObserver(()=>tryOpen());
      obs.observe(document.body, {subtree:true, childList:true});
      setTimeout(()=>obs.disconnect(), 5000);
    });
  }
})();
</script>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="/" class="nav-item active" onclick="if(window.setAppTab) {event.preventDefault(); window.setAppTab('dashboard');}">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    <div class="nav-label">Dom≈Ø</div>
  </a>
  <a href="/?tab=jobs" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('jobs'); } else { window.location.href='/?tab=jobs'; }" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
    <div class="nav-label">Zak√°zky</div>
  </a>
  <a href="/timesheets.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
    <div class="nav-label">V√Ωkazy</div>
  </a>
  <a href="/calendar.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="nav-label">Kalend√°≈ô</div>
  </a>
  <a href="#" id="more-menu-btn" class="nav-item" onclick="event.preventDefault(); document.getElementById('more-menu').classList.toggle('show');">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
    <div class="nav-label">V√≠ce</div>
  </a>
  <a href="/settings.html" class="nav-item">
    <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/></svg></div>
    <div class="nav-label">Nastaven√≠</div>
  </a>
</nav>

<!-- More Menu (Expandable) -->
<div id="more-menu" class="more-menu">
  <div class="more-menu-backdrop" onclick="document.getElementById('more-menu').classList.remove('show');"></div>
  <div class="more-menu-panel">
    <div class="more-menu-header">
      <div style="font-size:18px;font-weight:600;color:#e8eef2;">Navigace</div>
      <button onclick="document.getElementById('more-menu').classList.remove('show');" style="background:none;border:none;color:#9ca8b3;cursor:pointer;font-size:24px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">√ó</button>
    </div>
    <div class="more-menu-content">
      <a href="/" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('dashboard'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>p≈ôehled</span>
      </a>
      <a href="/calendar.html" class="more-menu-item">
        <span>kalend√°≈ô</span>
      </a>
      <a href="/timesheets.html" class="more-menu-item">
        <span>v√Ωkazy hodin</span>
      </a>
      <a href="/jobs.html" class="more-menu-item">
        <span>zak√°zky</span>
      </a>
      <a href="/tasks.html" class="more-menu-item">
        <span>√∫koly</span>
      </a>
      <a href="/employees.html" class="more-menu-item">
        <span>zamƒõstnanci</span>
      </a>
      <a href="/warehouse.html" class="more-menu-item">
        <span>sklad</span>
      </a>
      <a href="/finance.html" class="more-menu-item">
        <span>üí∞ finance</span>
      </a>
      <a href="/documents.html" class="more-menu-item">
        <span>üìÅ dokumenty</span>
      </a>
      <a href="/reports.html" class="more-menu-item">
        <span>üìä reporty</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('archive'); } else { window.location.href='/?tab=archive'; } document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>archiv zak√°zek</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('users'); } else { window.location.href='/?tab=users'; } document.getElementById('more-menu').classList.remove('show');" class="more-menu-item" id="users-menu-item" style="display:none;">
        <span>u≈æivatel√©</span>
      </a>
      <a href="/settings.html" class="more-menu-item">
        <span>‚öôÔ∏è nastaven√≠</span>
      </a>
    </div>
  </div>
</div>

<script>
  // Search is now in Dashboard component (KPI stats), handled by React useEffect
    
    // Show/hide users menu item based on admin status
    function updateUsersMenu(){
      const usersItem = document.getElementById('users-menu-item');
      if(usersItem && window.appCanAdmin){
        usersItem.style.display = '';
      } else if(usersItem){
        usersItem.style.display = 'none';
      }
    }
    setInterval(updateUsersMenu, 500);
    
    // Update bottom nav active state
    function updateBottomNav(){
      const navItems = document.querySelectorAll('.bottom-nav .nav-item');
      navItems.forEach(item => {
        item.classList.remove('active');
        const href = item.getAttribute('href');
        if(href === '/' && window.location.pathname === '/') {
          item.classList.add('active');
        } else if(href && window.location.pathname.includes(href.replace('/',''))) {
          item.classList.add('active');
        }
      });
    }
    updateBottomNav();
    setInterval(updateBottomNav, 1000);
</script>

</body>
</html>
