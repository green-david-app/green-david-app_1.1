<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>green david app</title>
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="/static/css/app.css"/>
    <link rel="stylesheet" href="/static/icons.css"/>
    <script src="/app-settings.js"></script>
    <script src="/static/app-header.js"></script>
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="app-header-container">
        <a href="/" class="app-header-brand">
          <img src="/logo.jpg" alt="green david app" class="app-header-logo" onerror="this.src='/logo.svg'"/>
          <div class="app-header-text">
            <div class="app-header-title">green david app</div>
            <div class="app-header-subtitle">interní systém</div>
          </div>
        </a>
        <div class="app-header-actions">
          <div id="userbox" class="app-header-user"></div>
          <a href="/settings.html" class="app-header-settings" title="Nastavení">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="app"></div>
      <div id="js-error" class="error-overlay" style="display:none"></div>
      <p class="small footer">© green david s.r.o.</p>
    </main>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>

      function toISODateFlex(v){
        if(!v) return v;
        const d = String(v).replace(/\D+/g, '');
        if(d.length !== 8) return v;
        const yFirst = parseInt(d.slice(0,4),10);
        let y,m,day;
        if(yFirst >= 1900 && yFirst <= 2100){
          y = yFirst; m = parseInt(d.slice(4,6),10); day = parseInt(d.slice(6,8),10);
        } else {
          day = parseInt(d.slice(0,2),10); m = parseInt(d.slice(2,4),10); y = parseInt(d.slice(4,8),10);
        }
        if(!(y && m && day)) return v;
        const pad = (n)=> String(n).padStart(2,'0');
        return `${y}-${pad(m)}-${pad(day)}`;
      }
      function toCZ(iso){
        if(!iso) return iso||'';
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return iso;
        const [_,y,mm,dd] = m;
        return `${dd}.${mm}.${y}`;
      }

      function normalizeDate(v){
        if(!v) return v;
        var m=v.match(/^(\d{1,2})[\.\s-](\d{1,2})[\.\s-](\d{4})$/);
        if(m){
          var d=m[1].padStart(2,'0'); var M=m[2].padStart(2,'0'); var y=m[3];
          return y+"-"+M+"-"+d;
        }
        return v;
      }
      // Notification System (global)
      let notificationContainer = null;
      function showNotification(message,type="info"){
        if(!notificationContainer) {
          notificationContainer = document.createElement('div');
          notificationContainer.id = 'notification-container';
          notificationContainer.style.cssText = 'position:fixed;top:80px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:8px;max-width:400px;';
          document.body.appendChild(notificationContainer);
        }
        const notif = document.createElement('div');
        const colors = {success:'#9FD4A1',error:'#ef4444',info:'#3b82f6',warning:'#f59e0b'};
        notif.style.cssText = `padding:12px 16px;background:${colors[type]||colors.info}20;border:1px solid ${colors[type]||colors.info}40;border-radius:12px;color:#e8eef2;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;`;
        notif.textContent = message;
        notificationContainer.appendChild(notif);
        setTimeout(()=>{
          notif.style.animation = 'slideOut 0.3s ease';
          setTimeout(()=>notif.remove(),300);
        },4000);
      }
      
      function showJSError(msg){
        var el = document.getElementById('js-error');
        el.style.display = 'block';
        el.textContent = String(msg || 'Neznámá chyba ve skriptu.');
        console.error(msg);
      }
      window.addEventListener('error', function(e){ showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)); });
      window.addEventListener('unhandledrejection', function(e){ showJSError(e.reason ? (e.reason.stack||e.reason) : e); });
      async function api(path, opts={}){
        const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
        if(!res.ok){ let msg = res.statusText; try{ const j = await res.json(); msg = j.error || msg; }catch{} throw new Error(msg); }
        try{ return await res.json(); }catch{return {};}
      }
      async function refreshUserBox(){
        const box = document.getElementById("userbox");
        try{
          const j = await api("/api/me");
          if(j.authenticated){
            box.innerHTML = `<span>Úkoly: <strong style="color:#e8eef2;">${j.tasks_count}</strong></span> &nbsp; <button class="btn btn-ghost btn-sm" id="logout-btn" style="padding:6px 12px;font-size:13px;">Odhlásit</button>`;
            document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
          } else {
            box.innerHTML = '<span>Nepřihlášen</span>';
          }
        }catch(e){ box.innerText = ""; }
      }
    </script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      function Login({onLogged}){
        const [email,setEmail]=useState(""); const [pass,setPass]=useState(""); const [err,setErr]=useState("");
        async function submit(e){ e.preventDefault(); setErr(""); try{ await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})}); onLogged(); }catch(e){ setErr("Špatný e‑mail nebo heslo"); } }
        return (<div className="card" style={{maxWidth:460, margin:"40px auto"}}><div className="card-h"><div>Přihlášení</div></div><div className="card-c">
          <form onSubmit={submit}><div className="form-row"><input type="email" placeholder="E‑mail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/></div>
          <div className="form-row"><input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/></div>
          {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}<div className="form-row" style={{justifyContent:"flex-end"}}><button type="submit">Přihlásit</button></div>
          <div className="small">Výchozí admin: <b>admin@greendavid.local</b> / <b>admin123</b>.</div></form></div></div>);
      }

      function Tabs({value,onChange,canAdmin,taskCount}){
        const items = [
          {key:"dashboard",label:"přehled"},
          {key:"calendar",label:"kalendář",href:"/calendar.html"},
          {key:"timesheets",label:"výkazy hodin",href:"/timesheets.html"},
          {key:"jobs",label:"zakázky"},
          {key:"tasks",label:"úkoly"},
          {key:"employees",label:"zaměstnanci"},
          {key:"warehouse",label:"sklad"},
          {key:"archive",label:"archiv zakázek"},
          ...(canAdmin ? [{key:"users",label:"uživatelé"}] : [])
        ];
        return <div className="tabs">
          {items.map(it => (
            it.href
              ? <a key={it.key} className={"tab"+(value===it.key?" active":"")} href={it.href}>{it.label}</a>
              : <div key={it.key} className={"tab"+(value===it.key?" active":"")} onClick={()=>onChange(it.key)}>{it.label}</div>
          ))}
        </div>;
      }

      function JobsList({onOpen}){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({title:"",client:"",status:"Plán",city:"",code:"",date:"",note:""});
        const [err,setErr]=useState("");
        // Default to list view on mobile, kanban on desktop
        const [viewMode,setViewMode]=useState(()=>{
          if(typeof window !== 'undefined' && window.innerWidth < 768) return "list";
          return "kanban";
        }); // "kanban" or "list"
        const [draggedJob,setDraggedJob]=useState(null);

        // NEW: edit mode state
        const [editId, setEditId] = useState(null);
        const [edit, setEdit] = useState({title:"",client:"",status:"Plán",city:"",code:"",date:"",note:""});

        async function load(){ try{ const j=await api("/api/jobs"); setList(j.jobs||[]); }catch(e){ setErr(e.message); showNotification("Chyba při načítání zakázek: "+e.message,"error");} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        
        // Drag & Drop handlers
        function handleDragStart(e,job){
          setDraggedJob(job);
          e.dataTransfer.effectAllowed = "move";
        }
        function handleDragOver(e){
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }
        async function handleDrop(e,newStatus){
          e.preventDefault();
          if(!draggedJob || draggedJob.status===newStatus) return;
          try{
            await api("/api/jobs",{method:"PATCH",body:JSON.stringify({id:draggedJob.id,status:newStatus})});
            showNotification(`Zakázka "${draggedJob.title}" přesunuta do ${newStatus}`,"success");
            load();
          }catch(e){
            showNotification("Chyba při přesunu zakázky: "+e.message,"error");
          }
          setDraggedJob(null);
        }
        
        const columns = [
          {id:"Plán",label:"Plán",color:"#3b82f6"},
          {id:"Probíhá",label:"Probíhá",color:"#9FD4A1"},
          {id:"Dokončeno",label:"Dokončeno",color:"#6b7580"}
        ];

        async function add(e){ e.preventDefault(); try{ const payload={...form, date: toISODateFlex(form.date)}; await api("/api/jobs",{method:"POST",body:JSON.stringify(payload)}); setForm({title:"",client:"",status:"Plán",city:"",code:"",date:"",note:""}); showNotification("Zakázka přidána","success"); load(); }catch(e){ setErr(e.message || String(e)); showNotification("Chyba při přidávání zakázky: "+e.message,"error"); } }
        async function del(id){ if(!confirm("Smazat zakázku?")) return; try{ await api("/api/jobs?id="+id,{method:"DELETE"}); showNotification("Zakázka smazána","success"); load(); }catch(e){ showNotification("Chyba při mazání: "+e.message,"error"); } }

        // NEW: start/cancel/save edit
        function startEdit(z){
          setEditId(z.id);
          setEdit({
            title: z.title || "",
            client: z.client || "",
            status: z.status || "Plán",
            city: z.city || "",
            code: z.code || "",
            date: toCZ(z.date || ""),
            note: z.note || ""
          });
        }
        function cancelEdit(){ setEditId(null); }
        async function saveEdit(e){
          e.preventDefault();
          try{
            const payload = { id: editId, ...edit, date: toISODateFlex(edit.date) };
            await api("/api/jobs", { method:"PATCH", body: JSON.stringify(payload) });
            setEditId(null);
            showNotification("Zakázka upravena","success");
            load();
          }catch(e){ setErr(e.message || String(e)); showNotification("Chyba při ukládání: "+e.message,"error"); }
        }

        return (<div style={{paddingBottom:100}}>
          {/* View Mode Toggle */}
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <h2 style={{fontSize:22,fontWeight:700,color:"#e8eef2"}}>Zakázky</h2>
            <div style={{display:"flex",gap:8}}>
              <button className="btn btn-ghost" style={{padding:"6px 12px",fontSize:12,background:viewMode==="kanban"?"rgba(178, 251, 165, 0.15)":"transparent"}} onClick={()=>setViewMode("kanban")}>Kanban</button>
              <button className="btn btn-ghost" style={{padding:"6px 12px",fontSize:12,background:viewMode==="list"?"rgba(178, 251, 165, 0.15)":"transparent"}} onClick={()=>setViewMode("list")}>Seznam</button>
            </div>
          </div>
          
          {/* Kanban Board View */}
          {viewMode==="kanban" ? (
            <div style={{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:16,marginBottom:24}} className="kanban-board">
              {columns.map(col=>{
                const colJobs = list.filter(j=>j.status===col.id);
                return <div key={col.id} className="card" style={{minHeight:400}} onDragOver={handleDragOver} onDrop={(e)=>handleDrop(e,col.id)}>
                  <div className="card-h" style={{background:col.color+"20",borderBottom:`2px solid ${col.color}`}}>
                    <div style={{fontWeight:600,color:"#e8eef2"}}>{col.label}</div>
                    <span className="badge" style={{background:col.color+"30",color:col.color}}>{colJobs.length}</span>
                  </div>
                  <div className="card-c" style={{display:"flex",flexDirection:"column",gap:12}}>
                    {colJobs.map(job=>(
                      <div key={job.id} className="card" draggable onDragStart={(e)=>handleDragStart(e,job)} style={{cursor:"move",opacity:draggedJob?.id===job.id?0.5:1}}>
                        <div style={{fontWeight:600,color:"#e8eef2",marginBottom:4,overflow:"hidden",textOverflow:"ellipsis"}}>{job.title}</div>
                        <div className="small" style={{color:"#9ca8b3",marginBottom:8}}>{job.client} • {job.city}</div>
                        <div className="small" style={{color:"#6b7580",marginBottom:8}}>{toCZ(job.date)} • {job.code}</div>
                        <div style={{display:"flex",gap:4}}>
                          <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11}} onClick={()=>onOpen(job.id)}>Detail</button>
                          <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11}} onClick={()=>del(job.id)}>Smazat</button>
                        </div>
                      </div>
                    ))}
                    {colJobs.length===0 && <div style={{textAlign:"center",color:"#6b7580",padding:20,fontSize:13}}>Žádné zakázky</div>}
                  </div>
                </div>;
              })}
            </div>
          ) : (
            /* List View */
            <div className="grid" style={{gridTemplateColumns:"1fr"}}>
              <div className="card"><div className="card-h"><div>Nová zakázka</div></div><div className="card-c">
            <form onSubmit={add}><div className="form-row">
              <input placeholder="Název" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} style={{flex:2}} required/>
              <input placeholder="Zákazník" value={form.client} onChange={e=>setForm({...form,client:e.target.value})} style={{flex:2}} required/>
              <select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}><option>Plán</option><option>Probíhá</option><option>Dokončeno</option></select>
            </div><div className="form-row">
              <input placeholder="Město" value={form.city} onChange={e=>setForm({...form,city:e.target.value})} required/>
              <input placeholder="Kód (např. 2025-091)" value={form.code} onChange={e=>setForm({...form,code:e.target.value})} required/>
              <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
            </div><div className="form-row">
              <input placeholder="Poznámka" value={form.note} onChange={e=>setForm({...form,note:e.target.value})} style={{flex:1}}/>
              <button type="submit">Přidat</button>
            </div></form>{err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}</div></div>

          {list.map(z=> (
            <div className="card" key={z.id}>
              <div className="card-h">
                <div>
                  <div style={{fontWeight:700}}><span className="linklike" onClick={()=> onOpen(z.id)}>{z.title}</span></div>
                  <div className="small">{z.client} • {z.city} • {z.code}</div>
                </div>
                <span className="badge">{z.status}</span>
              </div>

              <div className="card-c">
                <div className="kv small">
                  <svg style={{width:"16px",height:"16px",display:"inline-block",verticalAlign:"middle",marginRight:"4px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  <span>{toCZ(z.date)}</span>
                </div>

                {/* EDIT MODE UI */}
                {editId === z.id ? (
                  <form onSubmit={saveEdit} className="small" style={{marginTop:12}}>
                    <div className="form-row">
                      <input placeholder="Název" value={edit.title} onChange={e=>setEdit({...edit,title:e.target.value})} style={{flex:2}} required/>
                      <input placeholder="Zákazník" value={edit.client} onChange={e=>setEdit({...edit,client:e.target.value})} style={{flex:2}} required/>
                      <select value={edit.status} onChange={e=>setEdit({...edit,status:e.target.value})}>
                        <option>Plán</option><option>Probíhá</option><option>Dokončeno</option>
                      </select>
                    </div>
                    <div className="form-row">
                      <input placeholder="Město" value={edit.city} onChange={e=>setEdit({...edit,city:e.target.value})} required/>
                      <input placeholder="Kód (např. 2025-091)" value={edit.code} onChange={e=>setEdit({...edit,code:e.target.value})} required/>
                      <input type="text" placeholder="DD.MM.RRRR" value={edit.date} onChange={e=>setEdit({...edit,date:e.target.value})} required/>
                    </div>
                    <div className="form-row">
                      <input placeholder="Poznámka" value={edit.note} onChange={e=>setEdit({...edit,note:e.target.value})} style={{flex:1}}/>
                      <div>
                        <button type="submit">Uložit</button>
                        <button type="button" className="ghost" onClick={cancelEdit} style={{marginLeft:6}}>Zrušit</button>
                      </div>
                    </div>
                  </form>
                ) : null}

                <div style={{marginTop:12, display:"flex", gap:8}}>
                  <button onClick={()=> onOpen(z.id)}>Otevřít detail</button>
                  {/* NEW EDIT BUTTON next to Delete */}
                  {editId === z.id ? (
                    <button className="ghost" onClick={cancelEdit}>Zrušit úpravy</button>
                  ) : (
                    <button className="ghost" onClick={()=> startEdit(z)}>Upravit</button>
                  )}
                  <button className="ghost" onClick={()=> del(z.id)}>Smazat</button>
                </div>
              </div>
            </div>
          ))}

              {list.length===0 && <div className="card"><div className="card-c small">Zatím žádné zakázky – přidej první výše.</div></div>}
            </div>
          )}
        </div>);
      }

      function PhotoUploader({jobId,onUploaded}){
        function compressAndSend(file){
          var reader = new FileReader();
          reader.onload = function(){
            var img = new Image();
            img.onload = async function(){
              var maxSide = 1600, quality = 0.82;
              var scale = (img.width>img.height) ? maxSide/img.width : maxSide/img.height;
              var w = Math.min(maxSide, Math.round(img.width*scale));
              var h = Math.min(maxSide, Math.round(img.height*scale));
              var c = document.createElement("canvas"); c.width=w; c.height=h;
              var ctx = c.getContext("2d"); ctx.drawImage(img,0,0,w,h);
              var dataUrl = c.toDataURL("image/jpeg", quality);
              await api(`/api/jobs/${jobId}/photos`, {method:"POST", body: JSON.stringify({data_url:dataUrl})});
              onUploaded && onUploaded();
            };
            img.src = reader.result;
          };
          reader.readAsDataURL(file);
        }
        return (<label><input type="file" accept="image/*" onChange={e=>{ var f=e.target.files && e.target.files[0]; if(f) compressAndSend(f); }}/><button className="ghost">Nahrát fotku</button></label>);
      }

      function JobTasks({jobId}){
        const [list,setList]=useState([]);
        const [employees,setEmployees]=useState([]);
        const [form,setForm]=useState({title:"",description:"",due_date:"",employee_id:""});
        async function load(){ try{ const [t,e]=await Promise.all([api("/api/tasks?job_id="+jobId), api("/api/employees")]); setList(t.tasks||[]); setEmployees(e.employees||[]); }catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[jobId]);
        async function add(e){ e.preventDefault(); await api("/api/tasks",{method:"POST",body:JSON.stringify({...form, due_date: toISODateFlex(form.due_date), job_id: jobId || null})}); setForm({title:"",description:"",due_date:"",employee_id:""}); load(); }
        async function setStatus(t, status){ await api("/api/tasks",{method:"PATCH",body:JSON.stringify({id:t.id,status})}); load(); }
        async function del(t){ if(!confirm("Smazat úkol?")) return; await api("/api/tasks?id="+t.id,{method:"DELETE"}); load(); }
        return (<div className="card"><div className="card-h"><div>Úkoly zakázky</div></div><div className="card-c">
          <form onSubmit={add}><div className="form-row">
            <input placeholder="Nadpis úkolu" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} required style={{flex:2}}/>
            <input placeholder="Do kdy (YYYY-MM-DD)" value={form.due_date} onChange={e=>setForm({...form,due_date:e.target.value})}/>
            <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})}><option value="">Nepřiřazovat</option>{employees.map(emp=>(<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select>
            <button type="submit">Přidat</button>
          </div><div className="form-row"><input placeholder="Popis" value={form.description} onChange={e=>setForm({...form,description:e.target.value})} style={{flex:1}}/></div></form>
          <table className="table"><thead><tr><th>Stav</th><th>Název</th><th>Přiřazeno</th><th>Termín</th><th></th></tr></thead><tbody>
            {list.map(t=>(<tr key={t.id}><td><span className="badge">{t.status}</span></td><td>{t.title}</td><td>{t.employee_id || "-"}</td><td>{t.due_date || "-"}</td><td className="small">
              <button className="ghost" onClick={()=>setStatus(t,"nový")}>nový</button><button className="ghost" onClick={()=>setStatus(t,"probíhá")}>probíhá</button><button className="ghost" onClick={()=>setStatus(t,"hotovo")}>hotovo</button><button className="ghost" onClick={()=>del(t)}>smazat</button></td></tr>))}
          </tbody></table>{list.length===0 && <div className="small">Žádné úkoly.</div>}</div></div>);
      }

      function JobHours({jobId}){
        const [rows,setRows]=useState([]);
        const [employees,setEmployees]=useState([]);
        const [form,setForm]=useState({employee_id:"",date:"",hours:0,place:"",activity:""});
        async function load(){ try{ const [h,e]=await Promise.all([api("/api/timesheets?job_id="+jobId), api("/api/employees")]); setRows(h.rows||[]); setEmployees(e.employees||[]);}catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[jobId]);
        async function add(e){ e.preventDefault(); await api("/api/timesheets",{method:"POST",body:JSON.stringify({job_id:jobId, ...form})}); setForm({employee_id:"",date:"",hours:0,place:"",activity:""}); load(); }
        async function del(id){ if(!confirm("Smazat záznam?")) return; await api("/api/timesheets?id="+id,{method:"DELETE"}); load(); }
        return (<div className="card"><div className="card-h"><div>Hodiny na zakázce</div></div><div className="card-c">
          <form onSubmit={add}><div className="form-row">
            <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})} required><option value="">Zaměstnanec…</option>{employees.map(emp=>(<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select>
            <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
            <input type="number" step="0.25" value={form.hours} onChange={e=>setForm({...form,hours:e.target.value})} required/>
          </div>
          <div className="form-row">
            <input placeholder="Místo" value={form.place} onChange={e=>setForm({...form,place:e.target.value})} style={{flex:1}}/>
            <input placeholder="Popis činnosti" value={form.activity} onChange={e=>setForm({...form,activity:e.target.value})} style={{flex:2}}/>
            <button type="submit">Přidat</button>
          </div></form>
          <table className="table"><thead><tr><th>Datum</th><th>Hodiny</th><th>Zaměstnanec</th><th>Místo</th><th>Popis činnosti</th><th></th></tr></thead><tbody>
            {rows.map(r=>(<tr key={r.id}><td>{toCZ(r.date)}</td><td>{r.hours}</td><td>{r.employee_name || r.employee_id}</td><td>{r.place||"-"}</td><td>{r.activity||"-"}</td>
              <td><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></td></tr>))}
          </tbody></table>{rows.length===0 && <div className="small">Zatím žádné hodiny.</div>}
        </div></div>);
      }

      function JobDetail({jobId,onBack}){
        const [data,setData]=useState(null); const [employees,setEmployees]=useState([]); const [selEmp,setSelEmp]=useState([]);
        const [mat,setMat]=useState({name:"",qty:0,unit:"ks"}); const [tool,setTool]=useState({name:"",qty:0,unit:"ks"});
        const [err,setErr]=useState("");
        async function load(){ try{ const [d, e] = await Promise.all([api(`/api/jobs/${jobId}`), api("/api/employees")]); setData(d); setEmployees(e.employees||[]); setSelEmp(d.assignments||[]);}catch(e){ setErr(e.message);} }
        useEffect(()=>{ load().catch(()=>{}); },[jobId]);
        async function addMat(e){ e.preventDefault(); await api(`/api/jobs/${jobId}/materials`,{method:"POST",body:JSON.stringify(mat)}); setMat({name:"",qty:0,unit:"ks"}); load(); }
        async function addTool(e){ e.preventDefault(); await api(`/api/jobs/${jobId}/tools`,{method:"POST",body:JSON.stringify(tool)}); setTool({name:"",qty:0,unit:"ks"}); load(); }
        async function delMat(id){ await api(`/api/jobs/${jobId}/materials?id=${id}`,{method:"DELETE"}); load(); }
        async function delTool(id){ await api(`/api/jobs/${jobId}/tools?id=${id}`,{method:"DELETE"}); load(); }
        async function setAssign(){ await api(`/api/jobs/${jobId}/assignments`,{method:"POST",body:JSON.stringify({employee_ids:selEmp})}); load(); }
        if(!data) return <div className="small">Načítám…</div>;
        const j = data.job;
        return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
          <button className="ghost" onClick={onBack}>← Zpět na seznam</button>
          <div className="card"><div className="card-h"><div><div style={{fontWeight:800,fontSize:18}}>{j.title}</div><div className="small">{j.client} • {j.city} • {j.code}</div></div><span className="badge">{j.status}</span></div>
            <div className="card-c"><div className="kv small" style={{display:"flex",alignItems:"center",gap:"6px"}}>
              <svg style={{width:"14px",height:"14px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <span>{toCZ(j.date)}</span>
            </div>{j.note && <div className="small" style={{marginTop:8}}>{j.note}</div>}</div></div>
          <div className="card"><div className="card-h"><div>Přiřazení zaměstnanci</div><button onClick={setAssign}>Uložit přiřazení</button></div>
            <div className="card-c small"><div className="row h"><div style={{gridColumn:"span 6"}}>Jméno</div><div style={{gridColumn:"span 6"}}>Přiřazen</div></div>
              {employees.map(e=> (<div className="row" key={e.id}><div style={{gridColumn:"span 6"}}>{e.name}</div><div style={{gridColumn:"span 6"}}><input type="checkbox" checked={selEmp.includes(e.id)} onChange={(ev)=>{ const checked=ev.target.checked; setSelEmp(s=> checked? [...new Set([...s, e.id])] : s.filter(x=>x!==e.id)); }}/></div></div>))}
            </div></div>
          <JobTasks jobId={jobId}/>
          <JobHours jobId={jobId}/>
          <div className="card"><div className="card-h"><div>Materiál</div><a className="ghost" href={`/export/job_materials.xlsx?job_id=${jobId}`}>Export XLSX</a></div>
            <div className="card-c"><form onSubmit={addMat}><div className="form-row">
              <input placeholder="Název" value={mat.name} onChange={e=>setMat({...mat,name:e.target.value})} required style={{flex:2}}/>
              <input type="number" step="0.01" placeholder="Množství" value={mat.qty} onChange={e=>setMat({...mat,qty:e.target.value})} required style={{width:120}}/>
              <input placeholder="Jedn." value={mat.unit} onChange={e=>setMat({...mat,unit:e.target.value})} required style={{width:80}}/>
              <button type="submit">Přidat</button></div></form>
              <div className="row h"><div style={{gridColumn:"span 7"}}>Název</div><div style={{gridColumn:"span 2",textAlign:"right"}}>Množství</div><div style={{gridColumn:"span 1"}}>Jedn.</div><div style={{gridColumn:"span 2",textAlign:"right"}}></div></div>
              {(data.materials||[]).map(r=> (<div className="row small" key={r.id}><div style={{gridColumn:"span 7"}}>{r.name}</div><div style={{gridColumn:"span 2",textAlign:"right"}}>{r.qty}</div><div style={{gridColumn:"span 1"}}>{r.unit}</div><div style={{gridColumn:"span 2",textAlign:"right"}}><button className="ghost" onClick={()=>delMat(r.id)}>Smazat</button></div></div>))}
              {data.materials?.length===0 && <div className="small">Zatím žádný materiál.</div>}</div></div>
          <div className="card"><div className="card-h"><div>Nářadí</div></div>
            <div className="card-c"><form onSubmit={addTool}><div className="form-row">
              <input placeholder="Název" value={tool.name} onChange={e=>setTool({...tool,name:e.target.value})} required style={{flex:2}}/>
              <input type="number" step="0.01" placeholder="Množství" value={tool.qty} onChange={e=>setTool({...tool,qty:e.target.value})} required style={{width:120}}/>
              <input placeholder="Jedn." value={tool.unit} onChange={e=>setTool({...tool,unit:e.target.value})} required style={{width:80}}/>
              <button type="submit">Přidat</button></div></form>
              <div className="row h"><div style={{gridColumn:"span 7"}}>Název</div><div style={{gridColumn:"span 2",textAlign:"right"}}>Množství</div><div style={{gridColumn:"span 1"}}>Jedn.</div><div style={{gridColumn:"span 2",textAlign:"right"}}></div></div>
              {(data.tools||[]).map(r=> (<div className="row small" key={r.id}><div style={{gridColumn:"span 7"}}>{r.name}</div><div style={{gridColumn:"span 2",textAlign:"right"}}>{r.qty}</div><div style={{gridColumn:"span 1"}}>{r.unit}</div><div style={{gridColumn:"span 2",textAlign:"right"}}><button className="ghost" onClick={()=>delTool(r.id)}>Smazat</button></div></div>))}
              {data.tools?.length===0 && <div className="small">Zatím žádné nářadí.</div>}</div></div>
          <div className="card"><div className="card-h"><div>Fotky</div></div>
            <div className="card-c"><PhotoUploader jobId={jobId} onUploaded={load}/>
              <div className="grid" style={{gridTemplateColumns:"repeat(5,1fr)"}}>
                {(data.photos||[]).map(p=> (<div key={p.id}><img className="img-preview" src={`/uploads/${p.filename}`} alt="foto"/></div>))}
              </div>
              {data.photos?.length===0 && <div className="small">Zatím žádné fotky.</div>}
            </div></div>
        </div>);
      }

      function EmployeeDetail({employee,onBack}){
        const [rows,setRows]=useState([]);
        const [jobs,setJobs]=useState([]);
        const [form,setForm]=useState({job_id:"",date:"",hours:0,place:"",activity:""});
        async function load(){ try{ const [t,j] = await Promise.all([api("/api/timesheets?employee_id="+employee.id), api("/api/jobs")]); setRows(t.rows||[]); setJobs(j.jobs||[]); }catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[employee.id]);
        async function add(e){ e.preventDefault(); await api("/api/timesheets",{method:"POST",body:JSON.stringify({employee_id:employee.id, ...form})}); setForm({job_id:"",date:"",hours:0,place:"",activity:""}); load(); }
        async function del(id){ if(!confirm("Smazat záznam?")) return; await api("/api/timesheets?id="+id,{method:"DELETE"}); load(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <button className="ghost" onClick={onBack}>← Zpět na seznam</button>
            <div className="card">
              <div className="card-h"><div>{employee.name} — výkazy hodin</div><a className="ghost" href={`/export/employee_hours.xlsx?employee_id=${employee.id}`}>Export XLSX</a></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <select value={form.job_id} onChange={e=>setForm({...form,job_id:e.target.value})} required>
                      <option value="">Vyber zakázku…</option>
                      {jobs.map(j=>(<option key={j.id} value={j.id}>{j.title} ({j.code})</option>))}
                    </select>
                    <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
                    <input type="number" step="0.25" value={form.hours} onChange={e=>setForm({...form,hours:e.target.value})} required/>
                  </div>
                  <div className="form-row">
                    <input placeholder="Místo (např. Praha 6)" value={form.place} onChange={e=>setForm({...form,place:e.target.value})} style={{flex:1}}/>
                    <input placeholder="Popis činnosti" value={form.activity} onChange={e=>setForm({...form,activity:e.target.value})} style={{flex:2}}/>
                    <button type="submit">Přidat</button>
                  </div>
                </form>
                <table className="table">
                  <thead><tr><th>Datum</th><th>Hodiny</th><th>Zakázka</th><th>Místo</th><th>Popis činnosti</th><th></th></tr></thead>
                  <tbody>
                    {rows.map(r=>(
                      <tr key={r.id}>
                        <td>{toCZ(r.date)}</td><td>{r.hours}</td><td>{r.job_title}</td><td>{r.place||"-"}</td><td>{r.activity||"-"}</td>
                        <td><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {rows.length===0 && <div className="small">Zatím žádné záznamy.</div>}
              </div>
            </div>
          </div>
        );
      }

      const CATS = ['trvalky','trávy','dřeviny','stromy','cibuloviny','hnojiva/postřiky','materiál zahrada','materiál stavba'];
      function Warehouse(){
        const [site,setSite]=useState("lipnik"); const [list,setList]=useState([]); const [form,setForm]=useState({category:CATS[0],name:"",qty:0,unit:"ks"}); const [q,setQ]=useState("");
        async function load(){ try{ const j=await api("/api/items?site="+site); setList(j.items||[]); }catch(e){ console.error(e);} } useEffect(()=>{ load().catch(()=>{}); },[site]);
        async function add(e){ e.preventDefault(); await api("/api/items",{method:"POST",body:JSON.stringify({...form,site})}); setForm({category:CATS[0],name:"",qty:0,unit:"ks"}); load(); }
        async function del(id){ if(!confirm("Smazat položku?")) return; await api("/api/items?id="+id,{method:"DELETE"}); load(); }
        const filtered = React.useMemo(()=> list.filter(r=> (r.name||"").toLowerCase().includes(q.toLowerCase())), [list,q]);
        return (<div><div style={{display:"flex",gap:8,alignItems:"center",margin:"8px 0 12px"}}>
          <div className="tabs"><div className={"tab"+(site==="lipnik"?" active":"")} onClick={()=>setSite("lipnik")}>Lipník</div><div className={"tab"+(site==="praha"?" active":"")} onClick={()=>setSite("praha")}>Praha</div></div>
          <div className="search" style={{flex:1}}><input value={q} onChange={e=> setQ(e.target.value)} placeholder="Hledat položku…"/><button className="ghost">Hledat</button></div>
          <a className="ghost" href="/export/warehouse.xlsx">Export XLSX</a></div>
          <div className="card"><div className="card-h"><div>Nová položka</div></div><div className="card-c">
            <form onSubmit={add}><div className="form-row">
              <select value={form.category} onChange={e=>setForm({...form,category:e.target.value})}>{CATS.map(c=>(<option key={c}>{c}</option>))}</select>
              <input placeholder="Název" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:2}}/>
              <input type="number" step="0.01" placeholder="Množství" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} required style={{width:120}}/>
              <input placeholder="Jedn." value={form.unit} onChange={e=>setForm({...form,unit:e.target.value})} required style={{width:80}}/>
              <button type="submit">Přidat</button></div></form></div></div>
          <div className="card"><div className="card-h"><div>Inventář – {site==="lipnik"?"Lipník":"Praha"}</div></div><div className="card-c">
            <div className="row h"><div style={{gridColumn:"span 4"}}>Kategorie</div><div style={{gridColumn:"span 6"}}>Název</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Množství</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Jedn.</div></div>
            {filtered.length===0 && <div className="small">Prázdné – přidej položky výše.</div>}
            {filtered.map(r=> (<div className="row small" key={r.id}><div style={{gridColumn:"span 4"}}>{r.category}</div><div style={{gridColumn:"span 6"}}>{r.name}</div><div style={{gridColumn:"span 1",textAlign:"right"}}>{r.qty}</div><div style={{gridColumn:"span 1",textAlign:"right"}}>{r.unit}</div>
              <div style={{gridColumn:"span 12",textAlign:"right"}}><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></div></div>))}
          </div></div></div>);
      }

      function UsersTab(){
        const [list,setList]=useState([]); const [form,setForm]=useState({email:"",name:"",role:"worker",password:""}); const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/users"); setList(j.users||[]); }catch(e){ setErr(e.message);} } useEffect(()=>{load().catch(()=>{}); },[]);
        async function create(e){ e.preventDefault(); await api("/api/users",{method:"POST",body:JSON.stringify(form)}); setForm({email:"",name:"",role:"worker",password:""}); load(); }
        async function setRole(id,role){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id,role})}); load(); }
        async function toggleActive(u){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id:u.id,active:!u.active})}); load(); }
        return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
          <div className="card"><div className="card-h"><div>Nový uživatel</div></div><div className="card-c">
            <form onSubmit={create}><div className="form-row">
              <input placeholder="E‑mail" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required style={{flex:1}}/>
              <input placeholder="Jméno" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/></div>
              <div className="form-row"><select value={form.role} onChange={e=>setForm({...form,role:e.target.value})}><option value="worker">worker</option><option value="manager">manager</option><option value="admin">admin</option></select>
              <input type="password" placeholder="Heslo" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} required/><button type="submit">Vytvořit</button></div></form>
          </div></div>
          <div className="card"><div className="card-h"><div>Uživatelé</div></div><div className="card-c">
            {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
            <table className="table"><thead><tr><th>ID</th><th>E‑mail</th><th>Jméno</th><th>Role</th><th>Aktivní</th><th></th></tr></thead><tbody>
              {list.map(u=>(<tr key={u.id}><td>{u.id}</td><td>{u.email}</td><td>{u.name}</td><td>{u.role}</td><td>{u.active? "ano":"ne"}</td>
                <td className="small"><button className="ghost" onClick={()=>setRole(u.id,"worker")}>worker</button>
                  <button className="ghost" onClick={()=>setRole(u.id,"manager")}>manager</button>
                  <button className="ghost" onClick={()=>setRole(u.id,"admin")}>admin</button>
                  <button className="ghost" onClick={()=>toggleActive(u)}>{u.active?"deaktivovat":"aktivovat"}</button></td></tr>))}
            </tbody></table>
          </div></div>
        </div>);
      }


      function ArchiveTab({onOpen}){
        const [monthsData,setMonthsData] = useState({});
        const [years,setYears] = useState([]);
        const [activeYear,setActiveYear] = useState("");
        const [err,setErr] = useState("");

        useEffect(() => {
          (async () => {
            try{
              const j = await api("/api/jobs/archive");
              const months = j.months || {};
              const byYear = {};
              Object.keys(months).forEach(ym => {
                if(!ym || ym === "unknown") return;
                const parts = String(ym).split("-");
                if(parts.length < 2) return;
                const year = parts[0];
                const monthIdx = parseInt(parts[1],10) - 1;
                if(monthIdx < 0 || monthIdx > 11) return;
                if(!byYear[year]) byYear[year] = Array.from({length:12}, () => []);
                byYear[year][monthIdx] = months[ym] || [];
              });
              const yearsSorted = Object.keys(byYear).sort().reverse();
              setYears(yearsSorted);
              if(yearsSorted.length && !activeYear){
                setActiveYear(yearsSorted[0]);
              }
              setMonthsData(byYear);
            }catch(e){
              console.error(e);
              setErr(e.message || String(e));
            }
          })();
        }, []);

        const monthNames = ["Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"];

        const yearData = (activeYear && monthsData[activeYear]) || [];

        function openJob(id){
          if(onOpen) onOpen(id);
        }

        return (
          <div className="card">
            <div className="card-h">
              <div>Archiv zakázek</div>
              {years.length > 0 && (
                <div style={{marginLeft:"auto"}}>
                  <select value={activeYear} onChange={e=>setActiveYear(e.target.value)}>
                    {years.map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
              )}
            </div>
            <div className="card-c">
              {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
              {years.length === 0 && !err && (
                <div className="small">Zatím žádné dokončené zakázky.</div>
              )}
              {years.length > 0 && (
                <div className="archive-grid">
                  {monthNames.map((name, idx) => {
                    const jobs = (yearData && yearData[idx]) || [];
                    return (
                      <div className="archive-month-card" key={idx}>
                        <div className="archive-month-head">
                          <div className="archive-month-title">{name}</div>
                          {jobs.length > 0 && (
                            <div className="archive-month-count small">
                              {jobs.length} zakázek
                            </div>
                          )}
                        </div>
                        <div className="archive-month-body small">
                          {jobs.length === 0 && (
                            <div>Žádné dokončené zakázky.</div>
                          )}
                          {jobs.map(j => (
                            <div className="archive-job-row" key={j.id}>
                              <div className="archive-job-main">
                                <div className="archive-job-title">{j.title}</div>
                              </div>
                              <div className="archive-job-actions">
                                <button type="button" onClick={() => openJob(j.id)}>Otevřít detail</button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      }

      function TasksTab(){
        const [list,setList]=useState([]);
        const [employees,setEmployees]=useState([]);
        const [jobs,setJobs]=useState([]);
        const [form,setForm]=useState({title:"",description:"",due_date:"",employee_id:"",job_id:""});
        async function load(){ try{ const [t,e,j]=await Promise.all([api("/api/tasks"), api("/api/employees"), api("/api/jobs")]); setList(t.tasks||[]); setEmployees(e.employees||[]); setJobs(j.jobs||[]); }catch(e){ console.error(e);} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        async function add(e){ e.preventDefault(); await api("/api/tasks",{method:"POST",body:JSON.stringify({...form, due_date: toISODateFlex(form.due_date)})}); setForm({title:"",description:"",due_date:"",employee_id:"",job_id:""}); load(); }
        async function setStatus(t, status){ await api("/api/tasks",{method:"PATCH",body:JSON.stringify({id:t.id,status})}); load(); }
        async function del(t){ if(!confirm("Smazat úkol?")) return; await api("/api/tasks?id="+t.id,{method:"DELETE"}); load(); }
        return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
          <div className="card"><div className="card-h"><div>Úkoly</div></div><div className="card-c">
            <form onSubmit={add}><div className="form-row">
              <input placeholder="Nadpis" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} required style={{flex:2}}/>
              <input placeholder="Termín (YYYY-MM-DD)" value={form.due_date} onChange={e=>setForm({...form,due_date:e.target.value})}/>
              <select value={form.employee_id} onChange={e=>setForm({...form,employee_id:e.target.value})}><option value="">Bez přiřazení</option>{employees.map(emp=>(<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select>
              <select value={form.job_id} onChange={e=>setForm({...form,job_id:e.target.value})}><option value="">Bez zakázky</option>{jobs.map(j=>(<option key={j.id} value={j.id}>{j.title}</option>))}</select>
              <button type="submit">Přidat</button>
            </div><div className="form-row"><input placeholder="Popis" value={form.description} onChange={e=>setForm({...form,description:e.target.value})} style={{flex:1}}/></div></form>
            <table className="table"><thead><tr><th>Stav</th><th>Název</th><th>Zaměstnanec</th><th>Zakázka</th><th>Termín</th><th></th></tr></thead><tbody>
              {list.map(t=>(<tr key={t.id}><td><span className="badge">{t.status}</span></td><td>{t.title}</td><td>{t.employee_id || "-"}</td><td>{t.job_id || "-"}</td><td>{t.due_date || "-"}</td>
              <td className="small"><button className="ghost" onClick={()=>setStatus(t,"nový")}>nový</button><button className="ghost" onClick={()=>setStatus(t,"probíhá")}>probíhá</button><button className="ghost" onClick={()=>setStatus(t,"hotovo")}>hotovo</button><button className="ghost" onClick={()=>del(t)}>smazat</button></td></tr>))}
            </tbody></table>
            {list.length===0 && <div className="small">Zatím žádné úkoly.</div>}
          </div></div>
        </div>);
      }

      function Dashboard({user, taskCount}){
        const [stats,setStats]=useState({
          jobs:0,employees:0,tasks:0
        });
        
        useEffect(()=>{
          (async()=>{
            try{
              // Get jobs
              let jobs = {jobs:[]};
              try {
                jobs = await api("/api/jobs");
              } catch(e) {
                console.warn("Failed to load jobs:", e);
              }
              const jobsCount = (jobs.jobs||[]).length;
              
              // Get employees
              let emps = {employees:[]};
              try {
                emps = await api("/api/employees");
              } catch(e) {
                console.warn("Failed to load employees:", e);
              }
              const empCount = (emps.employees||[]).length;
              
              // Get tasks
              let tasks = {tasks:[]};
              try {
                tasks = await api("/api/tasks");
              } catch(e) {
                console.warn("Failed to load tasks:", e);
              }
              const taskCount = (tasks.tasks||[]).length;
              
              setStats({
                jobs: jobsCount,
                employees: empCount,
                tasks: taskCount
              });
            }catch(e){
              console.error("Dashboard error:", e);
              setStats({jobs:0,employees:0,tasks:0});
            }
          })();
        },[]);
        
        return (<div style={{paddingBottom:100,padding:"20px",maxWidth:"1200px",margin:"0 auto"}}>
          <style>{`
            .admin-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 32px; margin-bottom: 24px; display: flex; align-items: center; gap: 24px; }
            .admin-card .admin-title { font-size: 36px; font-weight: 700; color: #e8eef2; margin: 0; }
            .admin-card .admin-role { font-size: 16px; color: var(--mint); margin-top: 4px; }
            .admin-card .admin-search { flex: 1; max-width: 300px; }
            .admin-card .admin-search input { width: 100%; padding: 12px 16px; background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-size: 14px; }
            .admin-card .admin-search input:focus { outline: none; border-color: var(--mint); }
            .admin-card .admin-search input::placeholder { color: #6b7580; }
            .admin-card .admin-stats { display: flex; gap: 32px; }
            .admin-stat { text-align: center; cursor: pointer; transition: opacity 0.2s; }
            .admin-stat:hover { opacity: 0.8; }
            .admin-stat .value { font-size: 32px; font-weight: 700; color: #e8eef2; display: block; }
            .admin-stat .label { font-size: 14px; color: #9ca8b3; margin-top: 4px; }
            
            .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
            .action-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; }
            .action-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); border-color: var(--mint); }
            .action-card .icon-circle { width: 64px; height: 64px; border-radius: 50%; background: var(--mint); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
            .action-card .icon-circle svg { width: 32px; height: 32px; stroke: #0a0e11; }
            .action-card h3 { font-size: 18px; font-weight: 600; color: #e8eef2; margin: 0 0 8px 0; }
            .action-card p { font-size: 14px; color: #9ca8b3; margin: 0; }
            
            @media (max-width: 768px) {
              .admin-card { flex-direction: column; text-align: center; }
              .admin-card .admin-search { max-width: 100%; width: 100%; }
              .admin-card .admin-stats { justify-content: center; flex-wrap: wrap; }
              .action-grid { grid-template-columns: repeat(2, 1fr); }
            }
          `}</style>
          
          {/* Admin Card */}
          <div className="admin-card">
              <div>
              <div className="admin-title">Admin</div>
              <div className="admin-role">admin</div>
              </div>
            <div className="admin-search">
              <input type="search" placeholder="Vyhledávat..." />
            </div>
            <div className="admin-stats">
              <div className="admin-stat" onClick={()=>{window.location.href="/jobs.html";}}>
                <span className="value">{stats.jobs}</span>
                <span className="label">zakázky</span>
              </div>
              <div className="admin-stat" onClick={()=>window.location.href="/employees.html"}>
                <span className="value">{stats.employees}</span>
                <span className="label">tým</span>
              </div>
              <div className="admin-stat" onClick={()=>window.location.href="/tasks.html"}>
                <span className="value">{stats.tasks}</span>
                <span className="label">úkoly</span>
              </div>
            </div>
          </div>

          {/* Action Cards */}
          <div className="action-grid">
            <div className="action-card" onClick={()=>{window.location.href="/jobs.html";}}>
              <div className="icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </div>
              <h3>Nová zakázka</h3>
              <p>Vytvořit</p>
            </div>
            <div className="action-card" onClick={()=>window.location.href="/timesheets.html"}>
              <div className="icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <h3>Výkaz hodin</h3>
              <p>Přidat čas</p>
            </div>
            <div className="action-card" onClick={()=>{window.location.href="/jobs.html";}}>
              <div className="icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                  <rect x="9" y="3" width="6" height="4" rx="1"/>
                  <path d="M9 12h6"/>
                  <path d="M9 16h6"/>
                </svg>
              </div>
              <h3>Zakázky</h3>
              <p>Přehled</p>
            </div>
            <div className="action-card" onClick={()=>window.location.href="/tasks.html"}>
              <div className="icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
              </div>
              <h3>Úkoly</h3>
              <p>Přehled</p>
            </div>
            <div className="action-card" onClick={()=>window.location.href="/employees.html"}>
              <div className="icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
              </div>
              <h3>Tým</h3>
              <p>Spravovat</p>
            </div>
            <div className="action-card" onClick={()=>{if(window.setAppTab) window.setAppTab('reports'); else window.location.href="/reports.html";}}>
              <div className="icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="18" y1="20" x2="18" y2="10"/>
                  <line x1="12" y1="20" x2="12" y2="4"/>
                  <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
              </div>
              <h3>Statistiky</h3>
              <p>Přehledy</p>
            </div>
          </div>
        </div>);
      }

      function App(){
        const [auth,setAuth]=useState({ready:false, ok:false, user:null, tasks:0}); const [tab, setTab] = useState("dashboard"); const [jobOpen,setJobOpen]=useState(null);
        useEffect(()=>{(async()=>{ try{ const j=await api("/api/me"); setAuth({ready:true, ok:j.authenticated, user:j.user||null, tasks:j.tasks_count||0}); refreshUserBox(); }catch(e){ showJSError(e.message);} })()},[]);
        if(!auth.ready) return <div className="small">Načítám…</div>;
        if(!auth.ok) return <Login onLogged={()=>location.reload()}/>;
        // Store setTab in window for menu access
        window.setAppTab = (k) => { setTab(k); setJobOpen(null); };
        window.appTab = tab;
        window.appCanAdmin = auth.user?.role==="admin";
        
        return (<div>
          {/* Tabs moved to "Více" menu */}
          {tab==="dashboard" && <Dashboard user={auth.user} taskCount={auth.tasks}/>}
          {tab==="jobs" && (jobOpen? <JobDetail jobId={jobOpen} onBack={()=>setJobOpen(null)}/> : <JobsList onOpen={setJobOpen}/>)}
          {tab==="archive" && <ArchiveTab onOpen={(id)=>{ setJobOpen(id); setTab("jobs"); }}/>}
          {tab==="tasks" && <TasksTab/>}
          {tab==="employees" && <Employees/>}
          {tab==="warehouse" && <Warehouse/>}
          {tab==="users" && auth.user?.role==="admin" && <UsersTab/>}
          {tab==="statistics" && <StatisticsTab user={auth.user}/>}
          {tab==="reports" && <ReportsTab user={auth.user}/>}
        </div>);
      }

      // Employees root (needs after App def)
      function Employees(){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({name:"",role:"Zahradník"});
        const [editId,setEditId]=useState(null);
        const [edit,setEdit]=useState({name:"",role:""});
        const [changeIdFor,setChangeIdFor]=useState(null);
        const [newId,setNewId]=useState("");
        const [open,setOpen]=useState(null);
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/employees"); setList(j.employees||[]); }catch(e){ setErr(e.message);} }
        useEffect(()=>{ load().catch(()=>{}); },[]);
        async function add(e){ e.preventDefault(); await api("/api/employees",{method:"POST",body:JSON.stringify(form)}); setForm({name:"",role:"Zahradník"}); load(); }
        async function del(id){ if(!confirm("Smazat zaměstnance?")) return; await api("/api/employees?id="+id,{method:"DELETE"}); load(); }
        
        async function startEdit(e){ setEditId(e.id); setEdit({name:e.name, role:e.role}); }
        async function cancelEdit(){ setEditId(null); setEdit({name:"",role:""}); }
        async function saveEdit(e){
          await api("/api/employees",{method:"PATCH", body: JSON.stringify({id:e.id, name:edit.name, role:edit.role})});
          setEditId(null); setEdit({name:"",role:""}); load();
        }

        async function startChangeId(e){ setChangeIdFor(e.id); setNewId(String(e.id)); }
        async function cancelChangeId(){ setChangeIdFor(null); setNewId(""); }
        async function saveChangeId(e){
          const nid = parseInt(newId, 10);
          if(!nid || nid<=0){ alert("Zadej platné číslo ID"); return; }
          await api("/api/employees/reassign_id",{method:"POST", body: JSON.stringify({old_id:e.id,new_id:nid})});
          setChangeIdFor(null); setNewId(""); load();
        }
if(open){ const emp=list.find(x=>x.id===open); if(emp) return <EmployeeDetail employee={emp} onBack={()=>setOpen(null)}/>; }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nový zaměstnanec</div></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <input placeholder="Jméno" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/>
                    <input placeholder="Role (např. Zahradník)" value={form.role} onChange={e=>setForm({...form,role:e.target.value})} required style={{flex:1}}/>
                    <button type="submit">Přidat</button>
                  </div>
                </form>
              </div>
            </div>
            <div className="card">
              <div className="card-h"><div>Seznam</div></div>
              <div className="card-c">
                {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
                <table className="table">
                  <thead><tr><th>ID</th><th>Jméno</th><th>Role</th><th></th></tr></thead>
                  <tbody>
                    {list.map(e=>(
                      <tr key={e.id}>
                        <td>{e.id}</td>
                        <td>{editId===e.id ? (<input value={edit.name} onChange={ev=>setEdit({...edit,name:ev.target.value})} placeholder="Jméno"/>) : (<span className="link" onClick={()=>setOpen(e.id)}>{e.name}</span>)}</td>
                        <td>{editId===e.id ? (<input value={edit.role} onChange={ev=>setEdit({...edit,role:ev.target.value})} placeholder="Role"/>) : e.role}</td>
                        <td>
                          {editId===e.id ? (
                            <>
                              <button onClick={()=>saveEdit(e)}>Uložit</button>
                              <button className="ghost" onClick={cancelEdit} style={{marginLeft:6}}>Zrušit</button>
                            </>
                          ) : changeIdFor===e.id ? (
                            <>
                              <input type="number" value={newId} onChange={ev=>setNewId(ev.target.value)} placeholder="Nové ID" style={{width:100}}/>
                              <button onClick={()=>saveChangeId(e)} style={{marginLeft:6}}>Uložit ID</button>
                              <button className="ghost" onClick={cancelChangeId} style={{marginLeft:6}}>Zrušit</button>
                            </>
                          ) : (
                            <>
                              <button onClick={()=>setOpen(e.id)}>Detail</button>
                              <button className="ghost" onClick={()=>startEdit(e)} style={{marginLeft:6}}>Upravit</button>
                              <button className="ghost" onClick={()=>startChangeId(e)} style={{marginLeft:6}}>Změnit ID</button>
                              <button className="ghost" onClick={()=>del(e.id)} style={{marginLeft:6}}>Smazat</button>
                            </>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {list.length===0 && <div className="small">Zatím žádní zaměstnanci – přidej prvního výše.</div>}
              </div>
            </div>
          </div>
        );
      }

      function ReportsTab({user}){
        const [stats,setStats]=useState({
          activeJobs:0,employees:0,tasks:0,
          totalHoursWeek:0,totalHoursMonth:0,
          topEmployee:null,upcomingTasks:0,
          pendingTasks:0,urgentTasks:0,
          onlineEmployees:0,totalEmployees:0
        });
        const [activeJobs,setActiveJobs]=useState([]);
        const [todayEvents,setTodayEvents]=useState([]);
        const [teamStatus,setTeamStatus]=useState([]);
        const [notifications,setNotifications]=useState([]);
        const [chartData,setChartData]=useState({monthly:[],breakdown:[]});
        const [chartPeriod,setChartPeriod]=useState("week");
        
        useEffect(()=>{
          (async()=>{
            try{
              // Get this week's timesheets
              const today = new Date();
              const monday = new Date(today);
              monday.setDate(today.getDate() - ((today.getDay()+6)%7));
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6);
              const fmt = (d)=>d.toISOString().slice(0,10);
              let timesheets = {rows:[]};
              try {
                timesheets = await api(`/api/timesheets?from=${fmt(monday)}&to=${fmt(sunday)}`);
              } catch(e) {
                console.warn("Failed to load timesheets:", e);
              }
              const totalHWeek = (timesheets.rows||[]).reduce((s,r)=>s+(r.hours||0),0);
              
              // Get this month's timesheets
              const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
              const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              let timesheetsMonth = {rows:[]};
              try {
                timesheetsMonth = await api(`/api/timesheets?from=${fmt(monthStart)}&to=${fmt(monthEnd)}`);
              } catch(e) {
                console.warn("Failed to load monthly timesheets:", e);
              }
              const totalHMonth = (timesheetsMonth.rows||[]).reduce((s,r)=>s+(r.hours||0),0);
              
              // Get jobs
              const jobs = await api("/api/jobs");
              const active = (jobs.jobs||[]).filter(j=>j.status==="Probíhá"||j.status==="Plán").length;
              const activeList = (jobs.jobs||[]).filter(j=>j.status==="Probíhá"||j.status==="Plán").slice(0,5);
              
              // Get employees
              let emps = {employees:[]};
              try {
                emps = await api("/api/employees");
              } catch(e) {
                console.warn("Failed to load employees:", e);
              }
              const empCount = (emps.employees||[]).length;
              
              // Get tasks
              let tasks = {tasks:[]};
              try {
                tasks = await api("/api/tasks");
              } catch(e) {
                console.warn("Failed to load tasks:", e);
              }
              const taskCount = (tasks.tasks||[]).length;
              const pending = (tasks.tasks||[]).filter(t=>t.status==="open"||t.status==="in-progress").length;
              const todayDate = today.toISOString().slice(0,10);
              const urgent = (tasks.tasks||[]).filter(t=>t.due_date===todayDate&&t.status!=="completed").length;
              const upcoming = (tasks.tasks||[]).filter(t=>t.status!=="completed"&&t.due_date&&new Date(t.due_date)>=today).length;
              
              // Get today's events (deadlines, tasks)
              const events = [];
              (tasks.tasks||[]).filter(t=>t.due_date===todayDate).forEach(t=>{
                events.push({time:"09:00",type:"deadline",title:`Deadline - ${t.title}`,description:"Dokončení prací",urgent:true});
              });
              
              // Get team status - show ALL employees, not just those with recent activity
              const empStatus = [];
              (emps.employees||[]).forEach(emp=>{
                const empTimesheets = (timesheets.rows||[]).filter(ts=>ts.employee_id===emp.id);
                const hasRecentActivity = empTimesheets.some(ts=>{
                  const tsDate = new Date(ts.date);
                  const diff = (today - tsDate) / (1000 * 60 * 60);
                  return diff < 24;
                });
                
                // Show all employees, mark status based on activity
                const jobHours = {};
                empTimesheets.forEach(ts=>{
                  const job = (jobs.jobs||[]).find(j=>j.id===ts.job_id);
                  if(job) jobHours[job.title||`Zakázka ${job.id}`] = (jobHours[job.title||`Zakázka ${job.id}`]||0) + (ts.hours||0);
                });
                const currentJob = Object.entries(jobHours).sort((a,b)=>b[1]-a[1])[0];
                const weekHours = empTimesheets.reduce((s,r)=>s+(r.hours||0),0);
                
                empStatus.push({
                  id:emp.id,
                  name:emp.name || `Zaměstnanec ${emp.id}`,
                  status:hasRecentActivity?'online':'offline',
                  currentWork:currentJob ? currentJob[0] : 'Pauza',
                  hours:weekHours > 0 ? weekHours.toFixed(1) : '0'
                });
              });
              
              // Calculate online employees
              const onlineCount = empStatus.filter(e=>e.status==='online').length;
              
              // Monthly chart data (last 30 days)
              const monthlyData = [];
              for(let i=29;i>=0;i--){
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dayTimesheets = (timesheetsMonth.rows||[]).filter(ts=>ts.date===date.toISOString().slice(0,10));
                const hours = dayTimesheets.reduce((s,r)=>s+(r.hours||0),0);
                monthlyData.push({date:date.toLocaleDateString('cs-CZ',{day:'2-digit',month:'2-digit'}),hours});
              }
              
              // Time breakdown (simplified - by job type)
              const breakdownData = [];
              const jobTypes = {};
              (timesheets.rows||[]).forEach(r=>{
                const job = (jobs.jobs||[]).find(j=>j.id===r.job_id);
                const type = job ? (job.status||'Jiné') : 'Jiné';
                jobTypes[type] = (jobTypes[type]||0) + (r.hours||0);
              });
              Object.entries(jobTypes).forEach(([type,hours])=>{
                breakdownData.push({name:type,hours});
              });
              
              // Notifications
              const notifs = [];
              if(urgent>0){
                notifs.push({icon:"warning",type:"warning",title:"Deadline blíží!",text:`${urgent} úkol${urgent>1?'y':'ů'} končí dnes`,time:"před 10 min",unread:true});
              }
              if(totalHWeek>0){
                notifs.push({icon:"success",type:"success",title:"Výkaz schválen",text:"Tvůj výkaz za minulý týden byl schválen",time:"před 1h",unread:false});
              }
              
              // Calculate top employee
              const empHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const name = r.employee_name || 'Neznámý';
                empHours[name] = (empHours[name]||0) + (r.hours||0);
              });
              const topEmp = Object.entries(empHours).sort((a,b)=>b[1]-a[1])[0];
              
              // Chart data - hours per employee
              const empChartData = Object.entries(empHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              // Chart data - hours per job
              const jobHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const title = r.job_title || `Zakázka ${r.job_id}`;
                jobHours[title] = (jobHours[title]||0) + (r.hours||0);
              });
              const jobChartData = Object.entries(jobHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              setStats({
                activeJobs: active,
                employees: empCount,
                tasks: taskCount,
                totalHoursWeek: totalHWeek,
                totalHoursMonth: totalHMonth,
                topEmployee: topEmp ? {name:topEmp[0],hours:topEmp[1]} : null,
                upcomingTasks: upcoming,
                pendingTasks: pending,
                urgentTasks: urgent,
                onlineEmployees: onlineCount,
                totalEmployees: empCount
              });
              
              setActiveJobs(activeList);
              setTodayEvents(events);
              setTeamStatus(empStatus);
              setNotifications(notifs);
              setChartData({monthly:monthlyData,breakdown:breakdownData,employees:empChartData,jobs:jobChartData});
            }catch(e){
              console.error("ReportsTab error:", e);
              // Set default values on error
              setStats({
                activeJobs:0,employees:0,tasks:0,
                totalHoursWeek:0,totalHoursMonth:0,
                topEmployee:null,upcomingTasks:0,
                pendingTasks:0,urgentTasks:0,
                onlineEmployees:0,totalEmployees:0
              });
            }
          })();
        },[]);
        
        // Simple SVG Bar Chart Component
        const BarChart = ({data,height=200,color="#9FD4A1",mobile=false})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>Žádná data</div>;
          const max = Math.max(...data.map(d=>d.hours),1);
          const barWidth = mobile ? (280 / Math.max(data.length, 1)) : (280 / data.length);
          const fontSize = mobile ? 9 : 10;
          const valueFontSize = mobile ? 10 : 11;
          // Zobraz každé 3. datum nebo otoč labely o 45°
          const showEveryNth = data.length > 15 ? 3 : 1;
          return <svg width="100%" height={height} style={{overflow:"visible"}}>
            {data.map((d,i)=>{
              const barHeight = Math.max(0, (d.hours/max)*(mobile ? 120 : 150));
              const rectWidth = Math.max(1, barWidth-10);
              const showLabel = i % showEveryNth === 0 || i === data.length - 1;
              return <g key={i}>
                <rect x={i*barWidth+10} y={height-barHeight-20} width={rectWidth} height={barHeight} fill={color} opacity={0.8} rx={4}/>
                {showLabel && (
                  <text 
                    x={i*barWidth+barWidth/2+5} 
                    y={height-5} 
                    fontSize={fontSize} 
                    fill="#9ca8b3" 
                    textAnchor="middle"
                    transform={`rotate(-45 ${i*barWidth+barWidth/2+5} ${height-5})`}
                    style={{transformOrigin: `${i*barWidth+barWidth/2+5}px ${height-5}px`}}
                  >
                    {d.name}
                  </text>
                )}
                <text x={i*barWidth+barWidth/2+5} y={height-barHeight-25} fontSize={valueFontSize} fill="#e8eef2" textAnchor="middle" fontWeight="600">{d.hours.toFixed(1)}h</text>
              </g>;
            })}
          </svg>;
        };
        
        // Simple SVG Pie Chart Component
        const PieChart = ({data,size=200,colors=["#9FD4A1","#9FD4A1","#9FD4A1","#9FD4A1","#9FD4A1"]})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>Žádná data</div>;
          const total = data.reduce((s,d)=>s+d.hours,0);
          if(total===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>Žádná data</div>;
          let currentAngle = -90;
          const center = size/2;
          const radius = size/2-20;
          return <svg width={size} height={size} style={{margin:"0 auto",display:"block"}}>
            {data.map((d,i)=>{
              const angle = (d.hours/total)*360;
              const startAngle = currentAngle;
              const endAngle = currentAngle + angle;
              currentAngle += angle;
              const x1 = center + radius*Math.cos(startAngle*Math.PI/180);
              const y1 = center + radius*Math.sin(startAngle*Math.PI/180);
              const x2 = center + radius*Math.cos(endAngle*Math.PI/180);
              const y2 = center + radius*Math.sin(endAngle*Math.PI/180);
              const largeArc = angle>180?1:0;
              return <path key={i} d={`M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={colors[i%colors.length]} opacity={0.8} stroke="#0a0e11" strokeWidth="2"/>
            })}
            <text x={center} y={center+5} fontSize="14" fill="#e8eef2" textAnchor="middle" fontWeight="600">{total.toFixed(1)}h</text>
            <text x={center} y={center+20} fontSize="11" fill="#9ca8b3" textAnchor="middle">Celkem</text>
          </svg>;
        };
        
        const today = new Date();
        const todayStr = today.toLocaleDateString('cs-CZ',{day:'numeric',month:'long',year:'numeric'});
        const weekGoal = 200;
        const weekProgress = stats.totalHoursWeek / weekGoal * 100;
        
        return (<div style={{paddingBottom:100,padding:"20px",maxWidth:"1600px",margin:"0 auto"}}>
          <style>{`
            .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
            .metric-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px; display: flex; gap: 16px; align-items: center; transition: all 0.3s; }
            .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-color: var(--mint); }
            .metric-card.primary { border-left: 4px solid #3b82f6; }
            .metric-card.success { border-left: 4px solid #9FD4A1; }
            .metric-card.warning { border-left: 4px solid #fb923c; }
            .metric-card.info { border-left: 4px solid #60a5fa; }
            .metric-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }
            .metric-icon svg { width: 48px; height: 48px; stroke: #9FD4A1; fill: none; stroke-width: 2; }
            .metric-data { flex: 1; }
            .metric-data h2 { font-size: 32px; font-weight: 700; color: #e8eef2; margin: 0 0 4px 0; }
            .metric-data p { font-size: 14px; color: #9ca8b3; margin: 0 0 8px 0; }
            .trend { font-size: 12px; color: #9ca8b3; }
            .trend.up { color: #9FD4A1; }
            .progress-mini { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 8px 0 4px 0; }
            .progress-mini .fill { height: 100%; background: linear-gradient(90deg, #9FD4A1, #9FD4A1); transition: width 0.3s; }
            
            .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
            .action-btn { flex: 1; min-width: 150px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 14px; font-weight: 500; }
            .action-btn:hover { background: var(--mint); border-color: var(--mint); color: #0a0e11; transform: translateY(-2px); }
            .action-btn .icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
            .action-btn .icon svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; }
            
            .today-timeline { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .today-timeline h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .timeline-item { display: flex; gap: 16px; padding: 12px; border-radius: 8px; margin-bottom: 12px; background: var(--bg-elevated); }
            .timeline-item.urgent { background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fb923c; }
            .timeline-item .time { font-size: 14px; font-weight: 600; color: var(--text-primary); min-width: 60px; }
            .timeline-item .event h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .timeline-item .event p { font-size: 12px; color: var(--text-secondary); margin: 0; }
            
            .active-projects { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .active-projects h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .project-preview { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; }
            .project-info { flex: 1; }
            .project-info h4 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .project-info p { font-size: 12px; color: var(--text-secondary); margin: 0; }
            .project-progress { position: relative; width: 60px; height: 60px; }
            .progress-circle { width: 60px; height: 60px; position: relative; }
            .progress-circle svg { transform: rotate(-90deg); }
            .progress-circle circle { fill: none; stroke-width: 6; stroke-dasharray: 188; stroke-dashoffset: 47; transition: stroke-dashoffset 0.3s, stroke 0.3s; }
            .progress-circle span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 600; color: var(--text-primary); }
            /* Barvy podle procent - nastaví se dynamicky přes JavaScript */
            .progress-circle.progress-red circle { stroke: #ef4444; }
            .progress-circle.progress-orange circle { stroke: #f59e0b; }
            .progress-circle.progress-green circle { stroke: #9FD4A1; }
            .project-deadline .warning { color: #fb923c; font-size: 12px; font-weight: 500; }
            
            .team-status { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .team-status h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .team-member { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; position: relative; }
            .team-member .avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--mint); display: flex; align-items: center; justify-content: center; color: #0a0e11; font-weight: 600; font-size: 18px; }
            .member-info { flex: 1; }
            .member-info h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
            .member-info .current-work { font-size: 12px; color: var(--text-secondary); margin: 0 0 2px 0; }
            .member-info .time { font-size: 11px; color: var(--text-tertiary); }
            .status-dot { width: 12px; height: 12px; border-radius: 50%; position: absolute; top: 12px; right: 12px; }
            .team-member.online .status-dot { background: var(--mint); }
            .team-member.pause .status-dot { background: #fb923c; }
            
            .dashboard-chart { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
            .dashboard-chart h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            
            .notifications-widget { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; }
            .notifications-widget h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; }
            .notification { display: flex; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; }
            .notification.unread { background: rgba(60, 165, 250, 0.1); border-left: 3px solid #3b82f6; }
            .notif-icon { font-size: 24px; }
            .notif-content { flex: 1; }
            .notif-content p { margin: 0 0 4px 0; font-size: 13px; color: var(--text-primary); }
            .notif-content .time { font-size: 11px; color: var(--text-tertiary); }
            .view-all { width: 100%; padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 14px; margin-top: 8px; }
            .view-all:hover { background: var(--mint); border-color: var(--mint); color: #0a0e11; }
            
            @media (max-width: 768px) {
              .dashboard-stats { grid-template-columns: 1fr; gap: 12px; }
              .quick-actions { flex-direction: column; }
              .action-btn { width: 100%; }
              .metric-card { padding: 16px; }
              .metric-data h2 { font-size: 24px; }
              .dashboard-chart { padding: 16px; }
              .dashboard-chart svg { max-height: 250px !important; }
              .stat-card { padding: 12px; font-size: 14px; }
              .today-timeline, .active-projects, .team-status, .notifications-widget { padding: 16px; }
            }
            
            @media (max-width: 767px) {
              .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
              .metric-card { flex-direction: column; text-align: center; }
              .metric-icon { width: 40px; height: 40px; }
              .metric-icon svg { width: 40px; height: 40px; }
              .dashboard-chart svg { max-height: 250px !important; height: 250px !important; }
            }
          `}</style>
          
          <h1 style={{fontSize:28,fontWeight:700,color:"#e8eef2",marginBottom:24,display:"flex",alignItems:"center",gap:"12px"}}>
            <svg style={{width:"32px",height:"32px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            Přehledy
          </h1>
          
          {/* Top Stat Cards */}
          <div className="dashboard-stats">
            <div className="metric-card primary" style={{cursor:"pointer"}} onClick={()=>{window.location.href="/jobs.html";}}>
              <div className="metric-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                  <rect x="9" y="3" width="6" height="4" rx="1"/>
                  <path d="M9 12h6"/>
                  <path d="M9 16h6"/>
                </svg>
              </div>
              <div className="metric-data">
                <h2>{stats.activeJobs}</h2>
                <p>Aktivní zakázky</p>
                <span className="trend up">↑ 12% vs minulý měsíc</span>
              </div>
            </div>
            
            <div className="metric-card success">
              <div className="metric-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <div className="metric-data">
                <h2>{stats.totalHoursWeek.toFixed(0)}h</h2>
                <p>Hodiny tento týden</p>
                <div className="progress-mini">
                  <div className="fill" style={{width: `${Math.min(weekProgress, 100)}%`}}></div>
                </div>
                <span>{Math.round(weekProgress)}% týdenního cíle ({weekGoal}h)</span>
              </div>
            </div>
            
            <div className="metric-card warning" style={{cursor:"pointer"}} onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>
              <div className="metric-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
              <div className="metric-data">
                <h2>{stats.pendingTasks}</h2>
                <p>Čekající úkoly</p>
                <span className="trend">{stats.urgentTasks} s deadline dnes</span>
              </div>
            </div>
            
            <div className="metric-card info" style={{cursor:"pointer"}} onClick={()=>window.location.href="/employees.html"}>
              <div className="metric-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
              </div>
              <div className="metric-data">
                <h2>{stats.onlineEmployees}/{stats.totalEmployees}</h2>
                <p>Tým online</p>
                <span>{stats.totalEmployees>0 ? Math.round(stats.onlineEmployees/stats.totalEmployees*100) : 0}% dostupnost</span>
              </div>
            </div>
          </div>
          
          {/* Quick Actions */}
          <div className="quick-actions">
            <button className="action-btn" onClick={()=>{window.location.href="/jobs.html";}}>
              <span className="icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </span>
              <span>Nová zakázka</span>
            </button>
            <button className="action-btn" onClick={()=>window.location.href="/timesheets.html"}>
              <span className="icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </span>
              <span>Přidat výkaz</span>
            </button>
            <button className="action-btn" onClick={()=>{if(window.setAppTab) window.setAppTab('tasks');}}>
              <span className="icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
              </span>
              <span>Nový úkol</span>
            </button>
            <button className="action-btn" onClick={()=>window.location.href="/reports.html"}>
              <span className="icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="18" y1="20" x2="18" y2="10"/>
                  <line x1="12" y1="20" x2="12" y2="4"/>
                  <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
              </span>
              <span>Generovat report</span>
            </button>
          </div>
          
          {/* Main Grid */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(400px, 1fr))",gap:"24px"}}>
            {/* Left Column */}
            <div>
              {/* Today Timeline */}
              <div className="today-timeline">
                <h3 style={{display:"flex",alignItems:"center",gap:"8px"}}>
                  <svg style={{width:"20px",height:"20px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  Dnes - {todayStr}
                </h3>
                {todayEvents.length > 0 ? todayEvents.map((e,i)=><div key={i} className={`timeline-item ${e.urgent?'urgent':''}`}>
                  <div className="time">{e.time}</div>
                  <div className="event">
                    <h4>{e.title}</h4>
                    <p>{e.description}</p>
                  </div>
                </div>) : <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>Žádné události na dnes</div>}
              </div>

              {/* Active Projects */}
              <div className="active-projects">
                <h3 style={{display:"flex",alignItems:"center",gap:"8px"}}>
                  <svg style={{width:"20px",height:"20px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                  </svg>
                  Top aktivní projekty
                </h3>
                {activeJobs.slice(0,5).map(j=>{
                  const progress = Math.random()*100; // Simplified - would calculate from actual data
                  const daysLeft = j.date ? Math.ceil((new Date(j.date) - today) / (1000*60*60*24)) : null;
                  return <div key={j.id} className="project-preview" style={{cursor:"pointer"}} onClick={()=>{window.location.href="/jobs.html";}}>
                    <div className="project-info">
                      <h4>{j.title || `Zakázka ${j.id}`}</h4>
                      <p>{j.client || '—'} • {j.city || '—'}</p>
                    </div>
                    <div className="project-progress">
                      <div className={`progress-circle ${progress <= 30 ? 'progress-red' : progress <= 70 ? 'progress-orange' : 'progress-green'}`} data-progress={progress}>
                        <svg width="60" height="60">
                          <circle cx="30" cy="30" r="30" strokeDashoffset={188 - (Math.max(0, Math.min(100, progress))/100)*188}></circle>
                        </svg>
                        <span>{Math.round(Math.max(0, Math.min(100, progress)))}%</span>
                      </div>
                    </div>
                    {daysLeft !== null && daysLeft >= 0 && daysLeft <= 7 && <div className="project-deadline">
                      <span className="warning">Končí za {daysLeft} {daysLeft===1?'den':daysLeft<5?'dny':'dní'}</span>
                    </div>}
                  </div>;
                })}
                {activeJobs.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>Žádné aktivní projekty</div>}
              </div>
            </div>

            {/* Right Column */}
            <div>
              {/* Team Status */}
              <div className="team-status">
                <h3 style={{display:"flex",alignItems:"center",gap:"8px"}}>
                  <svg style={{width:"20px",height:"20px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                  </svg>
                  Tým právě teď
                </h3>
                {teamStatus.slice(0,5).map(emp=>{
                  const status = emp.status || 'offline';
                  const initials = (emp.name || '').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '?';
                  return <div key={emp.id} className={`team-member ${status}`}>
                    <div className="avatar">{initials}</div>
                    <div className="member-info">
                      <h4>{emp.name || 'Bez jména'}</h4>
                      <p className="current-work">{emp.currentWork || '—'}</p>
                      <span className="time">{emp.hours || '0'}h</span>
                    </div>
                    <div className="status-dot"></div>
                  </div>;
                })}
                {teamStatus.length === 0 && <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>Žádní členové týmu</div>}
              </div>
              
              {/* Monthly Performance Chart */}
              <div className="dashboard-chart">
                <h3 style={{display:"flex",alignItems:"center",gap:"8px"}}>
                  <svg style={{width:"20px",height:"20px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                    <polyline points="17 6 23 6 23 12"/>
                  </svg>
                  Výkon za měsíc
                </h3>
                <BarChart data={chartData.monthly.map(d=>({name:d.date,hours:d.hours}))} height={window.innerWidth <= 768 ? 250 : 200} color="#9FD4A1" mobile={window.innerWidth <= 768}/>
              </div>
              
              {/* Time Breakdown Chart */}
              <div className="dashboard-chart">
                <h3 style={{display:"flex",alignItems:"center",gap:"8px"}}>
                  <svg style={{width:"20px",height:"20px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  Rozložení času
                </h3>
                <PieChart data={chartData.breakdown} size={200}/>
              </div>
              
              {/* Notifications */}
              <div className="notifications-widget">
                <h3 style={{display:"flex",alignItems:"center",gap:"8px"}}>
                  <svg style={{width:"20px",height:"20px",stroke:"#9FD4A1"}} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 01-3.46 0"/>
                  </svg>
                  Upozornění
                </h3>
                {notifications.length > 0 ? (
                  <>
                    {notifications.slice(0,3).map((notif, idx) => (
                      <div key={idx} className={`notification ${notif.unread ? 'unread' : ''}`}>
                        <div className={`notif-icon ${notif.type}`}>{notif.icon}</div>
                        <div className="notif-content">
                          <p><strong>{notif.title}</strong></p>
                          <p>{notif.text}</p>
                          <span className="time">{notif.time}</span>
                        </div>
                      </div>
                    ))}
                    <button className="view-all" onClick={()=>{if(window.setAppTab) window.setAppTab('notifications');}}>Zobrazit všechny</button>
                  </>
                ) : (
                  <div style={{color:"var(--text-tertiary)",fontSize:"14px"}}>Žádná upozornění</div>
                )}
              </div>
            </div>
          </div>
        </div>);
      }

      function StatisticsTab({user}){
        const [chartData,setChartData]=useState({employees:[],jobs:[]});
        const [chartPeriod,setChartPeriod]=useState("week");
        
        useEffect(()=>{
          (async()=>{
            try{
              const today = new Date();
              const monday = new Date(today);
              monday.setDate(today.getDate() - ((today.getDay()+6)%7));
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6);
              const fmt = (d)=>d.toISOString().slice(0,10);
              const timesheets = await api(`/api/timesheets?from=${fmt(monday)}&to=${fmt(sunday)}`);
              
              // Chart data - hours per employee
              const empHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const name = r.employee_name || 'Neznámý';
                empHours[name] = (empHours[name]||0) + (r.hours||0);
              });
              const empChartData = Object.entries(empHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              // Chart data - hours per job
              const jobHours = {};
              (timesheets.rows||[]).forEach(r=>{
                const title = r.job_title || `Zakázka ${r.job_id}`;
                jobHours[title] = (jobHours[title]||0) + (r.hours||0);
              });
              const jobChartData = Object.entries(jobHours).map(([name,hours])=>({name,hours})).slice(0,5);
              
              setChartData({employees:empChartData,jobs:jobChartData});
            }catch(e){console.error(e);}
          })();
        },[]);
        
        const BarChart = ({data,height=200,color="#9FD4A1",mobile=false})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>Žádná data</div>;
          const max = Math.max(...data.map(d=>d.hours),1);
          const barWidth = mobile ? (280 / Math.max(data.length, 1)) : (280 / data.length);
          const fontSize = mobile ? 9 : 10;
          const valueFontSize = mobile ? 10 : 11;
          return <svg width="100%" height={height} style={{overflow:"visible"}}>
            {data.map((d,i)=>{
              const barHeight = Math.max(0, (d.hours/max)*(mobile ? 120 : 150));
              const rectWidth = Math.max(1, barWidth-10);
              return <g key={i}>
                <rect x={i*barWidth+10} y={height-barHeight-20} width={rectWidth} height={barHeight} fill={color} opacity={0.8} rx={4}/>
                <text x={i*barWidth+barWidth/2+5} y={height-5} fontSize={fontSize} fill="#9ca8b3" textAnchor="middle">{d.name.substring(0,mobile ? 6 : 8)}</text>
                <text x={i*barWidth+barWidth/2+5} y={height-barHeight-25} fontSize={valueFontSize} fill="#e8eef2" textAnchor="middle" fontWeight="600">{d.hours.toFixed(1)}h</text>
              </g>;
            })}
          </svg>;
        };
        
        const PieChart = ({data,size=200,colors=["#9FD4A1","#9FD4A1","#9FD4A1","#9FD4A1","#9FD4A1"]})=>{
          if(!data||data.length===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>Žádná data</div>;
          const total = data.reduce((s,d)=>s+d.hours,0);
          if(total===0) return <div style={{padding:40,textAlign:"center",color:"#6b7580"}}>Žádná data</div>;
          let currentAngle = -90;
          const center = size/2;
          const radius = size/2-20;
          return <svg width={size} height={size} style={{margin:"0 auto",display:"block"}}>
            {data.map((d,i)=>{
              const angle = (d.hours/total)*360;
              const startAngle = currentAngle;
              const endAngle = currentAngle + angle;
              currentAngle += angle;
              const x1 = center + radius*Math.cos(startAngle*Math.PI/180);
              const y1 = center + radius*Math.sin(startAngle*Math.PI/180);
              const x2 = center + radius*Math.cos(endAngle*Math.PI/180);
              const y2 = center + radius*Math.sin(endAngle*Math.PI/180);
              const largeArc = angle>180?1:0;
              return <path key={i} d={`M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={colors[i%colors.length]} opacity={0.8} stroke="#0a0e11" strokeWidth="2"/>
            })}
            <text x={center} y={center+5} fontSize="14" fill="#e8eef2" textAnchor="middle" fontWeight="600">{total.toFixed(1)}h</text>
            <text x={center} y={center+20} fontSize="11" fill="#9ca8b3" textAnchor="middle">Celkem</text>
          </svg>;
        };
        
        const isMobile = window.innerWidth <= 768;
        return (<div style={{paddingBottom:100,padding:"16px"}}>
          <h1 style={{fontSize:24,fontWeight:700,color:"#e8eef2",marginBottom:24}}>Statistiky</h1>
          <div style={{display:"grid",gridTemplateColumns:isMobile ? "1fr" : "1fr 1fr",gap:16,margin:"0 0 24px 0"}}>
            <div className="card" style={{padding:20}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
                <div style={{fontSize:16,fontWeight:600,color:"#e8eef2"}}>Hodiny per zaměstnanec</div>
                <div style={{display:"flex",gap:4}}>
                  <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11,background:chartPeriod==="week"?"rgba(178, 251, 165, 0.15)":"transparent"}} onClick={()=>setChartPeriod("week")}>Týden</button>
                  <button className="btn btn-ghost" style={{padding:"4px 8px",fontSize:11,background:chartPeriod==="month"?"rgba(178, 251, 165, 0.15)":"transparent"}} onClick={()=>setChartPeriod("month")}>Měsíc</button>
                </div>
              </div>
              <BarChart data={chartData.employees} height={isMobile ? 250 : 200} color="#9FD4A1" mobile={isMobile}/>
            </div>
            <div className="card" style={{padding:20}}>
              <div style={{fontSize:16,fontWeight:600,color:"#e8eef2",marginBottom:16}}>Rozdělení hodin</div>
              <PieChart data={chartData.jobs} size={200}/>
              <div style={{marginTop:12,display:"flex",flexDirection:"column",gap:4}}>
                {chartData.jobs.slice(0,3).map((d,i)=>(
                  <div key={i} style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#9ca8b3"}}>
                    <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"120px"}}>{d.name}</span>
                    <span style={{fontWeight:600,color:"#e8eef2"}}>{d.hours.toFixed(1)}h</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>);
      }

      ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
    </script>
  <script>
// Hide old green shortcut row "Kalendář Výkazy hodin" if it exists (we keep only the tabs bar)
document.addEventListener('DOMContentLoaded', function(){
  const anchors = Array.from(document.querySelectorAll('a'));
  const kal = anchors.find(a => a.textContent && a.textContent.trim().match(/^Kalend[aá]ř$/));
  if (kal && kal.parentElement){
    const sib = kal.parentElement.querySelector('a + a');
    const txt = sib ? sib.textContent.trim() : "";
    if (/^V[ýy]kazy\s*hodin$/i.test(txt)) {
      // Hide the whole container row
      kal.parentElement.style.display = 'none';
    }
  }
});
</script>

<script>
(function(){
  function ensureSearch(container){
    if(!container) return;
    if(container.querySelector('#globalSearch')) return;
    var form = document.createElement('form');
    form.id = 'globalSearch';
    form.className = 'tabs-search';
    form.action = '/search';
    form.method = 'GET';
    form.innerHTML = '<input type="search" name="q" placeholder="Hledat…" aria-label="Hledat"/>' +
                     '<button type="submit" class="btn small">Hledat</button>';
    container.appendChild(form);
  }
  function findTabs(){
    document.querySelectorAll('.tabs').forEach(ensureSearch);
  }
  document.addEventListener('DOMContentLoaded', function(){
    findTabs();
    var obs = new MutationObserver(findTabs);
    obs.observe(document.body, {subtree:true, childList:true});
  });
})();
</script>


<script>
// SPA deep link helper: ?tab=jobs&jobId=123 or ?tab=employees
(function(){
  function qs(name){ return new URLSearchParams(window.location.search).get(name); }
  const tab = qs('tab');
  if (tab) {
    // Try to switch initial tab by simulating click on the tab header if present
    document.addEventListener('DOMContentLoaded', () => {
      const map = {
        'jobs': 'Zakázky', 'employees': 'Zaměstnanci',
        'calendar': 'Kalendář','timesheets':'Výkazy hodin','tasks':'Úkoly','warehouse':'Sklad','users':'Uživatelé'
      };
      const label = map[tab] || null;
      if (label) {
        // try click tab with given label
        const clickTab = () => {
          const tabs = Array.from(document.querySelectorAll('.tab'));
          const t = tabs.find(el => el.textContent.trim() === label);
          if (t) t.click();
        };
        clickTab();
        // also observe in case it renders later
        const obs = new MutationObserver(clickTab);
        obs.observe(document.body, {subtree:true, childList:true});
        setTimeout(()=>obs.disconnect(), 5000);
      }
    });
  }
  const jobId = qs('jobId');
  if (jobId) {
    // After jobs list is rendered, try to open the detail of that job
    const tryOpen = () => {
      // Find card/item that contains the ID number (ID column or data-id attr)
      const selectorCandidates = [
        `[data-job-id="${jobId}"] .btn, [data-id="${jobId}"] .btn`,
        `.job-row[data-id="${jobId}"] .btn`,
        `.job-item[data-id="${jobId}"] .btn`,
        `tr:has(td:first-child:contains("${jobId}")) .btn`,
        `a[href*="detail"][data-id="${jobId}"]`, `button:contains("Otevřít detail")`
      ];
      // Basic contains polyfill for querySelectorAll
      (function(){
        function containsSelectorPolyfill(){
          // no native :contains in querySelector; we implement manual scan
          const rows = Array.from(document.querySelectorAll('tr, .job-item, .job-row, [data-job-id], [data-id]'));
          for (const el of rows) {
            if (el.dataset && (el.dataset.jobId === jobId || el.dataset.id === jobId)) {
              const btn = el.querySelector('a,button');
              if (btn) { btn.click(); return true; }
            }
            if (el.querySelector) {
              const tds = el.querySelectorAll('td,div,span');
              for (const td of tds) {
                if (td.textContent && td.textContent.trim() === jobId) {
                  const btn = el.querySelector('a,button');
                  if (btn) { btn.click(); return true; }
                }
              }
            }
          }
          // fallback: click first "Otevřít detail" on page
          const any = Array.from(document.querySelectorAll('a,button')).find(b => /Otevřít detail/i.test(b.textContent));
          if (any) { any.click(); return true; }
          return false;
        }
        window.__openJobDetailById = containsSelectorPolyfill;
      })();

      if (window.__openJobDetailById && window.__openJobDetailById()) return;
    };
    document.addEventListener('DOMContentLoaded', ()=>{
      tryOpen();
      const obs = new MutationObserver(()=>tryOpen());
      obs.observe(document.body, {subtree:true, childList:true});
      setTimeout(()=>obs.disconnect(), 5000);
    });
  }
})();
</script>


<!-- More Menu (Expandable) -->
<div id="more-menu" class="more-menu">
  <div class="more-menu-backdrop" onclick="document.getElementById('more-menu').classList.remove('show');"></div>
  <div class="more-menu-panel">
    <div class="more-menu-header">
      <div style="font-size:18px;font-weight:600;color:#e8eef2;">Navigace</div>
      <button onclick="document.getElementById('more-menu').classList.remove('show');" style="background:none;border:none;color:#9ca8b3;cursor:pointer;font-size:24px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">×</button>
    </div>
    <div class="more-menu-content">
      <a href="/" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('dashboard'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>přehled</span>
      </a>
      <a href="/calendar.html" class="more-menu-item">
        <span>kalendář</span>
      </a>
      <a href="/timesheets.html" class="more-menu-item">
        <span>výkazy hodin</span>
      </a>
      <a href="/jobs.html" class="more-menu-item">
        <span>zakázky</span>
      </a>
      <a href="/tasks.html" class="more-menu-item">
        <span>úkoly</span>
      </a>
      <a href="/employees.html" class="more-menu-item">
        <span>zaměstnanci</span>
      </a>
      <a href="/warehouse.html" class="more-menu-item">
        <span>sklad</span>
      </a>
      <a href="/finance.html" class="more-menu-item">
        <span>finance</span>
      </a>
      <a href="/documents.html" class="more-menu-item">
        <span>dokumenty</span>
      </a>
      <a href="/reports.html" class="more-menu-item">
        <span>reporty</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('archive'); } else { window.location.href='/?tab=archive'; } document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
        <span>archiv zakázek</span>
      </a>
      <a href="#" onclick="event.preventDefault(); if(window.setAppTab) { window.setAppTab('users'); } else { window.location.href='/?tab=users'; } document.getElementById('more-menu').classList.remove('show');" class="more-menu-item" id="users-menu-item" style="display:none;">
        <span>uživatelé</span>
      </a>
      <a href="/settings.html" class="more-menu-item">
        <span>nastavení</span>
      </a>
    </div>
  </div>
</div>

<script>
  // Search is now in Dashboard component (KPI stats), handled by React useEffect
    
    // Show/hide users menu item based on admin status
    function updateUsersMenu(){
      const usersItem = document.getElementById('users-menu-item');
      if(usersItem && window.appCanAdmin){
        usersItem.style.display = '';
      } else if(usersItem){
        usersItem.style.display = 'none';
      }
    }
    setInterval(updateUsersMenu, 500);
    
</script>
<div id="bottom-nav-container"></div>
<script src="/static/bottom-nav.js"></script>
<script src="/static/navigation.js"></script>

</body>
</html>
