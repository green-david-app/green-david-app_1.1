<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>green david app</title>
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/style.css">
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#eaf3ea;color:#111;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #c4d6c4;cursor:pointer}
  .tab.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
  .card{background:#1f2a22;color:#e9f5ea;border-radius:14px;border:1px solid #2f3d33;margin:10px 0}
  .card-h{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #2f3d33}
  .card-c{padding:16px}
  .kv{display:flex;gap:8px;align-items:center}
  .badge{display:inline-block;border:1px solid #8aa58a;border-radius:999px;padding:2px 8px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin:6px 0}
  .row.h{font-weight:700}
  .form-row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
  input,select,textarea{border:1px solid #3f5043;border-radius:10px;padding:10px;background:#142017;color:#e9f5ea}
  button,.ghost{border:1px solid #3f5043;border-radius:10px;padding:8px 12px;background:#2e7d32;color:#fff;cursor:pointer}
  .ghost{background:transparent;color:#e9f5ea}
  .linklike{cursor:pointer;text-decoration:underline}
  .small{font-size:12px;opacity:.85}
  table.table{width:100%;border-collapse:collapse}
  table.table th, table.table td{border-top:1px solid #2f3d33;padding:8px;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px">
    <div style="font-weight:800;font-size:22px">green david app</div>
    <div id="userbox"></div>
  </div>

  <div id="js-error" style="display:none;background:#ffcdd2;color:#111;padding:8px;border-radius:8px;margin-bottom:8px"></div>

  <div id="app"></div>
</div>

<script>
  function toCZ(v){
    if(!v) return "-";
    const m = String(v).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m){ return m[3].padStart(2,'0')+"."+m[2].padStart(2,'0')+"."+m[1]; }
    const m2 = String(v).match(/^(\d{1,2})[.\s-](\d{1,2})[.\s-](\d{4})$/);
    if(m2){ return m2[1].padStart(2,'0')+"."+m2[2].padStart(2,'0')+"."+m2[3]; }
    return v;
  }
  function toISODateFlex(v){
    if(!v) return "";
    const m = String(v).match(/^(\d{1,2})[.\s-](\d{1,2})[.\s-](\d{4})$/);
    if(m){ return m[3]+"-"+String(m[2]).padStart(2,'0')+"-"+String(m[1]).padStart(2,'0'); }
    return v; // already YYYY-MM-DD or other parsable
  }
  function showJSError(msg){
    var el = document.getElementById('js-error');
    el.style.display = 'block'; el.textContent = String(msg||'Nezn√°m√° chyba');
    console.error(msg);
  }
  window.addEventListener('error', e=> showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)));
  window.addEventListener('unhandledrejection', e=> showJSError(e.reason ? (e.reason.stack||e.reason) : e));

  async function api(path, opts={}){
    const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
    if(!res.ok){ let msg = res.statusText; try{ const j = await res.json(); msg = j.error || msg; }catch{} throw new Error(msg); }
    try{ return await res.json(); }catch{return {};}
  }
  async function refreshUserBox(){
    const box = document.getElementById("userbox");
    try{
      const j = await api("/api/me");
      if(j.authenticated){
        box.innerHTML = `P≈ôihl√°≈°en: <b>${j.user.name}</b> (${j.user.role}) ‚Ä¢ √ökoly: <b>${j.tasks_count}</b> &nbsp; <button class="ghost" id="logout-btn">Odhl√°sit</button>`;
        document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
      } else {
        box.innerHTML = '<span>Nep≈ôihl√°≈°en</span>';
      }
    }catch(e){ box.innerText = ""; }
  }
</script>

<script type="text/babel" data-presets="env,react">
const { useState, useEffect, useMemo } = React;

function Login({onLogged}){
  const [email,setEmail]=useState(""); const [pass,setPass]=useState(""); const [err,setErr]=useState("");
  async function submit(e){ e.preventDefault(); setErr(""); try{ await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})}); onLogged(); }catch(e){ setErr("≈†patn√Ω e‚Äëmail nebo heslo"); } }
  return (<div className="card" style={{maxWidth:460, margin:"40px auto"}}><div className="card-h"><div>P≈ôihl√°≈°en√≠</div></div><div className="card-c">
    <form onSubmit={submit}><div className="form-row"><input type="email" placeholder="E‚Äëmail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/></div>
    <div className="form-row"><input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/></div>
    {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}
    <div className="form-row" style={{justifyContent:"flex-end"}}><button type="submit">P≈ôihl√°sit</button></div>
    <div className="small">V√Ωchoz√≠ admin: <b>admin@greendavid.local</b> / <b>admin123</b>.</div></form></div></div>);
}

function Tabs({value,onChange,canAdmin,taskCount}){
  const items = [
    {key:"calendar",label:"Kalend√°≈ô",href:"/calendar.html"},
    {key:"timesheets",label:"V√Ωkazy hodin",href:"/timesheets.html"},
    {key:"jobs",label:"Zak√°zky"},
    {key:"tasks",label:"√ökoly"},
    {key:"employees",label:"Zamƒõstnanci"},
    {key:"warehouse",label:"Sklad"},
    ...(canAdmin ? [{key:"users",label:"U≈æivatel√©"}] : [])
  ];
  return <div className="tabs">
    {items.map(it => (
      it.href
        ? <a key={it.key} className={"tab"+(value===it.key?" active":"")} href={it.href}>{it.label}</a>
        : <div key={it.key} className={"tab"+(value===it.key?" active":"")} onClick={()=>onChange(it.key)}>{it.label}</div>
    ))}
  </div>;
}

function JobsList({onOpen}){
  const [list,setList]=useState([]);
  const [form,setForm]=useState({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""});
  const [err,setErr]=useState("");
  async function load(){ try{ const j=await api("/api/jobs"); setList(j.jobs||[]); }catch(e){ setErr(e.message);} }
  useEffect(()=>{ load().catch(()=>{}); },[]);
  async function add(e){ e.preventDefault(); try{ const payload={...form, date: toISODateFlex(form.date)}; await api("/api/jobs",{method:"POST",body:JSON.stringify(payload)}); setForm({title:"",client:"",status:"Pl√°n",city:"",code:"",date:"",note:""}); load(); }catch(e){ setErr(e.message || String(e)); } }
  async function del(id){ if(!confirm("Smazat zak√°zku?")) return; await api("/api/jobs?id="+id,{method:"DELETE"}); load(); }
  return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
    <div className="card"><div className="card-h"><div>Nov√° zak√°zka</div></div><div className="card-c">
      <form onSubmit={add}><div className="form-row">
        <input placeholder="N√°zev" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} style={{flex:2}} required/>
        <input placeholder="Z√°kazn√≠k" value={form.client} onChange={e=>setForm({...form,client:e.target.value})} style={{flex:2}} required/>
        <select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}><option>Pl√°n</option><option>Prob√≠h√°</option><option>Dokonƒçeno</option></select>
      </div><div className="form-row">
        <input placeholder="Mƒõsto" value={form.city} onChange={e=>setForm({...form,city:e.target.value})} required/>
        <input placeholder="K√≥d (nap≈ô. 2025-091)" value={form.code} onChange={e=>setForm({...form,code:e.target.value})} required/>
        <input type="text" placeholder="DD.MM.RRRR" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
      </div><div className="form-row">
        <input placeholder="Pozn√°mka" value={form.note} onChange={e=>setForm({...form,note:e.target.value})} style={{flex:1}}/>
        <button type="submit">P≈ôidat</button>
      </div></form>{err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}</div></div>
      {list.map(z=> (<div className="card" key={z.id}>
        <div className="card-h">
          <div><div style={{fontWeight:700}}><span className="linklike" onClick={()=> onOpen(z.id)}>{z.title}</span></div><div className="small">{z.client} ‚Ä¢ {z.city} ‚Ä¢ {z.code}</div></div>
          <span className="badge">{z.status}</span>
        </div>
        <div className="card-c">
          <div className="kv small"><span>üìÖ</span> <span>{toCZ(z.date)}</span></div>
          <div style={{marginTop:12, display:"flex", gap:8}}>
            <button onClick={()=> onOpen(z.id)}>Otev≈ô√≠t detail</button>
            <a className="ghost" href={`/job_edit.html?id=${z.id}`}>Upravit</a>
            <button className="ghost" onClick={()=> del(z.id)}>Smazat</button>
          </div>
        </div>
      </div>))}
      {list.length===0 && <div className="card"><div className="card-c small">Zat√≠m ≈æ√°dn√© zak√°zky ‚Äì p≈ôidej prvn√≠ v√Ω≈°e.</div></div>}
    </div>);
}

function JobTasks({jobId}){ return null; } // placeholder (nezmƒõnƒõno)
function JobHours({jobId}){ return null; } // placeholder (nezmƒõnƒõno)

function JobDetail({jobId,onBack}){
  const [data,setData]=useState(null); const [employees,setEmployees]=useState([]); const [selEmp,setSelEmp]=useState([]);
  const [mat,setMat]=useState({name:"",qty:0,unit:"ks"}); const [tool,setTool]=useState({name:"",qty:0,unit:"ks"});
  const [err,setErr]=useState("");
  async function load(){ try{ const [d, e] = await Promise.all([api(`/api/jobs/${jobId}`), api("/api/employees")]); setData(d); setEmployees(e.employees||[]); setSelEmp(d.assignments||[]);}catch(e){ setErr(e.message);} }
  useEffect(()=>{ load().catch(()=>{}); },[jobId]);
  if(!data) return <div className="small">Naƒç√≠t√°m‚Ä¶</div>;
  const j = data.job;
  return (<div className="grid" style={{gridTemplateColumns:"1fr"}}>
    <div style={{display:"flex", gap:8, alignItems:"center"}}>
      <button className="ghost" onClick={onBack}>‚Üê Zpƒõt na seznam</button>
      <a className="ghost" href={`/job_edit.html?id=${jobId}`}>Upravit</a>
    </div>
    <div className="card"><div className="card-h"><div><div style={{fontWeight:800,fontSize:18}}>{j.title}</div><div className="small">{j.client} ‚Ä¢ {j.city} ‚Ä¢ {j.code}</div></div><span className="badge">{j.status}</span></div>
      <div className="card-c"><div className="kv small"><span>üìÖ</span> <span>{toCZ(j.date)}</span></div>{j.note && <div className="small" style={{marginTop:8}}>{j.note}</div>}</div></div>
  </div>);
}

function App(){
  const [tab,setTab]=useState("jobs");
  const [auth,setAuth]=useState(false);
  const [detailId,setDetailId]=useState(null);
  useEffect(()=>{ refreshUserBox(); async function check(){ try{ const j = await api("/api/me"); setAuth(j.authenticated); }catch{} } check(); },[]);
  if(!auth) return <Login onLogged={()=>location.reload()}/>;
  return (<div>
    <Tabs value={tab} onChange={setTab} canAdmin={true}/>
    {tab==="jobs" && (detailId ? <JobDetail jobId={detailId} onBack={()=>setDetailId(null)}/> : <JobsList onOpen={setDetailId}/>)}
  </div>);
}

ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
</script>
</body>
</html>
