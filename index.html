
<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>green david app</title>
    <link rel="stylesheet" href="/style.css"/>
    <style>
      /* Bottom dock for the login box (#userbox) – non-destructive */
      #userbox-dock{ display:flex; justify-content:center; margin:12px 0 0 0; }
      #userbox{
        background:#1f262b; color:#eaf6ef;
        border:1px solid #445058; border-radius:14px;
        padding:8px 12px; display:inline-flex; gap:10px; align-items:center;
      }
      #userbox .ghost, #userbox button, #userbox a{
        background:transparent; color:#eaf6ef; border:1px solid #607d8b55;
        border-radius:10px; padding:6px 10px; text-decoration:none; cursor:pointer;
      }
      @media (max-width:560px){
        #userbox-dock{ padding:0 12px; }
        #userbox{ width:100%; justify-content:space-between; flex-wrap:wrap; row-gap:6px; }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="brand">
        <img src="/logo.jpg" alt="Green David" class="brand-logo" onerror="this.src='/logo.svg'"/>
        <div>
          <div class="brand-title">green david app</div>
          <div class="brand-sub">interní systém</div>
        </div>
        <div class="right small" id="userbox"></div>
      </div>
    </header>

    <div class="container" style="margin-top:.5rem">
      <div class="row-gap" style="justify-content:flex-start">

      </div>
    </div>

    <main class="container">
      <div id="app"></div>
      <div id="js-error" class="error-overlay" style="display:none"></div>
      <p class="small footer">© green david s.r.o.</p>
      <!-- userbox will be moved here by the script below -->
      <div id="userbox-dock" aria-hidden="true" style="display:none"></div>
    </main>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>

      function toISODateFlex(v){
        if(!v) return v;
        // Remove everything except digits
        const d = String(v).replace(/\D+/g, '');
        if(d.length !== 8) return v; // keep original if not 8 digits
        // Decide if it's YYYYMMDD or DDMMYYYY
        const yFirst = parseInt(d.slice(0,4),10);
        let y,m,day;
        if(yFirst >= 1900 && yFirst <= 2100){
          y = yFirst; m = parseInt(d.slice(4,6),10); day = parseInt(d.slice(6,8),10);
        } else {
          day = parseInt(d.slice(0,2),10); m = parseInt(d.slice(2,4),10); y = parseInt(d.slice(4,8),10);
        }
        if(!(y && m && day)) return v;
        const pad = (n)=> String(n).padStart(2,'0');
        return `${y}-${pad(m)}-${pad(day)}`;
      }
      function toCZ(iso){
        if(!iso) return iso||'';
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return iso;
        const [_,y,mm,dd] = m;
        return `${dd}.${mm}.${y}`;
      }

      function normalizeDate(v){
        if(!v) return v;
        // Accept 15.09.2025 or 15. 09. 2025 etc.
        var m=v.match(/^(\d{1,2})[\.\s-](\d{1,2})[\.\s-](\d{4})$/);
        if(m){
          var d=m[1].padStart(2,'0'); var M=m[2].padStart(2,'0'); var y=m[3];
          return y+"-"+M+"-"+d;
        }
        return v; // already YYYY-MM-DD
      }
      function showJSError(msg){
        var el = document.getElementById('js-error');
        el.style.display = 'block';
        el.textContent = String(msg || 'Neznámá chyba ve skriptu.');
        console.error(msg);
      }
      window.addEventListener('error', function(e){ showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)); });
      window.addEventListener('unhandledrejection', function(e){ showJSError(e.reason ? (e.reason.stack||e.reason) : e); });
      async function api(path, opts={}){
        const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
        if(!res.ok){ let msg = res.statusText; try{ const j = await res.json(); msg = j.error || msg; }catch{} throw new Error(msg); }
        try{ return await res.json(); }catch{return {};}
      }
      async function refreshUserBox(){
        const box = document.getElementById("userbox");
        try{
          const j = await api("/api/me");
          if(j.authenticated){
            box.innerHTML = `Přihlášen: <b>${j.user.name}</b> (${j.user.role}) • Úkoly: <b>${j.tasks_count}</b> &nbsp; <button class="ghost" id="logout-btn">Odhlásit</button>`;
            document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
          } else {
            box.innerHTML = '<span>Nepřihlášen</span>';
          }
        }catch(e){ box.innerText = ""; }
      }

      // === Move userbox under the footer ===
      (function(){
        function dockUserBox(){
          var box = document.getElementById('userbox');
          var dock = document.getElementById('userbox-dock');
          var footer = document.querySelector('main .footer');
          if(!box || !dock || !footer) return;
          if(dock.contains(box)) return;
          dock.style.display = 'flex';
          footer.parentNode.insertBefore(dock, footer.nextSibling);
          dock.appendChild(box);
        }
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', dockUserBox);
        } else {
          dockUserBox();
        }
      })();
    </script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      function Login({onLogged}){
        const [email,setEmail]=useState(""); const [pass,setPass]=useState(""); const [err,setErr]=useState("");
        async function submit(e){ e.preventDefault(); setErr(""); try{ await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})}); onLogged(); }catch(e){ setErr("Špatný e‑mail nebo heslo"); } }
        return (<div className="card" style={{maxWidth:460, margin:"40px auto"}}><div className="card-h"><div>Přihlášení</div></div><div className="card-c">
          <form onSubmit={submit}><div className="form-row"><input type="email" placeholder="E‑mail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/></div>
          <div className="form-row"><input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/></div>
          {err && <div className="small" style={{color:"#ffbcbc"}}>{err}</div>}<div className="form-row" style={{justifyContent:"flex-end"}}><button type="submit">Přihlásit</button></div>
          <div className="small">Výchozí admin: <b>admin@greendavid.local</b> / <b>admin123</b>.</div></form></div></div>);
      }

      function Tabs({value,onChange,canAdmin,taskCount}){
  const items = [
    {key:"calendar",label:"Kalendář",href:"/calendar.html"},
    {key:"timesheets",label:"Výkazy hodin",href:"/timesheets.html"},
    {key:"jobs",label:"Zakázky"},
    {key:"tasks",label:"Úkoly"},
    {key:"employees",label:"Zaměstnanci"},
    {key:"warehouse",label:"Sklad"},
    ...(canAdmin ? [{key:"users",label:"Uživatelé"}] : [])
  ];
  return <div className="tabs">
    {items.map(it => (
      it.href
        ? <a key={it.key} className={"tab"+(value===it.key?" active":"")} href={it.href}>{it.label}</a>
        : <div key={it.key} className={"tab"+(value===it.key?" active":"")} onClick={()=>onChange(it.key)}>{it.label}</div>
    ))}
  </div>;
}
      // ... (rest of your React components unchanged)
    </script>
  </body>
</html>
