{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timesheets.css') }}">
{% endblock %}
{% block content %}

<div class="gd-dark cell pad">
  <!-- breadcrumbs removed -->
  <div class="title-row">
    <a href="/dashboard" class="btn ghost">â† ZpÄ›t na hlavnÃ­</a>
    <h1>VÃ½kazy hodin â€” tÃ½den</h1>
  </div>

  <div class="week-toolbar">
    <label>TÃ½den od <input id="weekStart" type="date"/></label>
    <button id="prevWeek" class="ghost">â† PÅ™edchozÃ­</button>
    <button id="nextWeek" class="ghost">NÃ¡sledujÃ­cÃ­ â†’</button>
    <span id="weekLabel" class="smallmuted"></span>
    <div class="spacer"></div>
    <label>Filtrovat zakÃ¡zku <select id="filterJob"><option value="">VÅ¡e</option></select></label>
    <label>Filtrovat zamÄ›stnance <select id="filterEmployee"><option value="">VÅ¡ichni</option></select></label>
    <button id="exportCsv">Export CSV (tÃ½den)</button>
  </div>
</div>

<div class="lanes-wrap">
  <div id="lanes" class="week-lanes"></div>
</div>

<div id="modal" class="modal-backdrop" style="display:none;">
  <div class="card modal-card">
    <div class="card-h"><div id="modalTitle">NovÃ½ zÃ¡znam</div></div>
    <div class="card-c form-grid">
      <label>ZamÄ›stnanec <select id="fEmployee"></select></label>
      <label>ZakÃ¡zka <select id="fJob"></select></label>
      <label>Datum <input id="fDate" type="date"/></label>
      <label>Hodin <input id="fHours" type="number" min="0" step="0.25" placeholder="8"/></label>
      <label>MÃ­sto <input id="fPlace" type="text"/></label>
      <label class="span2">ÄŒinnost <textarea id="fActivity" rows="2"></textarea></label>
    </div>
    <div class="card-f actions">
      <button id="btnDelete" class="ghost" style="display:none;">Smazat</button>
      <button id="btnCancel" class="ghost">ZruÅ¡it</button>
      <button id="btnSave">UloÅ¾it</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
function toISO(d){ const z = new Date(d.getTime() - d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
function fromISO(s){ const [y,m,d]=s.split('-').map(Number); const dt = new Date(Date.UTC(y,m-1,d)); return new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate()); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function mondayOf(d){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }

let weekStart = mondayOf(new Date());
let rows=[], employees=[], jobs=[];
let modalState={mode:"new", id:null};

function updateWeekControls(){
  $("#weekStart").value = toISO(weekStart);
  $("#weekLabel").textContent = `(Po ${toISO(weekStart)} â€” Ne ${toISO(addDays(weekStart,6))})`;
}
$("#weekStart").addEventListener("change", e=>{ weekStart = fromISO(e.target.value); updateWeekControls(); loadAll(); });
$("#prevWeek").addEventListener("click", ()=>{ weekStart = addDays(weekStart,-7); updateWeekControls(); loadAll(); });
$("#nextWeek").addEventListener("click", ()=>{ weekStart = addDays(weekStart, 7); updateWeekControls(); loadAll(); });

function api(url,opts){ return fetch(url,opts).then(r=>r.json()); }

function renderEntries(){
  const lanes = $("#lanes"); lanes.innerHTML="";
  const byDay=[0,1,2,3,4,5,6].map(i=>({date: toISO(addDays(weekStart,i)), items: []}));
  for(const r of rows){ const idx = Math.floor((new Date(r.date)-weekStart)/86400000); if(idx>=0 && idx<7) byDay[idx].items.push(r); }
  for(const d of byDay){
    const wrap = document.createElement("div"); wrap.className="lane lane-dark";
    wrap.innerHTML = `<div class="lane-head"><div class="title">${d.date}</div></div><div class="lane-body"></div><div class="add-row"><button class="add-pill" data-date="${d.date}">+ PÅ™idat zÃ¡znam</button></div>`;
    const body = wrap.querySelector(".lane-body");
    for(const r of d.items){
      const pill = document.createElement("div"); pill.className="entry-pill";
      pill.innerHTML = `<div class="entry-main"><div class="entry-name">${r.employee_name||r.employee_id}</div>${r.place?`<div class="entry-place">ğŸ“ ${r.place}</div>`:""}<div class="entry-hours">${r.hours} h</div>${r.activity?`<div class="entry-activity">${r.activity}</div>`:""}</div><div class="entry-actions"><button class="ghost" data-edit="${r.id}" title="Upravit">âœï¸</button></div>`;
      body.appendChild(pill);
    }
    lanes.appendChild(wrap);
  }
  lanes.querySelectorAll("[data-date]").forEach(btn=>btn.addEventListener("click", ()=>openModal("new",{date:btn.getAttribute("data-date")})));
  lanes.querySelectorAll("[data-edit]").forEach(btn=>btn.addEventListener("click", ()=>{
    const id=Number(btn.getAttribute("data-edit")); const r=rows.find(x=>x.id===id); if(r) openModal("edit", r);
  }));
}

function fillSelect(el, items, idKey, labelKey){ el.innerHTML=""; for(const it of items){ const opt=document.createElement("option"); opt.value=it[idKey]; opt.textContent=it[labelKey]; el.appendChild(opt);} }

async function loadAll(){
  const ws = toISO(weekStart), we = toISO(addDays(weekStart,6));
  const [emps, js, ts] = await Promise.all([ api("/gd/api/employees"), api("/gd/api/jobs"), api(`/gd/api/timesheets?from=${ws}&to=${we}`) ]);
  employees = (emps.employees||[]).sort((a,b)=>String(a.name).localeCompare(b.name));
  jobs = (js.jobs||[]).sort((a,b)=>String(a.title).localeCompare(b.title));
  rows = ts.rows || [];

  fillSelect($("#fEmployee"), employees, "id", "name");
  fillSelect($("#fJob"), jobs, "id", "title");
  renderEntries();
}

function openModal(mode, data){
  modalState = {mode, id:data?.id||null};
  $("#modalTitle").innerText = mode==="edit" ? "Upravit zÃ¡znam" : "NovÃ½ zÃ¡znam";
  $("#btnDelete").style.display = mode==="edit" ? "" : "none";
  if(mode==="edit"){
    $("#fEmployee").value = String(data.employee_id);
    $("#fJob").value = String(data.job_id);
    $("#fDate").value = data.date;
    $("#fHours").value = data.hours;
    $("#fPlace").value = data.place || "";
    $("#fActivity").value = data.activity || "";
  }else{
    $("#fEmployee").value = "";
    $("#fJob").value = "";
    $("#fDate").value = data?.date || toISO(new Date());
    $("#fHours").value = "";
    $("#fPlace").value = "";
    $("#fActivity").value = "";
  }
  $("#modal").style.display = "flex";
}
function closeModal(){ $("#modal").style.display="none"; }

async function saveModal(){
  const payload = {
    employee_id: Number($("#fEmployee").value),
    job_id: Number($("#fJob").value),
    date: $("#fDate").value,
    hours: Number($("#fHours").value || 0),
    place: $("#fPlace").value || "",
    activity: $("#fActivity").value || ""
  };
  if(modalState.mode==="edit"){
    payload.id = modalState.id;
    await fetch("/gd/api/timesheets", {method:"PATCH", headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }else{
    await fetch("/gd/api/timesheets", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }
  closeModal(); await loadAll();
}
async function deleteModal(){
  if(!confirm("Smazat zÃ¡znam?")) return;
  await fetch("/gd/api/timesheets?id="+modalState.id, {method:"DELETE"});
  closeModal(); await loadAll();
}

(function(){ updateWeekControls(); loadAll().catch(()=>{}); })();
</script>
{% endblock %}
