<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Reporty - green david app</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <link rel="stylesheet" href="/static/css/app.css"/>
  <link rel="stylesheet" href="/static/css/glass-design.css"/>
  <link rel="stylesheet" href="/static/css/tasks-design-system.css"/>
  <script src="/app-settings.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg-dark: #1a1d1f;
      --bg-card: rgba(17, 24, 39, 0.8);
      --border: rgba(255,255,255,0.08);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --mint: #4ade80;
      --blue: #60a5fa;
      --purple: #a78bfa;
      --yellow: #facc15;
      --orange: #fb923c;
      --red: #ef4444;
    }

    body { 
      background: var(--bg-dark); 
      color: var(--text-primary); 
      min-height: 100vh; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .reports-container { max-width: 1400px; margin: 0 auto; padding: 20px 24px 120px; }

    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .page-header h1 { display: flex; align-items: center; gap: 16px; font-size: 28px; font-weight: 700; margin: 0; }

    .page-icon {
      width: 52px; height: 52px; border-radius: 16px; display: flex; align-items: center; justify-content: center; position: relative;
      background: linear-gradient(145deg, rgba(74,222,128,0.35) 0%, rgba(74,222,128,0.15) 100%);
      box-shadow: 0 6px 20px rgba(0,0,0,0.35), inset 0 2px 4px rgba(255,255,255,0.20), inset 0 -2px 4px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .page-icon::before { content: ''; position: absolute; top: 4px; left: 10px; right: 10px; height: 40%; background: linear-gradient(180deg, rgba(255,255,255,0.45) 0%, transparent 100%); border-radius: 12px 12px 6px 6px; }
    .page-icon svg { width: 26px; height: 26px; stroke: #4ade80; stroke-width: 1.8; fill: none; position: relative; z-index: 1; }

    .btn-scheduled { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(96,165,250,0.15); border: 1px solid rgba(96,165,250,0.3); border-radius: 10px; color: #60a5fa; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-scheduled:hover { background: rgba(96,165,250,0.25); transform: translateY(-2px); }
    .btn-scheduled svg { width: 18px; height: 18px; stroke: currentColor; fill: none; }

    .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 18px; display: flex; align-items: center; gap: 14px; }
    .stat-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .stat-icon.green { background: rgba(74,222,128,0.15); }
    .stat-icon.green svg { stroke: #4ade80; }
    .stat-icon.blue { background: rgba(96,165,250,0.15); }
    .stat-icon.blue svg { stroke: #60a5fa; }
    .stat-icon.purple { background: rgba(167,139,250,0.15); }
    .stat-icon.purple svg { stroke: #a78bfa; }
    .stat-icon.yellow { background: rgba(250,204,21,0.15); }
    .stat-icon.yellow svg { stroke: #facc15; }
    .stat-icon svg { width: 22px; height: 22px; stroke-width: 1.8; fill: none; }
    .stat-info .value { font-size: 22px; font-weight: 700; }
    .stat-info .label { font-size: 12px; color: var(--text-secondary); }

    .report-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 40px; }

    .report-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
      border: 1px solid rgba(255,255,255,0.08); border-top-color: rgba(255,255,255,0.15);
      border-radius: 20px; padding: 28px; cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative; overflow: hidden;
    }
    .report-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent-color), transparent); opacity: 0; transition: opacity 0.3s; }
    .report-card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 40px var(--glow-color); border-color: var(--accent-color); }
    .report-card:hover::before { opacity: 1; }
    .report-card:focus { outline: none; box-shadow: 0 0 0 3px rgba(74,222,128,0.4); }
    .report-card.weekly { --accent-color: #4ade80; --glow-color: rgba(74,222,128,0.15); }
    .report-card.monthly { --accent-color: #60a5fa; --glow-color: rgba(96,165,250,0.15); }
    .report-card.project { --accent-color: #a78bfa; --glow-color: rgba(167,139,250,0.15); }
    .report-card.custom { --accent-color: #facc15; --glow-color: rgba(250,204,21,0.15); }

    .report-card-header { display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px; }
    .report-card-icon {
      width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      position: relative; flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.15), inset 0 -2px 4px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .report-card-icon::before { content: ''; position: absolute; top: 3px; left: 8px; right: 8px; height: 40%; background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%); border-radius: 10px 10px 4px 4px; }
    .report-card-icon svg { width: 26px; height: 26px; stroke-width: 1.8; fill: none; position: relative; z-index: 1; }
    .report-card.weekly .report-card-icon { background: linear-gradient(145deg, rgba(74,222,128,0.35) 0%, rgba(74,222,128,0.15) 100%); }
    .report-card.weekly .report-card-icon svg { stroke: #4ade80; }
    .report-card.monthly .report-card-icon { background: linear-gradient(145deg, rgba(96,165,250,0.35) 0%, rgba(96,165,250,0.15) 100%); }
    .report-card.monthly .report-card-icon svg { stroke: #60a5fa; }
    .report-card.project .report-card-icon { background: linear-gradient(145deg, rgba(167,139,250,0.35) 0%, rgba(167,139,250,0.15) 100%); }
    .report-card.project .report-card-icon svg { stroke: #a78bfa; }
    .report-card.custom .report-card-icon { background: linear-gradient(145deg, rgba(250,204,21,0.35) 0%, rgba(250,204,21,0.15) 100%); }
    .report-card.custom .report-card-icon svg { stroke: #facc15; }
    .report-card-info h3 { font-size: 20px; font-weight: 600; margin: 0 0 6px 0; }
    .report-card-info p { font-size: 14px; color: var(--text-secondary); margin: 0; }
    .report-card-features { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
    .feature-tag { display: flex; align-items: center; gap: 4px; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 12px; color: var(--text-secondary); }
    .feature-tag svg { width: 12px; height: 12px; stroke: var(--accent-color); fill: none; }

    /* Generator Modal */
    .generator-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; overflow-y: auto; padding: 40px 20px; }
    .generator-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
    .generator-modal { background: linear-gradient(145deg, rgba(17,24,39,0.98) 0%, rgba(10,15,26,0.98) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; width: 100%; max-width: 900px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); animation: modalSlideIn 0.3s ease; }
    @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .generator-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 28px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .generator-header h2 { font-size: 22px; font-weight: 600; margin: 0; }
    .btn-close { width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .btn-close:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #ef4444; }

    .generator-body { padding: 28px; max-height: 60vh; overflow-y: auto; }
    .form-section { margin-bottom: 28px; }
    .form-section-title { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
    .form-section-title svg { width: 16px; height: 16px; stroke: var(--mint); fill: none; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 14px; transition: all 0.2s; box-sizing: border-box; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--mint); box-shadow: 0 0 0 3px rgba(74,222,128,0.15); }

    /* Selectable Cards */
    .selectable-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    
    .selectable-card {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 16px; 
      background: rgba(255,255,255,0.03); 
      border: 2px solid rgba(255,255,255,0.06); 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.2s ease;
      user-select: none;
    }
    .selectable-card:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }
    .selectable-card:focus { outline: none; box-shadow: 0 0 0 3px rgba(74,222,128,0.3); }
    .selectable-card[aria-checked="true"] { background: rgba(74,222,128,0.08); border-color: rgba(74,222,128,0.4); }
    
    .card-checkbox {
      width: 22px; height: 22px; 
      border-radius: 6px; 
      border: 2px solid rgba(255,255,255,0.25); 
      display: flex; align-items: center; justify-content: center; 
      flex-shrink: 0;
      transition: all 0.2s;
      margin-top: 2px;
    }
    .selectable-card[aria-checked="true"] .card-checkbox { background: var(--mint); border-color: var(--mint); }
    .card-checkbox svg { width: 14px; height: 14px; stroke: #0a0f1a; stroke-width: 3; opacity: 0; transform: scale(0.5); transition: all 0.15s; fill: none; }
    .selectable-card[aria-checked="true"] .card-checkbox svg { opacity: 1; transform: scale(1); }
    
    .card-content { flex: 1; min-width: 0; }
    .card-title { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 4px; }
    .card-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }

    /* Export Format Cards */
    .export-formats { display: flex; gap: 12px; flex-wrap: wrap; }
    .export-format { 
      display: flex; align-items: center; gap: 12px; 
      padding: 16px 20px; 
      background: rgba(255,255,255,0.03); 
      border: 2px solid rgba(255,255,255,0.08); 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.2s; 
      min-width: 140px;
      user-select: none;
    }
    .export-format:hover { background: rgba(255,255,255,0.06); transform: translateY(-2px); }
    .export-format:focus { outline: none; box-shadow: 0 0 0 3px rgba(74,222,128,0.3); }
    .export-format[aria-checked="true"] { border-color: var(--mint); background: rgba(74,222,128,0.1); }
    .export-format-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .export-format-icon.pdf { background: rgba(239,68,68,0.2); }
    .export-format-icon.pdf svg { stroke: #ef4444; }
    .export-format-icon.xlsx { background: rgba(74,222,128,0.2); }
    .export-format-icon.xlsx svg { stroke: #4ade80; }
    .export-format-icon.docx { background: rgba(96,165,250,0.2); }
    .export-format-icon.docx svg { stroke: #60a5fa; }
    .export-format-icon svg { width: 20px; height: 20px; stroke-width: 1.8; fill: none; }
    .export-format-label { font-size: 15px; font-weight: 500; }

    .generator-footer { display: flex; justify-content: space-between; align-items: center; padding: 20px 28px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); border-radius: 0 0 24px 24px; gap: 12px; flex-wrap: wrap; }
    .btn-secondary { display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-primary { display: flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); border: none; border-radius: 10px; color: #0a0f1a; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(74,222,128,0.3); }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(74,222,128,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-primary svg, .btn-secondary svg { width: 18px; height: 18px; fill: none; }
    
    .btn-primary .spinner { display: none; width: 18px; height: 18px; border: 2px solid rgba(10,15,26,0.3); border-top-color: #0a0f1a; border-radius: 50%; animation: spin 0.8s linear infinite; }
    .btn-primary.loading .spinner { display: block; }
    .btn-primary.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Result Modal */
    .result-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto; padding: 40px 20px; }
    .result-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
    .result-modal { background: #111827; border-radius: 20px; width: 100%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
    .result-header { padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .result-header h2 { margin: 0; font-size: 20px; }
    .result-header small { color: var(--text-secondary); font-size: 13px; display: block; margin-top: 4px; }
    .result-body { flex: 1; overflow-y: auto; padding: 24px; }
    .result-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap; flex-shrink: 0; }
    
    .result-section { margin-bottom: 24px; }
    .result-section h4 { color: var(--mint); font-size: 15px; font-weight: 600; margin: 0 0 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .result-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
    .result-stat { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 14px; text-align: center; }
    .result-stat-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .result-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
    .result-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .result-table th { padding: 10px 12px; text-align: left; color: var(--text-secondary); font-weight: 500; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .result-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .result-empty { text-align: center; padding: 40px; color: var(--text-secondary); }
    .result-info { background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.2); border-radius: 8px; padding: 12px 16px; color: #60a5fa; font-size: 13px; }

    @media (max-width: 768px) {
      .reports-container { padding: 20px 16px 120px; }
      .report-types { grid-template-columns: 1fr; }
      .selectable-cards { grid-template-columns: 1fr; }
      .export-formats { flex-direction: column; }
      .generator-footer { flex-direction: column; }
      .generator-footer > * { width: 100%; justify-content: center; }
    }
  </style>
    <link rel="stylesheet" href="/static/css/glass-design.css"/>
    <link rel="stylesheet" href="/static/css/sidebar.css"/>
    <link rel="stylesheet" href="/static/css/responsive.css"/>
</head>
<body class="has-sidebar">
  <div id="app-header"></div>

  <div class="reports-container">
    <div class="page-header" style="justify-content:flex-end;">
      <button class="btn-scheduled" onclick="alert('Plánované reporty - připravujeme')">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Plánované reporty
      </button>
    </div>

    <div class="quick-stats" id="quickStats">
      <div class="stat-card"><div class="stat-icon green"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="stat-info"><div class="value">-</div><div class="label">Reportů celkem</div></div></div>
      <div class="stat-card"><div class="stat-icon blue"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><div class="stat-info"><div class="value">-</div><div class="label">Tento měsíc</div></div></div>
      <div class="stat-card"><div class="stat-icon purple"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="stat-info"><div class="value">-</div><div class="label">Naplánovaných</div></div></div>
      <div class="stat-card"><div class="stat-icon yellow"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div><div class="stat-info"><div class="value">-</div><div class="label">Stažení</div></div></div>
    </div>

    <div class="report-types">
      <div class="report-card weekly" onclick="openGenerator('weekly')" tabindex="0" role="button">
        <div class="report-card-header">
          <div class="report-card-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
          <div class="report-card-info"><h3>Týdenní report</h3><p>Kompletní přehled za týden</p></div>
        </div>
        <div class="report-card-features">
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Hodiny</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Projekty</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Úkoly</span>
        </div>
      </div>
      <div class="report-card monthly" onclick="openGenerator('monthly')" tabindex="0" role="button">
        <div class="report-card-header">
          <div class="report-card-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
          <div class="report-card-info"><h3>Měsíční report</h3><p>Finanční přehled a produktivita</p></div>
        </div>
        <div class="report-card-features">
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Finance</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Produktivita</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Srovnání</span>
        </div>
      </div>
      <div class="report-card project" onclick="openGenerator('project')" tabindex="0" role="button">
        <div class="report-card-header">
          <div class="report-card-icon"><svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 12l2 2 4-4"/></svg></div>
          <div class="report-card-info"><h3>Projektový report</h3><p>Detailní analýza projektu</p></div>
        </div>
        <div class="report-card-features">
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Timeline</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Náklady</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Ziskovost</span>
        </div>
      </div>
      <div class="report-card custom" onclick="openGenerator('custom')" tabindex="0" role="button">
        <div class="report-card-header">
          <div class="report-card-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-2.82 1.18V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-2.51-1.18l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0-1.18-2.82H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 2.82-1.18V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 2.51 1.18l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0 1.18 2.82H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
          <div class="report-card-info"><h3>Vlastní report</h3><p>Kompletně na míru</p></div>
        </div>
        <div class="report-card-features">
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Vše volitelné</span>
          <span class="feature-tag"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Šablony</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Generator Modal -->
  <div class="generator-overlay" id="generatorOverlay">
    <div class="generator-modal">
      <div class="generator-header">
        <h2 id="generatorTitle">Týdenní report</h2>
        <button class="btn-close" onclick="closeGenerator()" aria-label="Zavřít">
          <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="generator-body">
        <div class="form-section">
          <div class="form-section-title"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Období</div>
          <div class="form-row">
            <div class="form-group"><label>Datum od</label><input type="date" id="dateFrom"></div>
            <div class="form-group"><label>Datum do</label><input type="date" id="dateTo"></div>
            <div class="form-group" id="projectSelectGroup" style="display:none;"><label>Projekt</label><select id="projectSelect"><option value="">Vyberte projekt</option></select></div>
          </div>
        </div>
        <div class="form-section" id="filtersSection">
          <div class="form-section-title"><svg viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Filtry (volitelné)</div>
          <div class="form-row">
            <div class="form-group" id="employeesFilterGroup">
              <label>Zaměstnanci <small style="color:var(--text-secondary);font-weight:normal;">(prázdné = všichni)</small></label>
              <select id="employeesFilter" multiple style="min-height:80px;"></select>
            </div>
            <div class="form-group" id="jobsFilterGroup">
              <label>Zakázky <small style="color:var(--text-secondary);font-weight:normal;">(prázdné = všechny)</small></label>
              <select id="jobsFilter" multiple style="min-height:80px;"></select>
            </div>
          </div>
        </div>
        <div class="form-section">
          <div class="form-section-title"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Obsah reportu</div>
          <div class="selectable-cards" id="contentSections"></div>
        </div>
        <div class="form-section">
          <div class="form-section-title"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Podrobnosti dat</div>
          <div class="selectable-cards" id="dataDetails"></div>
        </div>
        <div class="form-section">
          <div class="form-section-title"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Vizuální prvky</div>
          <div class="selectable-cards" id="visualElements"></div>
        </div>
        <div class="form-section">
          <div class="form-section-title"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Formát exportu</div>
          <div class="export-formats" id="exportFormats" role="radiogroup"></div>
        </div>
        <div class="form-section">
          <div class="form-group" style="margin-bottom:0;"><label>Poznámka (volitelné)</label><textarea id="reportNote" placeholder="Dodatečné poznámky k reportu..." rows="3" style="resize:vertical;"></textarea></div>
        </div>
      </div>
      <div class="generator-footer">
        <button class="btn-secondary" onclick="closeGenerator()"><svg viewBox="0 0 24 24" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>Zrušit</button>
        <button class="btn-primary" id="generateBtn" onclick="generateReport()"><span class="spinner"></span><span class="btn-text"><svg viewBox="0 0 24 24" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Generovat report</span></button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-modal">
      <div class="result-header">
        <div><h2 id="resultTitle">Report</h2><small id="resultMeta"></small></div>
        <button class="btn-close" onclick="closeResult()" aria-label="Zavřít"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="result-body" id="resultBody"></div>
      <div class="result-footer">
        <button class="btn-secondary" onclick="downloadJSON()"><svg viewBox="0 0 24 24" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Stáhnout JSON</button>
        <button class="btn-primary" id="exportBtn" onclick="exportReport()"><svg viewBox="0 0 24 24" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span id="exportBtnText">Exportovat PDF</span></button>
      </div>
    </div>
  </div>

  <script src="/static/app-header.js"></script>
  <script src="/static/css/global-search.css" onerror=""></script>
  <script src="/static/global-search.js" onerror=""></script>
  <script src="/static/js/ai-operator-drawer.js" onerror=""></script>
  <script src="/static/js/ai-inline-indicators.js" onerror=""></script>
  <script>
    const REPORT_CONFIG = {
      weekly: {
        content: [
          { id: 'hours_summary', label: 'Přehled hodin', desc: 'Celkové hodiny za období', default: true },
          { id: 'hours_by_project', label: 'Hodiny dle projektů', desc: 'Rozpad hodin na projekty', default: true },
          { id: 'hours_by_employee', label: 'Hodiny dle zaměstnanců', desc: 'Kdo odpracoval kolik', default: true },
          { id: 'tasks_completed', label: 'Dokončené úkoly', desc: 'Seznam splněných úkolů', default: true },
          { id: 'tasks_pending', label: 'Rozpracované úkoly', desc: 'Co je ještě v řešení', default: false },
          { id: 'tasks_overdue', label: 'Po termínu', desc: 'Úkoly po deadline', default: true }
        ],
        details: [
          { id: 'daily_breakdown', label: 'Denní rozpad', desc: 'Po jednotlivých dnech', default: true },
          { id: 'issues_reported', label: 'Nahlášené problémy', desc: 'Issues a závady', default: false }
        ],
        visuals: [
          { id: 'tables', label: 'Tabulky', desc: 'Strukturovaná data', default: true },
          { id: 'branding', label: 'Firemní branding', desc: 'Logo a barvy', default: true }
        ]
      },
      monthly: {
        content: [
          { id: 'financial', label: 'Finanční přehled', desc: 'Příjmy, výdaje, zisk', default: true },
          { id: 'revenue', label: 'Rozpad příjmů', desc: 'Podle projektů', default: false },
          { id: 'costs', label: 'Rozpad nákladů', desc: 'Mzdy, materiál, režie', default: false },
          { id: 'profitability', label: 'Ziskovost', desc: 'Marže a rentabilita', default: false },
          { id: 'productivity', label: 'Produktivita týmu', desc: 'Výkonnost', default: true },
          { id: 'top_projects', label: 'Top projekty', desc: 'Nejlepší/nejhorší', default: true },
          { id: 'clients', label: 'Přehled klientů', desc: 'Kdo platí nejvíc', default: false },
          { id: 'comparison', label: 'Srovnání s minulým', desc: 'Měsíc vs měsíc', default: false }
        ],
        details: [
          { id: 'invoices', label: 'Seznam faktur', desc: 'Vydané faktury', default: false },
          { id: 'payments', label: 'Status plateb', desc: 'Zaplaceno/ne', default: false },
          { id: 'expenses', label: 'Detail výdajů', desc: 'Každá položka', default: false },
          { id: 'salaries', label: 'Náklady na zaměstnance', desc: 'Mzdy a odvody', default: false },
          { id: 'materials', label: 'Náklady na materiál', desc: 'Spotřeba skladu', default: false },
          { id: 'subcontractors', label: 'Subdodavatelé', desc: 'Externí náklady', default: false }
        ],
        visuals: [
          { id: 'revenue_chart', label: 'Graf příjmů', desc: 'Trend za měsíc', default: false },
          { id: 'profit_chart', label: 'Graf zisku', desc: 'Vývoj marže', default: false },
          { id: 'comparison_chart', label: 'Srovnávací graf', desc: 'Tento vs minulý', default: false },
          { id: 'costs_pie', label: 'Struktura nákladů', desc: 'Kam jdou peníze', default: false },
          { id: 'tables', label: 'Tabulky', desc: 'Strukturovaná data', default: true },
          { id: 'branding', label: 'Firemní branding', desc: 'Logo a barvy', default: true }
        ]
      },
      project: {
        content: [
          { id: 'summary', label: 'Základní info', desc: 'Popis, klient, termíny', default: true },
          { id: 'timeline', label: 'Timeline prací', desc: 'Kdy co probíhalo', default: true },
          { id: 'budget', label: 'Rozpočet vs skutečnost', desc: 'Plán vs realita', default: true },
          { id: 'team', label: 'Zapojení týmu', desc: 'Kdo pracoval', default: true },
          { id: 'risks', label: 'Rizika a problémy', desc: 'Co se nepovedlo', default: false }
        ],
        details: [
          { id: 'tasks', label: 'Seznam úkolů', desc: 'Všechny tasky', default: true },
          { id: 'materials', label: 'Spotřeba materiálu', desc: 'Co se použilo', default: false }
        ],
        visuals: [
          { id: 'tables', label: 'Tabulky', desc: 'Strukturovaná data', default: true },
          { id: 'branding', label: 'Firemní branding', desc: 'Logo a barvy', default: true }
        ]
      },
      custom: {
        content: [
          { id: 'hours', label: 'Přehled hodin', desc: 'Celkové hodiny', default: true },
          { id: 'financial', label: 'Finanční přehled', desc: 'Příjmy a výdaje', default: false },
          { id: 'tasks', label: 'Přehled úkolů', desc: 'Statusy a progres', default: true },
          { id: 'team', label: 'Přehled týmu', desc: 'Zaměstnanci', default: true },
          { id: 'projects', label: 'Přehled projektů', desc: 'Všechny zakázky', default: true },
          { id: 'warehouse', label: 'Stav skladu', desc: 'Zásoby a hodnota', default: false },
          { id: 'nursery', label: 'Stav školky', desc: 'Rostliny a prodej', default: false }
        ],
        details: [
          { id: 'full', label: 'Plné detaily', desc: 'Vše do hloubky', default: false },
          { id: 'summary', label: 'Pouze souhrn', desc: 'Stručný přehled', default: true }
        ],
        visuals: [
          { id: 'tables', label: 'Tabulky', desc: 'Strukturovaná data', default: true },
          { id: 'branding', label: 'Firemní branding', desc: 'Logo a barvy', default: true }
        ]
      }
    };

    const TITLES = { weekly: 'Týdenní report', monthly: 'Měsíční report', project: 'Projektový report', custom: 'Vlastní report' };
    let currentType = 'weekly';
    let selectedFormat = 'pdf';
    let lastReportData = null;

    function saveState() { try { localStorage.setItem(`report_${currentType}`, JSON.stringify({ content: getIds('contentSections'), details: getIds('dataDetails'), visuals: getIds('visualElements'), format: selectedFormat })); } catch(e){} }
    function loadState() { try { return JSON.parse(localStorage.getItem(`report_${currentType}`)); } catch(e){ return null; } }
    function getIds(cid) { return Array.from(document.querySelectorAll(`#${cid} .selectable-card[aria-checked="true"]`)).map(c => c.dataset.id); }

    function renderCards(container, items, saved) {
      container.innerHTML = items.map(i => {
        const sel = saved ? saved.includes(i.id) : i.default;
        return `<div class="selectable-card" role="checkbox" tabindex="0" aria-checked="${sel}" data-id="${i.id}" onclick="toggleCard(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCard(this);}"><div class="card-checkbox"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="card-content"><div class="card-title">${i.label}</div><div class="card-desc">${i.desc}</div></div></div>`;
      }).join('');
    }

    function renderFormats(saved) {
      const fmts = [{id:'pdf',label:'PDF',icon:'pdf'},{id:'xlsx',label:'Excel',icon:'xlsx'},{id:'docx',label:'Word',icon:'docx'}];
      document.getElementById('exportFormats').innerHTML = fmts.map(f => `<div class="export-format" role="radio" tabindex="0" aria-checked="${f.id===(saved||'pdf')}" data-format="${f.id}" onclick="selectFormat(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectFormat(this);}"><div class="export-format-icon ${f.icon}">${f.id==='pdf'?'<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>':f.id==='xlsx'?'<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/></svg>':'<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'}</div><span class="export-format-label">${f.label}</span></div>`).join('');
      selectedFormat = saved || 'pdf';
    }

    function toggleCard(el) { el.setAttribute('aria-checked', el.getAttribute('aria-checked')!=='true'); saveState(); }
    function selectFormat(el) { document.querySelectorAll('.export-format').forEach(f => f.setAttribute('aria-checked','false')); el.setAttribute('aria-checked','true'); selectedFormat = el.dataset.format; saveState(); }

    function openGenerator(type) {
      currentType = type;
      document.getElementById('generatorTitle').textContent = TITLES[type];
      const today = new Date(), past = new Date(today);
      if (type==='weekly') past.setDate(today.getDate()-7); else if (type==='monthly') past.setMonth(today.getMonth()-1); else past.setDate(today.getDate()-30);
      document.getElementById('dateFrom').value = past.toISOString().split('T')[0];
      document.getElementById('dateTo').value = today.toISOString().split('T')[0];
      document.getElementById('projectSelectGroup').style.display = type==='project'?'block':'none';
      document.getElementById('filtersSection').style.display = type==='project'?'none':'block';
      document.getElementById('jobsFilterGroup').style.display = type==='project'?'none':'block';
      if (type==='project') loadProjects();
      
      // Load filters
      loadEmployees();
      if (type !== 'project') loadJobs();
      
      const s = loadState(), cfg = REPORT_CONFIG[type];
      renderCards(document.getElementById('contentSections'), cfg.content, s?.content);
      renderCards(document.getElementById('dataDetails'), cfg.details, s?.details);
      renderCards(document.getElementById('visualElements'), cfg.visuals, s?.visuals);
      renderFormats(s?.format);
      document.getElementById('reportNote').value = '';
      document.getElementById('generatorOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeGenerator() { document.getElementById('generatorOverlay').classList.remove('active'); document.body.style.overflow=''; }
    function closeResult() { document.getElementById('resultOverlay').classList.remove('active'); document.body.style.overflow=''; }

    async function loadProjects() {
      try {
        const r = await fetch('/api/reports/projects', {credentials:'include'});
        if (!r.ok) return;
        const jobs = await r.json();
        const sel = document.getElementById('projectSelect');
        sel.innerHTML = '<option value="">Vyberte projekt</option>' + jobs.map(j => `<option value="${j.id}">${j.name||'Projekt '+j.id}${j.client?' ('+j.client+')':''}</option>`).join('');
      } catch(e){ console.error(e); }
    }

    async function loadEmployees() {
      try {
        const r = await fetch('/api/reports/employees', {credentials:'include'});
        if (!r.ok) return;
        const emps = await r.json();
        const sel = document.getElementById('employeesFilter');
        sel.innerHTML = emps.map(e => `<option value="${e.id}">${e.name}${e.role?' ('+e.role+')':''}</option>`).join('');
      } catch(e){ console.error(e); }
    }

    async function loadJobs() {
      try {
        const r = await fetch('/api/reports/projects', {credentials:'include'});
        if (!r.ok) return;
        const jobs = await r.json();
        const sel = document.getElementById('jobsFilter');
        sel.innerHTML = jobs.map(j => `<option value="${j.id}">${j.name||'Projekt '+j.id}${j.client?' ('+j.client+')':''}</option>`).join('');
      } catch(e){ console.error(e); }
    }

    async function generateReport() {
      const dateFrom = document.getElementById('dateFrom').value, dateTo = document.getElementById('dateTo').value, projectId = document.getElementById('projectSelect')?.value, note = document.getElementById('reportNote').value;
      if (!dateFrom || !dateTo) { alert('Vyplňte období'); return; }
      if (currentType==='project' && !projectId) { alert('Vyberte projekt'); return; }
      const content = getIds('contentSections'), details = getIds('dataDetails'), visuals = getIds('visualElements');
      if (content.length===0 && details.length===0) { alert('Vyberte alespoň jednu sekci'); return; }
      
      // Get selected filters
      const employeesFilter = Array.from(document.getElementById('employeesFilter').selectedOptions).map(o => parseInt(o.value));
      const jobsFilter = Array.from(document.getElementById('jobsFilter').selectedOptions).map(o => parseInt(o.value));
      
      const btn = document.getElementById('generateBtn');
      btn.classList.add('loading'); btn.disabled = true;
      try {
        const r = await fetch('/api/reports/generate', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({type:currentType,dateFrom,dateTo,projectId:currentType==='project'?projectId:null,content,details,visuals,format:selectedFormat,note,employeeIds:employeesFilter.length>0?employeesFilter:null,jobIds:jobsFilter.length>0?jobsFilter:null}) });
        if (!r.ok) throw new Error((await r.json().catch(()=>({}))).error || 'Chyba');
        const data = await r.json();
        lastReportData = data; lastReportData._format = selectedFormat; lastReportData._note = note;
        closeGenerator(); showResult(data);
      } catch(e) { alert('Chyba: '+e.message); } finally { btn.classList.remove('loading'); btn.disabled=false; }
    }

    function showResult(data) {
      document.getElementById('resultTitle').textContent = TITLES[data.type]||'Report';
      document.getElementById('resultMeta').textContent = `Od: ${data.date_from} | Do: ${data.date_to} | ${new Date(data.generated_at).toLocaleString('cs-CZ')}`;
      document.getElementById('exportBtnText').textContent = 'Exportovat ' + ({pdf:'PDF',xlsx:'Excel',docx:'Word'}[selectedFormat]||'PDF');
      const body = document.getElementById('resultBody');
      
      // Kompletní překlady sekcí
      const labels = {
        hours_summary:'Přehled hodin', hours_by_project:'Hodiny dle projektů', hours_by_employee:'Hodiny dle zaměstnanců',
        tasks_completed:'Dokončené úkoly', tasks_pending:'Rozpracované úkoly', tasks_overdue:'Úkoly po termínu',
        daily_breakdown:'Denní rozpad', issues:'Problémy', financial:'Finanční přehled', top_projects:'Top projekty',
        productivity:'Produktivita', warehouse:'Sklad', project_info:'Informace o projektu', timesheets:'Výkazy práce',
        costs:'Náklady', team:'Tým', tasks:'Úkoly', materials:'Materiály', hours:'Hodiny', projects:'Projekty',
        nursery:'Školka', hours_total:'Celkem hodin', revenue:'Příjmy', profitability:'Ziskovost', clients:'Klienti',
        comparison:'Srovnání s minulým obdobím', salaries:'Mzdové náklady'
      };
      
      // Kompletní překlady klíčů
      const kl = {
        total_hours:'Celkem hodin', unique_employees:'Zaměstnanců', unique_jobs:'Zakázek', hours:'Hodiny', name:'Název',
        client:'Klient', status:'Status', workers:'Pracovníků', role:'Pozice', id:'ID', title:'Název', date:'Datum',
        labor_cost:'Náklady na práci', total:'Celkem', active:'Aktivních', value:'Hodnota', days:'Dní', projects:'Projektů',
        employee:'Zaměstnanec', activity:'Činnost', place:'Místo', assignee:'Přiřazeno', due_date:'Termín',
        description:'Popis', city:'Město', budget:'Rozpočet', created_at:'Vytvořeno', deadline:'Deadline',
        total_entries:'Záznamů', cost:'Náklady', earnings:'Výdělek', hourly_rate:'Hodinová sazba',
        total_items:'Položek', total_value:'Celková hodnota', low_stock_count:'Nízké zásoby', items:'Položky',
        total_cost:'Celkové náklady', materials_cost:'Náklady na materiál', margin:'Marže', total_revenue:'Celkové příjmy',
        profit:'Zisk', margin_percent:'Marže %', jobs_count:'Počet zakázek', total_budget:'Celkový rozpočet',
        current_hours:'Aktuální hodiny', previous_hours:'Předchozí hodiny', hours_change_percent:'Změna %',
        current_jobs:'Aktuální zakázky', previous_jobs:'Předchozí zakázky', total_price:'Celková cena',
        unit_price:'Jednotková cena', qty:'Množství', unit:'Jednotka', job_name:'Zakázka'
      };
      
      // Klíče k ignorování (prázdné/interní)
      const ignoreKeys = ['id','created_by','created_from_template','is_template','internal_note','code','buffer_days',
        'deadline_reason','deadline_type','budget_equipment','budget_labor','budget_materials','budget_other',
        'budget_spent_percent','actual_end_date','actual_hours','actual_labor_cost','actual_material_cost',
        'actual_value','estimated_hours','estimated_value','completion_percent','completed_at','invoiced','address'];
      
      const fmt = (k,v) => { 
        if(v==null || v==='' || v==='null') return null;
        if(typeof v==='number'){ 
          if(k.includes('cost')||k.includes('value')||k.includes('budget')||k.includes('price')||k==='earnings'||k==='profit'||k==='margin'||k==='total_revenue') 
            return v.toLocaleString('cs-CZ')+' Kč'; 
          if(k.includes('hours')||k==='hours'||k==='total_hours') 
            return v.toLocaleString('cs-CZ',{minimumFractionDigits:1})+' h';
          if(k.includes('percent'))
            return v.toLocaleString('cs-CZ',{minimumFractionDigits:1})+' %';
          return v.toLocaleString('cs-CZ'); 
        }
        if(k==='status') return {open:'Otevřený',in_progress:'V práci',done:'Dokončeno',completed:'Dokončeno',active:'Aktivní',cancelled:'Zrušeno'}[v]||v;
        return v; 
      };
      
      let html = '';
      if (!data.sections || Object.keys(data.sections).length===0) { 
        html = '<div class="result-empty">Report neobsahuje data</div>'; 
      } else { 
        for (const [k,v] of Object.entries(data.sections)) { 
          if(v==null) continue; 
          const t = labels[k]||k.replace(/_/g,' '); 
          
          if(Array.isArray(v)){ 
            if(v.length===0) continue; 
            // Filtrovat klíče - jen ty co mají smysl
            const allKeys = Object.keys(v[0]||{});
            const h = allKeys.filter(x => !ignoreKeys.includes(x) && v.some(row => row[x]!=null && row[x]!=='' && row[x]!=='null'));
            if(h.length===0) continue;
            
            html += `<div class="result-section"><h4>${t}</h4><div style="overflow-x:auto;"><table class="result-table"><thead><tr>${h.map(x=>`<th>${kl[x]||x}</th>`).join('')}</tr></thead><tbody>${v.slice(0,30).map(r=>`<tr>${h.map(x=>{const fv=fmt(x,r[x]);return `<td>${fv!==null?fv:'-'}</td>`;}).join('')}</tr>`).join('')}</tbody></table></div>${v.length>30?`<div style="text-align:center;padding:8px;color:var(--text-secondary);font-size:12px;">...a dalších ${v.length-30}</div>`:''}</div>`; 
          } else if(typeof v==='object'){ 
            // Filtrovat prázdné hodnoty
            const entries = Object.entries(v).filter(([x,y])=>!ignoreKeys.includes(x) && y!=null && y!=='' && y!=='null' && x!=='items' && x!=='by_status');
            if(entries.length===0 && !v.by_status) continue;
            
            if(v.by_status){ 
              html += `<div class="result-section"><h4>${t}</h4><div class="result-stats"><div class="result-stat"><div class="result-stat-value">${v.total||0}</div><div class="result-stat-label">Celkem</div></div>${v.by_status.map(s=>`<div class="result-stat"><div class="result-stat-value">${s.count}</div><div class="result-stat-label">${s.status}</div></div>`).join('')}</div></div>`; 
            } else { 
              html += `<div class="result-section"><h4>${t}</h4><div class="result-stats">${entries.map(([x,y])=>{const fv=fmt(x,y);return fv!==null?`<div class="result-stat"><div class="result-stat-value">${fv}</div><div class="result-stat-label">${kl[x]||x.replace(/_/g,' ')}</div></div>`:''}).join('')}</div></div>`; 
            } 
          } else { 
            const fv = fmt(k,v);
            if(fv===null) continue;
            html += `<div class="result-section"><h4>${t}</h4><div class="result-stats"><div class="result-stat"><div class="result-stat-value">${fv}</div><div class="result-stat-label">${kl[k]||k}</div></div></div></div>`; 
          } 
        } 
      }
      body.innerHTML = html;
      document.getElementById('resultOverlay').classList.add('active'); document.body.style.overflow='hidden';
    }

    function downloadJSON() { if(!lastReportData) return; const b = new Blob([JSON.stringify(lastReportData,null,2)],{type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`report-${lastReportData.type}-${lastReportData.date_from}.json`; a.click(); URL.revokeObjectURL(u); }

    function exportReport() { if(!lastReportData) return; const f = lastReportData._format||'pdf'; if(f==='pdf') exportPDF(); else if(f==='xlsx') exportExcel(); else exportWord(); }

    function exportPDF() {
      const {jsPDF} = window.jspdf, doc = new jsPDF(), d = lastReportData;
      
      // Překlady
      const labels = {
        hours_summary:'Přehled hodin', hours_by_project:'Hodiny dle projektů', hours_by_employee:'Hodiny dle zaměstnanců',
        tasks_completed:'Dokončené úkoly', tasks_pending:'Rozpracované úkoly', tasks_overdue:'Úkoly po termínu',
        daily_breakdown:'Denní rozpad', issues:'Problémy', financial:'Finanční přehled', top_projects:'Top projekty',
        productivity:'Produktivita', warehouse:'Sklad', project_info:'Informace o projektu', timesheets:'Výkazy práce',
        costs:'Náklady', team:'Tým', tasks:'Úkoly', materials:'Materiály', hours:'Hodiny', projects:'Projekty',
        nursery:'Školka', hours_total:'Celkem hodin', revenue:'Příjmy', profitability:'Ziskovost', clients:'Klienti',
        comparison:'Srovnání', salaries:'Mzdové náklady'
      };
      const kl = {
        total_hours:'Hodiny', unique_employees:'Zaměstnanců', unique_jobs:'Zakázek', hours:'Hodiny', name:'Název',
        client:'Klient', status:'Status', workers:'Pracovníků', role:'Pozice', title:'Název', date:'Datum',
        labor_cost:'Náklady práce', total:'Celkem', active:'Aktivních', value:'Hodnota', days:'Dní', projects:'Projektů',
        employee:'Zaměstnanec', activity:'Činnost', place:'Místo', assignee:'Přiřazeno', due_date:'Termín', city:'Město',
        budget:'Rozpočet', cost:'Náklady', earnings:'Výdělek', hourly_rate:'Sazba/h', total_cost:'Celk. náklady',
        materials_cost:'Materiál', margin:'Marže', total_revenue:'Příjmy', profit:'Zisk', margin_percent:'Marže %',
        jobs_count:'Zakázek', total_budget:'Rozpočet', current_hours:'Nyní h', previous_hours:'Dříve h',
        hours_change_percent:'Změna %', qty:'Množství', unit:'Jedn.', job_name:'Zakázka', total_price:'Celkem',
        unit_price:'Cena/ks', total_items:'Položek', total_value:'Hodnota', low_stock_count:'Nízké zásoby'
      };
      const ignoreKeys = ['id','created_by','created_from_template','is_template','internal_note','code','buffer_days',
        'deadline_reason','deadline_type','budget_equipment','budget_labor','budget_materials','budget_other',
        'budget_spent_percent','actual_end_date','actual_hours','actual_labor_cost','actual_material_cost',
        'actual_value','estimated_hours','estimated_value','completion_percent','completed_at','invoiced','address',
        'description','created_at','deadline','created_date'];
      
      const fmt = (k,v) => { 
        if(v==null || v==='' || v==='null') return '-';
        if(typeof v==='number'){ 
          if(k.includes('cost')||k.includes('value')||k.includes('budget')||k.includes('price')||k==='earnings'||k==='profit') return v.toLocaleString('cs-CZ')+' Kč'; 
          if(k.includes('hours')||k==='hours') return v.toLocaleString('cs-CZ',{minimumFractionDigits:1})+' h';
          if(k.includes('percent')) return v.toLocaleString('cs-CZ',{minimumFractionDigits:1})+' %';
          return String(v);
        }
        if(k==='status') return {open:'Otevřený',in_progress:'V práci',done:'Hotovo',completed:'Hotovo',active:'Aktivní'}[v]||v;
        return String(v).substring(0,50);
      };
      
      // Header
      doc.setFontSize(20); doc.setTextColor(34,197,94); doc.text(TITLES[d.type]||'Report',20,20);
      doc.setFontSize(11); doc.setTextColor(100); 
      doc.text(`Období: ${d.date_from} - ${d.date_to}`,20,30); 
      doc.text(`Vygenerováno: ${new Date(d.generated_at).toLocaleString('cs-CZ')}`,20,37);
      if(d._note) { doc.text(`Poznámka: ${d._note}`,20,44); }
      
      let y = d._note ? 55 : 48;
      
      for (const [k,v] of Object.entries(d.sections||{})) { 
        if(v==null) continue; 
        if(y>260){doc.addPage();y=20;} 
        
        const sectionTitle = labels[k]||k.replace(/_/g,' ');
        doc.setFontSize(13); doc.setTextColor(34,197,94); doc.text(sectionTitle,20,y); y+=8; 
        doc.setFontSize(9); doc.setTextColor(60); 
        
        if(Array.isArray(v)&&v.length>0){ 
          const allKeys = Object.keys(v[0]);
          const h = allKeys.filter(x => !ignoreKeys.includes(x) && v.some(row => row[x]!=null && row[x]!=='' && row[x]!=='null'));
          if(h.length===0) continue;
          
          doc.autoTable({
            startY:y,
            head:[h.map(x=>kl[x]||x)],
            body:v.slice(0,25).map(r=>h.map(x=>fmt(x,r[x]))),
            theme:'striped',
            headStyles:{fillColor:[34,197,94],textColor:[255,255,255],fontSize:8,fontStyle:'bold'},
            bodyStyles:{fontSize:7},
            styles:{cellPadding:2,overflow:'ellipsize'},
            margin:{left:20,right:20}
          }); 
          y=doc.lastAutoTable.finalY+12; 
        } else if(typeof v==='object'){ 
          const entries = Object.entries(v).filter(([x,z])=>!ignoreKeys.includes(x) && z!=null && z!=='' && z!=='null' && x!=='items' && x!=='by_status');
          for(const [x,z] of entries){ 
            doc.text(`${kl[x]||x}: ${fmt(x,z)}`,25,y); y+=5; 
            if(y>270){doc.addPage();y=20;}
          } 
          y+=7; 
        } 
      }
      doc.save(`report-${d.type}-${d.date_from}.pdf`);
    }

    function exportExcel() {
      const d = lastReportData;
      const labels = {
        hours_summary:'Přehled hodin', hours_by_project:'Hodiny dle projektů', hours_by_employee:'Hodiny dle zaměstnanců',
        tasks_completed:'Dokončené úkoly', tasks_pending:'Rozpracované úkoly', tasks_overdue:'Úkoly po termínu',
        daily_breakdown:'Denní rozpad', financial:'Finanční přehled', top_projects:'Top projekty',
        productivity:'Produktivita', warehouse:'Sklad', project_info:'Informace o projektu', timesheets:'Výkazy práce',
        costs:'Náklady', team:'Tým', tasks:'Úkoly', materials:'Materiály', hours_total:'Celkem hodin'
      };
      const kl = {
        total_hours:'Hodiny', unique_employees:'Zaměstnanců', unique_jobs:'Zakázek', hours:'Hodiny', name:'Název',
        client:'Klient', status:'Status', workers:'Pracovníků', role:'Pozice', title:'Název', date:'Datum',
        labor_cost:'Náklady práce', total:'Celkem', days:'Dní', employee:'Zaměstnanec', activity:'Činnost',
        place:'Místo', assignee:'Přiřazeno', due_date:'Termín', city:'Město', cost:'Náklady', job_name:'Zakázka'
      };
      const ignoreKeys = ['id','created_by','created_from_template','is_template','internal_note','code','buffer_days',
        'deadline_reason','deadline_type','budget_equipment','budget_labor','budget_materials','budget_other',
        'budget_spent_percent','actual_end_date','actual_hours','actual_labor_cost','actual_material_cost',
        'actual_value','estimated_hours','estimated_value','completion_percent','completed_at','invoiced','address','description'];
      
      let csv = `${TITLES[d.type]}\nObdobí: ${d.date_from} - ${d.date_to}\nVygenerováno: ${new Date(d.generated_at).toLocaleString('cs-CZ')}\n`;
      
      for (const [k,v] of Object.entries(d.sections||{})) { 
        if(v==null) continue; 
        csv += `\n${labels[k]||k}\n`; 
        if(Array.isArray(v)&&v.length>0){ 
          const allKeys = Object.keys(v[0]);
          const h = allKeys.filter(x => !ignoreKeys.includes(x));
          csv += h.map(x=>kl[x]||x).join(';')+'\n'; 
          v.forEach(r=>csv+=h.map(x=>String(r[x]??'').replace(/;/g,',')).join(';')+'\n'); 
        } else if(typeof v==='object'){ 
          for(const [x,z] of Object.entries(v)){ 
            if(ignoreKeys.includes(x)||x==='items'||x==='by_status') continue; 
            csv+=`${kl[x]||x};${z}\n`; 
          } 
        } 
      }
      const b = new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`report-${d.type}-${d.date_from}.csv`; a.click(); URL.revokeObjectURL(u);
    }

    function exportWord() {
      const d = lastReportData;
      const labels = {
        hours_summary:'Přehled hodin', hours_by_project:'Hodiny dle projektů', hours_by_employee:'Hodiny dle zaměstnanců',
        tasks_completed:'Dokončené úkoly', tasks_pending:'Rozpracované úkoly', tasks_overdue:'Úkoly po termínu',
        daily_breakdown:'Denní rozpad', financial:'Finanční přehled', top_projects:'Top projekty',
        productivity:'Produktivita', warehouse:'Sklad', project_info:'Informace o projektu', timesheets:'Výkazy práce',
        costs:'Náklady', team:'Tým', tasks:'Úkoly', materials:'Materiály', hours_total:'Celkem hodin'
      };
      const kl = {
        total_hours:'Hodiny', unique_employees:'Zaměstnanců', unique_jobs:'Zakázek', hours:'Hodiny', name:'Název',
        client:'Klient', status:'Status', workers:'Pracovníků', role:'Pozice', title:'Název', date:'Datum',
        labor_cost:'Náklady práce', total:'Celkem', days:'Dní', employee:'Zaměstnanec', activity:'Činnost',
        place:'Místo', assignee:'Přiřazeno', due_date:'Termín', city:'Město', cost:'Náklady', job_name:'Zakázka'
      };
      const ignoreKeys = ['id','created_by','created_from_template','is_template','internal_note','code','buffer_days',
        'deadline_reason','deadline_type','budget_equipment','budget_labor','budget_materials','budget_other',
        'budget_spent_percent','actual_end_date','actual_hours','actual_labor_cost','actual_material_cost',
        'actual_value','estimated_hours','estimated_value','completion_percent','completed_at','invoiced','address','description'];
      
      let h = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Report</title><style>body{font-family:Arial,sans-serif;padding:30px;color:#333;}h1{color:#22c55e;border-bottom:3px solid #22c55e;padding-bottom:10px;}h2{color:#16a34a;margin-top:25px;border-bottom:1px solid #ddd;padding-bottom:5px;}table{border-collapse:collapse;width:100%;margin:15px 0;}th,td{border:1px solid #ddd;padding:10px 8px;text-align:left;}th{background:#f0fdf4;font-weight:600;}tr:nth-child(even){background:#f9fafb;}p{margin:5px 0;}.meta{color:#666;font-size:14px;margin-bottom:20px;}</style></head><body>`;
      h += `<h1>${TITLES[d.type]}</h1>`;
      h += `<p class="meta"><strong>Období:</strong> ${d.date_from} - ${d.date_to} | <strong>Vygenerováno:</strong> ${new Date(d.generated_at).toLocaleString('cs-CZ')}</p>`;
      if(d._note) h += `<p class="meta"><strong>Poznámka:</strong> ${d._note}</p>`;
      
      for (const [k,v] of Object.entries(d.sections||{})) { 
        if(v==null) continue; 
        h+=`<h2>${labels[k]||k}</h2>`; 
        if(Array.isArray(v)&&v.length>0){ 
          const allKeys = Object.keys(v[0]);
          const hd = allKeys.filter(x => !ignoreKeys.includes(x));
          h+=`<table><tr>${hd.map(x=>`<th>${kl[x]||x}</th>`).join('')}</tr>${v.slice(0,50).map(r=>`<tr>${hd.map(x=>`<td>${r[x]??'-'}</td>`).join('')}</tr>`).join('')}</table>`; 
        } else if(typeof v==='object'){ 
          const entries = Object.entries(v).filter(([x])=>!ignoreKeys.includes(x)&&x!=='items'&&x!=='by_status');
          if(entries.length>0) {
            h+='<table>'; 
            for(const [x,z] of entries){ 
              h+=`<tr><th style="width:200px;">${kl[x]||x}</th><td>${z}</td></tr>`; 
            } 
            h+='</table>'; 
          }
        } 
      }
      h+='</body></html>'; 
      const b = new Blob([h],{type:'application/msword'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`report-${d.type}-${d.date_from}.doc`; a.click(); URL.revokeObjectURL(u);
    }

    document.addEventListener('keydown', e => { if(e.key==='Escape'){ if(document.getElementById('resultOverlay').classList.contains('active')) closeResult(); else if(document.getElementById('generatorOverlay').classList.contains('active')) closeGenerator(); } });
    document.getElementById('generatorOverlay').addEventListener('click', e => { if(e.target.id==='generatorOverlay') closeGenerator(); });
    document.getElementById('resultOverlay').addEventListener('click', e => { if(e.target.id==='resultOverlay') closeResult(); });
    document.querySelectorAll('.report-card').forEach(c => c.addEventListener('keydown', e => { if(e.key==='Enter'||e.key===' '){ e.preventDefault(); c.click(); } }));
  </script>
<script src="/static/app-sidebar.js"></script>
</body>
</html>
