<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Výkazy hodin - Green David</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .timeline-item {
            position: relative;
            padding-left: 40px;
            padding-bottom: 24px;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 15px;
            top: 12px;
            bottom: -12px;
            width: 2px;
            background: var(--line);
        }
        .timeline-item:last-child:before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 8px;
            top: 8px;
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background: var(--mint);
            border: 3px solid var(--bg-dark);
        }
        .timeline-card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .timeline-time {
            font-size: 20px;
            font-weight: 700;
            color: var(--mint);
        }
        .timeline-date {
            font-size: 13px;
            color: var(--text-muted);
        }
        .date-separator {
            padding: 16px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <div class="logo-area">
                <div class="logo-icon">
                    <img src="/logo.jpg" alt="Green David" onerror="this.parentElement.innerHTML='<div style=\'font-weight:700;color:var(--text-light);font-size:14px\'>GD</div>'">
                </div>
                <div class="app-title">výkazy hodin</div>
            </div>
            <button class="btn btn-small" onclick="showNewTimesheetModal()">
                <svg viewBox="0 0 24 24" style="width:20px;height:20px">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Přidat
            </button>
        </div>
        
        <!-- Filters -->
        <div style="margin-top: 16px;">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="date" id="date-from" style="flex: 1;">
                <input type="date" id="date-to" style="flex: 1;">
            </div>
            <select id="employee-filter" style="width: 100%;">
                <option value="">Všichni zaměstnanci</option>
            </select>
        </div>
    </div>
    
    <!-- Summary -->
    <div class="section">
        <div class="card" style="display: flex; justify-content: space-around; text-align: center;">
            <div>
                <div style="font-size: 24px; font-weight: 700; color: var(--mint);" id="total-hours">0</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Hodin celkem</div>
            </div>
            <div style="width: 1px; background: var(--line);"></div>
            <div>
                <div style="font-size: 24px; font-weight: 700; color: var(--text-light);" id="total-entries">0</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Záznamů</div>
            </div>
        </div>
    </div>
    
    <!-- Timeline -->
    <div class="section">
        <div id="timesheets-list">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="tab-bar">
        <div class="tab-item" onclick="location.href='/'">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                </svg>
            </div>
            <div class="tab-label">domů</div>
        </div>
        <div class="tab-item" onclick="location.href='/jobs'">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                </svg>
            </div>
            <div class="tab-label">zakázky</div>
        </div>
        <div class="tab-item active">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="tab-label">výkazy</div>
        </div>
        <div class="tab-item" onclick="location.href='/calendar'">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
            </div>
            <div class="tab-label">kalendář</div>
        </div>
        <div class="tab-item" onclick="location.href='/employees'">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </div>
            <div class="tab-label">více</div>
        </div>
    </div>
    
    <!-- New Timesheet Modal -->
    <div id="new-timesheet-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Přidat výkaz</div>
                <button class="modal-close" onclick="closeNewTimesheetModal()">
                    <svg viewBox="0 0 24 24" style="width:20px;height:20px">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="new-timesheet-form">
                    <div class="input-group">
                        <label class="input-label">Zaměstnanec *</label>
                        <select name="employee_id" id="modal-employee-select" required>
                            <option value="">Vyberte...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Zakázka *</label>
                        <select name="job_id" id="modal-job-select" required>
                            <option value="">Vyberte...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Datum *</label>
                        <input type="date" name="date" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Hodiny *</label>
                        <input type="number" name="hours" step="0.5" min="0" required placeholder="8">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Poznámka</label>
                        <textarea name="notes" placeholder="Popis práce..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeNewTimesheetModal()">Zrušit</button>
                <button class="btn" onclick="submitNewTimesheet()">Přidat</button>
            </div>
        </div>
    </div>
    
    <script>
        async function api(path, opts = {}) {
            const res = await fetch(path, {
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                ...opts
            });
            if (!res.ok) throw new Error(res.statusText);
            return await res.json();
        }
        
        let allTimesheets = [];
        let employees = [];
        let jobs = [];
        
        // Load data
        async function loadData() {
            try {
                const [tsData, empData, jobsData] = await Promise.all([
                    api('/api/timesheets'),
                    api('/api/employees'),
                    api('/api/jobs')
                ]);
                
                allTimesheets = tsData.timesheets || [];
                employees = empData.employees || [];
                jobs = jobsData.jobs || [];
                
                // Populate filters
                const empFilter = document.getElementById('employee-filter');
                empFilter.innerHTML = '<option value="">Všichni zaměstnanci</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                
                // Populate modal selects
                const modalEmp = document.getElementById('modal-employee-select');
                modalEmp.innerHTML = '<option value="">Vyberte...</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                
                const modalJob = document.getElementById('modal-job-select');
                modalJob.innerHTML = '<option value="">Vyberte...</option>' +
                    jobs.map(j => `<option value="${j.id}">${j.title || j.name}</option>`).join('');
                
                renderTimesheets();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Render timesheets
        function renderTimesheets() {
            const container = document.getElementById('timesheets-list');
            const empFilter = document.getElementById('employee-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            let filtered = allTimesheets;
            
            // Filter by employee
            if (empFilter) {
                filtered = filtered.filter(ts => ts.employee_id == empFilter);
            }
            
            // Filter by date range
            if (dateFrom) {
                filtered = filtered.filter(ts => ts.date >= dateFrom);
            }
            if (dateTo) {
                filtered = filtered.filter(ts => ts.date <= dateTo);
            }
            
            // Update summary
            const totalHours = filtered.reduce((sum, ts) => sum + (parseFloat(ts.hours) || 0), 0);
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('total-entries').textContent = filtered.length;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⏱️</div>
                        <div class="empty-title">Žádné výkazy</div>
                        <div class="empty-text">Přidejte první výkaz hodin</div>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const grouped = {};
            filtered.forEach(ts => {
                const date = ts.date || 'Neznámé datum';
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(ts);
            });
            
            // Sort dates descending
            const dates = Object.keys(grouped).sort().reverse();
            
            const html = dates.map(date => {
                const entries = grouped[date];
                const entriesHtml = entries.map(ts => {
                    const emp = employees.find(e => e.id == ts.employee_id);
                    const job = jobs.find(j => j.id == ts.job_id);
                    
                    return `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-card">
                                <div class="timeline-header">
                                    <div class="timeline-time">${ts.hours}h</div>
                                    <div class="timeline-date">${emp?.name || 'Neznámý'}</div>
                                </div>
                                <div style="color: var(--text-light); font-weight: 600; margin-bottom: 4px;">
                                    ${job?.title || job?.name || 'Neznámá zakázka'}
                                </div>
                                ${ts.notes ? `<div style="color: var(--text-muted); font-size: 14px;">${ts.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="date-separator">${formatDate(date)}</div>
                    ${entriesHtml}
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Dnes';
            if (date.toDateString() === yesterday.toDateString()) return 'Včera';
            
            return date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        // Modal functions
        function showNewTimesheetModal() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="date"]').value = today;
            document.getElementById('new-timesheet-modal').style.display = 'flex';
        }
        
        function closeNewTimesheetModal() {
            document.getElementById('new-timesheet-modal').style.display = 'none';
            document.getElementById('new-timesheet-form').reset();
        }
        
        async function submitNewTimesheet() {
            const form = document.getElementById('new-timesheet-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                await api('/api/timesheets', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                closeNewTimesheetModal();
                loadData();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // Filter listeners
            document.getElementById('employee-filter').addEventListener('change', renderTimesheets);
            document.getElementById('date-from').addEventListener('change', renderTimesheets);
            document.getElementById('date-to').addEventListener('change', renderTimesheets);
        });
    </script>
</body>
</html>
