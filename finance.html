<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finance - green david app</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <script src="/app-settings.js"></script>
  <style>
    :root {
      --bg-primary: #0a1628;
      --bg-secondary: #1a2942;
      --bg-card: rgba(255,255,255,0.05);
      --bg-elevated: rgba(255,255,255,0.08);
      --border-primary: rgba(255,255,255,0.1);
      --border-medium: rgba(255,255,255,0.15);
      --text-primary: #e8eef2;
      --text-secondary: #9ca8b3;
      --text-tertiary: #6b7580;
      --mint: #B2FBA5;
      --mint-dark: #B2FBA5;
      --warning: #fb923c;
      --danger: #f87171;
      --success: #B2FBA5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .finance-page {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .finance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .finance-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-primary {
      padding: 10px 20px;
      background: var(--mint);
      border: 1px solid var(--mint);
      border-radius: 8px;
      color: #0a0e11;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: var(--mint-dark);
      border-color: var(--mint-dark);
    }

    .btn-secondary {
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: var(--bg-elevated);
    }

    /* Finance Overview */
    .finance-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .finance-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s;
    }

    .finance-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border-color: var(--mint);
    }

    .finance-card.success {
      border-color: var(--success);
      background: rgba(178, 251, 165, 0.1);
    }

    .finance-card.warning {
      border-color: var(--warning);
      background: rgba(251, 146, 60, 0.1);
    }

    .finance-card.danger {
      border-color: var(--danger);
      background: rgba(248, 113, 113, 0.1);
    }

    .finance-card h3 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin: 0 0 12px 0;
    }

    .finance-card h2 {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .finance-card .trend {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }

    .finance-card .trend.up {
      background: rgba(178, 251, 165, 0.2);
      color: var(--success);
    }

    .finance-card .trend.down {
      background: rgba(248, 113, 113, 0.2);
      color: var(--danger);
    }

    .finance-card .breakdown {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .finance-card .breakdown span {
      display: flex;
      justify-content: space-between;
    }

    /* Tabs */
    .finance-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-primary);
    }

    .tab-btn {
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      margin-bottom: -1px;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--mint);
      border-bottom-color: var(--mint);
    }

    /* Invoices Table */
    .invoices-section {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .filters-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .filter-select {
      padding: 10px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .invoices-table {
      width: 100%;
      border-collapse: collapse;
    }

    .invoices-table thead {
      background: var(--bg-elevated);
    }

    .invoices-table th {
      padding: 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border-primary);
    }

    .invoices-table td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--border-primary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .invoices-table tbody tr:hover {
      background: var(--bg-elevated);
    }

    .invoice-number {
      font-weight: 600;
      color: var(--mint);
      cursor: pointer;
    }

    .invoice-number:hover {
      text-decoration: underline;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
    }

    .badge.paid {
      background: rgba(178, 251, 165, 0.2);
      color: var(--success);
    }

    .badge.unpaid {
      background: rgba(251, 146, 60, 0.2);
      color: var(--warning);
    }

    .badge.overdue {
      background: rgba(248, 113, 113, 0.2);
      color: var(--danger);
    }

    .invoice-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--mint);
      border-color: var(--mint);
      color: #0a0e11;
    }

    /* Charts Section */
    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 24px;
    }

    .chart-card h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 20px 0;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    .simple-chart {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      height: 250px;
      padding: 20px 0;
    }

    .chart-bar {
      flex: 1;
      background: var(--mint);
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s;
      min-height: 20px;
    }

    .chart-bar:hover {
      background: var(--mint-dark);
      transform: scaleY(1.05);
    }

    .chart-bar-label {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .chart-bar-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-primary);
      font-weight: 600;
    }

    /* ROI Table */
    .roi-table {
      width: 100%;
      border-collapse: collapse;
    }

    .roi-table th,
    .roi-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-primary);
    }

    .roi-table th {
      background: var(--bg-elevated);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .roi-table td {
      color: var(--text-primary);
      font-size: 14px;
    }

    .roi-positive {
      color: var(--success);
      font-weight: 600;
    }

    .roi-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* Modal */
    .invoice-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .invoice-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-primary);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-primary);
    }

    .modal-header h2 {
      margin: 0;
      font-size: 24px;
      color: var(--text-primary);
    }

    .close-modal {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 32px;
      height: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(31, 36, 40, 0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
      border-radius: 8px;
      min-width: 60px;
    }

    .nav-item.active {
      color: var(--mint);
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-label {
      font-size: 11px;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .finance-overview {
        grid-template-columns: 1fr;
      }

      .charts-section {
        grid-template-columns: 1fr;
      }

      .invoices-table {
        font-size: 12px;
      }

      .invoices-table th,
      .invoices-table td {
        padding: 8px;
      }
      
      .finance-header {
        flex-direction: column;
        align-items: stretch;
      }
      .finance-header h1 {
        font-size: 24px;
        margin-bottom: 12px;
      }
      .header-actions {
        flex-direction: column;
        width: 100%;
      }
      .header-actions .btn {
        width: 100%;
      }
      .finance-overview {
        grid-template-columns: 1fr;
      }
      .finance-tabs {
        flex-wrap: wrap;
      }
      .tab-btn {
        flex: 1;
        min-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="finance-page">
    <!-- Header -->
    <div class="finance-header">
      <h1>
        <svg style="width:32px;height:32px;stroke:#B2FBA5;display:inline-block;vertical-align:middle;margin-right:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
        </svg>
        Finance
      </h1>
      <div class="header-actions">
        <button class="btn-secondary" onclick="exportData()">
          <svg style="width:18px;height:18px;display:inline-block;vertical-align:middle;margin-right:6px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          Export
        </button>
        <button class="btn-primary" onclick="openNewInvoiceModal()">+ Nov√° faktura</button>
      </div>
    </div>

    <!-- Finance Overview -->
    <div class="finance-overview">
      <div class="finance-card">
        <h3 style="display:flex;align-items:center;gap:8px;">
          <svg style="width:20px;height:20px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
          </svg>
          P≈ô√≠jmy tento mƒõs√≠c
        </h3>
        <h2 id="incomeAmount">0 Kƒç</h2>
        <span class="trend up" id="incomeTrend">‚Üë 0% vs minul√Ω mƒõs√≠c</span>
      </div>
      
      <div class="finance-card">
        <h3 style="display:flex;align-items:center;gap:8px;">
          <svg style="width:20px;height:20px;stroke:#f87171" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
          </svg>
          N√°klady
        </h3>
        <h2 id="expensesAmount">0 Kƒç</h2>
        <div class="breakdown" id="expensesBreakdown">
          <span>Mzdy: 0k</span>
          <span>Materi√°l: 0k</span>
          <span>Ostatn√≠: 0k</span>
        </div>
      </div>
      
      <div class="finance-card success">
        <h3 style="display:flex;align-items:center;gap:8px;">
          <svg style="width:20px;height:20px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          Zisk
        </h3>
        <h2 id="profitAmount">0 Kƒç</h2>
        <span id="profitMargin">Mar≈æe: 0%</span>
      </div>
      
      <div class="finance-card warning">
        <h3 style="display:flex;align-items:center;gap:8px;">
          <svg style="width:20px;height:20px;stroke:#fb923c" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          Nezaplacen√© faktury
        </h3>
        <h2 id="unpaidAmount">0 Kƒç</h2>
        <span id="unpaidCount">0 faktur po splatnosti</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="finance-tabs">
      <button class="tab-btn active" data-tab="invoices" onclick="switchTab('invoices')">Faktury</button>
      <button class="tab-btn" data-tab="profit" onclick="switchTab('profit')">V√Ωkazy zisku</button>
      <button class="tab-btn" data-tab="roi" onclick="switchTab('roi')">ROI zak√°zek</button>
    </div>

    <!-- Invoices Tab -->
    <div id="tab-invoices" class="tab-content">
      <div class="invoices-section">
        <div class="section-header">
          <h2>Faktury</h2>
        </div>

        <div class="filters-bar">
          <div class="search-box">
            <input type="search" id="invoiceSearch" placeholder="Hledat faktury...">
          </div>
          <select class="filter-select" id="filterType">
            <option value="">V≈°echny typy</option>
            <option value="issued">Vydan√©</option>
            <option value="received">P≈ôijat√©</option>
          </select>
          <select class="filter-select" id="filterStatus">
            <option value="">V≈°echny stavy</option>
            <option value="paid">Zaplaceno</option>
            <option value="unpaid">Nezaplaceno</option>
            <option value="overdue">Po splatnosti</option>
          </select>
        </div>

        <table class="invoices-table">
          <thead>
            <tr>
              <th>ƒå√≠slo</th>
              <th>Datum</th>
              <th>Klient/Dodavatel</th>
              <th>ƒå√°stka</th>
              <th>Status</th>
              <th>Splatnost</th>
              <th>Akce</th>
            </tr>
          </thead>
          <tbody id="invoicesList">
            <!-- Invoices will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Profit Tab -->
    <div id="tab-profit" class="tab-content" style="display:none;">
      <div class="charts-section">
        <div class="chart-card">
          <h3 style="display:flex;align-items:center;gap:8px;">
            <svg style="width:20px;height:20px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              <polyline points="17 6 23 6 23 12"/>
            </svg>
            P≈ô√≠jmy vs V√Ωdaje (6 mƒõs√≠c≈Ø)
          </h3>
          <div class="chart-container">
            <div class="simple-chart" id="incomeExpensesChart">
              <!-- Chart will be rendered here -->
            </div>
          </div>
        </div>

        <div class="chart-card">
          <h3 style="display:flex;align-items:center;gap:8px;">
            <svg style="width:20px;height:20px;stroke:#B2FBA5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
            </svg>
            Cashflow projekce
          </h3>
          <div class="chart-container">
            <div class="simple-chart" id="cashflowChart">
              <!-- Chart will be rendered here -->
            </div>
          </div>
        </div>
      </div>

      <div class="invoices-section">
        <div class="section-header">
          <h2>Mƒõs√≠ƒçn√≠ p≈ôehled</h2>
        </div>
        <table class="roi-table">
          <thead>
            <tr>
              <th>Mƒõs√≠c</th>
              <th>P≈ô√≠jmy</th>
              <th>V√Ωdaje</th>
              <th>Zisk</th>
              <th>Mar≈æe</th>
            </tr>
          </thead>
          <tbody id="monthlyProfitTable">
            <!-- Monthly data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ROI Tab -->
    <div id="tab-roi" class="tab-content" style="display:none;">
      <div class="invoices-section">
        <div class="section-header">
          <h2>ROI jednotliv√Ωch zak√°zek</h2>
        </div>
        <table class="roi-table">
          <thead>
            <tr>
              <th>Zak√°zka</th>
              <th>Klient</th>
              <th>P≈ô√≠jmy</th>
              <th>N√°klady</th>
              <th>Zisk</th>
              <th>ROI</th>
            </tr>
          </thead>
          <tbody id="roiTable">
            <!-- ROI data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="invoice-modal" id="invoiceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Nov√° faktura</h2>
        <button class="close-modal" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" style="padding:20px;" id="modalBody">
        <!-- Content will be loaded here -->
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;padding:20px;border-top:1px solid var(--border-primary);">
        <button class="btn-secondary" onclick="closeModal()">Zav≈ô√≠t</button>
        <button class="btn-primary" id="btnSaveInvoice" onclick="saveInvoice()">Ulo≈æit</button>
      </div>
    </div>
  </div>


  <!-- More Menu (Expandable) -->
  <div id="more-menu" class="more-menu">
    <div class="more-menu-backdrop" onclick="document.getElementById('more-menu').classList.remove('show');"></div>
    <div class="more-menu-panel">
      <div class="more-menu-header">
        <div style="font-size:18px;font-weight:600;color:#e8eef2;">Navigace</div>
        <button onclick="document.getElementById('more-menu').classList.remove('show');" style="background:none;border:none;color:#9ca8b3;cursor:pointer;font-size:24px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">√ó</button>
      </div>
      <div class="more-menu-content">
        <a href="/" onclick="event.preventDefault(); if(window.setAppTab) window.setAppTab('dashboard'); document.getElementById('more-menu').classList.remove('show');" class="more-menu-item">
          <span>p≈ôehled</span>
        </a>
        <a href="/calendar.html" class="more-menu-item">
          <span>kalend√°≈ô</span>
        </a>
        <a href="/timesheets.html" class="more-menu-item">
          <span>v√Ωkazy hodin</span>
        </a>
        <a href="/jobs.html" class="more-menu-item">
          <span>zak√°zky</span>
        </a>
        <a href="/tasks.html" class="more-menu-item">
          <span>√∫koly</span>
        </a>
        <a href="/employees.html" class="more-menu-item">
          <span>zamƒõstnanci</span>
        </a>
        <a href="/warehouse.html" class="more-menu-item">
          <span>sklad</span>
        </a>
        <a href="/finance.html" class="more-menu-item">
          <span>finance</span>
        </a>
        <a href="/documents.html" class="more-menu-item">
          <span>dokumenty</span>
        </a>
        <a href="/reports.html" class="more-menu-item">
          <span>reporty</span>
        </a>
        <a href="/settings.html" class="more-menu-item">
          <span>nastaven√≠</span>
        </a>
      </div>
    </div>
  </div>

  <script>
    let invoices = [];
    let jobs = [];
    let timesheets = [];
    let currentInvoiceId = null;
    let currentTab = 'invoices';

    // Load data
    async function loadData() {
      try {
        // Load invoices from localStorage (fallback to API if available)
        const stored = localStorage.getItem('finance_invoices');
        invoices = stored ? JSON.parse(stored) : [];
        
        // Try to load from API
        try {
          const res = await fetch('/api/invoices');
          const data = await res.json();
          if (data.invoices) {
            invoices = data.invoices;
            localStorage.setItem('finance_invoices', JSON.stringify(invoices));
          }
        } catch (e) {
          // Use localStorage data
        }

        // Load jobs for ROI calculation
        try {
          const res = await fetch('/api/jobs');
          const data = await res.json();
          jobs = data.jobs || [];
        } catch (e) {
          console.error('Error loading jobs:', e);
        }

        // Load timesheets for cost calculation
        try {
          const res = await fetch('/api/timesheets');
          const data = await res.json();
          timesheets = data.timesheets || [];
        } catch (e) {
          console.error('Error loading timesheets:', e);
        }

        updateOverview();
        renderInvoices();
        renderProfitCharts();
        renderMonthlyProfit();
        renderROI();
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }

    function updateOverview() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Calculate income (paid invoices this month)
      const income = invoices
        .filter(inv => {
          if (inv.status !== 'paid') return false;
          const date = new Date(inv.date || inv.created_at);
          return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        })
        .reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);

      // Calculate expenses
      const wages = calculateWages(currentMonth, currentYear);
      const materials = calculateMaterials(currentMonth, currentYear);
      const other = 0; // Could be extended
      const expenses = wages + materials + other;

      // Calculate profit
      const profit = income - expenses;
      const margin = income > 0 ? ((profit / income) * 100).toFixed(1) : 0;

      // Unpaid invoices
      const unpaid = invoices
        .filter(inv => inv.status === 'unpaid' || inv.status === 'overdue')
        .reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
      
      const overdueCount = invoices.filter(inv => inv.status === 'overdue').length;

      // Update UI
      document.getElementById('incomeAmount').textContent = formatCurrency(income);
      document.getElementById('expensesAmount').textContent = formatCurrency(expenses);
      document.getElementById('expensesBreakdown').innerHTML = `
        <span>Mzdy: ${formatCurrencyShort(wages)}</span>
        <span>Materi√°l: ${formatCurrencyShort(materials)}</span>
        <span>Ostatn√≠: ${formatCurrencyShort(other)}</span>
      `;
      document.getElementById('profitAmount').textContent = formatCurrency(profit);
      document.getElementById('profitMargin').textContent = `Mar≈æe: ${margin}%`;
      document.getElementById('unpaidAmount').textContent = formatCurrency(unpaid);
      document.getElementById('unpaidCount').textContent = `${overdueCount} faktur po splatnosti`;

      // Calculate trend (simplified - compare with previous month)
      const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
      const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
      const prevIncome = invoices
        .filter(inv => {
          if (inv.status !== 'paid') return false;
          const date = new Date(inv.date || inv.created_at);
          return date.getMonth() === prevMonth && date.getFullYear() === prevYear;
        })
        .reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
      
      const trend = prevIncome > 0 ? (((income - prevIncome) / prevIncome) * 100).toFixed(1) : 0;
      const trendElement = document.getElementById('incomeTrend');
      if (trend > 0) {
        trendElement.className = 'trend up';
        trendElement.textContent = `‚Üë ${trend}% vs minul√Ω mƒõs√≠c`;
      } else if (trend < 0) {
        trendElement.className = 'trend down';
        trendElement.textContent = `‚Üì ${Math.abs(trend)}% vs minul√Ω mƒõs√≠c`;
      } else {
        trendElement.textContent = '‚Äî vs minul√Ω mƒõs√≠c';
      }
    }

    function calculateWages(month, year) {
      // Calculate from timesheets (simplified - would need hourly rates)
      const monthTimesheets = timesheets.filter(ts => {
        const date = new Date(ts.date);
        return date.getMonth() === month && date.getFullYear() === year;
      });
      
      const totalHours = monthTimesheets.reduce((sum, ts) => sum + (parseFloat(ts.hours) || 0), 0);
      const avgRate = 300; // Average hourly rate (would come from employee data)
      return totalHours * avgRate;
    }

    function calculateMaterials(month, year) {
      // Would calculate from warehouse movements or job materials
      // Simplified for now
      return 0;
    }

    function renderInvoices() {
      const filtered = getFilteredInvoices();
      const container = document.getElementById('invoicesList');
      
      if (filtered.length === 0) {
        container.innerHTML = '<tr><td colspan="7" class="empty-state">≈Ω√°dn√© faktury</td></tr>';
        return;
      }
      
      container.innerHTML = filtered.map(inv => {
        const date = new Date(inv.date || inv.created_at);
        const dueDate = inv.due_date ? new Date(inv.due_date) : null;
        const status = getInvoiceStatus(inv);
        const statusClass = status === 'paid' ? 'paid' : status === 'overdue' ? 'overdue' : 'unpaid';
        const statusText = status === 'paid' ? 'Zaplaceno' : status === 'overdue' ? 'Po splatnosti' : 'Nezaplaceno';
        
        return `
          <tr>
            <td><span class="invoice-number" onclick="openInvoiceDetail(${inv.id})">${escapeHtml(inv.number || 'FV-' + inv.id)}</span></td>
            <td>${date.toLocaleDateString('cs-CZ')}</td>
            <td>${escapeHtml(inv.client || inv.supplier || '‚Äî')}</td>
            <td>${formatCurrency(inv.amount || 0)}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td>${dueDate ? dueDate.toLocaleDateString('cs-CZ') : '‚Äî'}</td>
            <td>
              <div class="invoice-actions">
                <button class="btn-icon" onclick="markAsPaid(${inv.id})" title="Oznaƒçit jako zaplaceno">‚úì</button>
                <button class="btn-icon" onclick="openInvoiceDetail(${inv.id})" title="Detail">üìù</button>
                <button class="btn-icon" onclick="exportPDF(${inv.id})" title="Export PDF">üìÑ</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getFilteredInvoices() {
      let filtered = [...invoices];
      
      const search = document.getElementById('invoiceSearch').value.toLowerCase();
      if (search) {
        filtered = filtered.filter(inv => 
          (inv.number || '').toLowerCase().includes(search) ||
          (inv.client || inv.supplier || '').toLowerCase().includes(search)
        );
      }

      const typeFilter = document.getElementById('filterType').value;
      if (typeFilter) {
        filtered = filtered.filter(inv => inv.type === typeFilter);
      }

      const statusFilter = document.getElementById('filterStatus').value;
      if (statusFilter) {
        filtered = filtered.filter(inv => {
          const status = getInvoiceStatus(inv);
          return status === statusFilter;
        });
      }

      return filtered;
    }

    function getInvoiceStatus(invoice) {
      if (invoice.status === 'paid') return 'paid';
      if (invoice.status === 'overdue') return 'overdue';
      
      // Check if overdue
      if (invoice.due_date) {
        const due = new Date(invoice.due_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (due < today) return 'overdue';
      }
      
      return 'unpaid';
    }

    function renderProfitCharts() {
      // Income vs Expenses Chart (6 months)
      const months = [];
      const incomeData = [];
      const expensesData = [];
      
      const now = new Date();
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push(date.toLocaleDateString('cs-CZ', { month: 'short' }));
        
        const month = date.getMonth();
        const year = date.getFullYear();
        
        const income = invoices
          .filter(inv => {
            if (inv.status !== 'paid') return false;
            const invDate = new Date(inv.date || inv.created_at);
            return invDate.getMonth() === month && invDate.getFullYear() === year;
          })
          .reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
        
        const expenses = calculateWages(month, year) + calculateMaterials(month, year);
        
        incomeData.push(income);
        expensesData.push(expenses);
      }
      
      const maxValue = Math.max(...incomeData, ...expensesData, 1);
      
      const chartContainer = document.getElementById('incomeExpensesChart');
      chartContainer.innerHTML = months.map((month, idx) => {
        const incomeHeight = (incomeData[idx] / maxValue) * 100;
        const expenseHeight = (expensesData[idx] / maxValue) * 100;
        
        return `
          <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
            <div style="flex: 1; display: flex; align-items: flex-end; gap: 4px;">
              <div class="chart-bar" style="height: ${incomeHeight}%; background: var(--success);" title="P≈ô√≠jmy: ${formatCurrency(incomeData[idx])}">
                <div class="chart-bar-value">${formatCurrencyShort(incomeData[idx])}</div>
              </div>
              <div class="chart-bar" style="height: ${expenseHeight}%; background: var(--danger);" title="V√Ωdaje: ${formatCurrency(expensesData[idx])}">
                <div class="chart-bar-value">${formatCurrencyShort(expensesData[idx])}</div>
              </div>
            </div>
            <div class="chart-bar-label">${month}</div>
          </div>
        `;
      }).join('');

      // Cashflow Chart (simplified projection)
      const cashflowContainer = document.getElementById('cashflowChart');
      const cashflowData = [];
      let balance = 0;
      
      for (let i = 0; i < 6; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const month = date.getMonth();
        const year = date.getFullYear();
        
        const income = i === 0 ? incomeData[5] : incomeData[5] * 0.95; // Projection
        const expenses = i === 0 ? expensesData[5] : expensesData[5] * 1.05; // Projection
        balance += (income - expenses);
        cashflowData.push(balance);
      }
      
      const maxCashflow = Math.max(...cashflowData.map(Math.abs), 1);
      
      cashflowContainer.innerHTML = cashflowData.map((value, idx) => {
        const height = (Math.abs(value) / maxCashflow) * 100;
        const color = value >= 0 ? 'var(--success)' : 'var(--danger)';
        const month = new Date(now.getFullYear(), now.getMonth() + idx, 1).toLocaleDateString('cs-CZ', { month: 'short' });
        
        return `
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
            <div class="chart-bar" style="height: ${height}%; background: ${color}; width: 100%;" title="Cashflow: ${formatCurrency(value)}">
              <div class="chart-bar-value">${formatCurrencyShort(value)}</div>
            </div>
            <div class="chart-bar-label">${month}</div>
          </div>
        `;
      }).join('');
    }

    function renderMonthlyProfit() {
      const months = [];
      const now = new Date();
      
      for (let i = 11; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push({
          month: date.getMonth(),
          year: date.getFullYear(),
          label: date.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' })
        });
      }
      
      const container = document.getElementById('monthlyProfitTable');
      container.innerHTML = months.map(m => {
        const income = invoices
          .filter(inv => {
            if (inv.status !== 'paid') return false;
            const invDate = new Date(inv.date || inv.created_at);
            return invDate.getMonth() === m.month && invDate.getFullYear() === m.year;
          })
          .reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
        
        const expenses = calculateWages(m.month, m.year) + calculateMaterials(m.month, m.year);
        const profit = income - expenses;
        const margin = income > 0 ? ((profit / income) * 100).toFixed(1) : 0;
        
        return `
          <tr>
            <td>${m.label}</td>
            <td>${formatCurrency(income)}</td>
            <td>${formatCurrency(expenses)}</td>
            <td class="${profit >= 0 ? 'roi-positive' : 'roi-negative'}">${formatCurrency(profit)}</td>
            <td>${margin}%</td>
          </tr>
        `;
      }).join('');
    }

    function renderROI() {
      const container = document.getElementById('roiTable');
      
      if (jobs.length === 0) {
        container.innerHTML = '<tr><td colspan="6" class="empty-state">≈Ω√°dn√© zak√°zky</td></tr>';
        return;
      }
      
      container.innerHTML = jobs.map(job => {
        // Calculate income from invoices for this job
        const jobInvoices = invoices.filter(inv => inv.job_id === job.id && inv.status === 'paid');
        const income = jobInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
        
        // Calculate costs from timesheets
        const jobTimesheets = timesheets.filter(ts => ts.job_id === job.id);
        const hours = jobTimesheets.reduce((sum, ts) => sum + (parseFloat(ts.hours) || 0), 0);
        const costs = hours * 300; // Simplified hourly rate
        
        const profit = income - costs;
        const roi = costs > 0 ? ((profit / costs) * 100).toFixed(1) : 0;
        
        return `
          <tr>
            <td>${escapeHtml(job.title || job.name || 'Zak√°zka ' + job.id)}</td>
            <td>${escapeHtml(job.client || '‚Äî')}</td>
            <td>${formatCurrency(income)}</td>
            <td>${formatCurrency(costs)}</td>
            <td class="${profit >= 0 ? 'roi-positive' : 'roi-negative'}">${formatCurrency(profit)}</td>
            <td class="${parseFloat(roi) >= 0 ? 'roi-positive' : 'roi-negative'}">${roi}%</td>
          </tr>
        `;
      }).join('');
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).style.display = 'block';
    }

    function openNewInvoiceModal() {
      currentInvoiceId = null;
      document.getElementById('modalTitle').textContent = 'Nov√° faktura';
      document.getElementById('modalBody').innerHTML = renderInvoiceForm();
      document.getElementById('invoiceModal').classList.add('show');
    }

    function openInvoiceDetail(invoiceId) {
      currentInvoiceId = invoiceId;
      const invoice = invoices.find(inv => inv.id === invoiceId);
      if (!invoice) return;
      
      document.getElementById('modalTitle').textContent = 'Detail faktury';
      document.getElementById('modalBody').innerHTML = renderInvoiceForm(invoice);
      document.getElementById('invoiceModal').classList.add('show');
    }

    function renderInvoiceForm(invoice = null) {
      return `
        <form id="invoiceForm">
          <div class="form-group">
            <label>Typ faktury *</label>
            <select id="invoiceType" required>
              <option value="issued" ${invoice && invoice.type === 'issued' ? 'selected' : ''}>Vydan√°</option>
              <option value="received" ${invoice && invoice.type === 'received' ? 'selected' : ''}>P≈ôijat√°</option>
            </select>
          </div>
          <div class="form-group">
            <label>ƒå√≠slo faktury *</label>
            <input type="text" id="invoiceNumber" value="${invoice ? escapeHtml(invoice.number || '') : ''}" required placeholder="FV-2024-001">
          </div>
          <div class="form-group">
            <label>${invoice && invoice.type === 'received' ? 'Dodavatel' : 'Klient'} *</label>
            <input type="text" id="invoiceClient" value="${invoice ? escapeHtml(invoice.client || invoice.supplier || '') : ''}" required>
          </div>
          <div class="form-group">
            <label>ƒå√°stka (Kƒç) *</label>
            <input type="number" step="0.01" id="invoiceAmount" value="${invoice ? (invoice.amount || 0) : 0}" required>
          </div>
          <div class="form-group">
            <label>Datum vystaven√≠ *</label>
            <input type="date" id="invoiceDate" value="${invoice && invoice.date ? invoice.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
          </div>
          <div class="form-group">
            <label>Splatnost</label>
            <input type="date" id="invoiceDueDate" value="${invoice && invoice.due_date ? invoice.due_date.split('T')[0] : ''}">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="invoiceStatus">
              <option value="unpaid" ${invoice && invoice.status === 'unpaid' ? 'selected' : ''}>Nezaplaceno</option>
              <option value="paid" ${invoice && invoice.status === 'paid' ? 'selected' : ''}>Zaplaceno</option>
              <option value="overdue" ${invoice && invoice.status === 'overdue' ? 'selected' : ''}>Po splatnosti</option>
            </select>
          </div>
          <div class="form-group">
            <label>Pozn√°mka</label>
            <textarea id="invoiceNote" rows="3">${invoice ? escapeHtml(invoice.note || '') : ''}</textarea>
          </div>
        </form>
      `;
    }

    async function saveInvoice() {
      const type = document.getElementById('invoiceType').value;
      const number = document.getElementById('invoiceNumber').value.trim();
      const client = document.getElementById('invoiceClient').value.trim();
      const amount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
      const date = document.getElementById('invoiceDate').value;
      const dueDate = document.getElementById('invoiceDueDate').value;
      const status = document.getElementById('invoiceStatus').value;
      const note = document.getElementById('invoiceNote').value.trim();

      if (!number || !client || !amount) {
        alert('Vypl≈àte v≈°echna povinn√° pole');
        return;
      }

      const invoiceData = {
        type: type,
        number: number,
        [type === 'issued' ? 'client' : 'supplier']: client,
        amount: amount,
        date: date,
        due_date: dueDate || null,
        status: status,
        note: note
      };

      try {
        if (!currentInvoiceId) {
          invoiceData.id = Date.now();
          invoiceData.created_at = new Date().toISOString();
          invoices.push(invoiceData);
        } else {
          const index = invoices.findIndex(inv => inv.id === currentInvoiceId);
          if (index !== -1) {
            Object.assign(invoices[index], invoiceData);
          }
        }

        localStorage.setItem('finance_invoices', JSON.stringify(invoices));
        
        // Try to save to API
        try {
          await fetch('/api/invoices', {
            method: currentInvoiceId ? 'PATCH' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invoiceData)
          });
        } catch (e) {
          // Fallback to localStorage only
        }

        await loadData();
        closeModal();
      } catch (e) {
        console.error('Error saving invoice:', e);
        alert('Chyba p≈ôi ukl√°d√°n√≠ faktury');
      }
    }

    function markAsPaid(invoiceId) {
      const invoice = invoices.find(inv => inv.id === invoiceId);
      if (invoice) {
        invoice.status = 'paid';
        localStorage.setItem('finance_invoices', JSON.stringify(invoices));
        loadData();
      }
    }

    function exportPDF(invoiceId) {
      // Placeholder for PDF export
      alert('Export PDF bude implementov√°n');
    }

    function exportData() {
      const csv = [
        ['ƒå√≠slo', 'Datum', 'Klient/Dodavatel', 'ƒå√°stka', 'Status', 'Splatnost'].join(','),
        ...invoices.map(inv => {
          const date = new Date(inv.date || inv.created_at);
          return [
            `"${inv.number || ''}"`,
            date.toLocaleDateString('cs-CZ'),
            `"${inv.client || inv.supplier || ''}"`,
            inv.amount || 0,
            inv.status || 'unpaid',
            inv.due_date ? new Date(inv.due_date).toLocaleDateString('cs-CZ') : ''
          ].join(',');
        })
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `finance_export_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }

    function closeModal() {
      document.getElementById('invoiceModal').classList.remove('show');
      currentInvoiceId = null;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK' }).format(amount);
    }

    function formatCurrencyShort(amount) {
      if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
      if (amount >= 1000) return (amount / 1000).toFixed(0) + 'k';
      return amount.toFixed(0);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    document.getElementById('invoiceSearch').addEventListener('input', renderInvoices);
    document.getElementById('filterType').addEventListener('change', renderInvoices);
    document.getElementById('filterStatus').addEventListener('change', renderInvoices);

    // Close modal on backdrop click
    document.getElementById('invoiceModal').addEventListener('click', (e) => {
      if (e.target.id === 'invoiceModal') {
        closeModal();
      }
    });

    // Initialize
    loadData();
  </script>
  <div id="bottom-nav-container"></div>
  <script src="/static/bottom-nav.js"></script>
  <link rel="stylesheet" href="/static/icons.css">
</body>
</html>

