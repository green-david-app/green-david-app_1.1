<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archiv - Green David</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="logo-area">
                <div class="logo-icon">
                    <img src="/logo.jpg" alt="Green David" onerror="this.parentElement.innerHTML='<div style=\'font-weight:700;color:var(--text-light);font-size:14px\'>GD</div>'">
                </div>
                <div class="app-title">archiv zak√°zek</div>
            </div>
        </div>
        <div style="margin-top: 16px;">
            <input type="search" id="search-input" placeholder="Hledat v archivu..." style="margin-bottom: 12px;">
            <select id="year-filter" style="width: 100%;">
                <option value="">V≈°echny roky</option>
            </select>
        </div>
    </div>
    
    <div class="section">
        <div id="archive-list">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
    
    <div class="tab-bar">
        <div class="tab-item" onclick="location.href='/'">
            <div class="tab-icon"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg></div>
            <div class="tab-label">dom≈Ø</div>
        </div>
        <div class="tab-item" onclick="location.href='/jobs'">
            <div class="tab-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg></div>
            <div class="tab-label">zak√°zky</div>
        </div>
        <div class="tab-item" onclick="location.href='/timesheets'">
            <div class="tab-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg></div>
            <div class="tab-label">v√Ωkazy</div>
        </div>
        <div class="tab-item" onclick="location.href='/calendar'">
            <div class="tab-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect></svg></div>
            <div class="tab-label">kalend√°≈ô</div>
        </div>
        <div class="tab-item active">
            <div class="tab-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle></svg></div>
            <div class="tab-label">v√≠ce</div>
        </div>
    </div>
    
    <script>
        async function api(path, opts = {}) {
            const res = await fetch(path, opts);
            if (!res.ok) throw new Error(res.statusText);
            return await res.json();
        }
        
        let allArchived = [];
        
        async function loadArchive() {
            try {
                const data = await api('/api/archive');
                allArchived = data.jobs || [];
                
                // Populate year filter
                const years = [...new Set(allArchived.map(j => {
                    const year = j.completed_at ? new Date(j.completed_at).getFullYear() : null;
                    return year;
                }).filter(Boolean))].sort().reverse();
                
                document.getElementById('year-filter').innerHTML = 
                    '<option value="">V≈°echny roky</option>' +
                    years.map(y => `<option value="${y}">${y}</option>`).join('');
                
                renderArchive();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderArchive() {
            const container = document.getElementById('archive-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const year = document.getElementById('year-filter').value;
            
            let filtered = allArchived;
            
            if (search) {
                filtered = filtered.filter(j => 
                    (j.title || '').toLowerCase().includes(search) ||
                    (j.city || '').toLowerCase().includes(search)
                );
            }
            
            if (year) {
                filtered = filtered.filter(j => {
                    const jobYear = j.completed_at ? new Date(j.completed_at).getFullYear() : null;
                    return jobYear == year;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <div class="empty-title">≈Ω√°dn√© archivovan√© zak√°zky</div>
                    </div>
                `;
                return;
            }
            
            const html = filtered.map(job => `
                <div class="card list-card" onclick="location.href='/archive/${job.id}'">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24">
                            <polyline points="21 8 21 21 3 21 3 8"></polyline>
                            <rect x="1" y="3" width="22" height="5"></rect>
                            <line x1="10" y1="12" x2="14" y2="12"></line>
                        </svg>
                    </div>
                    <div class="card-content">
                        <div class="card-title">${job.title || job.name}</div>
                        <div class="card-subtitle">${job.city || '-'} ‚Ä¢ ${job.completed_at || '-'}</div>
                    </div>
                    <div class="card-badge badge-done">Dokonƒçeno</div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadArchive();
            document.getElementById('search-input').addEventListener('input', renderArchive);
            document.getElementById('year-filter').addEventListener('change', renderArchive);
        });
    </script>
</body>
</html>
