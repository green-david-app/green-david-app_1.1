# JOBS.HTML PATCH - Změny pro Issues API
# Tento soubor obsahuje konkrétní změny které je třeba aplikovat do jobs.html

## 1. Změna názvu sekce (řádek ~1932):
NAJDI:
                            <div style="font-weight:700;">Problémy / překážky</div>

NAHRAĎ:
                            <div style="font-weight:700;">Issues</div>

## 2. Přepsat funkci addProblem (řádek 1680-1714):
NAHRAĎ CELOU FUNKCI:

async function addProblem(jobId) {
    const titleEl = document.getElementById('ops-problem-title');
    const noteEl = document.getElementById('ops-problem-note');
    const sevEl = document.getElementById('ops-problem-severity');
    const ownerEl = document.getElementById('ops-problem-owner');

    const title = (titleEl?.value || '').trim();
    const note = (noteEl?.value || '').trim();
    const severity = (sevEl?.value || 'blocking');
    const assignedTo = (ownerEl?.value || '').toString().trim();

    if (!title) {
        if (window.showToast) window.showToast('Zadej název issue', 'error');
        return;
    }

    try {
        const res = await fetch('/api/issues', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                job_id: jobId,
                title: title,
                description: note,
                type: severity === 'info' ? 'note' : 'blocker',
                severity: severity,
                assigned_to: assignedTo || null,
                status: 'open'
            })
        });

        if (res.ok) {
            titleEl.value = '';
            noteEl.value = '';
            renderOperativa(jobId);
            if (window.showToast) window.showToast('Issue přidán', 'success');
        } else {
            throw new Error('Nepodařilo se přidat issue');
        }
    } catch (e) {
        console.error(e);
        if (window.showToast) window.showToast('Chyba při přidávání issue', 'error');
    }
}

## 3. Přepsat funkci resolveProblem (řádek 1716-1725):
NAHRAĎ CELOU FUNKCI:

async function resolveProblem(jobId, problemId) {
    try {
        const res = await fetch('/api/issues', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                id: problemId,
                status: 'resolved'
            })
        });

        if (res.ok) {
            renderOperativa(jobId);
            if (window.showToast) window.showToast('Issue vyřešen', 'success');
        }
    } catch (e) {
        console.error(e);
        if (window.showToast) window.showToast('Chyba při řešení issue', 'error');
    }
}

## 4. Přepsat funkci deleteProblem (řádek 1727-1732):
NAHRAĎ CELOU FUNKCI:

async function deleteProblem(jobId, problemId) {
    try {
        const res = await fetch(`/api/issues?id=${problemId}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            renderOperativa(jobId);
            if (window.showToast) window.showToast('Issue smazán', 'success');
        }
    } catch (e) {
        console.error(e);
        if (window.showToast) window.showToast('Chyba při mazání issue', 'error');
    }
}

## 5. Aktualizovat renderOperativa aby načítala issues z API

V FUNKCI renderOperativa (řádek ~1547) NAJDI:
    function renderOperativa(jobId) {
        const ops = loadOps(jobId);

NAHRAĎ:
    async function renderOperativa(jobId) {
        // Load issues from API
        let issues = [];
        try {
            const res = await fetch(`/api/issues?job_id=${jobId}`);
            const data = await res.json();
            if (data.ok) {
                issues = data.issues || [];
            }
        } catch (e) {
            console.error('Error loading issues:', e);
        }

        const ops = loadOps(jobId);
        // Replace ops.problems with API data
        ops.problems = issues.map(i => ({
            id: i.id,
            title: i.title,
            note: i.description,
            severity: i.severity || i.type,
            ownerId: i.assigned_to,
            ownerName: i.assigned_name,
            status: i.status,
            createdAt: i.created_at
        }));

## 6. V renderOperativa změnit všechny "problém" na "issue" v toast zprávách a textech
